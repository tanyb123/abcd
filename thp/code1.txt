import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useNavigation } from '@react-navigation/native';
import { useAuth } from '../contexts/AuthContext';
import {
  getProposalsByStatus,
  canApproveProposal,
} from '../api/proposalService';

const DirectorDashboardScreen = () => {
  const navigation = useNavigation();
  const { currentUser } = useAuth();
  const [loading, setLoading] = useState(true);
  const [pendingProposals, setPendingProposals] = useState([]);
  const [canApprove, setCanApprove] = useState(false);

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      try {
        // Kiểm tra quyền duyệt đề xuất
        const hasApprovalPermission = canApproveProposal(currentUser?.role);
        setCanApprove(hasApprovalPermission);

        // Nếu có quyền duyệt, tải danh sách đề xuất chờ duyệt
        if (hasApprovalPermission) {
          const proposals = await getProposalsByStatus('pending');
          setPendingProposals(proposals);
        }
      } catch (error) {
        console.error('Error loading data:', error);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, [currentUser]);

  const formatDate = (timestamp) => {
    if (!timestamp) return 'N/A';
    try {
      if (timestamp.toDate) {
        return timestamp.toDate().toLocaleDateString('vi-VN');
      } else if (timestamp instanceof Date) {
        return timestamp.toLocaleDateString('vi-VN');
      }
      return 'N/A';
    } catch (e) {
      return 'N/A';
    }
  };

  const getPriorityColor = (priority) => {
    switch (priority) {
      case 'urgent':
        return '#FF3B30';
      case 'normal':
        return '#007AFF';
      default:
        return '#007AFF';
    }
  };

  const getPriorityLabel = (priority) => {
    switch (priority) {
      case 'urgent':
        return 'Gấp';
      case 'normal':
        return 'Bình thường';
      default:
        return priority || 'Bình thường';
    }
  };

  const renderProposalCard = (proposal) => (
    <TouchableOpacity
      key={proposal.id}
      style={styles.proposalCard}
      onPress={() => navigation.navigate('ProposalList')}
    >
      <View style={styles.proposalHeader}>
        <Text style={styles.proposalCode}>{proposal.proposalCode}</Text>
        <View
          style={[
            styles.priorityBadge,
            { backgroundColor: getPriorityColor(proposal.priority) },
          ]}
        >
          <Text style={styles.priorityText}>
            {getPriorityLabel(proposal.priority)}
          </Text>
        </View>
      </View>

      <Text style={styles.projectName}>{proposal.projectName}</Text>
      <Text style={styles.proposalInfo}>
        Người đề xuất: {proposal.createdByName || 'N/A'}
      </Text>
      <Text style={styles.proposalInfo}>
        Ngày cần cung cấp: {formatDate(proposal.requiredDate)}
      </Text>
      <Text style={styles.proposalInfo}>
        Số lượng vật tư: {proposal.items.length}
      </Text>

      <View style={styles.proposalPurpose}>
        <Text style={styles.purposeLabel}>Mục đích:</Text>
        <Text style={styles.purposeText} numberOfLines={2}>
          {proposal.purpose || 'Không có mô tả'}
        </Text>
      </View>
    </TouchableOpacity>
  );

  return (
    <ScrollView style={styles.container}>
      <Text style={styles.screenTitle}>Bảng điều khiển Giám đốc</Text>

      {/* Phần đề xuất chờ duyệt */}
      {canApprove && (
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <Text style={styles.sectionTitle}>Đề xuất chờ duyệt</Text>
            <TouchableOpacity
              style={styles.viewAllButton}
              onPress={() => navigation.navigate('ProposalList')}
            >
              <Text style={styles.viewAllText}>Xem tất cả</Text>
              <Ionicons name="chevron-forward" size={16} color="#0066cc" />
            </TouchableOpacity>
          </View>

          {loading ? (
            <ActivityIndicator
              size="large"
              color="#0066cc"
              style={styles.loader}
            />
          ) : pendingProposals.length > 0 ? (
            <View>
              {pendingProposals.slice(0, 3).map(renderProposalCard)}

              {pendingProposals.length > 3 && (
                <TouchableOpacity
                  style={styles.moreButton}
                  onPress={() => navigation.navigate('ProposalList')}
                >
                  <Text style={styles.moreButtonText}>
                    Xem thêm {pendingProposals.length - 3} đề xuất
                  </Text>
                </TouchableOpacity>
              )}
            </View>
          ) : (
            <View style={styles.emptyState}>
              <Ionicons name="checkmark-circle" size={40} color="#4CAF50" />
              <Text style={styles.emptyText}>
                Không có đề xuất nào chờ duyệt
              </Text>
            </View>
          )}
        </View>
      )}

      {/* Các phần khác của dashboard */}
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Báo cáo dự án</Text>
        <TouchableOpacity
          style={styles.dashboardCard}
          onPress={() => navigation.navigate('ProjectManagement')}
        >
          <Ionicons
            name="stats-chart"
            size={24}
            color="#0066cc"
            style={styles.cardIcon}
          />
          <View style={styles.cardContent}>
            <Text style={styles.cardTitle}>Quản lý dự án</Text>
            <Text style={styles.cardDescription}>
              Xem và quản lý tất cả dự án
            </Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color="#999" />
        </TouchableOpacity>
      </View>

      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Quản lý nhân sự</Text>
        <TouchableOpacity
          style={styles.dashboardCard}
          onPress={() => navigation.navigate('Attendance')}
        >
          <Ionicons
            name="people"
            size={24}
            color="#FF9500"
            style={styles.cardIcon}
          />
          <View style={styles.cardContent}>
            <Text style={styles.cardTitle}>Chấm công</Text>
            <Text style={styles.cardDescription}>
              Quản lý chấm công và tăng ca
            </Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color="#999" />
        </TouchableOpacity>

        <TouchableOpacity
          style={styles.dashboardCard}
          onPress={() => navigation.navigate('UserManagement')}
        >
          <Ionicons
            name="person-add"
            size={24}
            color="#FF2D55"
            style={styles.cardIcon}
          />
          <View style={styles.cardContent}>
            <Text style={styles.cardTitle}>Quản lý người dùng</Text>
            <Text style={styles.cardDescription}>
              Thêm và phân quyền người dùng
            </Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color="#999" />
        </TouchableOpacity>
      </View>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
    padding: 16,
  },
  screenTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    marginBottom: 20,
    color: '#333',
  },
  section: {
    marginBottom: 24,
    backgroundColor: '#fff',
    borderRadius: 12,
    padding: 16,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 2,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  viewAllButton: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  viewAllText: {
    color: '#0066cc',
    fontSize: 14,
    fontWeight: '500',
  },
  dashboardCard: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    backgroundColor: '#f9f9f9',
    borderRadius: 8,
    marginBottom: 12,
  },
  cardIcon: {
    marginRight: 16,
  },
  cardContent: {
    flex: 1,
  },
  cardTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
  },
  cardDescription: {
    fontSize: 14,
    color: '#666',
    marginTop: 2,
  },
  loader: {
    marginVertical: 20,
  },
  emptyState: {
    alignItems: 'center',
    padding: 30,
  },
  emptyText: {
    marginTop: 10,
    fontSize: 16,
    color: '#666',
  },
  proposalCard: {
    backgroundColor: '#f9f9f9',
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
    borderLeftWidth: 4,
    borderLeftColor: '#0066cc',
  },
  proposalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  proposalCode: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
  },
  priorityBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  priorityText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: '600',
  },
  projectName: {
    fontSize: 15,
    fontWeight: '500',
    marginBottom: 8,
  },
  proposalInfo: {
    fontSize: 14,
    color: '#666',
    marginBottom: 4,
  },
  proposalPurpose: {
    marginTop: 8,
    paddingTop: 8,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  purposeLabel: {
    fontSize: 14,
    fontWeight: '500',
    marginBottom: 4,
  },
  purposeText: {
    fontSize: 14,
    color: '#666',
  },
  moreButton: {
    alignItems: 'center',
    padding: 12,
    backgroundColor: '#f0f0f0',
    borderRadius: 8,
  },
  moreButtonText: {
    color: '#0066cc',
    fontWeight: '500',
  },
});

export default DirectorDashboardScreen;
