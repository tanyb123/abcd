
--- File: C:\Users\Admin\Downloads\thpapp\functions\src\config.ts ---

export const APP_DRIVE_ROOT_FOLDER_ID = '1ZN8CxmHgAC2yzDqDVaJWxKSrpD4OjFUT'; // TODO: Set to THP_APP_DATA_ROOT folder ID
export const SERVICE_ACCOUNT_KEY_PATH =
  '../../service-account-credentials.json';


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\contractGenerator.ts ---

/**
 * @fileoverview Cloud Function to generate a contract from a Google Docs template.
 *
 * @description
 * This function implements a professional "Native Table Insertion" approach for generating
 * contracts. It creates a properly formatted table directly using Google Docs API.
 *
 * HÆ¯á»šNG DáºªN Cáº¤U HÃŒNH TEMPLATE GOOGLE DOCS (QUAN TRá»ŒNG):
 *
 * 1. **Chuáº©n bá»‹ Template:**
 *    - Táº¡o má»™t file Google Docs Ä‘á»ƒ lÃ m máº«u há»£p Ä‘á»“ng.
 *    - Äáº·t cÃ¡c placeholder cho cÃ¡c trÆ°á»ng vÄƒn báº£n Ä‘Æ¡n giáº£n, vÃ­ dá»¥: {companyName}, {customerAddress}, {grandTotal}.
 *
 * 2. **Chuáº©n bá»‹ pháº§n Báº£ng Váº­t TÆ°:**
 *    - Chá»‰ cáº§n Ä‘áº·t má»™t placeholder Ä‘Æ¡n giáº£n: {{MATERIALS_TABLE}}
 *    - Placeholder nÃ y sáº½ Ä‘Æ°á»£c thay tháº¿ báº±ng má»™t báº£ng thá»±c sá»± Ä‘Æ°á»£c táº¡o bá»Ÿi Google Docs API.
 *    - Báº£ng sáº½ tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh kÃ­ch thÆ°á»›c dá»±a trÃªn sá»‘ lÆ°á»£ng váº­t tÆ°.
 *
 * 3. **Láº¥y ID Template:**
 *    - Má»Ÿ file template Google Docs, copy ID tá»« URL.
 *      (VÃ­ dá»¥: trong `.../d/THIS_IS_THE_ID/edit`, `THIS_IS_THE_ID` chÃ­nh lÃ  ID).
 *    - Cáº­p nháº­t biáº¿n `CONTRACT_TEMPLATE_ID` bÃªn dÆ°á»›i báº±ng ID nÃ y.
 */
import * as functions from 'firebase-functions/v1';
import * as admin from 'firebase-admin';
// Import kiá»ƒu dá»¯ liá»‡u, khÃ´ng import thÆ° viá»‡n thá»±c táº¿
import type { docs_v1 } from 'googleapis';

// --- CONFIGURATION ---
// TODO: Thay tháº¿ báº±ng ID cá»§a file Google Docs template cá»§a báº¡n
const CONTRACT_TEMPLATE_ID = '1d0ERJFmbBmhqe4CcaMi02EBi20BXYCgZeasMCbT6ULc'; // ID TEMPLATE Cáº¦N ÄÆ¯á»¢C Cáº¬P NHáº¬T

// --- TYPE DEFINITIONS ---
// Äá»‹nh nghÄ©a cáº¥u trÃºc cho má»™t hÃ ng váº­t tÆ°
interface MaterialItem {
  name: string;
  material: string;
  unit: string;
  quantity: number | string;
  unitPrice: number | string;
  totalPrice: number | string;
  weight?: number | string; // ThÃªm trá»ng lÆ°á»£ng Ä‘á»ƒ tÃ­nh Ä‘Æ¡n giÃ¡
  [key: string]: any;
}

// Äá»‹nh nghÄ©a cáº¥u trÃºc cho dá»¯ liá»‡u há»£p Ä‘á»“ng Ä‘Æ°á»£c gá»­i tá»« client
interface ContractData {
  materials?: MaterialItem[];
  subTotal?: number;
  vatPercentage?: number;
  vatAmount?: number;
  grandTotal?: number;
  [key: string]: any; // Cho phÃ©p cÃ¡c trÆ°á»ng khÃ¡c
}

/**
 * Chuyá»ƒn sá»‘ thÃ nh chá»¯ tiáº¿ng Viá»‡t
 * @param n Sá»‘ cáº§n chuyá»ƒn Ä‘á»•i
 * @returns Chuá»—i biá»ƒu diá»…n sá»‘ báº±ng chá»¯ tiáº¿ng Viá»‡t
 */
function convertNumberToVnWords(n: number): string {
  if (n === null || n === undefined) return '';
  const num = Math.floor(n);
  if (num === 0) return 'Báº±ng chá»¯: KhÃ´ng Ä‘á»“ng cháºµn.';
  const units = ['', ' nghÃ¬n', ' triá»‡u', ' tá»·', ' nghÃ¬n tá»·', ' triá»‡u tá»·'];
  const numbers = [
    'khÃ´ng',
    'má»™t',
    'hai',
    'ba',
    'bá»‘n',
    'nÄƒm',
    'sÃ¡u',
    'báº£y',
    'tÃ¡m',
    'chÃ­n',
  ];
  const convertGroup = (group: number): string => {
    let result = '';
    const tram = Math.floor(group / 100);
    const chuc = Math.floor((group % 100) / 10);
    const donvi = group % 10;
    if (tram > 0) {
      result += numbers[tram] + ' trÄƒm';
      if (chuc === 0 && donvi !== 0) result += ' linh';
    }
    if (chuc > 1) {
      result += (tram > 0 ? ' ' : '') + numbers[chuc] + ' mÆ°Æ¡i';
      if (donvi === 1) result += ' má»‘t';
    } else if (chuc === 1) {
      result += (tram > 0 ? ' ' : '') + 'mÆ°á»i';
    }
    if (donvi > 0 && chuc !== 1) {
      if (donvi === 5 && chuc > 0) {
        result += (result.length > 0 ? ' ' : '') + 'lÄƒm';
      } else if (donvi === 4 && chuc > 1) {
        result += (result.length > 0 ? ' ' : '') + 'tÆ°';
      } else {
        result += (result.length > 0 ? ' ' : '') + numbers[donvi];
      }
    } else if (donvi > 0 && chuc === 1) {
      if (donvi === 5) {
        result += ' lÄƒm';
      } else {
        result += ' ' + numbers[donvi];
      }
    }
    return result;
  };
  if (num === 0) return 'KhÃ´ng';
  let result = '';
  let i = 0;
  let tempNum = num;
  while (tempNum > 0) {
    let groupValue = tempNum % 1000;
    if (groupValue > 0) {
      let groupText = convertGroup(groupValue);
      result = groupText + units[i] + (result ? ' ' + result : '');
    }
    tempNum = Math.floor(tempNum / 1000);
    i++;
  }
  result = result.trim();
  return (
    'Báº±ng chá»¯: ' +
    result.charAt(0).toUpperCase() +
    result.slice(1) +
    ' Ä‘á»“ng cháºµn.'
  );
}

/**
 * Generates a contract by populating a Google Docs template using the "Native Table Insertion" approach.
 * This approach creates a properly formatted table directly using Google Docs API.
 */
export const generateContract = functions
  .region('us-central1')
  .runWith({
    timeoutSeconds: 300,
    memory: '1GB',
  })
  .https.onCall(async (data, context) => {
    // 1. ========= INITIALIZATION & VALIDATION =========
    // Import googleapis chá»‰ khi hÃ m Ä‘Æ°á»£c gá»i
    const { google } = await import('googleapis');

    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Báº¡n pháº£i Ä‘Äƒng nháº­p Ä‘á»ƒ thá»±c hiá»‡n chá»©c nÄƒng nÃ y.'
      );
    }

    const { contractData, fileName, projectId, accessToken } = data as {
      contractData: ContractData;
      fileName: string;
      projectId: string;
      accessToken?: string;
    };
    const typedContractData = contractData as ContractData;

    if (!typedContractData || !fileName || !projectId) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Dá»¯ liá»‡u Ä‘áº§u vÃ o khÃ´ng há»£p lá»‡ (thiáº¿u contractData, fileName, hoáº·c projectId).'
      );
    }

    try {
      if (!accessToken) {
        throw new functions.https.HttpsError(
          'invalid-argument',
          'Thiáº¿u accessToken Google cá»§a ngÆ°á»i dÃ¹ng.'
        );
      }

      // Initialize Google APIs with user's accessToken
      const oauth2Client = new google.auth.OAuth2();
      oauth2Client.setCredentials({ access_token: accessToken });

      const drive = google.drive({ version: 'v3', auth: oauth2Client });
      const docs = google.docs({ version: 'v1', auth: oauth2Client });

      // Get project folder info from Firestore
      const db = admin.firestore();
      const projectDoc = await db.collection('projects').doc(projectId).get();
      const projectData = projectDoc.data();

      if (!projectData || !projectData.driveFolderId) {
        throw new functions.https.HttpsError(
          'failed-precondition',
          'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin thÆ° má»¥c Drive cá»§a dá»± Ã¡n.'
        );
      }

      // Find 'hopdong' subfolder in project folder
      const hopdongFolderResponse = await drive.files.list({
        q: `name='hopdong' and '${projectData.driveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id)',
      });

      let hopdongFolderId;
      if (
        hopdongFolderResponse.data.files &&
        hopdongFolderResponse.data.files.length > 0
      ) {
        hopdongFolderId = hopdongFolderResponse.data.files[0].id;
      } else {
        // Create 'hopdong' folder if it doesn't exist
        const folderResponse = await drive.files.create({
          requestBody: {
            name: 'hopdong',
            mimeType: 'application/vnd.google-apps.folder',
            parents: [projectData.driveFolderId],
          },
          fields: 'id',
        });
        hopdongFolderId = folderResponse.data.id;
      }

      // Copy the template document
      const copiedFileResponse = await drive.files.copy({
        fileId: CONTRACT_TEMPLATE_ID,
        requestBody: {
          name: fileName,
          parents: [hopdongFolderId],
        },
      });
      const newDocId = copiedFileResponse.data.id;
      if (!newDocId) {
        throw new Error('KhÃ´ng thá»ƒ sao chÃ©p file template Google Docs.');
      }

      functions.logger.info(`ÄÃ£ táº¡o file táº¡m tá»« template, ID: ${newDocId}`);

      // 2. ========= TEXT REPLACEMENTS =========
      const requests: docs_v1.Schema$Request[] = [];

      // Xá»­ lÃ½ táº¥t cáº£ cÃ¡c trÆ°á»ng thÃ´ng thÆ°á»ng (khÃ´ng bao gá»“m báº£ng váº­t tÆ°)
      const { materials, ...textFields } = typedContractData;

      Object.entries(textFields).forEach(([key, value]) => {
        // Äáº£m báº£o key cÃ³ dáº¡ng {key} Ä‘á»ƒ phÃ¹ há»£p vá»›i placeholder trong template
        const placeholderKey =
          key.startsWith('{') && key.endsWith('}') ? key : `{${key}}`;

        // Chuyá»ƒn Ä‘á»•i value thÃ nh chuá»—i, Ä‘áº£m báº£o null/undefined trá»Ÿ thÃ nh chuá»—i rá»—ng
        const replacementText = value != null ? String(value) : '';

        requests.push({
          replaceAllText: {
            containsText: {
              text: placeholderKey,
              matchCase: true,
            },
            replaceText: replacementText,
          },
        });
      });

      // 3. ========= APPLY TEXT REPLACEMENTS =========
      if (requests.length > 0) {
        await docs.documents.batchUpdate({
          documentId: newDocId,
          requestBody: { requests },
        });
        functions.logger.info(
          `ÄÃ£ thá»±c hiá»‡n ${requests.length} yÃªu cáº§u thay tháº¿ vÄƒn báº£n.`
        );
      }

      // 4. ========= FIND TABLE PLACEHOLDER POSITION =========
      // Láº¥y ná»™i dung tÃ i liá»‡u Ä‘á»ƒ tÃ¬m vá»‹ trÃ­ cá»§a placeholder {{MATERIALS_TABLE}}
      const document = await docs.documents.get({
        documentId: newDocId,
      });

      // TÃ¬m vá»‹ trÃ­ cá»§a placeholder {{MATERIALS_TABLE}}
      let placeholderIndex: number | null = null;

      if (document.data.body?.content) {
        for (const element of document.data.body.content) {
          if (element.paragraph && element.paragraph.elements) {
            for (const paraElement of element.paragraph.elements) {
              if (
                paraElement.textRun &&
                paraElement.textRun.content &&
                paraElement.textRun.content.includes('{{MATERIALS_TABLE}}')
              ) {
                placeholderIndex = paraElement.startIndex || null;
                break;
              }
            }
            if (placeholderIndex !== null) break;
          }
        }
      }

      if (placeholderIndex === null) {
        functions.logger.warn(
          'KhÃ´ng tÃ¬m tháº¥y placeholder {{MATERIALS_TABLE}} trong tÃ i liá»‡u.'
        );
      } else {
        functions.logger.info(
          `ÄÃ£ tÃ¬m tháº¥y placeholder {{MATERIALS_TABLE}} táº¡i vá»‹ trÃ­: ${placeholderIndex}`
        );

        // 5. ========= CREATE AND INSERT TABLE =========
        const materialsArray = materials || [];
        // +1 cho hÃ ng header
        const numRows = materialsArray.length + 1;
        const numColumns = 7; // STT, Váº­t TÆ°/HÃ ng HÃ³a, VL, ÄVT, SL, ÄÆ¡n giÃ¡, ThÃ nh Tiá»n

        functions.logger.info(
          `Chuáº©n bá»‹ táº¡o báº£ng vá»›i ${numRows} hÃ ng vÃ  ${numColumns} cá»™t.`
        );

        // YÃªu cáº§u Ä‘á»ƒ xÃ³a placeholder vÃ  táº¡o báº£ng trá»‘ng
        const createTableRequests: docs_v1.Schema$Request[] = [
          {
            deleteContentRange: {
              range: {
                startIndex: placeholderIndex,
                endIndex: placeholderIndex + '{{MATERIALS_TABLE}}'.length,
              },
            },
          },
          {
            insertTable: {
              location: { index: placeholderIndex },
              rows: numRows,
              columns: numColumns,
            },
          },
        ];

        // Thá»±c thi táº¡o báº£ng
        await docs.documents.batchUpdate({
          documentId: newDocId,
          requestBody: { requests: createTableRequests },
        });
        functions.logger.info(
          'ÄÃ£ xÃ³a placeholder vÃ  táº¡o báº£ng trá»‘ng thÃ nh cÃ´ng.'
        );

        // 6. ========= POPULATE TABLE WITH DATA (ÄÃƒ Sá»¬A Lá»–I) =========
        // Láº¥y láº¡i tÃ i liá»‡u Ä‘á»ƒ cÃ³ cáº¥u trÃºc báº£ng má»›i nháº¥t vÃ  cÃ¡c chá»‰ sá»‘ chÃ­nh xÃ¡c
        const docWithTable = await docs.documents.get({
          documentId: newDocId,
        });

        // TÃ¬m báº£ng vá»«a táº¡o
        let tableElement: docs_v1.Schema$Table | undefined;
        let tableStartLocation: number | undefined;

        if (docWithTable.data.body?.content) {
          for (const element of docWithTable.data.body.content) {
            // TÃ¬m báº£ng cÃ³ startIndex gáº§n vá»›i vá»‹ trÃ­ placeholder ban Ä‘áº§u
            if (
              element.table &&
              element.startIndex &&
              Math.abs(element.startIndex - placeholderIndex) < 10
            ) {
              tableElement = element.table;
              tableStartLocation = element.startIndex;
              functions.logger.info(
                `ÄÃ£ tÃ¬m tháº¥y báº£ng táº¡i vá»‹ trÃ­: ${element.startIndex}`
              );
              break;
            }
          }
        }

        if (!tableElement || !tableElement.tableRows || !tableStartLocation) {
          throw new Error('KhÃ´ng tÃ¬m tháº¥y báº£ng vá»«a táº¡o Ä‘á»ƒ Ä‘iá»n dá»¯ liá»‡u.');
        }

        // *** THÃŠM Má»šI: Äá»‹nh dáº¡ng chiá»u rá»™ng cá»™t ***
        const columnWidths = [
          { index: 0, width: 30 }, // STT
          { index: 1, width: 190 }, // Váº­t TÆ°, HÃ ng HÃ³a
          { index: 2, width: 60 }, // VL
          { index: 3, width: 40 }, // ÄVT
          { index: 4, width: 30 }, // SL
          { index: 5, width: 70 }, // ÄÆ¡n giÃ¡
          { index: 6, width: 70 }, // ThÃ nh Tiá»n
        ];

        const setWidthRequests: docs_v1.Schema$Request[] = columnWidths.map(
          (col) => ({
            updateTableColumnProperties: {
              tableStartLocation: { index: tableStartLocation },
              columnIndices: [col.index],
              tableColumnProperties: {
                width: { magnitude: col.width, unit: 'PT' },
                widthType: 'FIXED_WIDTH',
              },
              fields: 'width,widthType',
            },
          })
        );

        await docs.documents.batchUpdate({
          documentId: newDocId,
          requestBody: { requests: setWidthRequests },
        });
        functions.logger.info('ÄÃ£ Ä‘á»‹nh dáº¡ng chiá»u rá»™ng cÃ¡c cá»™t thÃ nh cÃ´ng.');

        // *** THAY Äá»”I: Chuáº©n bá»‹ dá»¯ liá»‡u chá»‰ cho báº£ng váº­t tÆ° ***
        const headers = [
          'STT',
          'Váº­t TÆ°, HÃ ng HÃ³a',
          'VL',
          'ÄVT',
          'SL',
          'ÄÆ¡n giÃ¡',
          'ThÃ nh Tiá»n',
        ];
        const tableData: string[][] = [headers];

        materialsArray.forEach((material, index) => {
          // Kiá»ƒm tra xem hÃ ng nÃ y cÃ³ pháº£i lÃ  ghi chÃº khÃ´ng
          const nameIsNote = (material.name || '')
            .toUpperCase()
            .includes('GHI CHÃš');
          const startsWithPlus = (material.name || '').trim().startsWith('+');
          const isEmptyDetails =
            (!material.unit || material.unit === '') &&
            (material.quantity === null ||
              material.quantity === undefined ||
              Number(material.quantity) === 0) &&
            (!material.material || material.material === '');

          const isNoteRow =
            material.isNote ||
            nameIsNote ||
            startsWithPlus ||
            isEmptyDetails ||
            (material.name && material.name.includes('-----')) ||
            (material.name &&
              material.name.toLowerCase().includes('tá»•ng phá»¥')) ||
            (material.name && material.name.toLowerCase().includes('táº¡m tÃ­nh'));

          if (isNoteRow) {
            // Äá»‘i vá»›i ghi chÃº, chá»‰ Ä‘iá»n vÃ o cá»™t tÃªn vÃ  Ä‘á»ƒ trá»‘ng cÃ¡c cá»™t khÃ¡c
            tableData.push([
              '', // KhÃ´ng hiá»ƒn thá»‹ sá»‘ thá»© tá»±
              material.name || '', // Chá»‰ hiá»ƒn thá»‹ tÃªn/ghi chÃº
              '', // KhÃ´ng hiá»ƒn thá»‹ VL
              '', // KhÃ´ng hiá»ƒn thá»‹ ÄVT
              '', // KhÃ´ng hiá»ƒn thá»‹ SL
              '', // KhÃ´ng hiá»ƒn thá»‹ Ä‘Æ¡n giÃ¡
              '', // KhÃ´ng hiá»ƒn thá»‹ thÃ nh tiá»n
            ]);
          } else {
            // TÃ­nh Ä‘Æ¡n giÃ¡ dá»±a trÃªn khá»‘i lÆ°á»£ng vÃ  Ä‘Æ¡n giÃ¡/kg
            const weight = Number(material.weight || 0);
            const unitPricePerKg = Number(material.unitPrice || 0);

            // Xá»­ lÃ½ Ä‘áº·c biá»‡t Ä‘Æ¡n giÃ¡ khi KL = 0
            let calculatedUnitPrice;
            if (weight === 0) {
              // Náº¿u KL = 0, sá»­ dá»¥ng Ä‘Æ¡n giÃ¡ trá»±c tiáº¿p tá»« dá»¯ liá»‡u Ä‘áº§u vÃ o
              calculatedUnitPrice = unitPricePerKg;
            } else {
              // NgÆ°á»£c láº¡i tÃ­nh Ä‘Æ¡n giÃ¡ theo cÃ´ng thá»©c cÅ©
              calculatedUnitPrice = weight * unitPricePerKg;
            }

            const quantity = Number(material.quantity || 0);
            const totalPrice = quantity * calculatedUnitPrice;

            // Sá»­ dá»¥ng toÃ¡n tá»­ ba ngÃ´i Ä‘á»ƒ kiá»ƒm tra giÃ¡ trá»‹ báº±ng 0
            tableData.push([
              (index + 1).toString(),
              material.name || '',
              material.material || '',
              material.unit || 'cÃ¡i',
              quantity > 0 ? String(quantity) : '', // Äá»ƒ trá»‘ng náº¿u SL = 0
              calculatedUnitPrice > 0
                ? Math.floor(calculatedUnitPrice).toLocaleString('vi-VN')
                : '', // Äá»ƒ trá»‘ng náº¿u ÄÆ¡n giÃ¡ = 0
              totalPrice > 0
                ? Math.floor(totalPrice).toLocaleString('vi-VN')
                : '', // Äá»ƒ trá»‘ng náº¿u ThÃ nh tiá»n = 0
            ]);
          }
        });

        functions.logger.info(
          `ÄÃ£ chuáº©n bá»‹ dá»¯ liá»‡u cho ${tableData.length} hÃ ng`
        );

        const dataFillRequests: docs_v1.Schema$Request[] = [];

        // Thiáº¿t láº­p font chá»¯ Times New Roman, mÃ u Ä‘en, cá»¡ 12 cho toÃ n bá»™ báº£ng
        if (tableStartLocation) {
          // Thay vÃ¬ thiáº¿t láº­p font cho toÃ n bá»™ báº£ng vá»›i má»™t lá»‡nh, chÃºng ta sáº½ thiáº¿t láº­p font cho tá»«ng Ã´ khi chÃ¨n dá»¯ liá»‡u
          functions.logger.info(
            'Sáº½ thiáº¿t láº­p font chá»¯ cho tá»«ng Ã´ khi chÃ¨n dá»¯ liá»‡u'
          );
        }

        // *** Lá»–I ÄÆ¯á»¢C Sá»¬A Táº I ÄÃ‚Y: Láº¶P NGÆ¯á»¢C Tá»ª CUá»I LÃŠN Äáº¦U ***
        for (let r = tableData.length - 1; r >= 0; r--) {
          const rowData = tableData[r];
          for (let c = rowData.length - 1; c >= 0; c--) {
            const cellData = rowData[c];
            if (!cellData) continue; // Bá» qua Ã´ trá»‘ng

            const cell = tableElement.tableRows[r]?.tableCells?.[c];
            if (!cell?.content?.[0]?.paragraph?.elements?.[0]?.startIndex) {
              functions.logger.warn(`KhÃ´ng tÃ¬m tháº¥y vá»‹ trÃ­ cho Ã´ [${r}, ${c}]`);
              continue;
            }

            const cellStartIndex =
              cell.content[0].paragraph.elements[0].startIndex;
            functions.logger.info(
              `Äiá»n "${cellData}" vÃ o Ã´ [${r}, ${c}] táº¡i vá»‹ trÃ­ ${cellStartIndex}`
            );

            // 1. ThÃªm yÃªu cáº§u chÃ¨n vÄƒn báº£n
            dataFillRequests.push({
              insertText: {
                location: { index: cellStartIndex },
                text: cellData,
              },
            });

            // 2. ThÃªm yÃªu cáº§u Ä‘á»‹nh dáº¡ng
            const textRange = {
              startIndex: cellStartIndex,
              endIndex: cellStartIndex + cellData.length,
            };

            // Thiáº¿t láº­p font chá»¯ Times New Roman, mÃ u Ä‘en, cá»¡ 12 cho tá»«ng Ã´
            dataFillRequests.push({
              updateTextStyle: {
                range: textRange,
                textStyle: {
                  weightedFontFamily: { fontFamily: 'Times New Roman' },
                  fontSize: { magnitude: 12, unit: 'PT' },
                  foregroundColor: {
                    color: {
                      rgbColor: { red: 0, green: 0, blue: 0 },
                    },
                  },
                },
                fields: 'weightedFontFamily,fontSize,foregroundColor',
              },
            });

            // In Ä‘áº­m cho hÃ ng tiÃªu Ä‘á» vÃ  cÃ¡c hÃ ng tá»•ng cá»™ng
            // In Ä‘áº­m cho hÃ ng tiÃªu Ä‘á» vÃ  cÃ¡c hÃ ng tá»•ng cá»™ng
            // Chá»‰ in Ä‘áº­m cho hÃ ng tiÃªu Ä‘á»
            if (r === 0) {
              // <--- ÄÃƒ Sá»¬A
              dataFillRequests.push({
                updateTextStyle: {
                  range: textRange,
                  textStyle: { bold: true },
                  fields: 'bold',
                },
              });
            }

            // CÄƒn giá»¯a cho táº¥t cáº£ cÃ¡c Ã´ (theo yÃªu cáº§u)
            dataFillRequests.push({
              updateParagraphStyle: {
                range: textRange,
                paragraphStyle: { alignment: 'CENTER' },
                fields: 'alignment',
              },
            });

            // CÄƒn giá»¯a theo chiá»u dá»c
            dataFillRequests.push({
              updateTableCellStyle: {
                tableRange: {
                  tableCellLocation: {
                    tableStartLocation: { index: tableStartLocation || 0 },
                    rowIndex: r,
                    columnIndex: c,
                  },
                  rowSpan: 1,
                  columnSpan: 1,
                },
                tableCellStyle: {
                  contentAlignment: 'MIDDLE',
                },
                fields: 'contentAlignment',
              },
            });
          }
        }

        // Äá»‹nh dáº¡ng mÃ u ná»n vÃ  viá»n cho báº£ng
        if (tableStartLocation) {
          // MÃ u ná»n cho hÃ ng tiÃªu Ä‘á»
          dataFillRequests.push({
            updateTableCellStyle: {
              tableRange: {
                tableCellLocation: {
                  tableStartLocation: { index: tableStartLocation },
                  rowIndex: 0,
                  columnIndex: 0,
                },
                rowSpan: 1,
                columnSpan: numColumns,
              },
              tableCellStyle: {
                backgroundColor: {
                  // MÃ u xanh nháº¡t giá»‘ng trong template
                  color: {
                    rgbColor: { red: 0.737, green: 0.867, blue: 0.898 },
                  },
                },
              },
              fields: 'backgroundColor',
            },
          });

          // Viá»n cho toÃ n bá»™ báº£ng
          dataFillRequests.push({
            updateTableCellStyle: {
              tableRange: {
                tableCellLocation: {
                  tableStartLocation: { index: tableStartLocation },
                  rowIndex: 0,
                  columnIndex: 0,
                },
                rowSpan: numRows,
                columnSpan: numColumns,
              },
              tableCellStyle: {
                borderBottom: {
                  color: { color: { rgbColor: { red: 0, green: 0, blue: 0 } } },
                  width: { magnitude: 1, unit: 'PT' },
                  dashStyle: 'SOLID',
                },
                borderTop: {
                  color: { color: { rgbColor: { red: 0, green: 0, blue: 0 } } },
                  width: { magnitude: 1, unit: 'PT' },
                  dashStyle: 'SOLID',
                },
                borderLeft: {
                  color: { color: { rgbColor: { red: 0, green: 0, blue: 0 } } },
                  width: { magnitude: 1, unit: 'PT' },
                  dashStyle: 'SOLID',
                },
                borderRight: {
                  color: { color: { rgbColor: { red: 0, green: 0, blue: 0 } } },
                  width: { magnitude: 1, unit: 'PT' },
                  dashStyle: 'SOLID',
                },
              },
              fields: 'borderBottom,borderTop,borderLeft,borderRight',
            },
          });
        }

        // ThÃªm yÃªu cáº§u Ä‘á»ƒ merge cÃ¡c Ã´ cho hÃ ng ghi chÃº
        if (tableStartLocation) {
          const mergeCellsRequests: docs_v1.Schema$Request[] = [];

          // XÃ¡c Ä‘á»‹nh hÃ ng nÃ o lÃ  hÃ ng ghi chÃº cáº§n merge
          materialsArray.forEach((material, rowIndex) => {
            // Sá»­ dá»¥ng láº¡i logic Ä‘á»ƒ xÃ¡c Ä‘á»‹nh hÃ ng ghi chÃº
            const nameIsNote = (material.name || '')
              .toUpperCase()
              .includes('GHI CHÃš');
            const startsWithPlus = (material.name || '').trim().startsWith('+');
            const isEmptyDetails =
              (!material.unit || material.unit === '') &&
              (material.quantity === null ||
                material.quantity === undefined ||
                Number(material.quantity) === 0) &&
              (!material.material || material.material === '');

            const isNoteRow =
              material.isNote ||
              nameIsNote ||
              startsWithPlus ||
              isEmptyDetails ||
              (material.name && material.name.includes('-----')) ||
              (material.name &&
                material.name.toLowerCase().includes('tá»•ng phá»¥')) ||
              (material.name &&
                material.name.toLowerCase().includes('táº¡m tÃ­nh'));

            if (isNoteRow) {
              // Táº¡o yÃªu cáº§u merge táº¥t cáº£ cÃ¡c Ã´ trong hÃ ng nÃ y - hÃ ng Ä‘áº§u tiÃªn (0) lÃ  header nÃªn rowIndex + 1
              mergeCellsRequests.push({
                mergeTableCells: {
                  tableRange: {
                    tableCellLocation: {
                      tableStartLocation: { index: tableStartLocation },
                      rowIndex: rowIndex + 1, // +1 vÃ¬ hÃ ng 0 lÃ  header
                      columnIndex: 0,
                    },
                    rowSpan: 1,
                    columnSpan: numColumns,
                  },
                },
              });

              // ThÃªm Ä‘á»‹nh dáº¡ng Ä‘áº·c biá»‡t cho hÃ ng ghi chÃº Ä‘Ã£ merge
              const cellStartIndex =
                tableElement?.tableRows?.[rowIndex + 1]?.tableCells?.[0]
                  ?.content?.[0]?.paragraph?.elements?.[0]?.startIndex;

              if (cellStartIndex && material.name) {
                const textRange = {
                  startIndex: cellStartIndex,
                  endIndex: cellStartIndex + material.name.length,
                };

                // Äá»‹nh dáº¡ng cÄƒn giá»¯a vÃ  in nghiÃªng cho ghi chÃº
                dataFillRequests.push({
                  updateParagraphStyle: {
                    range: textRange,
                    paragraphStyle: { alignment: 'CENTER' },
                    fields: 'alignment',
                  },
                });

                // In nghiÃªng cho ghi chÃº thÃ´ng thÆ°á»ng, in Ä‘áº­m cho hÃ ng tá»•ng phá»¥, táº¡m tÃ­nh
                if (
                  material.name.toLowerCase().includes('tá»•ng phá»¥') ||
                  material.name.toLowerCase().includes('táº¡m tÃ­nh')
                ) {
                  dataFillRequests.push({
                    updateTextStyle: {
                      range: textRange,
                      textStyle: {
                        bold: true,
                        italic: false,
                      },
                      fields: 'bold,italic',
                    },
                  });
                } else {
                  dataFillRequests.push({
                    updateTextStyle: {
                      range: textRange,
                      textStyle: {
                        italic: true,
                        bold: false,
                      },
                      fields: 'italic,bold',
                    },
                  });
                }
              }
            }
          });

          // Thá»±c thi cÃ¡c yÃªu cáº§u merge náº¿u cÃ³
          if (mergeCellsRequests.length > 0) {
            await docs.documents.batchUpdate({
              documentId: newDocId,
              requestBody: { requests: mergeCellsRequests },
            });
            functions.logger.info(
              `ÄÃ£ merge cÃ¡c Ã´ cho ${mergeCellsRequests.length} hÃ ng ghi chÃº.`
            );
          }
        }

        // Thá»±c thi táº¥t cáº£ cÃ¡c yÃªu cáº§u Ä‘iá»n vÃ  Ä‘á»‹nh dáº¡ng dá»¯ liá»‡u
        if (dataFillRequests.length > 0) {
          await docs.documents.batchUpdate({
            documentId: newDocId,
            requestBody: { requests: dataFillRequests },
          });
          functions.logger.info(
            `ÄÃ£ Ä‘iá»n vÃ  Ä‘á»‹nh dáº¡ng dá»¯ liá»‡u cho ${tableData.length} hÃ ng.`
          );
        }

        // 7. ========= INSERT SUMMARY SECTION (Báº¢NG Tá»”NG Káº¾T) =========
        // Láº¥y láº¡i tÃ i liá»‡u Ä‘á»ƒ xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ cuá»‘i cá»§a báº£ng váº­t tÆ°
        const docWithTableFilled = await docs.documents.get({
          documentId: newDocId,
        });

        let tableEndIndex: number | undefined;
        if (docWithTableFilled.data.body?.content) {
          for (const element of docWithTableFilled.data.body.content) {
            if (
              element.table &&
              element.startIndex &&
              element.endIndex &&
              Math.abs(element.startIndex - (tableStartLocation || 0)) < 10
            ) {
              tableEndIndex = element.endIndex;
              functions.logger.info(
                `TÃ¬m tháº¥y vá»‹ trÃ­ káº¿t thÃºc cá»§a báº£ng váº­t tÆ°: ${tableEndIndex}`
              );
              break;
            }
          }
        }

        if (!tableEndIndex) {
          throw new Error('KhÃ´ng tÃ¬m tháº¥y vá»‹ trÃ­ káº¿t thÃºc báº£ng váº­t tÆ°');
        }

        // TÃ­nh toÃ¡n giÃ¡ trá»‹ tá»•ng káº¿t - tá»± tÃ­nh toÃ¡n má»i giÃ¡ trá»‹, khÃ´ng dÃ¹ng giÃ¡ trá»‹ tá»« input
        // Hardcode VAT rate lÃ  10%
        const vatPercentage = 10;

        // TÃ­nh tá»•ng tiá»n hÃ ng tá»« danh sÃ¡ch váº­t tÆ°
        let subTotal = 0;
        materialsArray.forEach((material) => {
          // TÃ­nh láº¡i Ä‘Æ¡n giÃ¡ vÃ  thÃ nh tiá»n Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh Ä‘Ãºng
          const weight = Number(material.weight || 0);
          const unitPricePerKg = Number(material.unitPrice || 0);

          // Xá»­ lÃ½ Ä‘áº·c biá»‡t Ä‘Æ¡n giÃ¡ khi KL = 0 (giá»‘ng nhÆ° trong pháº§n hiá»ƒn thá»‹)
          let calculatedUnitPrice;
          if (weight === 0) {
            // Náº¿u KL = 0, sá»­ dá»¥ng Ä‘Æ¡n giÃ¡ trá»±c tiáº¿p tá»« dá»¯ liá»‡u Ä‘áº§u vÃ o
            calculatedUnitPrice = unitPricePerKg;
          } else {
            // NgÆ°á»£c láº¡i tÃ­nh Ä‘Æ¡n giÃ¡ theo cÃ´ng thá»©c cÅ©
            calculatedUnitPrice = weight * unitPricePerKg;
          }

          const quantity = Number(material.quantity || 0);
          const totalPrice = quantity * calculatedUnitPrice;
          subTotal += totalPrice;
        });

        // TÃ­nh thuáº¿ VAT vÃ  tá»•ng tiá»n thanh toÃ¡n
        const vatAmount = (subTotal * vatPercentage) / 100;
        const grandTotal = subTotal + vatAmount;

        // TÃ­nh half_total SAU KHI Ä‘Ã£ tÃ­nh toÃ¡n xong grandTotal
        const halfTotal = Math.floor(grandTotal * 0.5);
        // Táº¡o chuá»—i half_total chá»‰ sau khi biáº¿t cháº¯c cháº¯n halfTotal lÃ  sá»‘ há»£p lá»‡
        const halfTotalFormatted = halfTotal.toLocaleString('vi-VN');
        const halfTotalText = `${halfTotalFormatted} Ä‘ (${convertNumberToVnWords(
          halfTotal
        )})`;

        // Thá»±c hiá»‡n thay tháº¿ half_total trong vÄƒn báº£n
        const halfTotalRequests: docs_v1.Schema$Request[] = [
          {
            replaceAllText: {
              containsText: { text: '{half_total}', matchCase: false },
              replaceText: halfTotalText,
            },
          },
        ];

        // Ãp dá»¥ng thay tháº¿ half_total
        if (halfTotalRequests.length > 0) {
          await docs.documents.batchUpdate({
            documentId: newDocId,
            requestBody: { requests: halfTotalRequests },
          });
          functions.logger.info('ÄÃ£ thay tháº¿ half_total thÃ nh cÃ´ng.');
        }

        // Tá»± táº¡o chuá»—i "báº±ng chá»¯" tá»« tá»•ng tiá»n Ä‘Ã£ tÃ­nh (bá» pháº§n tháº­p phÃ¢n)
        const amountInWords = convertNumberToVnWords(Math.floor(grandTotal));

        // Táº¡o báº£ng tá»•ng káº¿t (2 cá»™t, 4 hÃ ng)
        const summaryTableRequests: docs_v1.Schema$Request[] = [
          {
            insertTable: {
              location: { index: tableEndIndex },
              rows: 4,
              columns: 2,
            },
          },
        ];

        await docs.documents.batchUpdate({
          documentId: newDocId,
          requestBody: { requests: summaryTableRequests },
        });
        functions.logger.info('ÄÃ£ táº¡o báº£ng tá»•ng káº¿t sau báº£ng váº­t tÆ°');

        // Láº¥y láº¡i tÃ i liá»‡u Ä‘á»ƒ Ä‘á»‹nh vá»‹ báº£ng tá»•ng káº¿t vá»«a táº¡o
        const docWithSummaryTable = await docs.documents.get({
          documentId: newDocId,
        });

        let summaryTable: docs_v1.Schema$Table | undefined;
        let summaryTableStartIndex: number | undefined;

        if (docWithSummaryTable.data.body?.content) {
          for (const element of docWithSummaryTable.data.body.content) {
            if (
              element.table &&
              element.startIndex &&
              element.startIndex > (tableEndIndex || 0) - 5
            ) {
              // Láº¥y báº£ng Ä‘áº§u tiÃªn sau báº£ng váº­t tÆ°
              summaryTable = element.table;
              summaryTableStartIndex = element.startIndex;
              functions.logger.info(
                `TÃ¬m tháº¥y báº£ng tá»•ng káº¿t táº¡i vá»‹ trÃ­: ${element.startIndex}`
              );
              break;
            }
          }
        }

        if (!summaryTable || !summaryTableStartIndex) {
          throw new Error('KhÃ´ng tÃ¬m tháº¥y báº£ng tá»•ng káº¿t sau khi táº¡o');
        }

        // Chuáº©n bá»‹ dá»¯ liá»‡u cho báº£ng tá»•ng káº¿t
        const summaryData = [
          [
            'Cá»˜NG TIá»€N HÃ€NG:',
            Math.floor(subTotal).toLocaleString('vi-VN') + ' Ä‘',
          ],
          [
            `THUáº¾ GTGT ${vatPercentage}%:`,
            Math.floor(vatAmount).toLocaleString('vi-VN') + ' Ä‘',
          ],
          [
            'Tá»”NG TIá»€N THANH TOÃN:',
            Math.floor(grandTotal).toLocaleString('vi-VN') + ' Ä‘',
          ],
          [amountInWords], // Chá»‰ chá»©a má»™t pháº§n tá»­ Ä‘á»ƒ gá»™p Ã´
        ];

        // Táº¡o cÃ¡c yÃªu cáº§u Ä‘á»ƒ Ä‘iá»n dá»¯ liá»‡u vÃ  Ä‘á»‹nh dáº¡ng báº£ng tá»•ng káº¿t
        const summaryFillRequests: docs_v1.Schema$Request[] = [];

        // Láº·p ngÆ°á»£c Ä‘á»ƒ Ä‘iá»n dá»¯ liá»‡u tá»« cuá»‘i lÃªn Ä‘áº§u (trÃ¡nh lá»—i vá»‹ trÃ­)
        for (let r = summaryData.length - 1; r >= 0; r--) {
          for (let c = summaryData[r].length - 1; c >= 0; c--) {
            const cellData = summaryData[r][c];
            if (!cellData) continue;

            const cell = summaryTable.tableRows?.[r]?.tableCells?.[c];
            if (!cell?.content?.[0]?.paragraph?.elements?.[0]?.startIndex) {
              functions.logger.warn(
                `KhÃ´ng tÃ¬m tháº¥y vá»‹ trÃ­ cho Ã´ tá»•ng káº¿t [${r}, ${c}]`
              );
              continue;
            }

            const cellStartIndex =
              cell.content[0].paragraph.elements[0].startIndex;
            functions.logger.info(
              `Äiá»n dá»¯ liá»‡u "${cellData}" vÃ o Ã´ tá»•ng káº¿t [${r}, ${c}] táº¡i vá»‹ trÃ­ ${cellStartIndex}`
            );

            // ChÃ¨n vÄƒn báº£n
            summaryFillRequests.push({
              insertText: {
                location: { index: cellStartIndex },
                text: cellData,
              },
            });

            const textRange = {
              startIndex: cellStartIndex,
              endIndex: cellStartIndex + cellData.length,
            };

            // Äá»‹nh dáº¡ng font, mÃ u sáº¯c vÃ  in Ä‘áº­m
            summaryFillRequests.push({
              updateTextStyle: {
                range: textRange,
                textStyle: {
                  weightedFontFamily: { fontFamily: 'Times New Roman' },
                  fontSize: { magnitude: 12, unit: 'PT' },
                  bold: r < 3, // Chá»‰ in Ä‘áº­m 3 dÃ²ng Ä‘áº§u tiÃªn (0, 1, 2), khÃ´ng in Ä‘áº­m dÃ²ng "Báº±ng chá»¯:" (3)
                  foregroundColor: {
                    color: {
                      rgbColor: { red: 0, green: 0, blue: 0 },
                    },
                  },
                },
                fields: 'weightedFontFamily,fontSize,bold,foregroundColor',
              },
            });

            // CÄƒn lá»
            let alignment: 'END' | 'START' = 'START';
            if (c === 1) {
              // Cá»™t giÃ¡ trá»‹ cÄƒn pháº£i
              alignment = 'END';
            }
            // DÃ²ng "Báº±ng chá»¯" cÄƒn trÃ¡i
            if (r === 3) {
              alignment = 'START';
            }

            summaryFillRequests.push({
              updateParagraphStyle: {
                range: textRange,
                paragraphStyle: { alignment: alignment },
                fields: 'alignment',
              },
            });
          }
        }

        // Gá»™p Ã´ cho dÃ²ng "Báº±ng chá»¯"
        summaryFillRequests.push({
          mergeTableCells: {
            tableRange: {
              tableCellLocation: {
                tableStartLocation: { index: summaryTableStartIndex },
                rowIndex: 3, // HÃ ng cuá»‘i cÃ¹ng (báº±ng chá»¯)
                columnIndex: 0,
              },
              rowSpan: 1,
              columnSpan: 2,
            },
          },
        });

        // XÃ³a viá»n cá»§a báº£ng tá»•ng káº¿t Ä‘á»ƒ nÃ³ hÃ²a vÃ o vÄƒn báº£n
        summaryFillRequests.push({
          updateTableCellStyle: {
            tableRange: {
              tableCellLocation: {
                tableStartLocation: { index: summaryTableStartIndex },
                rowIndex: 0,
                columnIndex: 0,
              },
              rowSpan: 4,
              columnSpan: 2,
            },
            tableCellStyle: {
              borderBottom: {
                width: { magnitude: 0, unit: 'PT' },
                dashStyle: 'SOLID',
                color: { color: { rgbColor: {} } },
              },
              borderTop: {
                width: { magnitude: 0, unit: 'PT' },
                dashStyle: 'SOLID',
                color: { color: { rgbColor: {} } },
              },
              borderLeft: {
                width: { magnitude: 0, unit: 'PT' },
                dashStyle: 'SOLID',
                color: { color: { rgbColor: {} } },
              },
              borderRight: {
                width: { magnitude: 0, unit: 'PT' },
                dashStyle: 'SOLID',
                color: { color: { rgbColor: {} } },
              },
            },
            fields: 'borderBottom,borderTop,borderLeft,borderRight',
          },
        });

        // Thá»±c thi cÃ¡c yÃªu cáº§u Ä‘iá»n vÃ  Ä‘á»‹nh dáº¡ng cho báº£ng tá»•ng káº¿t
        if (summaryFillRequests.length > 0) {
          await docs.documents.batchUpdate({
            documentId: newDocId,
            requestBody: { requests: summaryFillRequests },
          });
          functions.logger.info(
            'ÄÃ£ Ä‘iá»n vÃ  Ä‘á»‹nh dáº¡ng báº£ng tá»•ng káº¿t thÃ nh cÃ´ng'
          );
        }
      }

      // 8. ========= RETURN DOCX INFO =========
      // Cáº¥p quyá»n xem cho Google Doc Ä‘á»ƒ ngÆ°á»i dÃ¹ng cÃ³ link cÃ³ thá»ƒ xem
      await drive.permissions.create({
        fileId: newDocId,
        requestBody: { role: 'reader', type: 'anyone' },
      });

      const docUrl = `https://docs.google.com/document/d/${newDocId}/edit`;
      functions.logger.info(`Táº¡o há»£p Ä‘á»“ng thÃ nh cÃ´ng. Doc URL: ${docUrl}`);

      // Tráº£ vá» URL cá»§a Google Doc vÃ  ID
      return {
        docUrl,
        docId: newDocId,
      };
    } catch (error) {
      functions.logger.error('Lá»—i nghiÃªm trá»ng khi táº¡o há»£p Ä‘á»“ng:', error);
      if (error instanceof Error) {
        throw new functions.https.HttpsError(
          'internal',
          `KhÃ´ng thá»ƒ táº¡o há»£p Ä‘á»“ng: ${error.message}`
        );
      }
      throw new functions.https.HttpsError(
        'internal',
        'ÄÃ£ xáº£y ra lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh khi táº¡o há»£p Ä‘á»“ng.'
      );
    }
  });


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\createProjectFolders.ts ---

import * as functions from 'firebase-functions/v1';
import * as admin from 'firebase-admin';
import { getDriveClient } from './utils/driveClient';
import { APP_DRIVE_ROOT_FOLDER_ID } from './config';

const db = admin.firestore();

/**
 * Callable: createProjectFolders
 * - Input: { projectId: string }
 * - Creates a Drive folder for the project inside the app root and
 *   sub-folders [baogia, hopdong, PO, QC_Reports].
 * - Saves driveFolderId, driveFolderUrl back to Firestore.
 */
export const createProjectFolders = functions
  .region('asia-southeast1')
  .runWith({ timeoutSeconds: 300, memory: '1GB' })
  .https.onCall(async (data, context) => {
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Báº¡n cáº§n Ä‘Äƒng nháº­p.'
      );
    }

    const { projectId } = data as { projectId?: string };
    if (!projectId) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Thiáº¿u projectId'
      );
    }

    const projectRef = db.collection('projects').doc(projectId);
    const projectSnap = await projectRef.get();
    if (!projectSnap.exists) {
      throw new functions.https.HttpsError('not-found', 'KhÃ´ng tÃ¬m tháº¥y dá»± Ã¡n');
    }

    const projectData = projectSnap.data()!;
    if (projectData.driveFolderId) {
      // Folder Ä‘Ã£ tá»“n táº¡i, tráº£ vá» ngay
      return {
        success: true,
        driveFolderId: projectData.driveFolderId,
        driveFolderUrl: projectData.driveFolderUrl,
        skipped: true,
      };
    }

    try {
      const drive = await getDriveClient();

      // Sanitize name (khÃ´ng kÃ½ tá»± Ä‘áº·c biá»‡t mÃ  Drive cáº¥m)
      const cleanName = (projectData.name || projectId).replace(
        /[\\/:*?"<>|]/g,
        '_'
      );

      // 1. Táº¡o thÆ° má»¥c dá»± Ã¡n bÃªn trong ROOT
      const projectFolderRes = await drive.files.create({
        requestBody: {
          name: cleanName,
          mimeType: 'application/vnd.google-apps.folder',
          parents: [APP_DRIVE_ROOT_FOLDER_ID],
        },
        fields: 'id, webViewLink',
      });

      const projectFolderId = projectFolderRes.data.id!;

      // 2. Táº¡o sub-folders
      const subNames = ['baogia', 'hopdong', 'PO', 'QC_Reports'];
      await Promise.all(
        subNames.map((sub) =>
          drive.files.create({
            requestBody: {
              name: sub,
              mimeType: 'application/vnd.google-apps.folder',
              parents: [projectFolderId],
            },
          })
        )
      );

      // 3. Ghi Firestore
      await projectRef.update({
        driveFolderId: projectFolderId,
        driveFolderUrl: projectFolderRes.data.webViewLink,
        driveCreatedAt: admin.firestore.FieldValue.serverTimestamp(),
      });

      return {
        success: true,
        driveFolderId: projectFolderId,
        driveFolderUrl: projectFolderRes.data.webViewLink,
        skipped: false,
      };
    } catch (err: any) {
      console.error('createProjectFolders error:', err);
      throw new functions.https.HttpsError(
        'internal',
        err.message || 'Lá»—i táº¡o thÆ° má»¥c dá»± Ã¡n'
      );
    }
  });


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\financialProcessor.ts ---

import * as functions from 'firebase-functions/v2';
import * as admin from 'firebase-admin';
import { google } from 'googleapis';
import * as path from 'path';
import * as XLSX from 'xlsx';
import { Timestamp } from 'firebase-admin/firestore';

const db = admin.firestore();
const SECRET_TOKEN = 'THP_FINANCE_SECRET_TOKEN'; // Should match Apps Script token

// Function to format currency for display
function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND',
  }).format(amount);
}

// Column mapping for Excel file
const colMap = {
  date: 0, // A - NgÃ y CT
  docNumber: 1, // B - BB Sá»
  invoiceNumber: 2, // C - HÃ³a Ä‘Æ¡n
  supplier: 3, // D - TÃŠN ÄÆ N Vá»Š
  description: 4, // E - DIá»„N GIáº¢I
  unit: 5, // F - ÄVT
  quantity: 6, // G - Sá» LÆ¯á»¢NG
  price: 7, // H - ÄÆ N GIÃ
  vat: 8, // I - VAT
  totalAmount: 9, // J - THÃ€NH TIá»€N
  paidAmount: 10, // K - ÄÃƒ THANH TOÃN
  remainingAmount: 11, // L - CÃ’N Láº I
};

// Function to convert Excel date serial number to JS Date
function excelDateToJSDate(excelDate: number): Date {
  // Excel's epoch starts on 1/1/1900
  const millisecondsPerDay = 24 * 60 * 60 * 1000;
  // Excel incorrectly assumes 1900 is a leap year, so we adjust by 1 day for dates after 2/28/1900
  const dayAdjust = excelDate > 59 ? 1 : 0;
  const jsDate = new Date(
    Math.round((excelDate - dayAdjust - 25569) * millisecondsPerDay)
  );
  return jsDate;
}

// Function to clean text values
function cleanText(text: any): string {
  if (!text) return '';
  return String(text).trim().replace(/\s+/g, ' ');
}

// Function to extract numeric value from cell
function extractNumber(value: any): number {
  if (typeof value === 'number') return value;
  if (!value) return 0;

  const numStr = String(value).replace(/[^\d.-]/g, '');
  return numStr ? parseFloat(numStr) : 0;
}

// Function to check if a row is a transaction row
function isTransactionRow(row: any[], currentSupplier: string | null): boolean {
  // Check if date column has a value and we have a current supplier
  return row[colMap.date] && currentSupplier !== null;
}

// Function to check if a row is a supplier header row
function isSupplierRow(row: any[]): boolean {
  const supplierValue = row[colMap.supplier];
  return (
    supplierValue &&
    (String(supplierValue).startsWith('NCC - ') ||
      String(supplierValue).startsWith('KH - '))
  );
}

// Function to check if a row is a total row
function isTotalRow(row: any[]): boolean {
  return row[0] === 'Cá»˜NG';
}

// Function to extract supplier name from cell
function extractSupplierName(cell: any): string {
  if (!cell) return '';
  const text = String(cell);
  if (text.startsWith('NCC - ')) {
    return text.substring(6).trim();
  } else if (text.startsWith('KH - ')) {
    return text.substring(5).trim();
  }
  return text.trim();
}

/**
 * Cloud Function to process payable ledger Excel file from Google Drive
 */
export const processPayableLedgerFromDrive = functions.https.onRequest(
  {
    region: 'asia-southeast1',
    timeoutSeconds: 300, // 5 minutes timeout for large files
  },
  async (req, res) => {
    try {
      // Verify authorization token
      const authHeader = req.headers.authorization;
      if (!authHeader || authHeader !== `Bearer ${SECRET_TOKEN}`) {
        console.error('Invalid or missing authorization token');
        res.status(401).send({ error: 'Unauthorized' });
        return;
      }

      // Get fileId from request body
      const { fileId } = req.body;
      if (!fileId) {
        console.error('No fileId provided in request body');
        res.status(400).send({ error: 'Missing fileId parameter' });
        return;
      }

      console.log(`Processing file with ID: ${fileId}`);

      // Initialize Google Drive API
      const auth = new google.auth.GoogleAuth({
        keyFile: path.join(__dirname, '../tanyb-fe4bf-4fbd5c01b6c7.json'),
        scopes: ['https://www.googleapis.com/auth/drive'],
      });
      const drive = google.drive({ version: 'v3', auth });

      // Download file from Google Drive
      const response = await drive.files.get(
        {
          fileId: fileId,
          alt: 'media',
        },
        { responseType: 'arraybuffer' }
      );

      // Get file metadata to extract filename
      const fileMetadata = await drive.files.get({
        fileId: fileId,
        fields: 'name,createdTime,modifiedTime',
      });

      const fileName = fileMetadata.data.name || 'Unknown File';
      console.log(`Downloaded file: ${fileName}`);

      // Parse Excel file
      const workbook = XLSX.read(response.data, { type: 'array' });
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];

      // Convert to array of arrays
      const rows = XLSX.utils.sheet_to_json(worksheet, {
        header: 1,
      }) as any[][];

      console.log(`Total rows in Excel file: ${rows.length}`);

      // Process rows
      const transactions = [];
      let currentSupplier: string | null = null;
      let isPayable = true; // Default to payable (pháº£i tráº£)

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length === 0) continue;

        // Check if this is a header row that indicates the type of ledger
        if (
          row.some(
            (cell) =>
              cell && String(cell).includes('Sá»” CHI TIáº¾T CÃ”NG Ná»¢ PHáº¢I THU')
          )
        ) {
          isPayable = false;
          currentSupplier = null;
          continue;
        } else if (
          row.some(
            (cell) =>
              cell && String(cell).includes('Sá»” CHI TIáº¾T CÃ”NG Ná»¢ PHáº¢I TRáº¢')
          )
        ) {
          isPayable = true;
          currentSupplier = null;
          continue;
        }

        // Check if this is a supplier row
        if (isSupplierRow(row)) {
          currentSupplier = extractSupplierName(row[colMap.supplier]);
          continue;
        }

        // Check if this is a total row
        if (isTotalRow(row)) {
          currentSupplier = null;
          continue;
        }

        // Skip header rows
        if (row[0] === 'NgÃ y CT' || row[0] === 'NgÃ y') continue;

        // Process transaction row
        if (isTransactionRow(row, currentSupplier)) {
          let transactionDate: Date;

          // Handle date format (could be Excel serial date or string)
          if (typeof row[colMap.date] === 'number') {
            transactionDate = excelDateToJSDate(row[colMap.date]);
          } else if (typeof row[colMap.date] === 'string') {
            // Try to parse date string (DD/MM/YYYY format)
            const dateParts = String(row[colMap.date]).split('/');
            if (dateParts.length === 3) {
              transactionDate = new Date(
                parseInt(dateParts[2]),
                parseInt(dateParts[1]) - 1,
                parseInt(dateParts[0])
              );
            } else {
              // Default to current date if parsing fails
              transactionDate = new Date();
            }
          } else {
            // Default to current date if no valid date
            transactionDate = new Date();
          }

          const transaction = {
            type: isPayable ? 'payable' : 'receivable',
            supplier: currentSupplier || '',
            transactionDate: Timestamp.fromDate(transactionDate),
            docNumber: cleanText(row[colMap.docNumber]),
            invoiceNumber: cleanText(row[colMap.invoiceNumber]),
            description: cleanText(row[colMap.description]),
            amount: extractNumber(row[colMap.totalAmount]),
            paidAmount: extractNumber(row[colMap.paidAmount]),
            remainingAmount: extractNumber(row[colMap.remainingAmount]),
            unit: cleanText(row[colMap.unit]),
            quantity: extractNumber(row[colMap.quantity]),
            price: extractNumber(row[colMap.price]),
            vat: extractNumber(row[colMap.vat]),
            fileId: fileId,
            fileName: fileName,
            processedAt: Timestamp.now(),
          };

          transactions.push(transaction);
        }
      }

      console.log(`Extracted ${transactions.length} transactions`);

      // Save transactions to Firestore using batch write
      const batch = db.batch();

      for (const transaction of transactions) {
        // Generate a unique ID based on supplier, date, and document number
        const idComponents = [
          transaction.supplier,
          transaction.transactionDate.toDate().toISOString().split('T')[0],
          transaction.docNumber || 'nodoc',
          transaction.description
            ? transaction.description.substring(0, 20)
            : 'nodesc',
        ];
        const uniqueId = idComponents.join('_').replace(/[^a-zA-Z0-9_]/g, '');

        const docRef = db.collection('payable_transactions').doc(uniqueId);
        batch.set(docRef, transaction, { merge: true });
      }

      await batch.commit();
      console.log(
        `Successfully saved ${transactions.length} transactions to Firestore`
      );

      // Update the last processed timestamp in a metadata document
      await db.collection('system').doc('financialProcessorMetadata').set(
        {
          lastProcessedAt: Timestamp.now(),
          lastProcessedFile: fileName,
          lastProcessedFileId: fileId,
          transactionsProcessed: transactions.length,
        },
        { merge: true }
      );

      res.status(200).send({
        success: true,
        message: `Successfully processed ${transactions.length} transactions from ${fileName}`,
      });
    } catch (error: any) {
      console.error('Error processing payable ledger:', error);
      res.status(500).send({
        error: 'Failed to process payable ledger',
        details: error.message,
      });
    }
  }
);

/**
 * Orchestrator function to trigger Excel processing from a folder
 * This is a callable function that can be invoked from the client
 */
export const triggerExcelProcessing = functions.https.onCall(
  {
    region: 'asia-southeast1',
    timeoutSeconds: 300, // 5 phÃºt timeout cho file lá»›n
  },
  async () => {
    try {
      console.log('triggerExcelProcessing called');

      // Initialize Google Drive API
      const auth = new google.auth.GoogleAuth({
        keyFile: path.join(__dirname, '../tanyb-fe4bf-4fbd5c01b6c7.json'),
        scopes: ['https://www.googleapis.com/auth/drive'],
      });
      const drive = google.drive({ version: 'v3', auth });

      // Define the folder ID where Excel files are stored
      const FOLDER_ID = '1Ci_BHZx0-Uhv2xg5IzwLPn05yPAUXOOU';

      // Search for Excel files in the specified folder
      const response = await drive.files.list({
        q: `'${FOLDER_ID}' in parents and (mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' or mimeType='application/vnd.ms-excel') and trashed=false`,
        orderBy: 'modifiedTime desc',
        pageSize: 1, // Get only the latest file
        fields: 'files(id,name,modifiedTime)',
      });

      const files = response.data.files;
      if (!files || files.length === 0) {
        throw new functions.https.HttpsError(
          'not-found',
          'No Excel files found in the specified folder'
        );
      }

      const latestFile = files[0];
      console.log(
        `Found latest file: ${latestFile.name} (ID: ${latestFile.id})`
      );

      // Download file from Google Drive
      const fileResponse = await drive.files.get(
        {
          fileId: latestFile.id!,
          alt: 'media',
        },
        { responseType: 'arraybuffer' }
      );

      console.log(`Downloaded file Excel: ${latestFile.name}`);

      // Parse Excel file
      const workbook = XLSX.read(fileResponse.data, { type: 'buffer' });

      let totalReceivable = 0; // Tá»•ng pháº£i thu
      let totalPayable = 0; // Tá»•ng pháº£i tráº£

      // Process "PHáº¢I TRáº¢" sheet
      const payableSheetName = findSheetByPattern(workbook, [
        'PHáº¢I TRáº¢',
        'PHAI TRA',
        'PAYABLE',
      ]);
      if (payableSheetName) {
        console.log(`Processing PHáº¢I TRáº¢ sheet: ${payableSheetName}`);
        totalPayable = processSheetForTotal(workbook, payableSheetName);
        console.log(`Total PAYABLE: ${totalPayable}`);
      } else {
        console.log('No PHáº¢I TRáº¢ sheet found');
      }

      // Process "PHáº¢I THU" sheet
      const receivableSheetName = findSheetByPattern(workbook, [
        'PHáº¢I THU',
        'PHAI THU',
        'RECEIVABLE',
      ]);
      if (receivableSheetName) {
        console.log(`Processing PHáº¢I THU sheet: ${receivableSheetName}`);
        totalReceivable = processSheetForTotal(workbook, receivableSheetName);
        console.log(`Total RECEIVABLE: ${totalReceivable}`);
      } else {
        console.log('No PHáº¢I THU sheet found');
      }

      // Calculate net position
      const netPosition = totalReceivable - totalPayable;

      // Create summary object
      const summary = {
        totalReceivable,
        totalPayable,
        netPosition,
        lastUpdated: Timestamp.now(),
        fileName: latestFile.name!,
        fileId: latestFile.id!,
        formattedTotals: {
          totalReceivable: formatCurrency(totalReceivable),
          totalPayable: formatCurrency(totalPayable),
          netPosition: formatCurrency(netPosition),
        },
      };

      // Save summary to Firestore
      console.log('Saving data to Firestore...');
      await db
        .collection('summaries')
        .doc('directorDashboard')
        .set(summary, { merge: true });

      // Update metadata
      await db.collection('system').doc('financialProcessorMetadata').set(
        {
          lastProcessedAt: Timestamp.now(),
          lastProcessedFile: latestFile.name,
          lastProcessedFileId: latestFile.id,
          summaryDataProcessed: true,
          totalReceivable,
          totalPayable,
        },
        { merge: true }
      );

      console.log('Excel processing completed successfully!');

      // Return success result
      return {
        success: true,
        message: `Successfully processed data from file ${latestFile.name}`,
        fileName: latestFile.name,
        fileId: latestFile.id,
        summary,
      };
    } catch (error: any) {
      console.error('Error in triggerExcelProcessing:', error);

      // Re-throw HttpsError as-is, convert others to internal error
      if (error instanceof functions.https.HttpsError) {
        throw error;
      }

      throw new functions.https.HttpsError(
        'internal',
        `Failed to process Excel file: ${error.message}`
      );
    }
  }
);

/**
 * Find sheet name based on pattern
 * @param workbook - XLSX workbook
 * @param patterns - Array of patterns to look for
 * @returns Sheet name if found, undefined otherwise
 */
function findSheetByPattern(
  workbook: XLSX.WorkBook,
  patterns: string[]
): string | undefined {
  for (const sheetName of workbook.SheetNames) {
    const normalizedName = sheetName.normalize('NFC').toUpperCase();
    for (const pattern of patterns) {
      if (normalizedName.includes(pattern)) {
        return sheetName;
      }
    }
  }
  return undefined;
}

/**
 * Process a sheet to get total value based on column B = "Cá»˜NG" and get value from column L
 * @param workbook - XLSX workbook
 * @param sheetName - Sheet name to process
 * @returns Total value
 */
function processSheetForTotal(
  workbook: XLSX.WorkBook,
  sheetName: string
): number {
  const sheet = workbook.Sheets[sheetName];
  const data = XLSX.utils.sheet_to_json<any>(sheet, { header: 'A' });

  let total = 0;
  let sums: number[] = [];

  console.log(`Total rows in sheet ${sheetName}: ${data.length}`);

  // Loop through each row to find rows with column B as "Cá»˜NG"
  for (const row of data) {
    // Check if column B (mapped to key 'B') is "Cá»˜NG"
    if (row['B'] === 'Cá»˜NG') {
      // Get value from column L
      const value = parseFloat(row['L'] || 0);
      if (!isNaN(value)) {
        sums.push(value);
        console.log(`Found Cá»˜NG value: ${value}`);
      }
    }
  }

  // Calculate total from all found values
  total = sums.reduce((acc, curr) => acc + curr, 0);
  console.log(`Values found: ${sums.join(', ')}`);
  console.log(`Total: ${total}`);

  return total;
}


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\index.ts ---

//functions/src/index.ts
/* eslint-disable max-len */
/**
 * Import function triggers from their respective submodules:
 *
 * import {onCall} from "firebase-functions/v2/https";
 * import {onDocumentWritten} from "firebase-functions/v2/firestore";
 *
 * See a full list of supported triggers at https://firebase.google.com/docs/functions
 */

import * as admin from 'firebase-admin';

// Initialize Firebase Admin FIRST
admin.initializeApp();

// Export functions from other files
export * from './materialImporter';
export * from './projectTriggers';
export * from './taskTriggers';
export * from './excelGenerator';
export * from './pdfGenerator';
export * from './contractGenerator';
export * from './financialProcessor';
export * from './scheduledFunctions';
export * from './uploadFileToDrive';
export * from './uploadFileToDriveUser';
export * from './poExcelGenerator';
export * from './poReceiptConfirmation';
export * from './savePOReceiptConfirmation';
export * from './createProjectFolders';
// Do not export from quotationExcelGenerator.ts since it's already exported from excelGenerator

// The functions below are already exported by the '*' exports above.
// They are kept here for clarity but can be removed if they cause issues.
// export { projectWorkflowManager } from './taskTriggers';
// export { onProjectDeleted, onProjectCreate } from './projectTriggers';


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\materialImporter.ts ---

import * as functions from 'firebase-functions/v1';
import { google } from 'googleapis';
import * as XLSX from 'xlsx';
import { CallableContext } from 'firebase-functions/v1/https';

// admin Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o á»Ÿ file index.ts chÃ­nh

export const importMaterialsFromDrive = functions
  .region('asia-southeast1')
  .https.onCall(async (data: any, context: CallableContext) => {
    // === QUAY Láº I CÃCH XÃC THá»°C CHUáº¨N ===
    if (!context.auth) {
      // Náº¿u context.auth khÃ´ng tá»“n táº¡i, cÃ³ nghÄ©a lÃ  Firebase khÃ´ng thá»ƒ xÃ¡c thá»±c ngÆ°á»i dÃ¹ng.
      throw new functions.https.HttpsError(
        'unauthenticated',
        'YÃªu cáº§u pháº£i Ä‘Æ°á»£c thá»±c hiá»‡n khi Ä‘Ã£ Ä‘Äƒng nháº­p.'
      );
    }
    // Tá»« Ä‘Ã¢y, báº¡n cÃ³ thá»ƒ tin tÆ°á»Ÿng context.auth.uid
    console.log(`Request from authenticated user: ${context.auth.uid}`);

    const { driveFileId, accessToken } = data;
    if (!driveFileId || !accessToken) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Thiáº¿u file ID hoáº·c access token.'
      );
    }

    try {
      // 1. Setup Google API client
      const auth = new google.auth.OAuth2();
      auth.setCredentials({ access_token: accessToken });
      const drive = google.drive({ version: 'v3', auth });

      // 2. Táº£i vÃ  parse file
      const response = await drive.files.get(
        { fileId: driveFileId, alt: 'media' },
        { responseType: 'arraybuffer' }
      );
      const workbook = XLSX.read(Buffer.from(response.data as any), {
        type: 'buffer',
      });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const rawData: any[][] = XLSX.utils.sheet_to_json(worksheet, {
        header: 1,
        // The `defval` property ensures that empty cells are read as `null`
        // instead of being skipped, which is important for checking empty columns.
        defval: null,
      });

      const parsedMaterials: any[] = [];
      // Start from row 5 (index 4) which is the first data row
      for (let i = 4; i < rawData.length; i++) {
        const row: any[] = rawData[i];

        // Skip rows that are completely empty or have no name in column B
        if (!row || !row[1]) {
          continue;
        }

        // A row is considered a "note" if columns C, H, and J are all empty.
        // Column C: row[2] (Material)
        // Column H: row[7] (Quantity)
        // Column J: row[9] (Not used in current parsing, but checked as requested)
        const isNote = !row[2] && !row[7] && !row[9];

        let materialItem;

        if (isNote) {
          materialItem = {
            isNote: true,
            name: row[1] || '', // Only take the note's content from column B
            // Set other fields to null/empty to prevent default values on the frontend
            stt: null,
            material: '',
            quyCach: '',
            unit: '',
            quantity: null,
            weight: null,
            unitPrice: 0,
            totalPrice: 0,
          };
        } else {
          materialItem = {
            isNote: false,
            stt: row[0],
            name: row[1] || '',
            material: row[2] || '',
            quyCach: row[3] && row[4] ? `${row[3]}x${row[4]}` : '',
            unit: row[6] || '',
            quantity: parseFloat(String(row[7])) || 0,
            weight: parseFloat(String(row[8])) || null,
            unitPrice: 0,
            totalPrice: 0,
          };
        }
        parsedMaterials.push(materialItem);
      }

      // Tráº£ vá» káº¿t quáº£
      return { materials: parsedMaterials };
    } catch (error: any) {
      console.error('Error importing materials from Drive:', error);
      // Lá»—i tá»« Google API, cÃ³ thá»ƒ do accessToken háº¿t háº¡n
      if (error.code === 401 || error.code === 403) {
        throw new functions.https.HttpsError(
          'permission-denied',
          'Token truy cáº­p Google Drive khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n.'
        );
      }
      throw new functions.https.HttpsError(
        'internal',
        'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh khi xá»­ lÃ½ file.',
        error.message
      );
    }
  });


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\pdfGenerator.ts ---

import * as functions from 'firebase-functions/v1';
import * as admin from 'firebase-admin';
import * as path from 'path';

// Chá»‰ import 'googleapis' bÃªn trong hÃ m khi cáº§n
// import { google } from 'googleapis';

// Get reference to Firebase Storage
const storage = admin.storage().bucket();

/**
 * Callable function that takes a Google Sheet ID and exports it as PDF using Google Drive API
 * then uploads the PDF to Firebase Storage and returns a public URL
 */
export const exportSheetToPdf = functions
  .region('us-central1') // Explicitly specify the region
  .runWith({
    timeoutSeconds: 300,
    memory: '1GB',
  })
  .https.onCall(async (data, context) => {
    // Lazy load the googleapis library
    const { google } = await import('googleapis');

    // Check authentication
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng nÃ y.'
      );
    }

    // Validate input parameters
    const { spreadsheetId, fileName, projectId, accessToken } = data;
    if (!spreadsheetId) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Thiáº¿u ID cá»§a Google Sheet.'
      );
    }

    if (!fileName) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Thiáº¿u tÃªn file cho PDF.'
      );
    }

    if (!projectId) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Thiáº¿u ID dá»± Ã¡n.'
      );
    }

    try {
      let auth: any;
      // Build auth/sheets depending on whether we have an end-user token
      if (accessToken) {
        const userAuth = new google.auth.OAuth2();
        userAuth.setCredentials({ access_token: accessToken });
        auth = userAuth;
      } else {
        auth = new google.auth.GoogleAuth({
          keyFile: path.join(__dirname, '../tanyb-fe4bf-4fbd5c01b6c7.json'),
          scopes: [
            'https://www.googleapis.com/auth/drive.readonly',
            'https://www.googleapis.com/auth/spreadsheets.readonly',
          ],
        });
      }

      const sheets = google.sheets({ version: 'v4', auth });

      // Step 1: Get the data from column A to determine the last row with content
      const sheetsResponse = await sheets.spreadsheets.values.get({
        spreadsheetId,
        range: 'A:A', // Only examine column A to determine the last row
      });

      // Calculate the last row with content
      const values = sheetsResponse.data.values || [];
      let lastRow = 0;

      // Find the last non-empty row
      for (let i = 0; i < values.length; i++) {
        if (values[i] && values[i][0]) {
          lastRow = i + 1; // Convert to 1-indexed
        }
      }

      // Add buffer rows to ensure we capture all content
      const bufferRows = 6;
      const dynamicRange = `A1:G${lastRow + bufferRows}`;

      functions.logger.info(
        `Calculated dynamic range: ${dynamicRange} (last row: ${lastRow})`
      );

      // Step 2: Build a custom export URL that limits the print area to columns A:G and rows 1 â†’ lastRow + buffer.
      // Google Sheets accepts the parameters r1, r2, c1, c2 (0-based, r2/c2 are exclusive) together with a gid that identifies the sheet.
      const sheetMeta = await sheets.spreadsheets.get({
        spreadsheetId,
        fields: 'sheets(properties(sheetId))',
      });

      const sheetId = sheetMeta.data.sheets?.[0]?.properties?.sheetId ?? 0;

      const r1 = 0; // start row (0-based)
      // Guarantee export always reaches at least the bottom of the template (row 36)
      const MIN_TEMPLATE_ROWS = 36;
      const r2 = Math.max(lastRow + bufferRows, MIN_TEMPLATE_ROWS); // end row (exclusive)
      const c1 = 0; // column A (0-based)
      // Include column H (index 7) so the right-hand border of the template is preserved
      const c2 = 8; // exclusive end index

      const exportUrl =
        `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export` +
        `?format=pdf` +
        `&gid=${sheetId}` +
        `&portrait=true` +
        `&size=a4` +
        `&scale=2` +
        `&gridlines=false` +
        `&sheetnames=false` +
        `&printtitle=true` +
        `&pagenum=UNDEFINED` +
        `&r1=${r1}&r2=${r2}&c1=${c1}&c2=${c2}`;

      functions.logger.info(`Export URL: ${exportUrl}`);

      // Use the authenticated HTTP client to download the PDF as a stream
      const authClient =
        typeof auth.getClient === 'function' ? await auth.getClient() : auth;
      const pdfResponse = await authClient.request({
        url: exportUrl,
        method: 'GET',
        responseType: 'stream',
      });

      const pdfStream = (pdfResponse as any).data as NodeJS.ReadableStream;

      if (!pdfStream) {
        throw new functions.https.HttpsError(
          'internal',
          'KhÃ´ng thá»ƒ xuáº¥t file PDF tá»« Google Sheet.'
        );
      }

      // Get project folder info from Firestore
      const projectDoc = await admin
        .firestore()
        .collection('projects')
        .doc(projectId)
        .get();
      const projectData = projectDoc.data();

      if (!projectData || !projectData.driveFolderId) {
        throw new functions.https.HttpsError(
          'failed-precondition',
          'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin thÆ° má»¥c Drive cá»§a dá»± Ã¡n.'
        );
      }

      // Find 'baogia' subfolder in project folder
      const baogiaFolderResponse = await authClient.request({
        url: 'https://www.googleapis.com/drive/v3/files',
        method: 'GET',
        params: {
          q: `name='baogia' and '${projectData.driveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
          fields: 'files(id)',
        },
      });

      // Type casting for the response
      interface DriveFilesResponse {
        files?: { id: string }[];
      }

      const responseData = baogiaFolderResponse.data as DriveFilesResponse;

      let baogiaFolderId;
      if (responseData.files && responseData.files.length > 0) {
        baogiaFolderId = responseData.files[0].id;
      } else {
        // Create 'baogia' folder if it doesn't exist
        const driveClient = google.drive({
          version: 'v3',
          auth: authClient,
        });
        const folderResponse = await driveClient.files.create({
          requestBody: {
            name: 'baogia',
            mimeType: 'application/vnd.google-apps.folder',
            parents: [projectData.driveFolderId],
          },
          fields: 'id',
        });
        baogiaFolderId = folderResponse.data.id;
      }

      // Define sanitized filename first
      const sanitizedFileName = fileName.replace(/[^a-z0-9.]/gi, '_');

      // Save PDF to Google Drive folder if baogiaFolderId exists
      if (baogiaFolderId) {
        try {
          // Upload PDF to Drive (in background, don't await)
          const driveClient = google.drive({
            version: 'v3',
            auth: authClient,
          });

          // Clone the stream since we need to use it twice (Drive and Storage)
          const pdfClone = require('stream').Readable.from(pdfStream);

          driveClient.files
            .create({
              requestBody: {
                name: `${sanitizedFileName}.pdf`,
                mimeType: 'application/pdf',
                parents: [baogiaFolderId],
              },
              media: {
                mimeType: 'application/pdf',
                body: pdfClone,
              },
            })
            .catch((error) => {
              console.error('Error uploading PDF to Drive:', error);
            });
        } catch (error) {
          console.error('Error setting up Drive upload:', error);
        }
      }

      // Define the destination path in Firebase Storage (keep existing functionality)
      const destinationPath = `quotation-pdfs/${projectId}/${sanitizedFileName}.pdf`;
      const file = storage.file(destinationPath);

      // Create a write stream to Firebase Storage
      const writeStream = file.createWriteStream({
        metadata: {
          contentType: 'application/pdf',
        },
      });

      // Handle potential errors in the pipeline
      let pipelineError: Error | null = null;

      // Pipe the PDF data from Google Drive to Firebase Storage
      pdfStream
        .on('error', (err: Error) => {
          pipelineError = err;
          functions.logger.error('Error streaming PDF from Drive:', err);
        })
        .pipe(writeStream);

      // Return a promise that resolves when the upload is complete
      return new Promise((resolve, reject) => {
        writeStream.on('finish', async () => {
          if (pipelineError) {
            reject(
              new functions.https.HttpsError('internal', pipelineError.message)
            );
            return;
          }

          try {
            // Generate a signed URL instead of making the file public
            // This is compatible with Uniform Bucket-Level Access
            const [signedUrl] = await file.getSignedUrl({
              action: 'read',
              expires: '01-01-2124', // Set a very long expiration date (e.g., 100 years)
            });

            resolve({
              pdfUrl: signedUrl,
              lastRow,
              dynamicRange,
              usedUrl: exportUrl,
            });
          } catch (err) {
            functions.logger.error('Error generating signed URL:', err);
            reject(
              new functions.https.HttpsError(
                'internal',
                'KhÃ´ng thá»ƒ táº¡o URL cÃ´ng khai cho file PDF.'
              )
            );
          }
        });

        writeStream.on('error', (err) => {
          functions.logger.error('Error writing to Firebase Storage:', err);
          reject(
            new functions.https.HttpsError(
              'internal',
              `Lá»—i khi lÆ°u file PDF: ${err.message}`
            )
          );
        });
      });
    } catch (error) {
      functions.logger.error('Error in exportSheetToPdf:', error);
      throw new functions.https.HttpsError(
        'internal',
        `Lá»—i khi xuáº¥t file PDF: ${
          error instanceof Error ? error.message : 'Unknown error'
        }`
      );
    }
  });


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\poExcelGenerator.ts ---

import * as functions from 'firebase-functions/v1';
import { google, sheets_v4 } from 'googleapis';
import { CallableContext } from 'firebase-functions/v1/https';
import * as admin from 'firebase-admin';

// Define PO data interface
interface ExcelPurchaseOrderData {
  metadata: {
    projectName?: string;
    supplierName?: string;
    supplierAddress?: string;
    supplierPhone?: string;
    supplierEmail?: string;
    supplierTaxCode?: string;
    supplierContactPerson?: string;
    poNumber?: string;
    proposalNumber?: string;
    poDate?: string;
    deliveryTime?: string;
    paymentTerms?: string;
  };
  materials: {
    no: number;
    name: string;
    unit: string;
    quantity: number;
    unitPrice: number;
    total: number;
    material?: string;
    specs?: string;
  }[];
  summary: {
    subTotal: number;
    vatPercentage: number;
    vatAmount: number;
    grandTotal: number;
  };
}

// ----- CONFIGURATION -----
const TEMPLATE_FILE_ID = '1z0MBboGASBZ8rE68x-_ykMVt4YjFcuTZG9RcVWBcZF0'; // Updated PO template ID
const START_ROW_MATERIALS = 18; // Data starts at row 18 in the new template

// ----- MAIN FUNCTION -----
export const generateExcelPurchaseOrder = functions
  .region('asia-southeast1')
  .runWith({ timeoutSeconds: 300, memory: '512MB' })
  .https.onCall(
    async (
      data: {
        formattedData: ExcelPurchaseOrderData;
        projectId: string;
        accessToken: string;
      },
      context: CallableContext
    ) => {
      // Add detailed logging for debugging
      console.log('PO Generator called with projectId:', data.projectId);
      console.log(
        'Auth context:',
        context.auth ? 'Authenticated' : 'Not authenticated'
      );
      console.log('Access token provided:', data.accessToken ? 'Yes' : 'No');

      // Check if we have the required data
      const { formattedData, projectId, accessToken } = data;

      // Validate required parameters
      if (!formattedData) {
        throw new functions.https.HttpsError(
          'invalid-argument',
          'Invalid data.'
        );
      }
      if (!projectId) {
        throw new functions.https.HttpsError(
          'invalid-argument',
          'Project ID is required.'
        );
      }

      // Check for accessToken (required for Google API access)
      if (!accessToken) {
        throw new functions.https.HttpsError(
          'unauthenticated',
          'Google access token is required.'
        );
      }

      console.log(
        'PO Generator: Received valid request for project:',
        projectId
      );

      try {
        // Use the provided access token for Google API authentication
        const auth = new google.auth.OAuth2();
        auth.setCredentials({ access_token: accessToken });

        const drive = google.drive({ version: 'v3', auth });
        const sheets = google.sheets({ version: 'v4', auth });

        const db = admin.firestore();
        const projectDoc = await db.collection('projects').doc(projectId).get();
        const projectData = projectDoc.data();

        if (!projectData || !projectData.driveFolderId) {
          throw new functions.https.HttpsError(
            'failed-precondition',
            'Project Drive folder information not found.'
          );
        }

        // Find or create 'PO' subfolder in the project folder
        const poFolderResponse = await drive.files.list({
          q: `name='PO' and '${projectData.driveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
          fields: 'files(id)',
        });

        let poFolderId;
        if (
          poFolderResponse.data.files &&
          poFolderResponse.data.files.length > 0
        ) {
          poFolderId = poFolderResponse.data.files[0].id;
        } else {
          const folderResponse = await drive.files.create({
            requestBody: {
              name: 'PO',
              mimeType: 'application/vnd.google-apps.folder',
              parents: [projectData.driveFolderId],
            },
            fields: 'id',
          });
          poFolderId = folderResponse.data.id;
        }

        const newFileName = `Äáº·t hÃ ng - ${
          formattedData.metadata.supplierName || 'NCC'
        } - ${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}`;

        const copiedFileResponse = await drive.files.copy({
          fileId: TEMPLATE_FILE_ID,
          requestBody: { name: newFileName, parents: [poFolderId] },
        });

        const newFileId = copiedFileResponse.data.id;
        if (!newFileId) throw new Error('Cannot copy template file.');

        const spreadsheet = await sheets.spreadsheets.get({
          spreadsheetId: newFileId,
          fields: 'sheets.properties',
        });
        const firstSheet = spreadsheet.data.sheets?.[0];
        const sheetId = firstSheet?.properties?.sheetId;
        if (sheetId === undefined || sheetId === null) {
          throw new Error('Cannot determine sheetId of the first sheet');
        }

        const requests: sheets_v4.Schema$Request[] = [];

        // ---- NEW METADATA MAPPING TO MATCH THE TEMPLATE ----
        const poDate = new Date();
        const dateString = `HCM, NgÃ y ${poDate.getDate()} thÃ¡ng ${
          poDate.getMonth() + 1
        } nÄƒm ${poDate.getFullYear()}`;

        // Helper to create update requests
        const createCellUpdateRequest = (
          value: any,
          rowIndex: number,
          columnIndex: number
        ) => ({
          updateCells: {
            rows: [
              {
                values: [{ userEnteredValue: { stringValue: String(value) } }],
              },
            ],
            fields: 'userEnteredValue',
            start: { sheetId, rowIndex, columnIndex },
          },
        });

        // Project and Date
        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.projectName || '',
            1,
            9 // Column J (index 9) for cell J2
          )
        );
        requests.push(createCellUpdateRequest(dateString, 5, 4)); // E6

        // Supplier Info - Updated to write to the correct cells
        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.supplierName || '',
            8,
            3
          )
        ); // D9

        // Merge cells for supplier name D9:F10
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 8,
              endRowIndex: 10,
              startColumnIndex: 3,
              endColumnIndex: 6,
            },
            mergeType: 'MERGE_ALL',
          },
        });

        // Address in D11:F11
        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.supplierAddress || '',
            10,
            3
          )
        ); // D11

        // Merge cells for address D11:F11
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 10,
              endRowIndex: 11,
              startColumnIndex: 3,
              endColumnIndex: 6,
            },
            mergeType: 'MERGE_ALL',
          },
        });

        // Tax code in D12:F12
        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.supplierTaxCode || '',
            11,
            3
          )
        ); // D12

        // Merge cells for tax code D12:F12
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 11,
              endRowIndex: 12,
              startColumnIndex: 3,
              endColumnIndex: 6,
            },
            mergeType: 'MERGE_ALL',
          },
        });

        // Contact person in D13:F13
        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.supplierContactPerson || '',
            12,
            3
          )
        ); // D13

        // Merge cells for contact person D13:F13
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 12,
              endRowIndex: 13,
              startColumnIndex: 3,
              endColumnIndex: 6,
            },
            mergeType: 'MERGE_ALL',
          },
        });

        // Email stays in original location
        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.supplierEmail || '',
            13,
            2
          )
        ); // C14

        // Phone in D15:F15
        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.supplierPhone || '',
            14,
            3
          )
        ); // D15

        // Merge cells for phone D15:F15
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 14,
              endRowIndex: 15,
              startColumnIndex: 3,
              endColumnIndex: 6,
            },
            mergeType: 'MERGE_ALL',
          },
        });

        // PO Info - I9
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: formattedData.metadata.poNumber || '',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue',
            start: { sheetId, rowIndex: 8, columnIndex: 8 }, // I9
          },
        });
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 8,
              endRowIndex: 9,
              startColumnIndex: 8, // I
              endColumnIndex: 10, // J
            }, // I9:J9
            mergeType: 'MERGE_ALL',
          },
        });

        // Proposal Number - I10
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: formattedData.metadata.proposalNumber || '',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue',
            start: { sheetId, rowIndex: 9, columnIndex: 8 }, // I10
          },
        });
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 9,
              endRowIndex: 10,
              startColumnIndex: 8, // I
              endColumnIndex: 10, // J
            }, // I10:J10
            mergeType: 'MERGE_ALL',
          },
        });

        // Delivery time moved to I12
        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.deliveryTime || '',
            11,
            8
          )
        ); // I12
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 11,
              endRowIndex: 12,
              startColumnIndex: 8,
              endColumnIndex: 10,
            }, // I12:J12
            mergeType: 'MERGE_ALL',
          },
        });

        requests.push(
          createCellUpdateRequest(
            formattedData.metadata.paymentTerms || '',
            12,
            9
          )
        ); // J13

        // ---- MATERIALS TABLE ----
        // Add table header for materials - starting from column C (index 2)
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: { stringValue: 'STT' },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      borders: {
                        top: { style: 'SOLID' },
                        bottom: { style: 'SOLID' },
                        left: { style: 'SOLID' },
                        right: { style: 'SOLID' },
                      },
                    },
                  },
                  {
                    userEnteredValue: { stringValue: 'MÃ´ Táº£ HÃ ng HÃ³a' },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      borders: {
                        top: { style: 'SOLID' },
                        bottom: { style: 'SOLID' },
                        left: { style: 'SOLID' },
                        right: { style: 'SOLID' },
                      },
                    },
                  },
                  {
                    userEnteredValue: { stringValue: 'YÃªu Cáº§u Ká»¹ Thuáº­t' },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      borders: {
                        top: { style: 'SOLID' },
                        bottom: { style: 'SOLID' },
                        left: { style: 'SOLID' },
                        right: { style: 'SOLID' },
                      },
                    },
                  },
                  {
                    userEnteredValue: { stringValue: 'ÄVT' },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      borders: {
                        top: { style: 'SOLID' },
                        bottom: { style: 'SOLID' },
                        left: { style: 'SOLID' },
                        right: { style: 'SOLID' },
                      },
                    },
                  },
                  {
                    userEnteredValue: { stringValue: 'Sá»‘ LÆ°á»£ng' },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      borders: {
                        top: { style: 'SOLID' },
                        bottom: { style: 'SOLID' },
                        left: { style: 'SOLID' },
                        right: { style: 'SOLID' },
                      },
                    },
                  },
                  {
                    userEnteredValue: { stringValue: 'ÄÆ¡n giÃ¡ (VND)' },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      borders: {
                        top: { style: 'SOLID' },
                        bottom: { style: 'SOLID' },
                        left: { style: 'SOLID' },
                        right: { style: 'SOLID' },
                      },
                    },
                  },
                  {
                    userEnteredValue: { stringValue: 'ThÃ nh Tiá»n (VND)' },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      borders: {
                        top: { style: 'SOLID' },
                        bottom: { style: 'SOLID' },
                        left: { style: 'SOLID' },
                        right: { style: 'SOLID' },
                      },
                    },
                  },
                  {
                    userEnteredValue: { stringValue: 'Ghi chÃº' },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      borders: {
                        top: { style: 'SOLID' },
                        bottom: { style: 'SOLID' },
                        left: { style: 'SOLID' },
                        right: { style: 'SOLID' },
                      },
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: {
              sheetId,
              rowIndex: START_ROW_MATERIALS - 2,
              columnIndex: 2,
            },
          },
        });

        const materialRows = formattedData.materials.map((material) => ({
          values: [
            {
              userEnteredValue: { numberValue: material.no },
              userEnteredFormat: {
                horizontalAlignment: 'CENTER',
                verticalAlignment: 'MIDDLE',
                borders: {
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                },
              },
            },
            {
              // Description
              userEnteredValue: { stringValue: material.name },
              userEnteredFormat: {
                horizontalAlignment: 'LEFT',
                verticalAlignment: 'MIDDLE',
                borders: {
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                },
              },
            },
            {
              // Technical spec
              userEnteredValue: { stringValue: material.specs || '' },
              userEnteredFormat: {
                horizontalAlignment: 'CENTER',
                verticalAlignment: 'MIDDLE',
                borders: {
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                },
              },
            },
            {
              // Unit
              userEnteredValue: { stringValue: material.unit },
              userEnteredFormat: {
                horizontalAlignment: 'CENTER',
                verticalAlignment: 'MIDDLE',
                borders: {
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                },
              },
            },
            {
              // Quantity
              userEnteredValue: { numberValue: material.quantity },
              userEnteredFormat: {
                horizontalAlignment: 'RIGHT',
                verticalAlignment: 'MIDDLE',
                borders: {
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                },
              },
            },
            {
              // Unit price
              userEnteredValue: { numberValue: material.unitPrice },
              userEnteredFormat: {
                numberFormat: { type: 'NUMBER', pattern: '#,##0' },
                horizontalAlignment: 'RIGHT',
                verticalAlignment: 'MIDDLE',
                borders: {
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                },
              },
            },
            {
              // Total
              userEnteredValue: { numberValue: material.total },
              userEnteredFormat: {
                numberFormat: { type: 'NUMBER', pattern: '#,##0' },
                horizontalAlignment: 'RIGHT',
                verticalAlignment: 'MIDDLE',
                borders: {
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                },
              },
            },
            {
              // Note column blank
              userEnteredValue: { stringValue: '' },
              userEnteredFormat: {
                borders: {
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                },
              },
            },
          ],
        }));

        if (materialRows.length > 0) {
          requests.push({
            insertDimension: {
              range: {
                sheetId,
                dimension: 'ROWS',
                startIndex: START_ROW_MATERIALS - 1,
                endIndex: START_ROW_MATERIALS - 1 + materialRows.length,
              },
              inheritFromBefore: true,
            },
          });
          requests.push({
            updateCells: {
              rows: materialRows,
              fields: 'userEnteredValue,userEnteredFormat',
              start: {
                sheetId,
                rowIndex: START_ROW_MATERIALS - 1,
                columnIndex: 2,
              },
            },
          });
        }

        // ---- SUMMARY SECTION ----
        const summaryStartRow =
          START_ROW_MATERIALS + formattedData.materials.length + 3; // Add some spacing
        const createSummaryRow = (
          label: string,
          value: number | null,
          isBold: boolean,
          rowOffset: number
        ) => {
          // 1. Write Label to Column B
          requests.push({
            updateCells: {
              rows: [
                {
                  values: [
                    {
                      userEnteredValue: { stringValue: label },
                      userEnteredFormat: {
                        textFormat: { bold: isBold },
                        horizontalAlignment: 'RIGHT',
                        verticalAlignment: 'MIDDLE',
                      },
                    },
                  ],
                },
              ],
              fields: 'userEnteredValue,userEnteredFormat',
              start: {
                sheetId,
                rowIndex: summaryStartRow + rowOffset,
                columnIndex: 1, // Column B
              },
            },
          });

          // 2. Write Value to Column I
          if (value !== null) {
            requests.push({
              updateCells: {
                rows: [
                  {
                    values: [
                      {
                        userEnteredValue: { numberValue: value },
                        userEnteredFormat: {
                          numberFormat: { type: 'NUMBER', pattern: '#,##0' },
                          textFormat: { bold: isBold },
                          horizontalAlignment: 'RIGHT',
                          verticalAlignment: 'MIDDLE',
                        },
                      },
                    ],
                  },
                ],
                fields: 'userEnteredValue,userEnteredFormat',
                start: {
                  sheetId,
                  rowIndex: summaryStartRow + rowOffset,
                  columnIndex: 8, // Column I
                },
              },
            });
          }

          // 3. Merge label cells (B to H)
          requests.push({
            mergeCells: {
              range: {
                sheetId,
                startRowIndex: summaryStartRow + rowOffset,
                endRowIndex: summaryStartRow + rowOffset + 1,
                startColumnIndex: 1, // Column B
                endColumnIndex: 8, // Column H
              },
              mergeType: 'MERGE_ALL',
            },
          });

          // 4. Merge value cells (I to J)
          requests.push({
            mergeCells: {
              range: {
                sheetId,
                startRowIndex: summaryStartRow + rowOffset,
                endRowIndex: summaryStartRow + rowOffset + 1,
                startColumnIndex: 8, // Column I
                endColumnIndex: 10, // Column J
              },
              mergeType: 'MERGE_ALL',
            },
          });
        };

        createSummaryRow(
          'Tá»•ng Sá»‘ Tiá»n ChÆ°a Bao Gá»“m thuáº¿ GTGT (VAT)',
          formattedData.summary.subTotal,
          false,
          0
        );
        createSummaryRow(
          `Thuáº¿ VAT ${formattedData.summary.vatPercentage}%`,
          formattedData.summary.vatAmount,
          false,
          1
        );
        createSummaryRow(
          'Tá»•ng Sá»‘ Tiá»n Bao Gá»“m thuáº¿ GTGT (VAT)',
          formattedData.summary.grandTotal,
          true,
          2
        );

        // Amount in words row (merge B:J)
        const amountInWordsRow = summaryStartRow + 3;
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: `(Báº±ng chá»¯: ${convertNumberToVnWords(
                        formattedData.summary.grandTotal
                      )})`,
                    },
                    userEnteredFormat: {
                      textFormat: { bold: true, italic: true },
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: amountInWordsRow, columnIndex: 1 },
          },
        });
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: amountInWordsRow,
              endRowIndex: amountInWordsRow + 2, // Span 2 rows
              startColumnIndex: 1,
              endColumnIndex: 10,
            },
            mergeType: 'MERGE_ALL',
          },
        });

        // ---- TERMS AND CONDITIONS SECTION ----
        const termsStartRow = amountInWordsRow + 3;
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: '* ÄIá»€U KHOáº¢N VÃ€ YÃŠU Cáº¦U Bá»” SUNG:',
                    },
                    userEnteredFormat: { textFormat: { bold: true } },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: termsStartRow, columnIndex: 1 },
          },
        });
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: termsStartRow,
              endRowIndex: termsStartRow + 1,
              startColumnIndex: 1,
              endColumnIndex: 10,
            },
            mergeType: 'MERGE_ALL',
          },
        });

        const termsConditions = [
          {
            no: 1,
            text: 'ÄÆ¡n giÃ¡ khÃ´ng bao gá»“m phÃ­ váº­n chuyá»ƒn theo Ä‘á»‹a chá»‰ giao hÃ ng Ä‘á» cáº­p trong ÄÆ¡n Äáº·t HÃ ng nÃ y.',
          },
          {
            no: 2,
            text: 'NhÃ  cung cáº¥p chuáº©n bá»‹ vÃ  kÃ­ biÃªn báº£n giao nháº­n, cÃ¹ng vá»›i ÄÆ¡n Ä‘áº·t hÃ ng nÃ y khi giao hÃ ng.',
          },
          {
            no: 3,
            text: 'Táº¥t cáº£ hÃ ng hÃ³a má»›i 100%. NhÃ  cung cáº¥p pháº£i trÃ¬nh chá»©ng chá»‰ cháº¥t lÆ°á»£ng vÃ  xuáº¥t xá»© (copy) khi Ä‘Æ°á»£c yÃªu cáº§u',
          },
        ];

        termsConditions.forEach((term, idx) => {
          requests.push({
            updateCells: {
              rows: [
                {
                  values: [
                    {
                      userEnteredValue: { numberValue: term.no },
                      userEnteredFormat: {
                        textFormat: { bold: true },
                        horizontalAlignment: 'CENTER',
                      },
                    },
                    {
                      userEnteredValue: { stringValue: term.text },
                      userEnteredFormat: {
                        textFormat: {
                          foregroundColor: { red: 1, green: 0, blue: 0 },
                        },
                        horizontalAlignment: 'LEFT',
                      },
                    },
                  ],
                },
              ],
              fields: 'userEnteredValue,userEnteredFormat',
              start: {
                sheetId,
                rowIndex: termsStartRow + 1 + idx,
                columnIndex: 1,
              },
            },
          });
          requests.push({
            mergeCells: {
              range: {
                sheetId,
                startRowIndex: termsStartRow + 1 + idx,
                endRowIndex: termsStartRow + 2 + idx,
                startColumnIndex: 2,
                endColumnIndex: 10,
              },
              mergeType: 'MERGE_ALL',
            },
          });
        });

        // Add space between terms and signatures
        const signatureStartRow = termsStartRow + termsConditions.length + 3;

        // ---- SIGNATURES SECTION (CORRECT & ROBUST IMPLEMENTATION) ----

        // --- BÃŠN MUA HÃ€NG (BÃŠN A) ---
        // 1. Ghi chá»¯ "Äáº¡i diá»‡n bÃªn Mua hÃ ng (BÃªn A)" vÃ o cá»™t B
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: 'Äáº¡i diá»‡n bÃªn Mua hÃ ng (BÃªn A)',
                    },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: signatureStartRow, columnIndex: 1 }, // Cá»™t B
          },
        });

        // 2. Gá»™p Ã´ cho BÃªn A (B Ä‘áº¿n F)
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: signatureStartRow,
              endRowIndex: signatureStartRow + 1,
              startColumnIndex: 1, // Tá»« Cá»™t B
              endColumnIndex: 6, // Äáº¿n Cá»™t F
            },
            mergeType: 'MERGE_ALL',
          },
        });

        // --- BÃŠN BÃN HÃ€NG (BÃŠN B) ---
        // 3. Ghi chá»¯ "Äáº¡i diá»‡n bÃªn BÃ¡n hÃ ng (BÃªn B)" vÃ o cá»™t G
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: 'Äáº¡i diá»‡n bÃªn BÃ¡n hÃ ng (BÃªn B)',
                    },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      horizontalAlignment: 'CENTER',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: signatureStartRow, columnIndex: 6 }, // Cá»™t G
          },
        });

        // 4. Gá»™p Ã´ cho BÃªn B (G Ä‘áº¿n K)
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: signatureStartRow,
              endRowIndex: signatureStartRow + 1,
              startColumnIndex: 6, // Tá»« Cá»™t G
              endColumnIndex: 11, // Äáº¿n Cá»™t K
            },
            mergeType: 'MERGE_ALL',
          },
        });

        // Add empty space for signatures (about 7 rows)
        for (let i = 0; i < 7; i++) {
          requests.push({
            updateCells: {
              rows: [{ values: [{ userEnteredValue: { stringValue: '' } }] }],
              fields: 'userEnteredValue',
              start: {
                sheetId,
                rowIndex: signatureStartRow + 1 + i,
                columnIndex: 0,
              },
            },
          });
        }

        // Apply all updates to the spreadsheet
        await sheets.spreadsheets.batchUpdate({
          spreadsheetId: newFileId,
          requestBody: { requests },
        });

        // Set permissions to make the file accessible
        await drive.permissions.create({
          fileId: newFileId,
          requestBody: { role: 'reader', type: 'anyone' },
        });

        // ----- SAVE PO METADATA TO FIRESTORE -----
        await admin
          .firestore()
          .collection('purchase_orders')
          .add({
            projectId,
            supplierName: formattedData.metadata.supplierName || '',
            poNumber: formattedData.metadata.poNumber || '',
            deliveryTime: formattedData.metadata.deliveryTime || '',
            fileId: newFileId,
            fileUrl: `https://docs.google.com/spreadsheets/d/${newFileId}/edit`,
            status: 'created',
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
            formattedData,
          });

        return {
          success: true,
          fileId: newFileId,
          fileUrl: `https://docs.google.com/spreadsheets/d/${newFileId}/edit`,
          message: 'Purchase Order generated successfully',
        };
      } catch (error) {
        console.error('Error details in generateExcelPurchaseOrder:', error);
        throw new functions.https.HttpsError(
          'internal',
          'Error creating purchase order. Check logs for details.',
          error
        );
      }
    }
  );

// ----- HELPER FUNCTIONS -----
function convertNumberToVnWords(n: number): string {
  const t = [
    'khÃ´ng',
    'má»™t',
    'hai',
    'ba',
    'bá»‘n',
    'nÄƒm',
    'sÃ¡u',
    'báº£y',
    'tÃ¡m',
    'chÃ­n',
  ];
  const r = (num: number): string => {
    if (num === 0) return '';
    if (num < 10) return t[num];
    if (num < 100) {
      return (
        t[Math.floor(num / 10)] +
        ' mÆ°Æ¡i ' +
        (num % 10 === 1
          ? 'má»‘t'
          : num % 10 === 5
          ? 'lÄƒm'
          : num % 10 !== 0
          ? t[num % 10]
          : '')
      );
    }
    if (num < 1000) {
      return (
        t[Math.floor(num / 100)] +
        ' trÄƒm ' +
        (num % 100 < 10 && num % 100 > 0 ? 'láº» ' + t[num % 100] : r(num % 100))
      );
    }
    if (num < 1000000) {
      return (
        r(Math.floor(num / 1000)) +
        ' nghÃ¬n ' +
        (num % 1000 < 100 && num % 1000 > 0
          ? 'khÃ´ng trÄƒm ' + r(num % 1000)
          : r(num % 1000))
      );
    }
    if (num < 1000000000) {
      return (
        r(Math.floor(num / 1000000)) +
        ' triá»‡u ' +
        (num % 1000000 === 0 ? '' : r(num % 1000000))
      );
    }
    return (
      r(Math.floor(num / 1000000000)) +
      ' tá»· ' +
      (num % 1000000000 === 0 ? '' : r(num % 1000000000))
    );
  };

  return r(Math.floor(n)) + ' Ä‘á»“ng';
}


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\poReceiptConfirmation.ts ---

import * as functions from 'firebase-functions/v1';
import * as admin from 'firebase-admin';
import { google } from 'googleapis';
import * as path from 'path';
import { Readable } from 'stream';

// Helper to detect quota/rate-limit errors
function isQuotaError(error: any): boolean {
  if (!error) return false;
  const status = error.code || error.status;
  const message = (error.message || '').toLowerCase();
  return (
    status === 403 ||
    status === 429 ||
    message.includes('quota') ||
    message.includes('rate limit') ||
    message.includes('user rate limit exceeded') ||
    message.includes('quota exceeded')
  );
}

// Exponential-backoff retry helper
async function withRetry<T>(
  fn: () => Promise<T>,
  retries = 5,
  delay = 1000
): Promise<T> {
  try {
    return await fn();
  } catch (err) {
    if (retries > 0 && isQuotaError(err)) {
      console.log(
        `Quota error â€“ retrying in ${delay} ms, attempts left ${retries}`
      );
      await new Promise((res) => setTimeout(res, delay));
      return withRetry(fn, retries - 1, delay * 2);
    }
    throw err;
  }
}

// Build Drive client either with service account or user OAuth token
const buildDriveClient = async (accessToken?: string) => {
  if (accessToken) {
    const auth = new google.auth.OAuth2();
    auth.setCredentials({ access_token: accessToken });
    return google.drive({ version: 'v3', auth });
  }
  const auth = new google.auth.GoogleAuth({
    keyFile: path.join(__dirname, '../tanyb-fe4bf-4fbd5c01b6c7.json'),
    scopes: ['https://www.googleapis.com/auth/drive'],
  });
  return google.drive({ version: 'v3', auth });
};

/**
 * confirmPOReceipt
 * Allows QA/QC to upload photos confirming that materials in a PO have been received.
 * - Uploads images to Drive under <Project>/PO_Receipts/<PO_ID>
 * - Updates purchase_orders doc: status -> "received", receivedAt, receiptPhotos[]
 */
export const confirmPOReceipt = functions
  .region('asia-southeast1')
  .runWith({ timeoutSeconds: 300, memory: '1GB' })
  .https.onCall(async (data, context) => {
    const {
      poId,
      projectId,
      files,
      remarks = '',
      accessToken,
    } = data as {
      poId?: string;
      projectId?: string;
      files?: Array<{ fileName: string; mimeType: string; base64Data: string }>;
      remarks?: string;
      accessToken?: string;
    };

    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Báº¡n cáº§n Ä‘Äƒng nháº­p'
      );
    }

    if (!poId || !projectId || !files || files.length === 0) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Thiáº¿u tham sá»‘ báº¯t buá»™c'
      );
    }

    try {
      const db = admin.firestore();
      const poRef = db.collection('purchase_orders').doc(poId);
      const poSnap = await poRef.get();
      if (!poSnap.exists) {
        throw new functions.https.HttpsError('not-found', 'KhÃ´ng tÃ¬m tháº¥y PO');
      }

      const projectSnap = await db.collection('projects').doc(projectId).get();
      const projectData = projectSnap.data();
      if (!projectData || !projectData.driveFolderId) {
        throw new functions.https.HttpsError(
          'failed-precondition',
          'KhÃ´ng tÃ¬m tháº¥y folder Drive dá»± Ã¡n'
        );
      }

      const drive = await buildDriveClient(accessToken);

      // Find or create QC_Reports folder inside project folder
      const receiptFolderRes = await withRetry(() =>
        drive.files.list({
          q: `name='QC_Reports' and '${projectData.driveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
          fields: 'files(id)',
          spaces: 'drive',
        })
      );

      let qcFolderId = receiptFolderRes.data.files?.[0]?.id;
      if (!qcFolderId) {
        const createFolder = await withRetry(() =>
          drive.files.create({
            requestBody: {
              name: 'QC_Reports',
              mimeType: 'application/vnd.google-apps.folder',
              parents: [projectData.driveFolderId],
            },
            fields: 'id',
          })
        );
        qcFolderId = createFolder.data.id!;
      }

      // Upload each file
      const uploaded: Array<{
        fileId: string;
        webViewLink: string;
        mimeType: string;
      }> = [];
      for (const f of files) {
        // Add PO ID prefix to filename for better identification
        const poFileName = `PO_${poId}_${f.fileName}`;
        const buffer = Buffer.from(f.base64Data, 'base64');
        const stream = Readable.from(buffer);
        const fileRes = await withRetry(() =>
          drive.files.create({
            requestBody: {
              name: poFileName,
              mimeType: f.mimeType,
              parents: [qcFolderId],
            },
            media: { mimeType: f.mimeType, body: stream },
            fields: 'id,webViewLink,mimeType,webContentLink',
          })
        );

        await withRetry(() =>
          drive.permissions.create({
            fileId: fileRes.data.id!,
            requestBody: { role: 'reader', type: 'anyone' },
          })
        );

        uploaded.push({
          fileId: fileRes.data.id!,
          webViewLink: fileRes.data.webViewLink!,
          mimeType: fileRes.data.mimeType!,
        });
      }

      // Update PO document
      await poRef.update({
        status: 'received',
        receivedAt: admin.firestore.FieldValue.serverTimestamp(),
        receiptPhotos: uploaded,
        receiptRemarks: remarks,
      });

      return { success: true, uploaded };
    } catch (err: any) {
      console.error('confirmPOReceipt error', err);
      throw new functions.https.HttpsError(
        'internal',
        err.message || 'Lá»—i xá»­ lÃ½ xÃ¡c nháº­n PO'
      );
    }
  });


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\projectTriggers.ts ---

import {
  onDocumentDeleted,
  onDocumentCreated,
} from 'firebase-functions/v2/firestore';
import * as admin from 'firebase-admin';
import { google } from 'googleapis';
import * as path from 'path';

const db = admin.firestore();
const ROOT_FOLDER_ID = '18OrAEBSuZzz-AFbqlitz5gUxpsdunXjX'; // Baogia root folder ID

/**
 * Creates a Google Drive folder structure for a new project
 */
export const onProjectCreate = onDocumentCreated(
  {
    document: 'projects/{projectId}',
    region: 'asia-southeast1',
  },
  async (event) => {
    const { projectId } = event.params;
    const projectData = event.data?.data();
    if (!projectData) {
      console.log(`No data found for project ${projectId}.`);
      return;
    }

    console.log(`Creating Drive folders for new project: ${projectData.name}`);

    try {
      // Initialize Google Drive API
      const auth = new google.auth.GoogleAuth({
        keyFile: path.join(__dirname, '../tanyb-fe4bf-4fbd5c01b6c7.json'),
        scopes: ['https://www.googleapis.com/auth/drive'],
      });
      const drive = google.drive({ version: 'v3', auth });

      // Get current date for folder structure (YYYY/MM/DD)
      const createdDate = projectData.createdAt?.toDate() || new Date();
      const year = createdDate.getFullYear().toString();
      const month = (createdDate.getMonth() + 1).toString().padStart(2, '0');
      const day = createdDate.getDate().toString().padStart(2, '0');

      // Clean project name for use in folder name (remove invalid chars)
      const cleanProjectName = projectData.name.replace(/[\/\\:*?"<>|]/g, '_');

      // Step 1: Find or create year folder
      const yearFolder = await findOrCreateFolder(drive, year, ROOT_FOLDER_ID);
      if (!yearFolder) {
        throw new Error(`Failed to create year folder ${year}`);
      }

      // Step 2: Find or create month folder
      const monthFolder = await findOrCreateFolder(drive, month, yearFolder.id);
      if (!monthFolder) {
        throw new Error(`Failed to create month folder ${month}`);
      }

      // Step 3: Find or create day folder
      const dayFolder = await findOrCreateFolder(drive, day, monthFolder.id);
      if (!dayFolder) {
        throw new Error(`Failed to create day folder ${day}`);
      }

      // Step 4: Create project folder
      const projectFolder = await createFolder(
        drive,
        cleanProjectName,
        dayFolder.id
      );
      if (!projectFolder) {
        throw new Error(`Failed to create project folder ${cleanProjectName}`);
      }

      // Step 5: Create subfolders (baogia, hopdong)
      // Create and track subfolder IDs for logging
      const baogiaFolder = await createFolder(
        drive,
        'baogia',
        projectFolder.id
      );
      const hopdongFolder = await createFolder(
        drive,
        'hopdong',
        projectFolder.id
      );

      console.log(
        `Created subfolders: baogia (${baogiaFolder.id}) and hopdong (${hopdongFolder.id})`
      );

      // Step 6: Update project document with folder IDs
      await db.collection('projects').doc(projectId).update({
        driveFolderId: projectFolder.id,
        driveFolderUrl: projectFolder.webViewLink,
        driveCreatedAt: admin.firestore.FieldValue.serverTimestamp(),
      });

      console.log(
        `Successfully created Drive folders for project ${projectId}.`
      );
    } catch (error) {
      console.error(
        `Error creating Drive folders for project ${projectId}:`,
        error
      );
    }
  }
);

/**
 * Deletes all tasks associated with a project when the project is deleted.
 */
export const onProjectDeleted = onDocumentDeleted(
  {
    document: 'projects/{projectId}',
    region: 'asia-southeast1',
  },
  async (event) => {
    const { projectId } = event.params;
    console.log(`Project ${projectId} deleted. Deleting associated tasks...`);

    const tasksRef = db.collection('tasks');
    const query = tasksRef.where('projectId', '==', projectId);

    try {
      const snapshot = await query.get();
      if (snapshot.empty) {
        console.log(`No tasks found for project ${projectId}.`);
        return;
      }

      const batch = db.batch();
      snapshot.docs.forEach((doc) => {
        batch.delete(doc.ref);
      });

      await batch.commit();
      console.log(
        `Successfully deleted ${snapshot.size} tasks for project ${projectId}.`
      );
    } catch (error) {
      console.error(`Error deleting tasks for project ${projectId}:`, error);
    }
  }
);

/**
 * Helper function to find a folder by name in a parent folder or create it if it doesn't exist
 */
async function findOrCreateFolder(drive, folderName, parentFolderId) {
  // Search for folder
  const response = await drive.files.list({
    q: `name='${folderName}' and '${parentFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
    fields: 'files(id, name, webViewLink)',
  });

  // If folder exists, return it
  if (response.data.files && response.data.files.length > 0) {
    return response.data.files[0];
  }

  // Otherwise create new folder
  return createFolder(drive, folderName, parentFolderId);
}

/**
 * Helper function to create a new folder
 */
async function createFolder(drive, folderName, parentFolderId) {
  const folderMetadata = {
    name: folderName,
    mimeType: 'application/vnd.google-apps.folder',
    parents: [parentFolderId],
  };

  const folder = await drive.files.create({
    requestBody: folderMetadata,
    fields: 'id, name, webViewLink',
  });

  return folder.data;
}


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\quotationExcelGenerator.ts ---

import * as functions from 'firebase-functions/v1';
import * as admin from 'firebase-admin';
import * as XLSX from 'xlsx';
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';
import { CallableContext } from 'firebase-functions/v1/https';

// Get references to services (but don't reinitialize admin)
const storage = admin.storage();
const bucket = storage.bucket();

// Interface for the Excel formatted data
interface ExcelQuotationData {
  metadata: {
    companyName: string;
    companyAddress: string;
    companyPhone: string;
    companyEmail: string;
    taxCode: string;
    customerName: string;
    customerAddress: string;
    quotationNumber: string;
    quotationDate: string;
    projectName: string;
    quoteValidity: string;
  };
  materials: Array<{
    no: number;
    name: string;
    unit: string;
    quantity: number;
    unitPrice: number;
    total: number;
  }>;
  summary: {
    subTotal: number;
    discountPercentage: number;
    discountAmount: number;
    vatPercentage: number;
    vatAmount: number;
    grandTotal: number;
    amountInWords: string;
  };
}

/**
 * Generates an Excel file based on the quotation data and template
 * @param {ExcelQuotationData} formattedData The formatted data for Excel
 * @returns {Buffer} The Excel file as a buffer
 */
function generateExcelFile(formattedData: ExcelQuotationData): Buffer {
  // Create a new workbook and worksheet
  const workbook = XLSX.utils.book_new();
  const worksheet = XLSX.utils.aoa_to_sheet([]);

  // Set column widths
  const colWidths = [
    { wch: 5 }, // A - STT
    { wch: 40 }, // B - TÃªn gá»i
    { wch: 15 }, // C - Váº­t liá»‡u
    { wch: 10 }, // D - ÄVT
    { wch: 10 }, // E - SL
    { wch: 15 }, // F - ÄÆ¡n giÃ¡
    { wch: 20 }, // G - ThÃ nh Tiá»n
    { wch: 15 }, // H
  ];
  worksheet['!cols'] = colWidths;

  // Add company logo placeholder in cell A1-B8
  // Logo would be added manually or could be implemented with additional code

  // Populate header section based on the template screenshot - Right side header (Company info)
  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['CÃ”NG TY TNHH Sáº¢N XUáº¤T CÆ  KHÃ THÆ¯Æ NG Máº I']],
    { origin: 'D1' }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['Dá»ŠCH Vá»¤ TÃ‚N HÃ’A PHÃT']], {
    origin: 'D2',
  });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['ÄC: Sá»‘ 7 Quá»‘c lá»™ 1A ,KP3B,PhÆ°á»ng Thanh Lá»™c,Quáº­n']],
    { origin: 'D3' }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['12,TP.HCM']], { origin: 'D4' });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['MST: 0315155409', 'Web:cokhitanhoaphat.com.vn']],
    { origin: 'D5' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Email :chomcauinoxtanhoaphat.com.vn']],
    { origin: 'D6' }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['Hotline 24/7: 0978.268.559']], {
    origin: 'D7',
  });

  // Add quotation title
  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Báº¢NG BÃO GIÃ KIá»‚M XÃC NHáº¬N Äáº¶T HÃ€NG']],
    { origin: 'B3' }
  );

  // Add quotation info - Date and number
  XLSX.utils.sheet_add_aoa(worksheet, [['NgÃ y']], { origin: 'F4' });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [[formattedData.metadata.quotationDate]],
    { origin: 'G4' }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['Sá»']], { origin: 'F5' });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [[formattedData.metadata.quotationNumber]],
    { origin: 'G5' }
  );

  // Add customer info section starting at B10
  XLSX.utils.sheet_add_aoa(worksheet, [['KÃNH Gá»¬I:']], { origin: 'B9' });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Äá»‹a chá»‰:', formattedData.metadata.customerAddress]],
    { origin: 'B10' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Tel', ':', '', '', 'MST', ':', '', 'FAX']],
    { origin: 'B11' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Email', ':', '', '', 'Attn', ':', '', 'Mobile:']],
    { origin: 'B12' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [
      [
        'TrÆ°á»›c háº¿t CÃ´ng Ty TÃ¢n HÃ²a PhÃ¡t xin chÃ¢n thÃ nh cáº£m Æ¡n sá»± quan tÃ¢m & há»£p tÃ¡c cá»§a QuÃ½ KhÃ¡ch. ChÃºng tÃ´i xin gá»­i tá»›i QuÃ½ khÃ¡ch bÃ¡o giÃ¡ cÃ¡c chá»§ng loáº¡i sau:',
      ],
    ],
    { origin: 'B14' }
  );

  // Add table header for materials
  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['STT', 'TÃªn gá»i', 'Váº­t liá»‡u', 'ÄVT', 'SL', 'ÄÆ¡n giÃ¡', 'ThÃ nh Tiá»n']],
    { origin: 'B16' }
  );

  // Add material rows
  let currentRow = 17;
  formattedData.materials.forEach((item) => {
    XLSX.utils.sheet_add_aoa(
      worksheet,
      [
        [
          item.no,
          item.name,
          '',
          item.unit,
          item.quantity,
          item.unitPrice,
          item.total,
        ],
      ],
      { origin: `B${currentRow}` }
    );
    currentRow++;
  });

  // Add summary section after materials
  // Calculate appropriate summary row position based on materials
  const summaryStartRow = Math.max(currentRow + 1, 17); // Ensure at least some space after last material

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Tá»•ng cá»™ng', formattedData.summary.subTotal]],
    { origin: `F${summaryStartRow}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Thuáº¿ VAT 10%', formattedData.summary.vatAmount]],
    { origin: `F${summaryStartRow + 1}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Tá»•ng cá»™ng Ä‘Ã£ bao gá»“m VAT 10%', formattedData.summary.grandTotal]],
    { origin: `F${summaryStartRow + 2}` }
  );

  // Add amount in words
  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Báº±ng chá»¯:', formattedData.summary.amountInWords]],
    { origin: `B${summaryStartRow + 4}` }
  );

  // Add ghi chÃº section
  XLSX.utils.sheet_add_aoa(worksheet, [['Ghi chÃº:']], {
    origin: `B${summaryStartRow + 6}`,
  });

  // Add terms and conditions
  let termsRow = summaryStartRow + 8;

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [
      [
        '1. BÃ¡o giÃ¡ cÃ³ hiá»‡u lá»±c trong 7 ngÃ y. Háº¿t hiá»‡u lá»±c xin liÃªn há»‡ láº¡i cho CÃ´ng ty.',
      ],
    ],
    { origin: `C${termsRow}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['2. Thá»i gian giao hÃ ng: 3 ngÃ y ( khÃ´ng bao gá»“m chá»§ nháº­t, ngÃ y lá»… )']],
    { origin: `C${termsRow + 1}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['3. GiÃ¡ Ä‘Ã£ bao gá»“m VAT vÃ  khÃ´ng bao gá»“m váº­n chuyá»ƒn']],
    { origin: `C${termsRow + 2}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['4. Äá»‹a Ä‘iá»ƒm giao hÃ ng: kho bÃªn BÃ¡n']],
    { origin: `C${termsRow + 3}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [
      [
        '5. PhÆ°Æ¡ng thá»©c thanh toÃ¡n: QuÃ½ KhÃ¡ch hÃ ng vui lÃ²ng thanh toÃ¡n báº±ng chuyá»ƒn khoáº£n Ä‘á»ƒ xuáº¥t hÃ³a Ä‘Æ¡n:',
      ],
    ],
    { origin: `C${termsRow + 4}` }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['TÃ i khoáº£n sá»‘: 27888866']], {
    origin: `C${termsRow + 5}`,
  });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['TÃªn tÃ i khoáº£n: CÃ´ng ty TNHH SX cÆ¡ khÃ­ TM-DV TÃ¢n HÃ²a PhÃ¡t']],
    { origin: `C${termsRow + 6}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['NgÃ¢n hÃ ng TMCP Ã ChÃ¢u - Chi nhÃ¡nh: Tam HÃ , Thá»§ Äá»©c']],
    { origin: `C${termsRow + 7}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Táº¡m á»©ng 50%, Thanh toÃ¡n 50% trÆ°á»›c khi nháº­n hÃ ng']],
    { origin: `C${termsRow + 8}` }
  );

  // Add the worksheet to the workbook
  XLSX.utils.book_append_sheet(workbook, worksheet, 'BÃ¡o giÃ¡');

  // Generate Excel file as buffer
  const excelBuffer = XLSX.write(workbook, {
    type: 'buffer',
    bookType: 'xlsx',
  });
  return excelBuffer;
}

/**
 * Firebase Callable Function that generates an Excel quotation
 * Uploads the Excel to Firebase Storage and returns a public URL
 */
export const generateExcelQuotation = functions
  .runWith({
    timeoutSeconds: 300, // Increased timeout
    memory: '512MB', // Increased memory
  })
  .https.onCall(
    async (
      data: {
        formattedData: ExcelQuotationData;
        projectId: string;
      },
      context: CallableContext
    ) => {
      if (!context.auth) {
        throw new functions.https.HttpsError(
          'unauthenticated',
          'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng nÃ y.'
        );
      }

      const { formattedData, projectId } = data;

      if (!formattedData) {
        throw new functions.https.HttpsError(
          'invalid-argument',
          'KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u bÃ¡o giÃ¡.'
        );
      }

      if (!projectId) {
        throw new functions.https.HttpsError(
          'invalid-argument',
          'KhÃ´ng tÃ¬m tháº¥y ID dá»± Ã¡n.'
        );
      }

      try {
        // Generate Excel buffer
        const excelBuffer = generateExcelFile(formattedData);

        // Save to temp file
        const quotationNumber = formattedData.metadata.quotationNumber.replace(
          /\//g,
          '-'
        );
        const tempExcelPath = path.join(os.tmpdir(), `${quotationNumber}.xlsx`);
        fs.writeFileSync(tempExcelPath, excelBuffer);

        // Upload to Firebase Storage
        const fileName = `excel_quotations/${projectId}/${quotationNumber}.xlsx`;
        const file = bucket.file(fileName);

        await file.save(fs.readFileSync(tempExcelPath), {
          metadata: {
            contentType:
              'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          },
        });

        // Clean up temp file
        fs.unlinkSync(tempExcelPath);

        // Make the file publicly accessible
        await file.makePublic();

        // Return the public URL
        const excelUrl = `https://storage.googleapis.com/${bucket.name}/${fileName}`;
        return { excelUrl };
      } catch (error: any) {
        console.error('Error generating Excel:', error);
        throw new functions.https.HttpsError(
          'internal',
          `Lá»—i táº¡o file Excel: ${error.message || 'Unknown error'}`,
          error
        );
      }
    }
  );


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\savePOReceiptConfirmation.ts ---

import * as functions from 'firebase-functions/v1';
import * as admin from 'firebase-admin';

/**
 * savePOReceiptConfirmation
 * Updates the purchase order document with receipt confirmation data
 * This function only updates the Firestore document, it doesn't upload any files
 */
export const savePOReceiptConfirmation = functions
  .region('asia-southeast1')
  .runWith({ timeoutSeconds: 60, memory: '256MB' })
  .https.onCall(async (data, context) => {
    // Authentication check
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Báº¡n cáº§n Ä‘Äƒng nháº­p'
      );
    }

    const {
      poId,
      projectId,
      filesToSave,
      remarks = '',
    } = data as {
      poId?: string;
      projectId?: string;
      filesToSave?: Array<{
        id: string;
        name: string;
        url: string;
        mimeType?: string;
      }>;
      remarks?: string;
    };

    // Validate required parameters
    if (!poId || !projectId || !filesToSave) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Thiáº¿u tham sá»‘ báº¯t buá»™c'
      );
    }

    try {
      const db = admin.firestore();
      const poRef = db.collection('purchase_orders').doc(poId);
      const poSnap = await poRef.get();

      if (!poSnap.exists) {
        throw new functions.https.HttpsError('not-found', 'KhÃ´ng tÃ¬m tháº¥y PO');
      }

      // Update PO document
      await poRef.update({
        status: 'received',
        receivedAt: admin.firestore.FieldValue.serverTimestamp(),
        receiptPhotos: filesToSave,
        receiptRemarks: remarks,
        updatedBy: context.auth.uid,
        updatedAt: admin.firestore.FieldValue.serverTimestamp(),
      });

      return { success: true };
    } catch (err: any) {
      console.error('savePOReceiptConfirmation error', err);
      throw new functions.https.HttpsError(
        'internal',
        err.message || 'Lá»—i xá»­ lÃ½ xÃ¡c nháº­n PO'
      );
    }
  });


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\scheduledFunctions.ts ---

import * as functions from 'firebase-functions/v2';
import * as admin from 'firebase-admin';
import { Timestamp } from 'firebase-admin/firestore';

const db = admin.firestore();

/**
 * Scheduled function to aggregate financial data for the director's dashboard
 * Runs daily at 1:00 AM Vietnam time
 */
export const aggregateDashboardData = functions.scheduler.onSchedule(
  {
    schedule: '0 1 * * *',
    timeZone: 'Asia/Ho_Chi_Minh',
    region: 'asia-southeast1',
  },
  async (context) => {
    try {
      console.log('Starting dashboard data aggregation');

      // Get all payable transactions
      const payableSnapshot = await db.collection('payable_transactions').get();
      const transactions = payableSnapshot.docs.map((doc) => doc.data());

      // Calculate total accounts payable (pháº£i tráº£)
      const payableTransactions = transactions.filter(
        (t) => t.type === 'payable'
      );
      const totalAccountsPayable = payableTransactions.reduce(
        (sum, t) => sum + (t.remainingAmount || 0),
        0
      );

      // Calculate total accounts receivable (pháº£i thu)
      const receivableTransactions = transactions.filter(
        (t) => t.type === 'receivable'
      );
      const totalAccountsReceivable = receivableTransactions.reduce(
        (sum, t) => sum + (t.remainingAmount || 0),
        0
      );

      // Calculate net debt position (negative means company owes more than it's owed)
      const netDebtPosition = totalAccountsReceivable - totalAccountsPayable;

      // Calculate top 5 suppliers by outstanding amount (pháº£i tráº£)
      const supplierTotals: Record<string, number> = {};
      payableTransactions.forEach((t) => {
        if (!supplierTotals[t.supplier]) {
          supplierTotals[t.supplier] = 0;
        }
        supplierTotals[t.supplier] += t.remainingAmount || 0;
      });

      const top5Payable = Object.entries(supplierTotals)
        .map(([supplier, amount]) => ({ supplier, amount }))
        .sort((a, b) => b.amount - a.amount)
        .slice(0, 5)
        .map((item) => ({
          ...item,
          // Convert to millions for display
          amountInMillions:
            Math.round((Number(item.amount) / 1000000) * 100) / 100,
        }));

      // Calculate top 5 customers by outstanding amount (pháº£i thu)
      const customerTotals: Record<string, number> = {};
      receivableTransactions.forEach((t) => {
        if (!customerTotals[t.supplier]) {
          // supplier field is used for both suppliers and customers
          customerTotals[t.supplier] = 0;
        }
        customerTotals[t.supplier] += t.remainingAmount || 0;
      });

      const top5Receivable = Object.entries(customerTotals)
        .map(([customer, amount]) => ({ customer, amount }))
        .sort((a, b) => b.amount - a.amount)
        .slice(0, 5)
        .map((item) => ({
          ...item,
          // Convert to millions for display
          amountInMillions:
            Math.round((Number(item.amount) / 1000000) * 100) / 100,
        }));

      // Save aggregated data to Firestore
      await db
        .collection('summaries')
        .doc('directorDashboard')
        .set({
          totalAccountsPayable,
          totalAccountsReceivable,
          netDebtPosition,
          top5Payable,
          top5Receivable,
          lastUpdated: Timestamp.now(),
          formattedTotals: {
            totalAccountsPayable: formatCurrency(totalAccountsPayable),
            totalAccountsReceivable: formatCurrency(totalAccountsReceivable),
            netDebtPosition: formatCurrency(netDebtPosition),
          },
        });

      console.log('Dashboard data aggregation completed successfully');
    } catch (error) {
      console.error('Error aggregating dashboard data:', error);
      throw error;
    }
  }
);

/**
 * Format currency for display (VND)
 */
function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
}


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\taskTriggers.ts ---

//functions/src/taskTriggers.ts
import { onDocumentWritten } from 'firebase-functions/v2/firestore';
import * as admin from 'firebase-admin';

const db = admin.firestore();

// --- Helper Functions ---

/**
 * Fetches users from Firestore based on their role.
 * @param {string | string[]} roles The role or roles to query for.
 * @returns {Promise<any[]>} An array of user objects.
 */
const getUsersByRole = async (roles: string | string[]): Promise<any[]> => {
  const rolesArray = Array.isArray(roles) ? roles : [roles];
  if (rolesArray.length === 0) return [];
  try {
    const usersRef = db.collection('users');
    // Firestore "in" query supports up to 10 elements. If more are needed,
    // multiple queries would be required. For now, this is sufficient.
    const querySnapshot = await usersRef.where('role', 'in', rolesArray).get();
    return querySnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error(`Error fetching users by role: ${roles}`, error);
    return [];
  }
};

/**
 * Sends a push notification to a list of users.
 * @param {any[]} users An array of user objects, must include fcmToken.
 * @param {string} title The notification title.
 * @param {string} body The notification body.
 * @returns {Promise<any>} A promise that resolves when all messages are sent.
 */
const sendNotificationToUsers = (
  users: any[],
  title: string,
  body: string
): Promise<any> => {
  const tokens = users.map((user) => user.fcmToken).filter((token) => token); // Filter out users without tokens

  if (tokens.length === 0) {
    return Promise.resolve();
  }
  // FCM"s sendToDevice supports up to 1000 tokens.
  return admin.messaging().sendToDevice(tokens, {
    notification: { title, body, sound: 'default' },
  });
};

/**
 * Fetches a user"s display name from their UID.
 * @param {string} uid The user"s ID.
 * @returns {Promise<string>} The user"s name or a fallback string.
 */
const getUserName = async (uid: string): Promise<string> => {
  if (!uid) return 'Há»‡ thá»‘ng';
  try {
    const userRecord = await admin.auth().getUser(uid);
    return userRecord.displayName || userRecord.email || 'NgÆ°á»i dÃ¹ng khÃ´ng tÃªn';
  } catch (error) {
    console.error(`Error fetching user data for UID: ${uid}`, error);
    return 'NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i';
  }
};

/**
 * Gets the human-readable label for a task key.
 * @param {string} taskKey The key of the task (e.g., "material_cutting").
 * @param {any} taskData The data object for the task, used for custom task names.
 * @returns {string} The display label for the task.
 */
const getTaskLabel = (taskKey: string, taskData: any): string => {
  const taskLabels: { [key: string]: string } = {
    material_separation: 'BÃ³c tÃ¡ch váº­t tÆ°',
    quotation: 'BÃ¡o giÃ¡',
    material_purchasing: 'Mua váº­t tÆ° & phá»¥ kiá»‡n',
    material_cutting: 'Cáº¯t phÃ´i',
    assembly: 'Láº¯p rÃ¡p',
    painting: 'SÆ¡n',
    shipping: 'Váº­n chuyá»ƒn',
    other: taskData?.name || 'CÃ´ng viá»‡c khÃ¡c',
  };
  return taskLabels[taskKey] || 'CÃ´ng viá»‡c khÃ´ng xÃ¡c Ä‘á»‹nh';
};

/**
 * Denormalizes a single task into the top-level "tasks" collection.
 * @param {string} projectId The project ID.
 * @param {string} projectName The project name.
 * @param {string} projectStatus The project status.
 * @param {string} taskKey The key of the task.
 * @param {any} taskData The data of the task.
 * @returns {Promise<any>} A promise that resolves when the write is complete.
 */
const denormalizeTask = async (
  projectId: string,
  projectName: string,
  projectStatus: string,
  taskKey: string,
  taskData: any
) => {
  const assignedToId = taskData.assignedTo || null;
  const assignedToName = await getUserName(assignedToId);
  const denormalizedTask = {
    projectId,
    projectName,
    projectStatus,
    taskKey,
    taskLabel: getTaskLabel(taskKey, taskData),
    status: taskData.status || 'pending',
    assignedToId,
    assignedToName,
    startDate: taskData.startDate || null,
    endDate: taskData.endDate || null,
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
  };
  const docId = `${projectId}_${taskKey}`;
  return db
    .collection('tasks')
    .doc(docId)
    .set(denormalizedTask, { merge: true });
};

// --- Main Cloud Function Trigger ---

export const projectWorkflowManager = onDocumentWritten(
  {
    document: 'projects/{projectId}',
    region: 'asia-southeast1',
  },
  async (event) => {
    const { projectId } = event.params;
    const beforeData = event.data?.before.data();
    const afterData = event.data?.after.data();

    if (!afterData) {
      console.log(`Project ${projectId} deleted. No action taken.`);
      return null;
    }

    const projectName = afterData.name || 'Dá»± Ã¡n khÃ´ng tÃªn';
    const updates: { [key: string]: any } = {};
    const notificationPromises: Promise<any>[] = [];

    // --- Workflow Triggers ---

    // Trigger 1: Project Creation
    if (!beforeData) {
      const engineers = await getUsersByRole('ky_su');
      if (engineers.length > 0) {
        const engineerToAssign = engineers[0];
        updates['tasks.material_separation.assignedTo'] = engineerToAssign.id;
        notificationPromises.push(
          sendNotificationToUsers(
            [engineerToAssign],
            'Nhiá»‡m vá»¥ má»›i',
            `Báº¡n Ä‘Æ°á»£c giao nhiá»‡m vá»¥ "TÃ¡ch váº­t liá»‡u" cho dá»± Ã¡n má»›i: ${projectName}.`
          )
        );
      }
    }

    // ---- NEW WORKFLOW LOGIC ----
    const beforeStages: any[] = beforeData?.workflowStages || [];
    const afterStages: any[] = afterData.workflowStages || [];

    // Detect status change to completed for material_separation
    const justCompleted = afterStages.find((stageAfter) => {
      if (stageAfter.processKey !== 'material_separation') return false;
      const beforeStage = beforeStages.find(
        (s) => s.stageId === stageAfter.stageId
      );
      return (
        beforeStage?.status !== 'completed' && stageAfter.status === 'completed'
      );
    });

    if (justCompleted) {
      // Find next stage by order
      const nextStage = afterStages
        .filter((s) => s.order > justCompleted.order)
        .sort((a, b) => a.order - b.order)[0];

      if (nextStage && nextStage.processKey === 'quotation') {
        const usersToNotify = await getUsersByRole(['thuong_mai', 'giam_doc']);
        const salesUser = usersToNotify.find((u) => u.role === 'thuong_mai');

        if (salesUser) {
          // update array element
          const newStages = afterStages.map((s) =>
            s.stageId === nextStage.stageId
              ? { ...s, assignedToId: salesUser.id }
              : s
          );
          updates['workflowStages'] = newStages;
        }

        notificationPromises.push(
          sendNotificationToUsers(
            usersToNotify,
            'YÃªu cáº§u bÃ¡o giÃ¡',
            `Ká»¹ sÆ° Ä‘Ã£ hoÃ n thÃ nh bÃ³c tÃ¡ch váº­t liá»‡u cho dá»± Ã¡n ${projectName}. Vui lÃ²ng tiáº¿n hÃ nh bÃ¡o giÃ¡.`
          )
        );
      }
    }

    // Trigger 3: Project Approved -> Assign Purchasing & Cutting
    if (
      beforeData?.status === 'pending' &&
      afterData.status === 'in-progress'
    ) {
      // a. Assign Material Purchasing
      const purchasingUsers = await getUsersByRole(['thuong_mai', 'ke_toan']);
      const salesUser = purchasingUsers.find((u) => u.role === 'thuong_mai');
      if (salesUser) {
        updates['tasks.material_purchasing.assignedTo'] = salesUser.id;
      }
      notificationPromises.push(
        sendNotificationToUsers(
          purchasingUsers,
          'YÃªu cáº§u mua váº­t tÆ°',
          `Dá»± Ã¡n ${projectName} Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t. Vui lÃ²ng tiáº¿n hÃ nh mua váº­t tÆ°.`
        )
      );

      // b. Assign Material Cutting
      const cuttingEngineers = await getUsersByRole('ky_su_cat_phoi');
      if (cuttingEngineers.length > 0) {
        const engineerToAssign = cuttingEngineers[0];
        updates['tasks.material_cutting.assignedTo'] = engineerToAssign.id;
        notificationPromises.push(
          sendNotificationToUsers(
            [engineerToAssign],
            'Nhiá»‡m vá»¥ má»›i',
            `Báº¡n Ä‘Æ°á»£c giao nhiá»‡m vá»¥ "Cáº¯t phÃ´i" cho dá»± Ã¡n ${projectName}.`
          )
        );
      }
    }

    // Trigger 4: Material Cutting Completed -> Assign Assembly & Painting
    if (
      beforeData?.tasks.material_cutting?.status !== 'completed' &&
      afterData.tasks.material_cutting?.status === 'completed'
    ) {
      const viceDirectors = await getUsersByRole('pho_giam_doc');
      if (viceDirectors.length > 0) {
        const userToAssign = viceDirectors[0];
        updates['tasks.assembly.assignedTo'] = userToAssign.id;
        updates['tasks.painting.assignedTo'] = userToAssign.id;
        notificationPromises.push(
          sendNotificationToUsers(
            viceDirectors,
            'YÃªu cáº§u giÃ¡m sÃ¡t',
            `CÃ´ng Ä‘oáº¡n Cáº¯t phÃ´i Ä‘Ã£ xong. Vui lÃ²ng giÃ¡m sÃ¡t vÃ  thá»±c hiá»‡n Láº¯p rÃ¡p & SÆ¡n cho dá»± Ã¡n ${projectName}.`
          )
        );
      }
    }

    // Trigger 5: Assembly & Painting Completed -> Assign Shipping
    if (
      afterData.tasks.assembly?.status === 'completed' &&
      afterData.tasks.painting?.status === 'completed' &&
      (beforeData?.tasks.assembly?.status !== 'completed' ||
        beforeData?.tasks.painting?.status !== 'completed')
    ) {
      const usersToNotify = await getUsersByRole(['ke_toan', 'pho_giam_doc']);
      const accountant = usersToNotify.find((u) => u.role === 'ke_toan');

      if (accountant) {
        updates['tasks.shipping.assignedTo'] = accountant.id;
      }
      notificationPromises.push(
        sendNotificationToUsers(
          usersToNotify,
          'YÃªu cáº§u váº­n chuyá»ƒn',
          `Dá»± Ã¡n ${projectName} Ä‘Ã£ sáºµn sÃ ng. Vui lÃ²ng sáº¯p xáº¿p váº­n chuyá»ƒn.`
        )
      );
    }

    // --- Denormalization Logic (runs on any task change) ---
    const denormalizationPromises: Promise<any>[] = [];
    const beforeTasks = beforeData?.tasks || {};
    const afterTasks = afterData.tasks || {};

    for (const taskKey in afterTasks) {
      if (
        Object.prototype.hasOwnProperty.call(afterTasks, taskKey) &&
        JSON.stringify(beforeTasks[taskKey]) !==
          JSON.stringify(afterTasks[taskKey])
      ) {
        denormalizationPromises.push(
          denormalizeTask(
            projectId,
            projectName,
            afterData.status,
            taskKey,
            afterTasks[taskKey]
          )
        );
      }
    }

    // --- Execute Updates and Notifications ---
    const allPromises: Promise<any>[] = [
      ...notificationPromises,
      ...denormalizationPromises,
    ];

    if (Object.keys(updates).length > 0 && event.data) {
      // Add timestamp to avoid recursive triggers for the same update
      updates['workflowUpdatedAt'] =
        admin.firestore.FieldValue.serverTimestamp();
      allPromises.push(event.data.after.ref.update(updates));
    }

    return Promise.all(allPromises);
  }
);


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\uploadFileToDrive.ts ---

import * as functions from 'firebase-functions/v1';
import * as admin from 'firebase-admin';
import { Readable } from 'stream';
import { getDriveClient } from './utils/driveClient';

const db = admin.firestore();

/**
 * Callable Function: uploadFileToDrive
 * Uploads a base64 file to the "QC_Reports" subfolder of the project's Drive folder.
 * Returns the fileId and webViewLink.
 */
export const uploadFileToDrive = functions
  .region('asia-southeast1')
  .runWith({ timeoutSeconds: 300, memory: '1GB' })
  .https.onCall(async (data, context) => {
    // Authentication check
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng nÃ y.'
      );
    }

    const { projectId, fileName, mimeType, base64Data } = data as {
      projectId?: string;
      fileName?: string;
      mimeType?: string;
      base64Data?: string;
    };

    // Validate parameters
    if (!projectId || !fileName || !mimeType || !base64Data) {
      throw new functions.https.HttpsError(
        'invalid-argument',
        'Thiáº¿u tham sá»‘ (projectId, fileName, mimeType hoáº·c base64Data)'
      );
    }

    try {
      const projectSnap = await db.collection('projects').doc(projectId).get();
      const projectData = projectSnap.data();

      if (!projectData || !projectData.driveFolderId) {
        throw new functions.https.HttpsError(
          'failed-precondition',
          'KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c Drive cá»§a dá»± Ã¡n.'
        );
      }

      const drive = await getDriveClient();

      // Step 1: Find or create QC_Reports subfolder
      const folderQuery = await drive.files.list({
        q: `name='QC_Reports' and '${projectData.driveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name)',
        spaces: 'drive',
      });

      let qcFolderId: string | undefined;
      if (folderQuery.data.files && folderQuery.data.files.length > 0) {
        qcFolderId = folderQuery.data.files[0].id;
      } else {
        const folderRes = await drive.files.create({
          requestBody: {
            name: 'QC_Reports',
            mimeType: 'application/vnd.google-apps.folder',
            parents: [projectData.driveFolderId],
          },
          fields: 'id',
        });
        qcFolderId = folderRes.data.id;
      }

      if (!qcFolderId) {
        throw new functions.https.HttpsError(
          'internal',
          'KhÃ´ng thá»ƒ táº¡o hoáº·c tÃ¬m QC_Reports folder.'
        );
      }

      // Step 2: Upload file
      const buffer = Buffer.from(base64Data, 'base64');
      const stream = Readable.from(buffer);

      const createRes = await drive.files.create({
        requestBody: {
          name: fileName,
          mimeType,
          parents: [qcFolderId],
        },
        media: {
          mimeType,
          body: stream,
        },
        fields: 'id, webViewLink, thumbnailLink, mimeType, webContentLink',
      });

      const newFile = createRes.data;

      // Step 3: Set permissions
      await drive.permissions.create({
        fileId: newFile.id!,
        requestBody: {
          role: 'reader',
          type: 'anyone',
        },
      });

      return {
        success: true,
        fileId: newFile.id,
        webViewLink: newFile.webViewLink,
        thumbnailLink: newFile.thumbnailLink || newFile.webContentLink || '',
        mimeType: newFile.mimeType,
      };
    } catch (error: any) {
      console.error('Error uploading file to Drive:', error);
      throw new functions.https.HttpsError(
        'internal',
        error.message || 'KhÃ´ng thá»ƒ táº£i lÃªn file Google Drive.'
      );
    }
  });

/**
 * Callable Function: deleteFileFromDrive
 * Deletes a file on Google Drive by fileId.
 */
export const deleteFileFromDrive = functions
  .region('asia-southeast1')
  .runWith({ timeoutSeconds: 60, memory: '256MB' })
  .https.onCall(async (data, context) => {
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Báº¡n cáº§n Ä‘Äƒng nháº­p.'
      );
    }

    const { fileId } = data as { fileId?: string };
    if (!fileId) {
      throw new functions.https.HttpsError('invalid-argument', 'Thiáº¿u fileId.');
    }

    try {
      const drive = await getDriveClient();
      await drive.files.delete({ fileId });
      return { success: true };
    } catch (error: any) {
      console.error('Error deleting file from Drive:', error);
      throw new functions.https.HttpsError(
        'internal',
        error.message || 'KhÃ´ng thá»ƒ xÃ³a file Google Drive.'
      );
    }
  });


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\uploadFileToDriveUser.ts ---

import * as functions from 'firebase-functions/v1';
import * as admin from 'firebase-admin';
import { google } from 'googleapis';
import { Readable } from 'stream';

const db = admin.firestore();

export const uploadFileToDriveUser = functions
  .region('asia-southeast1')
  .runWith({ timeoutSeconds: 300, memory: '1GB' })
  .https.onCall(async (data, context) => {
    const { accessToken, projectId, fileName, mimeType, base64Data } = data as {
      accessToken?: string;
      projectId?: string;
      fileName?: string;
      mimeType?: string;
      base64Data?: string;
    };

    console.log(
      `[uploadFileToDriveUser] Starting upload for project ${projectId}, file: ${fileName}`
    );

    if (!accessToken) {
      console.error('[uploadFileToDriveUser] Missing accessToken');
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Thiáº¿u accessToken'
      );
    }
    if (!projectId || !fileName || !mimeType || !base64Data) {
      console.error('[uploadFileToDriveUser] Missing required parameters');
      throw new functions.https.HttpsError('invalid-argument', 'Thiáº¿u tham sá»‘');
    }

    try {
      const projectSnap = await db.collection('projects').doc(projectId).get();
      const projectData = projectSnap.data();
      if (!projectData || !projectData.driveFolderId) {
        console.error(
          `[uploadFileToDriveUser] Project folder not found for project ${projectId}`
        );
        throw new functions.https.HttpsError(
          'failed-precondition',
          'KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c Drive cá»§a dá»± Ã¡n.'
        );
      }

      console.log(
        `[uploadFileToDriveUser] Found project folder ID: ${projectData.driveFolderId}`
      );
      console.log(
        `[uploadFileToDriveUser] Project name: ${projectData.name || 'Unknown'}`
      );
      console.log(
        `[uploadFileToDriveUser] Project code: ${projectData.code || 'Unknown'}`
      );

      // Build Drive client with user's OAuth token
      const auth = new google.auth.OAuth2();
      auth.setCredentials({ access_token: accessToken });
      const drive = google.drive({ version: 'v3', auth });

      // Verify access token works by getting user info
      try {
        console.log(`[uploadFileToDriveUser] Verifying access token validity`);
        const aboutResponse = await drive.about.get({
          fields: 'user',
        });
        console.log(
          `[uploadFileToDriveUser] Access token valid for user: ${
            aboutResponse.data.user?.displayName || 'Unknown'
          }`
        );
      } catch (tokenError) {
        console.error(
          `[uploadFileToDriveUser] Access token verification failed:`,
          tokenError
        );
        throw new functions.https.HttpsError(
          'unauthenticated',
          'Google access token khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n.'
        );
      }

      // Verify we can access the project folder
      try {
        console.log(
          `[uploadFileToDriveUser] Verifying access to project folder`
        );
        const folderInfo = await drive.files.get({
          fileId: projectData.driveFolderId,
          fields: 'id,name,mimeType',
        });
        console.log(
          `[uploadFileToDriveUser] Project folder accessible: ${folderInfo.data.name}`
        );
      } catch (folderError) {
        console.error(
          `[uploadFileToDriveUser] Cannot access project folder:`,
          folderError
        );
        throw new functions.https.HttpsError(
          'permission-denied',
          'KhÃ´ng cÃ³ quyá»n truy cáº­p thÆ° má»¥c dá»± Ã¡n. Vui lÃ²ng kiá»ƒm tra quyá»n truy cáº­p Google Drive.'
        );
      }

      console.log(
        `[uploadFileToDriveUser] Looking for QC_Reports folder in project folder`
      );
      // Find or create QC_Reports folder
      const listRes = await drive.files.list({
        q: `name='QC_Reports' and '${projectData.driveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id,name,parents)',
        spaces: 'drive',
      });

      console.log(
        `[uploadFileToDriveUser] QC_Reports folder search result:`,
        JSON.stringify(listRes.data.files)
      );

      let qcFolderId = listRes.data.files?.[0]?.id;

      if (!qcFolderId) {
        console.log(
          `[uploadFileToDriveUser] QC_Reports folder not found, creating new one`
        );
        const folderRes = await drive.files.create({
          requestBody: {
            name: 'QC_Reports',
            mimeType: 'application/vnd.google-apps.folder',
            parents: [projectData.driveFolderId],
          },
          fields: 'id,name,parents',
        });

        qcFolderId = folderRes.data.id!;
        console.log(
          `[uploadFileToDriveUser] Created new QC_Reports folder with ID: ${qcFolderId}`
        );
        console.log(
          `[uploadFileToDriveUser] New folder details:`,
          JSON.stringify(folderRes.data)
        );
      } else {
        console.log(
          `[uploadFileToDriveUser] Found existing QC_Reports folder with ID: ${qcFolderId}`
        );
      }

      // Verify we can access the QC_Reports folder
      try {
        console.log(
          `[uploadFileToDriveUser] Verifying access to QC_Reports folder`
        );
        const folderInfo = await drive.files.get({
          fileId: qcFolderId,
          fields: 'id,name,mimeType,parents',
        });
        console.log(
          `[uploadFileToDriveUser] QC_Reports folder accessible: ${folderInfo.data.name}`
        );
        console.log(
          `[uploadFileToDriveUser] QC_Reports folder parent: ${folderInfo.data.parents?.[0]}`
        );

        // Verify this folder is actually in the project folder
        if (folderInfo.data.parents?.[0] !== projectData.driveFolderId) {
          console.warn(
            `[uploadFileToDriveUser] WARNING: QC_Reports folder is not in the project folder!`
          );
          console.warn(
            `[uploadFileToDriveUser] Expected parent: ${projectData.driveFolderId}, Actual parent: ${folderInfo.data.parents?.[0]}`
          );

          // Create a new QC_Reports folder directly inside the project folder to ensure correct location
          console.log(
            `[uploadFileToDriveUser] Creating a new QC_Reports folder inside the correct project folder`
          );
          const newFolderRes = await drive.files.create({
            requestBody: {
              name: 'QC_Reports',
              mimeType: 'application/vnd.google-apps.folder',
              parents: [projectData.driveFolderId],
            },
            fields: 'id,name,parents',
          });
          qcFolderId = newFolderRes.data.id!;
          console.log(
            `[uploadFileToDriveUser] New QC_Reports folder created with ID: ${qcFolderId}`
          );
          console.log(
            `[uploadFileToDriveUser] New folder details:`,
            JSON.stringify(newFolderRes.data)
          );
        }
      } catch (folderError) {
        console.error(
          `[uploadFileToDriveUser] Cannot access QC_Reports folder:`,
          folderError
        );
        throw new functions.https.HttpsError(
          'permission-denied',
          'KhÃ´ng cÃ³ quyá»n truy cáº­p thÆ° má»¥c QC_Reports. Vui lÃ²ng kiá»ƒm tra quyá»n truy cáº­p Google Drive.'
        );
      }

      console.log(
        `[uploadFileToDriveUser] Preparing file upload to QC_Reports folder`
      );
      const buffer = Buffer.from(base64Data, 'base64');
      const stream = Readable.from(buffer);
      console.log(
        `[uploadFileToDriveUser] File buffer size: ${buffer.length} bytes`
      );

      // Log the file information before upload
      console.log(`[uploadFileToDriveUser] Uploading file with parameters:
        Name: ${fileName}
        MimeType: ${mimeType}
        Target folder: ${qcFolderId}
        File size: ${buffer.length} bytes`);

      const fileRes = await drive.files.create({
        requestBody: { name: fileName, mimeType, parents: [qcFolderId] },
        media: { mimeType, body: stream },
        fields:
          'id, webViewLink, thumbnailLink, mimeType, webContentLink, parents',
      });

      console.log(
        `[uploadFileToDriveUser] File uploaded successfully with ID: ${fileRes.data.id}`
      );
      console.log(
        `[uploadFileToDriveUser] File webViewLink: ${fileRes.data.webViewLink}`
      );
      console.log(
        `[uploadFileToDriveUser] File parent folder: ${fileRes.data.parents?.[0]}`
      );

      // Verify file was uploaded to correct folder
      if (fileRes.data.parents?.[0] !== qcFolderId) {
        console.warn(
          `[uploadFileToDriveUser] WARNING: File was not uploaded to the QC_Reports folder!`
        );
        console.warn(
          `[uploadFileToDriveUser] Expected parent: ${qcFolderId}, Actual parent: ${fileRes.data.parents?.[0]}`
        );
      }

      await drive.permissions.create({
        fileId: fileRes.data.id!,
        requestBody: { role: 'reader', type: 'anyone' },
      });
      console.log(`[uploadFileToDriveUser] Permissions set to public for file`);

      // Get file metadata to verify it exists
      try {
        const fileMetadata = await drive.files.get({
          fileId: fileRes.data.id!,
          fields: 'id,name,webViewLink,parents',
        });
        console.log(
          `[uploadFileToDriveUser] File verification - Name: ${fileMetadata.data.name}, Parent: ${fileMetadata.data.parents?.[0]}`
        );

        // List files in the QC_Reports folder to verify the file is there
        console.log(
          `[uploadFileToDriveUser] Listing files in QC_Reports folder to verify...`
        );
        const filesInFolder = await drive.files.list({
          q: `'${qcFolderId}' in parents and trashed=false`,
          fields: 'files(id,name)',
          spaces: 'drive',
        });

        console.log(
          `[uploadFileToDriveUser] Files in QC_Reports folder:`,
          JSON.stringify(filesInFolder.data.files)
        );

        // Check if our file is in the list
        const fileInFolder = filesInFolder.data.files?.find(
          (f) => f.id === fileRes.data.id
        );
        if (fileInFolder) {
          console.log(
            `[uploadFileToDriveUser] Confirmed file exists in QC_Reports folder`
          );
        } else {
          console.warn(
            `[uploadFileToDriveUser] WARNING: File not found in QC_Reports folder list!`
          );
        }
      } catch (verifyErr) {
        console.error(
          `[uploadFileToDriveUser] Error verifying file: ${verifyErr}`
        );
      }

      return {
        success: true,
        fileId: fileRes.data.id,
        webViewLink: fileRes.data.webViewLink,
        thumbnailLink:
          fileRes.data.thumbnailLink || fileRes.data.webContentLink,
        mimeType: fileRes.data.mimeType,
        fileName: fileName,
      };
    } catch (err: any) {
      console.error('[uploadFileToDriveUser] Error:', err);
      throw new functions.https.HttpsError(
        'internal',
        err.message || 'Lá»—i ná»™i bá»™'
      );
    }
  });


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\excelGenerator\index.ts ---

// functions/src/index.ts

import * as functions from 'firebase-functions/v1';
import { google, sheets_v4 } from 'googleapis';
import { CallableContext } from 'firebase-functions/v1/https';
import * as admin from 'firebase-admin';

// Giáº£ sá»­ báº¡n Ä‘Ã£ Ä‘á»‹nh nghÄ©a kiá»ƒu nÃ y trong file types.ts
interface ExcelQuotationData {
  metadata: {
    projectName?: string;
    customerName?: string;
    customerAddress?: string;
    customerPhone?: string;
    customerEmail?: string;
    customerTaxCode?: string;
    customerContactPerson?: string;
    quotationNumber?: string;
    quoteValidity?: string;
    deliveryTime?: string;
  };
  materials: {
    isNote?: boolean; // Flag to identify note rows
    no: number;
    name: string;
    unit: string;
    quantity: number;
    unitPrice: number;
    total: number;
    material?: string;
    weight?: number; // ThÃªm trÆ°á»ng weight Ä‘á»ƒ lÆ°u khá»‘i lÆ°á»£ng váº­t tÆ°
  }[];
  summary: {
    subTotal: number;
    vatPercentage: number;
    vatAmount: number;
    grandTotal: number;
  };
}

// ----- Cáº¤U HÃŒNH -----
const TEMPLATE_FILE_ID = '18CYrE8IHHbqNBc-FWrQw5kGnyLW31VDJOA4a1tusu4M';
// @ts-ignore - Keep for backward compatibility
const DESTINATION_FOLDER_ID = '18OrAEBSuZzz-AFbqlitz5gUxpsdunXjX';
const START_ROW_MATERIALS = 10; // Dá»±a theo áº£nh, cÃ³ váº» lÃ  dÃ²ng 10
// URL áº£nh chá»¯ kÃ½ tá»« Firebase Storage - Ä‘Ã£ xÃ³a bá»
// const SIGNATURE_IMAGE_URL =
//   'https://storage.googleapis.com/tanyb-fe4bf.firebasestorage.app/signature.png';

// ----- HÃ€M CHÃNH -----
export const generateExcelQuotation = functions
  .region('asia-southeast1')
  .runWith({ timeoutSeconds: 300, memory: '512MB' })
  .https.onCall(
    async (
      data: { formattedData: ExcelQuotationData; projectId: string },
      context: CallableContext
    ) => {
      // ... (Pháº§n xÃ¡c thá»±c vÃ  kiá»ƒm tra data giá»¯ nguyÃªn)
      if (!context.auth) {
        throw new functions.https.HttpsError(
          'unauthenticated',
          'Báº¡n cáº§n Ä‘Äƒng nháº­p.'
        );
      }
      const { formattedData, projectId, accessToken } = data as {
        formattedData: ExcelQuotationData;
        projectId: string;
        accessToken?: string;
      };
      if (!formattedData) {
        throw new functions.https.HttpsError(
          'invalid-argument',
          'Dá»¯ liá»‡u khÃ´ng há»£p lá»‡.'
        );
      }

      if (!projectId) {
        throw new functions.https.HttpsError(
          'invalid-argument',
          'Thiáº¿u ID dá»± Ã¡n.'
        );
      }

      if (!accessToken) {
        throw new functions.https.HttpsError(
          'invalid-argument',
          'Thiáº¿u accessToken Google cá»§a ngÆ°á»i dÃ¹ng.'
        );
      }

      // Sá»­ dá»¥ng OAuth2 client cá»§a googleapis vá»›i accessToken ngÆ°á»i dÃ¹ng
      const auth = new google.auth.OAuth2();
      auth.setCredentials({ access_token: accessToken });

      const drive = google.drive({ version: 'v3', auth });
      const sheets = google.sheets({ version: 'v4', auth });

      // Láº¥y thÃ´ng tin dá»± Ã¡n tá»« Firestore Ä‘á»ƒ tÃ¬m thÆ° má»¥c Drive
      const db = admin.firestore();
      const projectDoc = await db.collection('projects').doc(projectId).get();
      const projectData = projectDoc.data();

      if (!projectData || !projectData.driveFolderId) {
        throw new functions.https.HttpsError(
          'failed-precondition',
          'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin thÆ° má»¥c Drive cá»§a dá»± Ã¡n.'
        );
      }

      try {
        // TÃ¬m thÆ° má»¥c con 'baogia' trong thÆ° má»¥c dá»± Ã¡n
        const baogiaFolderResponse = await drive.files.list({
          q: `name='baogia' and '${projectData.driveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
          fields: 'files(id)',
        });

        // Náº¿u khÃ´ng tÃ¬m tháº¥y thÆ° má»¥c baogia, táº¡o má»›i
        let baogiaFolderId;
        if (
          baogiaFolderResponse.data.files &&
          baogiaFolderResponse.data.files.length > 0
        ) {
          baogiaFolderId = baogiaFolderResponse.data.files[0].id;
        } else {
          // Táº¡o thÆ° má»¥c baogia náº¿u chÆ°a cÃ³
          const folderResponse = await drive.files.create({
            requestBody: {
              name: 'baogia',
              mimeType: 'application/vnd.google-apps.folder',
              parents: [projectData.driveFolderId],
            },
            fields: 'id',
          });
          baogiaFolderId = folderResponse.data.id;
        }

        const newFileName = `BÃ¡o giÃ¡ - ${
          formattedData.metadata.projectName || 'Dá»± Ã¡n'
        } - ${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}`;
        const copiedFileResponse = await drive.files.copy({
          fileId: TEMPLATE_FILE_ID,
          requestBody: { name: newFileName, parents: [baogiaFolderId] },
        });

        const newFileId = copiedFileResponse.data.id;
        if (!newFileId) throw new Error('KhÃ´ng thá»ƒ sao chÃ©p file template.');

        const spreadsheet = await sheets.spreadsheets.get({
          spreadsheetId: newFileId,
          fields: 'sheets.properties',
        });
        const firstSheet = spreadsheet.data.sheets?.[0];
        const sheetId = firstSheet?.properties?.sheetId;
        if (sheetId === undefined || sheetId === null) {
          throw new Error('KhÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh sheetId cá»§a sheet Ä‘áº§u tiÃªn');
        }

        // TÃ­nh toÃ¡n vá»‹ trÃ­ cÃ¡c dÃ²ng
        const lastMaterialRow =
          START_ROW_MATERIALS + Math.max(0, formattedData.materials.length - 1);
        const totalRow = lastMaterialRow + 2;
        const vatRow = totalRow + 1;
        const totalWithVatRow = vatRow + 1;
        const amountInWordsRow = totalWithVatRow + 1;
        const blankRowAfterWords = amountInWordsRow + 1; // DÃ²ng trá»‘ng
        const notesRow = blankRowAfterWords + 1;
        const footerStartRow = notesRow + 1;
        const signatureRow = footerStartRow + 6;

        const requests: sheets_v4.Schema$Request[] = [];

        // Há»§y bá» merge cell á»Ÿ vÃ¹ng cÃ³ thá»ƒ gÃ¢y lá»—i
        requests.push({
          unmergeCells: {
            range: {
              sheetId,
              startRowIndex: START_ROW_MATERIALS - 1,
              endRowIndex: START_ROW_MATERIALS + 150, // Má»Ÿ rá»™ng vÃ¹ng lÃ m viá»‡c
              startColumnIndex: 0,
              endColumnIndex: 7,
            },
          },
        });

        // XÃ³a ná»™i dung cÅ© trong vÃ¹ng lÃ m viá»‡c Ä‘á»™ng Ä‘á»ƒ trÃ¡nh dá»¯ liá»‡u thá»«a tá»« template
        requests.push({
          updateCells: {
            range: {
              sheetId,
              startRowIndex: START_ROW_MATERIALS - 1,
              endRowIndex: START_ROW_MATERIALS + 150, // Pháº£i khá»›p vá»›i vÃ¹ng unmerge
              startColumnIndex: 0,
              endColumnIndex: 7,
            },
            fields: 'userEnteredValue', // Chá»‰ xÃ³a giÃ¡ trá»‹, giá»¯ Ä‘á»‹nh dáº¡ng
          },
        });

        // Unmerge header rows 4-6 to avoid partial merge errors
        requests.push({
          unmergeCells: {
            range: {
              sheetId,
              startRowIndex: 3, // rows A4, A5, A6 index
              endRowIndex: 6,
              startColumnIndex: 0,
              endColumnIndex: 7,
            },
          },
        });

        // Cáº­p nháº­t tÃªn khÃ¡ch hÃ ng vÃ o Ã´ A4
        // Merge cells A4-G4 for company name
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 3,
              endRowIndex: 4,
              startColumnIndex: 0,
              endColumnIndex: 7,
            },
          },
        });

        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: `KÃNH Gá»¬I: ${
                        formattedData.metadata.customerName || ''
                      }`,
                    },
                    userEnteredFormat: {
                      textFormat: { bold: true },
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: 3, columnIndex: 0 }, // A4 (0-indexed)
          },
        });

        // Add border to company name
        requests.push({
          updateBorders: {
            range: {
              sheetId,
              startRowIndex: 3,
              endRowIndex: 4,
              startColumnIndex: 0,
              endColumnIndex: 7,
            },
            top: { style: 'SOLID' },
            bottom: { style: 'SOLID' },
            left: { style: 'SOLID' },
            right: { style: 'SOLID' },
          },
        });

        // KHÃ”NG MERGE cells A5-G5 cho Ä‘á»‹a chá»‰ ná»¯a
        // ThÃªm label "Äá»‹a chá»‰:" vÃ o A5
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: { stringValue: 'Äá»‹a chá»‰:' },
                    userEnteredFormat: {
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: 4, columnIndex: 0 }, // A5
          },
        });

        // Ghi Ä‘á»‹a chá»‰ vÃ o Ã´ B5 (khÃ´ng merge)
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: formattedData.metadata.customerAddress || '',
                    },
                    userEnteredFormat: {
                      wrapStrategy: 'WRAP',
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: 4, columnIndex: 1 }, // B5
          },
        });

        // Merge cells B5:G5 sau khi Ä‘Ã£ thiáº¿t láº­p giÃ¡ trá»‹ thÃ nh cÃ´ng
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: 4,
              endRowIndex: 5,
              startColumnIndex: 1,
              endColumnIndex: 7,
            },
          },
        });

        // Add border to address row
        requests.push({
          updateBorders: {
            range: {
              sheetId,
              startRowIndex: 4,
              endRowIndex: 5,
              startColumnIndex: 0,
              endColumnIndex: 7,
            },
            top: { style: 'SOLID' },
            bottom: { style: 'SOLID' },
            left: { style: 'SOLID' },
            right: { style: 'SOLID' },
          },
        });

        // Cáº­p nháº­t thÃ´ng tin liÃªn há»‡ khÃ¡ch hÃ ng vÃ o cÃ¡c Ã´ tÆ°Æ¡ng á»©ng
        // Sá»‘ Ä‘iá»‡n thoáº¡i vÃ o Ã´ B6
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: formattedData.metadata.customerPhone || '',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue',
            start: { sheetId, rowIndex: 5, columnIndex: 1 }, // B6 (0-indexed)
          },
        });

        // Email vÃ o Ã´ B7 (vá»›i Ä‘á»‹nh dáº¡ng mÃ u Ä‘en)
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: formattedData.metadata.customerEmail || '',
                    },
                    userEnteredFormat: {
                      textFormat: {
                        foregroundColor: { red: 0, green: 0, blue: 0 }, // MÃ u Ä‘en
                      },
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: 6, columnIndex: 1 }, // B7 (0-indexed)
          },
        });

        // MÃ£ sá»‘ thuáº¿ vÃ o Ã´ C6
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: 'MST:',
                    },
                    userEnteredFormat: {
                      textFormat: { bold: false }, // Bá» bÃ´i Ä‘áº­m
                      horizontalAlignment: 'LEFT',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue,userEnteredFormat',
            start: { sheetId, rowIndex: 5, columnIndex: 2 }, // C6
          },
        });

        // Tax code vÃ o Ã´ D6
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: formattedData.metadata.customerTaxCode || '',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue',
            start: { sheetId, rowIndex: 5, columnIndex: 3 }, // D6 (0-indexed)
          },
        });

        // NgÆ°á»i liÃªn há»‡ vÃ o Ã´ C7
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: 'Attn:',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue',
            start: { sheetId, rowIndex: 6, columnIndex: 2 }, // C7 (0-indexed)
          },
        });

        // ThÃªm tÃªn ngÆ°á»i liÃªn há»‡ vÃ o Ã´ D7
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue:
                        formattedData.metadata.customerContactPerson || '',
                    },
                  },
                ],
              },
            ],
            fields: 'userEnteredValue',
            start: { sheetId, rowIndex: 6, columnIndex: 3 }, // D7 (0-indexed)
          },
        });

        if (formattedData.materials.length > 0) {
          const materialsRows: sheets_v4.Schema$RowData[] = [];
          let sttCounter = 1;

          formattedData.materials.forEach((material) => {
            const nameIsNoteMerge = (material.name || '')
              .toUpperCase()
              .includes('GHI CHÃš');
            const startsWithPlus = (material.name || '').trim().startsWith('+');
            const isNoteRow =
              material.isNote ||
              nameIsNoteMerge ||
              startsWithPlus ||
              ((!material.unit || material.unit === '') &&
                (material.quantity === null ||
                  material.quantity === undefined ||
                  material.quantity === 0) &&
                (!material.material || material.material === ''));

            // é¢å¤–æ£€æŸ¥å…¶ä»–ç‰¹æ®Šè¡Œæ ¼å¼
            const isSpecialRow =
              (material.name && material.name.includes('-----')) ||
              (material.name &&
                material.name.toLowerCase().includes('tá»•ng phá»¥')) ||
              (material.name &&
                material.name.toLowerCase().includes('táº¡m tÃ­nh'));

            // æ‰€æœ‰éœ€è¦ç‰¹æ®Šå¤„ç†çš„è¡Œ
            const shouldFormatAsNote = isNoteRow || isSpecialRow;

            if (shouldFormatAsNote) {
              // æ ¹æ®è¡Œç±»åž‹è°ƒæ•´æ ¼å¼
              if (isSpecialRow) {
                // å¯¹äºŽç‰¹æ®Šè¡Œï¼ˆå¦‚æ€»è®¡å°è®¡ç­‰ï¼‰ï¼Œä½¿ç”¨ç‰¹æ®Šæ ¼å¼
                let bgColor = { red: 1, green: 1, blue: 0.9 }; // é»˜è®¤æµ…é»„è‰²
                let fontStyle = { bold: true, italic: false };
                let alignment = 'CENTER';

                // å¯ä»¥æ ¹æ®ä¸åŒç±»åž‹çš„ç‰¹æ®Šè¡Œè®¾ç½®ä¸åŒçš„æ ·å¼
                if (
                  material.name &&
                  material.name.toLowerCase().includes('tá»•ng phá»¥')
                ) {
                  bgColor = { red: 0.9, green: 0.9, blue: 1 }; // æµ…è“è‰²
                  alignment = 'RIGHT';
                } else if (
                  material.name &&
                  material.name.toLowerCase().includes('táº¡m tÃ­nh')
                ) {
                  bgColor = { red: 0.9, green: 1, blue: 0.9 }; // æµ…ç»¿è‰²
                  alignment = 'RIGHT';
                }

                materialsRows.push({
                  values: [
                    {
                      userEnteredValue: { stringValue: material.name || '' },
                      userEnteredFormat: {
                        textFormat: fontStyle,
                        horizontalAlignment: alignment,
                        verticalAlignment: 'MIDDLE',
                        backgroundColor: bgColor,
                      },
                    },
                    {},
                    {},
                    {},
                    {},
                    {},
                  ],
                });
              } else {
                // åŽŸå§‹å¤‡æ³¨è¡Œæ ¼å¼ä¿æŒä¸å˜
                materialsRows.push({
                  values: [
                    {
                      userEnteredValue: { stringValue: material.name || '' },
                      userEnteredFormat: {
                        textFormat: { italic: true },
                        horizontalAlignment: 'LEFT',
                        verticalAlignment: 'MIDDLE',
                        backgroundColor: { red: 1, green: 1, blue: 0.9 },
                      },
                    },
                    {},
                    {},
                    {},
                    {},
                    {},
                  ],
                });
              }
            } else {
              materialsRows.push({
                values: [
                  {
                    userEnteredValue: { numberValue: sttCounter++ },
                    userEnteredFormat: {
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                  {
                    userEnteredValue: { stringValue: material.name || '' },
                    userEnteredFormat: {
                      horizontalAlignment: 'LEFT',
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                  {
                    userEnteredValue: { stringValue: material.material || '' },
                    userEnteredFormat: {
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                  {
                    userEnteredValue: { stringValue: material.unit || '' },
                    userEnteredFormat: {
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                  {
                    userEnteredValue: {
                      numberValue: material.quantity ?? 0,
                    },
                    userEnteredFormat: {
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                  {
                    userEnteredValue: material.unitPrice
                      ? { numberValue: material.unitPrice }
                      : { stringValue: '' },
                    userEnteredFormat: {
                      numberFormat: { type: 'NUMBER', pattern: '#,##0' },
                      textFormat: { bold: material.unitPrice ? true : false },
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                  {
                    userEnteredValue: material.total
                      ? { numberValue: material.total }
                      : { stringValue: '' },
                    userEnteredFormat: {
                      numberFormat: { type: 'NUMBER', pattern: '#,##0' },
                      textFormat: { bold: material.total ? true : false },
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                ],
              });
            }
          });
          requests.push({
            updateCells: {
              rows: materialsRows,
              fields: 'userEnteredValue,userEnteredFormat',
              start: {
                sheetId,
                rowIndex: START_ROW_MATERIALS - 1,
                columnIndex: 0,
              },
            },
          });

          // Add merge requests for note rows and special rows between notes and total
          formattedData.materials.forEach((material, index) => {
            const nameIsNoteMerge = (material.name || '')
              .toUpperCase()
              .includes('GHI CHÃš');
            const startsWithPlusMerge = (material.name || '')
              .trim()
              .startsWith('+');

            // æ‰©å±•åˆå¹¶æ¡ä»¶ï¼ŒåŒ…æ‹¬å¤‡æ³¨è¡Œå’Œéœ€è¦åˆå¹¶çš„ç‰¹æ®Šè¡Œ
            const isNoteRow =
              material.isNote ||
              nameIsNoteMerge ||
              startsWithPlusMerge ||
              ((!material.unit || material.unit === '') &&
                (material.quantity === null ||
                  material.quantity === undefined ||
                  material.quantity === 0) &&
                (!material.material || material.material === ''));

            // éœ€è¦åˆå¹¶çš„ç‰¹æ®Šè¡Œæ¡ä»¶ï¼šå¤‡æ³¨è¡Œæˆ–å…¶ä»–éœ€åˆå¹¶çš„ç‰¹æ®Šæ ¼å¼è¡Œ
            const shouldMergeFullRow =
              isNoteRow ||
              // è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–éœ€è¦åˆå¹¶çš„ç‰¹æ®Šè¡Œçš„åˆ¤æ–­æ¡ä»¶
              (material.name && material.name.includes('-----')) ||
              (material.name &&
                material.name.toLowerCase().includes('tá»•ng phá»¥')) ||
              (material.name &&
                material.name.toLowerCase().includes('táº¡m tÃ­nh'));

            if (shouldMergeFullRow) {
              const noteRowIndex = START_ROW_MATERIALS - 1 + index;
              requests.push({
                mergeCells: {
                  range: {
                    sheetId,
                    startRowIndex: noteRowIndex,
                    endRowIndex: noteRowIndex + 1,
                    startColumnIndex: 0, // Column A
                    endColumnIndex: 7, // Up to column G (7 columns total)
                  },
                  mergeType: 'MERGE_ALL',
                },
              });
            }
          });
        }

        // --- Báº¯t Ä‘áº§u pháº§n Ä‘á»‹nh dáº¡ng Footer ---
        const blueBg = { red: 200 / 255, green: 204 / 255, blue: 228 / 255 }; // #c8cce4
        const yellowBg = { red: 255 / 255, green: 255 / 255, blue: 204 / 255 };
        const boldRight = {
          horizontalAlignment: 'RIGHT',
          textFormat: { bold: true, fontSize: 11 },
          backgroundColor: blueBg,
        };
        const boldRightValue = {
          ...boldRight,
          numberFormat: { type: 'NUMBER', pattern: '#,##0' },
        };
        const boldCenterYellow = {
          horizontalAlignment: 'CENTER',
          verticalAlignment: 'MIDDLE',
          textFormat: { bold: true, italic: true, fontSize: 11 },
          backgroundColor: yellowBg,
        };

        // Tá»•ng cá»™ng, VAT, Tá»•ng cÃ³ VAT (kÃ©o dÃ i Ä‘áº¿n cá»™t G - index 6)
        const summaryEndColumn = 7; // Cá»™t G
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: totalRow - 1,
              endRowIndex: totalRow,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn - 1,
            },
          },
        });
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: { stringValue: 'Tá»•ng cá»™ng' },
                    userEnteredFormat: boldRight,
                  },
                  {},
                  {},
                  {},
                  {},
                  {},
                  {
                    userEnteredValue: {
                      numberValue: formattedData.summary.subTotal,
                    },
                    userEnteredFormat: boldRightValue,
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: totalRow - 1, columnIndex: 0 },
          },
        });
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: vatRow - 1,
              endRowIndex: vatRow,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn - 1,
            },
          },
        });
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: `Thuáº¿ VAT ${formattedData.summary.vatPercentage}%`,
                    },
                    userEnteredFormat: boldRight,
                  },
                  {},
                  {},
                  {},
                  {},
                  {},
                  {
                    userEnteredValue: {
                      numberValue: formattedData.summary.vatAmount,
                    },
                    userEnteredFormat: boldRightValue,
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: vatRow - 1, columnIndex: 0 },
          },
        });
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: totalWithVatRow - 1,
              endRowIndex: totalWithVatRow,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn - 1,
            },
          },
        });
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: 'Tá»•ng cá»™ng Ä‘Ã£ bao gá»“m VAT 10%',
                    },
                    userEnteredFormat: boldRight,
                  },
                  {},
                  {},
                  {},
                  {},
                  {},
                  {
                    userEnteredValue: {
                      numberValue: formattedData.summary.grandTotal,
                    },
                    userEnteredFormat: boldRightValue,
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: totalWithVatRow - 1, columnIndex: 0 },
          },
        });

        // Báº±ng chá»¯
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: amountInWordsRow - 1,
              endRowIndex: amountInWordsRow,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
          },
        });
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: convertNumberToVnWords(
                        formattedData.summary.grandTotal
                      ),
                    },
                    userEnteredFormat: boldCenterYellow,
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: amountInWordsRow - 1, columnIndex: 0 },
          },
        });

        // **FIX 3: Merge vÃ  káº» viá»n dÃ²ng trá»‘ng**
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: blankRowAfterWords - 1,
              endRowIndex: blankRowAfterWords,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
          },
        });

        // Ghi chÃº
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: notesRow - 1,
              endRowIndex: notesRow,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
          },
        });
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue:
                        'Ghi chÃº: CÃ¡c Ä‘iá»u khoáº£n khÃ¡c vui lÃ²ng xem bÃªn dÆ°á»›i.',
                    },
                    userEnteredFormat: {
                      textFormat: { bold: true, italic: true },
                      padding: { left: 10 },
                    },
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: notesRow - 1, columnIndex: 0 },
          },
        });

        // Pháº§n Ä‘iá»u khoáº£n
        const termsTextPart1 =
          `1. BÃ¡o giÃ¡ cÃ³ hiá»‡u lá»±c trong ${
            formattedData.metadata.quoteValidity || '7 ngÃ y'
          }. Háº¿t hiá»‡u lá»±c xin liÃªn há»‡ láº¡i cho CÃ´ng ty.\n` +
          `2. Thá»i gian giao hÃ ng: ${
            formattedData.metadata.deliveryTime || '3 ngÃ y'
          } ( khÃ´ng bao gá»“m chá»§ nháº­t, ngÃ y lá»… )\n` +
          `3. GiÃ¡ Ä‘Ã£ bao gá»“m VAT vÃ  chÆ°a bao gá»“m váº­n chuyá»ƒn\n` +
          `4. Äá»‹a Ä‘iá»ƒm giao hÃ ng: XÆ°á»Ÿng THP\n` +
          `5. PhÆ°Æ¡ng thá»©c thanh toÃ¡n: Thanh toÃ¡n báº±ng chuyá»ƒn khoáº£n\n` +
          `    TÃ i khoáº£n sá»‘: 27888866\n` +
          `    TÃªn tÃ i khoáº£n: CÃ´ng ty TNHH SX cÆ¡ khÃ­ TM-DV TÃ¢n HÃ²a PhÃ¡t\n` +
          `    NgÃ¢n hÃ ng TMCP Ã ChÃ¢u - Chi nhÃ¡nh BÃ¬nh TÃ¢y\n`;
        const termsTextPart2 = `    Táº¡m á»©ng 50%, Thanh toÃ¡n 50% trÆ°á»›c khi nháº­n hÃ ng`;

        // Má»Ÿ rá»™ng merge cell cho Ä‘iá»u khoáº£n
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: footerStartRow - 1,
              endRowIndex: footerStartRow + 5,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
          },
        });

        // Pháº§n Ä‘iá»u khoáº£n thÃ´ng thÆ°á»ng
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: termsTextPart1,
                    },
                    userEnteredFormat: {
                      wrapStrategy: 'WRAP',
                      verticalAlignment: 'TOP',
                      padding: { left: 20 },
                    },
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: footerStartRow - 1, columnIndex: 0 },
          },
        });

        // Pháº§n Ä‘iá»u khoáº£n mÃ u Ä‘á» (táº¡m á»©ng)
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      stringValue: termsTextPart2,
                    },
                    userEnteredFormat: {
                      wrapStrategy: 'WRAP',
                      verticalAlignment: 'TOP',
                      padding: { left: 20 },
                      textFormat: {
                        foregroundColor: { red: 1, green: 0, blue: 0 },
                        bold: true,
                      },
                    },
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: footerStartRow + 4, columnIndex: 0 },
          },
        });

        // VÃ¹ng chá»¯ kÃ½
        const buyerSignatureEndCol = 4; // Cá»™t D

        // Äáº§u tiÃªn xÃ³a ná»™i dung Ä‘ang cÃ³ á»Ÿ vÃ¹ng chá»¯ kÃ½ Ä‘á»ƒ trÃ¡nh láº·p láº¡i
        requests.push({
          updateCells: {
            range: {
              sheetId,
              startRowIndex: signatureRow - 1,
              endRowIndex: signatureRow + 5,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
            fields: 'userEnteredValue',
          },
        });

        // Thiáº¿t láº­p láº¡i "XÃ¡c Nháº­n BÃªn Mua"
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: signatureRow - 1,
              endRowIndex: signatureRow,
              startColumnIndex: 0,
              endColumnIndex: buyerSignatureEndCol,
            },
          },
        });

        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: { stringValue: 'XÃ¡c Nháº­n BÃªn Mua' },
                    userEnteredFormat: {
                      horizontalAlignment: 'CENTER',
                      textFormat: { bold: true },
                    },
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: signatureRow - 1, columnIndex: 0 },
          },
        });

        // VÃ¹ng Ä‘á»ƒ kÃ½ bÃªn mua
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: signatureRow,
              endRowIndex: signatureRow + 5,
              startColumnIndex: 0,
              endColumnIndex: buyerSignatureEndCol,
            },
          },
        });

        // ThÃªm border cho khu vá»±c kÃ½ cá»§a BÃªn Mua
        requests.push({
          updateBorders: {
            range: {
              sheetId,
              startRowIndex: signatureRow - 1, // Báº¯t Ä‘áº§u tá»« header "XÃ¡c Nháº­n BÃªn Mua"
              endRowIndex: signatureRow + 5, // Káº¿t thÃºc sau khu vá»±c Ä‘á»ƒ chá»¯ kÃ½
              startColumnIndex: 0,
              endColumnIndex: buyerSignatureEndCol,
            },
            top: { style: 'SOLID' },
            bottom: { style: 'SOLID' },
            left: { style: 'SOLID' },
            right: { style: 'SOLID' },
            innerHorizontal: { style: 'SOLID' },
            innerVertical: { style: 'SOLID' },
          },
        });

        // Thiáº¿t láº­p "XÃ¡c Nháº­n BÃªn BÃ¡n"
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: signatureRow - 1,
              endRowIndex: signatureRow,
              startColumnIndex: buyerSignatureEndCol,
              endColumnIndex: summaryEndColumn,
            },
          },
        });

        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: { stringValue: 'XÃ¡c Nháº­n BÃªn BÃ¡n' },
                    userEnteredFormat: {
                      horizontalAlignment: 'CENTER',
                      textFormat: { bold: true },
                    },
                  },
                ],
              },
            ],
            fields: '*',
            start: {
              sheetId,
              rowIndex: signatureRow - 1,
              columnIndex: buyerSignatureEndCol,
            },
          },
        });

        // VÃ¹ng chá»¯ kÃ½ bÃªn bÃ¡n vÃ  hÃ¬nh áº£nh chá»¯ kÃ½
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: signatureRow,
              endRowIndex: signatureRow + 5,
              startColumnIndex: buyerSignatureEndCol,
              endColumnIndex: summaryEndColumn,
            },
          },
        });

        // **FIX 1: ChÃ¨n áº£nh chá»¯ kÃ½ tá»« Firebase Storage**
        requests.push({
          mergeCells: {
            range: {
              sheetId,
              startRowIndex: signatureRow,
              endRowIndex: signatureRow + 5,
              startColumnIndex: buyerSignatureEndCol,
              endColumnIndex: summaryEndColumn,
            },
          },
        });

        // ChÃ¨n áº£nh chá»¯ kÃ½ tá»« Firebase Storage URL - Sá»­a cÃº phÃ¡p dáº¥u pháº©y thÃ nh dáº¥u cháº¥m pháº©y
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      formulaValue: `=A1`, // XÃ³a áº£nh chá»¯ kÃ½ vÃ  sá»­ dá»¥ng reference trá»‘ng A1
                    },
                    userEnteredFormat: {
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                    },
                  },
                ],
              },
            ],
            fields: '*',
            start: {
              sheetId,
              rowIndex: signatureRow,
              columnIndex: buyerSignatureEndCol,
            },
          },
        });

        // ThÃªm ngÃ y thÃ¡ng tá»± Ä‘á»™ng vÃ o bÃ¡o giÃ¡ á»Ÿ Ã´ G2 vá»›i cÄƒn giá»¯a ngang vÃ  dá»c
        requests.push({
          updateCells: {
            rows: [
              {
                values: [
                  {
                    userEnteredValue: {
                      formulaValue: '=TODAY()',
                    },
                    userEnteredFormat: {
                      horizontalAlignment: 'CENTER',
                      verticalAlignment: 'MIDDLE',
                      numberFormat: { type: 'DATE', pattern: 'dd/MM/yyyy' },
                    },
                  },
                ],
              },
            ],
            fields: '*',
            start: { sheetId, rowIndex: 1, columnIndex: 6 }, // Cell G2
          },
        });

        // ThÃªm border cho Ã´ G2
        requests.push({
          updateBorders: {
            range: {
              sheetId,
              startRowIndex: 1,
              endRowIndex: 2,
              startColumnIndex: 6,
              endColumnIndex: 7,
            },
            top: { style: 'SOLID' },
            bottom: { style: 'SOLID' },
            left: { style: 'SOLID' },
            right: { style: 'SOLID' },
          },
        });

        // **FIX 2 & 4: Káº» báº£ng chÃ­nh xÃ¡c, loáº¡i bá» border thá»«a**
        // Instead of one global border, apply borders individually for each row
        // to correctly handle note rows (which should not have innerVertical borders)
        if (formattedData.materials.length > 0) {
          // First apply border to the header row
          requests.push({
            updateBorders: {
              range: {
                sheetId,
                startRowIndex: START_ROW_MATERIALS - 2, // Header row
                endRowIndex: START_ROW_MATERIALS - 1,
                startColumnIndex: 0,
                endColumnIndex: summaryEndColumn,
              },
              top: { style: 'SOLID' },
              bottom: { style: 'SOLID' },
              left: { style: 'SOLID' },
              right: { style: 'SOLID' },
              innerVertical: { style: 'SOLID' },
            },
          });

          // Then apply borders for each material row individually
          formattedData.materials.forEach((material, index) => {
            const rowStartIndex = START_ROW_MATERIALS - 1 + index;
            const rowEndIndex = rowStartIndex + 1;

            const nameIsNoteBorder = (material.name || '')
              .toUpperCase()
              .includes('GHI CHÃš');
            const startsWithPlusBorder = (material.name || '')
              .trim()
              .startsWith('+');
            const isNoteRow =
              material.isNote ||
              nameIsNoteBorder ||
              startsWithPlusBorder ||
              ((!material.unit || material.unit === '') &&
                (material.quantity === null ||
                  material.quantity === undefined ||
                  material.quantity === 0) &&
                (!material.material || material.material === ''));

            // æ‰©å±•ç‰¹æ®Šè¡Œåˆ¤æ–­æ¡ä»¶ï¼Œä¸Žä¸Šé¢çš„åˆå¹¶é€»è¾‘ä¿æŒä¸€è‡´
            const shouldMergeForBorder =
              isNoteRow ||
              (material.name && material.name.includes('-----')) ||
              (material.name &&
                material.name.toLowerCase().includes('tá»•ng phá»¥')) ||
              (material.name &&
                material.name.toLowerCase().includes('táº¡m tÃ­nh'));

            if (shouldMergeForBorder) {
              // For note rows, only apply outer borders (no inner vertical borders)
              requests.push({
                updateBorders: {
                  range: {
                    sheetId,
                    startRowIndex: rowStartIndex,
                    endRowIndex: rowEndIndex,
                    startColumnIndex: 0,
                    endColumnIndex: summaryEndColumn,
                  },
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                  // No innerVertical for note rows
                },
              });
            } else {
              // For regular rows, apply full borders including inner vertical lines
              requests.push({
                updateBorders: {
                  range: {
                    sheetId,
                    startRowIndex: rowStartIndex,
                    endRowIndex: rowEndIndex,
                    startColumnIndex: 0,
                    endColumnIndex: summaryEndColumn,
                  },
                  top: { style: 'SOLID' },
                  bottom: { style: 'SOLID' },
                  left: { style: 'SOLID' },
                  right: { style: 'SOLID' },
                  innerVertical: { style: 'SOLID' },
                },
              });
            }
          });
        }

        // Káº» báº£ng tá»•ng káº¿t
        requests.push({
          updateBorders: {
            range: {
              sheetId,
              startRowIndex: totalRow - 1,
              endRowIndex: notesRow,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
            top: { style: 'SOLID' },
            bottom: { style: 'SOLID' },
            left: { style: 'SOLID' },
            right: { style: 'SOLID' },
            innerHorizontal: { style: 'SOLID' },
          },
        });

        // Káº» báº£ng Ä‘iá»u khoáº£n
        requests.push({
          updateBorders: {
            range: {
              sheetId,
              startRowIndex: notesRow,
              endRowIndex: signatureRow - 1,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
            top: { style: 'SOLID' },
            bottom: { style: 'SOLID' },
            left: { style: 'SOLID' },
            right: { style: 'SOLID' },
          },
        });

        // Káº» báº£ng chá»¯ kÃ½ (quan trá»ng: khÃ´ng káº» innerVertical)
        requests.push({
          updateBorders: {
            range: {
              sheetId,
              startRowIndex: signatureRow - 1,
              endRowIndex: signatureRow + 5,
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
            top: { style: 'SOLID' },
            bottom: { style: 'SOLID' },
            left: { style: 'SOLID' },
            right: { style: 'SOLID' },
            innerHorizontal: { style: 'SOLID' },
          },
        });

        // XÃ³a ná»™i dung á»Ÿ cÃ¡c dÃ²ng phÃ­a dÆ°á»›i Ä‘á»ƒ trÃ¡nh hiá»ƒn thá»‹ vÄƒn báº£n dÆ° thá»«a tá»« template
        requests.push({
          updateCells: {
            range: {
              sheetId,
              startRowIndex: signatureRow + 6,
              endRowIndex: signatureRow + 20, // XÃ³a Ä‘áº¿n dÃ²ng +20 Ä‘á»ƒ Ä‘áº£m báº£o xÃ³a háº¿t
              startColumnIndex: 0,
              endColumnIndex: summaryEndColumn,
            },
            fields: 'userEnteredValue',
          },
        });

        // Gá»­i táº¥t cáº£ cÃ¡c request Ä‘á»‹nh dáº¡ng
        await sheets.spreadsheets.batchUpdate({
          spreadsheetId: newFileId,
          requestBody: { requests },
        });

        // Cáº¥p quyá»n vÃ  tráº£ vá» URL
        await drive.permissions.create({
          fileId: newFileId,
          requestBody: { role: 'reader', type: 'anyone' },
        });
        const fileResponse = await drive.files.get({
          fileId: newFileId,
          fields: 'webViewLink',
        });

        return {
          success: true,
          excelUrl: fileResponse.data.webViewLink,
          spreadsheetId: newFileId, // ThÃªm spreadsheetId vÃ o káº¿t quáº£ tráº£ vá»
        };
      } catch (error: any) {
        console.error(
          'Lá»—i khi táº¡o bÃ¡o giÃ¡:',
          error.response ? error.response.data.error : error.message
        );
        throw new functions.https.HttpsError(
          'internal',
          `Lá»—i khi táº¡o file trÃªn Google Drive: ${error.message}`
        );
      }
    }
  );

// HÃ m convertNumberToVnWords giá»¯ nguyÃªn
function convertNumberToVnWords(n: number): string {
  if (n === null || n === undefined) return '';
  const num = Math.floor(n);
  if (num === 0) return 'Báº±ng chá»¯: KhÃ´ng Ä‘á»“ng cháºµn.';
  const units = ['', ' nghÃ¬n', ' triá»‡u', ' tá»·', ' nghÃ¬n tá»·', ' triá»‡u tá»·'];
  const numbers = [
    'khÃ´ng',
    'má»™t',
    'hai',
    'ba',
    'bá»‘n',
    'nÄƒm',
    'sÃ¡u',
    'báº£y',
    'tÃ¡m',
    'chÃ­n',
  ];
  const convertGroup = (group: number): string => {
    let result = '';
    const tram = Math.floor(group / 100);
    const chuc = Math.floor((group % 100) / 10);
    const donvi = group % 10;
    if (tram > 0) {
      result += numbers[tram] + ' trÄƒm';
      if (chuc === 0 && donvi !== 0) result += ' linh';
    }
    if (chuc > 1) {
      result += (tram > 0 ? ' ' : '') + numbers[chuc] + ' mÆ°Æ¡i';
      if (donvi === 1) result += ' má»‘t';
    } else if (chuc === 1) {
      result += (tram > 0 ? ' ' : '') + 'mÆ°á»i';
    }
    if (donvi > 0 && chuc !== 1) {
      if (donvi === 5 && chuc > 0) {
        result += (result.length > 0 ? ' ' : '') + 'lÄƒm';
      } else if (donvi === 4 && chuc > 1) {
        result += (result.length > 0 ? ' ' : '') + 'tÆ°';
      } else {
        result += (result.length > 0 ? ' ' : '') + numbers[donvi];
      }
    } else if (donvi > 0 && chuc === 1) {
      if (donvi === 5) {
        result += ' lÄƒm';
      } else {
        result += ' ' + numbers[donvi];
      }
    }
    return result;
  };
  if (num === 0) return 'KhÃ´ng';
  let result = '';
  let i = 0;
  let tempNum = num;
  while (tempNum > 0) {
    let groupValue = tempNum % 1000;
    if (groupValue > 0) {
      let groupText = convertGroup(groupValue);
      result = groupText + units[i] + (result ? ' ' + result : '');
    }
    tempNum = Math.floor(tempNum / 1000);
    i++;
  }
  result = result.trim();
  return (
    'Báº±ng chá»¯: ' +
    result.charAt(0).toUpperCase() +
    result.slice(1) +
    ' Ä‘á»“ng cháºµn.'
  );
}


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\excelGenerator\templateGenerator.ts ---

import * as XLSX from 'xlsx';
import { ExcelQuotationData } from './types';

/**
 * Generates an Excel file based on the quotation data and template
 * @param {ExcelQuotationData} formattedData The formatted data for Excel
 * @returns {Buffer} The Excel file as a buffer
 */
export function generateExcelFile(formattedData: ExcelQuotationData): Buffer {
  // Create a new workbook and worksheet
  const workbook = XLSX.utils.book_new();
  const worksheet = XLSX.utils.aoa_to_sheet([]);

  // Set column widths
  const colWidths = [
    { wch: 5 }, // A
    { wch: 40 }, // B
    { wch: 10 }, // C
    { wch: 10 }, // D
    { wch: 15 }, // E
    { wch: 20 }, // F
    { wch: 20 }, // G
  ];
  worksheet['!cols'] = colWidths;

  // Add company header info (column E)
  addCompanyHeader(worksheet, formattedData);

  // Add quotation information (header and basic info)
  addQuotationHeader(worksheet, formattedData);

  // Add customer information
  addCustomerInfo(worksheet, formattedData);

  // Add materials table
  const materialEndRow = addMaterialsTable(worksheet, formattedData);

  // Add financial summary section
  const summaryEndRow = addFinancialSummary(
    worksheet,
    formattedData,
    materialEndRow
  );

  // Add terms and conditions
  addTermsAndConditions(worksheet, summaryEndRow);

  // Add the worksheet to the workbook
  XLSX.utils.book_append_sheet(workbook, worksheet, 'BÃ¡o giÃ¡');

  // Generate Excel file as buffer
  const excelBuffer = XLSX.write(workbook, {
    type: 'buffer',
    bookType: 'xlsx',
  });
  return excelBuffer;
}

/**
 * Add company header information to the worksheet
 */
function addCompanyHeader(
  worksheet: XLSX.WorkSheet,
  formattedData: ExcelQuotationData
): void {
  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['CÃ”NG TY TNHH Sáº¢N XUáº¤T CÆ  KHÃ THÆ¯Æ NG Máº I']],
    { origin: 'E1' }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['Dá»ŠCH Vá»¤ TÃ‚N HÃ’A PHÃT']], {
    origin: 'E2',
  });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['ÄC: Sá»‘ 7 Quá»‘c lá»™ 1A ,KP3B,PhÆ°á»ng Thanh Lá»™c,Quáº­n']],
    { origin: 'E3' }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['12,TP.HCM']], { origin: 'E4' });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['MST: 0315155409', 'Web:cokhitanhoaphat.com.vn']],
    { origin: 'E5' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Email :chomcauinoxtanhoaphat.com.vn']],
    { origin: 'E6' }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['Hotline 24/7: 0978.268.559']], {
    origin: 'E7',
  });
}

/**
 * Add quotation title and basic information
 */
function addQuotationHeader(
  worksheet: XLSX.WorkSheet,
  formattedData: ExcelQuotationData
): void {
  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Báº¢NG BÃO GIÃ KIá»‚M XÃC NHáº¬N Äáº¶T HÃ€NG']],
    { origin: 'B9' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['NgÃ y'], [formattedData.metadata.quotationDate]],
    { origin: 'F10' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Sá»'], [formattedData.metadata.quotationNumber]],
    { origin: 'F11' }
  );
}

/**
 * Add customer information section
 */
function addCustomerInfo(
  worksheet: XLSX.WorkSheet,
  formattedData: ExcelQuotationData
): void {
  XLSX.utils.sheet_add_aoa(worksheet, [['KÃNH Gá»¬I:']], { origin: 'B12' });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Äá»‹a chá»‰:', formattedData.metadata.customerAddress]],
    { origin: 'B13' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Tel', ':', '', '', 'MST', ':', '', 'FAX']],
    { origin: 'B14' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Email', ':', '', '', 'Attn', ':', '', 'Mobile:']],
    { origin: 'B15' }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [
      [
        'TrÆ°á»›c háº¿t CÃ´ng Ty TÃ¢n HÃ²a PhÃ¡t xin chÃ¢n thÃ nh cáº£m Æ¡n sá»± quan tÃ¢m & há»£p tÃ¡c cá»§a QuÃ½ KhÃ¡ch. ChÃºng tÃ´i xin gá»­i tá»›i QuÃ½ khÃ¡ch bÃ¡o giÃ¡ cÃ¡c chá»§ng loáº¡i sau:',
      ],
    ],
    { origin: 'B16' }
  );
}

/**
 * Add materials table to the worksheet
 * @returns The row number after the materials table
 */
function addMaterialsTable(
  worksheet: XLSX.WorkSheet,
  formattedData: ExcelQuotationData
): number {
  // Add table header for materials
  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['STT', 'TÃªn gá»i', 'Váº­t liá»‡u', 'ÄVT', 'SL', 'ÄÆ¡n giÃ¡', 'ThÃ nh Tiá»n']],
    { origin: 'B18' }
  );

  // Add material rows
  let currentRow = 19;
  formattedData.materials.forEach((item) => {
    XLSX.utils.sheet_add_aoa(
      worksheet,
      [
        [
          item.no,
          item.name,
          '',
          item.unit,
          item.quantity,
          item.unitPrice,
          item.total,
        ],
      ],
      { origin: `B${currentRow}` }
    );
    currentRow++;
  });

  return currentRow + 2; // Add 2 rows gap
}

/**
 * Add financial summary section
 * @returns The row number after the summary section
 */
function addFinancialSummary(
  worksheet: XLSX.WorkSheet,
  formattedData: ExcelQuotationData,
  startRow: number
): number {
  // Add summary section after materials
  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['', '', '', '', 'Tá»•ng cá»™ng:', '', formattedData.summary.subTotal]],
    { origin: `B${startRow}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [
      [
        '',
        '',
        '',
        '',
        `Chiáº¿t kháº¥u (${formattedData.summary.discountPercentage}%):`,
        '',
        formattedData.summary.discountAmount,
      ],
    ],
    { origin: `B${startRow + 1}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [
      [
        '',
        '',
        '',
        '',
        `Thuáº¿ VAT (${formattedData.summary.vatPercentage}%):`,
        '',
        formattedData.summary.vatAmount,
      ],
    ],
    { origin: `B${startRow + 2}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['', '', '', '', 'Tá»”NG Cá»˜NG:', '', formattedData.summary.grandTotal]],
    { origin: `B${startRow + 3}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Báº±ng chá»¯:', formattedData.summary.amountInWords]],
    { origin: `B${startRow + 5}` }
  );

  return startRow + 8; // Return row after summary section
}

/**
 * Add terms and conditions section
 */
function addTermsAndConditions(
  worksheet: XLSX.WorkSheet,
  startRow: number
): void {
  XLSX.utils.sheet_add_aoa(worksheet, [['Ghi chÃº:']], {
    origin: `B${startRow}`,
  });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [
      [
        '1. BÃ¡o giÃ¡ cÃ³ hiá»‡u lá»±c trong 7 ngÃ y. Háº¿t hiá»‡u lá»±c xin liÃªn há»‡ láº¡i cho CÃ´ng ty.',
      ],
    ],
    { origin: `C${startRow + 2}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['2. Thá»i gian giao hÃ ng: 3 ngÃ y ( khÃ´ng bao gá»“m chá»§ nháº­t, ngÃ y lá»… )']],
    { origin: `C${startRow + 3}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['3. GiÃ¡ Ä‘Ã£ bao gá»“m VAT vÃ  khÃ´ng bao gá»“m váº­n chuyá»ƒn']],
    { origin: `C${startRow + 4}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['4. Äá»‹a Ä‘iá»ƒm giao hÃ ng: kho bÃªn BÃ¡n']],
    { origin: `C${startRow + 5}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [
      [
        '5. PhÆ°Æ¡ng thá»©c thanh toÃ¡n: QuÃ½ KhÃ¡ch hÃ ng vui lÃ²ng thanh toÃ¡n báº±ng chuyá»ƒn khoáº£n Ä‘á»ƒ xuáº¥t hÃ³a Ä‘Æ¡n:',
      ],
    ],
    { origin: `C${startRow + 6}` }
  );

  XLSX.utils.sheet_add_aoa(worksheet, [['TÃ i khoáº£n sá»‘: 27888866']], {
    origin: `C${startRow + 7}`,
  });

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['TÃªn tÃ i khoáº£n: CÃ´ng ty TNHH SX cÆ¡ khÃ­ TM-DV TÃ¢n HÃ²a PhÃ¡t']],
    { origin: `C${startRow + 8}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['NgÃ¢n hÃ ng TMCP Ã ChÃ¢u - Chi nhÃ¡nh: Tam HÃ , Thá»§ Äá»©c']],
    { origin: `C${startRow + 9}` }
  );

  XLSX.utils.sheet_add_aoa(
    worksheet,
    [['Táº¡m á»©ng 50%, Thanh toÃ¡n 50% trÆ°á»›c khi nháº­n hÃ ng']],
    { origin: `C${startRow + 10}` }
  );
}


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\excelGenerator\types.ts ---

/**
 * Interface for Excel formatted quotation data
 */
export interface ExcelQuotationData {
  metadata: {
    companyName: string;
    companyAddress: string;
    companyPhone: string;
    companyEmail: string;
    taxCode: string;
    customerName: string;
    customerAddress: string;
    quotationNumber: string;
    quotationDate: string;
    projectName: string;
    quoteValidity: string;
  };
  materials: Array<{
    no: number;
    name: string;
    unit: string;
    quantity: number;
    unitPrice: number;
    total: number;
  }>;
  summary: {
    subTotal: number;
    discountPercentage: number;
    discountAmount: number;
    vatPercentage: number;
    vatAmount: number;
    grandTotal: number;
    amountInWords: string;
  };
}


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\types\workflow.ts ---

// types for dynamic workflow system
export interface ProcessTemplate {
  /** Readable Vietnamese name, e.g. "Cáº¯t Laser" */
  processName: string;
  /** Unique machine-readable key, e.g. "laser_cutting" */
  processKey: string;
  /** Optional high-level category, e.g. "Táº¡o phÃ´i" */
  category?: string;
}

export interface WorkflowStage {
  /** Firestore document id of the selected template */
  stageId: string;
  processKey: string;
  processName: string;
  /** Smaller number appears first */
  order: number;
  /** pending | in_progress | completed */
  status: 'pending' | 'in_progress' | 'completed';
  /** uid of the assigned employee (can be empty) */
  assignedToId?: string;
}


--- File: C:\Users\Admin\Downloads\thpapp\functions\src\utils\driveClient.ts ---

import { google } from 'googleapis';
import * as path from 'path';
import { SERVICE_ACCOUNT_KEY_PATH } from '../config';

/**
 * Returns an authenticated Google Drive client using the unified service account.
 */
export const getDriveClient = async () => {
  const auth = new google.auth.GoogleAuth({
    keyFile: path.join(__dirname, SERVICE_ACCOUNT_KEY_PATH),
    scopes: ['https://www.googleapis.com/auth/drive'],
  });
  return google.drive({ version: 'v3', auth });
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\attendanceService.js ---

// src/api/attendanceService.js

import {
  doc,
  getDoc,
  setDoc,
  updateDoc,
  serverTimestamp,
} from 'firebase/firestore';
import { db } from '../config/firebaseConfig';

/**
 * Utility to get YYYY-MM-DD formatted date string in local timezone.
 * @param {Date} [dateObj]
 */
const formatDate = (dateObj = new Date()) => {
  const year = dateObj.getFullYear();
  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
  const day = String(dateObj.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

/**
 * Build document reference for a user & date (defaults to today)
 */
const attendanceDocRef = (userId, dateStr = formatDate()) =>
  doc(db, 'attendance', `${userId}_${dateStr}`);

/**
 * Fetch today (or specific date) attendance for a user
 * @param {string} userId
 * @param {string} [dateStr] formatted YYYY-MM-DD
 */
export const getAttendance = async (userId, dateStr = formatDate()) => {
  const ref = attendanceDocRef(userId, dateStr);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    return { id: snap.id, ...snap.data() };
  }
  return null;
};

/**
 * Clock in: set clockIn timestamp if not already set.
 * Returns updated attendance document.
 */
export const clockIn = async (userId, timestamp = new Date()) => {
  const dateStr = formatDate(timestamp);
  const ref = attendanceDocRef(userId, dateStr);
  const data = {
    userId,
    date: dateStr,
    clockIn: timestamp,
    updatedAt: serverTimestamp(),
  };

  const existing = await getDoc(ref);
  if (existing.exists()) {
    // Only set clockIn if not yet recorded
    if (!existing.data().clockIn) {
      await updateDoc(ref, data);
    }
  } else {
    data.createdAt = serverTimestamp();
    await setDoc(ref, data);
  }
  return (await getDoc(ref)).data();
};

/**
 * Clock out: set clockOut timestamp.
 */
export const clockOut = async (userId, timestamp = new Date()) => {
  const dateStr = formatDate(timestamp);
  const ref = attendanceDocRef(userId, dateStr);
  const data = {
    clockOut: timestamp,
    updatedAt: serverTimestamp(),
  };
  const existing = await getDoc(ref);
  if (existing.exists()) {
    await updateDoc(ref, data);
  } else {
    // In case user forget to clock in, create new doc
    await setDoc(ref, {
      userId,
      date: dateStr,
      clockOut: timestamp,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    });
  }
  return (await getDoc(ref)).data();
};

/**
 * Add / update overtime hours (floating number of hours)
 */
export const addOvertime = async (userId, hours, timestamp = new Date()) => {
  const dateStr = formatDate(timestamp);
  const ref = attendanceDocRef(userId, dateStr);
  const existing = await getDoc(ref);
  if (existing.exists()) {
    await updateDoc(ref, {
      overtime: hours,
      updatedAt: serverTimestamp(),
    });
  } else {
    await setDoc(ref, {
      userId,
      date: dateStr,
      overtime: hours,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    });
  }
  return (await getDoc(ref)).data();
};

/**
 * Mark presence boolean for the day (mass attendance)
 */
export const setPresence = async (
  userId,
  present = true,
  timestamp = new Date()
) => {
  const dateStr = formatDate(timestamp);
  const ref = attendanceDocRef(userId, dateStr);
  const existing = await getDoc(ref);
  if (existing.exists()) {
    await updateDoc(ref, {
      present,
      updatedAt: serverTimestamp(),
    });
  } else {
    await setDoc(ref, {
      userId,
      date: dateStr,
      present,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    });
  }
  return (await getDoc(ref)).data();
};

/**
 * Utility to determine current status for UI
 * Returns: 'none' | 'clocked_in' | 'clocked_out'
 */
export const getAttendanceStatus = (attendanceDoc) => {
  if (!attendanceDoc) return 'none';
  if (attendanceDoc.clockIn && !attendanceDoc.clockOut) return 'clocked_in';
  if (attendanceDoc.clockIn && attendanceDoc.clockOut) return 'clocked_out';
  return 'none';
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\customerService.js ---

//src/api/customerService.js
import {
  collection,
  addDoc,
  updateDoc,
  deleteDoc,
  doc,
  query,
  orderBy,
  getDocs,
  getDoc,
  where,
  serverTimestamp,
} from 'firebase/firestore';
import { db } from '../config/firebaseConfig';

/**
 * Táº¡o khÃ¡ch hÃ ng má»›i
 * @param {Object} customerData - Dá»¯ liá»‡u khÃ¡ch hÃ ng
 * @param {string} userId - ID cá»§a ngÆ°á»i dÃ¹ng táº¡o khÃ¡ch hÃ ng
 * @returns {Promise<Object>} - KhÃ¡ch hÃ ng Ä‘Ã£ táº¡o kÃ¨m ID
 */
export const createCustomer = async (customerData, userId) => {
  try {
    const docRef = await addDoc(collection(db, 'customers'), {
      ...customerData,
      createdAt: serverTimestamp(),
      createdBy: userId,
      updatedAt: serverTimestamp(),
    });

    return {
      id: docRef.id,
      ...customerData,
    };
  } catch (error) {
    throw error;
  }
};

/**
 * Láº¥y táº¥t cáº£ khÃ¡ch hÃ ng
 * @returns {Promise<Array>} - Máº£ng khÃ¡ch hÃ ng
 */
export const getCustomers = async () => {
  try {
    const customersRef = collection(db, 'customers');
    const q = query(customersRef, orderBy('createdAt', 'desc'));
    const querySnapshot = await getDocs(q);

    return querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
  } catch (error) {
    throw error;
  }
};

/**
 * Láº¥y khÃ¡ch hÃ ng theo ID
 * @param {string} customerId - ID khÃ¡ch hÃ ng
 * @returns {Promise<Object|null>} - Dá»¯ liá»‡u khÃ¡ch hÃ ng hoáº·c null náº¿u khÃ´ng tÃ¬m tháº¥y
 */
export const getCustomerById = async (customerId) => {
  try {
    const customerRef = doc(db, 'customers', customerId);
    const customerSnapshot = await getDoc(customerRef);

    if (customerSnapshot.exists()) {
      return {
        id: customerSnapshot.id,
        ...customerSnapshot.data(),
      };
    } else {
      return null;
    }
  } catch (error) {
    throw error;
  }
};

/**
 * Cáº­p nháº­t thÃ´ng tin khÃ¡ch hÃ ng
 * @param {string} customerId - ID khÃ¡ch hÃ ng
 * @param {Object} customerData - Dá»¯ liá»‡u khÃ¡ch hÃ ng cáº­p nháº­t
 * @param {string} userId - ID cá»§a ngÆ°á»i dÃ¹ng cáº­p nháº­t khÃ¡ch hÃ ng
 * @returns {Promise<void>}
 */
export const updateCustomer = async (customerId, customerData, userId) => {
  try {
    const customerRef = doc(db, 'customers', customerId);
    await updateDoc(customerRef, {
      ...customerData,
      updatedAt: serverTimestamp(),
      updatedBy: userId,
    });
  } catch (error) {
    throw error;
  }
};

/**
 * XÃ³a khÃ¡ch hÃ ng
 * @param {string} customerId - ID khÃ¡ch hÃ ng
 * @returns {Promise<void>}
 */
export const deleteCustomer = async (customerId) => {
  try {
    const customerRef = doc(db, 'customers', customerId);
    await deleteDoc(customerRef);
  } catch (error) {
    throw error;
  }
};

/**
 * TÃ¬m kiáº¿m khÃ¡ch hÃ ng theo tÃªn hoáº·c ngÆ°á»i liÃªn há»‡
 * @param {string} searchTerm - Tá»« khÃ³a tÃ¬m kiáº¿m
 * @returns {Promise<Array>} - Máº£ng khÃ¡ch hÃ ng phÃ¹ há»£p
 */
export const searchCustomers = async (searchTerm) => {
  try {
    const customersRef = collection(db, 'customers');
    const nameQuery = query(
      customersRef,
      where('name', '>=', searchTerm),
      where('name', '<=', searchTerm + '\uf8ff')
    );
    const contactQuery = query(
      customersRef,
      where('contactPerson', '>=', searchTerm),
      where('contactPerson', '<=', searchTerm + '\uf8ff')
    );

    const [nameSnapshot, contactSnapshot] = await Promise.all([
      getDocs(nameQuery),
      getDocs(contactQuery),
    ]);

    // Káº¿t há»£p káº¿t quáº£ vÃ  loáº¡i bá» trÃ¹ng láº·p
    const results = new Map();

    nameSnapshot.docs.forEach((doc) => {
      results.set(doc.id, { id: doc.id, ...doc.data() });
    });

    contactSnapshot.docs.forEach((doc) => {
      if (!results.has(doc.id)) {
        results.set(doc.id, { id: doc.id, ...doc.data() });
      }
    });

    return Array.from(results.values());
  } catch (error) {
    throw error;
  }
};

/**
 * Láº¥y khÃ¡ch hÃ ng theo loáº¡i
 * @param {string} type - Loáº¡i khÃ¡ch hÃ ng (potential, regular, vip)
 * @returns {Promise<Array>} - Máº£ng khÃ¡ch hÃ ng thuá»™c loáº¡i Ä‘Ã£ chá»‰ Ä‘á»‹nh
 */
export const getCustomersByType = async (type) => {
  try {
    const customersRef = collection(db, 'customers');
    const q = query(
      customersRef,
      where('type', '==', type),
      orderBy('createdAt', 'desc')
    );

    const querySnapshot = await getDocs(q);

    return querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
  } catch (error) {
    throw error;
  }
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\googleDriveService.js ---

//src/api/googleDriveService.js
import axios from 'axios';
import * as XLSX from 'xlsx';
import * as FileSystem from 'expo-file-system';

/**
 * Láº¥y danh sÃ¡ch file tá»« Google Drive
 * @param {string} accessToken - Token xÃ¡c thá»±c Google
 * @param {string} folderId - ID thÆ° má»¥c cáº§n láº¥y (tÃ¹y chá»n)
 * @returns {Promise<Array>} - Máº£ng cÃ¡c file/thÆ° má»¥c
 */
export const listFiles = async (accessToken, folderId = null) => {
  try {
    let url = 'https://www.googleapis.com/drive/v3/files';
    let params = {
      fields: 'files(id, name, mimeType, modifiedTime, size)',
      orderBy: 'modifiedTime desc',
    };

    // Náº¿u cÃ³ folderId, lá»c theo thÆ° má»¥c
    if (folderId) {
      params.q = `'${folderId}' in parents and trashed = false`;
    } else {
      params.q = 'trashed = false';
    }

    const response = await axios.get(url, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      params,
    });

    return response.data.files;
  } catch (error) {
    console.error('Lá»—i khi láº¥y danh sÃ¡ch file tá»« Google Drive:', error);
    throw error;
  }
};

/**
 * TÃ¬m kiáº¿m file trÃªn Google Drive
 * @param {string} accessToken - Token xÃ¡c thá»±c Google
 * @param {string} query - Tá»« khÃ³a tÃ¬m kiáº¿m
 * @returns {Promise<Array>} - Máº£ng cÃ¡c file phÃ¹ há»£p
 */
export const searchFiles = async (accessToken, query) => {
  try {
    const url = 'https://www.googleapis.com/drive/v3/files';
    const params = {
      q: `name contains '${query}' and trashed = false`,
      fields: 'files(id, name, mimeType, modifiedTime, size)',
      orderBy: 'modifiedTime desc',
    };

    const response = await axios.get(url, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      params,
    });

    return response.data.files;
  } catch (error) {
    console.error('Lá»—i khi tÃ¬m kiáº¿m file trÃªn Google Drive:', error);
    throw error;
  }
};

/**
 * Táº£i ná»™i dung file tá»« Google Drive
 * @param {string} accessToken - Token xÃ¡c thá»±c Google
 * @param {string} fileId - ID cá»§a file cáº§n táº£i
 * @returns {Promise<Object>} - Dá»¯ liá»‡u file
 */
export const downloadFile = async (accessToken, fileId) => {
  try {
    // Äáº§u tiÃªn láº¥y thÃ´ng tin file Ä‘á»ƒ biáº¿t Ä‘á»‹nh dáº¡ng
    const fileInfoUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?fields=name,mimeType`;
    const fileInfoResponse = await axios.get(fileInfoUrl, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    });

    const { name, mimeType } = fileInfoResponse.data;

    // Táº£i ná»™i dung file
    const downloadUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
    const response = await axios.get(downloadUrl, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
      responseType: 'arraybuffer',
    });

    return {
      name,
      mimeType,
      data: response.data,
    };
  } catch (error) {
    console.error('Lá»—i khi táº£i file tá»« Google Drive:', error);
    throw error;
  }
};

/**
 * Táº£i lÃªn file lÃªn Google Drive
 * @param {string} accessToken - Token xÃ¡c thá»±c Google
 * @param {File|Blob} file - File cáº§n táº£i lÃªn
 * @param {string} folderId - ID thÆ° má»¥c Ä‘Ã­ch (tÃ¹y chá»n)
 * @returns {Promise<Object>} - ThÃ´ng tin file Ä‘Ã£ táº£i lÃªn
 */
export const uploadFile = async (accessToken, file, folderId = null) => {
  try {
    const metadata = {
      name: file.name,
      mimeType: file.type,
    };

    // Náº¿u cÃ³ folderId, Ä‘áº·t file vÃ o thÆ° má»¥c Ä‘Ã³
    if (folderId) {
      metadata.parents = [folderId];
    }

    // Táº¡o form data Ä‘á»ƒ táº£i lÃªn
    const form = new FormData();
    form.append(
      'metadata',
      new Blob([JSON.stringify(metadata)], { type: 'application/json' })
    );
    form.append('file', file);

    // Táº£i lÃªn file
    const response = await axios.post(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
      form,
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'multipart/form-data',
        },
      }
    );

    return response.data;
  } catch (error) {
    console.error('Lá»—i khi táº£i file lÃªn Google Drive:', error);
    throw error;
  }
};

/**
 * Äá»c ná»™i dung file Excel tá»« Google Drive
 * @param {string} accessToken - Token xÃ¡c thá»±c Google
 * @param {string} fileId - ID cá»§a file Excel
 * @returns {Promise<Object>} - Dá»¯ liá»‡u Ä‘Ã£ xá»­ lÃ½ tá»« file Excel
 */
export const readExcelFile = async (accessToken, fileId) => {
  try {
    // Táº£i file tá»« Google Drive
    const file = await downloadFile(accessToken, fileId);

    // Kiá»ƒm tra xem file cÃ³ pháº£i lÃ  Excel khÃ´ng
    const isExcel =
      file.mimeType.includes('spreadsheet') ||
      file.mimeType.includes('excel') ||
      file.name.endsWith('.xlsx') ||
      file.name.endsWith('.xls');

    if (!isExcel) {
      throw new Error('File khÃ´ng pháº£i lÃ  Excel');
    }

    // Xá»­ lÃ½ file Excel vá»›i thÆ° viá»‡n xlsx
    const data = new Uint8Array(file.data);
    const workbook = XLSX.read(data, { type: 'array' });

    // Láº¥y sheet Ä‘áº§u tiÃªn
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];

    // Chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u sang dáº¡ng JSON
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

    // Náº¿u cÃ³ nhiá»u sheet, láº¥y táº¥t cáº£
    const allSheets = {};
    workbook.SheetNames.forEach((sheetName) => {
      const sheet = workbook.Sheets[sheetName];
      allSheets[sheetName] = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    });

    return {
      fileName: file.name,
      firstSheet: jsonData,
      allSheets: allSheets,
      sheetNames: workbook.SheetNames,
    };
  } catch (error) {
    console.error('Lá»—i khi Ä‘á»c file Excel tá»« Google Drive:', error);
    throw error;
  }
};

/**
 * LÆ°u file Excel táº¡m thá»i vÃ o bá»™ nhá»› thiáº¿t bá»‹
 * @param {string} accessToken - Token xÃ¡c thá»±c Google
 * @param {string} fileId - ID cá»§a file Excel
 * @returns {Promise<string>} - ÄÆ°á»ng dáº«n Ä‘áº¿n file Ä‘Ã£ lÆ°u
 */
export const saveExcelFileLocally = async (accessToken, fileId) => {
  try {
    // Táº£i file tá»« Google Drive
    const file = await downloadFile(accessToken, fileId);

    // Táº¡o tÃªn file táº¡m thá»i
    const tempFilePath = `${FileSystem.cacheDirectory}${file.name}`;

    // Chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u thÃ nh base64 Ä‘á»ƒ lÆ°u vá»›i FileSystem
    const base64Data = Buffer.from(file.data).toString('base64');

    // LÆ°u file vÃ o bá»™ nhá»› táº¡m
    await FileSystem.writeAsStringAsync(tempFilePath, base64Data, {
      encoding: FileSystem.EncodingType.Base64,
    });

    return tempFilePath;
  } catch (error) {
    console.error('Lá»—i khi lÆ°u file Excel vÃ o bá»™ nhá»› táº¡m:', error);
    throw error;
  }
};

/**
 * Táº¡o thÆ° má»¥c má»›i trÃªn Google Drive
 * @param {string} accessToken - Token xÃ¡c thá»±c Google
 * @param {string} folderName - TÃªn thÆ° má»¥c
 * @param {string} parentFolderId - ID thÆ° má»¥c cha (tÃ¹y chá»n)
 * @returns {Promise<Object>} - ThÃ´ng tin thÆ° má»¥c Ä‘Ã£ táº¡o
 */
export const createFolder = async (
  accessToken,
  folderName,
  parentFolderId = null
) => {
  try {
    const metadata = {
      name: folderName,
      mimeType: 'application/vnd.google-apps.folder',
    };

    // Náº¿u cÃ³ parentFolderId, Ä‘áº·t thÆ° má»¥c vÃ o thÆ° má»¥c cha Ä‘Ã³
    if (parentFolderId) {
      metadata.parents = [parentFolderId];
    }

    const response = await axios.post(
      'https://www.googleapis.com/drive/v3/files',
      metadata,
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
        },
      }
    );

    return response.data;
  } catch (error) {
    console.error('Lá»—i khi táº¡o thÆ° má»¥c trÃªn Google Drive:', error);
    throw error;
  }
};

/**
 * Láº¥y file Excel má»›i nháº¥t tá»« thÆ° má»¥c cá»¥ thá»ƒ vÃ  xá»­ lÃ½ dá»¯ liá»‡u
 * @param {string} accessToken - Token xÃ¡c thá»±c Google
 * @param {string} folderId - ID thÆ° má»¥c cáº§n láº¥y
 * @returns {Promise<Object>} - Dá»¯ liá»‡u Ä‘Ã£ xá»­ lÃ½ tá»« file Excel má»›i nháº¥t
 */
export const getLatestExcelFromFolder = async (accessToken, folderId) => {
  try {
    // Láº¥y danh sÃ¡ch cÃ¡c file trong thÆ° má»¥c, sáº¯p xáº¿p theo thá»i gian sá»­a Ä‘á»•i má»›i nháº¥t
    const files = await listFiles(accessToken, folderId);

    // Lá»c chá»‰ láº¥y cÃ¡c file Excel
    const excelFiles = files.filter(
      (file) =>
        file.mimeType.includes('spreadsheet') ||
        file.mimeType.includes('excel') ||
        file.name.endsWith('.xlsx') ||
        file.name.endsWith('.xls')
    );

    if (excelFiles.length === 0) {
      throw new Error('KhÃ´ng tÃ¬m tháº¥y file Excel nÃ o trong thÆ° má»¥c');
    }

    // Láº¥y file má»›i nháº¥t (Ä‘Ã£ sáº¯p xáº¿p theo modifiedTime desc)
    const latestExcelFile = excelFiles[0];
    console.log('ÄÃ£ tÃ¬m tháº¥y file Excel má»›i nháº¥t:', latestExcelFile.name);

    // Äá»c vÃ  xá»­ lÃ½ file Excel
    const excelData = await readExcelFile(accessToken, latestExcelFile.id);

    return {
      fileInfo: latestExcelFile,
      data: excelData,
    };
  } catch (error) {
    console.error('Lá»—i khi láº¥y file Excel má»›i nháº¥t:', error);
    throw error;
  }
};

/**
 * PhÃ¢n tÃ­ch dá»¯ liá»‡u tá»« file Excel cÃ´ng ná»£
 * @param {Object} excelData - Dá»¯ liá»‡u Excel Ä‘Ã£ Ä‘á»c
 * @returns {Object} - Dá»¯ liá»‡u cÃ´ng ná»£ Ä‘Ã£ phÃ¢n tÃ­ch
 */
export const processDebtExcelData = (excelData) => {
  try {
    const sheets = excelData.allSheets;
    const result = {
      totalAccountsPayable: 0,
      totalAccountsReceivable: 0,
      top5Payable: [],
      top5Receivable: [],
      lastUpdated: new Date(),
    };

    // TÃ¬m sheet cÃ´ng ná»£ pháº£i tráº£
    const payableSheet = findSheetByName(sheets, [
      'Pháº£i Tráº£',
      'Phai Tra',
      'Accounts Payable',
      'CÃ´ng Ná»£ Pháº£i Tráº£',
    ]);
    if (payableSheet) {
      const payableData = processPayableSheet(payableSheet);
      result.totalAccountsPayable = payableData.total;
      result.top5Payable = payableData.top5;
    }

    // TÃ¬m sheet cÃ´ng ná»£ pháº£i thu
    const receivableSheet = findSheetByName(sheets, [
      'Pháº£i Thu',
      'Phai Thu',
      'Accounts Receivable',
      'CÃ´ng Ná»£ Pháº£i Thu',
    ]);
    if (receivableSheet) {
      const receivableData = processReceivableSheet(receivableSheet);
      result.totalAccountsReceivable = receivableData.total;
      result.top5Receivable = receivableData.top5;
    }

    // TÃ­nh vá»‹ tháº¿ cÃ´ng ná»£ rÃ²ng
    result.netDebtPosition =
      result.totalAccountsReceivable - result.totalAccountsPayable;

    // Äá»‹nh dáº¡ng sá»‘ tiá»n
    result.formattedTotals = {
      totalAccountsPayable: formatCurrency(result.totalAccountsPayable),
      totalAccountsReceivable: formatCurrency(result.totalAccountsReceivable),
      netDebtPosition: formatCurrency(result.netDebtPosition),
    };

    return result;
  } catch (error) {
    console.error('Lá»—i khi phÃ¢n tÃ­ch dá»¯ liá»‡u Excel cÃ´ng ná»£:', error);
    throw error;
  }
};

// HÃ m trá»£ giÃºp tÃ¬m sheet theo tÃªn
const findSheetByName = (sheets, possibleNames) => {
  for (const sheetName in sheets) {
    if (
      possibleNames.some((name) =>
        sheetName.toLowerCase().includes(name.toLowerCase())
      )
    ) {
      return sheets[sheetName];
    }
  }
  return null;
};

// Xá»­ lÃ½ sheet cÃ´ng ná»£ pháº£i tráº£
const processPayableSheet = (sheetData) => {
  // TÃ¬m cÃ¡c cá»™t chá»©a thÃ´ng tin nhÃ  cung cáº¥p vÃ  sá»‘ tiá»n
  const headerRow = sheetData.find((row) =>
    row.some(
      (cell) =>
        typeof cell === 'string' &&
        (cell.toLowerCase().includes('nhÃ  cung cáº¥p') ||
          cell.toLowerCase().includes('supplier') ||
          cell.toLowerCase().includes('tÃªn'))
    )
  );

  if (!headerRow) return { total: 0, top5: [] };

  const supplierColIndex = headerRow.findIndex(
    (cell) =>
      typeof cell === 'string' &&
      (cell.toLowerCase().includes('nhÃ  cung cáº¥p') ||
        cell.toLowerCase().includes('supplier') ||
        cell.toLowerCase().includes('tÃªn'))
  );

  const amountColIndex = headerRow.findIndex(
    (cell) =>
      typeof cell === 'string' &&
      (cell.toLowerCase().includes('sá»‘ tiá»n') ||
        cell.toLowerCase().includes('amount') ||
        cell.toLowerCase().includes('cÃ²n ná»£') ||
        cell.toLowerCase().includes('tá»•ng'))
  );

  if (supplierColIndex === -1 || amountColIndex === -1) {
    return { total: 0, top5: [] };
  }

  // Láº¥y dá»¯ liá»‡u tá»« cÃ¡c hÃ ng sau header
  const dataRows = sheetData.slice(sheetData.indexOf(headerRow) + 1);

  // Lá»c cÃ¡c hÃ ng cÃ³ dá»¯ liá»‡u há»£p lá»‡
  const validRows = dataRows.filter(
    (row) =>
      row[supplierColIndex] &&
      row[amountColIndex] &&
      !isNaN(parseFloat(row[amountColIndex]))
  );

  // TÃ­nh tá»•ng
  const total = validRows.reduce(
    (sum, row) => sum + parseFloat(row[amountColIndex]),
    0
  );

  // Sáº¯p xáº¿p theo sá»‘ tiá»n giáº£m dáº§n vÃ  láº¥y top 5
  const sortedRows = [...validRows].sort(
    (a, b) => parseFloat(b[amountColIndex]) - parseFloat(a[amountColIndex])
  );

  const top5 = sortedRows.slice(0, 5).map((row) => ({
    supplier: row[supplierColIndex].toString(),
    amount: parseFloat(row[amountColIndex]),
    amountInMillions: parseFloat(
      (parseFloat(row[amountColIndex]) / 1000000).toFixed(1)
    ),
  }));

  return { total, top5 };
};

// Xá»­ lÃ½ sheet cÃ´ng ná»£ pháº£i thu (tÆ°Æ¡ng tá»± nhÆ° pháº£i tráº£)
const processReceivableSheet = (sheetData) => {
  // TÃ¬m cÃ¡c cá»™t chá»©a thÃ´ng tin khÃ¡ch hÃ ng vÃ  sá»‘ tiá»n
  const headerRow = sheetData.find((row) =>
    row.some(
      (cell) =>
        typeof cell === 'string' &&
        (cell.toLowerCase().includes('khÃ¡ch hÃ ng') ||
          cell.toLowerCase().includes('customer') ||
          cell.toLowerCase().includes('tÃªn'))
    )
  );

  if (!headerRow) return { total: 0, top5: [] };

  const customerColIndex = headerRow.findIndex(
    (cell) =>
      typeof cell === 'string' &&
      (cell.toLowerCase().includes('khÃ¡ch hÃ ng') ||
        cell.toLowerCase().includes('customer') ||
        cell.toLowerCase().includes('tÃªn'))
  );

  const amountColIndex = headerRow.findIndex(
    (cell) =>
      typeof cell === 'string' &&
      (cell.toLowerCase().includes('sá»‘ tiá»n') ||
        cell.toLowerCase().includes('amount') ||
        cell.toLowerCase().includes('cÃ²n ná»£') ||
        cell.toLowerCase().includes('tá»•ng'))
  );

  if (customerColIndex === -1 || amountColIndex === -1) {
    return { total: 0, top5: [] };
  }

  // Láº¥y dá»¯ liá»‡u tá»« cÃ¡c hÃ ng sau header
  const dataRows = sheetData.slice(sheetData.indexOf(headerRow) + 1);

  // Lá»c cÃ¡c hÃ ng cÃ³ dá»¯ liá»‡u há»£p lá»‡
  const validRows = dataRows.filter(
    (row) =>
      row[customerColIndex] &&
      row[amountColIndex] &&
      !isNaN(parseFloat(row[amountColIndex]))
  );

  // TÃ­nh tá»•ng
  const total = validRows.reduce(
    (sum, row) => sum + parseFloat(row[amountColIndex]),
    0
  );

  // Sáº¯p xáº¿p theo sá»‘ tiá»n giáº£m dáº§n vÃ  láº¥y top 5
  const sortedRows = [...validRows].sort(
    (a, b) => parseFloat(b[amountColIndex]) - parseFloat(a[amountColIndex])
  );

  const top5 = sortedRows.slice(0, 5).map((row) => ({
    customer: row[customerColIndex].toString(),
    amount: parseFloat(row[amountColIndex]),
    amountInMillions: parseFloat(
      (parseFloat(row[amountColIndex]) / 1000000).toFixed(1)
    ),
  }));

  return { total, top5 };
};

// HÃ m Ä‘á»‹nh dáº¡ng tiá»n tá»‡
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
};

export default {
  listFiles,
  searchFiles,
  downloadFile,
  uploadFile,
  readExcelFile,
  saveExcelFileLocally,
  createFolder,
  getLatestExcelFromFolder,
  processDebtExcelData,
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\notificationService.js ---

// src/api/notificationService.js
import { db } from '../config/firebaseConfig';
import {
  collection,
  query,
  where,
  getDocs,
  orderBy,
  updateDoc,
  doc,
  limit,
} from 'firebase/firestore';

/**
 * Fetches notifications for a specific user, ordered by creation date.
 * @param {string} userId - The ID of the user.
 * @returns {Promise<Array>} A list of notifications.
 */
export const getUserNotifications = async (userId) => {
  if (!userId) return [];

  try {
    const q = query(
      collection(db, 'notifications'),
      where('userId', '==', userId),
      orderBy('createdAt', 'desc'),
      limit(30) // To avoid loading too many notifications at once
    );
    const snap = await getDocs(q);
    return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
  } catch (error) {
    console.error('Error fetching notifications:', error);
    return [];
  }
};

/**
 * Marks a specific notification as read.
 * @param {string} notificationId - The ID of the notification to update.
 * @returns {Promise<void>}
 */
export const markNotificationAsRead = async (notificationId) => {
  if (!notificationId) return;

  try {
    const ref = doc(db, 'notifications', notificationId);
    await updateDoc(ref, { read: true });
  } catch (error) {
    console.error('Error marking notification as read:', error);
  }
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\projectService.js ---

//src/api/projectService.js
import {
  collection,
  addDoc,
  updateDoc,
  deleteDoc,
  doc,
  query,
  orderBy,
  getDocs,
  getDoc,
  where,
  serverTimestamp,
  arrayUnion,
  runTransaction,
} from 'firebase/firestore';
import { db } from '../config/firebaseConfig';
import { getCustomerById } from './customerService'; // Import getCustomerById

/**
 * Láº¥y táº¥t cáº£ dá»± Ã¡n
 * @returns {Promise<Array>} - Máº£ng dá»± Ã¡n
 */
export const getProjects = async () => {
  try {
    const projectsRef = collection(db, 'projects');
    const q = query(projectsRef, orderBy('createdAt', 'desc'));
    const querySnapshot = await getDocs(q);

    // Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c denormalize, khÃ´ng cáº§n query thÃªm
    const projects = querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));

    return projects;
  } catch (error) {
    throw error;
  }
};

/**
 * Láº¥y dá»± Ã¡n theo ID kÃ¨m thÃ´ng tin khÃ¡ch hÃ ng
 * @param {string} projectId - ID dá»± Ã¡n
 * @returns {Promise<Object|null>} - Dá»¯ liá»‡u dá»± Ã¡n hoáº·c null náº¿u khÃ´ng tÃ¬m tháº¥y
 */
export const getProjectById = async (projectId) => {
  try {
    const projectRef = doc(db, 'projects', projectId);
    const projectSnapshot = await getDoc(projectRef);

    if (projectSnapshot.exists()) {
      const projectData = {
        id: projectSnapshot.id,
        ...projectSnapshot.data(),
      };

      // Náº¿u dá»± Ã¡n cÃ³ customerId, láº¥y thÃ´ng tin khÃ¡ch hÃ ng
      if (projectData.customerId) {
        try {
          const customerRef = doc(db, 'customers', projectData.customerId);
          const customerSnapshot = await getDoc(customerRef);

          if (customerSnapshot.exists()) {
            const customerData = customerSnapshot.data();
            // ThÃªm thÃ´ng tin khÃ¡ch hÃ ng vÃ o dá»± Ã¡n
            return {
              ...projectData,
              customerName: customerData.name || 'KhÃ´ng xÃ¡c Ä‘á»‹nh',
              customerContactPerson: customerData.contactPerson || '',
              customerEmail: customerData.email || '',
              customerPhone: customerData.phone || '',
              customerAddress: customerData.address || '',
              customerTaxCode: customerData.taxCode || '',
              customer: {
                id: projectData.customerId,
                ...customerData,
              },
            };
          }
        } catch (error) {
          console.error(
            `Lá»—i khi láº¥y thÃ´ng tin khÃ¡ch hÃ ng cho dá»± Ã¡n ${projectId}:`,
            error
          );
        }
      }

      // Tráº£ vá» dá»± Ã¡n gá»‘c náº¿u khÃ´ng cÃ³ customerId hoáº·c cÃ³ lá»—i
      return {
        ...projectData,
        customerName: 'KhÃ´ng xÃ¡c Ä‘á»‹nh',
        customerContactPerson: '',
        customerEmail: '',
        customerPhone: '',
        customerAddress: '',
        customerTaxCode: '',
      };
    } else {
      return null;
    }
  } catch (error) {
    throw error;
  }
};

/**
 * Táº¡o dá»± Ã¡n má»›i
 * @param {Object} projectData - Dá»¯ liá»‡u dá»± Ã¡n
 * @param {string} userId - ID cá»§a ngÆ°á»i dÃ¹ng táº¡o dá»± Ã¡n
 * @returns {Promise<Object>} - Dá»± Ã¡n Ä‘Ã£ táº¡o kÃ¨m ID
 */
export const createProject = async (projectData, userId) => {
  try {
    const projectToSave = { ...projectData };

    // Denormalization: Fetch and add customerName if customerId exists
    if (projectToSave.customerId) {
      const customer = await getCustomerById(projectToSave.customerId);
      if (customer) {
        projectToSave.customerName = customer.name;
      }
    }

    // Táº¡o cáº¥u trÃºc tasks máº·c Ä‘á»‹nh
    const defaultTasks = {
      quotation: { status: 'pending' },
      material_separation: { status: 'pending' },
      material_purchasing: {
        label: 'Mua váº­t tÆ° & phá»¥ kiá»‡n',
        status: 'pending',
      },
      material_cutting: { status: 'pending' },
      assembly: { status: 'pending' },
      painting: { status: 'pending' },
      shipping: { status: 'pending' },
      other: { name: '', status: 'pending' },
    };

    const docRef = await addDoc(collection(db, 'projects'), {
      ...projectToSave,
      tasks: defaultTasks, // ThÃªm cáº¥u trÃºc tasks máº·c Ä‘á»‹nh
      createdAt: serverTimestamp(),
      createdBy: userId,
      updatedAt: serverTimestamp(),
    });

    return {
      id: docRef.id,
      ...projectToSave,
      tasks: defaultTasks,
    };
  } catch (error) {
    throw error;
  }
};

/**
 * Cáº­p nháº­t thÃ´ng tin dá»± Ã¡n
 * @param {string} projectId - ID dá»± Ã¡n
 * @param {Object} projectData - Dá»¯ liá»‡u dá»± Ã¡n cáº­p nháº­t
 * @param {string} userId - ID cá»§a ngÆ°á»i dÃ¹ng cáº­p nháº­t dá»± Ã¡n
 * @returns {Promise<void>}
 */
export const updateProject = async (projectId, projectData, userId) => {
  try {
    const projectToUpdate = { ...projectData };

    // Denormalization: If customerId is being updated, also update customerName
    if (projectToUpdate.customerId) {
      const customer = await getCustomerById(projectToUpdate.customerId);
      if (customer) {
        projectToUpdate.customerName = customer.name;
      } else {
        projectToUpdate.customerName = 'KhÃ´ng xÃ¡c Ä‘á»‹nh'; // Handle case where customer might not be found
      }
    }

    const projectRef = doc(db, 'projects', projectId);
    await updateDoc(projectRef, {
      ...projectToUpdate,
      updatedAt: serverTimestamp(),
      updatedBy: userId,
    });
  } catch (error) {
    throw error;
  }
};

/**
 * XÃ³a dá»± Ã¡n
 * @param {string} projectId - ID dá»± Ã¡n
 * @returns {Promise<void>}
 */
export const deleteProject = async (projectId) => {
  try {
    const projectRef = doc(db, 'projects', projectId);
    await deleteDoc(projectRef);
  } catch (error) {
    console.error('Error deleting project:', error);
    throw new Error('KhÃ´ng thá»ƒ xÃ³a dá»± Ã¡n. Vui lÃ²ng thá»­ láº¡i.');
  }
};

/**
 * Láº¥y dá»± Ã¡n theo khÃ¡ch hÃ ng
 * @param {string} customerId - ID khÃ¡ch hÃ ng
 * @returns {Promise<Array>} - Máº£ng dá»± Ã¡n thuá»™c khÃ¡ch hÃ ng
 */
export const getProjectsByCustomer = async (customerId) => {
  try {
    const projectsRef = collection(db, 'projects');
    const q = query(
      projectsRef,
      where('customerId', '==', customerId),
      orderBy('createdAt', 'desc')
    );

    const querySnapshot = await getDocs(q);

    return querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
  } catch (error) {
    throw error;
  }
};

/**
 * Láº¥y dá»± Ã¡n theo tráº¡ng thÃ¡i
 * @param {string} status - Tráº¡ng thÃ¡i dá»± Ã¡n (pending, in-progress, completed, cancelled)
 * @returns {Promise<Array>} - Máº£ng dá»± Ã¡n thuá»™c tráº¡ng thÃ¡i Ä‘Ã£ chá»‰ Ä‘á»‹nh
 */
export const getProjectsByStatus = async (status) => {
  try {
    const projectsRef = collection(db, 'projects');
    const q = query(
      projectsRef,
      where('status', '==', status),
      orderBy('createdAt', 'desc')
    );

    const querySnapshot = await getDocs(q);

    return querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
  } catch (error) {
    throw error;
  }
};

/**
 * TÃ¬m kiáº¿m dá»± Ã¡n theo tÃªn
 * @param {string} searchTerm - Tá»« khÃ³a tÃ¬m kiáº¿m
 * @returns {Promise<Array>} - Máº£ng dá»± Ã¡n phÃ¹ há»£p
 */
export const searchProjects = async (searchTerm) => {
  try {
    const projectsRef = collection(db, 'projects');
    const nameQuery = query(
      projectsRef,
      where('name', '>=', searchTerm),
      where('name', '<=', searchTerm + '\uf8ff')
    );

    const querySnapshot = await getDocs(nameQuery);

    return querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
  } catch (error) {
    throw error;
  }
};

/**
 * Updates the status of a specific task within a project.
 * This is a targeted update to ensure it passes security rules for non-admin users.
 * @param {string} projectId The ID of the project to update.
 * @param {string} taskKey The key of the task to update (e.g., 'material_separation').
 * @param {string} newStatus The new status for the task.
 */
export const updateTaskStatus = async (projectId, taskKey, newStatus) => {
  if (!projectId || !taskKey || !newStatus) {
    throw new Error('Cáº§n cÃ³ ID dá»± Ã¡n, khÃ³a cÃ´ng viá»‡c vÃ  tráº¡ng thÃ¡i má»›i.');
  }
  try {
    const projectRef = doc(db, 'projects', projectId);
    // Construct the field path dynamically
    const fieldPath = `tasks.${taskKey}.status`;
    await updateDoc(projectRef, {
      [fieldPath]: newStatus,
    });
  } catch (error) {
    console.error('Error updating task status:', error);
    if (error.code === 'permission-denied') {
      throw new Error('Báº¡n khÃ´ng cÃ³ quyá»n cáº­p nháº­t tráº¡ng thÃ¡i cÃ´ng viá»‡c nÃ y.');
    }
    throw new Error(
      'KhÃ´ng thá»ƒ cáº­p nháº­t tráº¡ng thÃ¡i cÃ´ng viá»‡c. Vui lÃ²ng thá»­ láº¡i.'
    );
  }
};

/**
 * Cáº­p nháº­t tÃªn cÃ´ng viá»‡c "other"
 * @param {string} projectId - ID dá»± Ã¡n
 * @param {string} taskName - TÃªn cÃ´ng viá»‡c khÃ¡c
 * @param {string} userId - ID cá»§a ngÆ°á»i dÃ¹ng cáº­p nháº­t
 * @returns {Promise<void>}
 */
export const updateCustomTask = async (projectId, taskName, userId) => {
  try {
    const projectRef = doc(db, 'projects', projectId);
    const updatePath = `tasks.other.name`;

    await updateDoc(projectRef, {
      [updatePath]: taskName,
      updatedAt: serverTimestamp(),
      updatedBy: userId,
    });
  } catch (error) {
    throw error;
  }
};

/**
 * Updates the status of a specific workflow stage within a project.
 * This is a targeted update to ensure it passes security rules for non-admin users.
 * @param {string} projectId The ID of the project to update.
 * @param {string} stageId The ID of the stage to update.
 * @param {string} newStatus The new status for the stage.
 * @param {string} assignedToId The ID of the user assigned to the stage.
 */
export const updateWorkflowStageStatus = async (
  projectId,
  stageId,
  newStatus,
  assignedToId = null
) => {
  try {
    const projectRef = doc(db, 'projects', projectId);
    await updateDoc(projectRef, {
      workflowStages: arrayUnion(), // placeholder to trigger merge; we'll overwrite in transaction
    });
  } catch (e) {
    console.error('Direct update failed, fallback to transaction', e);
    await runTransaction(db, async (transaction) => {
      const ref = doc(db, 'projects', projectId);
      const snap = await transaction.get(ref);
      if (!snap.exists()) throw new Error('Project not found');
      const stages = snap.data().workflowStages || [];
      const idx = stages.findIndex((s) => s.stageId === stageId);
      if (idx === -1) throw new Error('Stage not found');
      stages[idx] = {
        ...stages[idx],
        status: newStatus,
        ...(assignedToId ? { assignedToId } : {}),
      };
      transaction.update(ref, { workflowStages: stages });
    });
  }
};

/**
 * Cáº­p nháº­t chi tiáº¿t (status, notes, files) cho má»™t cÃ´ng Ä‘oáº¡n cá»¥ thá»ƒ
 * @param {string} projectId
 * @param {string} stageId
 * @param {Object} data - {status?, notes?, files?}
 */
export const updateStageDetails = async (projectId, stageId, data) => {
  try {
    const projectRef = doc(db, 'projects', projectId);

    await runTransaction(db, async (tx) => {
      const snap = await tx.get(projectRef);
      if (!snap.exists()) throw new Error('Project not found');
      const project = snap.data();
      const stages = project.workflowStages || [];
      const idx = stages.findIndex((s) => s.stageId === stageId);
      if (idx === -1) throw new Error('Stage not found');

      stages[idx] = {
        ...stages[idx],
        ...data, // status, notes, files
      };

      tx.update(projectRef, {
        workflowStages: stages,
        updatedAt: serverTimestamp(),
      });
    });
  } catch (error) {
    console.error('Error updating stage details:', error);
    throw new Error('KhÃ´ng thá»ƒ cáº­p nháº­t chi tiáº¿t cÃ´ng Ä‘oáº¡n.');
  }
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\proposalService.js ---

// src/api/proposalService.js
import {
  collection,
  addDoc,
  getDocs,
  query,
  where,
  doc,
  updateDoc,
  serverTimestamp,
  orderBy,
  getDoc, // Add getDoc
} from 'firebase/firestore';
import { db } from '../config/firebaseConfig';

/**
 * Kiá»ƒm tra xem ngÆ°á»i dÃ¹ng cÃ³ quyá»n táº¡o Ä‘á» xuáº¥t khÃ´ng
 * @param {string} role - Role cá»§a ngÆ°á»i dÃ¹ng
 * @returns {boolean}
 */
export const canCreateProposal = (role) => {
  const allowedRoles = ['ky_su', 'pho_giam_doc', 'thuong_mai'];
  return allowedRoles.includes(role);
};

/**
 * Kiá»ƒm tra xem ngÆ°á»i dÃ¹ng cÃ³ quyá»n duyá»‡t Ä‘á» xuáº¥t khÃ´ng
 * @param {string} role - Role cá»§a ngÆ°á»i dÃ¹ng
 * @returns {boolean}
 */
export const canApproveProposal = (role) => {
  const allowedRoles = ['giam_doc', 'thuong_mai'];
  return allowedRoles.includes(role);
};

/**
 * Táº¡o phiáº¿u Ä‘á» xuáº¥t váº­t tÆ° má»›i
 * @param {Object} proposalData - {projectId, projectName, items:[], createdBy, proposalCode, requiredDate, priority, purpose, createdByName}
 * @returns {Promise<string>} id cá»§a phiáº¿u Ä‘Ã£ táº¡o
 */
export const createProposal = async (proposalData) => {
  const dataToSave = {
    ...proposalData,
    status: 'pending',
    createdAt: serverTimestamp(),
  };
  const docRef = await addDoc(collection(db, 'purchase_proposals'), dataToSave);
  return docRef.id;
};

/**
 * Láº¥y danh sÃ¡ch Ä‘á» xuáº¥t cá»§a 1 dá»± Ã¡n
 * @param {string} projectId
 */
export const getProposalsByProject = async (projectId) => {
  try {
    const q = query(
      collection(db, 'purchase_proposals'),
      where('projectId', '==', projectId),
      orderBy('createdAt', 'desc')
    );
    const snap = await getDocs(q);
    return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
  } catch (error) {
    // Náº¿u lá»—i do index chÆ°a tá»“n táº¡i, fallback khÃ´ng orderBy
    if (
      error.code === 'failed-precondition' ||
      (error.message && error.message.includes('index'))
    ) {
      console.warn(
        'Index missing, retrying getProposalsByProject without orderBy'
      );
      const q = query(
        collection(db, 'purchase_proposals'),
        where('projectId', '==', projectId)
      );
      const snap = await getDocs(q);
      return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
    }
    throw error;
  }
};

/**
 * Láº¥y danh sÃ¡ch Ä‘á» xuáº¥t theo tráº¡ng thÃ¡i
 * @param {string} status - 'pending', 'approved', 'rejected'
 */
export const getProposalsByStatus = async (status) => {
  try {
    // Thá»­ truy váº¥n vá»›i orderBy
    const q = query(
      collection(db, 'purchase_proposals'),
      where('status', '==', status),
      orderBy('createdAt', 'desc')
    );
    const snap = await getDocs(q);
    return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
  } catch (error) {
    // Náº¿u lá»—i do chÆ°a cÃ³ index, thá»­ truy váº¥n khÃ´ng cÃ³ orderBy
    if (
      error.code === 'failed-precondition' ||
      error.message.includes('index')
    ) {
      console.warn('Index error, trying without orderBy:', error.message);
      const q = query(
        collection(db, 'purchase_proposals'),
        where('status', '==', status)
      );
      const snap = await getDocs(q);
      return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
    } else {
      // Náº¿u lÃ  lá»—i khÃ¡c thÃ¬ throw
      throw error;
    }
  }
};

/**
 * Cáº­p nháº­t tráº¡ng thÃ¡i phiáº¿u (approved / rejected)
 * @param {string} proposalId
 * @param {'approved'|'rejected'} status
 * @param {string} approvedBy uid
 * @param {string} approvedByName tÃªn ngÆ°á»i duyá»‡t
 * @param {string} comment ghi chÃº khi duyá»‡t/tá»« chá»‘i
 */
export const updateProposalStatus = async (
  proposalId,
  status,
  approvedBy,
  approvedByName,
  comment = ''
) => {
  const proposalRef = doc(db, 'purchase_proposals', proposalId);
  await updateDoc(proposalRef, {
    status,
    approvedBy,
    approvedByName,
    approvedAt: serverTimestamp(),
    comment,
  });

  // Create a notification for the creator
  if (status === 'approved' || status === 'rejected') {
    try {
      const proposalSnap = await getDoc(proposalRef);
      if (proposalSnap.exists()) {
        const proposalData = proposalSnap.data();
        if (proposalData.createdBy && proposalData.createdBy !== approvedBy) {
          const notificationMessage =
            status === 'approved'
              ? `Äá» xuáº¥t "${
                  proposalData.proposalCode || 'KhÃ´ng cÃ³ mÃ£'
                }" Ä‘Ã£ Ä‘Æ°á»£c phÃª duyá»‡t.`
              : `Äá» xuáº¥t "${
                  proposalData.proposalCode || 'KhÃ´ng cÃ³ mÃ£'
                }" Ä‘Ã£ bá»‹ tá»« chá»‘i.`;

          const notificationData = {
            userId: proposalData.createdBy,
            message: notificationMessage,
            proposalId: proposalId,
            read: false,
            createdAt: serverTimestamp(),
            type:
              status === 'approved' ? 'PROPOSAL_APPROVED' : 'PROPOSAL_REJECTED',
            navLink: {
              screen: 'ProposalList',
            },
          };
          await addDoc(collection(db, 'notifications'), notificationData);
        }
      }
    } catch (error) {
      console.error('Failed to create notification:', error);
    }
  }
};

/**
 * Cáº­p nháº­t giÃ¡ váº­t tÆ° trong phiáº¿u Ä‘á» xuáº¥t
 * @param {string} proposalId - ID cá»§a phiáº¿u Ä‘á» xuáº¥t
 * @param {Array} materials - Máº£ng váº­t tÆ° vá»›i thÃ´ng tin giÃ¡ Ä‘Ã£ cáº­p nháº­t
 * @returns {Promise<void>}
 */
export const updateProposalMaterialPrices = async (proposalId, materials) => {
  const ref = doc(db, 'purchase_proposals', proposalId);

  // TÃ­nh tá»•ng giÃ¡ trá»‹ Ä‘Æ¡n hÃ ng
  let totalOrderValue = 0;
  materials.forEach((item) => {
    if (item.price && item.quantity) {
      const price = parseFloat(item.price);
      const quantity = parseFloat(item.quantity);
      if (!isNaN(price) && !isNaN(quantity)) {
        totalOrderValue += price * quantity;
      }
    }
  });

  await updateDoc(ref, {
    items: materials,
    hasPrices: true,
    totalValue: totalOrderValue,
    priceUpdatedAt: serverTimestamp(),
  });
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\purchaseOrderService.js ---

// src/api/purchaseOrderService.js
import {
  collection,
  addDoc,
  getDocs,
  query,
  where,
  orderBy,
  serverTimestamp,
} from 'firebase/firestore';
import { db } from '../config/firebaseConfig';
import { httpsCallable, getFunctions } from 'firebase/functions';

// Get Firebase Functions instance for asia-southeast1 region
const functionsInstance = getFunctions(undefined, 'asia-southeast1');

export const createPO = async (poData) => {
  const dataToSave = {
    ...poData,
    status: 'created',
    createdAt: serverTimestamp(),
  };
  const docRef = await addDoc(collection(db, 'purchase_orders'), dataToSave);
  return docRef.id;
};

export const getPOsByProject = async (projectId) => {
  const q = query(
    collection(db, 'purchase_orders'),
    where('projectId', '==', projectId),
    orderBy('createdAt', 'desc')
  );
  const snap = await getDocs(q);
  return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
};

export const getAllPOs = async () => {
  const snap = await getDocs(
    query(collection(db, 'purchase_orders'), orderBy('createdAt', 'desc'))
  );
  return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
};

/**
 * Saves PO receipt confirmation data to Firestore
 * This function assumes files have already been uploaded to Drive
 * @param {Object} params - Parameters
 * @param {string} params.poId - Purchase order ID
 * @param {string} params.projectId - Project ID
 * @param {Array} params.filesToSave - Array of file objects to save (with id, name, url)
 * @param {string} params.remarks - Optional remarks
 * @returns {Promise<Object>} - Result with success status
 */
export const savePOReceiptConfirmation = async ({
  poId,
  projectId,
  filesToSave,
  remarks = '',
}) => {
  const callable = httpsCallable(
    functionsInstance,
    'savePOReceiptConfirmation'
  );
  const res = await callable({ poId, projectId, filesToSave, remarks });
  return res.data;
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\quotationService.js ---

//src/api/quotationService.js
import {
  collection,
  addDoc,
  updateDoc,
  doc,
  getDoc,
  getDocs,
  query,
  where,
  orderBy,
  serverTimestamp,
} from 'firebase/firestore';
// import { getStorage, ref, uploadString, getDownloadURL } from 'firebase/storage';
import { db } from '../config/firebaseConfig';
// import * as FileSystem from 'expo-file-system';

/**
 * Save quotation metadata to Firestore.
 * The PDF is assumed to be already created and stored by a cloud function.
 * @param {string} projectId - Project ID
 * @param {Object} quotationData - All quotation data, including pdfUrl and createdBy
 * @returns {Promise<Object>} - Saved quotation data with Firestore document ID
 */
export const saveQuotation = async (projectId, quotationData) => {
  try {
    console.log(
      'Saving quotation metadata to Firestore for project:',
      projectId
    );

    // Destructure and validate required fields from quotationData
    const { pdfUrl, createdBy } = quotationData;

    if (!projectId) {
      throw new Error('ProjectId khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');
    }

    if (!pdfUrl) {
      throw new Error('PDF URL khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');
    }

    if (!createdBy) {
      throw new Error('UserId (createdBy) khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');
    }

    // 1. Save quotation data to Firestore
    const quotationRef = collection(db, `projects/${projectId}/quotations`);
    const docRef = await addDoc(quotationRef, {
      ...quotationData,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(), // Add updatedAt for consistency
    });

    console.log('Quotation metadata saved with ID:', docRef.id);

    // 2. Update project task status
    const projectRef = doc(db, 'projects', projectId);
    await updateDoc(projectRef, {
      'tasks.quotation.status': 'completed',
      'tasks.quotation.completedAt': serverTimestamp(),
      'tasks.quotation.completedBy': createdBy,
      updatedAt: serverTimestamp(),
      updatedBy: createdBy,
    });

    console.log('Project status updated.');

    return {
      id: docRef.id,
      ...quotationData,
    };
  } catch (error) {
    console.error('Error saving quotation metadata:', error);
    throw error;
  }
};

/**
 * Get all quotations for a specific project
 * @param {string} projectId - Project ID
 * @returns {Promise<Array>} - Array of quotations
 */
export const getQuotationsByProject = async (projectId) => {
  try {
    const quotationsRef = collection(db, `projects/${projectId}/quotations`);
    const q = query(quotationsRef, orderBy('createdAt', 'desc'));
    const querySnapshot = await getDocs(q);

    return querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
  } catch (error) {
    console.error('Error getting quotations:', error);
    throw error;
  }
};

/**
 * Get a specific quotation by ID
 * @param {string} projectId - Project ID
 * @param {string} quotationId - Quotation ID
 * @returns {Promise<Object|null>} - Quotation data or null if not found
 */
export const getQuotationById = async (projectId, quotationId) => {
  try {
    const quotationRef = doc(
      db,
      `projects/${projectId}/quotations`,
      quotationId
    );
    const quotationSnapshot = await getDoc(quotationRef);

    if (quotationSnapshot.exists()) {
      return {
        id: quotationSnapshot.id,
        ...quotationSnapshot.data(),
      };
    } else {
      return null;
    }
  } catch (error) {
    console.error('Error getting quotation by ID:', error);
    throw error;
  }
};


--- File: C:\Users\Admin\Downloads\thpapp\src\api\supplierService.js ---

// src/api/supplierService.js
import { db } from '../config/firebaseConfig';
import {
  collection,
  doc,
  getDoc,
  getDocs,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  where,
  serverTimestamp,
} from 'firebase/firestore';

// Láº¥y danh sÃ¡ch táº¥t cáº£ nhÃ  cung cáº¥p
export const getAllSuppliers = async () => {
  try {
    const suppliersRef = collection(db, 'suppliers');
    const q = query(suppliersRef, orderBy('name', 'asc'));
    const querySnapshot = await getDocs(q);

    return querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
  } catch (error) {
    console.error('Lá»—i khi láº¥y danh sÃ¡ch nhÃ  cung cáº¥p:', error);
    throw error;
  }
};

// Láº¥y thÃ´ng tin chi tiáº¿t cá»§a má»™t nhÃ  cung cáº¥p
export const getSupplierById = async (supplierId) => {
  try {
    const supplierRef = doc(db, 'suppliers', supplierId);
    const supplierDoc = await getDoc(supplierRef);

    if (supplierDoc.exists()) {
      return {
        id: supplierDoc.id,
        ...supplierDoc.data(),
      };
    } else {
      throw new Error('KhÃ´ng tÃ¬m tháº¥y nhÃ  cung cáº¥p');
    }
  } catch (error) {
    console.error('Lá»—i khi láº¥y thÃ´ng tin nhÃ  cung cáº¥p:', error);
    throw error;
  }
};

// ThÃªm nhÃ  cung cáº¥p má»›i
export const addSupplier = async (supplierData) => {
  try {
    const suppliersRef = collection(db, 'suppliers');

    // ThÃªm timestamp
    const supplierWithTimestamp = {
      ...supplierData,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    };

    const docRef = await addDoc(suppliersRef, supplierWithTimestamp);
    return {
      id: docRef.id,
      ...supplierWithTimestamp,
    };
  } catch (error) {
    console.error('Lá»—i khi thÃªm nhÃ  cung cáº¥p:', error);
    throw error;
  }
};

// Cáº­p nháº­t thÃ´ng tin nhÃ  cung cáº¥p
export const updateSupplier = async (supplierId, supplierData) => {
  try {
    const supplierRef = doc(db, 'suppliers', supplierId);

    // ThÃªm timestamp cáº­p nháº­t
    const updatedData = {
      ...supplierData,
      updatedAt: serverTimestamp(),
    };

    await updateDoc(supplierRef, updatedData);
    return {
      id: supplierId,
      ...updatedData,
    };
  } catch (error) {
    console.error('Lá»—i khi cáº­p nháº­t nhÃ  cung cáº¥p:', error);
    throw error;
  }
};

// XÃ³a nhÃ  cung cáº¥p
export const deleteSupplier = async (supplierId) => {
  try {
    const supplierRef = doc(db, 'suppliers', supplierId);
    await deleteDoc(supplierRef);
    return true;
  } catch (error) {
    console.error('Lá»—i khi xÃ³a nhÃ  cung cáº¥p:', error);
    throw error;
  }
};

// TÃ¬m kiáº¿m nhÃ  cung cáº¥p theo tÃªn
export const searchSuppliers = async (searchTerm) => {
  try {
    // LÆ°u Ã½: Firestore khÃ´ng há»— trá»£ tÃ¬m kiáº¿m full-text
    // ÄÃ¢y lÃ  cÃ¡ch Ä‘Æ¡n giáº£n Ä‘á»ƒ tÃ¬m kiáº¿m, cÃ³ thá»ƒ cáº§n cáº£i tiáº¿n sau
    const suppliersRef = collection(db, 'suppliers');
    const q = query(suppliersRef, orderBy('name'));
    const querySnapshot = await getDocs(q);

    const searchTermLower = searchTerm.toLowerCase();
    return querySnapshot.docs
      .map((doc) => ({ id: doc.id, ...doc.data() }))
      .filter(
        (supplier) =>
          supplier.name.toLowerCase().includes(searchTermLower) ||
          (supplier.contactName &&
            supplier.contactName.toLowerCase().includes(searchTermLower)) ||
          (supplier.phone && supplier.phone.includes(searchTerm))
      );
  } catch (error) {
    console.error('Lá»—i khi tÃ¬m kiáº¿m nhÃ  cung cáº¥p:', error);
    throw error;
  }
};

// Láº¥y danh sÃ¡ch nhÃ  cung cáº¥p theo danh má»¥c váº­t tÆ°
export const getSuppliersByCategory = async (category) => {
  try {
    const suppliersRef = collection(db, 'suppliers');
    const q = query(
      suppliersRef,
      where('categories', 'array-contains', category)
    );
    const querySnapshot = await getDocs(q);

    return querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
  } catch (error) {
    console.error('Lá»—i khi láº¥y nhÃ  cung cáº¥p theo danh má»¥c:', error);
    throw error;
  }
};

// ThÃªm Ä‘Ã¡nh giÃ¡ cho nhÃ  cung cáº¥p
export const addSupplierRating = async (supplierId, ratingData) => {
  try {
    const supplierRef = doc(db, 'suppliers', supplierId);
    const supplierDoc = await getDoc(supplierRef);

    if (!supplierDoc.exists()) {
      throw new Error('KhÃ´ng tÃ¬m tháº¥y nhÃ  cung cáº¥p');
    }

    const supplierData = supplierDoc.data();
    const ratings = supplierData.ratings || [];

    // ThÃªm Ä‘Ã¡nh giÃ¡ má»›i vá»›i timestamp
    const newRating = {
      ...ratingData,
      createdAt: serverTimestamp(),
    };

    ratings.push(newRating);

    // TÃ­nh láº¡i Ä‘iá»ƒm Ä‘Ã¡nh giÃ¡ trung bÃ¬nh
    const totalRating = ratings.reduce((sum, r) => sum + r.rating, 0);
    const averageRating = totalRating / ratings.length;

    await updateDoc(supplierRef, {
      ratings,
      averageRating,
      updatedAt: serverTimestamp(),
    });

    return {
      ratings,
      averageRating,
    };
  } catch (error) {
    console.error('Lá»—i khi thÃªm Ä‘Ã¡nh giÃ¡ nhÃ  cung cáº¥p:', error);
    throw error;
  }
};


--- File: C:\Users\Admin\Downloads\thpapp\src\components\ProcessPickerModal.js ---

import React, { useState, useEffect, useCallback } from 'react';
import {
  Modal,
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  ActivityIndicator,
  SectionList,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { collection, getDocs, addDoc } from 'firebase/firestore';
import { db } from '../config/firebaseConfig';

/**
 * ProcessPickerModal component
 * Props:
 *  - visible: boolean
 *  - onClose(): void  // close without saving
 *  - onConfirm(templates: ProcessTemplate[]): void // return chosen templates
 *  - existingStageKeys: string[] // list of process keys already in workflow
 */
const ProcessPickerModal = ({
  visible,
  onClose,
  onConfirm,
  existingStageKeys = [],
}) => {
  const [loading, setLoading] = useState(false);
  const [sections, setSections] = useState([]); // [{title, data: ProcessTemplate[]}]
  const [selectedIds, setSelectedIds] = useState(new Set());

  // Predefined templates to seed if collection is empty
  const DEFAULT_TEMPLATES = [
    // Táº¡o phÃ´i & Cáº¯t gá»t
    {
      processKey: 'laser_plasma_cut',
      processName: 'Cáº¯t Laser/Plasma',
      category: 'Táº¡o phÃ´i & Cáº¯t gá»t',
    },
    {
      processKey: 'oxy_gas_cut',
      processName: 'Cáº¯t Oxy-Gas',
      category: 'Táº¡o phÃ´i & Cáº¯t gá»t',
    },
    {
      processKey: 'saw_cut',
      processName: 'Cáº¯t báº±ng MÃ¡y cÆ°a',
      category: 'Táº¡o phÃ´i & Cáº¯t gá»t',
    },
    {
      processKey: 'punch',
      processName: 'Äá»™t / Dáº­p lá»—',
      category: 'Táº¡o phÃ´i & Cáº¯t gá»t',
    },
    {
      processKey: 'turning',
      processName: 'Tiá»‡n (Turning)',
      category: 'Táº¡o phÃ´i & Cáº¯t gá»t',
    },
    {
      processKey: 'milling',
      processName: 'Phay (Milling)',
      category: 'Táº¡o phÃ´i & Cáº¯t gá»t',
    },
    {
      processKey: 'drill_tap',
      processName: 'Khoan / Ta-rÃ´',
      category: 'Táº¡o phÃ´i & Cáº¯t gá»t',
    },
    // Biáº¿n dáº¡ng
    {
      processKey: 'bending',
      processName: 'Cháº¥n / Gáº¥p (Bending)',
      category: 'Biáº¿n dáº¡ng',
    },
    {
      processKey: 'rolling',
      processName: 'Lá»‘c / Uá»‘n TÃ´n (Rolling)',
      category: 'Biáº¿n dáº¡ng',
    },
    {
      processKey: 'pressing',
      processName: 'Dáº­p / Ã‰p (Pressing)',
      category: 'Biáº¿n dáº¡ng',
    },
    // Láº¯p rÃ¡p & HoÃ n thiá»‡n
    {
      processKey: 'fit_up',
      processName: 'Tá»• há»£p / GÃ¡ Ä‘áº·t (Fit-up)',
      category: 'Láº¯p rÃ¡p & HoÃ n thiá»‡n',
    },
    {
      processKey: 'welding',
      processName: 'HÃ n (Welding)',
      category: 'Láº¯p rÃ¡p & HoÃ n thiá»‡n',
    },
    {
      processKey: 'grinding',
      processName: 'MÃ i / Xá»­ lÃ½ bá» máº·t',
      category: 'Láº¯p rÃ¡p & HoÃ n thiá»‡n',
    },
    {
      processKey: 'sand_blasting',
      processName: 'Phun cÃ¡t / Phun bi',
      category: 'Láº¯p rÃ¡p & HoÃ n thiá»‡n',
    },
    {
      processKey: 'painting',
      processName: 'SÆ¡n (Painting)',
      category: 'Láº¯p rÃ¡p & HoÃ n thiá»‡n',
    },
    {
      processKey: 'inox_polish',
      processName: 'ÄÃ¡nh bÃ³ng Inox',
      category: 'Láº¯p rÃ¡p & HoÃ n thiá»‡n',
    },
    {
      processKey: 'qc_ndt',
      processName: 'Kiá»ƒm tra KCS / NDT',
      category: 'Láº¯p rÃ¡p & HoÃ n thiá»‡n',
    },
    {
      processKey: 'pack_ship',
      processName: 'ÄÃ³ng gÃ³i & Váº­n chuyá»ƒn',
      category: 'Láº¯p rÃ¡p & HoÃ n thiá»‡n',
    },
  ];

  const fetchTemplates = useCallback(async () => {
    try {
      setLoading(true);
      const snap = await getDocs(collection(db, 'process_templates'));
      const list = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

      // Auto-seed if empty
      if (list.length === 0) {
        await Promise.all(
          DEFAULT_TEMPLATES.map((tpl) =>
            addDoc(collection(db, 'process_templates'), tpl)
          )
        );
        // Re-fetch after seeding
        return fetchTemplates();
      }

      // Group by category
      const grouped = list.reduce((acc, tpl) => {
        const key = tpl.category || 'KhÃ¡c';
        if (!acc[key]) acc[key] = [];
        acc[key].push(tpl);
        return acc;
      }, {});
      const groupedSections = Object.keys(grouped).map((cat) => ({
        title: cat,
        data: grouped[cat],
      }));
      setSections(groupedSections);
    } catch (err) {
      console.error('Error loading process templates', err);
    } finally {
      setLoading(false);
    }
  }, []);

  // Fetch when opened
  useEffect(() => {
    if (visible) {
      fetchTemplates();
    } else {
      // reset selection when closing
      setSelectedIds(new Set());
    }
  }, [visible, fetchTemplates]);

  const toggleSelect = (template) => {
    const id = template.id;
    const disabled = existingStageKeys.includes(template.processKey);
    if (disabled) return; // ignore taps on already-added stages

    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);
      else next.add(id);
      return next;
    });
  };

  const handleConfirm = () => {
    // flatten all sections to find selected templates
    const allTemplates = sections.flatMap((s) => s.data);
    const selected = allTemplates.filter((tpl) => selectedIds.has(tpl.id));
    onConfirm(selected);
    onClose();
  };

  const renderItem = ({ item }) => {
    const disabled = existingStageKeys.includes(item.processKey);
    const selected = disabled || selectedIds.has(item.id);
    const iconColor = disabled ? '#bbb' : selected ? '#4CAF50' : '#999';

    return (
      <TouchableOpacity
        style={[styles.itemRow, disabled && styles.disabledRow]}
        activeOpacity={disabled ? 1 : 0.6}
        onPress={() => toggleSelect(item)}
      >
        <Text style={[styles.itemText, disabled && styles.disabledText]}>
          {item.processName}
        </Text>
        {selected ? (
          <Ionicons name="checkbox" size={22} color={iconColor} />
        ) : (
          <Ionicons name="square-outline" size={22} color={iconColor} />
        )}
      </TouchableOpacity>
    );
  };

  const renderSectionHeader = ({ section: { title } }) => (
    <View style={styles.sectionHeader}>
      <Text style={styles.sectionHeaderText}>{title}</Text>
    </View>
  );

  return (
    <Modal
      visible={visible}
      animationType="slide"
      transparent
      onRequestClose={onClose}
    >
      <View style={styles.overlay}>
        <View style={styles.container}>
          <Text style={styles.title}>Chá»n CÃ´ng Ä‘oáº¡n</Text>

          {loading ? (
            <View style={styles.loaderWrapper}>
              <ActivityIndicator size="large" color="#0066cc" />
            </View>
          ) : sections.length === 0 ||
            sections.every((s) => s.data.length === 0) ? (
            <View style={styles.emptyWrapper}>
              <Ionicons name="alert-circle-outline" size={40} color="#999" />
              <Text style={styles.emptyText}>ChÆ°a cÃ³ cÃ´ng Ä‘oáº¡n nÃ o.</Text>
            </View>
          ) : (
            <SectionList
              sections={sections}
              keyExtractor={(item) => item.id}
              renderItem={renderItem}
              renderSectionHeader={renderSectionHeader}
              stickySectionHeadersEnabled={false}
              contentContainerStyle={styles.listContent}
            />
          )}

          {/* Actions */}
          <View style={styles.actions}>
            <TouchableOpacity style={styles.cancelBtn} onPress={onClose}>
              <Text style={styles.btnText}>Há»§y</Text>
            </TouchableOpacity>
            <TouchableOpacity
              style={[
                styles.confirmBtn,
                { opacity: selectedIds.size ? 1 : 0.5 },
              ]}
              disabled={!selectedIds.size}
              onPress={handleConfirm}
            >
              <Text style={[styles.btnText, { color: '#fff' }]}>ThÃªm</Text>
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </Modal>
  );
};

const styles = StyleSheet.create({
  overlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.4)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  container: {
    width: '90%',
    maxHeight: '80%',
    backgroundColor: '#fff',
    borderRadius: 12,
    paddingHorizontal: 16,
    paddingBottom: 8,
    paddingTop: 12,
  },
  title: {
    fontSize: 18,
    fontWeight: 'bold',
    textAlign: 'center',
    marginBottom: 12,
  },
  sectionHeader: {
    backgroundColor: '#f1f1f1',
    paddingVertical: 6,
    paddingHorizontal: 8,
    borderRadius: 6,
    marginTop: 8,
  },
  sectionHeaderText: {
    fontSize: 14,
    fontWeight: '600',
    color: '#333',
  },
  itemRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 10,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  itemText: {
    fontSize: 16,
    color: '#333',
    flex: 1,
  },
  listContent: {
    paddingBottom: 8,
  },
  loaderWrapper: {
    paddingVertical: 20,
  },
  actions: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    marginTop: 12,
  },
  cancelBtn: {
    paddingVertical: 10,
    paddingHorizontal: 16,
    marginRight: 8,
  },
  confirmBtn: {
    backgroundColor: '#0066cc',
    paddingVertical: 10,
    paddingHorizontal: 16,
    borderRadius: 6,
  },
  btnText: {
    fontSize: 16,
  },
  emptyWrapper: {
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 20,
  },
  emptyText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
  },
  disabledRow: {
    backgroundColor: '#f4f4f4',
  },
  disabledText: {
    color: '#999',
  },
});

export default ProcessPickerModal;


--- File: C:\Users\Admin\Downloads\thpapp\src\components\StatusIndicator.js ---

//src/components/StatusIndicator.js
import React from 'react';
import { View, StyleSheet, Platform } from 'react-native';

/**
 * Component hiá»ƒn thá»‹ tráº¡ng thÃ¡i cÃ´ng viá»‡c dÆ°á»›i dáº¡ng hÃ¬nh trÃ²n cÃ³ mÃ u sáº¯c
 * @param {Object} props - Props cá»§a component
 * @param {string} props.status - Tráº¡ng thÃ¡i cÃ´ng viá»‡c (pending, in_progress, completed)
 * @param {number} props.size - KÃ­ch thÆ°á»›c cá»§a hÃ¬nh trÃ²n (máº·c Ä‘á»‹nh: 16)
 * @returns {React.Component} StatusIndicator component
 */
const StatusIndicator = ({ status, size = 16 }) => {
  // XÃ¡c Ä‘á»‹nh mÃ u sáº¯c dá»±a trÃªn tráº¡ng thÃ¡i
  const getStatusColor = () => {
    switch (status) {
      case 'completed':
        return '#4CAF50'; // Xanh lÃ¡
      case 'in_progress':
        return '#FFC107'; // VÃ ng
      case 'pending':
        return '#FF9800'; // Cam
      default:
        return '#9E9E9E'; // XÃ¡m
    }
  };

  return (
    <View
      style={[
        styles.indicator,
        {
          backgroundColor: getStatusColor(),
          width: size,
          height: size,
          borderRadius: size / 2,
        },
      ]}
    />
  );
};

const styles = StyleSheet.create({
  indicator: {
    // Äá»• bÃ³ng cho iOS
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.3,
    shadowRadius: 2,
    // Äá»• bÃ³ng cho Android
    elevation: 4,
    // CÃ¡c style khÃ¡c
    marginRight: 10,
    borderWidth: 1,
    borderColor: 'rgba(0,0,0,0.05)',
  },
});

export default StatusIndicator;


--- File: C:\Users\Admin\Downloads\thpapp\src\components\StyledTextInput.js ---

import React, { forwardRef } from 'react';
import { TextInput, StyleSheet, View, Text } from 'react-native';
import { Ionicons } from '@expo/vector-icons';

/**
 * Component TextInput tÃ¹y chá»‰nh vÃ  nháº¥t quÃ¡n cho toÃ n bá»™ á»©ng dá»¥ng
 * @param {Object} props - Props cá»§a component
 * @param {string} props.label - NhÃ£n cho trÆ°á»ng nháº­p liá»‡u
 * @param {string} props.iconName - TÃªn biá»ƒu tÆ°á»£ng Ionicons (tÃ¹y chá»n)
 * @param {string} props.error - ThÃ´ng bÃ¡o lá»—i (tÃ¹y chá»n)
 * @param {Object} props.containerStyle - Style cho container (tÃ¹y chá»n)
 * @param {Object} props.inputStyle - Style cho input (tÃ¹y chá»n)
 * @param {boolean} props.required - ÄÃ¡nh dáº¥u trÆ°á»ng báº¯t buá»™c (tÃ¹y chá»n)
 * @returns {React.Component} StyledTextInput component
 */
const StyledTextInput = forwardRef(
  (
    {
      label,
      iconName,
      error,
      containerStyle,
      inputStyle,
      required = false,
      ...props
    },
    ref
  ) => {
    return (
      <View style={[styles.container, containerStyle]}>
        {label && (
          <Text style={styles.label}>
            {label}
            {required && <Text style={styles.requiredMark}>*</Text>}
          </Text>
        )}

        <View
          style={[
            styles.inputContainer,
            error ? styles.inputContainerError : null,
          ]}
        >
          {iconName && (
            <Ionicons
              name={iconName}
              size={20}
              color="#666"
              style={styles.icon}
            />
          )}

          <TextInput
            ref={ref}
            style={[styles.input, inputStyle]}
            placeholderTextColor="#999"
            {...props}
          />

          {props.secureTextEntry !== undefined && (
            <View style={styles.rightIconContainer}>{props.rightIcon}</View>
          )}
        </View>

        {error && <Text style={styles.errorText}>{error}</Text>}
      </View>
    );
  }
);

const styles = StyleSheet.create({
  container: {
    marginBottom: 16,
  },
  label: {
    fontSize: 16,
    fontWeight: '500',
    color: '#333',
    marginBottom: 6,
  },
  requiredMark: {
    color: '#e74c3c',
    marginLeft: 4,
  },
  inputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    backgroundColor: '#f9f9f9',
    height: 50,
    paddingHorizontal: 12,
  },
  inputContainerError: {
    borderColor: '#e74c3c',
  },
  icon: {
    marginRight: 10,
  },
  input: {
    flex: 1,
    height: 50,
    fontSize: 16,
    color: '#333',
  },
  rightIconContainer: {
    paddingLeft: 8,
  },
  errorText: {
    color: '#e74c3c',
    fontSize: 12,
    marginTop: 4,
    marginLeft: 4,
  },
});

export default StyledTextInput;


--- File: C:\Users\Admin\Downloads\thpapp\src\components\SupplierPickerModal.js ---

import React, { useEffect, useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  Modal,
  TouchableOpacity,
  FlatList,
  ActivityIndicator,
  TextInput,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { getAllSuppliers } from '../api/supplierService';

const SupplierPickerModal = ({ visible, onClose, onSelect }) => {
  const [loading, setLoading] = useState(true);
  const [suppliers, setSuppliers] = useState([]);
  const [search, setSearch] = useState('');

  useEffect(() => {
    if (visible) {
      fetchSuppliers();
    }
  }, [visible]);

  const fetchSuppliers = async () => {
    setLoading(true);
    try {
      const data = await getAllSuppliers();
      setSuppliers(data);
    } catch (err) {
      console.error('Load suppliers error:', err);
    } finally {
      setLoading(false);
    }
  };

  const filtered = suppliers.filter((s) =>
    s.name.toLowerCase().includes(search.toLowerCase())
  );

  const renderItem = ({ item }) => (
    <TouchableOpacity
      style={styles.item}
      onPress={() => {
        onSelect(item);
        onClose();
      }}
    >
      <Text style={styles.name}>{item.name}</Text>
      {item.address ? <Text style={styles.sub}>{item.address}</Text> : null}
    </TouchableOpacity>
  );

  return (
    <Modal visible={visible} transparent animationType="slide">
      <View style={styles.overlay}>
        <View style={styles.container}>
          <View style={styles.header}>
            <Text style={styles.title}>Chá»n nhÃ  cung cáº¥p</Text>
            <TouchableOpacity onPress={onClose}>
              <Ionicons name="close" size={24} color="#333" />
            </TouchableOpacity>
          </View>

          <View style={styles.searchBar}>
            <Ionicons name="search" size={18} color="#666" />
            <TextInput
              style={styles.searchInput}
              placeholder="TÃ¬m kiáº¿m..."
              value={search}
              onChangeText={setSearch}
            />
          </View>

          {loading ? (
            <ActivityIndicator size="large" color="#0066cc" />
          ) : (
            <FlatList
              data={filtered}
              keyExtractor={(item) => item.id}
              renderItem={renderItem}
              ItemSeparatorComponent={() => <View style={styles.separator} />}
            />
          )}
        </View>
      </View>
    </Modal>
  );
};

const styles = StyleSheet.create({
  overlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.4)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  container: {
    width: '90%',
    maxHeight: '80%',
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 16,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  title: { fontSize: 18, fontWeight: 'bold', color: '#333' },
  searchBar: {
    flexDirection: 'row',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 6,
    paddingHorizontal: 8,
    marginBottom: 12,
  },
  searchInput: { flex: 1, paddingVertical: 6, marginLeft: 6 },
  item: { paddingVertical: 10 },
  name: { fontSize: 16, fontWeight: '500', color: '#333' },
  sub: { fontSize: 12, color: '#666', marginTop: 2 },
  separator: { height: 1, backgroundColor: '#eee' },
});

export default SupplierPickerModal;


--- File: C:\Users\Admin\Downloads\thpapp\src\components\TaskCard.js ---

import React, { useContext } from 'react';
import { View, Text, TouchableOpacity, StyleSheet } from 'react-native';
import { ThemeContext } from '../contexts/ThemeContext';

const TaskCard = ({ task, onPress }) => {
  const { theme } = useContext(ThemeContext);
  const styles = getStyles(theme);

  const getStatusColor = (status) => {
    switch (status) {
      case 'completed':
        return { bg: 'rgba(46, 204, 113, 0.2)', text: '#27AE60' };
      case 'in_progress':
        return { bg: 'rgba(52, 152, 219, 0.2)', text: '#2980B9' };
      case 'pending':
        return { bg: 'rgba(241, 196, 15, 0.2)', text: '#F39C12' };
      default:
        return { bg: theme.border, text: theme.textSecondary };
    }
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'completed':
        return 'HoÃ n thÃ nh';
      case 'in_progress':
        return 'Äang thá»±c hiá»‡n';
      case 'pending':
        return 'Chá» xá»­ lÃ½';
      default:
        return 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
    }
  };

  const statusStyle = getStatusColor(task.status);

  return (
    <TouchableOpacity style={styles.card} onPress={onPress}>
      <View style={styles.cardHeader}>
        <Text style={styles.taskLabel}>{task.taskLabel}</Text>
        <View style={[styles.statusBadge, { backgroundColor: statusStyle.bg }]}>
          <Text style={[styles.statusText, { color: statusStyle.text }]}>
            {getStatusLabel(task.status)}
          </Text>
        </View>
      </View>
      <View style={styles.cardBody}>
        <Text style={styles.projectName}>Dá»± Ã¡n: {task.projectName}</Text>
        <Text style={styles.assignedTo}>Phá»¥ trÃ¡ch: {task.assignedToName}</Text>
      </View>
    </TouchableOpacity>
  );
};

const getStyles = (theme) =>
  StyleSheet.create({
    card: {
      backgroundColor: theme.card,
      padding: 16,
      borderRadius: 12,
      marginVertical: 8,
      borderWidth: 1,
      borderColor: theme.border,
      elevation: 2,
      shadowColor: '#000',
      shadowOffset: { width: 0, height: 1 },
      shadowOpacity: 0.05,
      shadowRadius: 2,
    },
    cardHeader: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: 4,
    },
    taskLabel: {
      fontSize: 17,
      fontWeight: 'bold',
      color: theme.text,
      flex: 1, // Allow text to wrap if long
    },
    statusBadge: {
      paddingHorizontal: 10,
      paddingVertical: 4,
      borderRadius: 12,
      marginLeft: 8,
    },
    statusText: {
      fontSize: 12,
      fontWeight: '600',
    },
    cardBody: {
      marginTop: 8,
    },
    projectName: {
      fontSize: 14,
      color: theme.textSecondary,
      marginBottom: 4,
    },
    assignedTo: {
      fontSize: 14,
      color: theme.textSecondary,
    },
  });

export default TaskCard;


--- File: C:\Users\Admin\Downloads\thpapp\src\config\authConfig.js ---

//src/config/authConfig.js
// Cáº¥u hÃ¬nh xÃ¡c thá»±c cho cÃ¡c dá»‹ch vá»¥ bÃªn ngoÃ i
export const googleAuthConfig = {
  // Thay tháº¿ cÃ¡c giÃ¡ trá»‹ nÃ y báº±ng Client ID thá»±c táº¿ cá»§a báº¡n
  iosClientId:
    '370615243912-o6d5f9a9l5vbui1o1gcnd5t0lbkru9is.apps.googleusercontent.com',
  androidClientId:
    '370615243912-v7btvdq1e1b4min5snq7av9jpoe7lr10.apps.googleusercontent.com',
  webClientId:
    '370615243912-fesvpqtf06r7ugj31ma1urmrii85m7at.apps.googleusercontent.com',
  offlineAccess: true,

  // CÃ¡c scopes máº·c Ä‘á»‹nh cho Google Drive
  driveScopes: [
    'https://www.googleapis.com/auth/drive.readonly',
    'https://www.googleapis.com/auth/drive.metadata.readonly',
  ],

  // CÃ¡c scopes máº·c Ä‘á»‹nh cho Google Sheets
  sheetsScopes: [
    'https://www.googleapis.com/auth/drive.readonly',
    'https://www.googleapis.com/auth/spreadsheets.readonly',
  ],
};

// HÃ m helper Ä‘á»ƒ log chi tiáº¿t lá»—i Google API
export const logGoogleApiError = (error, context = '') => {
  console.error(`Google API Error ${context ? `(${context})` : ''}:`, error);

  // Log thÃ´ng tin chi tiáº¿t hÆ¡n náº¿u cÃ³
  if (error.response) {
    console.error('Error response:', {
      status: error.response.status,
      statusText: error.response.statusText,
      data: error.response.data,
    });
  }

  // Log thÃ´ng tin request náº¿u cÃ³
  if (error.config) {
    console.error('Request config:', {
      url: error.config.url,
      method: error.config.method,
      headers: error.config.headers,
      params: error.config.params,
    });
  }

  return error;
};


--- File: C:\Users\Admin\Downloads\thpapp\src\config\colors.js ---

//src/config/colors.js
export const lightTheme = {
  // MÃ u ná»n
  background: '#FFFFFF',
  backgroundSecondary: '#F8F8F8',
  card: '#FFFFFF',

  // MÃ u chá»¯
  text: '#333333',
  textSecondary: '#666666',
  textMuted: '#999999',

  // MÃ u thÆ°Æ¡ng hiá»‡u vÃ  hÃ nh Ä‘á»™ng
  primary: '#0066CC',
  primaryLight: '#E6F0FA',
  secondary: '#4CAF50',
  danger: '#E74C3C',
  warning: '#FF9800',
  info: '#2196F3',

  // MÃ u viá»n
  border: '#DDDDDD',
  borderLight: '#EEEEEE',

  // MÃ u tráº¡ng thÃ¡i
  statusCompleted: '#4CAF50',
  statusInProgress: '#2196F3',
  statusPending: '#FF9800',
  statusCancelled: '#F44336',

  // MÃ u input
  inputBackground: '#F9F9F9',
  inputBorder: '#DDDDDD',
  inputPlaceholder: '#999999',

  // MÃ u khÃ¡c
  divider: '#EEEEEE',
  shadow: '#000000',
  overlay: 'rgba(0, 0, 0, 0.5)',

  // Äá»™ trong suá»‘t
  opacity: {
    disabled: 0.5,
    hover: 0.8,
  },
};

export const darkTheme = {
  // MÃ u ná»n
  background: '#121212',
  backgroundSecondary: '#1E1E1E',
  card: '#242424',

  // MÃ u chá»¯
  text: '#FFFFFF',
  textSecondary: '#CCCCCC',
  textMuted: '#999999',

  // MÃ u thÆ°Æ¡ng hiá»‡u vÃ  hÃ nh Ä‘á»™ng
  primary: '#0B84FF',
  primaryLight: '#1C2A3A',
  secondary: '#4CAF50',
  danger: '#E74C3C',
  warning: '#FF9800',
  info: '#2196F3',

  // MÃ u viá»n
  border: '#444444',
  borderLight: '#333333',

  // MÃ u tráº¡ng thÃ¡i
  statusCompleted: '#4CAF50',
  statusInProgress: '#2196F3',
  statusPending: '#FF9800',
  statusCancelled: '#F44336',

  // MÃ u input
  inputBackground: '#333333',
  inputBorder: '#444444',
  inputPlaceholder: '#777777',

  // MÃ u khÃ¡c
  divider: '#333333',
  shadow: '#000000',
  overlay: 'rgba(0, 0, 0, 0.7)',

  // Äá»™ trong suá»‘t
  opacity: {
    disabled: 0.5,
    hover: 0.8,
  },
};


--- File: C:\Users\Admin\Downloads\thpapp\src\config\firebaseConfig.js ---

//src/config/firebaseConfig.js
// Import the required Firebase modules
import { initializeApp, getApps, getApp } from 'firebase/app';
import {
  initializeAuth,
  getReactNativePersistence,
  getAuth,
} from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';
import { getStorage } from 'firebase/storage';
import { getFunctions, connectFunctionsEmulator } from 'firebase/functions';
import AsyncStorage from '@react-native-async-storage/async-storage';

// Firebase configuration object
const firebaseConfig = {
  apiKey: 'AIzaSyBYQoTM8YwjL4cq1TdF7dFz5U6Ss-wxb3A',
  authDomain: 'tanyb-fe4bf.firebaseapp.com',
  projectId: 'tanyb-fe4bf',
  storageBucket: 'tanyb-fe4bf.appspot.com',
  messagingSenderId: '370615243912',
  appId: '1:370615243912:web:f070ed1f8a20f4baaf7b3d',
  measurementId: 'G-DY64DPJJVQ',
};

let app;
let auth;

// Singleton pattern to avoid re-initialization
if (getApps().length < 1) {
  app = initializeApp(firebaseConfig);
  auth = initializeAuth(app, {
    persistence: getReactNativePersistence(AsyncStorage),
  });
} else {
  app = getApp();
  auth = getAuth(app);
}

const db = getFirestore(app);
const storage = getStorage(app);
const functions = getFunctions(app, 'asia-southeast1');

// (TÃ¹y chá»n) Náº¿u báº¡n dÃ¹ng emulator Ä‘á»ƒ test local, hÃ£y bá» comment dÃ²ng dÆ°á»›i
// if (__DEV__) {
//   try {
//     connectFunctionsEmulator(functions, 'localhost', 5001);
//   } catch (e) {
//     console.warn('Functions emulator already connected?');
//   }
// }

console.log('Firebase services handled.');

// Export the initialized services
export { auth, db, storage, functions };
export default app;


--- File: C:\Users\Admin\Downloads\thpapp\src\contexts\AuthContext.js ---

//src/contexts/AuthContext.js
import React, {
  createContext,
  useContext,
  useState,
  useEffect,
  useCallback,
} from 'react';
import {
  onAuthStateChanged,
  signOut,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  updateProfile,
  sendPasswordResetEmail,
} from 'firebase/auth';
import { doc, getDoc, setDoc, serverTimestamp } from 'firebase/firestore';
import { auth, db } from '../config/firebaseConfig';
import { Alert } from 'react-native';
import NetInfo from '@react-native-community/netinfo';
import { GoogleSignin } from '@react-native-google-signin/google-signin';

// Táº¡o context cho xÃ¡c thá»±c
const AuthContext = createContext();

// Provider component Ä‘á»ƒ cung cáº¥p tráº¡ng thÃ¡i xÃ¡c thá»±c cho toÃ n bá»™ á»©ng dá»¥ng
export const AuthProvider = ({ children }) => {
  // CÃ¡c state cáº§n thiáº¿t
  const [currentUser, setCurrentUser] = useState(null);
  const [userRole, setUserRole] = useState(null);
  const [loadingAuth, setLoadingAuth] = useState(true);
  const [error, setError] = useState(null);
  const [connectionStatus, setConnectionStatus] = useState('connected');
  const [isOffline, setIsOffline] = useState(false);

  // Theo dÃµi tráº¡ng thÃ¡i káº¿t ná»‘i máº¡ng
  useEffect(() => {
    console.log('Setting up network listener...');
    const unsubscribeNetInfo = NetInfo.addEventListener((state) => {
      console.log(
        'Network status:',
        state.isConnected ? 'Connected' : 'Disconnected'
      );
      setIsOffline(!state.isConnected);
      setConnectionStatus(state.isConnected ? 'connected' : 'disconnected');
    });

    return () => {
      unsubscribeNetInfo();
    };
  }, []);

  // HÃ m láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng tá»« Firestore
  const fetchUserData = useCallback(async (userAuth) => {
    if (!userAuth) return null;

    const userRef = doc(db, 'users', userAuth.uid);
    try {
      console.log('Fetching user data for:', userAuth.uid);
      const docSnap = await getDoc(userRef);

      if (docSnap.exists()) {
        console.log('User data found:', docSnap.data());
        return { uid: userAuth.uid, email: userAuth.email, ...docSnap.data() };
      } else {
        console.log('User document not found! Creating new one.');
        const newUser = {
          uid: userAuth.uid,
          email: userAuth.email,
          role: 'user',
          createdAt: serverTimestamp(),
          displayName: userAuth.displayName || userAuth.email.split('@')[0],
          photoURL: userAuth.photoURL || '',
        };
        await setDoc(userRef, newUser);
        console.log('New user document created.');
        return newUser;
      }
    } catch (err) {
      console.error('Error fetching/creating user document:', err);
      // Fallback offline data
      return {
        uid: userAuth.uid,
        email: userAuth.email,
        displayName: userAuth.displayName || userAuth.email.split('@')[0],
        role: 'user',
        isOfflineData: true,
      };
    }
  }, []);

  // Láº¯ng nghe sá»± thay Ä‘á»•i tráº¡ng thÃ¡i xÃ¡c thá»±c
  useEffect(() => {
    console.log('Setting up auth state listener...');

    // Kiá»ƒm tra xem auth Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o chÆ°a
    if (!auth) {
      console.error('Auth instance is not initialized!');
      setLoadingAuth(false);
      setError('Authentication service is not available');
      return () => {};
    }

    const unsubscribe = onAuthStateChanged(auth, async (userAuth) => {
      console.log(
        'Auth state changed:',
        userAuth ? 'User logged in' : 'User logged out'
      );
      setLoadingAuth(true);

      try {
        if (userAuth) {
          const userData = await fetchUserData(userAuth);
          if (userData) {
            setCurrentUser(userData);
            setUserRole(userData.role || 'user');
          }
        } else {
          setCurrentUser(null);
          setUserRole(null);
        }
      } catch (err) {
        console.error('Error in auth state change:', err);
        setError('Authentication error occurred.');
      } finally {
        setLoadingAuth(false);
      }
    });

    return () => unsubscribe();
  }, [fetchUserData]);

  // HÃ m Ä‘Äƒng nháº­p
  const login = async (email, password) => {
    try {
      setLoadingAuth(true);
      setError(null);

      // Kiá»ƒm tra káº¿t ná»‘i máº¡ng
      const netInfo = await NetInfo.fetch();
      if (!netInfo.isConnected) {
        throw new Error('No internet connection');
      }

      await signInWithEmailAndPassword(auth, email, password);
      console.log('Login successful:', email);
      return true;
    } catch (error) {
      console.error('Login error:', error);
      let errorMessage = 'Login failed. Please check your credentials.';

      switch (error.code) {
        case 'auth/invalid-email':
          errorMessage = 'Invalid email address.';
          break;
        case 'auth/user-disabled':
          errorMessage = 'This account has been disabled.';
          break;
        case 'auth/user-not-found':
          errorMessage = 'No account found with this email.';
          break;
        case 'auth/wrong-password':
          errorMessage = 'Incorrect password.';
          break;
        case 'auth/too-many-requests':
          errorMessage = 'Too many failed attempts. Please try again later.';
          break;
        case 'auth/network-request-failed':
          errorMessage = 'Network error. Please check your connection.';
          break;
        default:
          if (
            error.message.includes('internet') ||
            error.message.includes('connection')
          ) {
            errorMessage = 'No internet connection. Please check your network.';
          }
          break;
      }

      setError(errorMessage);
      Alert.alert('Login Error', errorMessage);
      return false;
    } finally {
      setLoadingAuth(false);
    }
  };

  // HÃ m Ä‘Äƒng kÃ½
  const register = async (email, password, displayName) => {
    try {
      setLoadingAuth(true);
      setError(null);

      const userCredential = await createUserWithEmailAndPassword(
        auth,
        email,
        password
      );

      if (displayName) {
        await updateProfile(userCredential.user, { displayName });
      }

      await setDoc(doc(db, 'users', userCredential.user.uid), {
        email,
        displayName: displayName || email.split('@')[0],
        role: 'user',
        createdAt: serverTimestamp(),
        photoURL: '',
      });

      console.log('Registration successful:', email);
      return true;
    } catch (error) {
      console.error('Registration error:', error);
      let errorMessage = 'Registration failed. Please try again.';

      switch (error.code) {
        case 'auth/email-already-in-use':
          errorMessage = 'This email is already registered.';
          break;
        case 'auth/invalid-email':
          errorMessage = 'Invalid email address.';
          break;
        case 'auth/weak-password':
          errorMessage =
            'Password is too weak. Please choose a stronger password.';
          break;
        case 'auth/network-request-failed':
          errorMessage = 'Network error. Please check your connection.';
          break;
      }

      setError(errorMessage);
      Alert.alert('Registration Error', errorMessage);
      return false;
    } finally {
      setLoadingAuth(false);
    }
  };

  // HÃ m Ä‘Äƒng xuáº¥t
  const logout = async () => {
    try {
      // ÄÄƒng xuáº¥t khá»i Google Sign-In trÆ°á»›c
      if (await GoogleSignin.isSignedIn()) {
        await GoogleSignin.signOut();
        console.log('Google user signed out');
      }

      // Sau Ä‘Ã³ Ä‘Äƒng xuáº¥t khá»i Firebase
      await signOut(auth);

      // Cáº­p nháº­t state
      setCurrentUser(null);
      setUserRole(null);

      console.log('User logged out successfully from all services');
      return true;
    } catch (error) {
      console.error('Logout failed:', error);
      setError('Logout failed. Please try again.');
      Alert.alert('Error', 'Logout failed. Please try again.');
      return false;
    }
  };

  // HÃ m quÃªn máº­t kháº©u
  const resetPassword = async (email) => {
    try {
      setLoadingAuth(true);
      setError(null);
      await sendPasswordResetEmail(auth, email);
      Alert.alert(
        'Password Reset Email Sent',
        'Please check your inbox and follow the instructions to reset your password.'
      );
      return true;
    } catch (error) {
      console.error('Password reset error:', error);
      let errorMessage =
        'Could not send password reset email. Please try again.';

      switch (error.code) {
        case 'auth/invalid-email':
          errorMessage = 'Invalid email address.';
          break;
        case 'auth/user-not-found':
          errorMessage = 'No account found with this email.';
          break;
      }

      setError(errorMessage);
      Alert.alert('Password Reset Error', errorMessage);
      return false;
    } finally {
      setLoadingAuth(false);
    }
  };

  // GiÃ¡ trá»‹ context Ä‘á»ƒ cung cáº¥p cho toÃ n bá»™ á»©ng dá»¥ng
  const value = {
    currentUser,
    userRole,
    user: currentUser,
    loadingAuth,
    error,
    isSignedIn: !!currentUser,
    login,
    logout,
    register,
    resetPassword,
    connectionStatus,
    isOffline,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

// Custom hook Ä‘á»ƒ sá»­ dá»¥ng AuthContext
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

export default AuthContext;


--- File: C:\Users\Admin\Downloads\thpapp\src\contexts\ThemeContext.js ---

import React, { createContext, useState, useContext, useEffect } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useColorScheme } from 'react-native';
import { lightTheme, darkTheme } from '../config/colors';

// Táº¡o context cho theme
const ThemeContext = createContext();

// Hook Ä‘á»ƒ sá»­ dá»¥ng theme
export const useTheme = () => useContext(ThemeContext);

// Provider component
export const ThemeProvider = ({ children }) => {
  // Láº¥y theme há»‡ thá»‘ng
  const systemColorScheme = useColorScheme();

  // State Ä‘á»ƒ lÆ°u tráº¡ng thÃ¡i dark mode
  const [isDarkMode, setIsDarkMode] = useState(false);

  // State Ä‘á»ƒ lÆ°u tráº¡ng thÃ¡i theo dÃµi há»‡ thá»‘ng
  const [followSystem, setFollowSystem] = useState(true);

  // Láº¥y theme tá»« storage khi component mount
  useEffect(() => {
    const loadThemePreference = async () => {
      try {
        const storedIsDarkMode = await AsyncStorage.getItem('isDarkMode');
        const storedFollowSystem = await AsyncStorage.getItem('followSystem');

        if (storedFollowSystem !== null) {
          setFollowSystem(storedFollowSystem === 'true');
        }

        if (storedIsDarkMode !== null && !followSystem) {
          setIsDarkMode(storedIsDarkMode === 'true');
        } else if (followSystem) {
          setIsDarkMode(systemColorScheme === 'dark');
        }
      } catch (error) {
        console.log('Error loading theme preference:', error);
      }
    };

    loadThemePreference();
  }, [systemColorScheme]);

  // Cáº­p nháº­t theme khi systemColorScheme thay Ä‘á»•i vÃ  followSystem = true
  useEffect(() => {
    if (followSystem) {
      setIsDarkMode(systemColorScheme === 'dark');
    }
  }, [systemColorScheme, followSystem]);

  // HÃ m toggle dark mode
  const toggleTheme = async () => {
    try {
      const newValue = !isDarkMode;
      setIsDarkMode(newValue);
      await AsyncStorage.setItem('isDarkMode', String(newValue));

      // Khi ngÆ°á»i dÃ¹ng chá»§ Ä‘á»™ng thay Ä‘á»•i theme, táº¯t cháº¿ Ä‘á»™ theo dÃµi há»‡ thá»‘ng
      if (followSystem) {
        setFollowSystem(false);
        await AsyncStorage.setItem('followSystem', 'false');
      }
    } catch (error) {
      console.log('Error saving theme preference:', error);
    }
  };

  // HÃ m toggle cháº¿ Ä‘á»™ theo dÃµi há»‡ thá»‘ng
  const toggleFollowSystem = async () => {
    try {
      const newValue = !followSystem;
      setFollowSystem(newValue);
      await AsyncStorage.setItem('followSystem', String(newValue));

      // Náº¿u báº­t cháº¿ Ä‘á»™ theo dÃµi há»‡ thá»‘ng, cáº­p nháº­t theme theo há»‡ thá»‘ng
      if (newValue) {
        const systemIsDark = systemColorScheme === 'dark';
        setIsDarkMode(systemIsDark);
        await AsyncStorage.setItem('isDarkMode', String(systemIsDark));
      }
    } catch (error) {
      console.log('Error saving system preference:', error);
    }
  };

  // Láº¥y theme hiá»‡n táº¡i
  const theme = isDarkMode ? darkTheme : lightTheme;

  // GiÃ¡ trá»‹ Ä‘Æ°á»£c cung cáº¥p bá»Ÿi context
  const value = {
    isDarkMode,
    theme,
    toggleTheme,
    followSystem,
    toggleFollowSystem,
  };

  return (
    <ThemeContext.Provider value={value}>{children}</ThemeContext.Provider>
  );
};

export default ThemeContext;


--- File: C:\Users\Admin\Downloads\thpapp\src\hooks\useContractGenerator.js ---

import { useState } from 'react';
import { Share, Alert, Linking } from 'react-native';
import { getFunctions, httpsCallable } from 'firebase/functions';
import { GoogleSignin } from '@react-native-google-signin/google-signin';

/**
 * Custom hook for generating contract documents.
 * This hook now handles generating a Google Doc and sharing its URL.
 * @param {Object} options - Configuration options
 * @returns {Object} - Functions and state for contract generation
 */
const useContractGenerator = ({
  projectId,
  customerData,
  materials,
  quotationData,
}) => {
  const [isLoading, setIsLoading] = useState(false);
  const [contractDocUrl, setContractDocUrl] = useState(null);

  /**
   * Format contract data for the template.
   */
  const formatContractData = () => {
    // Get today's date components for the contract
    const today = new Date();
    const day = today.getDate().toString();
    const month = (today.getMonth() + 1).toString();

    // Prepare contract data
    const contractData = {
      // Basic info
      companyName: customerData?.companyName || customerData?.name || '',
      customerAddress: customerData?.address || '',
      companyPhone: customerData?.phoneNumber || customerData?.phone || '',
      taxCode: customerData?.taxCode || '',
      day,
      month,
      deliveryTime: quotationData?.deliveryTime || '',

      // Pass the original materials array
      materials: materials || [],
    };

    return contractData;
  };

  /**
   * Generate contract document
   */
  const generateContract = async () => {
    setIsLoading(true);
    setContractDocUrl(null); // Reset on new generation

    try {
      // Format contract data
      const contractData = formatContractData();

      // Get Google access token (auto refresh)
      const signedIn = await GoogleSignin.isSignedIn();
      if (!signedIn) {
        await GoogleSignin.signIn();
      }
      const { accessToken } = await GoogleSignin.getTokens();
      if (!accessToken) {
        throw new Error('KhÃ´ng thá»ƒ láº¥y Google access token');
      }

      // Call cloud function to generate contract
      const functions = getFunctions();
      const generateContractFunc = httpsCallable(functions, 'generateContract');

      const result = await generateContractFunc({
        contractData,
        fileName: `Hop_dong_${
          customerData?.companyName || customerData?.name || 'khach_hang'
        }_${new Date().getTime()}`,
        projectId,
        accessToken,
      });

      // The cloud function now returns docUrl and docId
      const { docUrl } = result.data;

      // Update state with the new Google Doc URL
      setContractDocUrl(docUrl);

      Alert.alert(
        'ThÃ nh cÃ´ng',
        'ÄÃ£ táº¡o há»£p Ä‘á»“ng Google Docs thÃ nh cÃ´ng. Báº¡n cÃ³ muá»‘n chia sáº» liÃªn káº¿t khÃ´ng?',
        [
          { text: 'Äá»ƒ sau', style: 'cancel' },
          { text: 'Chia sáº»', onPress: () => shareContractDoc(docUrl) },
        ]
      );

      return { docUrl };
    } catch (error) {
      console.error('Error generating contract:', error);
      Alert.alert(
        'Lá»—i',
        `KhÃ´ng thá»ƒ táº¡o há»£p Ä‘á»“ng: ${error.message || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh'}`
      );
      return null;
    } finally {
      setIsLoading(false);
    }
  };

  /**
   * Share the Google Doc contract URL.
   * @param {string} docUrl - The URL of the Google Doc to share.
   */
  const shareContractDoc = async (docUrl) => {
    const urlToShare = docUrl || contractDocUrl;
    if (!urlToShare) {
      Alert.alert('Lá»—i', 'ChÆ°a cÃ³ liÃªn káº¿t há»£p Ä‘á»“ng Ä‘á»ƒ chia sáº».');
      return;
    }

    try {
      // TrÆ°á»›c tiÃªn, thá»­ má»Ÿ Google Docs trá»±c tiáº¿p Ä‘á»ƒ táº­n dá»¥ng giao diá»‡n chia sáº» cÃ³ sáºµn cá»§a Google
      const canOpenDoc = await Linking.canOpenURL(urlToShare);

      if (canOpenDoc) {
        // Má»Ÿ trá»±c tiáº¿p Google Doc Ä‘á»ƒ ngÆ°á»i dÃ¹ng chia sáº» tá»« giao diá»‡n Google
        await Linking.openURL(urlToShare);
        return;
      }

      // Náº¿u khÃ´ng thá»ƒ má»Ÿ trá»±c tiáº¿p, thÃ¬ thá»±c hiá»‡n chia sáº» URL nhÆ° phÆ°Æ¡ng Ã¡n dá»± phÃ²ng
      await Share.share({
        message: `Vui lÃ²ng xem há»£p Ä‘á»“ng táº¡i Ä‘Ã¢y: ${urlToShare}`,
        url: urlToShare,
        title: 'Chia sáº» Há»£p Ä‘á»“ng',
      });
    } catch (error) {
      console.error('Error sharing contract doc:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ chia sáº» há»£p Ä‘á»“ng: ' + error.message);
    }
  };

  return {
    isLoading,
    contractDocUrl,
    generateContract,
    shareContractDoc,
  };
};

export default useContractGenerator;


--- File: C:\Users\Admin\Downloads\thpapp\src\hooks\useMaterialsProcessor.js ---

//src/hooks/useMaterialsProcessor.js
import { useState, useCallback } from 'react';
import { Alert } from 'react-native';
import {
  GoogleSignin,
  statusCodes,
} from '@react-native-google-signin/google-signin';
import { functions } from '../config/firebaseConfig'; // Import functions instance
import { httpsCallable } from 'firebase/functions'; // Import httpsCallable
import { getAuth } from 'firebase/auth'; // ThÃªm import getAuth

export const useMaterialsProcessor = (project) => {
  // State for materials data and table visibility
  const [materials, setMaterials] = useState([]);
  const [showMaterialsTable, setShowMaterialsTable] = useState(false);

  // State for Google Drive integration
  const [driveFiles, setDriveFiles] = useState([]);
  const [isPickerVisible, setIsPickerVisible] = useState(false);
  const [isLoadingFiles, setIsLoadingFiles] = useState(false);
  const [isGoogleDriveLoading, setIsGoogleDriveLoading] = useState(false);
  const [isProcessingFile, setIsProcessingFile] = useState(false); // State for processing

  const fetchGoogleDriveFiles = useCallback(async (token, folderId = null) => {
    setIsLoadingFiles(true);
    const baseUrl = 'https://www.googleapis.com/drive/v3/files';
    const params = new URLSearchParams();

    // Build query based on whether we have a specific folder ID or not
    let query =
      "mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' and trashed=false";
    if (folderId) {
      query = `'${folderId}' in parents and ${query}`;
    }

    params.append('q', query);
    params.append('orderBy', 'modifiedTime desc');
    params.append('fields', 'files(id, name, modifiedTime, iconLink)');
    const url = `${baseUrl}?${params.toString()}`;

    try {
      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!response.ok) {
        throw new Error(`Google Drive API error: ${response.status}`);
      }
      const json = await response.json();
      return json.files || [];
    } catch (error) {
      console.error('Error in fetchGoogleDriveFiles:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ láº¥y danh sÃ¡ch file tá»« Google Drive.');
      throw error;
    } finally {
      setIsLoadingFiles(false);
    }
  }, []);

  const handleFileSelect = useCallback(async (driveFile, fileName) => {
    setIsPickerVisible(false);
    setIsProcessingFile(true);
    Alert.alert(
      'Äang xá»­ lÃ½...',
      `Há»‡ thá»‘ng Ä‘ang xá»­ lÃ½ file "${fileName}". Vui lÃ²ng chá».`
    );

    try {
      // 1. Láº¥y accessToken tá»« GoogleSignin
      const tokens = await GoogleSignin.getTokens();
      const { accessToken } = tokens;

      if (!accessToken) {
        throw new Error(
          'KhÃ´ng thá»ƒ láº¥y Ä‘Æ°á»£c access token cá»§a Google. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.'
        );
      }

      // 2. Gá»i Cloud Function `importMaterialsFromDrive`
      const importMaterials = httpsCallable(
        functions,
        'importMaterialsFromDrive'
      );
      const result = await importMaterials({
        driveFileId: driveFile.id,
        accessToken,
      });

      // 3. Xá»­ lÃ½ káº¿t quáº£ tráº£ vá»
      const { materials: importedMaterials } = result.data;

      if (importedMaterials && importedMaterials.length > 0) {
        setMaterials(importedMaterials);
        setShowMaterialsTable(true);
        Alert.alert(
          'Nháº­p dá»¯ liá»‡u thÃ nh cÃ´ng',
          `ÄÃ£ nháº­p ${importedMaterials.length} dÃ²ng dá»¯ liá»‡u tá»« file "${fileName}".`
        );
      } else {
        Alert.alert(
          'KhÃ´ng cÃ³ dá»¯ liá»‡u',
          `KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u váº­t tÆ° há»£p lá»‡ trong file "${fileName}".`
        );
      }
    } catch (error) {
      console.error('Lá»—i khi gá»i importMaterialsFromDrive:', error);
      let errorMessage = error.message;
      if (error.code === 'functions/unauthenticated') {
        errorMessage =
          'XÃ¡c thá»±c tháº¥t báº¡i. Vui lÃ²ng Ä‘Äƒng xuáº¥t vÃ  Ä‘Äƒng nháº­p láº¡i.';
      } else if (error.code === 'functions/permission-denied') {
        errorMessage =
          'Token truy cáº­p Google Drive Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng thá»­ láº¡i.';
      }
      Alert.alert('Lá»—i xá»­ lÃ½ file', `Chi tiáº¿t: ${errorMessage}`);
    } finally {
      setIsProcessingFile(false);
    }
  }, []);

  const handleImportFromGoogleDrive = useCallback(async () => {
    setIsGoogleDriveLoading(true);
    try {
      const isSignedIn = await GoogleSignin.isSignedIn();
      if (!isSignedIn) {
        await GoogleSignin.signIn();
      }
      const tokens = await GoogleSignin.getTokens();
      const accessToken = tokens.accessToken;
      if (!accessToken) {
        throw new Error('KhÃ´ng thá»ƒ láº¥y Ä‘Æ°á»£c access token.');
      }

      // Check if we have project info with a Drive folder ID
      if (project && project.driveFolderId) {
        const files = await fetchGoogleDriveFiles(
          accessToken,
          project.driveFolderId
        );
        if (files && files.length > 0) {
          setDriveFiles(files);
          setIsPickerVisible(true);
        } else {
          Alert.alert(
            'KhÃ´ng tÃ¬m tháº¥y file',
            'KhÃ´ng tÃ¬m tháº¥y file Excel nÃ o trong thÆ° má»¥c dá»± Ã¡n nÃ y. HÃ£y táº£i file Excel vÃ o thÆ° má»¥c dá»± Ã¡n trÃªn Google Drive trÆ°á»›c.'
          );
        }
      } else {
        // Fallback to scanning all of Drive if no project folder ID
        Alert.alert(
          'ThÃ´ng bÃ¡o',
          'ThÆ° má»¥c Google Drive cho dá»± Ã¡n nÃ y chÆ°a Ä‘Æ°á»£c thiáº¿t láº­p. Há»‡ thá»‘ng sáº½ tÃ¬m trong toÃ n bá»™ Google Drive cá»§a báº¡n.'
        );
        const files = await fetchGoogleDriveFiles(accessToken);
        if (files && files.length > 0) {
          setDriveFiles(files);
          setIsPickerVisible(true);
        } else {
          Alert.alert(
            'KhÃ´ng tÃ¬m tháº¥y file',
            'KhÃ´ng tÃ¬m tháº¥y file Excel nÃ o trong Google Drive cá»§a báº¡n.'
          );
        }
      }
    } catch (error) {
      console.error('Lá»—i khi thao tÃ¡c vá»›i Google Drive:', error);
      if (error.code !== statusCodes.SIGN_IN_CANCELLED) {
        Alert.alert('Lá»—i', 'ÄÃ£ xáº£y ra lá»—i khi káº¿t ná»‘i vá»›i Google Drive.');
      }
    } finally {
      setIsGoogleDriveLoading(false);
    }
  }, [fetchGoogleDriveFiles, project]);

  const handlePriceChange = useCallback((text, index) => {
    // Sá»­ dá»¥ng callback form cá»§a setState Ä‘á»ƒ Ä‘áº£m báº£o truy cáº­p vÃ o state má»›i nháº¥t
    setMaterials((currentMaterials) => {
      const newMaterials = JSON.parse(JSON.stringify(currentMaterials));
      const item = newMaterials[index];
      const price = parseFloat(text) || 0;
      item.unitPrice = price;

      // Calculate total price based on whether weight exists
      const quantity = parseFloat(item.quantity || 0);
      const weight = parseFloat(item.weight || 0);

      if (weight > 0) {
        // If weight exists: totalPrice = quantity * weight * unitPrice
        item.totalPrice = quantity * weight * price;
      } else {
        // If no weight: totalPrice = quantity * unitPrice (for items with unit "bá»™")
        item.totalPrice = quantity * price;
      }

      return newMaterials;
    });
  }, []); // Dependency rá»—ng vÃ¬ chÃºng ta dÃ¹ng callback form cá»§a setState

  const handleRequote = useCallback((quotation) => {
    if (quotation.materials && Array.isArray(quotation.materials)) {
      setMaterials(JSON.parse(JSON.stringify(quotation.materials)));
      setShowMaterialsTable(true);
      Alert.alert(
        'Táº£i thÃ nh cÃ´ng',
        `ÄÃ£ táº£i láº¡i dá»¯ liá»‡u tá»« bÃ¡o giÃ¡ ${quotation.quotationNumber}.`
      );
    } else {
      Alert.alert('Lá»—i', 'BÃ¡o giÃ¡ nÃ y khÃ´ng chá»©a dá»¯ liá»‡u váº­t tÆ° Ä‘á»ƒ táº£i láº¡i.');
    }
  }, []);

  // Process material data from Excel
  const processMaterialData = useCallback((rawData) => {
    if (!rawData || !Array.isArray(rawData)) {
      console.log('No materials data');
      return;
    }

    const processed = rawData.map((item) => {
      // Check if the item is a note
      if (item.isNote) {
        return {
          ...item,
          selected: false, // Add selected property for consistent handling
        };
      }

      // Extract essential data
      const quantity = parseFloat(item.quantity) || 0;
      const weight = parseFloat(item.weight || 0);
      const unitPrice = parseFloat(item.unitPrice || 0);

      // Calculate total price based on quantity, weight and unit price
      let totalPrice = 0;
      if (weight > 0) {
        totalPrice = quantity * weight * unitPrice;
      } else {
        totalPrice = quantity * unitPrice;
      }

      return {
        name: item.name || '',
        material: item.material || '',
        quyCach: item.quyCach || '',
        unit: item.unit || '',
        quantity,
        weight,
        unitPrice,
        totalPrice,
        selected: false, // Add selected property
        isNote: false, // Explicitly mark as not a note
      };
    });

    setMaterials(processed);
    setShowMaterialsTable(true);
  }, []);

  return {
    materials,
    setMaterials, // Export setMaterials
    showMaterialsTable,
    driveFiles,
    isPickerVisible,
    isLoadingFiles,
    isGoogleDriveLoading,
    isProcessingFile,
    handleImportFromGoogleDrive,
    handleFileSelect,
    handlePriceChange,
    handleRequote,
    setIsPickerVisible,
  };
};


--- File: C:\Users\Admin\Downloads\thpapp\src\hooks\usePOReceipt.js ---

import { useState } from 'react';
import { Alert } from 'react-native';
import { savePOReceiptConfirmation } from '../api/purchaseOrderService';
import { httpsCallable } from 'firebase/functions';
import { functions } from '../config/firebaseConfig';
import { GoogleSignin } from '@react-native-google-signin/google-signin';
import uuid from 'react-native-uuid';

const usePOReceipt = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [uploadProgress, setUploadProgress] = useState(0);

  // Upload a single file to Drive
  const uploadFile = async (projectId, file) => {
    try {
      console.log(
        `[POReceipt] Starting upload for file: ${file.fileName || 'unnamed'}`
      );

      // Láº¥y accessToken Google cá»§a ngÆ°á»i dÃ¹ng
      console.log('[POReceipt] Getting Google access token');
      const tokens = await GoogleSignin.getTokens();
      const accessToken = tokens.accessToken;

      if (!accessToken) {
        console.error('[POReceipt] No access token available');
        throw new Error(
          'PhiÃªn Ä‘Äƒng nháº­p Google Ä‘Ã£ háº¿t. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.'
        );
      }
      console.log('[POReceipt] Got access token successfully');

      // Generate a unique filename
      const ext = (file.fileName || 'jpg').split('.').pop();
      const uniqueFileName = `PO_${uuid.v4()}.${ext}`;
      console.log(`[POReceipt] Generated filename: ${uniqueFileName}`);

      // Call the uploadFileToDrive Cloud Function
      console.log('[POReceipt] Calling uploadFileToDriveUser cloud function');
      const uploadFn = httpsCallable(functions, 'uploadFileToDriveUser');
      const result = await uploadFn({
        accessToken,
        projectId,
        fileName: uniqueFileName,
        mimeType: file.mimeType,
        base64Data: file.base64Data,
      });

      console.log(
        '[POReceipt] Cloud function response:',
        JSON.stringify(result.data)
      );

      if (!result.data.success) {
        console.error('[POReceipt] Upload failed:', result.data.message);
        throw new Error(result.data.message || 'Lá»—i táº£i file lÃªn server');
      }

      console.log(
        `[POReceipt] File uploaded successfully. FileID: ${result.data.fileId}, Link: ${result.data.webViewLink}`
      );
      return result.data;
    } catch (err) {
      console.error('[POReceipt] File upload error:', err);
      // Log detailed error information
      if (err.details) {
        console.error(
          '[POReceipt] Error details:',
          JSON.stringify(err.details)
        );
      }
      if (err.code) {
        console.error('[POReceipt] Error code:', err.code);
      }
      console.error('File upload error in hook:', err);
      // NÃ©m lá»—i ra ngoÃ i Ä‘á»ƒ hÃ m confirmReceipt cÃ³ thá»ƒ báº¯t Ä‘Æ°á»£c
      throw err;
    }
  };

  // Main function to handle the entire PO receipt confirmation process
  const confirmReceipt = async ({ poId, projectId, files, remarks }) => {
    setLoading(true);
    setError(null);
    setUploadProgress(0);

    try {
      console.log(
        `[POReceipt] Starting confirmation process for PO: ${poId}, Project: ${projectId}`
      );
      console.log(`[POReceipt] Files to upload: ${files.length}`);

      // Step 1: Upload each file one by one
      const totalFiles = files.length;
      const uploadedFilesInfo = [];

      for (let i = 0; i < totalFiles; i++) {
        const fileToUpload = files[i];
        console.log(
          `Uploading file ${i + 1}/${totalFiles}:`,
          fileToUpload.fileName
        );
        const uploadResult = await uploadFile(projectId, fileToUpload);

        uploadedFilesInfo.push({
          id: uploadResult.fileId,
          name: uploadResult.fileName || fileToUpload.fileName,
          url: uploadResult.webViewLink,
          mimeType: uploadResult.mimeType,
          preview: uploadResult.thumbnailLink,
        });

        // Update progress
        setUploadProgress(((i + 1) / totalFiles) * 100);
      }

      // Step 2: Save the PO receipt confirmation data to Firestore
      console.log('All files uploaded. Saving confirmation to Firestore...');
      console.log(`[POReceipt] Files uploaded: ${uploadedFilesInfo.length}`);
      console.log(
        `[POReceipt] File details:`,
        JSON.stringify(uploadedFilesInfo)
      );

      await savePOReceiptConfirmation({
        poId,
        projectId,
        filesToSave: uploadedFilesInfo,
        remarks,
      });

      console.log(`[POReceipt] PO receipt confirmation saved successfully`);
      setLoading(false);
      setUploadProgress(0);
      return { success: true };
    } catch (err) {
      console.error('Confirm receipt process failed:', err);
      console.error('[POReceipt] Error stack:', err.stack);
      const errorMessage =
        err.details?.message || err.message || 'KhÃ´ng thá»ƒ xÃ¡c nháº­n PO.';
      setError(errorMessage);
      Alert.alert('Lá»—i', errorMessage);
      setLoading(false);
      setUploadProgress(0);
      // KhÃ´ng cáº§n throw err ná»¯a vÃ¬ Ä‘Ã£ xá»­ lÃ½ á»Ÿ Ä‘Ã¢y
    }
  };

  return { confirmReceipt, loading, error, uploadProgress };
};

export default usePOReceipt;


--- File: C:\Users\Admin\Downloads\thpapp\src\hooks\useProjectDetails.js ---

//src/hooks/useProjectDetails.js
import { useState, useEffect, useCallback } from 'react';
import { useFocusEffect } from '@react-navigation/native';
import { getProjectById } from '../api/projectService';

export const useProjectDetails = (projectId) => {
  const [project, setProject] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const fetchProjectData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const data = await getProjectById(projectId);

      if (data) {
        setProject(data);
      } else {
        setError('KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin dá»± Ã¡n');
      }
    } catch (err) {
      console.error('Lá»—i khi táº£i thÃ´ng tin dá»± Ã¡n:', err);
      setError('KhÃ´ng thá»ƒ táº£i thÃ´ng tin dá»± Ã¡n. Vui lÃ²ng thá»­ láº¡i sau.');
    } finally {
      setLoading(false);
    }
  }, [projectId]);

  // Initial fetch when the component mounts
  useEffect(() => {
    if (projectId) {
      fetchProjectData();
    }
  }, [fetchProjectData, projectId]);

  // Re-fetch when the screen comes into focus
  useFocusEffect(
    useCallback(() => {
      if (projectId) {
        fetchProjectData();
      }
    }, [fetchProjectData, projectId])
  );

  return { project, loading, error, fetchProjectData };
};


--- File: C:\Users\Admin\Downloads\thpapp\src\hooks\usePurchaseOrderGenerator.js ---

// src/hooks/usePurchaseOrderGenerator.js
import { useState, useContext } from 'react';
import { httpsCallable, getFunctions } from 'firebase/functions';
import { Alert, Linking } from 'react-native';
import AuthContext from '../contexts/AuthContext';
import { GoogleSignin } from '@react-native-google-signin/google-signin';

const usePurchaseOrderGenerator = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const { currentUser } = useContext(AuthContext);

  /**
   * Generate a Purchase Order Excel file for a project
   *
   * @param {Object} poData - The purchase order data
   * @param {string} projectId - The ID of the project
   * @returns {Promise<Object>} - The response object with file URL
   */
  const generatePurchaseOrder = async (poData, projectId) => {
    setLoading(true);
    setError(null);

    try {
      // Ensure Google user is signed in and get accessToken
      const signedIn = await GoogleSignin.isSignedIn();
      if (!signedIn) {
        console.log('Google user not signed in, attempting to sign in...');
        await GoogleSignin.signIn();
      }

      console.log('Getting Google access token...');
      const { accessToken } = await GoogleSignin.getTokens();
      if (!accessToken) {
        throw new Error('Could not get Google access token.');
      }
      console.log('Access token obtained successfully');

      const formattedData = formatPOData(poData);
      console.log('Formatted PO data:', JSON.stringify(formattedData));

      const functions = getFunctions(undefined, 'asia-southeast1');
      const generateExcelPurchaseOrder = httpsCallable(
        functions,
        'generateExcelPurchaseOrder'
      );

      console.log('Calling Firebase function with projectId:', projectId);
      const result = await generateExcelPurchaseOrder({
        formattedData,
        projectId,
        accessToken, // Pass the Google OAuth token
      });

      console.log('Firebase function result:', JSON.stringify(result.data));

      if (result.data && result.data.success) {
        if (result.data.fileUrl) {
          await Linking.openURL(result.data.fileUrl);
        }
        setLoading(false);
        return result.data;
      } else {
        throw new Error(
          result.data?.message || 'Failed to generate Purchase Order'
        );
      }
    } catch (err) {
      console.error('Purchase Order generation error:', err);
      let errorMessage = 'KhÃ´ng thá»ƒ táº¡o Ä‘Æ¡n Ä‘áº·t hÃ ng.';

      if (err.message?.includes('unauthenticated')) {
        errorMessage =
          'Lá»—i xÃ¡c thá»±c Google. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i vÃ  thá»­ láº¡i.';
        // Try to reset Google Sign-In
        try {
          await GoogleSignin.signOut();
          console.log('Google sign-out complete, user should re-authenticate');
        } catch (signOutErr) {
          console.error('Error signing out from Google:', signOutErr);
        }
      }

      setError(errorMessage);
      Alert.alert('Lá»—i', errorMessage);
      setLoading(false);
      throw err;
    }
  };

  /**
   * Format the data for the PO generator
   *
   * @param {Object} data - The raw data to format
   * @returns {Object} - The formatted data
   */
  const formatPOData = (data) => {
    // Calculate the totals
    const subTotal = calculateSubTotal(data.materials);
    const vatPercentage = data.vatPercentage || 10;
    const vatAmount = (subTotal * vatPercentage) / 100;
    const grandTotal = subTotal + vatAmount;

    return {
      metadata: {
        projectName: data.projectName,
        supplierName: data.supplierName,
        supplierAddress: data.supplierAddress,
        supplierPhone: data.supplierPhone,
        supplierEmail: data.supplierEmail,
        supplierTaxCode: data.supplierTaxCode,
        supplierContactPerson: data.supplierContactPerson,
        poNumber: data.poNumber || `PO-${Date.now().toString().substr(-6)}`,
        poDate: data.poDate || new Date().toLocaleDateString('vi-VN'),
        deliveryTime: data.deliveryTime,
        paymentTerms: data.paymentTerms,
      },
      materials: data.materials.map((item, index) => ({
        no: index + 1,
        name: item.name || '',
        unit: item.unit || '',
        quantity: parseFloat(item.quantity) || 0,
        unitPrice: parseFloat(item.unitPrice) || 0,
        total:
          (parseFloat(item.quantity) || 0) * (parseFloat(item.unitPrice) || 0),
      })),
      summary: {
        subTotal,
        vatPercentage,
        vatAmount,
        grandTotal,
      },
    };
  };

  /**
   * Calculate the subtotal of all materials
   *
   * @param {Array} materials - List of material items
   * @returns {number} - The calculated subtotal
   */
  const calculateSubTotal = (materials) => {
    return materials.reduce((sum, item) => {
      const quantity = parseFloat(item.quantity) || 0;
      const unitPrice = parseFloat(item.unitPrice) || 0;
      return sum + quantity * unitPrice;
    }, 0);
  };

  return {
    generatePurchaseOrder,
    loading,
    error,
  };
};

export default usePurchaseOrderGenerator;


--- File: C:\Users\Admin\Downloads\thpapp\src\hooks\useQuotationGenerator.js ---

import { useState } from 'react';
import * as FileSystem from 'expo-file-system';
import * as Sharing from 'expo-sharing';
import { Alert } from 'react-native';
import { getFunctions, httpsCallable } from 'firebase/functions';
import { GoogleSignin } from '@react-native-google-signin/google-signin';
import { saveQuotation } from '../api/quotationService';

/**
 * Custom hook for generating quotations in Excel format
 * @param {Object} options - Configuration options
 * @returns {Object} - Functions and state for quotation generation
 */
const useQuotationGenerator = ({ projectId, customerData, materials }) => {
  const [isLoading, setIsLoading] = useState(false);
  const [excelUrl, setExcelUrl] = useState(null);
  const [pdfUrl, setPdfUrl] = useState(null);
  const [isPdfLoading, setIsPdfLoading] = useState(false);

  /**
   * Formats quotation data for Excel export according to the specified template
   * @param {Object} quotationData - All quotation data
   * @returns {Object} - Formatted data for Excel
   */
  const formatQuotationDataForExcel = (quotationData) => {
    const {
      quotationNumber,
      quotationDate,
      projectName,
      customerData = {},
      metadata = {},
      materials = [],
      subTotal,
      discountPercentage,
      discountAmount,
      vatPercentage,
      vatAmount,
      grandTotal,
      amountInWords,
      quoteValidity,
      deliveryTime,
    } = quotationData;

    // Build data structure matching the Excel template
    return {
      metadata: {
        // Header/company info
        companyName:
          'CÃ”NG TY TNHH Sáº¢N XUáº¤T CÆ  KHÃ THÆ¯Æ NG Máº I Dá»ŠCH Vá»¤ TÃ‚N HÃ’A PHÃT',
        companyAddress:
          'Sá»‘ 7 Quá»‘c lá»™ 1A, KP3B, PhÆ°á»ng Thanh Lá»™c, Quáº­n 12, TP.HCM',
        companyPhone: '0978.268.559',
        companyEmail: 'chomcauinoxtanhoaphat.com.vn',
        taxCode: '0315155409',

        // Customer info - Sá»­ dá»¥ng metadata náº¿u cÃ³, khÃ´ng thÃ¬ dÃ¹ng customerData, khÃ´ng hiá»ƒn thá»‹ N/A
        customerName: metadata?.customerName || customerData?.name || '',
        customerAddress:
          metadata?.customerAddress || customerData?.address || '',
        customerPhone: metadata?.customerPhone || customerData?.phone || '',
        customerEmail: metadata?.customerEmail || customerData?.email || '',
        customerTaxCode:
          metadata?.customerTaxCode || customerData?.taxCode || '',
        customerContactPerson:
          metadata?.customerContactPerson || customerData?.contactPerson || '',

        // Quotation info
        quotationNumber,
        quotationDate: new Date(quotationDate).toLocaleDateString('vi-VN'),
        projectName,
        quoteValidity,
        deliveryTime,
      },

      // Materials will be added from row 8 onwards
      materials: materials.map((item, index) => {
        // Handle note rows differently. If isNote flag is already true OR
        // unit & quantity are both empty/zero and material field empty, treat as note.
        const startsWithPlus = (item.name || '').trim().startsWith('+');
        const nameIsNote = (item.name || '').toUpperCase().includes('GHI CHÃš');
        const inferredNote =
          item.isNote ||
          nameIsNote ||
          startsWithPlus ||
          ((!item.unit || item.unit === '') &&
            (!item.material || item.material === '') &&
            (item.quantity === null ||
              item.quantity === undefined ||
              item.quantity === 0));
        if (inferredNote) {
          return {
            isNote: true,
            no: null, // No sequence number for notes
            name: item.name || '',
            material: '', // No material for notes
            unit: '', // No unit for notes
            quantity: null, // No quantity for notes
            unitPrice: null,
            total: null,
            weight: null,
          };
        }

        const weight = item.weight ?? 0;
        const inputUnitPrice = item.unitPrice || item.price || 0;

        // Náº¿u khÃ´ng cÃ³ trá»ng lÆ°á»£ng (bÃ¡o giÃ¡ thá»§ cÃ´ng) -> dÃ¹ng Ä‘Æ¡n giÃ¡ trá»±c tiáº¿p
        const calculatedUnitPrice =
          weight && weight > 0 ? weight * inputUnitPrice : inputUnitPrice;

        const quantity = item.quantity || 0;
        const totalPrice = quantity * calculatedUnitPrice;

        return {
          isNote: false,
          no: item.no || index + 1,
          name: item.name || '',
          material: item.material || item.type || '',
          unit: item.unit || '',
          quantity: quantity,
          unitPrice: calculatedUnitPrice, // ÄÆ¡n giÃ¡ Ä‘Ã£ Ä‘Æ°á»£c tÃ­nh = Ä‘Æ¡n giÃ¡/kg * khá»‘i lÆ°á»£ng
          total: totalPrice || item.totalPrice || item.total || 0,
          weight: weight, // ThÃªm trÆ°á»ng weight Ä‘á»ƒ Cloud Function cÃ³ thá»ƒ sá»­ dá»¥ng náº¿u cáº§n
        };
      }),

      // Summary data
      summary: {
        subTotal,
        discountPercentage: discountPercentage || 0,
        discountAmount: discountAmount || 0,
        vatPercentage: vatPercentage || 0,
        vatAmount: vatAmount || 0,
        grandTotal: grandTotal || 0,
        amountInWords: amountInWords || 'KhÃ´ng Ä‘á»“ng',
      },
    };
  };

  /**
   * Generate and save a quotation in Excel format
   * @param {Object} quotationData - Complete quotation data
   * @returns {Promise<string>} URL to the generated Excel file
   */
  const generateExcelQuotation = async (quotationData) => {
    try {
      setIsLoading(true);

      // Format the data for Excel export
      const formattedData = formatQuotationDataForExcel(quotationData);

      // Ensure we have a Google access token
      const signedIn = await GoogleSignin.isSignedIn();
      if (!signedIn) {
        await GoogleSignin.signIn();
      }
      const { accessToken } = await GoogleSignin.getTokens();
      if (!accessToken) {
        throw new Error('KhÃ´ng thá»ƒ láº¥y Google access token');
      }

      // Call cloud function to generate Excel file (with user token)
      const functions = getFunctions(undefined, 'asia-southeast1');
      const generateExcelFunc = httpsCallable(
        functions,
        'generateExcelQuotation'
      );
      const result = await generateExcelFunc({
        formattedData,
        projectId,
        accessToken,
      });

      // Get the Excel file URL
      const { excelUrl, spreadsheetId } = result.data;
      setExcelUrl(excelUrl);

      // Automatically convert to PDF
      const pdfUrl = await convertExcelToPdf(
        spreadsheetId,
        quotationData.quotationNumber
      );

      // Save quotation metadata to Firestore with both URLs
      await saveQuotation(projectId, {
        ...quotationData,
        excelUrl,
        pdfUrl: pdfUrl || excelUrl, // Using the PDF URL if available, otherwise Excel URL
        createdBy: quotationData.createdBy,
      });

      return { excelUrl, pdfUrl, spreadsheetId };
    } catch (error) {
      console.error('Error generating Excel quotation:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº¡o bÃ¡o giÃ¡ Excel: ' + error.message);
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  /**
   * Convert Excel to PDF using the new Cloud Function
   * @param {string} spreadsheetId - ID of the Google Sheet to convert
   * @param {string} fileName - Name for the generated PDF file
   * @returns {Promise<string>} URL to the generated PDF file
   */
  const convertExcelToPdf = async (spreadsheetId, fileName) => {
    if (!spreadsheetId) {
      console.error('Missing spreadsheetId for PDF conversion');
      return null;
    }

    try {
      setIsPdfLoading(true);

      // Get Google access token
      const { accessToken } = await GoogleSignin.getTokens();

      // Call the new cloud function to export sheet to PDF
      const functions = getFunctions(); // us-central1 default
      const exportToPdfFunc = httpsCallable(functions, 'exportSheetToPdf');

      const result = await exportToPdfFunc({
        spreadsheetId,
        fileName,
        projectId,
        accessToken,
      });

      // Get the PDF file URL
      const { pdfUrl } = result.data;
      setPdfUrl(pdfUrl);

      return pdfUrl;
    } catch (error) {
      console.error('Error converting Excel to PDF:', error);
      Alert.alert(
        'ThÃ´ng bÃ¡o',
        'ÄÃ£ táº¡o bÃ¡o giÃ¡ Excel thÃ nh cÃ´ng, nhÆ°ng khÃ´ng thá»ƒ chuyá»ƒn Ä‘á»•i sang PDF. Báº¡n váº«n cÃ³ thá»ƒ chia sáº» file Excel.'
      );
      return null;
    } finally {
      setIsPdfLoading(false);
    }
  };

  /**
   * Share the generated Excel file
   */
  const shareExcelQuotation = async () => {
    try {
      if (!excelUrl) {
        Alert.alert('Lá»—i', 'ChÆ°a cÃ³ file bÃ¡o giÃ¡ Excel Ä‘á»ƒ chia sáº».');
        return;
      }

      const fileUri = `${FileSystem.documentDirectory}quotation.xlsx`;
      const downloadResult = await FileSystem.downloadAsync(excelUrl, fileUri);

      if (downloadResult.status === 200) {
        await Sharing.shareAsync(fileUri);
      } else {
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i file bÃ¡o giÃ¡ Excel.');
      }
    } catch (error) {
      console.error('Error sharing Excel quotation:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ chia sáº» bÃ¡o giÃ¡ Excel: ' + error.message);
    }
  };

  /**
   * Share the generated PDF file
   */
  const sharePdfQuotation = async () => {
    try {
      if (!pdfUrl) {
        Alert.alert('Lá»—i', 'ChÆ°a cÃ³ file bÃ¡o giÃ¡ PDF Ä‘á»ƒ chia sáº».');
        return;
      }

      const fileUri = `${FileSystem.documentDirectory}quotation.pdf`;
      const downloadResult = await FileSystem.downloadAsync(pdfUrl, fileUri);

      if (downloadResult.status === 200) {
        await Sharing.shareAsync(fileUri, {
          mimeType: 'application/pdf',
          UTI: 'com.adobe.pdf',
        });
      } else {
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i file bÃ¡o giÃ¡ PDF.');
      }
    } catch (error) {
      console.error('Error sharing PDF quotation:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ chia sáº» bÃ¡o giÃ¡ PDF: ' + error.message);
    }
  };

  return {
    generateExcelQuotation,
    convertExcelToPdf,
    shareExcelQuotation,
    sharePdfQuotation,
    isLoading,
    isPdfLoading,
    excelUrl,
    pdfUrl,
  };
};

export default useQuotationGenerator;


--- File: C:\Users\Admin\Downloads\thpapp\src\navigation\AppNavigator.js ---

import React from 'react';
import { Text, View, TouchableOpacity } from 'react-native';
import {
  NavigationContainer,
  DefaultTheme,
  DarkTheme,
} from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { Ionicons } from '@expo/vector-icons';
import { useAuth } from '../contexts/AuthContext';
import { useTheme } from '../contexts/ThemeContext';

// Import cÃ¡c mÃ n hÃ¬nh
import LoginScreen from '../screens/LoginScreen';
import HomeScreen from '../screens/HomeScreen';
import CustomerManagementScreen from '../screens/CustomerManagementScreen';
import CustomerDetailScreen from '../screens/CustomerDetailScreen';
import AddCustomerScreen from '../screens/AddCustomerScreen';
import EditCustomerScreen from '../screens/EditCustomerScreen';

// Import cÃ¡c mÃ n hÃ¬nh quáº£n lÃ½ dá»± Ã¡n
import ProjectManagementScreen from '../screens/ProjectManagementScreen';
import ProjectDetailScreen from '../screens/ProjectDetailScreen';
import AddProjectScreen from '../screens/AddProjectScreen';
import EditProjectScreen from '../screens/EditProjectScreen';
import FinalizeQuotationScreen from '../screens/FinalizeQuotationScreen';
import QuotationScreen from '../screens/QuotationScreen';
import ManualQuotationScreen from '../screens/ManualQuotationScreen';
import StageDetailScreen from '../screens/StageDetailScreen';
import MaterialPurchaseScreen from '../screens/MaterialPurchaseScreen';
import CreateProposalScreen from '../screens/CreateProposalScreen';
import ProposalListScreen from '../screens/ProposalListScreen';
import CreatePOScreen from '../screens/CreatePOScreen';
import POListScreen from '../screens/POListScreen';

// Import mÃ n hÃ¬nh tÃ i khoáº£n
import AccountScreen from '../screens/AccountScreen';

// Import mÃ n hÃ¬nh bÃ¡o cÃ¡o cÃ´ng viá»‡c
import TaskReportScreen from '../screens/TaskReportScreen';
import TaskDetailScreen from '../screens/TaskDetailScreen';
import AttendanceScreen from '../screens/AttendanceScreen';
import UserManagementScreen from '../screens/UserManagementScreen';

// Import mÃ n hÃ¬nh dashboard cho giÃ¡m Ä‘á»‘c
import DirectorDashboardScreen from '../screens/DirectorDashboardScreen';
import DebtDashboard from '../screens/DebtDashboard';
import NotificationsScreen from '../screens/NotificationsScreen'; // Import NotificationsScreen

// Import cÃ¡c mÃ n hÃ¬nh quáº£n lÃ½ nhÃ  cung cáº¥p
import SupplierManagementScreen from '../screens/SupplierManagementScreen';
import AddSupplierScreen from '../screens/AddSupplierScreen';
import EditSupplierScreen from '../screens/EditSupplierScreen';
import SupplierDetailScreen from '../screens/SupplierDetailScreen';
import ConfirmPOReceiptScreen from '../screens/ConfirmPOReceiptScreen';

// Táº¡o Stack Navigator cho quáº£n lÃ½ dá»± Ã¡n
const ProjectStack = createNativeStackNavigator();

const ProjectStackNavigator = () => {
  const { theme } = useTheme();

  return (
    <ProjectStack.Navigator
      screenOptions={{
        headerShown: true,
        headerStyle: {
          backgroundColor: theme.background,
        },
        headerTitleStyle: {
          color: theme.text,
        },
        headerTintColor: theme.text,
        contentStyle: { backgroundColor: theme.background },
      }}
    >
      <ProjectStack.Screen
        name="ProjectManagement"
        component={ProjectManagementScreen}
        options={({ navigation }) => ({
          title: 'Quáº£n lÃ½ Dá»± Ã¡n',
          headerRight: () => (
            <TouchableOpacity
              onPress={() => navigation.navigate('AddProject')}
              style={{
                marginRight: 15,
                backgroundColor: theme.primary,
                width: 36,
                height: 36,
                borderRadius: 18,
                justifyContent: 'center',
                alignItems: 'center',
              }}
            >
              <Ionicons name="add" size={24} color="#fff" />
            </TouchableOpacity>
          ),
        })}
      />
      <ProjectStack.Screen
        name="ProjectDetail"
        component={ProjectDetailScreen}
        options={{ headerShown: false }}
      />
      <ProjectStack.Screen
        name="AddProject"
        component={AddProjectScreen}
        options={{ title: 'ThÃªm Dá»± Ã¡n Má»›i', headerRight: null }}
      />
      <ProjectStack.Screen
        name="EditProject"
        component={EditProjectScreen}
        options={{ title: 'Chá»‰nh sá»­a Dá»± Ã¡n', headerRight: null }}
      />
      <ProjectStack.Screen
        name="Quotation"
        component={QuotationScreen}
        options={{ headerShown: false }}
      />
      <ProjectStack.Screen
        name="ManualQuotation"
        component={ManualQuotationScreen}
        options={{ title: 'BÃ¡o giÃ¡ Thá»§ cÃ´ng' }}
      />
      <ProjectStack.Screen
        name="FinalizeQuotation"
        component={FinalizeQuotationScreen}
        options={{ title: 'HoÃ n táº¥t BÃ¡o giÃ¡', headerRight: null }}
      />
      <ProjectStack.Screen
        name="StageDetail"
        component={StageDetailScreen}
        options={{ title: 'Chi tiáº¿t CÃ´ng Ä‘oáº¡n' }}
      />
      <ProjectStack.Screen
        name="MaterialPurchase"
        component={MaterialPurchaseScreen}
        options={{ title: 'Quáº£n lÃ½ Mua Váº­t TÆ°' }}
      />
      <ProjectStack.Screen
        name="CreateProposal"
        component={CreateProposalScreen}
        options={{ title: 'Táº¡o Äá» Xuáº¥t' }}
      />
      <ProjectStack.Screen
        name="CreatePO"
        component={CreatePOScreen}
        options={{ title: 'Táº¡o PO' }}
      />
      <ProjectStack.Screen
        name="ProposalList"
        component={ProposalListScreen}
        options={{ title: 'Duyá»‡t Äá» Xuáº¥t' }}
      />
      <ProjectStack.Screen
        name="POList"
        component={POListScreen}
        options={{ title: 'ÄÆ¡n Ä‘áº·t hÃ ng' }}
      />
    </ProjectStack.Navigator>
  );
};

// Táº¡o Tab Navigator
const Tab = createBottomTabNavigator();

const MainTabNavigator = () => {
  const { theme } = useTheme();
  const { user } = useAuth();

  // Check if user has director role - support both English and Vietnamese role names
  const isDirector = ['director', 'GiÃ¡m Ä‘á»‘c', 'giam_doc'].includes(user?.role);
  const canManageAttendance = ['pho_giam_doc'].includes(user?.role);
  const canManageUsers = ['admin', 'giam_doc'].includes(user?.role);

  console.log('User role:', user?.role, 'Is Director:', isDirector);

  return (
    <Tab.Navigator
      screenOptions={({ route }) => ({
        tabBarIcon: ({ focused, color, size }) => {
          let iconName;

          if (route.name === 'Home') {
            iconName = focused ? 'home' : 'home-outline';
          } else if (route.name === 'Customers') {
            iconName = focused ? 'people' : 'people-outline';
          } else if (route.name === 'Projects') {
            iconName = focused ? 'briefcase' : 'briefcase-outline';
          } else if (route.name === 'Tasks') {
            iconName = focused ? 'file-tray-full' : 'file-tray-full-outline';
          } else if (route.name === 'Attendance') {
            iconName = focused ? 'checkbox' : 'square-outline';
          } else if (route.name === 'UserManagement') {
            iconName = focused ? 'people' : 'people-outline';
          } else if (route.name === 'Account') {
            iconName = focused ? 'person-circle' : 'person-circle-outline';
          } else if (route.name === 'Dashboard') {
            iconName = focused ? 'stats-chart' : 'stats-chart-outline';
          }

          return <Ionicons name={iconName} size={size} color={color} />;
        },
        tabBarActiveTintColor: theme.primary,
        tabBarInactiveTintColor: theme.textMuted,
        headerShown: true,
        headerStyle: {
          backgroundColor: theme.background,
        },
        headerTitleStyle: {
          color: theme.text,
        },
        tabBarStyle: {
          backgroundColor: theme.background,
          borderTopColor: theme.border,
        },
        contentStyle: {
          backgroundColor: theme.background,
        },
      })}
    >
      {isDirector ? (
        // Director sees Dashboard as first tab
        <Tab.Screen
          name="Dashboard"
          component={DirectorDashboardScreen}
          options={{ title: 'Tá»•ng Quan' }}
        />
      ) : (
        // Other users see Home as first tab
        <Tab.Screen
          name="Home"
          component={HomeScreen}
          options={{ title: 'Trang Chá»§' }}
        />
      )}
      <Tab.Screen
        name="Customers"
        component={CustomerManagementScreen}
        options={{ title: 'KhÃ¡ch HÃ ng', headerShown: false }}
      />
      <Tab.Screen
        name="Projects"
        component={ProjectStackNavigator}
        options={{
          title: 'Dá»± Ãn',
          headerShown: false,
        }}
      />
      {!canManageAttendance && (
        <Tab.Screen
          name="Tasks"
          component={TaskReportScreen}
          options={{ title: 'BÃ¡o cÃ¡o', headerShown: false }}
        />
      )}

      {canManageUsers && (
        <Tab.Screen
          name="UserManagement"
          component={UserManagementScreen}
          options={{ title: 'NhÃ¢n viÃªn' }}
        />
      )}

      {canManageAttendance && (
        <Tab.Screen
          name="Attendance"
          component={AttendanceScreen}
          options={{ title: 'Cháº¥m CÃ´ng' }}
        />
      )}

      <Tab.Screen
        name="Account"
        component={AccountScreen}
        options={{ title: 'TÃ i khoáº£n' }}
      />
    </Tab.Navigator>
  );
};

// Táº¡o Stack Navigator cho luá»“ng xÃ¡c thá»±c vÃ  cÃ¡c mÃ n hÃ¬nh khÃ¡c
const Stack = createNativeStackNavigator();

const AppNavigator = () => {
  // Sá»­ dá»¥ng tráº¡ng thÃ¡i Ä‘Äƒng nháº­p tá»« AuthContext
  const { isSignedIn, loadingAuth } = useAuth();
  const { theme, isDarkMode } = useTheme();

  // Táº¡o theme cho NavigationContainer dá»±a trÃªn theme hiá»‡n táº¡i
  const navigationTheme = {
    ...(isDarkMode ? DarkTheme : DefaultTheme),
    colors: {
      ...(isDarkMode ? DarkTheme.colors : DefaultTheme.colors),
      primary: theme.primary,
      background: theme.background,
      card: theme.card,
      text: theme.text,
      border: theme.border,
      notification: theme.primary,
    },
  };

  // Hiá»ƒn thá»‹ mÃ n hÃ¬nh loading náº¿u Ä‘ang kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
  if (loadingAuth) {
    return (
      <View
        style={{
          flex: 1,
          justifyContent: 'center',
          alignItems: 'center',
          backgroundColor: theme.background,
        }}
      >
        <Text style={{ color: theme.text }}>Äang táº£i...</Text>
      </View>
    );
  }

  return (
    <NavigationContainer theme={navigationTheme}>
      <Stack.Navigator
        screenOptions={{
          contentStyle: { backgroundColor: theme.background },
        }}
      >
        {isSignedIn ? (
          // NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p
          <>
            <Stack.Screen
              name="Main"
              component={MainTabNavigator}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="CustomerDetail"
              component={CustomerDetailScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="AddCustomer"
              component={AddCustomerScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="EditCustomer"
              component={EditCustomerScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="ProjectDetail"
              component={ProjectDetailScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="TaskDetail"
              component={TaskDetailScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="AddProject"
              component={AddProjectScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="EditProject"
              component={EditProjectScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="FinalizeQuotation"
              component={FinalizeQuotationScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="Quotation"
              component={QuotationScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="StageDetail"
              component={StageDetailScreen}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="DebtDashboard"
              component={DebtDashboard}
              options={{ headerShown: false }}
            />
            <Stack.Screen
              name="ProposalList"
              component={ProposalListScreen}
              options={{
                title: 'Duyá»‡t Äá» Xuáº¥t',
                headerStyle: {
                  backgroundColor: theme.background,
                },
                headerTintColor: theme.text,
                headerTitleStyle: {
                  color: theme.text,
                },
              }}
            />
            <Stack.Screen
              name="DirectorDashboard"
              component={DirectorDashboardScreen}
              options={{ title: 'Trang cá»§a giÃ¡m Ä‘á»‘c' }}
            />
            <Stack.Screen
              name="Notifications"
              component={NotificationsScreen}
              options={{ title: 'ThÃ´ng bÃ¡o' }}
            />

            {/* ThÃªm cÃ¡c mÃ n hÃ¬nh quáº£n lÃ½ nhÃ  cung cáº¥p */}
            <Stack.Screen
              name="SupplierManagement"
              component={SupplierManagementScreen}
            />
            <Stack.Screen name="AddSupplier" component={AddSupplierScreen} />
            <Stack.Screen name="EditSupplier" component={EditSupplierScreen} />
            <Stack.Screen
              name="SupplierDetail"
              component={SupplierDetailScreen}
            />
            <Stack.Screen
              name="ConfirmPOReceipt"
              component={ConfirmPOReceiptScreen}
              options={{ title: 'XÃ¡c nháº­n giao hÃ ng', headerShown: true }}
            />
          </>
        ) : (
          // NgÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p
          <Stack.Screen
            name="Login"
            component={LoginScreen}
            options={{ headerShown: false }}
          />
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
};

export default AppNavigator;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\AccountScreen.js ---

//src/screens/AccountScreen.js
import React, { useContext, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  Switch,
  ScrollView,
  Alert,
  LayoutAnimation,
  UIManager,
  Platform,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Ionicons } from '@expo/vector-icons';
import { useAuth } from '../contexts/AuthContext';
import { useTheme } from '../contexts/ThemeContext';
import {
  GoogleSignin,
  statusCodes,
} from '@react-native-google-signin/google-signin';

if (
  Platform.OS === 'android' &&
  UIManager.setLayoutAnimationEnabledExperimental
) {
  UIManager.setLayoutAnimationEnabledExperimental(true);
}

const SettingItem = ({
  icon,
  title,
  value,
  onPress,
  type = 'chevron',
  color,
}) => {
  const { theme } = useTheme();

  return (
    <TouchableOpacity
      style={[styles.settingItem, { borderBottomColor: theme.border }]}
      onPress={onPress}
      disabled={type === 'switch'}
    >
      <View style={styles.settingLeft}>
        <Ionicons
          name={icon}
          size={22}
          color={color || theme.text}
          style={styles.settingIcon}
        />
        <Text style={[styles.settingTitle, { color: theme.text }]}>
          {title}
        </Text>
      </View>

      <View style={styles.settingRight}>
        {type === 'switch' && (
          <Switch
            value={value}
            onValueChange={onPress}
            trackColor={{ false: theme.border, true: theme.primary }}
            thumbColor={value ? '#fff' : '#f4f3f4'}
          />
        )}
        {type === 'value' && (
          <Text style={[styles.settingValue, { color: theme.textSecondary }]}>
            {value}
          </Text>
        )}
        {type === 'chevron' && (
          <Ionicons name="chevron-forward" size={20} color={theme.textMuted} />
        )}
      </View>
    </TouchableOpacity>
  );
};

// Helper function to map role keys to display labels
const getRoleLabel = (role) => {
  switch (role) {
    case 'admin':
      return 'Quáº£n trá»‹ viÃªn';
    case 'giam_doc':
      return 'GiÃ¡m Ä‘á»‘c';
    case 'pho_giam_doc':
      return 'PhÃ³ GiÃ¡m Ä‘á»‘c';
    case 'quan_ly':
      return 'Quáº£n lÃ½';
    case 'ky_su':
      return 'Ká»¹ sÆ°';
    case 'ke_toan':
      return 'Káº¿ toÃ¡n';
    case 'thuong_mai':
      return 'ThÆ°Æ¡ng máº¡i';
    case 'cong_nhan':
      return 'CÃ´ng nhÃ¢n';
    case 'user':
      return 'NgÆ°á»i dÃ¹ng';
    default:
      return 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
  }
};

// Helper function to get style based on role
const getRoleStyle = (role) => {
  switch (role) {
    case 'giam_doc':
      return { backgroundColor: '#FFD700', textColor: '#8C6D00' };
    case 'pho_giam_doc':
      return { backgroundColor: '#E6E6FA', textColor: '#483D8B' };
    case 'ky_su':
      return {
        backgroundColor: 'rgba(0, 102, 204, 0.2)',
        textColor: '#0066cc',
      };
    case 'ke_toan':
      return {
        backgroundColor: 'rgba(46, 204, 113, 0.2)',
        textColor: '#27AE60',
      };
    case 'thuong_mai':
      return {
        backgroundColor: 'rgba(243, 156, 18, 0.2)',
        textColor: '#D35400',
      };
    case 'cong_nhan':
      return { backgroundColor: '#f0f0f0', textColor: '#555' };
    case 'admin':
    case 'quan_ly':
    case 'user':
    default:
      return {
        backgroundColor: 'rgba(108, 122, 137, 0.2)',
        textColor: '#6C7A89',
      };
  }
};

const AccountScreen = ({ navigation }) => {
  const { logout, currentUser, userRole } = useAuth();
  const { theme, isDarkMode, toggleTheme, followSystem, toggleFollowSystem } =
    useTheme();

  useEffect(() => {
    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
  }, []);

  const handleLogout = () => {
    Alert.alert(
      'XÃ¡c nháº­n Ä‘Äƒng xuáº¥t',
      'Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Äƒng xuáº¥t khÃ´ng?',
      [
        {
          text: 'Há»§y',
          style: 'cancel',
        },
        {
          text: 'ÄÄƒng xuáº¥t',
          onPress: () => logout(),
          style: 'destructive',
        },
      ],
      { cancelable: true }
    );
  };

  const switchGoogleAccount = async () => {
    try {
      // Ngáº¯t káº¿t ná»‘i tÃ i khoáº£n Google hiá»‡n táº¡i
      await GoogleSignin.revokeAccess();
      await GoogleSignin.signOut();

      Alert.alert(
        'ÄÃ£ ngáº¯t káº¿t ná»‘i',
        'TÃ i khoáº£n Google Ä‘Ã£ Ä‘Æ°á»£c ngáº¯t káº¿t ná»‘i. Báº¡n cÃ³ thá»ƒ káº¿t ná»‘i láº¡i khi cáº§n thiáº¿t trong mÃ n hÃ¬nh chi tiáº¿t dá»± Ã¡n.'
      );
    } catch (error) {
      if (error.code === statusCodes.SIGN_IN_REQUIRED) {
        // This error is expected after a sign-out or if the user isn't signed in.
        // We can safely ignore it.
        console.log(
          'User is not signed in, which is expected after revokeAccess.'
        );
        Alert.alert(
          'ÄÃ£ ngáº¯t káº¿t ná»‘i',
          'TÃ i khoáº£n Google Ä‘Ã£ Ä‘Æ°á»£c ngáº¯t káº¿t ná»‘i thÃ nh cÃ´ng.'
        );
      } else {
        // For any other unexpected errors, show an alert to the user.
        console.error('Lá»—i khi chuyá»ƒn tÃ i khoáº£n Google:', error);
        Alert.alert(
          'Lá»—i',
          'KhÃ´ng thá»ƒ ngáº¯t káº¿t ná»‘i tÃ i khoáº£n Google. Vui lÃ²ng thá»­ láº¡i.'
        );
      }
    }
  };

  // Get dynamic style for role badge
  const roleStyle = getRoleStyle(currentUser?.role);

  return (
    <SafeAreaView
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      <ScrollView
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.scrollViewContent}
      >
        {/* Header */}
        <View style={styles.header}>
          <View style={[styles.profileCard, { backgroundColor: theme.card }]}>
            <View
              style={[
                styles.avatarContainer,
                { backgroundColor: theme.primaryLight },
              ]}
            >
              <Text style={[styles.avatarText, { color: theme.primary }]}>
                {currentUser?.displayName
                  ? currentUser.displayName[0].toUpperCase()
                  : currentUser?.email
                  ? currentUser.email[0].toUpperCase()
                  : 'U'}
              </Text>
            </View>
            <View style={styles.userInfoContainer}>
              <Text style={[styles.nameText, { color: theme.text }]}>
                {currentUser?.displayName || 'TÃªn NgÆ°á»i DÃ¹ng'}
              </Text>
              <View
                style={[
                  styles.roleBadge,
                  { backgroundColor: roleStyle.backgroundColor },
                ]}
              >
                <Text
                  style={[styles.roleBadgeText, { color: roleStyle.textColor }]}
                >
                  {getRoleLabel(currentUser?.role)}
                </Text>
              </View>
            </View>
          </View>
        </View>

        {/* Settings Groups */}
        <View style={[styles.settingsGroup, { backgroundColor: theme.card }]}>
          <Text style={[styles.groupTitle, { color: theme.textSecondary }]}>
            Giao diá»‡n
          </Text>
          <SettingItem
            icon="contrast-outline"
            title="Cháº¿ Ä‘á»™ tá»‘i"
            value={isDarkMode}
            onPress={toggleTheme}
            type="switch"
          />
          <SettingItem
            icon="phone-portrait-outline"
            title="Theo há»‡ thá»‘ng"
            value={followSystem}
            onPress={toggleFollowSystem}
            type="switch"
          />
        </View>

        <View style={[styles.settingsGroup, { backgroundColor: theme.card }]}>
          <Text style={[styles.groupTitle, { color: theme.textSecondary }]}>
            TÃ i khoáº£n
          </Text>
          <SettingItem
            icon="person-outline"
            title="ThÃ´ng tin cÃ¡ nhÃ¢n"
            onPress={() => Alert.alert('TÃ­nh nÄƒng Ä‘ang phÃ¡t triá»ƒn')}
          />
          <SettingItem
            icon="key-outline"
            title="Äá»•i máº­t kháº©u"
            onPress={() => Alert.alert('TÃ­nh nÄƒng Ä‘ang phÃ¡t triá»ƒn')}
          />
          <SettingItem
            icon="swap-horizontal-outline"
            title="Chuyá»ƒn tÃ i khoáº£n Google"
            onPress={switchGoogleAccount}
            color="#4285F4"
          />
          {(userRole === 'giam_doc' || userRole === 'admin') && (
            <SettingItem
              icon="people-outline"
              title="Quáº£n lÃ½ nhÃ¢n viÃªn"
              onPress={() => navigation.navigate('UserManagement')}
              color={theme.primary}
            />
          )}
        </View>

        <View style={[styles.settingsGroup, { backgroundColor: theme.card }]}>
          <Text style={[styles.groupTitle, { color: theme.textSecondary }]}>
            á»¨ng dá»¥ng
          </Text>
          <SettingItem
            icon="information-circle-outline"
            title="ThÃ´ng tin á»©ng dá»¥ng"
            value="1.0.0"
            type="value"
            onPress={() => {}}
          />
          <SettingItem
            icon="help-circle-outline"
            title="Trá»£ giÃºp & Há»— trá»£"
            onPress={() => {}}
          />
        </View>

        {/* Logout Button */}
        <TouchableOpacity
          style={[styles.logoutButton, { backgroundColor: theme.danger }]}
          onPress={handleLogout}
        >
          <Ionicons
            name="log-out-outline"
            size={20}
            color="#fff"
            style={styles.logoutIcon}
          />
          <Text style={styles.logoutText}>ÄÄƒng xuáº¥t</Text>
        </TouchableOpacity>
      </ScrollView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  scrollViewContent: {
    paddingVertical: 16,
  },
  header: {
    paddingHorizontal: 16,
    marginBottom: 24,
  },
  profileCard: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    borderRadius: 16,
    elevation: 4,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
  },
  avatarContainer: {
    width: 72,
    height: 72,
    borderRadius: 36,
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: 16,
  },
  avatarText: {
    fontSize: 30,
    fontWeight: 'bold',
  },
  userInfoContainer: {
    flex: 1,
    justifyContent: 'center',
  },
  nameText: {
    fontSize: 20,
    fontWeight: 'bold',
    marginBottom: 8,
    marginLeft: 2,
  },
  roleBadge: {
    alignSelf: 'flex-start',
    paddingVertical: 4,
    paddingHorizontal: 12,
    borderRadius: 12,
  },
  roleBadgeText: {
    fontSize: 12,
    fontWeight: '600',
  },
  settingsGroup: {
    marginHorizontal: 16,
    marginVertical: 8,
    borderRadius: 12,
    overflow: 'hidden',
  },
  groupTitle: {
    fontSize: 14,
    fontWeight: '600',
    textTransform: 'uppercase',
    paddingHorizontal: 16,
    paddingTop: 16,
    paddingBottom: 8,
  },
  settingItem: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: 14,
    paddingHorizontal: 16,
    borderBottomWidth: 0.5,
  },
  settingLeft: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  settingIcon: {
    marginRight: 12,
  },
  settingTitle: {
    fontSize: 16,
  },
  settingRight: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  settingValue: {
    fontSize: 16,
    marginRight: 8,
  },
  logoutButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    marginHorizontal: 16,
    marginTop: 24,
    paddingVertical: 14,
    borderRadius: 12,
  },
  logoutIcon: {
    marginRight: 8,
  },
  logoutText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '500',
  },
});

export default AccountScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\AddCustomerScreen.js ---

//src/screens/AddCustomerScreen.js
import React, { useState, useRef } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  ActivityIndicator,
  Alert,
  KeyboardAvoidingView,
  Platform,
  Keyboard,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { createCustomer } from '../api/customerService';
import { useAuth } from '../contexts/AuthContext';
import { SafeAreaView } from 'react-native-safe-area-context';
import StyledTextInput from '../components/StyledTextInput';

const AddCustomerScreen = ({ navigation }) => {
  const { currentUser } = useAuth();
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    contactPerson: '',
    phone: '',
    email: '',
    address: '',
    type: 'regular', // máº·c Ä‘á»‹nh lÃ  khÃ¡ch hÃ ng thÆ°á»ng xuyÃªn
    taxCode: '',
  });

  // Refs cho cÃ¡c input Ä‘á»ƒ Ä‘iá»u hÆ°á»›ng focus
  const contactPersonRef = useRef(null);
  const phoneRef = useRef(null);
  const emailRef = useRef(null);
  const addressRef = useRef(null);
  const taxCodeRef = useRef(null);

  // Cáº­p nháº­t giÃ¡ trá»‹ form
  const handleChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  // Kiá»ƒm tra form há»£p lá»‡
  const validateForm = () => {
    if (!formData.name.trim()) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p tÃªn khÃ¡ch hÃ ng');
      return false;
    }

    if (!formData.contactPerson.trim()) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p tÃªn ngÆ°á»i liÃªn há»‡');
      return false;
    }

    if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      Alert.alert('Lá»—i', 'Email khÃ´ng há»£p lá»‡');
      return false;
    }

    return true;
  };

  // Xá»­ lÃ½ lÆ°u khÃ¡ch hÃ ng
  const handleSave = async () => {
    if (!validateForm()) {
      return;
    }

    Keyboard.dismiss();
    setIsLoading(true);

    try {
      // Gá»i API táº¡o khÃ¡ch hÃ ng má»›i
      await createCustomer(formData, currentUser?.uid);

      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ thÃªm khÃ¡ch hÃ ng má»›i thÃ nh cÃ´ng', [
        {
          text: 'OK',
          onPress: () => navigation.goBack(),
        },
      ]);
    } catch (error) {
      if (error.code === 'permission-denied') {
        Alert.alert(
          'Lá»—i quyá»n',
          'Báº¡n khÃ´ng cÃ³ Ä‘á»§ quyá»n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y.'
        );
      } else {
        console.error('Lá»—i khi thÃªm khÃ¡ch hÃ ng:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm khÃ¡ch hÃ ng. Vui lÃ²ng thá»­ láº¡i sau.');
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Xá»­ lÃ½ thay Ä‘á»•i loáº¡i khÃ¡ch hÃ ng
  const handleSelectType = (type) => {
    handleChange('type', type);
  };

  return (
    <SafeAreaView style={styles.safeArea}>
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={styles.container}
        keyboardVerticalOffset={Platform.OS === 'ios' ? 0 : 20}
      >
        <View style={styles.header}>
          <TouchableOpacity
            style={styles.backButton}
            onPress={() => navigation.goBack()}
          >
            <Ionicons name="arrow-back" size={24} color="#333" />
          </TouchableOpacity>
          <Text style={styles.headerTitle}>ThÃªm khÃ¡ch hÃ ng má»›i</Text>
          <View style={styles.placeholder} />
        </View>

        <ScrollView
          style={styles.formContainer}
          contentContainerStyle={styles.formContent}
          keyboardShouldPersistTaps="handled"
          showsVerticalScrollIndicator={false}
        >
          <StyledTextInput
            label="TÃªn cÃ´ng ty / Tá»• chá»©c"
            value={formData.name}
            onChangeText={(text) => handleChange('name', text)}
            placeholder="Nháº­p tÃªn cÃ´ng ty hoáº·c tá»• chá»©c"
            required={true}
            returnKeyType="next"
            blurOnSubmit={false}
            onSubmitEditing={() => contactPersonRef.current.focus()}
          />

          <StyledTextInput
            ref={contactPersonRef}
            label="NgÆ°á»i liÃªn há»‡"
            value={formData.contactPerson}
            onChangeText={(text) => handleChange('contactPerson', text)}
            placeholder="Nháº­p tÃªn ngÆ°á»i liÃªn há»‡"
            required={true}
            returnKeyType="next"
            blurOnSubmit={false}
            onSubmitEditing={() => phoneRef.current.focus()}
          />

          <StyledTextInput
            ref={phoneRef}
            label="Sá»‘ Ä‘iá»‡n thoáº¡i"
            value={formData.phone}
            onChangeText={(text) => handleChange('phone', text)}
            placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i"
            keyboardType="phone-pad"
            returnKeyType="next"
            blurOnSubmit={false}
            onSubmitEditing={() => emailRef.current.focus()}
          />

          <StyledTextInput
            ref={emailRef}
            label="Email"
            value={formData.email}
            onChangeText={(text) => handleChange('email', text)}
            placeholder="Nháº­p Ä‘á»‹a chá»‰ email"
            keyboardType="email-address"
            autoCapitalize="none"
            returnKeyType="next"
            blurOnSubmit={false}
            onSubmitEditing={() => addressRef.current.focus()}
          />

          <StyledTextInput
            ref={addressRef}
            label="Äá»‹a chá»‰"
            value={formData.address}
            onChangeText={(text) => handleChange('address', text)}
            placeholder="Nháº­p Ä‘á»‹a chá»‰"
            multiline
            numberOfLines={3}
            inputStyle={styles.textArea}
            returnKeyType="next"
            blurOnSubmit={false}
            onSubmitEditing={() => taxCodeRef.current.focus()}
          />

          <StyledTextInput
            ref={taxCodeRef}
            label="MÃ£ sá»‘ thuáº¿"
            value={formData.taxCode}
            onChangeText={(text) => handleChange('taxCode', text)}
            placeholder="Nháº­p mÃ£ sá»‘ thuáº¿"
            returnKeyType="done"
          />

          <View style={styles.inputGroup}>
            <Text style={styles.label}>Loáº¡i khÃ¡ch hÃ ng</Text>
            <View style={styles.typeButtonsContainer}>
              <TouchableOpacity
                style={[
                  styles.typeButton,
                  formData.type === 'potential' && styles.selectedTypeButton,
                ]}
                onPress={() => handleSelectType('potential')}
              >
                <Text
                  style={[
                    styles.typeButtonText,
                    formData.type === 'potential' &&
                      styles.selectedTypeButtonText,
                  ]}
                >
                  Tiá»m nÄƒng
                </Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.typeButton,
                  formData.type === 'regular' && styles.selectedTypeButton,
                ]}
                onPress={() => handleSelectType('regular')}
              >
                <Text
                  style={[
                    styles.typeButtonText,
                    formData.type === 'regular' &&
                      styles.selectedTypeButtonText,
                  ]}
                >
                  ThÆ°á»ng xuyÃªn
                </Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.typeButton,
                  formData.type === 'vip' && styles.selectedTypeButton,
                ]}
                onPress={() => handleSelectType('vip')}
              >
                <Text
                  style={[
                    styles.typeButtonText,
                    formData.type === 'vip' && styles.selectedTypeButtonText,
                  ]}
                >
                  VIP
                </Text>
              </TouchableOpacity>
            </View>
          </View>

          <TouchableOpacity
            style={styles.saveButton}
            onPress={handleSave}
            disabled={isLoading}
          >
            {isLoading ? (
              <ActivityIndicator color="#fff" size="small" />
            ) : (
              <>
                <Ionicons
                  name="save-outline"
                  size={20}
                  color="#fff"
                  style={styles.saveIcon}
                />
                <Text style={styles.saveButtonText}>LÆ°u khÃ¡ch hÃ ng</Text>
              </>
            )}
          </TouchableOpacity>
        </ScrollView>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  container: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  placeholder: {
    width: 24,
  },
  formContainer: {
    flex: 1,
  },
  formContent: {
    padding: 16,
  },
  inputGroup: {
    marginBottom: 16,
  },
  label: {
    fontSize: 16,
    fontWeight: '500',
    color: '#333',
    marginBottom: 6,
  },
  required: {
    color: '#e74c3c',
  },
  textArea: {
    height: 100,
    textAlignVertical: 'top',
    paddingTop: 12,
  },
  typeButtonsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  typeButton: {
    flex: 1,
    backgroundColor: '#f0f0f0',
    paddingVertical: 12,
    paddingHorizontal: 8,
    borderRadius: 6,
    alignItems: 'center',
    marginHorizontal: 4,
  },
  selectedTypeButton: {
    backgroundColor: '#0066cc',
  },
  typeButtonText: {
    color: '#333',
    fontWeight: '500',
  },
  selectedTypeButtonText: {
    color: '#fff',
  },
  saveButton: {
    backgroundColor: '#0066cc',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 14,
    borderRadius: 8,
    marginTop: 20,
    marginBottom: 30,
  },
  saveButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
  },
  saveIcon: {
    marginRight: 8,
  },
});

export default AddCustomerScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\AddProjectScreen.js ---

//src/screens/AddProjectScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  TextInput,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  ActivityIndicator,
  Alert,
  KeyboardAvoidingView,
  Platform,
  Modal,
  FlatList,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import DateTimePicker from '@react-native-community/datetimepicker';
import { createProject } from '../api/projectService';
import { getCustomers } from '../api/customerService';
import { useAuth } from '../contexts/AuthContext';

const AddProjectScreen = ({ navigation }) => {
  const { currentUser } = useAuth();
  const [isLoading, setIsLoading] = useState(false);
  const [customers, setCustomers] = useState([]);
  const [loadingCustomers, setLoadingCustomers] = useState(true);
  const [customerModalVisible, setCustomerModalVisible] = useState(false);
  const [customerSearchQuery, setCustomerSearchQuery] = useState('');
  const [filteredCustomers, setFilteredCustomers] = useState([]);

  // ThÃªm state cho date picker
  const [showStartDatePicker, setShowStartDatePicker] = useState(false);
  const [showEndDatePicker, setShowEndDatePicker] = useState(false);

  const [formData, setFormData] = useState({
    name: '',
    description: '',
    customerId: '',
    customerName: '',
    status: 'pending',
    startDate: null,
    endDate: null,
    durationInDays: '',
    location: 'workshop', // 'workshop' (táº¡i xÆ°á»Ÿng) hoáº·c 'site' (táº¡i cÃ´ng trÃ¬nh)
    budget: '',
    notes: '',
  });

  // Láº¥y danh sÃ¡ch khÃ¡ch hÃ ng khi mÃ n hÃ¬nh Ä‘Æ°á»£c táº£i
  useEffect(() => {
    const fetchCustomers = async () => {
      try {
        setLoadingCustomers(true);
        const data = await getCustomers();
        setCustomers(data);
        setFilteredCustomers(data);
      } catch (error) {
        console.error('Lá»—i khi láº¥y danh sÃ¡ch khÃ¡ch hÃ ng:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i danh sÃ¡ch khÃ¡ch hÃ ng');
      } finally {
        setLoadingCustomers(false);
      }
    };

    fetchCustomers();
  }, []);

  // Lá»c danh sÃ¡ch khÃ¡ch hÃ ng khi tá»« khÃ³a tÃ¬m kiáº¿m thay Ä‘á»•i
  useEffect(() => {
    if (!customerSearchQuery.trim()) {
      setFilteredCustomers(customers);
      return;
    }

    const query = customerSearchQuery.toLowerCase().trim();
    const filtered = customers.filter((customer) => {
      const name = (customer.name || '').toLowerCase();
      const contact = (customer.contactPerson || '').toLowerCase();
      const email = (customer.email || '').toLowerCase();

      return (
        name.includes(query) || contact.includes(query) || email.includes(query)
      );
    });

    setFilteredCustomers(filtered);
  }, [customerSearchQuery, customers]);

  // Cáº­p nháº­t giÃ¡ trá»‹ form
  const handleChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  // Xá»­ lÃ½ khi chá»n ngÃ y báº¯t Ä‘áº§u
  const handleStartDateChange = (event, selectedDate) => {
    setShowStartDatePicker(false);
    if (selectedDate) {
      handleChange('startDate', selectedDate);

      // Tá»± Ä‘á»™ng tÃ­nh ngÃ y káº¿t thÃºc náº¿u cÃ³ sá»‘ ngÃ y thi cÃ´ng
      if (formData.durationInDays) {
        const endDate = new Date(selectedDate);
        endDate.setDate(endDate.getDate() + Number(formData.durationInDays));
        handleChange('endDate', endDate);
      }
    }
  };

  // Xá»­ lÃ½ khi nháº­p sá»‘ ngÃ y thi cÃ´ng
  const handleDurationChange = (text) => {
    handleChange('durationInDays', text);

    // Tá»± Ä‘á»™ng tÃ­nh ngÃ y káº¿t thÃºc náº¿u cÃ³ ngÃ y báº¯t Ä‘áº§u
    if (formData.startDate && text) {
      const endDate = new Date(formData.startDate);
      endDate.setDate(endDate.getDate() + Number(text));
      handleChange('endDate', endDate);
    }
  };

  // Xá»­ lÃ½ khi chá»n vá»‹ trÃ­
  const handleLocationChange = (location) => {
    handleChange('location', location);
  };

  // Äá»‹nh dáº¡ng ngÃ y Ä‘á»ƒ hiá»ƒn thá»‹
  const formatDate = (date) => {
    if (!date) return '';
    return date.toLocaleDateString('vi-VN');
  };

  // Kiá»ƒm tra form há»£p lá»‡
  const validateForm = () => {
    if (!formData.name.trim()) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p tÃªn dá»± Ã¡n');
      return false;
    }

    return true;
  };

  // Xá»­ lÃ½ lÆ°u dá»± Ã¡n
  const handleSave = async () => {
    if (!validateForm()) {
      return;
    }

    setIsLoading(true);

    try {
      // Chuáº©n bá»‹ dá»¯ liá»‡u Ä‘á»ƒ lÆ°u
      const projectData = {
        ...formData,
        budget: formData.budget ? Number(formData.budget) : null,
        durationInDays: formData.durationInDays
          ? Number(formData.durationInDays)
          : null,
      };

      // Gá»i API táº¡o dá»± Ã¡n má»›i
      await createProject(projectData, currentUser?.uid);

      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ thÃªm dá»± Ã¡n má»›i thÃ nh cÃ´ng', [
        {
          text: 'OK',
          onPress: () => navigation.goBack(),
        },
      ]);
    } catch (error) {
      if (error.code === 'permission-denied') {
        Alert.alert(
          'Lá»—i quyá»n',
          'Báº¡n khÃ´ng cÃ³ Ä‘á»§ quyá»n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y.'
        );
      } else {
        console.error('Lá»—i khi thÃªm dá»± Ã¡n:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm dá»± Ã¡n. Vui lÃ²ng thá»­ láº¡i sau.');
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Xá»­ lÃ½ thay Ä‘á»•i tráº¡ng thÃ¡i dá»± Ã¡n
  const handleSelectStatus = (status) => {
    handleChange('status', status);
  };

  // Xá»­ lÃ½ má»Ÿ modal chá»n khÃ¡ch hÃ ng
  const handleOpenCustomerModal = () => {
    setCustomerModalVisible(true);
  };

  // Xá»­ lÃ½ Ä‘Ã³ng modal chá»n khÃ¡ch hÃ ng
  const handleCloseCustomerModal = () => {
    setCustomerModalVisible(false);
    setCustomerSearchQuery('');
  };

  // Xá»­ lÃ½ khi chá»n khÃ¡ch hÃ ng
  const handleSelectCustomer = (customer) => {
    setFormData((prev) => ({
      ...prev,
      customerId: customer.id,
      customerName: customer.name,
    }));
    handleCloseCustomerModal();
  };

  // Xá»­ lÃ½ khi tÃ¬m kiáº¿m khÃ¡ch hÃ ng
  const handleSearchCustomer = (text) => {
    setCustomerSearchQuery(text);
  };

  // Xá»­ lÃ½ khi xÃ³a khÃ¡ch hÃ ng Ä‘Ã£ chá»n
  const handleClearCustomer = () => {
    setFormData((prev) => ({
      ...prev,
      customerId: '',
      customerName: '',
    }));
  };

  // Render má»™t item trong danh sÃ¡ch khÃ¡ch hÃ ng
  const renderCustomerItem = ({ item }) => (
    <TouchableOpacity
      style={styles.customerItem}
      onPress={() => handleSelectCustomer(item)}
    >
      <View>
        <Text style={styles.customerName}>{item.name}</Text>
        {item.contactPerson && (
          <Text style={styles.customerDetail}>
            NgÆ°á»i liÃªn há»‡: {item.contactPerson}
          </Text>
        )}
        {item.email && (
          <Text style={styles.customerDetail}>Email: {item.email}</Text>
        )}
      </View>
      <Ionicons name="chevron-forward" size={20} color="#999" />
    </TouchableOpacity>
  );

  return (
    <KeyboardAvoidingView
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
      style={styles.container}
    >
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Ionicons name="arrow-back" size={24} color="#333" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>ThÃªm dá»± Ã¡n má»›i</Text>
        <View style={styles.placeholder} />
      </View>

      <ScrollView
        style={styles.formContainer}
        contentContainerStyle={styles.formContent}
        keyboardShouldPersistTaps="handled"
      >
        <View style={styles.inputGroup}>
          <Text style={styles.label}>
            TÃªn dá»± Ã¡n <Text style={styles.required}>*</Text>
          </Text>
          <TextInput
            style={styles.input}
            value={formData.name}
            onChangeText={(text) => handleChange('name', text)}
            placeholder="Nháº­p tÃªn dá»± Ã¡n"
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>MÃ´ táº£</Text>
          <TextInput
            style={[styles.input, styles.textArea]}
            value={formData.description}
            onChangeText={(text) => handleChange('description', text)}
            placeholder="Nháº­p mÃ´ táº£ dá»± Ã¡n"
            multiline
            numberOfLines={3}
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>KhÃ¡ch hÃ ng</Text>
          {formData.customerName ? (
            <View style={styles.selectedCustomerContainer}>
              <View style={styles.selectedCustomer}>
                <Ionicons name="business-outline" size={20} color="#0066cc" />
                <Text style={styles.selectedCustomerText}>
                  {formData.customerName}
                </Text>
              </View>
              <TouchableOpacity
                style={styles.clearCustomerButton}
                onPress={handleClearCustomer}
              >
                <Ionicons name="close-circle" size={20} color="#999" />
              </TouchableOpacity>
            </View>
          ) : (
            <TouchableOpacity
              style={styles.customerSelectButton}
              onPress={handleOpenCustomerModal}
            >
              <Ionicons name="add-circle-outline" size={20} color="#0066cc" />
              <Text style={styles.customerSelectButtonText}>
                Chá»n khÃ¡ch hÃ ng
              </Text>
            </TouchableOpacity>
          )}
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>Tráº¡ng thÃ¡i</Text>
          <View style={styles.statusButtonsContainer}>
            <TouchableOpacity
              style={[
                styles.statusButton,
                formData.status === 'pending' && styles.selectedStatusButton,
              ]}
              onPress={() => handleSelectStatus('pending')}
            >
              <Text
                style={[
                  styles.statusButtonText,
                  formData.status === 'pending' &&
                    styles.selectedStatusButtonText,
                ]}
              >
                Chá» xá»­ lÃ½
              </Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[
                styles.statusButton,
                formData.status === 'in-progress' &&
                  styles.selectedStatusButton,
              ]}
              onPress={() => handleSelectStatus('in-progress')}
            >
              <Text
                style={[
                  styles.statusButtonText,
                  formData.status === 'in-progress' &&
                    styles.selectedStatusButtonText,
                ]}
              >
                Äang thá»±c hiá»‡n
              </Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[
                styles.statusButton,
                formData.status === 'completed' && styles.selectedStatusButton,
              ]}
              onPress={() => handleSelectStatus('completed')}
            >
              <Text
                style={[
                  styles.statusButtonText,
                  formData.status === 'completed' &&
                    styles.selectedStatusButtonText,
                ]}
              >
                HoÃ n thÃ nh
              </Text>
            </TouchableOpacity>
          </View>

          <View style={[styles.statusButtonsContainer, { marginTop: 8 }]}>
            <TouchableOpacity
              style={[
                styles.statusButton,
                formData.status === 'cancelled' && styles.selectedStatusButton,
              ]}
              onPress={() => handleSelectStatus('cancelled')}
            >
              <Text
                style={[
                  styles.statusButtonText,
                  formData.status === 'cancelled' &&
                    styles.selectedStatusButtonText,
                ]}
              >
                ÄÃ£ há»§y
              </Text>
            </TouchableOpacity>
          </View>
        </View>

        {/* ThÃªm trÆ°á»ng ngÃ y báº¯t Ä‘áº§u */}
        <View style={styles.inputGroup}>
          <Text style={styles.label}>NgÃ y báº¯t Ä‘áº§u</Text>
          <TouchableOpacity
            style={styles.dateButton}
            onPress={() => setShowStartDatePicker(true)}
          >
            <Ionicons name="calendar-outline" size={20} color="#0066cc" />
            <Text style={styles.dateButtonText}>
              {formData.startDate
                ? formatDate(formData.startDate)
                : 'Chá»n ngÃ y báº¯t Ä‘áº§u'}
            </Text>
          </TouchableOpacity>
          {showStartDatePicker && (
            <DateTimePicker
              value={formData.startDate || new Date()}
              mode="date"
              display="default"
              onChange={handleStartDateChange}
            />
          )}
        </View>

        {/* ThÃªm trÆ°á»ng sá»‘ ngÃ y thi cÃ´ng */}
        <View style={styles.inputGroup}>
          <Text style={styles.label}>Sá»‘ ngÃ y thi cÃ´ng</Text>
          <TextInput
            style={styles.input}
            value={formData.durationInDays}
            onChangeText={handleDurationChange}
            placeholder="Nháº­p sá»‘ ngÃ y thi cÃ´ng"
            keyboardType="numeric"
          />
        </View>

        {/* Hiá»ƒn thá»‹ ngÃ y káº¿t thÃºc (chá»‰ Ä‘á»c) */}
        <View style={styles.inputGroup}>
          <Text style={styles.label}>NgÃ y káº¿t thÃºc (tá»± Ä‘á»™ng tÃ­nh)</Text>
          <View style={styles.readOnlyField}>
            <Ionicons name="calendar-outline" size={20} color="#666" />
            <Text style={styles.readOnlyText}>
              {formData.endDate
                ? formatDate(formData.endDate)
                : 'ChÆ°a xÃ¡c Ä‘á»‹nh'}
            </Text>
          </View>
        </View>

        {/* ThÃªm trÆ°á»ng vá»‹ trÃ­ */}
        <View style={styles.inputGroup}>
          <Text style={styles.label}>Vá»‹ trÃ­ thi cÃ´ng</Text>
          <View style={styles.locationButtonsContainer}>
            <TouchableOpacity
              style={[
                styles.locationButton,
                formData.location === 'workshop' &&
                  styles.selectedLocationButton,
              ]}
              onPress={() => handleLocationChange('workshop')}
            >
              <Text
                style={[
                  styles.locationButtonText,
                  formData.location === 'workshop' &&
                    styles.selectedLocationButtonText,
                ]}
              >
                Táº¡i xÆ°á»Ÿng
              </Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[
                styles.locationButton,
                formData.location === 'site' && styles.selectedLocationButton,
              ]}
              onPress={() => handleLocationChange('site')}
            >
              <Text
                style={[
                  styles.locationButtonText,
                  formData.location === 'site' &&
                    styles.selectedLocationButtonText,
                ]}
              >
                Táº¡i cÃ´ng trÃ¬nh
              </Text>
            </TouchableOpacity>
          </View>
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>NgÃ¢n sÃ¡ch</Text>
          <TextInput
            style={styles.input}
            value={formData.budget}
            onChangeText={(text) => handleChange('budget', text)}
            placeholder="Nháº­p ngÃ¢n sÃ¡ch dá»± Ã¡n"
            keyboardType="numeric"
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>Ghi chÃº</Text>
          <TextInput
            style={[styles.input, styles.textArea]}
            value={formData.notes}
            onChangeText={(text) => handleChange('notes', text)}
            placeholder="Nháº­p ghi chÃº"
            multiline
            numberOfLines={3}
          />
        </View>
      </ScrollView>

      <View style={styles.footer}>
        <TouchableOpacity
          style={styles.saveButton}
          onPress={handleSave}
          disabled={isLoading}
        >
          {isLoading ? (
            <ActivityIndicator color="#fff" size="small" />
          ) : (
            <>
              <Ionicons name="save-outline" size={20} color="#fff" />
              <Text style={styles.saveButtonText}>LÆ°u dá»± Ã¡n</Text>
            </>
          )}
        </TouchableOpacity>
      </View>

      {/* Modal chá»n khÃ¡ch hÃ ng */}
      <Modal
        visible={customerModalVisible}
        animationType="slide"
        transparent={true}
        onRequestClose={handleCloseCustomerModal}
      >
        <View style={styles.modalContainer}>
          <View style={styles.modalContent}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Chá»n khÃ¡ch hÃ ng</Text>
              <TouchableOpacity
                style={styles.closeButton}
                onPress={handleCloseCustomerModal}
              >
                <Ionicons name="close" size={24} color="#333" />
              </TouchableOpacity>
            </View>

            <View style={styles.searchContainer}>
              <Ionicons
                name="search"
                size={20}
                color="#999"
                style={styles.searchIcon}
              />
              <TextInput
                style={styles.searchInput}
                placeholder="TÃ¬m kiáº¿m khÃ¡ch hÃ ng..."
                value={customerSearchQuery}
                onChangeText={handleSearchCustomer}
              />
              {customerSearchQuery.length > 0 && (
                <TouchableOpacity
                  onPress={() => setCustomerSearchQuery('')}
                  style={styles.clearSearchButton}
                >
                  <Ionicons name="close-circle" size={18} color="#999" />
                </TouchableOpacity>
              )}
            </View>

            {loadingCustomers ? (
              <View style={styles.loadingContainer}>
                <ActivityIndicator size="large" color="#0066cc" />
                <Text style={styles.loadingText}>
                  Äang táº£i danh sÃ¡ch khÃ¡ch hÃ ng...
                </Text>
              </View>
            ) : (
              <FlatList
                data={filteredCustomers}
                keyExtractor={(item) => item.id}
                renderItem={renderCustomerItem}
                contentContainerStyle={styles.customersList}
                ListEmptyComponent={() => (
                  <View style={styles.emptyListContainer}>
                    <Ionicons name="search-outline" size={40} color="#ccc" />
                    <Text style={styles.emptyListText}>
                      KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng phÃ¹ há»£p
                    </Text>
                  </View>
                )}
              />
            )}
          </View>
        </View>
      </Modal>
    </KeyboardAvoidingView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  placeholder: {
    width: 24,
  },
  formContainer: {
    flex: 1,
  },
  formContent: {
    padding: 16,
  },
  inputGroup: {
    marginBottom: 16,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    marginBottom: 6,
    color: '#333',
  },
  required: {
    color: '#e74c3c',
  },
  input: {
    backgroundColor: '#fff',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    color: '#333',
  },
  textArea: {
    minHeight: 80,
    textAlignVertical: 'top',
  },
  statusButtonsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  statusButton: {
    flex: 1,
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 8,
    borderRadius: 8,
    marginHorizontal: 4,
    alignItems: 'center',
  },
  selectedStatusButton: {
    backgroundColor: '#0066cc',
  },
  statusButtonText: {
    fontSize: 14,
    color: '#666',
    fontWeight: '500',
  },
  selectedStatusButtonText: {
    color: '#fff',
  },
  // ThÃªm style cho cÃ¡c trÆ°á»ng má»›i
  dateButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
  },
  dateButtonText: {
    fontSize: 16,
    color: '#333',
    marginLeft: 8,
  },
  locationButtonsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  locationButton: {
    flex: 1,
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 8,
    borderRadius: 8,
    marginHorizontal: 4,
    alignItems: 'center',
  },
  selectedLocationButton: {
    backgroundColor: '#0066cc',
  },
  locationButtonText: {
    fontSize: 14,
    color: '#666',
    fontWeight: '500',
  },
  selectedLocationButtonText: {
    color: '#fff',
  },
  customerSelectButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
  },
  customerSelectButtonText: {
    fontSize: 16,
    color: '#0066cc',
    marginLeft: 8,
  },
  selectedCustomerContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
  },
  selectedCustomer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  selectedCustomerText: {
    fontSize: 16,
    color: '#333',
    marginLeft: 8,
  },
  clearCustomerButton: {
    padding: 4,
  },
  footer: {
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  saveButton: {
    backgroundColor: '#0066cc',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 14,
    borderRadius: 8,
  },
  saveButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
    marginLeft: 8,
  },
  modalContainer: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'flex-end',
  },
  modalContent: {
    backgroundColor: '#fff',
    borderTopLeftRadius: 16,
    borderTopRightRadius: 16,
    height: '80%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  closeButton: {
    padding: 4,
  },
  searchContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    margin: 16,
    borderRadius: 8,
    paddingHorizontal: 12,
  },
  searchIcon: {
    marginRight: 8,
  },
  searchInput: {
    flex: 1,
    height: 40,
    fontSize: 16,
  },
  clearSearchButton: {
    padding: 4,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  loadingText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
  },
  customersList: {
    padding: 16,
    paddingTop: 0,
  },
  customerItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    backgroundColor: '#f9f9f9',
    padding: 12,
    borderRadius: 8,
    marginBottom: 8,
  },
  customerName: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
    marginBottom: 2,
  },
  customerDetail: {
    fontSize: 14,
    color: '#666',
    marginTop: 2,
  },
  emptyListContainer: {
    alignItems: 'center',
    justifyContent: 'center',
    padding: 40,
  },
  emptyListText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  readOnlyField: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
  },
  readOnlyText: {
    fontSize: 16,
    color: '#666',
    marginLeft: 8,
  },
});

export default AddProjectScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\AddSupplierScreen.js ---

// src/screens/AddSupplierScreen.js
import React, { useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TextInput,
  TouchableOpacity,
  ScrollView,
  Alert,
  ActivityIndicator,
  SafeAreaView,
  KeyboardAvoidingView,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { addSupplier } from '../api/supplierService';
import { useAuth } from '../contexts/AuthContext';

const MATERIAL_CATEGORIES = [
  'ThÃ©p táº¥m',
  'NhÃ´m',
  'NÆ°á»›c',
  'SÆ¡n',
  'KhÃ­ hÃ n',
  'Váº­t liá»‡u hoÃ n thiá»‡n',
  'Sáº¯t',
  'Inox',
  'á»ng',
  'ThÃ©p hÃ¬nh',
  'Long Ä‘á»n',
  'Phá»¥ kiá»‡n',
  'Dá»¥ng cá»¥ hÃ n',
  'Thiáº¿t bá»‹ Ä‘o Ä‘áº¡c',
  'KhÃ¡c',
];

const AddSupplierScreen = ({ navigation }) => {
  const { currentUser } = useAuth();
  const [formData, setFormData] = useState({
    name: '',
    contactName: '',
    phone: '',
    email: '',
    address: '',
    taxCode: '',
    bankAccount: '',
    bankName: '',
    description: '',
    categories: [],
    verified: false,
    createdBy: currentUser?.uid || '',
    createdByName: currentUser?.displayName || currentUser?.email || '',
  });
  const [errors, setErrors] = useState({});
  const [saving, setSaving] = useState(false);

  const handleChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));

    // Clear error when field is edited
    if (errors[field]) {
      setErrors((prev) => ({
        ...prev,
        [field]: null,
      }));
    }
  };

  const toggleCategory = (category) => {
    setFormData((prev) => {
      const updatedCategories = [...prev.categories];

      if (updatedCategories.includes(category)) {
        // Remove category if already selected
        return {
          ...prev,
          categories: updatedCategories.filter((c) => c !== category),
        };
      } else {
        // Add category if not selected
        return {
          ...prev,
          categories: [...updatedCategories, category],
        };
      }
    });
  };

  const validateForm = () => {
    const newErrors = {};

    if (!formData.name.trim()) {
      newErrors.name = 'Vui lÃ²ng nháº­p tÃªn nhÃ  cung cáº¥p';
    }

    if (formData.phone && !/^[0-9]{10,11}$/.test(formData.phone.trim())) {
      newErrors.phone = 'Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡';
    }

    if (formData.email && !/\S+@\S+\.\S+/.test(formData.email.trim())) {
      newErrors.email = 'Email khÃ´ng há»£p lá»‡';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async () => {
    if (!validateForm()) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng kiá»ƒm tra láº¡i thÃ´ng tin nháº­p');
      return;
    }

    setSaving(true);
    try {
      await addSupplier(formData);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ thÃªm nhÃ  cung cáº¥p má»›i', [
        { text: 'OK', onPress: () => navigation.goBack() },
      ]);
    } catch (error) {
      console.error('Lá»—i khi thÃªm nhÃ  cung cáº¥p:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm nhÃ  cung cáº¥p. Vui lÃ²ng thá»­ láº¡i sau.');
    } finally {
      setSaving(false);
    }
  };

  return (
    <SafeAreaView style={styles.container}>
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={{ flex: 1 }}
      >
        <View style={styles.header}>
          <TouchableOpacity
            style={styles.backButton}
            onPress={() => navigation.goBack()}
          >
            <Ionicons name="arrow-back" size={24} color="#333" />
          </TouchableOpacity>
          <Text style={styles.headerTitle}>ThÃªm nhÃ  cung cáº¥p má»›i</Text>
          <View style={{ width: 24 }} />
        </View>

        <ScrollView style={styles.content}>
          <View style={styles.formGroup}>
            <Text style={styles.label}>
              TÃªn nhÃ  cung cáº¥p <Text style={styles.required}>*</Text>
            </Text>
            <TextInput
              style={[styles.input, errors.name && styles.inputError]}
              value={formData.name}
              onChangeText={(text) => handleChange('name', text)}
              placeholder="Nháº­p tÃªn nhÃ  cung cáº¥p"
            />
            {errors.name && <Text style={styles.errorText}>{errors.name}</Text>}
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>NgÆ°á»i liÃªn há»‡</Text>
            <TextInput
              style={styles.input}
              value={formData.contactName}
              onChangeText={(text) => handleChange('contactName', text)}
              placeholder="Nháº­p tÃªn ngÆ°á»i liÃªn há»‡"
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Sá»‘ Ä‘iá»‡n thoáº¡i</Text>
            <TextInput
              style={[styles.input, errors.phone && styles.inputError]}
              value={formData.phone}
              onChangeText={(text) => handleChange('phone', text)}
              placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i"
              keyboardType="phone-pad"
            />
            {errors.phone && (
              <Text style={styles.errorText}>{errors.phone}</Text>
            )}
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Email</Text>
            <TextInput
              style={[styles.input, errors.email && styles.inputError]}
              value={formData.email}
              onChangeText={(text) => handleChange('email', text)}
              placeholder="Nháº­p Ä‘á»‹a chá»‰ email"
              keyboardType="email-address"
              autoCapitalize="none"
            />
            {errors.email && (
              <Text style={styles.errorText}>{errors.email}</Text>
            )}
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Äá»‹a chá»‰</Text>
            <TextInput
              style={styles.input}
              value={formData.address}
              onChangeText={(text) => handleChange('address', text)}
              placeholder="Nháº­p Ä‘á»‹a chá»‰"
              multiline
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>MÃ£ sá»‘ thuáº¿</Text>
            <TextInput
              style={styles.input}
              value={formData.taxCode}
              onChangeText={(text) => handleChange('taxCode', text)}
              placeholder="Nháº­p mÃ£ sá»‘ thuáº¿"
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>TÃ i khoáº£n ngÃ¢n hÃ ng</Text>
            <TextInput
              style={styles.input}
              value={formData.bankAccount}
              onChangeText={(text) => handleChange('bankAccount', text)}
              placeholder="Nháº­p sá»‘ tÃ i khoáº£n"
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>TÃªn ngÃ¢n hÃ ng</Text>
            <TextInput
              style={styles.input}
              value={formData.bankName}
              onChangeText={(text) => handleChange('bankName', text)}
              placeholder="Nháº­p tÃªn ngÃ¢n hÃ ng"
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Danh má»¥c váº­t tÆ° cung cáº¥p</Text>
            <View style={styles.categoriesContainer}>
              {MATERIAL_CATEGORIES.map((category, index) => (
                <TouchableOpacity
                  key={index}
                  style={[
                    styles.categoryTag,
                    formData.categories.includes(category) &&
                      styles.categoryTagSelected,
                  ]}
                  onPress={() => toggleCategory(category)}
                >
                  <Text
                    style={[
                      styles.categoryText,
                      formData.categories.includes(category) &&
                        styles.categoryTextSelected,
                    ]}
                  >
                    {category}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>MÃ´ táº£</Text>
            <TextInput
              style={[styles.input, styles.textArea]}
              value={formData.description}
              onChangeText={(text) => handleChange('description', text)}
              placeholder="Nháº­p mÃ´ táº£ vá» nhÃ  cung cáº¥p"
              multiline
              numberOfLines={4}
              textAlignVertical="top"
            />
          </View>

          <View style={styles.verifiedContainer}>
            <TouchableOpacity
              style={styles.checkboxContainer}
              onPress={() => handleChange('verified', !formData.verified)}
            >
              <View
                style={[
                  styles.checkbox,
                  formData.verified && styles.checkboxChecked,
                ]}
              >
                {formData.verified && (
                  <Ionicons name="checkmark" size={16} color="#fff" />
                )}
              </View>
              <Text style={styles.checkboxLabel}>ÄÃ£ xÃ¡c minh</Text>
            </TouchableOpacity>
          </View>

          <TouchableOpacity
            style={styles.saveButton}
            onPress={handleSubmit}
            disabled={saving}
          >
            {saving ? (
              <ActivityIndicator color="#fff" size="small" />
            ) : (
              <Text style={styles.saveButtonText}>LÆ°u nhÃ  cung cáº¥p</Text>
            )}
          </TouchableOpacity>
        </ScrollView>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  content: {
    flex: 1,
    padding: 16,
  },
  formGroup: {
    marginBottom: 16,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    color: '#333',
    marginBottom: 6,
  },
  required: {
    color: 'red',
  },
  input: {
    backgroundColor: '#fff',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    paddingHorizontal: 12,
    paddingVertical: 10,
    fontSize: 16,
  },
  inputError: {
    borderColor: 'red',
  },
  errorText: {
    color: 'red',
    fontSize: 12,
    marginTop: 4,
  },
  textArea: {
    minHeight: 100,
    textAlignVertical: 'top',
  },
  categoriesContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    marginTop: 8,
  },
  categoryTag: {
    backgroundColor: '#f0f0f0',
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 16,
    marginRight: 8,
    marginBottom: 8,
  },
  categoryTagSelected: {
    backgroundColor: '#e6f2ff',
    borderWidth: 1,
    borderColor: '#0066cc',
  },
  categoryText: {
    fontSize: 14,
    color: '#666',
  },
  categoryTextSelected: {
    color: '#0066cc',
    fontWeight: '500',
  },
  verifiedContainer: {
    marginBottom: 24,
  },
  checkboxContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  checkbox: {
    width: 20,
    height: 20,
    borderRadius: 4,
    borderWidth: 1,
    borderColor: '#999',
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: 8,
  },
  checkboxChecked: {
    backgroundColor: '#0066cc',
    borderColor: '#0066cc',
  },
  checkboxLabel: {
    fontSize: 16,
    color: '#333',
  },
  saveButton: {
    backgroundColor: '#0066cc',
    paddingVertical: 14,
    borderRadius: 8,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 30,
  },
  saveButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
});

export default AddSupplierScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\AttendanceScreen.js ---

// src/screens/AttendanceScreen.js
import React, { useEffect, useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  TouchableOpacity,
  ActivityIndicator,
  Modal,
  TextInput,
  Alert,
  SafeAreaView,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useTheme } from '../contexts/ThemeContext';
import { db } from '../config/firebaseConfig';
import {
  collection,
  getDocs,
  addDoc,
  query,
  orderBy,
  serverTimestamp,
  deleteDoc,
  doc,
} from 'firebase/firestore';
import {
  setPresence,
  getAttendance,
  addOvertime,
} from '../api/attendanceService';
import DateTimePicker from '@react-native-community/datetimepicker';

const AttendanceScreen = () => {
  const { theme } = useTheme();
  const [employees, setEmployees] = useState([]);
  const [loading, setLoading] = useState(true);
  const [savingId, setSavingId] = useState(null);
  const [attMap, setAttMap] = useState({}); // uid -> attendance doc
  const [showAddModal, setShowAddModal] = useState(false);
  const [newName, setNewName] = useState('');
  const [newEmail, setNewEmail] = useState('');
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [showOvertimeModal, setShowOvertimeModal] = useState(false);
  const [overtimeHours, setOvertimeHours] = useState('');
  const [selectedEmployee, setSelectedEmployee] = useState(null);

  // Add default overtime hours
  const DEFAULT_OVERTIME_HOURS = 2.5; // Default 2.5 hours (20:30)

  // Format date for display
  const formatDisplayDate = (date) => {
    return date.toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  // Format date for document ID
  const formatDateForDoc = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  const fetchEmployees = async () => {
    setLoading(true);
    try {
      const usersRef = collection(db, 'users');
      const q = query(usersRef, orderBy('displayName', 'asc'));
      const snap = await getDocs(q);
      const list = snap.docs.map((d) => ({ uid: d.id, ...d.data() }));
      setEmployees(list);
      await fetchAttendanceForDate(selectedDate);
    } catch (err) {
      console.error('Load employees err', err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i danh sÃ¡ch nhÃ¢n viÃªn');
      setLoading(false);
    }
  };

  const fetchAttendanceForDate = async (date) => {
    setLoading(true);
    try {
      if (!employees.length) return;

      // Format date to YYYY-MM-DD for attendance lookup
      const dateStr = formatDateForDoc(date);

      // load attendance info
      const dateFetchPromises = employees.map((emp) =>
        getAttendance(emp.uid, dateStr)
      );
      const results = await Promise.all(dateFetchPromises);
      const map = {};
      results.forEach((doc) => {
        if (doc) map[doc.userId] = doc;
      });
      setAttMap(map);
    } catch (err) {
      console.error('Load attendance err', err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u cháº¥m cÃ´ng');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchEmployees();
  }, []);

  useEffect(() => {
    if (employees.length > 0) {
      fetchAttendanceForDate(selectedDate);
    }
  }, [selectedDate, employees.length]);

  const togglePresent = async (emp) => {
    try {
      setSavingId(emp.uid);
      const current = attMap[emp.uid]?.present || false;
      const updated = await setPresence(emp.uid, !current, selectedDate);
      setAttMap((prev) => ({ ...prev, [emp.uid]: updated }));
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t');
    } finally {
      setSavingId(null);
    }
  };

  const handleDateChange = (event, date) => {
    setShowDatePicker(false);
    if (date) {
      setSelectedDate(date);
    }
  };

  // Add delete employee function
  const deleteEmployee = async (emp) => {
    try {
      setSavingId(emp.uid);
      await deleteDoc(doc(db, 'users', emp.uid));
      setEmployees((prev) => prev.filter((e) => e.uid !== emp.uid));
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ xÃ³a nhÃ¢n viÃªn');
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ xÃ³a nhÃ¢n viÃªn');
    } finally {
      setSavingId(null);
    }
  };

  // Improve markAllPresent to be more efficient
  const markAllPresent = async () => {
    try {
      // Use a temporary state to show loading indicators on each row
      const tempIds = employees.map((e) => e.uid);
      setSavingId('all'); // Special marker for "all saving"
      const promises = employees.map((emp) =>
        setPresence(emp.uid, true, selectedDate)
      );
      await Promise.all(promises);

      // Update local state without full reload
      const newAttMap = { ...attMap };
      employees.forEach((emp) => {
        const uid = emp.uid;
        if (newAttMap[uid]) {
          newAttMap[uid].present = true;
        } else {
          newAttMap[uid] = {
            userId: uid,
            present: true,
            date: formatDateForDoc(selectedDate),
          };
        }
      });
      setAttMap(newAttMap);
      setSavingId(null);
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t táº¥t cáº£');
      setSavingId(null);
    }
  };

  // Add markAllOvertime function
  const markAllOvertime = async () => {
    try {
      setSavingId('all');
      const promises = employees.map((emp) =>
        addOvertime(emp.uid, DEFAULT_OVERTIME_HOURS, selectedDate)
      );
      await Promise.all(promises);

      // Update local state
      const newAttMap = { ...attMap };
      employees.forEach((emp) => {
        const uid = emp.uid;
        if (newAttMap[uid]) {
          newAttMap[uid].overtime = DEFAULT_OVERTIME_HOURS;
        } else {
          newAttMap[uid] = {
            userId: uid,
            overtime: DEFAULT_OVERTIME_HOURS,
            date: formatDateForDoc(selectedDate),
          };
        }
      });
      setAttMap(newAttMap);
      setSavingId(null);
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t tÄƒng ca');
      setSavingId(null);
    }
  };

  // Add a function to toggle overtime directly
  const toggleOvertime = async (emp) => {
    try {
      setSavingId(emp.uid);
      const current = attMap[emp.uid]?.overtime || 0;
      const newValue = current > 0 ? 0 : DEFAULT_OVERTIME_HOURS;
      const updated = await addOvertime(emp.uid, newValue, selectedDate);
      setAttMap((prev) => ({ ...prev, [emp.uid]: updated }));
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t tÄƒng ca');
    } finally {
      setSavingId(null);
    }
  };

  const handleAddOvertime = async () => {
    if (!selectedEmployee) return;

    const hours = parseFloat(overtimeHours);
    if (isNaN(hours) || hours < 0) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p sá»‘ giá» há»£p lá»‡');
      return;
    }

    try {
      setSavingId(selectedEmployee.uid);
      await addOvertime(selectedEmployee.uid, hours, selectedDate);
      setShowOvertimeModal(false);
      setOvertimeHours('');
      setSelectedEmployee(null);
      await fetchAttendanceForDate(selectedDate);
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm giá» tÄƒng ca');
    } finally {
      setSavingId(null);
    }
  };

  const openOvertimeModal = (emp) => {
    setSelectedEmployee(emp);
    setOvertimeHours('');
    setShowOvertimeModal(true);
  };

  const renderItem = ({ item }) => {
    const attendance = attMap[item.uid];
    const present = attendance?.present;
    const overtime = attendance?.overtime || 0;
    const isSaving = savingId === item.uid || savingId === 'all';

    return (
      <View
        style={[
          styles.row,
          { backgroundColor: theme.card, marginBottom: 8, borderRadius: 8 },
        ]}
      >
        <View style={styles.employeeInfo}>
          <Text
            style={[styles.nameText, { color: theme.text }]}
            numberOfLines={1}
            ellipsizeMode="tail"
          >
            {item.displayName || item.email || item.uid}
          </Text>
          <Text style={[styles.roleText, { color: theme.textSecondary }]}>
            {item.role ? getRoleLabel(item.role) : 'NhÃ¢n viÃªn'}
          </Text>
        </View>

        {overtime > 0 && (
          <TouchableOpacity
            style={styles.overtimeBadge}
            onPress={() => openOvertimeModal(item)}
          >
            <Ionicons
              name="time"
              size={12}
              color="#8B7500"
              style={{ marginRight: 4 }}
            />
            <Text style={styles.overtimeText}>
              {overtime === 2.5 ? '20:30' : `+${overtime}h`}
            </Text>
          </TouchableOpacity>
        )}

        <View style={styles.attendanceActions}>
          <TouchableOpacity
            onPress={() => togglePresent(item)}
            disabled={isSaving}
            style={styles.checkButton}
          >
            {isSaving ? (
              <ActivityIndicator size="small" color={theme.primary} />
            ) : (
              <Ionicons
                name={present ? 'checkbox' : 'square-outline'}
                size={24}
                color={present ? theme.primary : theme.textMuted}
              />
            )}
          </TouchableOpacity>

          <View style={styles.overtimeActionContainer}>
            <TouchableOpacity
              onPress={() => toggleOvertime(item)}
              disabled={isSaving}
              style={styles.checkButtonOvertime}
            >
              {isSaving ? (
                <ActivityIndicator
                  size="small"
                  color={theme.success || '#4CAF50'}
                />
              ) : (
                <Ionicons
                  name={overtime > 0 ? 'checkbox' : 'square-outline'}
                  size={24}
                  color={
                    overtime > 0 ? theme.success || '#4CAF50' : theme.textMuted
                  }
                />
              )}
            </TouchableOpacity>
          </View>
        </View>
      </View>
    );
  };

  const addEmployee = async () => {
    if (!newName.trim()) {
      Alert.alert('Thiáº¿u tÃªn');
      return;
    }
    try {
      const usersRef = collection(db, 'users');
      await addDoc(usersRef, {
        displayName: newName,
        email: newEmail.trim() || '',
        role: 'cong_nhan',
        createdAt: serverTimestamp(),
      });
      setShowAddModal(false);
      setNewName('');
      setNewEmail('');
      fetchEmployees();
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm nhÃ¢n viÃªn');
    }
  };

  // Helper function to format overtime display
  const formatOvertimeForDisplay = (hours) => {
    return `+${hours}h`;
  };

  // Helper function to map role keys to display labels
  const getRoleLabel = (role) => {
    switch (role) {
      case 'admin':
        return 'Quáº£n trá»‹ viÃªn';
      case 'giam_doc':
        return 'GiÃ¡m Ä‘á»‘c';
      case 'pho_giam_doc':
        return 'PhÃ³ GiÃ¡m Ä‘á»‘c';
      case 'quan_ly':
        return 'Quáº£n lÃ½';
      case 'ky_su':
        return 'Ká»¹ sÆ°';
      case 'ke_toan':
        return 'Káº¿ toÃ¡n';
      case 'thuong_mai':
        return 'ThÆ°Æ¡ng máº¡i';
      case 'cong_nhan':
        return 'CÃ´ng nhÃ¢n';
      case 'user':
        return 'NgÆ°á»i dÃ¹ng';
      default:
        return 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
    }
  };

  return (
    <SafeAreaView
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      {/* Header */}
      <View style={[styles.header, { backgroundColor: theme.card }]}>
        <Text style={[styles.headerTitle, { color: theme.text }]}>
          Cháº¥m CÃ´ng & TÄƒng Ca
        </Text>

        <TouchableOpacity
          style={[styles.dateButton, { borderColor: theme.border }]}
          onPress={() => setShowDatePicker(true)}
        >
          <Ionicons name="calendar-outline" size={18} color={theme.primary} />
          <Text style={[styles.dateText, { color: theme.text }]}>
            {formatDisplayDate(selectedDate)}
          </Text>
          <Ionicons name="chevron-down" size={16} color={theme.textMuted} />
        </TouchableOpacity>
      </View>

      {/* Action buttons */}
      <View style={styles.actionBar}>
        <TouchableOpacity
          style={[
            styles.actionButton,
            { backgroundColor: theme.secondary || '#FF9500' },
          ]}
          onPress={markAllPresent}
          disabled={savingId === 'all'}
        >
          {savingId === 'all' ? (
            <ActivityIndicator size="small" color="#fff" />
          ) : (
            <>
              <Ionicons
                name="checkbox"
                size={18}
                color="#fff"
                style={styles.actionIcon}
              />
              <Text style={styles.actionText}>Cháº¥m CÃ´ng Táº¥t Cáº£</Text>
            </>
          )}
        </TouchableOpacity>
      </View>

      {/* Employee list */}
      {loading ? (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color={theme.primary} />
          <Text style={[styles.loadingText, { color: theme.textSecondary }]}>
            Äang táº£i dá»¯ liá»‡u...
          </Text>
        </View>
      ) : (
        <FlatList
          data={employees}
          keyExtractor={(item) => item.uid}
          renderItem={renderItem}
          ListHeaderComponent={
            <>
              <View style={styles.listHeaderContainer}>
                <Text style={[styles.listHeaderLabel, { flex: 1 }]}>
                  TÃªn nhÃ¢n viÃªn
                </Text>
                <Text
                  style={[
                    styles.listHeaderLabel,
                    {
                      width: 80,
                      textAlign: 'center',
                      transform: [{ translateX: 3 }],
                    },
                  ]}
                >
                  Cháº¥m cÃ´ng
                </Text>
                <Text
                  style={[
                    styles.listHeaderLabel,
                    {
                      width: 80,
                      textAlign: 'center',
                      transform: [{ translateX: 6 }],
                    },
                  ]}
                >
                  TÄƒng ca
                </Text>
              </View>
              <View
                style={[styles.divider, { backgroundColor: theme.border }]}
              />
            </>
          }
          contentContainerStyle={styles.listContent}
          ListEmptyComponent={
            <View style={styles.emptyContainer}>
              <Ionicons name="people" size={40} color={theme.textMuted} />
              <Text style={[styles.emptyText, { color: theme.textMuted }]}>
                ChÆ°a cÃ³ nhÃ¢n viÃªn nÃ o
              </Text>
            </View>
          }
        />
      )}

      {/* Add employee button */}
      <TouchableOpacity
        style={[styles.fab, { backgroundColor: theme.primary }]}
        onPress={() => setShowAddModal(true)}
      >
        <Ionicons name="person-add" size={24} color="#fff" />
      </TouchableOpacity>

      {/* Date picker */}
      {showDatePicker && (
        <DateTimePicker
          value={selectedDate}
          mode="date"
          display={Platform.OS === 'ios' ? 'spinner' : 'default'}
          onChange={handleDateChange}
        />
      )}

      {/* Add employee modal */}
      <Modal visible={showAddModal} transparent animationType="slide">
        <View style={styles.modalBackdrop}>
          <View style={[styles.modalContent, { backgroundColor: theme.card }]}>
            <Text style={[styles.modalTitle, { color: theme.text }]}>
              ThÃªm nhÃ¢n viÃªn
            </Text>
            <TextInput
              placeholder="TÃªn"
              value={newName}
              onChangeText={setNewName}
              style={[
                styles.input,
                { borderColor: theme.border, color: theme.text },
              ]}
              placeholderTextColor={theme.textMuted}
            />
            <TextInput
              placeholder="Email (tuá»³ chá»n)"
              value={newEmail}
              onChangeText={setNewEmail}
              style={[
                styles.input,
                { borderColor: theme.border, color: theme.text },
              ]}
              placeholderTextColor={theme.textMuted}
            />
            <View style={styles.modalActions}>
              <TouchableOpacity
                onPress={() => setShowAddModal(false)}
                style={[styles.modalButton, styles.cancelButton]}
              >
                <Text style={{ color: theme.text }}>Huá»·</Text>
              </TouchableOpacity>
              <TouchableOpacity
                onPress={addEmployee}
                style={[
                  styles.modalButton,
                  styles.saveButton,
                  { backgroundColor: theme.primary },
                ]}
              >
                <Text style={styles.saveButtonText}>LÆ°u</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* Overtime modal */}
      <Modal visible={showOvertimeModal} transparent animationType="slide">
        <View style={styles.modalBackdrop}>
          <View style={[styles.modalContent, { backgroundColor: theme.card }]}>
            <Text style={[styles.modalTitle, { color: theme.text }]}>
              ThÃªm giá» tÄƒng ca
            </Text>
            <Text
              style={[
                styles.overtimeEmployeeName,
                { color: theme.textSecondary },
              ]}
            >
              {selectedEmployee?.displayName || ''}
            </Text>

            <TextInput
              placeholder="Sá»‘ giá» tÄƒng ca"
              value={overtimeHours}
              onChangeText={setOvertimeHours}
              keyboardType="decimal-pad"
              style={[
                styles.input,
                { borderColor: theme.border, color: theme.text },
              ]}
              placeholderTextColor={theme.textMuted}
            />

            <View style={styles.modalActions}>
              <TouchableOpacity
                onPress={() => setShowOvertimeModal(false)}
                style={[styles.modalButton, styles.cancelButton]}
              >
                <Text style={{ color: theme.text }}>Huá»·</Text>
              </TouchableOpacity>
              <TouchableOpacity
                onPress={handleAddOvertime}
                style={[
                  styles.modalButton,
                  styles.saveButton,
                  { backgroundColor: theme.primary },
                ]}
              >
                <Text style={styles.saveButtonText}>LÆ°u</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    elevation: 2,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  dateButton: {
    flexDirection: 'row',
    alignItems: 'center',
    borderWidth: 1,
    borderRadius: 8,
    paddingHorizontal: 10,
    paddingVertical: 6,
  },
  dateText: {
    marginHorizontal: 8,
    fontSize: 14,
  },
  actionBar: {
    flexDirection: 'row',
    padding: 12,
    justifyContent: 'space-around',
    gap: 10,
  },
  actionButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 8,
    borderRadius: 20,
    flex: 1,
    justifyContent: 'center',
  },
  actionIcon: {
    marginRight: 6,
  },
  actionText: {
    color: '#fff',
    fontWeight: '600',
  },
  divider: {
    height: 1,
    width: '100%',
    marginTop: 8,
  },
  listHeaderContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingTop: 8,
    alignItems: 'center',
  },
  listHeaderLabel: {
    fontWeight: '600',
    fontSize: 14,
  },
  listContent: {
    padding: 12,
  },
  row: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 12,
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  employeeInfo: {
    flex: 1,
    marginRight: 4,
  },
  nameText: {
    fontSize: 16,
    fontWeight: '500',
  },
  roleText: {
    fontSize: 12,
    marginTop: 2,
    flexBasis: '100%',
  },
  attendanceActions: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  overtimeActionContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    width: 80,
    justifyContent: 'center',
  },
  overtimeBadge: {
    backgroundColor: '#FFD700',
    borderRadius: 12,
    paddingHorizontal: 8,
    paddingVertical: 4,
    marginLeft: 4,
    flexDirection: 'row',
    alignItems: 'center',
  },
  overtimeText: {
    color: '#8B7500',
    fontSize: 12,
    fontWeight: 'bold',
  },
  checkButton: {
    width: 80,
    alignItems: 'center',
  },
  checkButtonOvertime: {
    paddingHorizontal: 8,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 12,
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 40,
  },
  emptyText: {
    marginTop: 12,
    fontSize: 16,
  },
  fab: {
    position: 'absolute',
    bottom: 20,
    right: 20,
    width: 56,
    height: 56,
    borderRadius: 28,
    justifyContent: 'center',
    alignItems: 'center',
    elevation: 4,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
  },
  modalBackdrop: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContent: {
    width: '85%',
    borderRadius: 12,
    padding: 20,
    elevation: 5,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    marginBottom: 16,
  },
  overtimeEmployeeName: {
    marginBottom: 12,
    fontSize: 16,
  },
  input: {
    borderWidth: 1,
    borderRadius: 8,
    padding: 12,
    marginBottom: 16,
    fontSize: 16,
  },
  modalActions: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    marginTop: 8,
  },
  modalButton: {
    paddingVertical: 10,
    paddingHorizontal: 16,
    borderRadius: 8,
    marginLeft: 12,
  },
  cancelButton: {
    backgroundColor: 'transparent',
  },
  saveButton: {
    minWidth: 80,
    alignItems: 'center',
  },
  saveButtonText: {
    color: '#fff',
    fontWeight: '600',
  },
});

export default AttendanceScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\ConfirmPOReceiptScreen.js ---

import React, { useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  TouchableOpacity,
  Image,
  Alert,
  TextInput,
  ActivityIndicator,
  ScrollView,
  ProgressBarAndroid,
  Platform,
  ProgressViewIOS,
  Linking,
} from 'react-native';
import { useRoute, useNavigation } from '@react-navigation/native';
import { Ionicons } from '@expo/vector-icons';
import * as ImagePicker from 'expo-image-picker';
import * as FileSystem from 'expo-file-system';
import usePOReceipt from '../hooks/usePOReceipt';
import uuid from 'react-native-uuid';

const ConfirmPOReceiptScreen = () => {
  const route = useRoute();
  const navigation = useNavigation();
  const { po } = route.params || {};

  const { confirmReceipt, loading, uploadProgress } = usePOReceipt();

  const [files, setFiles] = useState([]);
  const [remarks, setRemarks] = useState('');
  const [saving, setSaving] = useState(false);

  if (!po) {
    return (
      <View style={styles.centered}>
        <Text>KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin PO.</Text>
      </View>
    );
  }

  // HÃ m Ä‘Æ¡n giáº£n Ä‘á»ƒ thÃªm file vÃ o state
  const addFileToState = (asset) => {
    if (!asset || !asset.uri) {
      Alert.alert('Lá»—i', 'Táº­p tin khÃ´ng há»£p lá»‡.');
      return;
    }

    const tempId = uuid.v4();
    const fileInfo = {
      id: tempId, // ID táº¡m thá»i
      uri: asset.uri,
      name: asset.fileName || `image_${tempId}.jpg`,
      mimeType: asset.mimeType || 'image/jpeg',
    };

    setFiles((prev) => [...prev, fileInfo]);
  };

  const pickFile = async () => {
    const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (status !== 'granted') {
      Alert.alert('Lá»—i', 'Cáº§n quyá»n truy cáº­p thÆ° viá»‡n áº£nh.');
      return;
    }

    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      quality: 0.7,
      allowsMultipleSelection: true,
    });

    if (!result.canceled && result.assets) {
      result.assets.forEach(addFileToState);
    }
  };

  // Capture photo directly using camera
  const takePhoto = async () => {
    const { status } = await ImagePicker.requestCameraPermissionsAsync();
    if (status !== 'granted') {
      Alert.alert('Lá»—i', 'Cáº§n quyá»n truy cáº­p camera.');
      return;
    }

    const result = await ImagePicker.launchCameraAsync({ quality: 0.7 });

    if (!result.canceled) {
      addFileToState(result.assets[0]);
    }
  };

  const removeFile = (file) => {
    Alert.alert('XÃ¡c nháº­n', 'XÃ³a áº£nh nÃ y?', [
      { text: 'Há»§y', style: 'cancel' },
      {
        text: 'XÃ³a',
        style: 'destructive',
        onPress: () => {
          setFiles((prev) => prev.filter((f) => f.uri !== file.uri));
        },
      },
    ]);
  };

  const viewFile = (file) => {
    if (file.url) {
      Linking.openURL(file.url).catch(() =>
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ má»Ÿ tá»‡p.')
      );
    }
  };

  const handleConfirm = async () => {
    if (files.length === 0) {
      Alert.alert('Thiáº¿u áº£nh', 'Vui lÃ²ng chá»n Ã­t nháº¥t má»™t áº£nh Ä‘á»ƒ xÃ¡c nháº­n.');
      return;
    }

    setSaving(true);
    try {
      console.log('[ConfirmPOScreen] Starting confirmation process');
      console.log('[ConfirmPOScreen] Files count:', files.length);
      // Chuáº©n bá»‹ máº£ng file Ä‘á»ƒ upload
      const filesToUpload = await Promise.all(
        files.map(async (file, index) => {
          console.log(
            `[ConfirmPOScreen] Processing file ${index + 1}/${files.length}: ${
              file.name
            }`
          );
          // Äá»c base64 cho má»—i file
          const base64Data = await FileSystem.readAsStringAsync(file.uri, {
            encoding: FileSystem.EncodingType.Base64,
          });
          console.log(
            `[ConfirmPOScreen] File ${index + 1} base64 data length: ${
              base64Data.length
            }`
          );
          return {
            base64Data,
            fileName: file.name,
            mimeType: file.mimeType || 'image/jpeg',
          };
        })
      );

      console.log(
        '[ConfirmPOScreen] All files prepared, calling confirmReceipt'
      );
      console.log('[ConfirmPOScreen] PO ID:', po.id);
      console.log('[ConfirmPOScreen] Project ID:', po.projectId);

      await confirmReceipt({
        poId: po.id,
        projectId: po.projectId,
        files: filesToUpload,
        remarks,
      });

      console.log('[ConfirmPOScreen] Confirmation successful');
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ xÃ¡c nháº­n nháº­n hÃ ng thÃ nh cÃ´ng.');
      navigation.goBack();
    } catch (e) {
      console.error('[ConfirmPOScreen] Confirmation error:', e);
      // Lá»—i Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ vÃ  hiá»ƒn thá»‹ bá»Ÿi hook, khÃ´ng cáº§n lÃ m gÃ¬ thÃªm á»Ÿ Ä‘Ã¢y.
      console.log(
        'Handle confirm caught an error, but it should have been handled by the hook.'
      );
    } finally {
      setSaving(false);
    }
  };

  const renderMaterial = ({ item, index }) => (
    <View style={styles.materialRow}>
      <Text style={{ flex: 1 }}>
        {index + 1}. {item.name}
      </Text>
      <Text style={{ width: 80, textAlign: 'right' }}>
        {item.quantity} {item.unit}
      </Text>
    </View>
  );

  return (
    <ScrollView style={styles.container}>
      <Text style={styles.title}>PO: {po.poNumber || po.id}</Text>
      <Text style={styles.label}>NhÃ  cung cáº¥p: {po.supplierName}</Text>
      <Text style={styles.label}>
        NgÃ y táº¡o:{' '}
        {po.createdAt?.seconds
          ? new Date(po.createdAt.seconds * 1000).toLocaleDateString('vi-VN')
          : ''}
      </Text>

      <Text style={[styles.sectionTitle, { marginTop: 12 }]}>Váº­t tÆ°</Text>
      <FlatList
        data={po.materials || []}
        keyExtractor={(_, idx) => idx.toString()}
        renderItem={renderMaterial}
        scrollEnabled={false}
      />

      <Text style={[styles.sectionTitle, { marginTop: 12 }]}>áº¢nh xÃ¡c nháº­n</Text>

      {loading && uploadProgress > 0 && (
        <View style={styles.progressContainer}>
          {Platform.OS === 'android' ? (
            <ProgressBarAndroid
              styleAttr="Horizontal"
              indeterminate={false}
              progress={uploadProgress / 100}
              style={styles.progressBar}
            />
          ) : (
            <ProgressViewIOS
              progress={uploadProgress / 100}
              style={styles.progressBar}
            />
          )}
          <Text style={styles.progressText}>
            Äang táº£i lÃªn... {Math.round(uploadProgress)}%
          </Text>
        </View>
      )}

      <View style={styles.imagesContainer}>
        {files.map((file, idx) => (
          <View key={idx} style={styles.fileContainer}>
            <TouchableOpacity
              style={styles.fileThumb}
              onPress={() => viewFile(file)}
            >
              <Image source={{ uri: file.uri }} style={styles.imageThumb} />
              {file.isUploading && (
                <View style={styles.uploadingOverlay}>
                  <ActivityIndicator color="#fff" size="small" />
                </View>
              )}
            </TouchableOpacity>
            <TouchableOpacity
              style={styles.removeBtn}
              onPress={() => removeFile(file)}
            >
              <Ionicons name="close-circle" size={20} color="#ff4444" />
            </TouchableOpacity>
          </View>
        ))}
        <TouchableOpacity style={styles.addImage} onPress={pickFile}>
          <Ionicons name="add" size={28} color="#777" />
        </TouchableOpacity>

        <TouchableOpacity style={styles.addImage} onPress={takePhoto}>
          <Ionicons name="camera" size={26} color="#777" />
        </TouchableOpacity>
      </View>

      <Text style={[styles.sectionTitle, { marginTop: 12 }]}>Ghi chÃº</Text>
      <TextInput
        style={styles.remarksInput}
        placeholder="Ghi chÃº thÃªm..."
        value={remarks}
        onChangeText={setRemarks}
        multiline
      />

      <TouchableOpacity
        style={[styles.confirmBtn, (loading || saving) && { opacity: 0.7 }]}
        onPress={handleConfirm}
        disabled={loading || saving}
      >
        {loading || saving ? (
          <ActivityIndicator color="#fff" />
        ) : (
          <Ionicons name="checkmark-circle-outline" size={20} color="#fff" />
        )}
        <Text style={styles.confirmText}>XÃ¡c nháº­n</Text>
      </TouchableOpacity>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1, padding: 16, backgroundColor: '#fff' },
  centered: { flex: 1, justifyContent: 'center', alignItems: 'center' },
  title: { fontSize: 18, fontWeight: 'bold' },
  label: { fontSize: 14, marginTop: 4 },
  sectionTitle: { fontSize: 16, fontWeight: '600' },
  materialRow: {
    flexDirection: 'row',
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    paddingVertical: 6,
  },
  imagesContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    marginTop: 8,
  },
  fileContainer: {
    position: 'relative',
    marginRight: 8,
    marginBottom: 8,
  },
  fileThumb: {
    width: 80,
    height: 80,
    borderRadius: 4,
    overflow: 'hidden',
  },
  imageThumb: {
    width: 80,
    height: 80,
    borderRadius: 4,
  },
  uploadingOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: 'rgba(0,0,0,0.4)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  removeBtn: {
    position: 'absolute',
    top: -8,
    right: -8,
    backgroundColor: '#fff',
    borderRadius: 10,
    elevation: 2,
    shadowColor: '#000',
    shadowOpacity: 0.2,
    shadowOffset: { width: 0, height: 1 },
    shadowRadius: 2,
  },
  addImage: {
    width: 80,
    height: 80,
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 4,
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 8,
    marginRight: 8,
  },
  remarksInput: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 4,
    padding: 8,
    minHeight: 80,
    textAlignVertical: 'top',
    marginTop: 4,
  },
  progressContainer: {
    marginVertical: 10,
  },
  progressBar: {
    height: 6,
    marginBottom: 4,
  },
  progressText: {
    fontSize: 12,
    color: '#666',
    textAlign: 'center',
  },
  confirmBtn: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#28a745',
    paddingVertical: 12,
    borderRadius: 6,
    marginTop: 20,
  },
  confirmText: {
    color: '#fff',
    fontSize: 16,
    marginLeft: 8,
    fontWeight: '600',
  },
});

export default ConfirmPOReceiptScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\CreatePOScreen.js ---

import React, { useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  TextInput,
  Alert,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useRoute, useNavigation } from '@react-navigation/native';
import SupplierPickerModal from '../components/SupplierPickerModal';
import usePurchaseOrderGenerator from '../hooks/usePurchaseOrderGenerator';

/**
 * CreatePOScreen
 * This is a simplified screen that pre-populates the material list coming
 * from route.params (passed from ProposalListScreen â†’ navigate('CreatePO', params)).
 * For now we only allow editing quantity / price; supplier info can be added later.
 */
const CreatePOScreen = () => {
  const route = useRoute();
  const navigation = useNavigation();

  // Supplier state & modal visibility
  const [showSupplierModal, setShowSupplierModal] = useState(false);
  const [supplier, setSupplier] = useState(null);

  // New state for PO info
  const [poNumber, setPoNumber] = useState('');
  const [proposalNumber, setProposalNumber] = useState('');
  const [deliveryTime, setDeliveryTime] = useState('');

  // VAT percentage
  const [vatPercentage, setVatPercentage] = useState(10);

  // Purchase order generator hook
  const { generatePurchaseOrder, loading } = usePurchaseOrderGenerator();

  const {
    projectName = '',
    projectId = '',
    materials: initMaterials = [],
  } = route.params || {};

  const [materials, setMaterials] = useState(
    initMaterials.length > 0
      ? initMaterials.map((m) => ({
          ...m,
          quantity: m.quantity?.toString() || '',
          unitPrice: m.unitPrice?.toString() || '',
        }))
      : [
          {
            name: '',
            specs: '',
            unit: '',
            quantity: '',
            unitPrice: '',
          },
        ]
  );

  const handleMaterialChange = (index, field, value) => {
    const updated = [...materials];
    updated[index] = { ...updated[index], [field]: value };
    setMaterials(updated);
  };

  const handleAddMaterial = () => {
    setMaterials([
      ...materials,
      { name: '', specs: '', unit: '', quantity: '', unitPrice: '' },
    ]);
  };

  const handleRemoveMaterial = (index) => {
    if (materials.length === 1) return;
    const updated = [...materials];
    updated.splice(index, 1);
    setMaterials(updated);
  };

  const subtotal = materials.reduce((sum, item) => {
    const qty = parseFloat(item.quantity) || 0;
    const price = parseFloat(item.unitPrice) || 0;
    return sum + qty * price;
  }, 0);

  const vatAmount = (subtotal * vatPercentage) / 100;
  const grandTotal = subtotal + vatAmount;

  const handleGeneratePO = async () => {
    if (!supplier) {
      Alert.alert('Thiáº¿u thÃ´ng tin', 'Vui lÃ²ng chá»n NhÃ  cung cáº¥p');
      return;
    }

    console.log('Starting PO generation for project ID:', projectId);

    const poData = {
      projectName,
      supplierName: supplier.name,
      supplierAddress: supplier.address || '',
      supplierPhone: supplier.phone || '',
      supplierEmail: supplier.email || '',
      supplierTaxCode: supplier.taxCode || '',
      materials,
      vatPercentage,
      // Add new fields
      poNumber,
      proposalNumber,
      deliveryTime,
    };

    try {
      console.log(
        'Calling generatePurchaseOrder with data:',
        JSON.stringify({
          projectId,
          supplierName: supplier.name,
          materialsCount: materials.length,
        })
      );

      const result = await generatePurchaseOrder(poData, projectId);
      console.log('PO generation successful, result:', result);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ táº¡o Ä‘Æ¡n Ä‘áº·t hÃ ng');
      navigation.goBack();
    } catch (err) {
      console.error('Error in handleGeneratePO:', err);
      // error is already handled in the hook
    }
  };

  return (
    <ScrollView style={styles.container}>
      <SupplierPickerModal
        visible={showSupplierModal}
        onClose={() => setShowSupplierModal(false)}
        onSelect={(sup) => {
          setSupplier(sup);
        }}
      />
      <Text style={styles.title}>Táº¡o PO cho dá»± Ã¡n: {projectName}</Text>

      {/* Supplier selection */}
      <View style={styles.supplierGroup}>
        <Text style={styles.label}>NhÃ  cung cáº¥p</Text>
        <TouchableOpacity
          style={styles.selectButton}
          onPress={() => setShowSupplierModal(true)}
        >
          <Text style={styles.selectText}>
            {supplier ? supplier.name : 'Chá»n nhÃ  cung cáº¥p'}
          </Text>
        </TouchableOpacity>
        {supplier && (
          <View style={{ marginTop: 4 }}>
            {supplier.address ? (
              <Text style={styles.supplierInfo}>{supplier.address}</Text>
            ) : null}
            {supplier.phone ? (
              <Text style={styles.supplierInfo}>ÄT: {supplier.phone}</Text>
            ) : null}
          </View>
        )}
      </View>

      {/* PO Info Inputs */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>Sá»‘ Ä‘Æ¡n Ä‘áº·t hÃ ng</Text>
        <TextInput
          style={styles.inputField}
          placeholder="Nháº­p sá»‘ ÄÄH (vÃ­ dá»¥: PO-001)"
          value={poNumber}
          onChangeText={setPoNumber}
        />
      </View>
      <View style={styles.inputGroup}>
        <Text style={styles.label}>Sá»‘ Ä‘á» xuáº¥t</Text>
        <TextInput
          style={styles.inputField}
          placeholder="Nháº­p sá»‘ Ä‘á» xuáº¥t Ä‘Æ°á»£c duyá»‡t"
          value={proposalNumber}
          onChangeText={setProposalNumber}
        />
      </View>
      <View style={styles.inputGroup}>
        <Text style={styles.label}>Thá»i gian giao hÃ ng</Text>
        <TextInput
          style={styles.inputField}
          placeholder="Nháº­p thá»i gian giao hÃ ng (vÃ­ dá»¥: 3-5 ngÃ y)"
          value={deliveryTime}
          onChangeText={setDeliveryTime}
        />
      </View>

      {/* Materials list */}
      <View style={styles.sectionHeader}>
        <Text style={styles.sectionHeaderText}>Danh sÃ¡ch váº­t tÆ°</Text>
        <TouchableOpacity onPress={handleAddMaterial} style={styles.addBtn}>
          <Ionicons name="add-circle" size={22} color="#4CAF50" />
        </TouchableOpacity>
      </View>

      {materials.map((mat, idx) => {
        const total = (
          (parseFloat(mat.quantity) || 0) * (parseFloat(mat.unitPrice) || 0)
        ).toLocaleString('vi-VN');
        return (
          <View key={idx} style={styles.row}>
            <TextInput
              style={[styles.input, { flex: 3 }]}
              placeholder="TÃªn váº­t tÆ°"
              value={mat.name}
              onChangeText={(t) => handleMaterialChange(idx, 'name', t)}
            />
            <TextInput
              style={[styles.input, { flex: 1 }]}
              placeholder="SL"
              keyboardType="numeric"
              value={mat.quantity}
              onChangeText={(t) => handleMaterialChange(idx, 'quantity', t)}
            />
            <TextInput
              style={[styles.input, { flex: 2 }]}
              placeholder="ÄÆ¡n giÃ¡"
              keyboardType="numeric"
              value={mat.unitPrice}
              onChangeText={(t) => handleMaterialChange(idx, 'unitPrice', t)}
            />
            <Text style={[styles.total, { flex: 2 }]}>{total}</Text>
            <TouchableOpacity onPress={() => handleRemoveMaterial(idx)}>
              <Ionicons name="trash-outline" size={18} color="red" />
            </TouchableOpacity>
          </View>
        );
      })}

      {/* Summary */}
      <View style={{ marginTop: 12 }}>
        <Text style={styles.summary}>
          Táº¡m tÃ­nh: {subtotal.toLocaleString('vi-VN')} VND
        </Text>
        <View
          style={{ flexDirection: 'row', alignItems: 'center', marginTop: 6 }}
        >
          <Text style={styles.summary}>VAT (%) :</Text>
          <TextInput
            style={[styles.input, { width: 60, marginLeft: 6 }]}
            keyboardType="numeric"
            value={vatPercentage.toString()}
            onChangeText={(v) => setVatPercentage(parseFloat(v) || 0)}
          />
          <Text style={[styles.summary, { marginLeft: 6 }]}>
            {' '}
            = {vatAmount.toLocaleString('vi-VN')} VND
          </Text>
        </View>
        <Text style={styles.summary}>
          Tá»•ng cá»™ng: {grandTotal.toLocaleString('vi-VN')} VND
        </Text>
      </View>

      <TouchableOpacity
        style={styles.button}
        onPress={handleGeneratePO}
        disabled={loading}
      >
        <Ionicons name="document-text-outline" size={20} color="#fff" />
        <Text style={styles.buttonText}>Táº¡o Ä‘Æ¡n Ä‘áº·t hÃ ng</Text>
      </TouchableOpacity>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1, padding: 16, backgroundColor: '#fff' },
  title: { fontSize: 18, fontWeight: 'bold', marginBottom: 12 },
  sectionHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 8,
    marginTop: 16,
  },
  sectionHeaderText: { fontSize: 16, fontWeight: '600', flex: 1 },
  addBtn: { padding: 4 },
  row: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 4,
    paddingVertical: 2,
  },
  input: {
    borderWidth: 1,
    borderColor: '#ccc',
    padding: 6,
    borderRadius: 4,
    marginHorizontal: 2,
  },
  total: {
    textAlign: 'right',
    paddingHorizontal: 4,
    fontWeight: '500',
  },
  summary: {
    fontSize: 16,
    fontWeight: '500',
    color: '#333',
  },
  button: {
    marginTop: 20,
    backgroundColor: '#4CAF50',
    padding: 14,
    borderRadius: 8,
    alignItems: 'center',
    flexDirection: 'row',
    justifyContent: 'center',
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
    marginLeft: 8,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    marginBottom: 4,
    color: '#444',
  },
  supplierGroup: {
    borderWidth: 1,
    borderColor: '#ddd',
    padding: 12,
    borderRadius: 8,
    marginBottom: 12,
  },
  selectButton: {
    borderWidth: 1,
    borderColor: '#ccc',
    padding: 12,
    borderRadius: 4,
  },
  selectText: { fontSize: 16 },
  supplierInfo: { fontSize: 13, color: '#666' },
  inputGroup: {
    marginBottom: 12,
  },
  inputField: {
    borderWidth: 1,
    borderColor: '#ccc',
    padding: 12,
    borderRadius: 4,
    fontSize: 16,
  },
});

export default CreatePOScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\CreateProposalScreen.js ---

// src/screens/CreateProposalScreen.js
import React, { useState } from 'react';
import {
  View,
  Text,
  FlatList,
  TouchableOpacity,
  Alert,
  StyleSheet,
  TextInput,
  ScrollView,
  Platform,
} from 'react-native';
import { createProposal, canCreateProposal } from '../api/proposalService';
import { useAuth } from '../contexts/AuthContext';
import DateTimePicker from '@react-native-community/datetimepicker';
import { Ionicons } from '@expo/vector-icons';

const CreateProposalScreen = ({ route, navigation }) => {
  const { projectId, projectName, selectedItems } = route.params;
  const { currentUser } = useAuth();
  const [saving, setSaving] = useState(false);

  // CÃ¡c trÆ°á»ng má»›i
  const [proposalNumber, setProposalNumber] = useState('');
  const [requiredDate, setRequiredDate] = useState(new Date());
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [priority, setPriority] = useState('normal'); // 'normal' hoáº·c 'urgent'
  const [purpose, setPurpose] = useState('');

  // Kiá»ƒm tra quyá»n táº¡o Ä‘á» xuáº¥t
  if (!canCreateProposal(currentUser?.role)) {
    Alert.alert('KhÃ´ng cÃ³ quyá»n', 'Báº¡n khÃ´ng cÃ³ quyá»n táº¡o Ä‘á» xuáº¥t mua váº­t tÆ°');
    navigation.goBack();
  }

  const handleDateChange = (event, selectedDate) => {
    setShowDatePicker(Platform.OS === 'ios');
    if (selectedDate) {
      setRequiredDate(selectedDate);
    }
  };

  const handleSubmit = async () => {
    // Validate
    if (!proposalNumber.trim()) {
      return Alert.alert('Thiáº¿u thÃ´ng tin', 'Vui lÃ²ng nháº­p sá»‘ Ä‘á» xuáº¥t');
    }

    if (!purpose.trim()) {
      return Alert.alert('Thiáº¿u thÃ´ng tin', 'Vui lÃ²ng nháº­p má»¥c Ä‘Ã­ch sá»­ dá»¥ng');
    }

    const proposalCode = `THP/KT/25/${proposalNumber}`;

    setSaving(true);
    try {
      await createProposal({
        projectId,
        projectName,
        items: selectedItems,
        createdBy: currentUser.uid,
        createdByName: currentUser.displayName || currentUser.email,
        proposalCode,
        requiredDate,
        priority,
        purpose,
      });
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ gá»­i Ä‘á» xuáº¥t.');
      navigation.goBack();
    } catch (err) {
      Alert.alert('Lá»—i', err.message);
    } finally {
      setSaving(false);
    }
  };

  const renderItem = ({ item }) => (
    <View style={styles.row}>
      <Text style={styles.name}>{item.name}</Text>
      <Text style={styles.qty}>{item.quantity}</Text>
      <Text style={styles.unit}>{item.unit}</Text>
    </View>
  );

  return (
    <ScrollView style={styles.container}>
      <Text style={styles.title}>Äá» xuáº¥t mua váº­t tÆ° - {projectName}</Text>

      {/* Form thÃ´ng tin Ä‘á» xuáº¥t */}
      <View style={styles.formSection}>
        <Text style={styles.sectionTitle}>ThÃ´ng tin Ä‘á» xuáº¥t</Text>

        <View style={styles.formGroup}>
          <Text style={styles.label}>MÃ£ Ä‘á» xuáº¥t</Text>
          <View style={styles.codeInputContainer}>
            <Text style={styles.codePrefix}>THP/KT/25/</Text>
            <TextInput
              style={styles.codeInput}
              value={proposalNumber}
              onChangeText={setProposalNumber}
              placeholder="Nháº­p sá»‘"
              keyboardType="numeric"
            />
          </View>
        </View>

        <View style={styles.formGroup}>
          <Text style={styles.label}>NgÃ y cáº§n cung cáº¥p</Text>
          <TouchableOpacity
            style={styles.dateButton}
            onPress={() => setShowDatePicker(true)}
          >
            <Text style={styles.dateText}>
              {requiredDate.toLocaleDateString('vi-VN')}
            </Text>
            <Ionicons name="calendar-outline" size={20} color="#666" />
          </TouchableOpacity>
          {showDatePicker && (
            <DateTimePicker
              value={requiredDate}
              mode="date"
              display={Platform.OS === 'ios' ? 'spinner' : 'default'}
              onChange={handleDateChange}
              minimumDate={new Date()}
            />
          )}
        </View>

        <View style={styles.formGroup}>
          <Text style={styles.label}>Má»©c Ä‘á»™ Æ°u tiÃªn</Text>
          <View style={styles.priorityContainer}>
            <TouchableOpacity
              style={[
                styles.priorityButton,
                priority === 'normal' && styles.priorityButtonActive,
              ]}
              onPress={() => setPriority('normal')}
            >
              <Text
                style={[
                  styles.priorityText,
                  priority === 'normal' && styles.priorityTextActive,
                ]}
              >
                BÃ¬nh thÆ°á»ng
              </Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[
                styles.priorityButton,
                priority === 'urgent' && styles.priorityButtonActive,
                priority === 'urgent' && { backgroundColor: '#ffebee' },
              ]}
              onPress={() => setPriority('urgent')}
            >
              <Text
                style={[
                  styles.priorityText,
                  priority === 'urgent' && styles.priorityTextActive,
                  priority === 'urgent' && { color: '#d32f2f' },
                ]}
              >
                Gáº¥p
              </Text>
            </TouchableOpacity>
          </View>
        </View>

        <View style={styles.formGroup}>
          <Text style={styles.label}>Má»¥c Ä‘Ã­ch sá»­ dá»¥ng</Text>
          <TextInput
            style={styles.purposeInput}
            value={purpose}
            onChangeText={setPurpose}
            placeholder="Nháº­p má»¥c Ä‘Ã­ch sá»­ dá»¥ng váº­t tÆ°"
            multiline
            numberOfLines={3}
          />
        </View>
      </View>

      {/* Danh sÃ¡ch váº­t tÆ° */}
      <View style={styles.materialsSection}>
        <Text style={styles.sectionTitle}>
          Danh sÃ¡ch váº­t tÆ° ({selectedItems.length})
        </Text>
        <View style={styles.tableHeader}>
          <Text style={[styles.headerText, { flex: 3 }]}>TÃªn váº­t tÆ°</Text>
          <Text style={[styles.headerText, { flex: 1, textAlign: 'center' }]}>
            SL
          </Text>
          <Text style={[styles.headerText, { flex: 1, textAlign: 'center' }]}>
            ÄVT
          </Text>
        </View>
        <FlatList
          data={selectedItems}
          keyExtractor={(i, idx) => idx.toString()}
          renderItem={renderItem}
          nestedScrollEnabled
          style={{ maxHeight: 300 }}
        />
      </View>

      <TouchableOpacity
        style={styles.submitBtn}
        onPress={handleSubmit}
        disabled={saving}
      >
        <Text style={styles.btnText}>
          {saving ? 'Äang gá»­i...' : 'Gá»­i Duyá»‡t'}
        </Text>
      </TouchableOpacity>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
    backgroundColor: '#f5f5f5',
  },
  title: {
    fontSize: 18,
    fontWeight: '700',
    marginBottom: 16,
  },
  formSection: {
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  materialsSection: {
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 12,
    color: '#333',
  },
  formGroup: {
    marginBottom: 16,
  },
  label: {
    fontSize: 14,
    marginBottom: 8,
    color: '#555',
  },
  codeInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 4,
    overflow: 'hidden',
  },
  codePrefix: {
    backgroundColor: '#f0f0f0',
    paddingHorizontal: 8,
    paddingVertical: 10,
    fontSize: 14,
  },
  codeInput: {
    flex: 1,
    paddingHorizontal: 8,
    paddingVertical: 8,
    fontSize: 14,
  },
  dateButton: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 4,
    padding: 10,
  },
  dateText: {
    fontSize: 14,
  },
  priorityContainer: {
    flexDirection: 'row',
    gap: 12,
  },
  priorityButton: {
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 4,
    borderWidth: 1,
    borderColor: '#ddd',
    backgroundColor: '#f9f9f9',
  },
  priorityButtonActive: {
    borderColor: '#0066cc',
    backgroundColor: '#e6f2ff',
  },
  priorityText: {
    color: '#666',
  },
  priorityTextActive: {
    color: '#0066cc',
    fontWeight: '500',
  },
  purposeInput: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 4,
    padding: 10,
    fontSize: 14,
    textAlignVertical: 'top',
    minHeight: 80,
  },
  tableHeader: {
    flexDirection: 'row',
    paddingVertical: 8,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    marginBottom: 4,
  },
  headerText: {
    fontWeight: '600',
    fontSize: 14,
    color: '#555',
  },
  row: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingVertical: 8,
    borderBottomWidth: 1,
    borderColor: '#eee',
  },
  name: { flex: 3 },
  qty: { flex: 1, textAlign: 'center' },
  unit: { flex: 1, textAlign: 'center' },
  submitBtn: {
    backgroundColor: '#0066cc',
    padding: 14,
    borderRadius: 8,
    alignItems: 'center',
    marginTop: 8,
    marginBottom: 20,
  },
  btnText: {
    color: '#fff',
    fontWeight: '600',
    fontSize: 16,
  },
});

export default CreateProposalScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\CustomerDetailScreen.js ---

//src/screens/CustomerDetailScreen.js
import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  Alert,
  Share,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { getCustomerById, deleteCustomer } from '../api/customerService';
import { useFocusEffect } from '@react-navigation/native';

const CustomerDetailScreen = ({ route, navigation }) => {
  const { customerId } = route.params;
  const [customer, setCustomer] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isDeleting, setIsDeleting] = useState(false);

  // HÃ m láº¥y dá»¯ liá»‡u khÃ¡ch hÃ ng
  const fetchCustomerData = async () => {
    try {
      setLoading(true);
      setError(null);
      const data = await getCustomerById(customerId);

      if (data) {
        setCustomer(data);
      } else {
        setError('KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin khÃ¡ch hÃ ng');
      }
    } catch (err) {
      console.error('Lá»—i khi táº£i thÃ´ng tin khÃ¡ch hÃ ng:', err);
      setError('KhÃ´ng thá»ƒ táº£i thÃ´ng tin khÃ¡ch hÃ ng. Vui lÃ²ng thá»­ láº¡i sau.');
    } finally {
      setLoading(false);
    }
  };

  // Láº¥y dá»¯ liá»‡u khÃ¡ch hÃ ng khi mÃ n hÃ¬nh Ä‘Æ°á»£c táº£i
  useEffect(() => {
    fetchCustomerData();
  }, [customerId]);

  // LÃ m má»›i dá»¯ liá»‡u khi mÃ n hÃ¬nh Ä‘Æ°á»£c focus (quay láº¡i sau khi chá»‰nh sá»­a)
  useFocusEffect(
    useCallback(() => {
      fetchCustomerData();
    }, [customerId])
  );

  // Láº¥y nhÃ£n hiá»ƒn thá»‹ cho loáº¡i khÃ¡ch hÃ ng
  const getTypeLabel = (type) => {
    switch (type) {
      case 'vip':
        return 'VIP';
      case 'potential':
        return 'Tiá»m nÄƒng';
      case 'regular':
        return 'ThÆ°á»ng xuyÃªn';
      default:
        return type || 'ChÆ°a phÃ¢n loáº¡i';
    }
  };

  // Láº¥y mÃ u cho loáº¡i khÃ¡ch hÃ ng
  const getTypeColor = (type) => {
    switch (type) {
      case 'vip':
        return '#4CAF50'; // xanh lÃ¡
      case 'potential':
        return '#FF9800'; // cam
      default:
        return '#9E9E9E'; // xÃ¡m
    }
  };

  // Xá»­ lÃ½ chia sáº» thÃ´ng tin khÃ¡ch hÃ ng
  const handleShare = async () => {
    if (!customer) return;

    try {
      const message = `
ThÃ´ng tin khÃ¡ch hÃ ng:
TÃªn: ${customer.name || 'KhÃ´ng cÃ³'}
NgÆ°á»i liÃªn há»‡: ${customer.contactPerson || 'KhÃ´ng cÃ³'}
Äiá»‡n thoáº¡i: ${customer.phone || 'KhÃ´ng cÃ³'}
Email: ${customer.email || 'KhÃ´ng cÃ³'}
Äá»‹a chá»‰: ${customer.address || 'KhÃ´ng cÃ³'}
Loáº¡i khÃ¡ch hÃ ng: ${getTypeLabel(customer.type)}
      `;

      await Share.share({
        message,
        title: `ThÃ´ng tin khÃ¡ch hÃ ng: ${customer.name}`,
      });
    } catch (error) {
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ chia sáº» thÃ´ng tin khÃ¡ch hÃ ng');
    }
  };

  // Xá»­ lÃ½ chá»‰nh sá»­a khÃ¡ch hÃ ng
  const handleEdit = () => {
    navigation.navigate('EditCustomer', { customer });
  };

  // Xá»­ lÃ½ xÃ³a khÃ¡ch hÃ ng
  const handleDelete = () => {
    Alert.alert(
      'XÃ¡c nháº­n xÃ³a',
      'Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a khÃ¡ch hÃ ng nÃ y khÃ´ng?',
      [
        { text: 'Há»§y', style: 'cancel' },
        {
          text: 'XÃ³a',
          style: 'destructive',
          onPress: async () => {
            try {
              setIsDeleting(true);
              await deleteCustomer(customer.id);
              Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ xÃ³a khÃ¡ch hÃ ng thÃ nh cÃ´ng', [
                {
                  text: 'OK',
                  onPress: () => navigation.goBack(),
                },
              ]);
            } catch (error) {
              if (error.code === 'permission-denied') {
                Alert.alert(
                  'Lá»—i quyá»n',
                  'Báº¡n khÃ´ng cÃ³ Ä‘á»§ quyá»n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y.'
                );
              } else {
                console.error('Lá»—i khi xÃ³a khÃ¡ch hÃ ng:', error);
                Alert.alert(
                  'Lá»—i',
                  'KhÃ´ng thá»ƒ xÃ³a khÃ¡ch hÃ ng. Vui lÃ²ng thá»­ láº¡i sau.'
                );
              }
              setIsDeleting(false);
            }
          },
        },
      ]
    );
  };

  // Hiá»ƒn thá»‹ khi Ä‘ang táº£i dá»¯ liá»‡u
  if (loading) {
    return (
      <View style={styles.centerContainer}>
        <ActivityIndicator size="large" color="#0066cc" />
        <Text style={styles.loadingText}>Äang táº£i thÃ´ng tin khÃ¡ch hÃ ng...</Text>
      </View>
    );
  }

  // Hiá»ƒn thá»‹ khi cÃ³ lá»—i
  if (error) {
    return (
      <View style={styles.centerContainer}>
        <Ionicons name="alert-circle-outline" size={50} color="#FF3B30" />
        <Text style={styles.errorText}>{error}</Text>
        <TouchableOpacity
          style={styles.retryButton}
          onPress={() => navigation.goBack()}
        >
          <Text style={styles.retryButtonText}>Quay láº¡i</Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Hiá»ƒn thá»‹ khi khÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng
  if (!customer) {
    return (
      <View style={styles.centerContainer}>
        <Ionicons name="person-outline" size={50} color="#999" />
        <Text style={styles.errorText}>
          KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin khÃ¡ch hÃ ng
        </Text>
        <TouchableOpacity
          style={styles.retryButton}
          onPress={() => navigation.goBack()}
        >
          <Text style={styles.retryButtonText}>Quay láº¡i</Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Äá»‹nh dáº¡ng ngÃ y thÃ¡ng
  const formatDate = (timestamp) => {
    if (!timestamp) return 'KhÃ´ng cÃ³';

    const date = new Date(timestamp.seconds * 1000);
    return date.toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  return (
    <View style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Ionicons name="arrow-back" size={24} color="#333" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Chi tiáº¿t khÃ¡ch hÃ ng</Text>
        <TouchableOpacity style={styles.shareButton} onPress={handleShare}>
          <Ionicons name="share-outline" size={24} color="#333" />
        </TouchableOpacity>
      </View>

      <ScrollView style={styles.contentContainer}>
        <View style={styles.customerHeader}>
          <View style={styles.customerNameContainer}>
            <Text style={styles.customerName}>
              {customer.name || 'ChÆ°a cÃ³ tÃªn'}
            </Text>
            <View
              style={[
                styles.customerTypeTag,
                { borderColor: getTypeColor(customer.type) },
              ]}
            >
              <Text
                style={[
                  styles.customerTypeText,
                  { color: getTypeColor(customer.type) },
                ]}
              >
                {getTypeLabel(customer.type)}
              </Text>
            </View>
          </View>
        </View>

        <View style={styles.infoSection}>
          <View style={styles.infoItem}>
            <Text style={styles.infoLabel}>NgÆ°á»i liÃªn há»‡</Text>
            <Text style={styles.infoValue}>
              {customer.contactPerson || 'ChÆ°a cÃ³ thÃ´ng tin'}
            </Text>
          </View>

          <View style={styles.infoItem}>
            <Text style={styles.infoLabel}>Sá»‘ Ä‘iá»‡n thoáº¡i</Text>
            <View style={styles.infoValueWithIcon}>
              <Text style={styles.infoValue}>
                {customer.phone || 'ChÆ°a cÃ³ thÃ´ng tin'}
              </Text>
              {customer.phone && (
                <TouchableOpacity style={styles.actionIcon}>
                  <Ionicons name="call-outline" size={20} color="#0066cc" />
                </TouchableOpacity>
              )}
            </View>
          </View>

          <View style={styles.infoItem}>
            <Text style={styles.infoLabel}>Email</Text>
            <View style={styles.infoValueWithIcon}>
              <Text style={styles.infoValue}>
                {customer.email || 'ChÆ°a cÃ³ thÃ´ng tin'}
              </Text>
              {customer.email && (
                <TouchableOpacity style={styles.actionIcon}>
                  <Ionicons name="mail-outline" size={20} color="#0066cc" />
                </TouchableOpacity>
              )}
            </View>
          </View>

          <View style={styles.infoItem}>
            <Text style={styles.infoLabel}>Äá»‹a chá»‰</Text>
            <Text style={styles.infoValue}>
              {customer.address || 'ChÆ°a cÃ³ thÃ´ng tin'}
            </Text>
          </View>

          <View style={styles.infoItem}>
            <Text style={styles.infoLabel}>MÃ£ sá»‘ thuáº¿</Text>
            <Text style={styles.infoValue}>
              {customer.taxCode || 'ChÆ°a cÃ³ thÃ´ng tin'}
            </Text>
          </View>
        </View>

        <View style={styles.metaSection}>
          <Text style={styles.metaSectionTitle}>ThÃ´ng tin bá»• sung</Text>

          <View style={styles.metaItem}>
            <Text style={styles.metaLabel}>NgÃ y táº¡o</Text>
            <Text style={styles.metaValue}>
              {formatDate(customer.createdAt)}
            </Text>
          </View>

          <View style={styles.metaItem}>
            <Text style={styles.metaLabel}>Cáº­p nháº­t láº§n cuá»‘i</Text>
            <Text style={styles.metaValue}>
              {formatDate(customer.updatedAt)}
            </Text>
          </View>
        </View>
      </ScrollView>

      <View style={styles.footer}>
        <View style={styles.buttonContainer}>
          <TouchableOpacity
            style={styles.deleteButton}
            onPress={handleDelete}
            disabled={isDeleting}
          >
            {isDeleting ? (
              <ActivityIndicator color="#fff" size="small" />
            ) : (
              <>
                <Ionicons name="trash-outline" size={20} color="#fff" />
                <Text style={styles.deleteButtonText}>XÃ³a</Text>
              </>
            )}
          </TouchableOpacity>

          <TouchableOpacity style={styles.editButton} onPress={handleEdit}>
            <Ionicons name="create-outline" size={20} color="#fff" />
            <Text style={styles.editButtonText}>Chá»‰nh sá»­a</Text>
          </TouchableOpacity>
        </View>
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  centerContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  loadingText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
  },
  errorText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  retryButton: {
    marginTop: 16,
    backgroundColor: '#0066cc',
    paddingHorizontal: 20,
    paddingVertical: 10,
    borderRadius: 6,
  },
  retryButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '500',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  shareButton: {
    padding: 4,
  },
  contentContainer: {
    flex: 1,
  },
  customerHeader: {
    backgroundColor: '#fff',
    padding: 16,
    marginBottom: 12,
  },
  customerNameContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  customerName: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#333',
    flex: 1,
  },
  customerTypeTag: {
    borderWidth: 1,
    borderRadius: 12,
    paddingHorizontal: 10,
    paddingVertical: 3,
  },
  customerTypeText: {
    fontSize: 12,
    fontWeight: '500',
  },
  infoSection: {
    backgroundColor: '#fff',
    padding: 16,
    marginBottom: 12,
  },
  infoItem: {
    marginBottom: 16,
  },
  infoLabel: {
    fontSize: 14,
    color: '#666',
    marginBottom: 4,
  },
  infoValue: {
    fontSize: 16,
    color: '#333',
  },
  infoValueWithIcon: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  actionIcon: {
    padding: 4,
  },
  metaSection: {
    backgroundColor: '#fff',
    padding: 16,
    marginBottom: 20,
  },
  metaSectionTitle: {
    fontSize: 16,
    fontWeight: '500',
    color: '#333',
    marginBottom: 12,
  },
  metaItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 8,
  },
  metaLabel: {
    fontSize: 14,
    color: '#666',
  },
  metaValue: {
    fontSize: 14,
    color: '#333',
  },
  footer: {
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  buttonContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  editButton: {
    backgroundColor: '#0066cc',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 14,
    borderRadius: 8,
    flex: 3,
    marginLeft: 10,
  },
  editButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
    marginLeft: 8,
  },
  deleteButton: {
    backgroundColor: '#e74c3c',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 14,
    borderRadius: 8,
    flex: 1,
  },
  deleteButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
    marginLeft: 8,
  },
});

export default CustomerDetailScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\CustomerManagementScreen.js ---

//src/screens/CustomerManagementScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  FlatList,
  StyleSheet,
  ActivityIndicator,
  Pressable,
  TouchableOpacity,
  SafeAreaView,
  StatusBar,
  TextInput,
  LayoutAnimation,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { getCustomers } from '../api/customerService';
import { useTheme } from '../contexts/ThemeContext';

// Component hiá»ƒn thá»‹ tá»«ng khÃ¡ch hÃ ng trong danh sÃ¡ch
const CustomerListItem = ({ customer, onPress }) => {
  const { theme } = useTheme();
  // XÃ¡c Ä‘á»‹nh loáº¡i khÃ¡ch hÃ ng Ä‘á»ƒ hiá»ƒn thá»‹ mÃ u sáº¯c phÃ¹ há»£p
  const getTypeColor = (type) => {
    switch (type) {
      case 'vip':
        return '#4CAF50'; // xanh lÃ¡
      case 'potential':
        return '#FF9800'; // cam
      default:
        return theme.textMuted; // Sá»­ dá»¥ng mÃ u tá»« theme
    }
  };

  // Láº¥y nhÃ£n hiá»ƒn thá»‹ cho loáº¡i khÃ¡ch hÃ ng
  const getTypeLabel = (type) => {
    switch (type) {
      case 'vip':
        return 'VIP';
      case 'potential':
        return 'Tiá»m nÄƒng';
      case 'regular':
        return 'ThÆ°á»ng xuyÃªn';
      default:
        return type || 'ChÆ°a phÃ¢n loáº¡i';
    }
  };

  return (
    <Pressable
      style={({ pressed }) => [
        styles.customerCard,
        { backgroundColor: theme.card },
        pressed && styles.cardPressed,
      ]}
      onPress={() => onPress(customer)}
    >
      <View style={styles.customerInfo}>
        <Text style={[styles.customerName, { color: theme.text }]}>
          {customer.name || 'ChÆ°a cÃ³ tÃªn'}
        </Text>

        <View style={styles.contactRow}>
          <Ionicons
            name="person-outline"
            size={14}
            color={theme.textSecondary}
          />
          <Text style={[styles.contactText, { color: theme.textSecondary }]}>
            {customer.contactPerson || 'ChÆ°a cÃ³ ngÆ°á»i liÃªn há»‡'}
          </Text>
        </View>

        {customer.email && (
          <View style={styles.contactRow}>
            <Ionicons
              name="mail-outline"
              size={14}
              color={theme.textSecondary}
            />
            <Text style={[styles.contactText, { color: theme.textSecondary }]}>
              {customer.email}
            </Text>
          </View>
        )}

        {customer.phone && (
          <View style={styles.contactRow}>
            <Ionicons
              name="call-outline"
              size={14}
              color={theme.textSecondary}
            />
            <Text style={[styles.contactText, { color: theme.textSecondary }]}>
              {customer.phone}
            </Text>
          </View>
        )}
      </View>

      <View style={styles.customerTypeContainer}>
        <View
          style={[
            styles.customerTypeTag,
            { borderColor: getTypeColor(customer.type) },
          ]}
        >
          <Text
            style={[
              styles.customerTypeText,
              { color: getTypeColor(customer.type) },
            ]}
          >
            {getTypeLabel(customer.type)}
          </Text>
        </View>
      </View>
    </Pressable>
  );
};

const CustomerManagementScreen = ({ navigation }) => {
  const { theme } = useTheme();
  const [customers, setCustomers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [refreshing, setRefreshing] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [filteredCustomers, setFilteredCustomers] = useState([]);

  // HÃ m táº£i danh sÃ¡ch khÃ¡ch hÃ ng
  const loadCustomers = async () => {
    try {
      setLoading(true);
      setError(null);
      const data = await getCustomers();

      // ThÃªm animation khi cáº­p nháº­t danh sÃ¡ch
      LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);

      setCustomers(data);
      setFilteredCustomers(data); // Khá»Ÿi táº¡o danh sÃ¡ch lá»c ban Ä‘áº§u
    } catch (err) {
      console.error('Lá»—i khi táº£i danh sÃ¡ch khÃ¡ch hÃ ng:', err);
      setError('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch khÃ¡ch hÃ ng. Vui lÃ²ng thá»­ láº¡i sau.');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  // Táº£i dá»¯ liá»‡u khi mÃ n hÃ¬nh Ä‘Æ°á»£c má»Ÿ
  useEffect(() => {
    loadCustomers();

    // ThÃªm listener Ä‘á»ƒ lÃ m má»›i danh sÃ¡ch khi quay láº¡i tá»« mÃ n hÃ¬nh khÃ¡c
    const unsubscribe = navigation.addListener('focus', () => {
      loadCustomers();
    });

    return unsubscribe;
  }, [navigation]);

  // Lá»c danh sÃ¡ch khÃ¡ch hÃ ng theo tá»« khÃ³a tÃ¬m kiáº¿m
  useEffect(() => {
    if (!searchQuery.trim()) {
      LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
      setFilteredCustomers(customers);
      return;
    }

    const query = searchQuery.toLowerCase().trim();
    const filtered = customers.filter((customer) => {
      const name = (customer.name || '').toLowerCase();
      const contactPerson = (customer.contactPerson || '').toLowerCase();
      const email = (customer.email || '').toLowerCase();
      const phone = (customer.phone || '').toLowerCase();

      return (
        name.includes(query) ||
        contactPerson.includes(query) ||
        email.includes(query) ||
        phone.includes(query)
      );
    });

    // ThÃªm animation khi cáº­p nháº­t káº¿t quáº£ tÃ¬m kiáº¿m
    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);

    setFilteredCustomers(filtered);
  }, [searchQuery, customers]);

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng kÃ©o Ä‘á»ƒ lÃ m má»›i
  const handleRefresh = () => {
    setRefreshing(true);
    loadCustomers();
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥n vÃ o má»™t khÃ¡ch hÃ ng
  const handleCustomerPress = (customer) => {
    navigation.navigate('CustomerDetail', { customerId: customer.id });
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng muá»‘n thÃªm khÃ¡ch hÃ ng má»›i
  const handleAddCustomer = () => {
    navigation.navigate('AddCustomer');
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº­p tá»« khÃ³a tÃ¬m kiáº¿m
  const handleSearch = (text) => {
    setSearchQuery(text);
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng muá»‘n xÃ³a tá»« khÃ³a tÃ¬m kiáº¿m
  const handleClearSearch = () => {
    setSearchQuery('');
  };

  // Hiá»ƒn thá»‹ khi Ä‘ang táº£i dá»¯ liá»‡u
  if (loading && !refreshing) {
    return (
      <View
        style={[styles.centerContainer, { backgroundColor: theme.background }]}
      >
        <ActivityIndicator size="large" color={theme.primary} />
        <Text style={[styles.loadingText, { color: theme.textSecondary }]}>
          Äang táº£i danh sÃ¡ch khÃ¡ch hÃ ng...
        </Text>
      </View>
    );
  }

  // Hiá»ƒn thá»‹ khi cÃ³ lá»—i
  if (error) {
    return (
      <View
        style={[styles.centerContainer, { backgroundColor: theme.background }]}
      >
        <Ionicons name="alert-circle-outline" size={50} color={theme.danger} />
        <Text style={[styles.errorText, { color: theme.text }]}>{error}</Text>
        <TouchableOpacity
          style={[styles.retryButton, { backgroundColor: theme.primary }]}
          onPress={loadCustomers}
        >
          <Text style={styles.retryButtonText}>Thá»­ láº¡i</Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Hiá»ƒn thá»‹ khi khÃ´ng cÃ³ khÃ¡ch hÃ ng
  if (customers.length === 0) {
    return (
      <SafeAreaView
        style={[styles.container, { backgroundColor: theme.background }]}
      >
        <View style={[styles.header, { borderBottomColor: theme.border }]}>
          <Text style={[styles.headerTitle, { color: theme.text }]}>
            Quáº£n lÃ½ KhÃ¡ch hÃ ng
          </Text>
          <TouchableOpacity
            style={[styles.addButton, { backgroundColor: theme.primary }]}
            onPress={handleAddCustomer}
          >
            <Ionicons name="add" size={24} color="#fff" />
          </TouchableOpacity>
        </View>

        <View
          style={[
            styles.centerContainer,
            { backgroundColor: theme.background },
          ]}
        >
          <Ionicons name="people-outline" size={60} color={theme.textMuted} />
          <Text style={[styles.emptyText, { color: theme.textSecondary }]}>
            ChÆ°a cÃ³ khÃ¡ch hÃ ng nÃ o
          </Text>
          <TouchableOpacity
            style={[
              styles.addCustomerButton,
              { backgroundColor: theme.primary },
            ]}
            onPress={handleAddCustomer}
          >
            <Text style={styles.addCustomerButtonText}>
              ThÃªm khÃ¡ch hÃ ng má»›i
            </Text>
          </TouchableOpacity>
        </View>
      </SafeAreaView>
    );
  }

  // Hiá»ƒn thá»‹ danh sÃ¡ch khÃ¡ch hÃ ng
  return (
    <SafeAreaView
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      <StatusBar
        barStyle={theme.dark ? 'light-content' : 'dark-content'}
        backgroundColor={theme.background}
      />

      <View style={[styles.header, { borderBottomColor: theme.border }]}>
        <Text style={[styles.headerTitle, { color: theme.text }]}>
          Quáº£n lÃ½ KhÃ¡ch hÃ ng
        </Text>
        <TouchableOpacity
          style={[styles.addButton, { backgroundColor: theme.primary }]}
          onPress={handleAddCustomer}
        >
          <Ionicons name="add" size={24} color="#fff" />
        </TouchableOpacity>
      </View>

      <View
        style={[
          styles.searchContainer,
          { backgroundColor: theme.card, borderColor: theme.border },
        ]}
      >
        <Ionicons
          name="search"
          size={20}
          color={theme.textMuted}
          style={styles.searchIcon}
        />
        <TextInput
          style={[styles.searchInput, { color: theme.text }]}
          placeholder="TÃ¬m kiáº¿m khÃ¡ch hÃ ng..."
          placeholderTextColor={theme.textMuted}
          value={searchQuery}
          onChangeText={handleSearch}
        />
        {searchQuery.length > 0 && (
          <TouchableOpacity onPress={handleClearSearch}>
            <Ionicons name="close-circle" size={20} color={theme.textMuted} />
          </TouchableOpacity>
        )}
      </View>

      {filteredCustomers.length === 0 && searchQuery ? (
        <View style={styles.emptyResultContainer}>
          <Ionicons name="search-outline" size={50} color="#CCCCCC" />
          <Text style={styles.emptyResultText}>
            KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng phÃ¹ há»£p
          </Text>
          <TouchableOpacity
            onPress={handleClearSearch}
            style={styles.tryAgainButton}
          >
            <Text style={styles.tryAgainButtonText}>XÃ³a tÃ¬m kiáº¿m</Text>
          </TouchableOpacity>
        </View>
      ) : (
        <FlatList
          data={filteredCustomers}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <CustomerListItem customer={item} onPress={handleCustomerPress} />
          )}
          contentContainerStyle={styles.listContainer}
          showsVerticalScrollIndicator={false}
          refreshing={refreshing}
          onRefresh={handleRefresh}
          initialNumToRender={10}
          maxToRenderPerBatch={10}
          windowSize={10}
          ListEmptyComponent={
            !searchQuery ? (
              <View style={styles.emptyContainer}>
                <Ionicons name="people-outline" size={60} color="#CCCCCC" />
                <Text style={styles.emptyText}>ChÆ°a cÃ³ khÃ¡ch hÃ ng nÃ o</Text>
                <TouchableOpacity
                  style={styles.addCustomerButton}
                  onPress={handleAddCustomer}
                >
                  <Text style={styles.addCustomerButtonText}>
                    ThÃªm khÃ¡ch hÃ ng má»›i
                  </Text>
                </TouchableOpacity>
              </View>
            ) : null
          }
        />
      )}
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f9fa',
  },
  centerContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
    backgroundColor: '#fff',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
  },
  headerTitle: {
    fontSize: 24,
    fontWeight: 'bold',
  },
  addButton: {
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: 'center',
    alignItems: 'center',
  },
  searchContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginHorizontal: 16,
    marginTop: 16,
    marginBottom: 8,
    paddingHorizontal: 12,
    borderWidth: 1,
    borderRadius: 12,
    backgroundColor: '#fff',
  },
  searchIcon: {
    marginRight: 8,
  },
  searchInput: {
    flex: 1,
    height: 44,
    fontSize: 16,
  },
  listContainer: {
    paddingHorizontal: 16,
  },
  customerCard: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    padding: 16,
    marginVertical: 8,
    borderRadius: 12,
    backgroundColor: '#ffffff',
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.05,
    shadowRadius: 2,
  },
  cardPressed: {
    transform: [{ scale: 0.98 }],
    opacity: 0.9,
  },
  customerInfo: {
    flex: 1,
    marginRight: 10,
  },
  customerName: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 8,
  },
  contactRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 4,
  },
  contactText: {
    marginLeft: 6,
    fontSize: 14,
  },
  customerTypeContainer: {
    marginLeft: 12,
  },
  customerTypeTag: {
    borderWidth: 1,
    borderRadius: 12,
    paddingHorizontal: 10,
    paddingVertical: 4,
  },
  customerTypeText: {
    fontSize: 12,
    fontWeight: '500',
  },
  loadingText: {
    marginTop: 10,
    fontSize: 16,
    color: '#666',
  },
  errorText: {
    marginTop: 10,
    fontSize: 16,
    color: '#333',
    textAlign: 'center',
    marginBottom: 20,
  },
  retryButton: {
    paddingHorizontal: 20,
    paddingVertical: 10,
    borderRadius: 8,
  },
  retryButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
    minHeight: 300,
  },
  emptyText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  addCustomerButton: {
    marginTop: 16,
    backgroundColor: '#0066cc',
    paddingHorizontal: 20,
    paddingVertical: 10,
    borderRadius: 6,
  },
  addCustomerButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '500',
  },
  emptyResultContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  emptyResultText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  tryAgainButton: {
    marginTop: 16,
    backgroundColor: '#f0f0f0',
    paddingHorizontal: 20,
    paddingVertical: 10,
    borderRadius: 6,
  },
  tryAgainButtonText: {
    color: '#333',
    fontSize: 16,
    fontWeight: '500',
  },
});

export default CustomerManagementScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\DebtDashboard.js ---

import React, { useState, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  Dimensions,
  RefreshControl,
  Alert,
} from 'react-native';
import { useFocusEffect } from '@react-navigation/native';
import { doc, getDoc } from 'firebase/firestore';
import { db } from '../config/firebaseConfig';
import { useTheme } from '../contexts/ThemeContext';
import { useAuth } from '../contexts/AuthContext';
import { Ionicons } from '@expo/vector-icons';
import { BarChart } from 'react-native-chart-kit';
import { getFunctions, httpsCallable } from 'firebase/functions';

// ID thÆ° má»¥c Google Drive chá»©a file Excel cÃ´ng ná»£
const DEBT_FOLDER_ID = '1Ci_BHZx0-Uhv2xg5IzwLPn05yPAUXOOU';

const screenWidth = Dimensions.get('window').width;

const DebtDashboard = ({ navigation }) => {
  const { theme } = useTheme();
  const { currentUser } = useAuth();
  const [dashboardData, setDashboardData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState(null);
  const [processingExcel, setProcessingExcel] = useState(false);

  // HÃ m láº¥y dá»¯ liá»‡u tá»•ng quan tá»« Firestore
  const fetchDashboardData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const dashboardRef = doc(db, 'summaries', 'directorDashboard');
      const dashboardSnap = await getDoc(dashboardRef);

      if (dashboardSnap.exists()) {
        const data = dashboardSnap.data();
        setDashboardData(data);
      } else {
        // Náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u, thá»­ gá»i cloud function Ä‘á»ƒ xá»­ lÃ½
        await fetchLatestExcelData();
      }
    } catch (err) {
      console.error('Error fetching dashboard data:', err);
      setError('Lá»—i khi táº£i dá»¯ liá»‡u tá»•ng quan.');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  }, []);

  // HÃ m gá»i Cloud Function Ä‘á»ƒ xá»­ lÃ½ file Excel má»›i nháº¥t
  const fetchLatestExcelData = async () => {
    try {
      setProcessingExcel(true);
      setError(null);

      // Gá»i cloud function triggerExcelProcessing
      const functions = getFunctions(undefined, 'asia-southeast1');
      const triggerExcel = httpsCallable(functions, 'triggerExcelProcessing');

      const result = await triggerExcel();
      console.log('Káº¿t quáº£ xá»­ lÃ½ Excel:', result.data);

      if (result.data && result.data.success) {
        // Láº¥y dá»¯ liá»‡u má»›i tá»« Firestore
        const dashboardRef = doc(db, 'summaries', 'directorDashboard');
        const dashboardSnap = await getDoc(dashboardRef);

        if (dashboardSnap.exists()) {
          const data = dashboardSnap.data();
          setDashboardData(data);
        }

        Alert.alert(
          'Cáº­p nháº­t thÃ nh cÃ´ng',
          `ÄÃ£ cáº­p nháº­t dá»¯ liá»‡u tá»« file: ${result.data.fileName}`
        );
      } else {
        throw new Error('KhÃ´ng nháº­n Ä‘Æ°á»£c dá»¯ liá»‡u tá»« cloud function');
      }
    } catch (err) {
      console.error('Lá»—i khi xá»­ lÃ½ file Excel:', err);
      setError(`Lá»—i khi xá»­ lÃ½ file Excel: ${err.message}`);
      Alert.alert('Lá»—i', `KhÃ´ng thá»ƒ xá»­ lÃ½ file Excel: ${err.message}`);
    } finally {
      setProcessingExcel(false);
      setRefreshing(false);
    }
  };

  const onRefresh = useCallback(() => {
    setRefreshing(true);
    fetchLatestExcelData();
  }, []);

  useFocusEffect(
    useCallback(() => {
      fetchDashboardData();
    }, [fetchDashboardData])
  );

  const formatDate = (timestamp) => {
    if (!timestamp) return 'KhÃ´ng cÃ³ dá»¯ liá»‡u';

    const date = timestamp.toDate ? timestamp.toDate() : timestamp;
    return new Intl.DateTimeFormat('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    }).format(date);
  };

  const formatCurrency = (amount) => {
    if (amount === undefined || amount === null) return '0 â‚«';

    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(amount);
  };

  if (loading && !refreshing) {
    return (
      <View style={[styles.container, { backgroundColor: theme.background }]}>
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color={theme.primary} />
          <Text style={[styles.loadingText, { color: theme.text }]}>
            Äang táº£i dá»¯ liá»‡u cÃ´ng ná»£...
          </Text>
        </View>
      </View>
    );
  }

  const chartConfig = {
    backgroundGradientFrom: theme.card,
    backgroundGradientTo: theme.card,
    color: (opacity = 1) => `rgba(26, 255, 146, ${opacity})`,
    strokeWidth: 2,
    barPercentage: 0.7,
    useShadowColorFromDataset: false,
    decimalPlaces: 1,
  };

  const getPayableChartData = () => {
    // Dá»¯ liá»‡u má»›i khÃ´ng cÃ³ top5Payable, nÃªn tráº£ vá» dá»¯ liá»‡u máº«u
    return {
      labels: ['KhÃ´ng cÃ³ dá»¯ liá»‡u chi tiáº¿t'],
      datasets: [
        {
          data: [
            dashboardData?.totalPayable
              ? dashboardData.totalPayable / 1000000
              : 0,
          ],
        },
      ],
    };
  };

  const getReceivableChartData = () => {
    // Dá»¯ liá»‡u má»›i khÃ´ng cÃ³ top5Receivable, nÃªn tráº£ vá» dá»¯ liá»‡u máº«u
    return {
      labels: ['KhÃ´ng cÃ³ dá»¯ liá»‡u chi tiáº¿t'],
      datasets: [
        {
          data: [
            dashboardData?.totalReceivable
              ? dashboardData.totalReceivable / 1000000
              : 0,
          ],
        },
      ],
    };
  };

  return (
    <ScrollView
      style={[styles.container, { backgroundColor: theme.background }]}
      refreshControl={
        <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />
      }
    >
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Ionicons name="arrow-back" size={24} color={theme.text} />
        </TouchableOpacity>
        <Text style={[styles.headerTitle, { color: theme.text }]}>
          BÃ¡o CÃ¡o CÃ´ng Ná»£
        </Text>
        <TouchableOpacity
          style={styles.refreshButton}
          onPress={fetchLatestExcelData}
          disabled={processingExcel || refreshing}
        >
          {processingExcel ? (
            <ActivityIndicator size="small" color={theme.primary} />
          ) : (
            <Ionicons name="refresh-outline" size={24} color={theme.text} />
          )}
        </TouchableOpacity>
      </View>

      {error ? (
        <View style={styles.errorContainer}>
          <Ionicons name="alert-circle-outline" size={48} color={theme.error} />
          <Text style={[styles.errorText, { color: theme.error }]}>
            {error}
          </Text>
          <TouchableOpacity
            style={[styles.retryButton, { backgroundColor: theme.primary }]}
            onPress={fetchLatestExcelData}
          >
            <Text style={styles.retryButtonText}>Thá»­ láº¡i</Text>
          </TouchableOpacity>
        </View>
      ) : (
        <>
          <View style={styles.kpiContainer}>
            <View
              style={[
                styles.kpiCard,
                { backgroundColor: '#d9534f' }, // Red for payables
              ]}
            >
              <Text style={styles.kpiLabel}>Tá»•ng Ná»£ Pháº£i Tráº£</Text>
              <Text style={styles.kpiValue}>
                {dashboardData?.formattedTotals?.totalPayable ||
                  formatCurrency(dashboardData?.totalPayable)}
              </Text>
            </View>

            <View
              style={[
                styles.kpiCard,
                { backgroundColor: '#5cb85c' }, // Green for receivables
              ]}
            >
              <Text style={styles.kpiLabel}>Tá»•ng Ná»£ Pháº£i Thu</Text>
              <Text style={styles.kpiValue}>
                {dashboardData?.formattedTotals?.totalReceivable ||
                  formatCurrency(dashboardData?.totalReceivable)}
              </Text>
            </View>

            <View
              style={[
                styles.kpiCard,
                {
                  backgroundColor:
                    (dashboardData?.netPosition || 0) >= 0
                      ? '#5cb85c' // Green for positive
                      : '#d9534f', // Red for negative
                },
              ]}
            >
              <Text style={styles.kpiLabel}>Vá»‹ Tháº¿ CÃ´ng Ná»£ RÃ²ng</Text>
              <Text style={styles.kpiValue}>
                {dashboardData?.formattedTotals?.netPosition ||
                  formatCurrency(dashboardData?.netPosition)}
              </Text>
            </View>

            <View style={[styles.kpiCard, { backgroundColor: theme.card }]}>
              <Text style={[styles.kpiLabel, { color: theme.textSecondary }]}>
                Cáº­p nháº­t láº§n cuá»‘i
              </Text>
              <Text style={[styles.lastUpdatedValue, { color: theme.text }]}>
                {dashboardData?.lastUpdated
                  ? formatDate(dashboardData.lastUpdated)
                  : 'ChÆ°a cÃ³ dá»¯ liá»‡u'}
              </Text>
              {dashboardData?.fileName && (
                <Text style={[styles.fileNameText, { color: theme.textMuted }]}>
                  {dashboardData.fileName}
                </Text>
              )}
            </View>
          </View>

          <View style={styles.chartSection}>
            <Text style={[styles.chartTitle, { color: theme.text }]}>
              Top 5 CÃ´ng Ná»£ Pháº£i Tráº£ (Triá»‡u VNÄ)
            </Text>
            <View style={styles.chartContainer}>
              <BarChart
                data={getPayableChartData()}
                width={screenWidth - 32}
                height={220}
                chartConfig={chartConfig}
                verticalLabelRotation={30}
                showValuesOnTopOfBars={true}
                fromZero={true}
                style={styles.chart}
              />
            </View>
          </View>

          <View style={styles.chartSection}>
            <Text style={[styles.chartTitle, { color: theme.text }]}>
              Top 5 KhÃ¡ch HÃ ng Ná»£ Nhiá»u Nháº¥t (Triá»‡u VNÄ)
            </Text>
            <View style={styles.chartContainer}>
              <BarChart
                data={getReceivableChartData()}
                width={screenWidth - 32}
                height={220}
                chartConfig={{
                  ...chartConfig,
                  color: (opacity = 1) => `rgba(54, 162, 235, ${opacity})`,
                }}
                verticalLabelRotation={30}
                showValuesOnTopOfBars={true}
                fromZero={true}
                style={styles.chart}
              />
            </View>
          </View>
        </>
      )}
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 16,
    fontSize: 16,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 16,
  },
  headerTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    flex: 1,
    textAlign: 'center',
  },
  backButton: {
    padding: 8,
  },
  refreshButton: {
    padding: 8,
  },
  errorContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
    marginTop: 50,
  },
  errorText: {
    fontSize: 16,
    textAlign: 'center',
    marginVertical: 20,
  },
  retryButton: {
    paddingVertical: 10,
    paddingHorizontal: 20,
    borderRadius: 8,
  },
  retryButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '600',
  },
  kpiContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    marginBottom: 16,
  },
  kpiCard: {
    width: '48%',
    padding: 16,
    borderRadius: 12,
    marginBottom: 16,
    alignItems: 'center',
    justifyContent: 'center',
  },
  kpiLabel: {
    color: 'white',
    fontSize: 14,
    fontWeight: '600',
    marginBottom: 8,
    textAlign: 'center',
  },
  kpiValue: {
    color: 'white',
    fontSize: 20,
    fontWeight: 'bold',
    textAlign: 'center',
  },
  lastUpdatedValue: {
    fontSize: 14,
    fontWeight: '500',
    textAlign: 'center',
  },
  chartSection: {
    marginVertical: 16,
    paddingHorizontal: 16,
  },
  chartTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 12,
  },
  chartContainer: {
    alignItems: 'center',
    backgroundColor: 'white',
    borderRadius: 12,
    padding: 8,
  },
  chart: {
    borderRadius: 12,
    marginVertical: 8,
  },
  fileNameText: {
    fontSize: 12,
    marginTop: 4,
    textAlign: 'center',
  },
});

export default DebtDashboard;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\DirectorDashboardScreen.js ---

import React, { useState, useEffect, useLayoutEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  FlatList,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useNavigation, useFocusEffect } from '@react-navigation/native';
import { useAuth } from '../contexts/AuthContext';
import { useTheme } from '../contexts/ThemeContext';
import {
  getProposalsByStatus,
  canApproveProposal,
} from '../api/proposalService';

const DirectorDashboardScreen = ({ navigation }) => {
  const { theme } = useTheme();
  const { currentUser } = useAuth();
  const [loading, setLoading] = useState(true);
  const [pendingProposals, setPendingProposals] = useState([]);
  const [canApprove, setCanApprove] = useState(false);

  useLayoutEffect(() => {
    navigation.setOptions({
      headerRight: () => (
        <TouchableOpacity
          onPress={() => navigation.navigate('Notifications')}
          style={{ marginRight: 16 }}
        >
          <Ionicons name="notifications-outline" size={24} color="#333" />
        </TouchableOpacity>
      ),
    });
  }, [navigation]);

  // ThÃªm useFocusEffect Ä‘á»ƒ táº£i láº¡i dá»¯ liá»‡u khi mÃ n hÃ¬nh Ä‘Æ°á»£c focus
  useFocusEffect(
    React.useCallback(() => {
      loadData();
    }, [])
  );

  const loadData = async () => {
    setLoading(true);
    try {
      // Kiá»ƒm tra quyá»n duyá»‡t Ä‘á» xuáº¥t
      const hasApprovalPermission = canApproveProposal(currentUser?.role);
      setCanApprove(hasApprovalPermission);

      // Náº¿u cÃ³ quyá»n duyá»‡t, táº£i danh sÃ¡ch Ä‘á» xuáº¥t chá» duyá»‡t
      if (hasApprovalPermission) {
        try {
          const proposals = await getProposalsByStatus('pending');
          console.log('Loaded pending proposals:', proposals.length);
          setPendingProposals(proposals);
        } catch (error) {
          console.error('Error loading proposals:', error);
          // Váº«n set canApprove Ä‘á»ƒ hiá»ƒn thá»‹ UI
        }
      }
    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (timestamp) => {
    if (!timestamp) return 'N/A';
    try {
      if (timestamp.toDate) {
        return timestamp.toDate().toLocaleDateString('vi-VN');
      } else if (timestamp instanceof Date) {
        return timestamp.toLocaleDateString('vi-VN');
      }
      return 'N/A';
    } catch (e) {
      return 'N/A';
    }
  };

  const getPriorityColor = (priority) => {
    switch (priority) {
      case 'urgent':
        return '#FF3B30';
      case 'normal':
        return '#007AFF';
      default:
        return '#007AFF';
    }
  };

  const renderProposalItem = ({ item }) => {
    // Choose icon and color based on priority
    let iconName = 'document-text';
    let iconColor = '#4E8AF4'; // New color for default items

    if (item.priority === 'urgent') {
      iconName = 'alert-circle';
      iconColor = '#FF3B30';
    }

    return (
      <TouchableOpacity
        style={[styles.proposalItem, { backgroundColor: theme.card }]}
        onPress={() => navigation.navigate('ProposalList')}
      >
        <View style={styles.proposalIconContainer}>
          <Ionicons name={iconName} size={24} color={iconColor} />
        </View>
        <View style={styles.proposalContent}>
          <Text
            style={[styles.proposalCode, { color: theme.text }]}
            numberOfLines={1}
          >
            {item.proposalCode}
          </Text>
          <Text
            style={[styles.projectName, { color: theme.textSecondary }]}
            numberOfLines={1}
          >
            {item.projectName}
          </Text>
          <Text
            style={[
              styles.requiredDate,
              {
                color:
                  item.priority === 'urgent' ? '#FF3B30' : theme.textSecondary,
              },
            ]}
          >
            Cáº§n: {formatDate(item.requiredDate)} â€¢ {item.items?.length || 0} váº­t
            tÆ°
          </Text>
        </View>
        <Ionicons name="chevron-forward" size={20} color={theme.textMuted} />
      </TouchableOpacity>
    );
  };

  // Helper functions for status and priority
  const getStatusColor = (status) => {
    switch (status) {
      case 'approved':
        return '#34C759';
      case 'rejected':
        return '#FF3B30';
      case 'pending':
      default:
        return '#FF9500';
    }
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'approved':
        return 'ÄÃ£ duyá»‡t';
      case 'rejected':
        return 'Tá»« chá»‘i';
      case 'pending':
      default:
        return 'Chá» duyá»‡t';
    }
  };

  return (
    <ScrollView
      style={[styles.container, { backgroundColor: theme.background }]}
      contentContainerStyle={styles.contentContainer}
    >
      <Text style={[styles.screenTitle, { color: theme.text }]}>
        Báº£ng Ä‘iá»u khiá»ƒn GiÃ¡m Ä‘á»‘c
      </Text>

      {/* NÃºt truy cáº­p mÃ n hÃ¬nh cÃ´ng ná»£ */}
      <TouchableOpacity
        style={[styles.debtButton, { backgroundColor: theme.primary }]}
        onPress={() => navigation.navigate('DebtDashboard')}
      >
        <Ionicons name="cash-outline" size={24} color="white" />
        <Text style={styles.debtButtonText}>Xem bÃ¡o cÃ¡o cÃ´ng ná»£</Text>
      </TouchableOpacity>

      {/* Pháº§n Ä‘á» xuáº¥t chá» duyá»‡t */}
      {canApprove && (
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <View style={styles.sectionTitleContainer}>
              <Ionicons
                name="file-tray-stacked-outline"
                size={22}
                color={theme.primary}
                style={styles.sectionIcon}
              />
              <Text style={[styles.sectionTitle, { color: theme.text }]}>
                Äá» xuáº¥t chá» duyá»‡t
              </Text>
            </View>
            <TouchableOpacity
              style={styles.viewAllButton}
              onPress={() => navigation.navigate('ProposalList')}
            >
              <Text style={[styles.viewAllText, { color: theme.primary }]}>
                Xem táº¥t cáº£
              </Text>
              <Ionicons
                name="chevron-forward"
                size={16}
                color={theme.primary}
              />
            </TouchableOpacity>
          </View>

          {loading ? (
            <ActivityIndicator
              size="large"
              color={theme.primary}
              style={styles.loader}
            />
          ) : pendingProposals.length > 0 ? (
            <View
              style={[styles.proposalsContainer, { borderColor: theme.border }]}
            >
              <FlatList
                data={pendingProposals}
                renderItem={renderProposalItem}
                keyExtractor={(item) => item.id}
                style={styles.proposalsList}
                scrollEnabled={true}
                nestedScrollEnabled={true}
                showsVerticalScrollIndicator={true}
                ListFooterComponent={
                  pendingProposals.length > 3 ? (
                    <TouchableOpacity
                      style={[
                        styles.moreButton,
                        { backgroundColor: theme.backgroundLight },
                      ]}
                      onPress={() => navigation.navigate('ProposalList')}
                    >
                      <Text
                        style={[
                          styles.moreButtonText,
                          { color: theme.primary },
                        ]}
                      >
                        Xem thÃªm {pendingProposals.length - 3} Ä‘á» xuáº¥t
                      </Text>
                    </TouchableOpacity>
                  ) : null
                }
              />
            </View>
          ) : (
            <View style={[styles.emptyState, { backgroundColor: theme.card }]}>
              <Ionicons
                name="checkmark-circle"
                size={40}
                color={theme.success || '#4CAF50'}
              />
              <Text style={[styles.emptyText, { color: theme.textSecondary }]}>
                KhÃ´ng cÃ³ Ä‘á» xuáº¥t nÃ o chá» duyá»‡t
              </Text>
            </View>
          )}
        </View>
      )}

      {/* CÃ¡c pháº§n khÃ¡c cá»§a dashboard */}
      <View style={styles.section}>
        <View style={styles.sectionTitleContainer}>
          <Ionicons
            name="stats-chart"
            size={22}
            color="#0066cc"
            style={styles.sectionIcon}
          />
          <Text style={[styles.sectionTitle, { color: theme.text }]}>
            BÃ¡o cÃ¡o dá»± Ã¡n
          </Text>
        </View>
        <TouchableOpacity
          style={[styles.dashboardCard, { backgroundColor: theme.card }]}
          onPress={() => navigation.navigate('ProjectManagement')}
        >
          <Ionicons
            name="stats-chart"
            size={24}
            color={theme.primary}
            style={styles.cardIcon}
          />
          <View style={styles.cardContent}>
            <Text style={[styles.cardTitle, { color: theme.text }]}>
              Quáº£n lÃ½ dá»± Ã¡n
            </Text>
            <Text
              style={[styles.cardDescription, { color: theme.textSecondary }]}
            >
              Xem vÃ  quáº£n lÃ½ táº¥t cáº£ dá»± Ã¡n
            </Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color={theme.textMuted} />
        </TouchableOpacity>
      </View>

      <View style={styles.section}>
        <View style={styles.sectionTitleContainer}>
          <Ionicons
            name="people"
            size={22}
            color="#FF9500"
            style={styles.sectionIcon}
          />
          <Text style={[styles.sectionTitle, { color: theme.text }]}>
            Quáº£n lÃ½ nhÃ¢n sá»±
          </Text>
        </View>
        <TouchableOpacity
          style={[styles.dashboardCard, { backgroundColor: theme.card }]}
          onPress={() => navigation.navigate('Attendance')}
        >
          <Ionicons
            name="people"
            size={24}
            color="#FF9500"
            style={styles.cardIcon}
          />
          <View style={styles.cardContent}>
            <Text style={[styles.cardTitle, { color: theme.text }]}>
              Cháº¥m cÃ´ng
            </Text>
            <Text
              style={[styles.cardDescription, { color: theme.textSecondary }]}
            >
              Quáº£n lÃ½ cháº¥m cÃ´ng vÃ  tÄƒng ca
            </Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color={theme.textMuted} />
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.dashboardCard, { backgroundColor: theme.card }]}
          onPress={() => navigation.navigate('UserManagement')}
        >
          <Ionicons
            name="person-add"
            size={24}
            color="#FF2D55"
            style={styles.cardIcon}
          />
          <View style={styles.cardContent}>
            <Text style={[styles.cardTitle, { color: theme.text }]}>
              Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
            </Text>
            <Text
              style={[styles.cardDescription, { color: theme.textSecondary }]}
            >
              ThÃªm vÃ  phÃ¢n quyá»n ngÆ°á»i dÃ¹ng
            </Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color={theme.textMuted} />
        </TouchableOpacity>
      </View>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  contentContainer: {
    padding: 16,
    paddingBottom: 32,
  },
  screenTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    marginBottom: 20,
  },
  debtButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 12,
    borderRadius: 8,
    marginBottom: 20,
  },
  debtButtonText: {
    color: 'white',
    fontWeight: 'bold',
    fontSize: 16,
    marginLeft: 8,
  },
  section: {
    marginBottom: 24,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  sectionTitleContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  sectionIcon: {
    marginRight: 8,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  viewAllButton: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  viewAllText: {
    fontSize: 14,
    fontWeight: '500',
    marginRight: 4,
  },
  proposalsContainer: {
    borderWidth: 1,
    borderRadius: 8,
    height: 220, // Chiá»u cao cá»‘ Ä‘á»‹nh
    marginBottom: 8,
  },
  proposalsList: {
    flex: 1,
  },
  proposalItem: {
    flexDirection: 'row',
    alignItems: 'center', // Changed from flex-start to center
    padding: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  proposalIconContainer: {
    marginRight: 12,
    width: 36,
    height: 36,
    borderRadius: 18,
    backgroundColor: '#f0f0f0',
    justifyContent: 'center',
    alignItems: 'center',
  },
  proposalContent: {
    flex: 1,
    marginRight: 8, // Add margin to prevent text touching the arrow
  },
  headerRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 2,
  },
  proposalCode: {
    fontWeight: 'bold',
    fontSize: 15,
  },
  projectName: {
    fontSize: 13,
    marginTop: 2,
  },
  requiredDate: {
    fontSize: 12,
    marginTop: 2,
  },
  statusBadge: {
    paddingHorizontal: 6,
    paddingVertical: 2,
    borderRadius: 4,
  },
  statusText: {
    color: '#fff',
    fontSize: 10,
    fontWeight: '500',
  },
  moreButton: {
    padding: 12,
    alignItems: 'center',
    borderBottomLeftRadius: 8,
    borderBottomRightRadius: 8,
  },
  moreButtonText: {
    fontWeight: '500',
  },
  emptyState: {
    padding: 24,
    borderRadius: 8,
    alignItems: 'center',
    justifyContent: 'center',
  },
  emptyText: {
    marginTop: 12,
    fontSize: 16,
    textAlign: 'center',
  },
  loader: {
    padding: 24,
  },
  dashboardCard: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    borderRadius: 8,
    marginBottom: 12,
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  cardIcon: {
    marginRight: 16,
  },
  cardContent: {
    flex: 1,
  },
  cardTitle: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 4,
  },
  cardDescription: {
    fontSize: 14,
  },
});

export default DirectorDashboardScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\EditCustomerScreen.js ---

//src/screens/EditCustomerScreen.js
import React, { useState } from 'react';
import {
  View,
  Text,
  TextInput,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  ActivityIndicator,
  Alert,
  KeyboardAvoidingView,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { updateCustomer } from '../api/customerService';
import { useAuth } from '../contexts/AuthContext';

const EditCustomerScreen = ({ route, navigation }) => {
  const { customer } = route.params;
  const { currentUser } = useAuth();
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    name: customer.name || '',
    contactPerson: customer.contactPerson || '',
    phone: customer.phone || '',
    email: customer.email || '',
    address: customer.address || '',
    type: customer.type || 'regular',
    taxCode: customer.taxCode || '',
  });

  // Cáº­p nháº­t giÃ¡ trá»‹ form
  const handleChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  // Kiá»ƒm tra form há»£p lá»‡
  const validateForm = () => {
    if (!formData.name.trim()) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p tÃªn khÃ¡ch hÃ ng');
      return false;
    }

    if (!formData.contactPerson.trim()) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p tÃªn ngÆ°á»i liÃªn há»‡');
      return false;
    }

    if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      Alert.alert('Lá»—i', 'Email khÃ´ng há»£p lá»‡');
      return false;
    }

    return true;
  };

  // Xá»­ lÃ½ cáº­p nháº­t khÃ¡ch hÃ ng
  const handleUpdate = async () => {
    if (!validateForm()) {
      return;
    }

    setIsLoading(true);

    try {
      // Gá»i API cáº­p nháº­t thÃ´ng tin khÃ¡ch hÃ ng
      await updateCustomer(customer.id, formData, currentUser?.uid);

      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ cáº­p nháº­t thÃ´ng tin khÃ¡ch hÃ ng thÃ nh cÃ´ng', [
        {
          text: 'OK',
          onPress: () => navigation.goBack(),
        },
      ]);
    } catch (error) {
      if (error.code === 'permission-denied') {
        Alert.alert(
          'Lá»—i quyá»n',
          'Báº¡n khÃ´ng cÃ³ Ä‘á»§ quyá»n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y.'
        );
      } else {
        console.error('Lá»—i khi cáº­p nháº­t khÃ¡ch hÃ ng:', error);
        Alert.alert(
          'Lá»—i',
          'KhÃ´ng thá»ƒ cáº­p nháº­t thÃ´ng tin khÃ¡ch hÃ ng. Vui lÃ²ng thá»­ láº¡i sau.'
        );
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Xá»­ lÃ½ thay Ä‘á»•i loáº¡i khÃ¡ch hÃ ng
  const handleSelectType = (type) => {
    handleChange('type', type);
  };

  return (
    <KeyboardAvoidingView
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
      style={styles.container}
    >
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Ionicons name="arrow-back" size={24} color="#333" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Chá»‰nh sá»­a thÃ´ng tin khÃ¡ch hÃ ng</Text>
        <View style={styles.placeholder} />
      </View>

      <ScrollView
        style={styles.formContainer}
        contentContainerStyle={styles.formContent}
        keyboardShouldPersistTaps="handled"
      >
        <View style={styles.inputGroup}>
          <Text style={styles.label}>
            TÃªn cÃ´ng ty / Tá»• chá»©c <Text style={styles.required}>*</Text>
          </Text>
          <TextInput
            style={styles.input}
            value={formData.name}
            onChangeText={(text) => handleChange('name', text)}
            placeholder="Nháº­p tÃªn cÃ´ng ty hoáº·c tá»• chá»©c"
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>
            NgÆ°á»i liÃªn há»‡ <Text style={styles.required}>*</Text>
          </Text>
          <TextInput
            style={styles.input}
            value={formData.contactPerson}
            onChangeText={(text) => handleChange('contactPerson', text)}
            placeholder="Nháº­p tÃªn ngÆ°á»i liÃªn há»‡"
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>Sá»‘ Ä‘iá»‡n thoáº¡i</Text>
          <TextInput
            style={styles.input}
            value={formData.phone}
            onChangeText={(text) => handleChange('phone', text)}
            placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i"
            keyboardType="phone-pad"
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>Email</Text>
          <TextInput
            style={styles.input}
            value={formData.email}
            onChangeText={(text) => handleChange('email', text)}
            placeholder="Nháº­p Ä‘á»‹a chá»‰ email"
            keyboardType="email-address"
            autoCapitalize="none"
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>Äá»‹a chá»‰</Text>
          <TextInput
            style={[styles.input, styles.textArea]}
            value={formData.address}
            onChangeText={(text) => handleChange('address', text)}
            placeholder="Nháº­p Ä‘á»‹a chá»‰"
            multiline
            numberOfLines={3}
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>MÃ£ sá»‘ thuáº¿</Text>
          <TextInput
            style={styles.input}
            value={formData.taxCode}
            onChangeText={(text) => handleChange('taxCode', text)}
            placeholder="Nháº­p mÃ£ sá»‘ thuáº¿"
          />
        </View>

        <View style={styles.inputGroup}>
          <Text style={styles.label}>Loáº¡i khÃ¡ch hÃ ng</Text>
          <View style={styles.typeButtonsContainer}>
            <TouchableOpacity
              style={[
                styles.typeButton,
                formData.type === 'potential' && styles.selectedTypeButton,
              ]}
              onPress={() => handleSelectType('potential')}
            >
              <Text
                style={[
                  styles.typeButtonText,
                  formData.type === 'potential' &&
                    styles.selectedTypeButtonText,
                ]}
              >
                Tiá»m nÄƒng
              </Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[
                styles.typeButton,
                formData.type === 'regular' && styles.selectedTypeButton,
              ]}
              onPress={() => handleSelectType('regular')}
            >
              <Text
                style={[
                  styles.typeButtonText,
                  formData.type === 'regular' && styles.selectedTypeButtonText,
                ]}
              >
                ThÆ°á»ng xuyÃªn
              </Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[
                styles.typeButton,
                formData.type === 'vip' && styles.selectedTypeButton,
              ]}
              onPress={() => handleSelectType('vip')}
            >
              <Text
                style={[
                  styles.typeButtonText,
                  formData.type === 'vip' && styles.selectedTypeButtonText,
                ]}
              >
                VIP
              </Text>
            </TouchableOpacity>
          </View>
        </View>
      </ScrollView>

      <View style={styles.footer}>
        <TouchableOpacity
          style={styles.saveButton}
          onPress={handleUpdate}
          disabled={isLoading}
        >
          {isLoading ? (
            <ActivityIndicator color="#fff" size="small" />
          ) : (
            <>
              <Ionicons name="save-outline" size={20} color="#fff" />
              <Text style={styles.saveButtonText}>LÆ°u thay Ä‘á»•i</Text>
            </>
          )}
        </TouchableOpacity>
      </View>
    </KeyboardAvoidingView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  placeholder: {
    width: 24,
  },
  formContainer: {
    flex: 1,
  },
  formContent: {
    padding: 16,
  },
  inputGroup: {
    marginBottom: 16,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    marginBottom: 6,
    color: '#333',
  },
  required: {
    color: '#e74c3c',
  },
  input: {
    backgroundColor: '#fff',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    color: '#333',
  },
  textArea: {
    minHeight: 80,
    textAlignVertical: 'top',
  },
  typeButtonsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  typeButton: {
    flex: 1,
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 8,
    borderRadius: 8,
    marginHorizontal: 4,
    alignItems: 'center',
  },
  selectedTypeButton: {
    backgroundColor: '#0066cc',
  },
  typeButtonText: {
    fontSize: 14,
    color: '#666',
    fontWeight: '500',
  },
  selectedTypeButtonText: {
    color: '#fff',
  },
  footer: {
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  saveButton: {
    backgroundColor: '#0066cc',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 14,
    borderRadius: 8,
  },
  saveButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
    marginLeft: 8,
  },
});

export default EditCustomerScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\EditProjectScreen.js ---

//src/screens/EditProjectScreen.js
import React, { useState, useEffect, useLayoutEffect } from 'react';
import {
  View,
  Text,
  TextInput,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  ActivityIndicator,
  Alert,
  KeyboardAvoidingView,
  Platform,
  Modal,
  FlatList,
  LogBox,
  ActionSheetIOS,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import DateTimePicker from '@react-native-community/datetimepicker';
import { updateProject } from '../api/projectService';
import { getCustomers } from '../api/customerService';
import { useAuth } from '../contexts/AuthContext';
import DraggableFlatList from 'react-native-draggable-flatlist';
import ProcessPickerModal from '../components/ProcessPickerModal';
import uuid from 'react-native-uuid';
import { GestureHandlerRootView } from 'react-native-gesture-handler';

// Ignore the VirtualizedLists nested warning (we purposely nest one non-scrollable list inside a ScrollView)
LogBox.ignoreLogs(['VirtualizedLists should never be nested']);

const EditProjectScreen = ({ route, navigation }) => {
  // Láº¥y thÃ´ng tin dá»± Ã¡n tá»« route params
  const { project } = route.params;
  const { currentUser } = useAuth();
  const [isLoading, setIsLoading] = useState(false);
  const [customers, setCustomers] = useState([]);
  const [loadingCustomers, setLoadingCustomers] = useState(true);
  const [customerModalVisible, setCustomerModalVisible] = useState(false);
  const [customerSearchQuery, setCustomerSearchQuery] = useState('');
  const [filteredCustomers, setFilteredCustomers] = useState([]);

  // ThÃªm state cho date picker
  const [showStartDatePicker, setShowStartDatePicker] = useState(false);
  const [showEndDatePicker, setShowEndDatePicker] = useState(false);

  // Khá»Ÿi táº¡o formData vá»›i dá»¯ liá»‡u dá»± Ã¡n hiá»‡n táº¡i
  const [formData, setFormData] = useState({
    name: project?.name || '',
    description: project?.description || '',
    customerId: project?.customerId || '',
    customerName: project?.customerName || '',
    status: project?.status || 'pending',
    startDate: project?.startDate
      ? new Date(project.startDate.seconds * 1000)
      : null,
    endDate: project?.endDate ? new Date(project.endDate.seconds * 1000) : null,
    durationInDays: project?.durationInDays
      ? String(project.durationInDays)
      : '',
    location: project?.location || 'workshop', // 'workshop' (táº¡i xÆ°á»Ÿng) hoáº·c 'site' (táº¡i cÃ´ng trÃ¬nh)
    budget: project?.budget ? String(project.budget) : '',
    notes: project?.notes || '',
  });

  // Láº¥y danh sÃ¡ch khÃ¡ch hÃ ng khi mÃ n hÃ¬nh Ä‘Æ°á»£c táº£i
  useEffect(() => {
    const fetchCustomers = async () => {
      try {
        setLoadingCustomers(true);
        const data = await getCustomers();
        setCustomers(data);
        setFilteredCustomers(data);
      } catch (error) {
        console.error('Lá»—i khi láº¥y danh sÃ¡ch khÃ¡ch hÃ ng:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i danh sÃ¡ch khÃ¡ch hÃ ng');
      } finally {
        setLoadingCustomers(false);
      }
    };

    fetchCustomers();
  }, []);

  // Lá»c danh sÃ¡ch khÃ¡ch hÃ ng khi tá»« khÃ³a tÃ¬m kiáº¿m thay Ä‘á»•i
  useEffect(() => {
    if (!customerSearchQuery.trim()) {
      setFilteredCustomers(customers);
      return;
    }

    const query = customerSearchQuery.toLowerCase().trim();
    const filtered = customers.filter((customer) => {
      const name = (customer.name || '').toLowerCase();
      const contact = (customer.contactPerson || '').toLowerCase();
      const email = (customer.email || '').toLowerCase();

      return (
        name.includes(query) || contact.includes(query) || email.includes(query)
      );
    });

    setFilteredCustomers(filtered);
  }, [customerSearchQuery, customers]);

  // Cáº­p nháº­t giÃ¡ trá»‹ form
  const handleChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  // Xá»­ lÃ½ khi chá»n ngÃ y báº¯t Ä‘áº§u
  const handleStartDateChange = (event, selectedDate) => {
    setShowStartDatePicker(false);
    if (selectedDate) {
      handleChange('startDate', selectedDate);

      // Tá»± Ä‘á»™ng tÃ­nh ngÃ y káº¿t thÃºc náº¿u cÃ³ sá»‘ ngÃ y thi cÃ´ng
      if (formData.durationInDays) {
        const endDate = new Date(selectedDate);
        endDate.setDate(endDate.getDate() + Number(formData.durationInDays));
        handleChange('endDate', endDate);
      }
    }
  };

  // Xá»­ lÃ½ khi nháº­p sá»‘ ngÃ y thi cÃ´ng
  const handleDurationChange = (text) => {
    handleChange('durationInDays', text);

    // Tá»± Ä‘á»™ng tÃ­nh ngÃ y káº¿t thÃºc náº¿u cÃ³ ngÃ y báº¯t Ä‘áº§u
    if (formData.startDate && text) {
      const endDate = new Date(formData.startDate);
      endDate.setDate(endDate.getDate() + Number(text));
      handleChange('endDate', endDate);
    }
  };

  // Xá»­ lÃ½ khi chá»n vá»‹ trÃ­
  const handleLocationChange = (location) => {
    handleChange('location', location);
  };

  // Äá»‹nh dáº¡ng ngÃ y Ä‘á»ƒ hiá»ƒn thá»‹
  const formatDate = (date) => {
    if (!date) return '';
    return date.toLocaleDateString('vi-VN');
  };

  // Kiá»ƒm tra form há»£p lá»‡
  const validateForm = () => {
    if (!formData.name.trim()) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p tÃªn dá»± Ã¡n');
      return false;
    }

    return true;
  };

  // Xá»­ lÃ½ cáº­p nháº­t dá»± Ã¡n
  const handleUpdate = async () => {
    if (!validateForm()) {
      return;
    }

    setIsLoading(true);

    try {
      // Chuáº©n bá»‹ dá»¯ liá»‡u Ä‘á»ƒ lÆ°u
      const projectData = {
        ...formData,
        budget: formData.budget ? Number(formData.budget) : null,
        durationInDays: formData.durationInDays
          ? Number(formData.durationInDays)
          : null,
        workflowStages: workflowStages.map((s, index) => ({
          ...s,
          order: index,
        })),
      };

      // Gá»i API cáº­p nháº­t dá»± Ã¡n
      await updateProject(project.id, projectData, currentUser?.uid);

      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ cáº­p nháº­t dá»± Ã¡n thÃ nh cÃ´ng', [
        {
          text: 'OK',
          onPress: () => navigation.goBack(),
        },
      ]);
    } catch (error) {
      if (error.code === 'permission-denied') {
        Alert.alert(
          'Lá»—i quyá»n',
          'Báº¡n khÃ´ng cÃ³ Ä‘á»§ quyá»n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y.'
        );
      } else {
        console.error('Lá»—i khi cáº­p nháº­t dá»± Ã¡n:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t dá»± Ã¡n. Vui lÃ²ng thá»­ láº¡i sau.');
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Xá»­ lÃ½ thay Ä‘á»•i tráº¡ng thÃ¡i dá»± Ã¡n
  const handleSelectStatus = (status) => {
    handleChange('status', status);
  };

  // Xá»­ lÃ½ má»Ÿ modal chá»n khÃ¡ch hÃ ng
  const handleOpenCustomerModal = () => {
    setCustomerModalVisible(true);
  };

  // Xá»­ lÃ½ Ä‘Ã³ng modal chá»n khÃ¡ch hÃ ng
  const handleCloseCustomerModal = () => {
    setCustomerModalVisible(false);
    setCustomerSearchQuery('');
  };

  // Xá»­ lÃ½ khi chá»n khÃ¡ch hÃ ng
  const handleSelectCustomer = (customer) => {
    setFormData((prev) => ({
      ...prev,
      customerId: customer.id,
      customerName: customer.name,
    }));
    handleCloseCustomerModal();
  };

  // Xá»­ lÃ½ khi tÃ¬m kiáº¿m khÃ¡ch hÃ ng
  const handleSearchCustomer = (text) => {
    setCustomerSearchQuery(text);
  };

  // Xá»­ lÃ½ khi xÃ³a khÃ¡ch hÃ ng Ä‘Ã£ chá»n
  const handleClearCustomer = () => {
    setFormData((prev) => ({
      ...prev,
      customerId: '',
      customerName: '',
    }));
  };

  // Render má»™t item trong danh sÃ¡ch khÃ¡ch hÃ ng
  const renderCustomerItem = ({ item }) => (
    <TouchableOpacity
      style={[
        styles.customerItem,
        item.id === formData.customerId && styles.selectedCustomerItem,
      ]}
      onPress={() => handleSelectCustomer(item)}
    >
      <View>
        <Text style={styles.customerName}>
          {item.name}
          {item.id === formData.customerId && ' (ÄÃ£ chá»n)'}
        </Text>
        {item.contactPerson && (
          <Text style={styles.customerDetail}>
            NgÆ°á»i liÃªn há»‡: {item.contactPerson}
          </Text>
        )}
        {item.email && (
          <Text style={styles.customerDetail}>Email: {item.email}</Text>
        )}
      </View>
      {item.id === formData.customerId && (
        <Ionicons name="checkmark-circle" size={20} color="#0066cc" />
      )}
      {item.id !== formData.customerId && (
        <Ionicons name="chevron-forward" size={20} color="#999" />
      )}
    </TouchableOpacity>
  );

  // áº¨n header máº·c Ä‘á»‹nh Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p
  useLayoutEffect(() => {
    navigation.setOptions({ headerShown: false });
  }, [navigation]);

  const [workflowStages, setWorkflowStages] = useState(
    project?.workflowStages || []
  );
  const [pickerVisible, setPickerVisible] = useState(false);

  // Remove stage
  const handleRemoveStage = (stageId) => {
    Alert.alert('XÃ¡c nháº­n', 'XÃ³a cÃ´ng Ä‘oáº¡n nÃ y?', [
      { text: 'Há»§y', style: 'cancel' },
      {
        text: 'XÃ³a',
        style: 'destructive',
        onPress: () =>
          setWorkflowStages((prev) =>
            prev.filter((s) => s.stageId !== stageId)
          ),
      },
    ]);
  };

  const STATUS_OPTIONS = [
    { value: 'pending', label: 'Chá» xá»­ lÃ½' },
    { value: 'in_progress', label: 'Äang lÃ m' },
    { value: 'completed', label: 'HoÃ n thÃ nh' },
  ];

  const changeStageStatusLocal = (stageId, newStatus) => {
    setWorkflowStages((prev) =>
      prev.map((s) => (s.stageId === stageId ? { ...s, status: newStatus } : s))
    );
  };

  const quickChangeStatus = (stage) => {
    if (Platform.OS === 'ios') {
      ActionSheetIOS.showActionSheetWithOptions(
        {
          options: [...STATUS_OPTIONS.map((s) => s.label), 'Há»§y'],
          cancelButtonIndex: STATUS_OPTIONS.length,
        },
        (idx) => {
          if (idx < STATUS_OPTIONS.length) {
            changeStageStatusLocal(stage.stageId, STATUS_OPTIONS[idx].value);
          }
        }
      );
    } else {
      Alert.alert('Chá»n tráº¡ng thÃ¡i', null, [
        ...STATUS_OPTIONS.map((opt) => ({
          text: opt.label,
          onPress: () => changeStageStatusLocal(stage.stageId, opt.value),
        })),
        { text: 'Há»§y', style: 'cancel' },
      ]);
    }
  };

  /* -------------------- WORKFLOW BUILDER ------------------- */
  const renderStageItem = ({ item, drag, isActive }) => {
    const statusColor =
      item.status === 'completed'
        ? '#4CAF50'
        : item.status === 'in_progress'
        ? '#FFD54F'
        : '#9E9E9E';

    return (
      <View style={[styles.stageRow, isActive && { opacity: 0.8 }]}>
        <TouchableOpacity onLongPress={drag} style={styles.dragHandle}>
          <Ionicons name="reorder-two-outline" size={20} color="#666" />
        </TouchableOpacity>

        <View style={styles.stageInfo}>
          <Text style={styles.stageName}>{item.processName}</Text>
          <TouchableOpacity
            style={[
              styles.statusBadge,
              { backgroundColor: statusColor + '22' },
            ]}
            onPress={() => quickChangeStatus(item)}
          >
            <Text style={[styles.statusBadgeText, { color: statusColor }]}>
              {
                {
                  pending: 'Chá» xá»­ lÃ½',
                  in_progress: 'Äang lÃ m',
                  completed: 'HoÃ n thÃ nh',
                }[item.status]
              }
            </Text>
          </TouchableOpacity>
        </View>

        <TouchableOpacity
          style={styles.deleteStageBtn}
          onPress={() => handleRemoveStage(item.stageId)}
        >
          <Ionicons name="trash-outline" size={20} color="#d11a2a" />
        </TouchableOpacity>
      </View>
    );
  };

  const handleAddStages = (selectedTemplates) => {
    const next = [...workflowStages];
    selectedTemplates.forEach((tpl) => {
      next.push({
        stageId: uuid.v4(),
        processKey: tpl.processKey,
        processName: tpl.processName,
        order: next.length,
        status: 'pending',
      });
    });
    setWorkflowStages(next);
    setPickerVisible(false);
  };

  return (
    <GestureHandlerRootView style={{ flex: 1 }}>
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={styles.container}
      >
        <View style={styles.header}>
          <TouchableOpacity
            style={styles.backButton}
            onPress={() => navigation.goBack()}
          >
            <Ionicons name="arrow-back" size={24} color="#333" />
          </TouchableOpacity>
          <Text style={styles.headerTitle}>Chá»‰nh sá»­a dá»± Ã¡n</Text>
          <View style={styles.placeholder} />
        </View>

        <ScrollView
          style={styles.formContainer}
          contentContainerStyle={styles.formContent}
          keyboardShouldPersistTaps="handled"
        >
          <View style={styles.inputGroup}>
            <Text style={styles.label}>
              TÃªn dá»± Ã¡n <Text style={styles.required}>*</Text>
            </Text>
            <TextInput
              style={styles.input}
              value={formData.name}
              onChangeText={(text) => handleChange('name', text)}
              placeholder="Nháº­p tÃªn dá»± Ã¡n"
            />
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>MÃ´ táº£</Text>
            <TextInput
              style={[styles.input, styles.textArea]}
              value={formData.description}
              onChangeText={(text) => handleChange('description', text)}
              placeholder="Nháº­p mÃ´ táº£ dá»± Ã¡n"
              multiline
              numberOfLines={3}
            />
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>KhÃ¡ch hÃ ng</Text>
            {formData.customerName ? (
              <View style={styles.selectedCustomerContainer}>
                <View style={styles.selectedCustomer}>
                  <Ionicons name="business-outline" size={20} color="#0066cc" />
                  <Text style={styles.selectedCustomerText}>
                    {formData.customerName}
                  </Text>
                </View>
                <TouchableOpacity
                  style={styles.clearCustomerButton}
                  onPress={handleClearCustomer}
                >
                  <Ionicons name="close-circle" size={20} color="#999" />
                </TouchableOpacity>
              </View>
            ) : (
              <TouchableOpacity
                style={styles.customerSelectButton}
                onPress={handleOpenCustomerModal}
              >
                <Ionicons name="add-circle-outline" size={20} color="#0066cc" />
                <Text style={styles.customerSelectButtonText}>
                  Chá»n khÃ¡ch hÃ ng
                </Text>
              </TouchableOpacity>
            )}
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>Tráº¡ng thÃ¡i</Text>
            <View style={styles.statusButtonsContainer}>
              <TouchableOpacity
                style={[
                  styles.statusButton,
                  formData.status === 'pending' && styles.selectedStatusButton,
                ]}
                onPress={() => handleSelectStatus('pending')}
              >
                <Text
                  style={[
                    styles.statusButtonText,
                    formData.status === 'pending' &&
                      styles.selectedStatusButtonText,
                  ]}
                >
                  Chá» xá»­ lÃ½
                </Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.statusButton,
                  formData.status === 'in-progress' &&
                    styles.selectedStatusButton,
                ]}
                onPress={() => handleSelectStatus('in-progress')}
              >
                <Text
                  style={[
                    styles.statusButtonText,
                    formData.status === 'in-progress' &&
                      styles.selectedStatusButtonText,
                  ]}
                >
                  Äang thá»±c hiá»‡n
                </Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.statusButton,
                  formData.status === 'completed' &&
                    styles.selectedStatusButton,
                ]}
                onPress={() => handleSelectStatus('completed')}
              >
                <Text
                  style={[
                    styles.statusButtonText,
                    formData.status === 'completed' &&
                      styles.selectedStatusButtonText,
                  ]}
                >
                  HoÃ n thÃ nh
                </Text>
              </TouchableOpacity>
            </View>

            <View style={[styles.statusButtonsContainer, { marginTop: 8 }]}>
              <TouchableOpacity
                style={[
                  styles.statusButton,
                  formData.status === 'cancelled' &&
                    styles.selectedStatusButton,
                ]}
                onPress={() => handleSelectStatus('cancelled')}
              >
                <Text
                  style={[
                    styles.statusButtonText,
                    formData.status === 'cancelled' &&
                      styles.selectedStatusButtonText,
                  ]}
                >
                  ÄÃ£ há»§y
                </Text>
              </TouchableOpacity>
            </View>
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>NgÃ y báº¯t Ä‘áº§u</Text>
            <TouchableOpacity
              style={styles.dateButton}
              onPress={() => setShowStartDatePicker(true)}
            >
              <Ionicons name="calendar-outline" size={20} color="#0066cc" />
              <Text style={styles.dateButtonText}>
                {formData.startDate
                  ? formatDate(formData.startDate)
                  : 'Chá»n ngÃ y báº¯t Ä‘áº§u'}
              </Text>
            </TouchableOpacity>
            {showStartDatePicker && (
              <DateTimePicker
                value={formData.startDate || new Date()}
                mode="date"
                display="default"
                onChange={handleStartDateChange}
              />
            )}
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>Sá»‘ ngÃ y thi cÃ´ng</Text>
            <TextInput
              style={styles.input}
              value={formData.durationInDays}
              onChangeText={handleDurationChange}
              placeholder="Nháº­p sá»‘ ngÃ y thi cÃ´ng"
              keyboardType="numeric"
            />
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>NgÃ y káº¿t thÃºc (tá»± Ä‘á»™ng tÃ­nh)</Text>
            <View style={styles.readOnlyField}>
              <Ionicons name="calendar-outline" size={20} color="#666" />
              <Text style={styles.readOnlyText}>
                {formData.endDate
                  ? formatDate(formData.endDate)
                  : 'ChÆ°a xÃ¡c Ä‘á»‹nh'}
              </Text>
            </View>
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>Vá»‹ trÃ­ thi cÃ´ng</Text>
            <View style={styles.locationButtonsContainer}>
              <TouchableOpacity
                style={[
                  styles.locationButton,
                  formData.location === 'workshop' &&
                    styles.selectedLocationButton,
                ]}
                onPress={() => handleLocationChange('workshop')}
              >
                <Text
                  style={[
                    styles.locationButtonText,
                    formData.location === 'workshop' &&
                      styles.selectedLocationButtonText,
                  ]}
                >
                  Táº¡i xÆ°á»Ÿng
                </Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.locationButton,
                  formData.location === 'site' && styles.selectedLocationButton,
                ]}
                onPress={() => handleLocationChange('site')}
              >
                <Text
                  style={[
                    styles.locationButtonText,
                    formData.location === 'site' &&
                      styles.selectedLocationButtonText,
                  ]}
                >
                  Táº¡i cÃ´ng trÃ¬nh
                </Text>
              </TouchableOpacity>
            </View>
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>NgÃ¢n sÃ¡ch</Text>
            <TextInput
              style={styles.input}
              value={formData.budget}
              onChangeText={(text) => handleChange('budget', text)}
              placeholder="Nháº­p ngÃ¢n sÃ¡ch dá»± Ã¡n"
              keyboardType="numeric"
            />
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>Ghi chÃº</Text>
            <TextInput
              style={[styles.input, styles.textArea]}
              value={formData.notes}
              onChangeText={(text) => handleChange('notes', text)}
              placeholder="Nháº­p ghi chÃº"
              multiline
              numberOfLines={3}
            />
          </View>

          <View style={styles.inputGroup}>
            <Text style={styles.label}>Quy trÃ¬nh Sáº£n xuáº¥t</Text>
            <DraggableFlatList
              data={workflowStages}
              keyExtractor={(item) => item.stageId}
              onDragEnd={({ data }) => setWorkflowStages(data)}
              renderItem={renderStageItem}
              scrollEnabled={false}
            />
            <TouchableOpacity
              style={styles.addStageBtn}
              onPress={() => setPickerVisible(true)}
            >
              <Ionicons name="add-circle-outline" size={20} color="#0066cc" />
              <Text style={styles.addStageText}>ThÃªm CÃ´ng Ä‘oáº¡n</Text>
            </TouchableOpacity>
          </View>
        </ScrollView>

        <View style={styles.footer}>
          <TouchableOpacity
            style={styles.saveButton}
            onPress={handleUpdate}
            disabled={isLoading}
          >
            {isLoading ? (
              <ActivityIndicator color="#fff" size="small" />
            ) : (
              <>
                <Ionicons name="save-outline" size={20} color="#fff" />
                <Text style={styles.saveButtonText}>LÆ°u thay Ä‘á»•i</Text>
              </>
            )}
          </TouchableOpacity>
        </View>

        {/* Modal chá»n khÃ¡ch hÃ ng */}
        <Modal
          visible={customerModalVisible}
          animationType="slide"
          transparent={true}
          onRequestClose={handleCloseCustomerModal}
        >
          <View style={styles.modalContainer}>
            <View style={styles.modalContent}>
              <View style={styles.modalHeader}>
                <Text style={styles.modalTitle}>Chá»n khÃ¡ch hÃ ng</Text>
                <TouchableOpacity
                  style={styles.closeButton}
                  onPress={handleCloseCustomerModal}
                >
                  <Ionicons name="close" size={24} color="#333" />
                </TouchableOpacity>
              </View>

              <View style={styles.searchContainer}>
                <Ionicons
                  name="search"
                  size={20}
                  color="#999"
                  style={styles.searchIcon}
                />
                <TextInput
                  style={styles.searchInput}
                  placeholder="TÃ¬m kiáº¿m khÃ¡ch hÃ ng..."
                  value={customerSearchQuery}
                  onChangeText={handleSearchCustomer}
                />
                {customerSearchQuery.length > 0 && (
                  <TouchableOpacity
                    onPress={() => setCustomerSearchQuery('')}
                    style={styles.clearSearchButton}
                  >
                    <Ionicons name="close-circle" size={18} color="#999" />
                  </TouchableOpacity>
                )}
              </View>

              {loadingCustomers ? (
                <View style={styles.loadingContainer}>
                  <ActivityIndicator size="large" color="#0066cc" />
                  <Text style={styles.loadingText}>
                    Äang táº£i danh sÃ¡ch khÃ¡ch hÃ ng...
                  </Text>
                </View>
              ) : (
                <FlatList
                  data={filteredCustomers}
                  keyExtractor={(item) => item.id}
                  renderItem={renderCustomerItem}
                  contentContainerStyle={styles.customersList}
                  ListEmptyComponent={() => (
                    <View style={styles.emptyListContainer}>
                      <Ionicons name="search-outline" size={40} color="#ccc" />
                      <Text style={styles.emptyListText}>
                        KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng phÃ¹ há»£p
                      </Text>
                    </View>
                  )}
                />
              )}
            </View>
          </View>
        </Modal>

        <ProcessPickerModal
          visible={pickerVisible}
          onClose={() => setPickerVisible(false)}
          onConfirm={handleAddStages}
          existingStageKeys={workflowStages.map((s) => s.processKey)}
        />
      </KeyboardAvoidingView>
    </GestureHandlerRootView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  placeholder: {
    width: 24,
  },
  formContainer: {
    flex: 1,
  },
  formContent: {
    padding: 16,
  },
  inputGroup: {
    marginBottom: 16,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    marginBottom: 6,
    color: '#333',
  },
  required: {
    color: '#e74c3c',
  },
  input: {
    backgroundColor: '#fff',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    color: '#333',
  },
  textArea: {
    minHeight: 80,
    textAlignVertical: 'top',
  },
  statusButtonsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  statusButton: {
    flex: 1,
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 8,
    borderRadius: 8,
    marginHorizontal: 4,
    alignItems: 'center',
  },
  selectedStatusButton: {
    backgroundColor: '#0066cc',
  },
  statusButtonText: {
    fontSize: 14,
    color: '#666',
    fontWeight: '500',
  },
  selectedStatusButtonText: {
    color: '#fff',
  },
  // ThÃªm style cho cÃ¡c trÆ°á»ng má»›i
  dateButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
  },
  dateButtonText: {
    fontSize: 16,
    color: '#333',
    marginLeft: 8,
  },
  locationButtonsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  locationButton: {
    flex: 1,
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 8,
    borderRadius: 8,
    marginHorizontal: 4,
    alignItems: 'center',
  },
  selectedLocationButton: {
    backgroundColor: '#0066cc',
  },
  locationButtonText: {
    fontSize: 14,
    color: '#666',
    fontWeight: '500',
  },
  selectedLocationButtonText: {
    color: '#fff',
  },
  customerSelectButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
  },
  customerSelectButtonText: {
    fontSize: 16,
    color: '#0066cc',
    marginLeft: 8,
  },
  selectedCustomerContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
  },
  selectedCustomer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  selectedCustomerText: {
    fontSize: 16,
    color: '#333',
    marginLeft: 8,
  },
  clearCustomerButton: {
    padding: 4,
  },
  footer: {
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  saveButton: {
    backgroundColor: '#0066cc',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 14,
    borderRadius: 8,
  },
  saveButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
    marginLeft: 8,
  },
  modalContainer: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'flex-end',
  },
  modalContent: {
    backgroundColor: '#fff',
    borderTopLeftRadius: 16,
    borderTopRightRadius: 16,
    height: '80%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  closeButton: {
    padding: 4,
  },
  searchContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    margin: 16,
    borderRadius: 8,
    paddingHorizontal: 12,
  },
  searchIcon: {
    marginRight: 8,
  },
  searchInput: {
    flex: 1,
    height: 40,
    fontSize: 16,
  },
  clearSearchButton: {
    padding: 4,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  loadingText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
  },
  customersList: {
    padding: 16,
    paddingTop: 0,
  },
  customerItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    backgroundColor: '#f9f9f9',
    padding: 12,
    borderRadius: 8,
    marginBottom: 8,
  },
  selectedCustomerItem: {
    borderWidth: 1,
    borderColor: '#0066cc',
    backgroundColor: '#f0f7ff',
  },
  customerName: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
    marginBottom: 2,
  },
  customerDetail: {
    fontSize: 14,
    color: '#666',
    marginTop: 2,
  },
  emptyListContainer: {
    alignItems: 'center',
    justifyContent: 'center',
    padding: 40,
  },
  emptyListText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  readOnlyField: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
  },
  readOnlyText: {
    fontSize: 16,
    color: '#666',
    marginLeft: 8,
  },
  stageRow: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 10,
    paddingHorizontal: 12,
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    marginBottom: 8,
    backgroundColor: '#fff',
  },
  dragHandle: {
    padding: 4,
    marginRight: 8,
  },
  stageInfo: { flex: 1 },
  statusBadge: {
    alignSelf: 'flex-start',
    marginTop: 4,
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  statusBadgeText: { fontSize: 12, fontWeight: '500' },
  deleteStageBtn: { padding: 4, marginLeft: 8 },
  addStageBtn: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    paddingVertical: 12,
    paddingHorizontal: 12,
    borderRadius: 8,
    marginTop: 16,
  },
  addStageText: {
    fontSize: 16,
    color: '#0066cc',
    marginLeft: 8,
  },
});

export default EditProjectScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\EditSupplierScreen.js ---

// src/screens/EditSupplierScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TextInput,
  TouchableOpacity,
  ScrollView,
  Alert,
  ActivityIndicator,
  SafeAreaView,
  KeyboardAvoidingView,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { getSupplierById, updateSupplier } from '../api/supplierService';
import { useAuth } from '../contexts/AuthContext';

const MATERIAL_CATEGORIES = [
  'ThÃ©p',
  'Gá»—',
  'KÃ­nh',
  'NhÃ´m',
  'Äiá»‡n',
  'NÆ°á»›c',
  'SÆ¡n',
  'Gáº¡ch',
  'Xi mÄƒng',
  'Thiáº¿t bá»‹ vá»‡ sinh',
  'Thiáº¿t bá»‹ Ä‘iá»‡n',
  'Váº­t liá»‡u hoÃ n thiá»‡n',
  'Sáº¯t',
  'Inox',
  'Phá»¥ kiá»‡n',
  'MÄƒng sÃ´ng',
  'Thiáº¿t bá»‹ hÃ n',
  'KhÃ­ hÃ n',
  'KhÃ¡c',
];

const EditSupplierScreen = ({ route, navigation }) => {
  const { supplier: initialSupplier } = route.params;
  const { currentUser } = useAuth();
  const [formData, setFormData] = useState({
    name: '',
    contactName: '',
    phone: '',
    email: '',
    address: '',
    taxCode: '',
    bankAccount: '',
    bankName: '',
    description: '',
    categories: [],
    verified: false,
  });
  const [errors, setErrors] = useState({});
  const [saving, setSaving] = useState(false);
  const [loading, setLoading] = useState(true);

  // Táº£i dá»¯ liá»‡u nhÃ  cung cáº¥p
  useEffect(() => {
    const loadSupplierData = async () => {
      try {
        if (initialSupplier) {
          // Náº¿u Ä‘Ã£ cÃ³ dá»¯ liá»‡u tá»« route params, sá»­ dá»¥ng nÃ³
          setFormData({
            ...initialSupplier,
            categories: initialSupplier.categories || [],
          });
          setLoading(false);
        } else if (route.params?.supplierId) {
          // Náº¿u chá»‰ cÃ³ ID, táº£i dá»¯ liá»‡u tá»« Firestore
          const supplierData = await getSupplierById(route.params.supplierId);
          setFormData({
            ...supplierData,
            categories: supplierData.categories || [],
          });
          setLoading(false);
        } else {
          // KhÃ´ng cÃ³ dá»¯ liá»‡u
          Alert.alert('Lá»—i', 'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin nhÃ  cung cáº¥p');
          navigation.goBack();
        }
      } catch (error) {
        console.error('Lá»—i khi táº£i dá»¯ liá»‡u nhÃ  cung cáº¥p:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i thÃ´ng tin nhÃ  cung cáº¥p');
        navigation.goBack();
      }
    };

    loadSupplierData();
  }, [route.params, initialSupplier, navigation]);

  const handleChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));

    // Clear error when field is edited
    if (errors[field]) {
      setErrors((prev) => ({
        ...prev,
        [field]: null,
      }));
    }
  };

  const toggleCategory = (category) => {
    setFormData((prev) => {
      const updatedCategories = [...prev.categories];

      if (updatedCategories.includes(category)) {
        // Remove category if already selected
        return {
          ...prev,
          categories: updatedCategories.filter((c) => c !== category),
        };
      } else {
        // Add category if not selected
        return {
          ...prev,
          categories: [...updatedCategories, category],
        };
      }
    });
  };

  const validateForm = () => {
    const newErrors = {};

    if (!formData.name.trim()) {
      newErrors.name = 'Vui lÃ²ng nháº­p tÃªn nhÃ  cung cáº¥p';
    }

    if (formData.phone && !/^[0-9]{10,11}$/.test(formData.phone.trim())) {
      newErrors.phone = 'Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡';
    }

    if (formData.email && !/\S+@\S+\.\S+/.test(formData.email.trim())) {
      newErrors.email = 'Email khÃ´ng há»£p lá»‡';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async () => {
    if (!validateForm()) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng kiá»ƒm tra láº¡i thÃ´ng tin nháº­p');
      return;
    }

    setSaving(true);
    try {
      // ThÃªm thÃ´ng tin ngÆ°á»i cáº­p nháº­t
      const updatedData = {
        ...formData,
        updatedBy: currentUser?.uid || 'unknown',
        updatedByName:
          currentUser?.displayName || currentUser?.email || 'NgÆ°á»i dÃ¹ng',
      };

      await updateSupplier(formData.id, updatedData);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ cáº­p nháº­t thÃ´ng tin nhÃ  cung cáº¥p', [
        { text: 'OK', onPress: () => navigation.goBack() },
      ]);
    } catch (error) {
      console.error('Lá»—i khi cáº­p nháº­t nhÃ  cung cáº¥p:', error);
      Alert.alert(
        'Lá»—i',
        'KhÃ´ng thá»ƒ cáº­p nháº­t thÃ´ng tin nhÃ  cung cáº¥p. Vui lÃ²ng thá»­ láº¡i sau.'
      );
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <SafeAreaView style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#0066cc" />
        <Text style={styles.loadingText}>Äang táº£i dá»¯ liá»‡u...</Text>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView style={styles.container}>
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={{ flex: 1 }}
      >
        <View style={styles.header}>
          <TouchableOpacity
            style={styles.backButton}
            onPress={() => navigation.goBack()}
          >
            <Ionicons name="arrow-back" size={24} color="#333" />
          </TouchableOpacity>
          <Text style={styles.headerTitle}>Chá»‰nh sá»­a nhÃ  cung cáº¥p</Text>
          <View style={{ width: 24 }} />
        </View>

        <ScrollView style={styles.content}>
          <View style={styles.formGroup}>
            <Text style={styles.label}>
              TÃªn nhÃ  cung cáº¥p <Text style={styles.required}>*</Text>
            </Text>
            <TextInput
              style={[styles.input, errors.name && styles.inputError]}
              value={formData.name}
              onChangeText={(text) => handleChange('name', text)}
              placeholder="Nháº­p tÃªn nhÃ  cung cáº¥p"
            />
            {errors.name && <Text style={styles.errorText}>{errors.name}</Text>}
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>NgÆ°á»i liÃªn há»‡</Text>
            <TextInput
              style={styles.input}
              value={formData.contactName}
              onChangeText={(text) => handleChange('contactName', text)}
              placeholder="Nháº­p tÃªn ngÆ°á»i liÃªn há»‡"
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Sá»‘ Ä‘iá»‡n thoáº¡i</Text>
            <TextInput
              style={[styles.input, errors.phone && styles.inputError]}
              value={formData.phone}
              onChangeText={(text) => handleChange('phone', text)}
              placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i"
              keyboardType="phone-pad"
            />
            {errors.phone && (
              <Text style={styles.errorText}>{errors.phone}</Text>
            )}
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Email</Text>
            <TextInput
              style={[styles.input, errors.email && styles.inputError]}
              value={formData.email}
              onChangeText={(text) => handleChange('email', text)}
              placeholder="Nháº­p Ä‘á»‹a chá»‰ email"
              keyboardType="email-address"
              autoCapitalize="none"
            />
            {errors.email && (
              <Text style={styles.errorText}>{errors.email}</Text>
            )}
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Äá»‹a chá»‰</Text>
            <TextInput
              style={styles.input}
              value={formData.address}
              onChangeText={(text) => handleChange('address', text)}
              placeholder="Nháº­p Ä‘á»‹a chá»‰"
              multiline
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>MÃ£ sá»‘ thuáº¿</Text>
            <TextInput
              style={styles.input}
              value={formData.taxCode}
              onChangeText={(text) => handleChange('taxCode', text)}
              placeholder="Nháº­p mÃ£ sá»‘ thuáº¿"
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>TÃ i khoáº£n ngÃ¢n hÃ ng</Text>
            <TextInput
              style={styles.input}
              value={formData.bankAccount}
              onChangeText={(text) => handleChange('bankAccount', text)}
              placeholder="Nháº­p sá»‘ tÃ i khoáº£n"
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>TÃªn ngÃ¢n hÃ ng</Text>
            <TextInput
              style={styles.input}
              value={formData.bankName}
              onChangeText={(text) => handleChange('bankName', text)}
              placeholder="Nháº­p tÃªn ngÃ¢n hÃ ng"
            />
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>Danh má»¥c váº­t tÆ° cung cáº¥p</Text>
            <View style={styles.categoriesContainer}>
              {MATERIAL_CATEGORIES.map((category, index) => (
                <TouchableOpacity
                  key={index}
                  style={[
                    styles.categoryTag,
                    formData.categories.includes(category) &&
                      styles.categoryTagSelected,
                  ]}
                  onPress={() => toggleCategory(category)}
                >
                  <Text
                    style={[
                      styles.categoryText,
                      formData.categories.includes(category) &&
                        styles.categoryTextSelected,
                    ]}
                  >
                    {category}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>
          </View>

          <View style={styles.formGroup}>
            <Text style={styles.label}>MÃ´ táº£</Text>
            <TextInput
              style={[styles.input, styles.textArea]}
              value={formData.description}
              onChangeText={(text) => handleChange('description', text)}
              placeholder="Nháº­p mÃ´ táº£ vá» nhÃ  cung cáº¥p"
              multiline
              numberOfLines={4}
              textAlignVertical="top"
            />
          </View>

          <View style={styles.verifiedContainer}>
            <TouchableOpacity
              style={styles.checkboxContainer}
              onPress={() => handleChange('verified', !formData.verified)}
            >
              <View
                style={[
                  styles.checkbox,
                  formData.verified && styles.checkboxChecked,
                ]}
              >
                {formData.verified && (
                  <Ionicons name="checkmark" size={16} color="#fff" />
                )}
              </View>
              <Text style={styles.checkboxLabel}>ÄÃ£ xÃ¡c minh</Text>
            </TouchableOpacity>
          </View>

          <TouchableOpacity
            style={styles.saveButton}
            onPress={handleSubmit}
            disabled={saving}
          >
            {saving ? (
              <ActivityIndicator color="#fff" size="small" />
            ) : (
              <Text style={styles.saveButtonText}>Cáº­p nháº­t</Text>
            )}
          </TouchableOpacity>
        </ScrollView>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#f5f5f5',
  },
  loadingText: {
    marginTop: 12,
    color: '#666',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  content: {
    flex: 1,
    padding: 16,
  },
  formGroup: {
    marginBottom: 16,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    color: '#333',
    marginBottom: 6,
  },
  required: {
    color: 'red',
  },
  input: {
    backgroundColor: '#fff',
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    paddingHorizontal: 12,
    paddingVertical: 10,
    fontSize: 16,
  },
  inputError: {
    borderColor: 'red',
  },
  errorText: {
    color: 'red',
    fontSize: 12,
    marginTop: 4,
  },
  textArea: {
    minHeight: 100,
    textAlignVertical: 'top',
  },
  categoriesContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    marginTop: 8,
  },
  categoryTag: {
    backgroundColor: '#f0f0f0',
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 16,
    marginRight: 8,
    marginBottom: 8,
  },
  categoryTagSelected: {
    backgroundColor: '#e6f2ff',
    borderWidth: 1,
    borderColor: '#0066cc',
  },
  categoryText: {
    fontSize: 14,
    color: '#666',
  },
  categoryTextSelected: {
    color: '#0066cc',
    fontWeight: '500',
  },
  verifiedContainer: {
    marginBottom: 24,
  },
  checkboxContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  checkbox: {
    width: 20,
    height: 20,
    borderRadius: 4,
    borderWidth: 1,
    borderColor: '#999',
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: 8,
  },
  checkboxChecked: {
    backgroundColor: '#0066cc',
    borderColor: '#0066cc',
  },
  checkboxLabel: {
    fontSize: 16,
    color: '#333',
  },
  saveButton: {
    backgroundColor: '#0066cc',
    paddingVertical: 14,
    borderRadius: 8,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 30,
  },
  saveButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
});

export default EditSupplierScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\FinalizeQuotationScreen.js ---

//src/screens/FinalizeQuotationScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TextInput,
  TouchableOpacity,
  ScrollView,
  KeyboardAvoidingView,
  Platform,
  Alert,
  ActivityIndicator,
  Linking,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import * as FileSystem from 'expo-file-system';
import * as Sharing from 'expo-sharing';
import { getAuth } from 'firebase/auth';
import { saveQuotation } from '../api/quotationService';
import useQuotationGenerator from '../hooks/useQuotationGenerator';
import useContractGenerator from '../hooks/useContractGenerator';
import { getFunctions, httpsCallable } from 'firebase/functions';

// HTML2PDF API key
// const HTML2PDF_API_KEY = 'Uvwhf4HC3SED5GIYlCx1F8A6jq2r3iJEt3FH8C16u1LprY5J5hBNXGIVfsLtqRxH';
// const HTML2PDF_API_URL = 'https://api.html2pdf.app/v1/generate';

// HÃ m chuyá»ƒn Ä‘á»•i sá»‘ thÃ nh chá»¯ tiáº¿ng Viá»‡t
const convertNumberToWords = (number) => {
  // Máº£ng tá»« ngá»¯ cho cÃ¡c sá»‘
  const units = [
    'khÃ´ng',
    'má»™t',
    'hai',
    'ba',
    'bá»‘n',
    'nÄƒm',
    'sÃ¡u',
    'báº£y',
    'tÃ¡m',
    'chÃ­n',
  ];
  const teens = [
    'mÆ°á»i',
    'mÆ°á»i má»™t',
    'mÆ°á»i hai',
    'mÆ°á»i ba',
    'mÆ°á»i bá»‘n',
    'mÆ°á»i lÄƒm',
    'mÆ°á»i sÃ¡u',
    'mÆ°á»i báº£y',
    'mÆ°á»i tÃ¡m',
    'mÆ°á»i chÃ­n',
  ];
  const tens = [
    '',
    'mÆ°á»i',
    'hai mÆ°Æ¡i',
    'ba mÆ°Æ¡i',
    'bá»‘n mÆ°Æ¡i',
    'nÄƒm mÆ°Æ¡i',
    'sÃ¡u mÆ°Æ¡i',
    'báº£y mÆ°Æ¡i',
    'tÃ¡m mÆ°Æ¡i',
    'chÃ­n mÆ°Æ¡i',
  ];
  const scales = ['', 'nghÃ¬n', 'triá»‡u', 'tá»·', 'nghÃ¬n tá»·', 'triá»‡u tá»·'];

  // HÃ m xá»­ lÃ½ sá»‘ cÃ³ 3 chá»¯ sá»‘
  const handleHundreds = (num, isFirstGroup) => {
    let result = '';
    const originalNum = num;

    // Xá»­ lÃ½ hÃ ng trÄƒm
    if (num >= 100) {
      result += units[Math.floor(num / 100)] + ' trÄƒm ';
      num %= 100;
    }

    // Xá»­ lÃ½ hÃ ng chá»¥c vÃ  Ä‘Æ¡n vá»‹
    if (num > 0) {
      // Chá»‰ thÃªm "láº»" náº¿u nÃ³ khÃ´ng pháº£i lÃ  nhÃ³m Ä‘áº§u tiÃªn (nhÃ³m Ä‘Æ¡n vá»‹) vÃ  sá»‘ cÃ³ 1 chá»¯ sá»‘
      // hoáº·c náº¿u hÃ ng trÄƒm cá»§a nhÃ³m Ä‘Ã³ > 0
      if (num < 10 && !isFirstGroup && originalNum > 99) {
        if (num === 1 && Math.floor(originalNum / 100) > 0) {
          result += 'linh má»™t'; // Sá»­ dá»¥ng "linh má»™t" thay vÃ¬ "láº» má»™t"
        } else {
          result += 'láº» ' + units[num];
        }
      } else if (num < 10) {
        result += units[num];
      } else if (num < 20) {
        // Náº¿u sá»‘ dÆ° < 20, sá»­ dá»¥ng máº£ng teens
        result += teens[num - 10];
      } else {
        // Náº¿u sá»‘ dÆ° >= 20
        const ten = Math.floor(num / 10);
        const unit = num % 10;
        result += tens[ten];
        if (unit > 0) {
          // Xá»­ lÃ½ trÆ°á»ng há»£p Ä‘áº·c biá»‡t cho "má»‘t" vÃ  "lÄƒm"
          if (unit === 1 && ten > 1) {
            result += ' má»‘t';
          } else if (unit === 5 && ten > 0) {
            result += ' lÄƒm';
          } else {
            result += ' ' + units[unit];
          }
        }
      }
    }

    return result.trim();
  };

  // HÃ m chÃ­nh Ä‘á»ƒ chuyá»ƒn Ä‘á»•i sá»‘ thÃ nh chá»¯
  const convert = (num) => {
    if (num === 0) return 'khÃ´ng';

    let result = '';
    let scaleIndex = 0;

    // Xá»­ lÃ½ sá»‘ theo tá»«ng nhÃ³m 3 chá»¯ sá»‘
    while (num > 0) {
      const group = num % 1000;
      if (group !== 0) {
        const isFirstGroup = scaleIndex === 0;
        const groupText = handleHundreds(group, isFirstGroup);
        result =
          groupText +
          (scaleIndex > 0 ? ' ' + scales[scaleIndex] + ' ' : '') +
          result;
      }

      num = Math.floor(num / 1000);
      scaleIndex++;
    }

    return result.trim().replace(/\s\s+/g, ' '); // Loáº¡i bá» khoáº£ng tráº¯ng thá»«a
  };

  // Xá»­ lÃ½ sá»‘ tiá»n (chá»‰ láº¥y pháº§n nguyÃªn)
  const integerPart = Math.floor(number);

  let result = convert(integerPart) + ' Ä‘á»“ng';

  // Viáº¿t hoa chá»¯ cÃ¡i Ä‘áº§u
  return result.charAt(0).toUpperCase() + result.slice(1);
};

const FinalizeQuotationScreen = ({ route, navigation }) => {
  const {
    materials: newMaterials,
    subTotal: newSubTotal,
    projectId,
    projectName,
    customerData,
    initialData,
  } = route.params;

  // Determine if we are re-quoting and calculate subTotal accordingly
  const isRequoting = !!initialData;
  const materialsData = isRequoting ? initialData.materials : newMaterials;

  const subTotalData = isRequoting
    ? initialData.materials.reduce(
        (acc, item) => acc + (item.totalPrice || 0),
        0
      )
    : newSubTotal;

  // Initialize the quotation generator hook
  const {
    generateExcelQuotation,
    shareExcelQuotation,
    isLoading: isExcelLoading,
    excelUrl,
  } = useQuotationGenerator({
    projectId,
    customerData,
    materials: materialsData,
  });

  // Initialize the contract generator hook
  const {
    generateContract,
    shareContractDoc,
    isLoading: isContractLoading,
    contractDocUrl,
  } = useContractGenerator({
    projectId,
    customerData,
    materials: materialsData,
    quotationData: {
      deliveryTime,
      paymentTerms,
      warrantyTerms,
    },
  });

  // Use initialData if it exists (for re-quoting), otherwise use new data
  const sourceData = initialData || route.params;

  // State cho cÃ¡c trÆ°á»ng nháº­p liá»‡u
  const [discountPercentage, setDiscountPercentage] = useState(
    sourceData.discountPercentage?.toString() || '0'
  );
  const [vatPercentage, setVatPercentage] = useState(
    sourceData.vatPercentage?.toString() || '10'
  );
  const [quoteValidity, setQuoteValidity] = useState(
    sourceData.quoteValidity || '7 ngÃ y'
  );
  const [deliveryTime, setDeliveryTime] = useState(
    sourceData.deliveryTime || '15 ngÃ y'
  );
  const [notes, setNotes] = useState(sourceData.notes || '');
  const [paymentTerms, setPaymentTerms] = useState(
    sourceData.paymentTerms ||
      'Äá»£t 1: Thanh toÃ¡n 50% ngay sau khi kÃ½ há»£p Ä‘á»“ng.\nÄá»£t 2: Thanh toÃ¡n 50% cÃ²n láº¡i sau khi nghiá»‡m thu vÃ  bÃ n giao.'
  );
  const [warrantyTerms, setWarrantyTerms] = useState(
    sourceData.warrantyTerms || 'Báº£o hÃ nh 12 thÃ¡ng cho toÃ n bá»™ cÃ´ng trÃ¬nh.'
  );
  const [otherTerms, setOtherTerms] = useState(sourceData.otherTerms || '');
  const [bankDetails, setBankDetails] = useState(
    sourceData.bankDetails ||
      'TÃªn tÃ i khoáº£n: CÃ”NG TY TNHH ABC\nSá»‘ tÃ i khoáº£n: 123456789\nNgÃ¢n hÃ ng: Vietcombank - Chi nhÃ¡nh XYZ'
  );

  // State cho cÃ¡c giÃ¡ trá»‹ tÃ­nh toÃ¡n
  const [discountAmount, setDiscountAmount] = useState(0);
  const [afterDiscountTotal, setAfterDiscountTotal] = useState(subTotalData);
  const [vatAmount, setVatAmount] = useState(0);
  const [grandTotal, setGrandTotal] = useState(subTotalData);
  const [amountInWords, setAmountInWords] = useState('');

  // State cho quÃ¡ trÃ¬nh táº¡o PDF vÃ  Excel
  const [isLoading, setIsLoading] = useState(false);
  const [pdfLocalUri, setPdfLocalUri] = useState(null);
  const [materials, setMaterials] = useState(materialsData || []);

  // TÃ­nh toÃ¡n láº¡i cÃ¡c giÃ¡ trá»‹ khi ngÆ°á»i dÃ¹ng thay Ä‘á»•i Ä‘áº§u vÃ o
  useEffect(() => {
    // Defensive calculations to prevent NaN issues
    const safeSubTotal = Number(subTotalData) || 0;
    const discountPercent = parseFloat(discountPercentage) || 0;
    const vatPercent = parseFloat(vatPercentage) || 0;

    // Calculate all financial values as local constants
    const calculatedDiscountAmount = (safeSubTotal * discountPercent) / 100;
    const calculatedAfterDiscountTotal =
      safeSubTotal - calculatedDiscountAmount;
    const calculatedVatAmount =
      (calculatedAfterDiscountTotal * vatPercent) / 100;
    const calculatedGrandTotal =
      calculatedAfterDiscountTotal + calculatedVatAmount;
    const calculatedAmountInWords = convertNumberToWords(calculatedGrandTotal);

    // Update all states at once
    setDiscountAmount(calculatedDiscountAmount);
    setAfterDiscountTotal(calculatedAfterDiscountTotal);
    setVatAmount(calculatedVatAmount);
    setGrandTotal(calculatedGrandTotal);
    setAmountInWords(calculatedAmountInWords);
  }, [subTotalData, discountPercentage, vatPercentage]);

  const handleGenerateAndSave = async () => {
    setIsLoading(true);
    setPdfLocalUri(null); // Reset previous URI

    try {
      const auth = getAuth();
      const userId = auth.currentUser?.uid;

      if (!userId) {
        Alert.alert('Lá»—i', 'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ táº¡o bÃ¡o giÃ¡.');
        setIsLoading(false); // Stop loading on error
        return;
      }

      const effectiveProjectId = projectId || route?.params?.projectId;

      if (!effectiveProjectId) {
        Alert.alert('Lá»—i', 'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin dá»± Ã¡n. Vui lÃ²ng thá»­ láº¡i.');
        setIsLoading(false);
        return;
      }

      // 1. Chuáº©n bá»‹ dá»¯ liá»‡u bÃ¡o giÃ¡
      const quotationNumber = `HK-${new Date().getFullYear()}-${Math.floor(
        Math.random() * 1000
      )
        .toString()
        .padStart(3, '0')}`;

      // Assemble the complete, self-contained quotation object for versioning
      // This is the complete snapshot sent to the Cloud Function and saved to Firestore.
      const quotationDataForSaving = {
        // Core Info
        quotationNumber,
        createdBy: userId,
        projectName: projectName,
        quotationDate: new Date().toISOString(),

        // Customer Info
        customerData: customerData,

        // Financial Snapshot (Using state values)
        subTotal: subTotalData,
        discountPercentage: parseFloat(discountPercentage) || 0,
        discountAmount: discountAmount,
        afterDiscountTotal: afterDiscountTotal,
        vatPercentage: parseFloat(vatPercentage) || 0,
        vatAmount: vatAmount,
        grandTotal: grandTotal,
        amountInWords: amountInWords,

        // Materials Snapshot
        materials: materials,

        // Terms Snapshot
        quoteValidity: quoteValidity,
        deliveryTime: deliveryTime,
        paymentTerms: paymentTerms,
        warrantyTerms: warrantyTerms,
        otherTerms: otherTerms,
        bankDetails: bankDetails,
        notes: notes,
      };

      // 2. Gá»i Cloud Function Ä‘á»ƒ láº¥y URL cá»§a PDF
      console.log('Calling Cloud Function with complete data payload...');
      const functions = getFunctions();
      const generateInvoicePDF = httpsCallable(functions, 'generateInvoicePDF');
      const result = await generateInvoicePDF({
        userId,
        quotationData: quotationDataForSaving, // Pass the self-contained data
        projectId: effectiveProjectId,
      });

      const { pdfUrl } = result.data;
      if (!pdfUrl) {
        throw new Error('KhÃ´ng nháº­n Ä‘Æ°á»£c URL cá»§a PDF tá»« server.');
      }
      console.log('Received PDF URL:', pdfUrl);

      // 3. Táº£i file PDF vá» mÃ¡y Ä‘á»ƒ láº¥y local URI
      console.log('Downloading PDF to local device...');
      const fileUri = FileSystem.documentDirectory + `${quotationNumber}.pdf`;
      const { uri } = await FileSystem.downloadAsync(pdfUrl, fileUri);
      console.log('File downloaded to:', uri);

      // LÆ°u local URI vÃ o state Ä‘á»ƒ cÃ³ thá»ƒ chia sáº» sau
      setPdfLocalUri(uri);

      // 4. LÆ°u thÃ´ng tin bÃ¡o giÃ¡ vÃ o Firestore, now including the pdfUrl
      await saveQuotation(effectiveProjectId, {
        ...quotationDataForSaving,
        pdfUrl,
      });

      // 5. ThÃ´ng bÃ¡o thÃ nh cÃ´ng
      Alert.alert(
        'ThÃ nh cÃ´ng',
        'ÄÃ£ táº¡o vÃ  lÆ°u bÃ¡o giÃ¡ thÃ nh cÃ´ng. Báº¡n cÃ³ muá»‘n xem hoáº·c chia sáº» file PDF khÃ´ng?',
        [
          { text: 'Äá»ƒ sau', style: 'cancel' },
          { text: 'Chia sáº»', onPress: () => handleSharePdf(uri) },
          { text: 'Xem PDF', onPress: () => handleSharePdf(uri) },
        ]
      );
    } catch (error) {
      console.error('Error generating PDF and saving quotation:', error);
      const errorMessage = error.message || 'Má»™t lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Ã£ xáº£y ra.';
      Alert.alert('Lá»—i', `KhÃ´ng thá»ƒ táº¡o bÃ¡o giÃ¡: ${errorMessage}`);
    } finally {
      setIsLoading(false);
    }
  };

  // HÃ m chia sáº» file PDF Ä‘Ã£ Ä‘Æ°á»£c táº£i vá»
  const handleSharePdf = async (localUri) => {
    if (!localUri) {
      Alert.alert(
        'Lá»—i',
        'KhÃ´ng tÃ¬m tháº¥y file PDF Ä‘á»ƒ chia sáº». Vui lÃ²ng táº¡o láº¡i.'
      );
      return;
    }
    const isSharingAvailable = await Sharing.isAvailableAsync();
    if (!isSharingAvailable) {
      Alert.alert('Lá»—i', 'Chia sáº» khÃ´ng kháº£ dá»¥ng trÃªn thiáº¿t bá»‹ cá»§a báº¡n.');
      return;
    }
    try {
      await Sharing.shareAsync(localUri, {
        mimeType: 'application/pdf',
        dialogTitle: 'Chia sáº» bÃ¡o giÃ¡',
      });
    } catch (error) {
      console.error('Error sharing PDF:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ chia sáº» file PDF.');
    }
  };

  // HÃ m táº¡o bÃ¡o giÃ¡ Excel
  const handleGenerateExcel = async () => {
    try {
      const auth = getAuth();
      const userId = auth.currentUser?.uid;

      if (!userId) {
        Alert.alert('Lá»—i', 'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ táº¡o bÃ¡o giÃ¡ Excel.');
        return;
      }

      const effectiveProjectId = projectId || route?.params?.projectId;

      if (!effectiveProjectId) {
        Alert.alert('Lá»—i', 'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin dá»± Ã¡n. Vui lÃ²ng thá»­ láº¡i.');
        return;
      }

      // 1. Chuáº©n bá»‹ dá»¯ liá»‡u bÃ¡o giÃ¡
      const quotationNumber = `THP-${new Date().getFullYear()}-${Math.floor(
        Math.random() * 1000
      )
        .toString()
        .padStart(3, '0')}`;

      // Assemble the complete quotation data
      const quotationData = {
        // Core Info
        quotationNumber,
        createdBy: userId,
        projectName: projectName,
        quotationDate: new Date().toISOString(),

        // Customer Info - Äáº£m báº£o dá»¯ liá»‡u khÃ¡ch hÃ ng Ä‘Æ°á»£c gá»­i Ä‘Ãºng Ä‘á»‹nh dáº¡ng
        metadata: {
          projectName: projectName,
          customerName: customerData?.name || '',
          customerAddress: customerData?.address || '',
          customerPhone: customerData?.phone || '',
          customerEmail: customerData?.email || '',
          customerTaxCode: customerData?.taxCode || '',
          customerContactPerson: customerData?.contactPerson || '',
          quotationNumber: quotationNumber,
          quoteValidity: quoteValidity,
          deliveryTime: deliveryTime,
        },

        // Financial Snapshot
        subTotal: subTotalData,
        discountPercentage: parseFloat(discountPercentage) || 0,
        discountAmount: discountAmount,
        afterDiscountTotal: afterDiscountTotal,
        vatPercentage: parseFloat(vatPercentage) || 0,
        vatAmount: vatAmount,
        grandTotal: grandTotal,
        amountInWords: amountInWords,

        // Materials Snapshot
        materials: materials.map((material) => ({
          no: material.no || material.id || 0,
          name: material.name || material.description || '',
          material: material.material || material.type || '',
          unit: material.unit || 'cÃ¡i',
          quantity: material.quantity || 0,
          unitPrice: material.unitPrice || material.price || 0,
          total: material.totalPrice || material.total || 0,
          weight: material.weight || 0,
        })),

        // Terms Snapshot
        quoteValidity: quoteValidity,
        deliveryTime: deliveryTime,
        paymentTerms: paymentTerms,
        warrantyTerms: warrantyTerms,
        otherTerms: otherTerms,
        bankDetails: bankDetails,
        notes: notes,

        // Tá»•ng há»£p thÃ´ng tin tÃ i chÃ­nh
        summary: {
          subTotal: subTotalData,
          vatPercentage: parseFloat(vatPercentage) || 0,
          vatAmount: vatAmount,
          grandTotal: grandTotal,
        },
      };

      // Gá»i function táº¡o bÃ¡o giÃ¡ Excel
      const url = await generateExcelQuotation(quotationData);

      if (url) {
        Alert.alert(
          'ThÃ nh cÃ´ng',
          'ÄÃ£ táº¡o bÃ¡o giÃ¡ Excel thÃ nh cÃ´ng. Báº¡n cÃ³ muá»‘n chia sáº» file Excel khÃ´ng?',
          [
            { text: 'Äá»ƒ sau', style: 'cancel' },
            { text: 'Chia sáº»', onPress: () => shareExcelQuotation() },
          ]
        );
      }
    } catch (error) {
      console.error('Error generating Excel:', error);
      Alert.alert(
        'Lá»—i',
        `KhÃ´ng thá»ƒ táº¡o bÃ¡o giÃ¡ Excel: ${error.message || 'Unknown error'}`
      );
    }
  };

  // Function to handle contract generation
  const handleGenerateContract = async () => {
    try {
      await generateContract();
    } catch (error) {
      console.error('Error generating contract:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº¡o há»£p Ä‘á»“ng: ' + error.message);
    }
  };

  // Format sá»‘ tiá»n VND
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
    }).format(amount);
  };

  return (
    <KeyboardAvoidingView
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : undefined}
      keyboardVerticalOffset={Platform.OS === 'ios' ? 64 : 0}
    >
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Ionicons name="arrow-back" size={24} color="#333" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>HoÃ n thiá»‡n bÃ¡o giÃ¡</Text>
        <View style={styles.placeholder} />
      </View>

      <ScrollView style={styles.content}>
        {/* Hiá»ƒn thá»‹ tá»•ng tiá»n váº­t tÆ° */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Tá»•ng cá»™ng váº­t tÆ°</Text>
          <Text style={styles.subTotalValue}>
            {formatCurrency(subTotalData)}
          </Text>
        </View>

        {/* Pháº§n nháº­p chiáº¿t kháº¥u vÃ  VAT */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Äiá»u chá»‰nh giÃ¡</Text>

          <View style={styles.inputRow}>
            <Text style={styles.inputLabel}>Chiáº¿t kháº¥u (%)</Text>
            <TextInput
              style={styles.input}
              value={discountPercentage}
              onChangeText={setDiscountPercentage}
              keyboardType="numeric"
              placeholder="0"
              maxLength={5}
            />
          </View>

          <View style={styles.inputRow}>
            <Text style={styles.inputLabel}>Thuáº¿ VAT (%)</Text>
            <TextInput
              style={styles.input}
              value={vatPercentage}
              onChangeText={setVatPercentage}
              keyboardType="numeric"
              placeholder="10"
              maxLength={5}
            />
          </View>
        </View>

        {/* Pháº§n tÃ³m táº¯t tÃ­nh toÃ¡n */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>TÃ³m táº¯t</Text>

          <View style={styles.summaryRow}>
            <Text style={styles.summaryLabel}>Tá»•ng cá»™ng váº­t tÆ°:</Text>
            <Text style={styles.summaryValue}>
              {formatCurrency(subTotalData)}
            </Text>
          </View>

          <View style={styles.summaryRow}>
            <Text style={styles.summaryLabel}>
              Chiáº¿t kháº¥u ({discountPercentage}%):
            </Text>
            <Text style={styles.summaryValue}>
              - {formatCurrency(discountAmount)}
            </Text>
          </View>

          <View style={styles.summaryRow}>
            <Text style={styles.summaryLabel}>Tá»•ng cá»™ng sau chiáº¿t kháº¥u:</Text>
            <Text style={styles.summaryValue}>
              {formatCurrency(afterDiscountTotal)}
            </Text>
          </View>

          <View style={styles.summaryRow}>
            <Text style={styles.summaryLabel}>
              Tiá»n thuáº¿ VAT ({vatPercentage}%):
            </Text>
            <Text style={styles.summaryValue}>{formatCurrency(vatAmount)}</Text>
          </View>

          <View style={[styles.summaryRow, styles.totalRow]}>
            <Text style={styles.totalLabel}>Tá»”NG Cá»˜NG ÄÃƒ BAO Gá»’M VAT:</Text>
            <Text style={styles.totalValue}>{formatCurrency(grandTotal)}</Text>
          </View>

          <View style={styles.wordsContainer}>
            <Text style={styles.wordsLabel}>Báº±ng chá»¯:</Text>
            <Text style={styles.wordsValue}>{amountInWords}</Text>
          </View>
        </View>

        {/* Pháº§n Ä‘iá»u khoáº£n */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Äiá»u khoáº£n bÃ¡o giÃ¡</Text>

          <View style={styles.inputRow}>
            <Text style={styles.inputLabel}>Hiá»‡u lá»±c bÃ¡o giÃ¡</Text>
            <TextInput
              style={styles.input}
              value={quoteValidity}
              onChangeText={setQuoteValidity}
              placeholder="7 ngÃ y"
            />
          </View>

          <View style={styles.inputRow}>
            <Text style={styles.inputLabel}>Thá»i gian giao hÃ ng</Text>
            <TextInput
              style={styles.input}
              value={deliveryTime}
              onChangeText={setDeliveryTime}
              placeholder="15 ngÃ y"
            />
          </View>

          <View style={styles.notesContainer}>
            <Text style={styles.inputLabel}>Ghi chÃº</Text>
            <TextInput
              style={styles.notesInput}
              value={notes}
              onChangeText={setNotes}
              placeholder="Nháº­p ghi chÃº (vÃ­ dá»¥: + SÆ N EPOXY)"
              multiline
              numberOfLines={3}
              textAlignVertical="top"
            />
          </View>

          <View style={styles.notesContainer}>
            <Text style={styles.inputLabel}>PhÆ°Æ¡ng thá»©c thanh toÃ¡n</Text>
            <TextInput
              style={styles.notesInput}
              value={paymentTerms}
              onChangeText={setPaymentTerms}
              placeholder="Nháº­p phÆ°Æ¡ng thá»©c thanh toÃ¡n"
              multiline
              numberOfLines={2}
              textAlignVertical="top"
            />
          </View>

          <View style={styles.notesContainer}>
            <Text style={styles.inputLabel}>Äiá»u khoáº£n báº£o hÃ nh</Text>
            <TextInput
              style={styles.notesInput}
              value={warrantyTerms}
              onChangeText={setWarrantyTerms}
              placeholder="Nháº­p Ä‘iá»u khoáº£n báº£o hÃ nh"
              multiline
              numberOfLines={2}
              textAlignVertical="top"
            />
          </View>

          <View style={styles.notesContainer}>
            <Text style={styles.inputLabel}>ThÃ´ng tin ngÃ¢n hÃ ng</Text>
            <TextInput
              style={styles.notesInput}
              value={bankDetails}
              onChangeText={setBankDetails}
              placeholder="Nháº­p thÃ´ng tin ngÃ¢n hÃ ng"
              multiline
              numberOfLines={3}
              textAlignVertical="top"
            />
          </View>

          <View style={styles.notesContainer}>
            <Text style={styles.inputLabel}>Äiá»u khoáº£n khÃ¡c</Text>
            <TextInput
              style={styles.notesInput}
              value={otherTerms}
              onChangeText={setOtherTerms}
              placeholder="Nháº­p cÃ¡c Ä‘iá»u khoáº£n khÃ¡c"
              multiline
              numberOfLines={2}
              textAlignVertical="top"
            />
          </View>
        </View>
      </ScrollView>

      {/* NÃºt táº¡o PDF vÃ  Excel */}
      <View style={styles.footer}>
        <TouchableOpacity
          style={[styles.button, { backgroundColor: '#4CAF50' }]}
          onPress={handleGenerateAndSave}
          disabled={isLoading}
        >
          {isLoading ? (
            <ActivityIndicator size="small" color="#fff" />
          ) : (
            <Text style={styles.buttonText}>Táº¡o & LÆ°u BÃ¡o GiÃ¡ PDF</Text>
          )}
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.button, { backgroundColor: '#FF9800' }]}
          onPress={handleGenerateExcel}
          disabled={isExcelLoading}
        >
          {isExcelLoading ? (
            <ActivityIndicator size="small" color="#fff" />
          ) : (
            <>
              <Ionicons
                name="document-text"
                size={20}
                color="white"
                style={{ marginRight: 10 }}
              />
              <Text style={styles.buttonText}>Táº¡o BÃ¡o GiÃ¡ Excel</Text>
            </>
          )}
        </TouchableOpacity>

        {/* Contract generation button */}
        <TouchableOpacity
          style={[styles.button, { backgroundColor: '#9C27B0' }]}
          onPress={handleGenerateContract}
          disabled={isContractLoading}
        >
          {isContractLoading ? (
            <ActivityIndicator size="small" color="#fff" />
          ) : (
            <>
              <Ionicons
                name="document-text"
                size={20}
                color="white"
                style={{ marginRight: 10 }}
              />
              <Text style={styles.buttonText}>Táº¡o Há»£p Äá»“ng</Text>
            </>
          )}
        </TouchableOpacity>

        {pdfLocalUri && (
          <TouchableOpacity
            style={[styles.button, { backgroundColor: '#2196F3' }]}
            onPress={() => handleSharePdf(pdfLocalUri)}
          >
            <Ionicons
              name="share-social"
              size={20}
              color="white"
              style={{ marginRight: 10 }}
            />
            <Text style={styles.buttonText}>Chia Sáº» PDF</Text>
          </TouchableOpacity>
        )}

        {/* NÃºt Chia Sáº» Há»£p Äá»“ng (chá»‰ hiá»ƒn thá»‹ khi cÃ³ link) */}
        {contractDocUrl && !isContractLoading && (
          <TouchableOpacity
            style={[styles.button, { backgroundColor: '#673AB7' }]}
            onPress={() => shareContractDoc()}
          >
            <Ionicons
              name="share-social"
              size={20}
              color="white"
              style={{ marginRight: 10 }}
            />
            <Text style={styles.buttonText}>Chia Sáº» Há»£p Äá»“ng</Text>
          </TouchableOpacity>
        )}

        {excelUrl && (
          <TouchableOpacity
            style={[styles.button, { backgroundColor: '#009688' }]}
            onPress={shareExcelQuotation}
          >
            <Ionicons
              name="share-social"
              size={20}
              color="white"
              style={{ marginRight: 10 }}
            />
            <Text style={styles.buttonText}>Chia Sáº» Excel</Text>
          </TouchableOpacity>
        )}
      </View>
    </KeyboardAvoidingView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F5F5F5',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  placeholder: {
    width: 24,
  },
  content: {
    flex: 1,
  },
  section: {
    backgroundColor: '#fff',
    marginBottom: 12,
    padding: 16,
    borderRadius: 8,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
    elevation: 2,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#333',
    marginBottom: 16,
  },
  subTotalValue: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#0066cc',
  },
  inputRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
  },
  inputLabel: {
    fontSize: 16,
    color: '#555',
    flex: 1,
  },
  input: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 6,
    padding: 10,
    fontSize: 16,
    width: '40%',
    textAlign: 'right',
  },
  notesContainer: {
    marginBottom: 16,
  },
  notesInput: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 6,
    padding: 10,
    fontSize: 16,
    marginTop: 8,
    height: 80,
  },
  summaryRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 8,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  summaryLabel: {
    fontSize: 16,
    color: '#555',
  },
  summaryValue: {
    fontSize: 16,
    fontWeight: '500',
    color: '#333',
  },
  totalRow: {
    marginTop: 8,
    paddingTop: 12,
    borderTopWidth: 1,
    borderTopColor: '#ddd',
    borderBottomWidth: 0,
  },
  totalLabel: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  totalValue: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#0066cc',
  },
  wordsContainer: {
    marginTop: 16,
    padding: 12,
    backgroundColor: '#f5f5f5',
    borderRadius: 6,
  },
  wordsLabel: {
    fontSize: 14,
    color: '#666',
    marginBottom: 4,
  },
  wordsValue: {
    fontSize: 16,
    fontWeight: '500',
    color: '#333',
    fontStyle: 'italic',
  },
  footer: {
    backgroundColor: '#fff',
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  button: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 15,
    borderRadius: 8,
    marginVertical: 10,
    marginHorizontal: 20,
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
});

export default FinalizeQuotationScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\HomeScreen.js ---

//src/screens/HomeScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  StatusBar,
  TouchableOpacity,
  ScrollView,
  ActivityIndicator,
  Alert,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Ionicons } from '@expo/vector-icons';
import { useTheme } from '../contexts/ThemeContext';
import { getProjects } from '../api/projectService';
import { getCustomers } from '../api/customerService';
import { useFocusEffect } from '@react-navigation/native';
import {
  getAttendance,
  clockIn,
  clockOut,
  addOvertime,
  getAttendanceStatus,
} from '../api/attendanceService';
import { useAuth } from '../contexts/AuthContext';

const HomeScreen = ({ navigation }) => {
  const { theme, isDarkMode } = useTheme();
  const { user } = useAuth();
  const [recentProjects, setRecentProjects] = useState([]);
  const [recentCustomers, setRecentCustomers] = useState([]);
  const [loading, setLoading] = useState(true);

  // Attendance state
  const [attendance, setAttendance] = useState(null);
  const [attLoading, setAttLoading] = useState(true);

  const ROLE_CAN_ATTEND = ['ke_toan'];

  const canUseAttendance = ROLE_CAN_ATTEND.includes(
    (user?.role || '').toLowerCase()
  );

  const loadAttendance = async () => {
    if (!user?.uid || !canUseAttendance) {
      setAttendance(null);
      setAttLoading(false);
      return;
    }
    try {
      setAttLoading(true);
      const doc = await getAttendance(user.uid);
      setAttendance(doc);
    } catch (err) {
      console.error('Load attendance error:', err);
    } finally {
      setAttLoading(false);
    }
  };

  // HÃ m táº£i dá»¯ liá»‡u trang chá»§
  const loadHomeData = async () => {
    try {
      setLoading(true);

      // Láº¥y danh sÃ¡ch dá»± Ã¡n vÃ  khÃ¡ch hÃ ng
      const projectsData = await getProjects();
      const customersData = await getCustomers();

      // Láº¥y 3 dá»± Ã¡n má»›i nháº¥t
      setRecentProjects(projectsData.slice(0, 3));

      // Láº¥y 3 khÃ¡ch hÃ ng má»›i nháº¥t
      setRecentCustomers(customersData.slice(0, 3));
    } catch (error) {
      console.error('Lá»—i khi táº£i dá»¯ liá»‡u trang chá»§:', error);
    } finally {
      setLoading(false);
    }
  };

  // Táº£i dá»¯ liá»‡u khi mÃ n hÃ¬nh Ä‘Æ°á»£c má»Ÿ
  useEffect(() => {
    loadHomeData();
    loadAttendance();
  }, []);

  // LÃ m má»›i dá»¯ liá»‡u khi mÃ n hÃ¬nh Ä‘Æ°á»£c focus
  useFocusEffect(
    React.useCallback(() => {
      loadHomeData();
      loadAttendance();
    }, [])
  );

  const handleClockIn = async () => {
    try {
      setAttLoading(true);
      await clockIn(user.uid);
      loadAttendance();
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cháº¥m cÃ´ng vÃ o.');
    }
  };

  const handleClockOut = async () => {
    try {
      setAttLoading(true);
      await clockOut(user.uid);
      loadAttendance();
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cháº¥m cÃ´ng ra.');
    }
  };

  const handleAddOvertime = async (hours) => {
    try {
      setAttLoading(true);
      await addOvertime(user.uid, hours);
      loadAttendance();
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ thÃªm giá» tÄƒng ca.');
    }
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥n vÃ o dá»± Ã¡n
  const handleProjectPress = (project) => {
    navigation.navigate('ProjectDetail', { projectId: project.id });
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥n vÃ o khÃ¡ch hÃ ng
  const handleCustomerPress = (customer) => {
    navigation.navigate('CustomerDetail', { customerId: customer.id });
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥n vÃ o nÃºt xem táº¥t cáº£ dá»± Ã¡n
  const handleViewAllProjects = () => {
    navigation.navigate('Projects');
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥n vÃ o nÃºt xem táº¥t cáº£ khÃ¡ch hÃ ng
  const handleViewAllCustomers = () => {
    navigation.navigate('Customers');
  };

  // HÃ m láº¥y mÃ u tráº¡ng thÃ¡i dá»± Ã¡n
  const getStatusColor = (status) => {
    switch (status) {
      case 'completed':
        return theme.statusCompleted;
      case 'in-progress':
        return theme.statusInProgress;
      case 'pending':
        return theme.statusPending;
      case 'cancelled':
        return theme.statusCancelled;
      default:
        return theme.textMuted;
    }
  };

  // HÃ m láº¥y nhÃ£n tráº¡ng thÃ¡i dá»± Ã¡n
  const getStatusLabel = (status) => {
    switch (status) {
      case 'completed':
        return 'HoÃ n thÃ nh';
      case 'in-progress':
        return 'Äang thá»±c hiá»‡n';
      case 'pending':
        return 'Chá» xá»­ lÃ½';
      case 'cancelled':
        return 'ÄÃ£ há»§y';
      default:
        return status || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
    }
  };

  return (
    <SafeAreaView
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      <StatusBar
        barStyle={isDarkMode ? 'light-content' : 'dark-content'}
        backgroundColor={theme.background}
      />

      {canUseAttendance && (
        <View style={{ paddingHorizontal: 16, marginTop: 8 }}>
          <View
            style={{
              backgroundColor: theme.card,
              borderRadius: 8,
              padding: 16,
              borderWidth: 1,
              borderColor: theme.border,
              marginBottom: 16,
            }}
          >
            <Text
              style={{
                fontSize: 18,
                fontWeight: 'bold',
                color: theme.text,
                marginBottom: 8,
              }}
            >
              Cháº¥m CÃ´ng HÃ´m Nay
            </Text>
            {attLoading ? (
              <ActivityIndicator color={theme.primary} />
            ) : (
              <>
                {(() => {
                  const status = getAttendanceStatus(attendance);
                  if (status === 'none') {
                    return (
                      <TouchableOpacity
                        style={getAttBtnStyle(theme)}
                        onPress={handleClockIn}
                      >
                        <Ionicons
                          name="log-in-outline"
                          size={20}
                          color="#fff"
                          style={{ marginRight: 6 }}
                        />
                        <Text style={{ color: '#fff', fontWeight: '600' }}>
                          Cháº¥m CÃ´ng VÃ o
                        </Text>
                      </TouchableOpacity>
                    );
                  }
                  if (status === 'clocked_in') {
                    return (
                      <>
                        <Text style={{ color: theme.text, marginBottom: 8 }}>
                          VÃ o lÃºc:{' '}
                          {attendance.clockIn.toDate().toLocaleTimeString()}
                        </Text>
                        <TouchableOpacity
                          style={getAttBtnStyle(theme)}
                          onPress={handleClockOut}
                        >
                          <Ionicons
                            name="log-out-outline"
                            size={20}
                            color="#fff"
                            style={{ marginRight: 6 }}
                          />
                          <Text style={{ color: '#fff', fontWeight: '600' }}>
                            Cháº¥m CÃ´ng Ra
                          </Text>
                        </TouchableOpacity>
                      </>
                    );
                  }
                  if (status === 'clocked_out') {
                    return (
                      <>
                        <Text style={{ color: theme.text, marginBottom: 4 }}>
                          VÃ o lÃºc:{' '}
                          {attendance.clockIn.toDate().toLocaleTimeString()}
                        </Text>
                        <Text style={{ color: theme.text, marginBottom: 8 }}>
                          Ra lÃºc:{' '}
                          {attendance.clockOut.toDate().toLocaleTimeString()}
                        </Text>
                        <Text style={{ color: theme.text, marginBottom: 8 }}>
                          TÄƒng ca: {attendance.overtime || 0} giá»
                        </Text>
                        <View style={{ flexDirection: 'row' }}>
                          {[1, 2, 3].map((h) => (
                            <TouchableOpacity
                              key={h}
                              style={getOvertimeBtnStyle(theme)}
                              onPress={() => handleAddOvertime(h)}
                            >
                              <Text style={{ color: '#fff' }}>+{h}</Text>
                            </TouchableOpacity>
                          ))}
                        </View>
                      </>
                    );
                  }
                })()}
              </>
            )}
          </View>
        </View>
      )}

      {loading ? (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color={theme.primary} />
          <Text style={[styles.loadingText, { color: theme.textSecondary }]}>
            Äang táº£i dá»¯ liá»‡u...
          </Text>
        </View>
      ) : (
        <ScrollView
          style={styles.scrollView}
          contentContainerStyle={styles.scrollContent}
        >
          {/* Pháº§n dá»± Ã¡n gáº§n Ä‘Ã¢y */}
          <View style={styles.section}>
            <View style={styles.sectionHeader}>
              <Text style={[styles.sectionTitle, { color: theme.text }]}>
                Dá»± Ã¡n gáº§n Ä‘Ã¢y
              </Text>
              <TouchableOpacity onPress={handleViewAllProjects}>
                <Text style={[styles.viewAllText, { color: theme.primary }]}>
                  Xem táº¥t cáº£
                </Text>
              </TouchableOpacity>
            </View>

            {recentProjects.length > 0 ? (
              recentProjects.map((project) => (
                <TouchableOpacity
                  key={project.id}
                  style={[
                    styles.card,
                    { backgroundColor: theme.card, borderColor: theme.border },
                  ]}
                  onPress={() => handleProjectPress(project)}
                >
                  <View style={styles.cardContent}>
                    <View style={styles.cardMain}>
                      <Text style={[styles.cardTitle, { color: theme.text }]}>
                        {project.name || 'ChÆ°a cÃ³ tÃªn'}
                      </Text>
                      {project.customerName && (
                        <View style={styles.cardRow}>
                          <Ionicons
                            name="business-outline"
                            size={14}
                            color={theme.textSecondary}
                          />
                          <Text
                            style={[
                              styles.cardText,
                              { color: theme.textSecondary },
                            ]}
                          >
                            {project.customerName}
                          </Text>
                        </View>
                      )}
                    </View>
                    <View
                      style={[
                        styles.statusBadge,
                        { backgroundColor: getStatusColor(project.status) },
                      ]}
                    >
                      <Text style={styles.statusText}>
                        {getStatusLabel(project.status)}
                      </Text>
                    </View>
                  </View>
                </TouchableOpacity>
              ))
            ) : (
              <View
                style={[
                  styles.emptyCard,
                  { backgroundColor: theme.card, borderColor: theme.border },
                ]}
              >
                <Ionicons
                  name="briefcase-outline"
                  size={24}
                  color={theme.textMuted}
                />
                <Text style={[styles.emptyText, { color: theme.textMuted }]}>
                  ChÆ°a cÃ³ dá»± Ã¡n nÃ o
                </Text>
              </View>
            )}
          </View>

          {/* Pháº§n khÃ¡ch hÃ ng gáº§n Ä‘Ã¢y */}
          <View style={styles.section}>
            <View style={styles.sectionHeader}>
              <Text style={[styles.sectionTitle, { color: theme.text }]}>
                KhÃ¡ch hÃ ng gáº§n Ä‘Ã¢y
              </Text>
              <TouchableOpacity onPress={handleViewAllCustomers}>
                <Text style={[styles.viewAllText, { color: theme.primary }]}>
                  Xem táº¥t cáº£
                </Text>
              </TouchableOpacity>
            </View>

            {recentCustomers.length > 0 ? (
              recentCustomers.map((customer) => (
                <TouchableOpacity
                  key={customer.id}
                  style={[
                    styles.card,
                    { backgroundColor: theme.card, borderColor: theme.border },
                  ]}
                  onPress={() => handleCustomerPress(customer)}
                >
                  <View style={styles.cardContent}>
                    <View style={styles.cardMain}>
                      <Text style={[styles.cardTitle, { color: theme.text }]}>
                        {customer.name || 'ChÆ°a cÃ³ tÃªn'}
                      </Text>
                      {customer.contactPerson && (
                        <View style={styles.cardRow}>
                          <Ionicons
                            name="person-outline"
                            size={14}
                            color={theme.textSecondary}
                          />
                          <Text
                            style={[
                              styles.cardText,
                              { color: theme.textSecondary },
                            ]}
                          >
                            {customer.contactPerson}
                          </Text>
                        </View>
                      )}
                      {customer.phone && (
                        <View style={styles.cardRow}>
                          <Ionicons
                            name="call-outline"
                            size={14}
                            color={theme.textSecondary}
                          />
                          <Text
                            style={[
                              styles.cardText,
                              { color: theme.textSecondary },
                            ]}
                          >
                            {customer.phone}
                          </Text>
                        </View>
                      )}
                    </View>
                    <Ionicons
                      name="chevron-forward"
                      size={20}
                      color={theme.textMuted}
                    />
                  </View>
                </TouchableOpacity>
              ))
            ) : (
              <View
                style={[
                  styles.emptyCard,
                  { backgroundColor: theme.card, borderColor: theme.border },
                ]}
              >
                <Ionicons
                  name="people-outline"
                  size={24}
                  color={theme.textMuted}
                />
                <Text style={[styles.emptyText, { color: theme.textMuted }]}>
                  ChÆ°a cÃ³ khÃ¡ch hÃ ng nÃ o
                </Text>
              </View>
            )}
          </View>

          {/* ThÃ´ng tin á»©ng dá»¥ng */}
          <View
            style={[styles.infoCard, { backgroundColor: theme.primaryLight }]}
          >
            <Ionicons
              name="information-circle-outline"
              size={24}
              color={theme.primary}
            />
            <Text style={[styles.infoText, { color: theme.text }]}>
              THP App - PhiÃªn báº£n 1.0.0
            </Text>
          </View>

          {/* NÃºt quáº£n lÃ½ nhÃ  cung cáº¥p */}
          <TouchableOpacity
            style={styles.menuItem}
            onPress={() => navigation.navigate('SupplierManagement')}
          >
            <View style={[styles.menuIcon, { backgroundColor: '#4caf50' }]}>
              <Ionicons name="business-outline" size={24} color="#fff" />
            </View>
            <Text style={styles.menuText}>Quáº£n lÃ½ nhÃ  cung cáº¥p</Text>
            <Ionicons name="chevron-forward" size={20} color="#999" />
          </TouchableOpacity>
        </ScrollView>
      )}
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 10,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    padding: 16,
    paddingBottom: 32,
  },
  section: {
    marginBottom: 24,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  viewAllText: {
    fontSize: 14,
    fontWeight: '500',
  },
  card: {
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
    borderWidth: 1,
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  cardContent: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  cardMain: {
    flex: 1,
  },
  cardTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    marginBottom: 4,
  },
  cardRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 4,
  },
  cardText: {
    fontSize: 14,
    marginLeft: 6,
  },
  statusBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  statusText: {
    fontSize: 12,
    fontWeight: '500',
    color: 'white',
  },
  emptyCard: {
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
    borderWidth: 1,
    alignItems: 'center',
    justifyContent: 'center',
    height: 100,
  },
  emptyText: {
    fontSize: 14,
    marginTop: 8,
  },
  infoCard: {
    borderRadius: 8,
    padding: 16,
    marginTop: 12,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
  },
  infoText: {
    fontSize: 14,
    marginLeft: 8,
    fontWeight: '500',
  },
  // Note: dynamic button styles are generated via helper functions below
  menuItem: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderRadius: 8,
    marginBottom: 12,
    backgroundColor: '#f5f5f5',
  },
  menuIcon: {
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: 'center',
    alignItems: 'center',
  },
  menuText: {
    flex: 1,
    marginLeft: 12,
    fontSize: 16,
    fontWeight: '500',
    color: '#333',
  },
});

// Dynamic styles generators
const getAttBtnStyle = (theme) => ({
  backgroundColor: theme.primary,
  borderRadius: 8,
  paddingVertical: 12,
  paddingHorizontal: 20,
  flexDirection: 'row',
  alignItems: 'center',
  justifyContent: 'center',
  marginTop: 10,
});

const getOvertimeBtnStyle = (theme) => ({
  backgroundColor: theme.primary,
  borderRadius: 20,
  paddingVertical: 8,
  paddingHorizontal: 15,
  marginHorizontal: 5,
});

export default HomeScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\LoginScreen.js ---

//src/screens/LoginScreen.js
import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  Image,
  KeyboardAvoidingView,
  Platform,
  ScrollView,
  ActivityIndicator,
  Alert,
  Dimensions,
  Keyboard,
} from 'react-native';
import { useAuth } from '../contexts/AuthContext';
import { Ionicons } from '@expo/vector-icons';
import { SafeAreaView } from 'react-native-safe-area-context';
import StyledTextInput from '../components/StyledTextInput';

const { width, height } = Dimensions.get('window');

const LoginScreen = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [isEmailValid, setIsEmailValid] = useState(true);
  const [isFormValid, setIsFormValid] = useState(false);
  const [isLoggingIn, setIsLoggingIn] = useState(false);
  const [keyboardVisible, setKeyboardVisible] = useState(false);

  const passwordRef = useRef(null);
  const { login, error } = useAuth();

  // Kiá»ƒm tra tÃ­nh há»£p lá»‡ cá»§a form
  useEffect(() => {
    const validateEmail = (email) => {
      const re =
        /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    };

    const isValid =
      email.trim() !== '' && password.trim() !== '' && validateEmail(email);

    setIsEmailValid(email === '' || validateEmail(email));
    setIsFormValid(isValid);
  }, [email, password]);

  // Theo dÃµi tráº¡ng thÃ¡i hiá»ƒn thá»‹ cá»§a bÃ n phÃ­m
  useEffect(() => {
    const keyboardDidShowListener = Keyboard.addListener(
      'keyboardDidShow',
      () => {
        setKeyboardVisible(true);
      }
    );
    const keyboardDidHideListener = Keyboard.addListener(
      'keyboardDidHide',
      () => {
        setKeyboardVisible(false);
      }
    );

    return () => {
      keyboardDidShowListener.remove();
      keyboardDidHideListener.remove();
    };
  }, []);

  // Xá»­ lÃ½ Ä‘Äƒng nháº­p
  const handleLogin = async () => {
    if (!isFormValid) {
      Alert.alert('Lá»—i Ä‘Äƒng nháº­p', 'Vui lÃ²ng nháº­p email vÃ  máº­t kháº©u há»£p lá»‡');
      return;
    }

    Keyboard.dismiss();
    setIsLoggingIn(true);
    try {
      const success = await login(email, password);
      if (!success) {
        console.log('ÄÄƒng nháº­p tháº¥t báº¡i');
      }
    } catch (error) {
      console.error('Lá»—i khi Ä‘Äƒng nháº­p:', error);
      Alert.alert(
        'Lá»—i Ä‘Äƒng nháº­p',
        'ÄÃ£ xáº£y ra lá»—i khi Ä‘Äƒng nháº­p. Vui lÃ²ng thá»­ láº¡i sau.'
      );
    } finally {
      setIsLoggingIn(false);
    }
  };

  // Xá»­ lÃ½ quÃªn máº­t kháº©u
  const handleForgotPassword = () => {
    // Sáº½ triá»ƒn khai sau
    Alert.alert(
      'QuÃªn máº­t kháº©u',
      'TÃ­nh nÄƒng nÃ y sáº½ Ä‘Æ°á»£c triá»ƒn khai trong phiÃªn báº£n tiáº¿p theo.'
    );
  };

  // Táº¡o nÃºt hiá»ƒn thá»‹/áº©n máº­t kháº©u
  const PasswordToggleButton = (
    <TouchableOpacity
      onPress={() => setShowPassword(!showPassword)}
      style={styles.passwordToggle}
    >
      <Ionicons
        name={showPassword ? 'eye-off-outline' : 'eye-outline'}
        size={20}
        color="#666"
      />
    </TouchableOpacity>
  );

  return (
    <SafeAreaView style={styles.safeArea}>
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={styles.container}
        keyboardVerticalOffset={Platform.OS === 'ios' ? 0 : 20}
      >
        <ScrollView
          contentContainerStyle={[
            styles.scrollContainer,
            keyboardVisible && { justifyContent: 'flex-start', paddingTop: 20 },
          ]}
          keyboardShouldPersistTaps="handled"
          showsVerticalScrollIndicator={false}
        >
          <View
            style={[
              styles.logoContainer,
              keyboardVisible && {
                marginBottom: 10,
                transform: [{ scale: 0.8 }],
              },
            ]}
          >
            <Image
              source={require('../../assets/logo-placeholder.png')}
              style={styles.logo}
              resizeMode="contain"
            />
            <Text style={styles.appName}>TÃ¢n HÃ²a PhÃ¡t</Text>
            <Text style={styles.appDescription}>
              Há»‡ thá»‘ng quáº£n lÃ½ khÃ¡ch hÃ ng
            </Text>
          </View>

          <View style={styles.formContainer}>
            <Text style={styles.welcomeText}>ÄÄƒng nháº­p</Text>

            <StyledTextInput
              iconName="mail-outline"
              placeholder="Email"
              value={email}
              onChangeText={setEmail}
              keyboardType="email-address"
              autoCapitalize="none"
              returnKeyType="next"
              blurOnSubmit={false}
              onSubmitEditing={() => passwordRef.current.focus()}
              error={!isEmailValid ? 'Email khÃ´ng há»£p lá»‡' : null}
            />

            <StyledTextInput
              ref={passwordRef}
              iconName="lock-closed-outline"
              placeholder="Máº­t kháº©u"
              value={password}
              onChangeText={setPassword}
              secureTextEntry={!showPassword}
              returnKeyType="done"
              onSubmitEditing={handleLogin}
              rightIcon={PasswordToggleButton}
            />

            <TouchableOpacity
              style={styles.forgotPassword}
              onPress={handleForgotPassword}
            >
              <Text style={styles.forgotPasswordText}>QuÃªn máº­t kháº©u?</Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[
                styles.loginButton,
                (!isFormValid || isLoggingIn) && styles.loginButtonDisabled,
              ]}
              onPress={handleLogin}
              disabled={!isFormValid || isLoggingIn}
            >
              {isLoggingIn ? (
                <ActivityIndicator color="#fff" size="small" />
              ) : (
                <Text style={styles.loginButtonText}>ÄÄƒng nháº­p</Text>
              )}
            </TouchableOpacity>

            {error && (
              <View style={styles.errorContainer}>
                <Ionicons
                  name="alert-circle-outline"
                  size={18}
                  color="#e74c3c"
                />
                <Text style={styles.errorMessage}>{error}</Text>
              </View>
            )}
          </View>

          {!keyboardVisible && (
            <View style={styles.footer}>
              <Text style={styles.footerText}>
                Â© 2023 TÃ¢n HÃ²a PhÃ¡t. All rights reserved.
              </Text>
            </View>
          )}
        </ScrollView>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  container: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  scrollContainer: {
    flexGrow: 1,
    justifyContent: 'center',
    padding: 20,
  },
  logoContainer: {
    alignItems: 'center',
    marginBottom: 30,
  },
  logo: {
    width: 100,
    height: 100,
    marginBottom: 10,
  },
  appName: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#0066cc',
    marginBottom: 5,
  },
  appDescription: {
    fontSize: 16,
    color: '#666',
  },
  formContainer: {
    backgroundColor: '#fff',
    borderRadius: 10,
    padding: 20,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
    marginBottom: 20,
    width: '100%',
  },
  welcomeText: {
    fontSize: 20,
    fontWeight: 'bold',
    marginBottom: 20,
    textAlign: 'center',
    color: '#333',
  },
  passwordToggle: {
    padding: 8,
  },
  forgotPassword: {
    alignSelf: 'flex-end',
    marginBottom: 20,
  },
  forgotPasswordText: {
    color: '#0066cc',
    fontSize: 14,
  },
  loginButton: {
    backgroundColor: '#0066cc',
    borderRadius: 8,
    paddingVertical: 14,
    alignItems: 'center',
    justifyContent: 'center',
  },
  loginButtonDisabled: {
    backgroundColor: '#ccc',
  },
  loginButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
  },
  errorContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#fde2e2',
    padding: 10,
    borderRadius: 8,
    marginTop: 15,
  },
  errorMessage: {
    color: '#e74c3c',
    fontSize: 14,
    marginLeft: 5,
    flex: 1,
  },
  footer: {
    marginTop: 20,
    alignItems: 'center',
  },
  footerText: {
    color: '#999',
    fontSize: 12,
  },
});

export default LoginScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\ManualQuotationScreen.js ---

import React, { useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TextInput,
  TouchableOpacity,
  FlatList,
  ScrollView,
  KeyboardAvoidingView,
  Platform,
  Alert,
  Modal,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { Picker } from '@react-native-picker/picker';

const MATERIAL_OPTIONS = ['SUS304', 'SS400', 'SUS316', 'SUS304 2B', 'KhÃ¡c'];

const UNIT_OPTIONS = ['CÃ¡i', 'CÃ¢y', 'Bá»™', 'Kg', 'm'];

const ManualQuotationScreen = ({ route, navigation }) => {
  const { projectId, projectName, project } = route.params;

  const [materials, setMaterials] = useState([
    {
      name: '',
      material: MATERIAL_OPTIONS[0],
      unit: UNIT_OPTIONS[0],
      quantity: '',
      unitPrice: '',
      totalPrice: 0,
      selected: false,
    },
  ]);

  // Add new states for bulk price update
  const [showBulkPriceModal, setShowBulkPriceModal] = useState(false);
  const [bulkPrice, setBulkPrice] = useState('');
  const [hasSelections, setHasSelections] = useState(false);

  const addMaterialRow = () => {
    setMaterials((prev) => [
      ...prev,
      {
        name: '',
        material: MATERIAL_OPTIONS[0],
        unit: UNIT_OPTIONS[0],
        quantity: '',
        unitPrice: '',
        totalPrice: 0,
        selected: false,
      },
    ]);
  };

  const handleChange = (index, field, value) => {
    setMaterials((prev) => {
      const newArr = [...prev];
      newArr[index][field] = value;
      // Auto-recalculate total
      const qty = parseFloat(newArr[index].quantity) || 0;
      const unitP = parseFloat(newArr[index].unitPrice) || 0;
      newArr[index].totalPrice = qty * unitP;

      // Update hasSelections state if needed
      if (field === 'selected') {
        const anySelected = newArr.some((item) => item.selected);
        setHasSelections(anySelected);
      }

      return newArr;
    });
  };

  // Handle bulk price update
  const handleApplyBulkPrice = () => {
    if (!bulkPrice || isNaN(parseFloat(bulkPrice))) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p giÃ¡ há»£p lá»‡');
      return;
    }

    const price = parseFloat(bulkPrice);

    setMaterials((prev) => {
      return prev.map((item) => {
        if (item.selected) {
          const qty = parseFloat(item.quantity) || 0;
          return {
            ...item,
            unitPrice: price.toString(),
            totalPrice: qty * price,
          };
        }
        return item;
      });
    });

    setShowBulkPriceModal(false);
    setBulkPrice('');
  };

  const toggleSelectAll = (value) => {
    setMaterials((prev) =>
      prev.map((item) => ({
        ...item,
        selected: value,
      }))
    );
    setHasSelections(value);
  };

  const formatNumber = (num) => (num || num === 0 ? num.toString() : '');

  const computeSubTotal = () => {
    return materials.reduce((sum, m) => sum + (m.totalPrice || 0), 0);
  };

  const handleContinue = () => {
    // Validate
    if (materials.length === 0) {
      Alert.alert('ThÃ´ng bÃ¡o', 'Vui lÃ²ng nháº­p Ã­t nháº¥t 1 váº­t tÆ°.');
      return;
    }

    const cleaned = materials.filter((m) => (m.name || '').trim() !== '');

    if (cleaned.length === 0) {
      Alert.alert('ThÃ´ng bÃ¡o', 'TÃªn váº­t tÆ° khÃ´ng Ä‘Æ°á»£c bá» trá»‘ng.');
      return;
    }

    const subTotal = computeSubTotal();

    const customerData = {
      id: project.customerId || '',
      name: project.customerName || 'KhÃ¡ch hÃ ng',
      address: project.customerAddress || '',
      phone: project.customerPhone || '',
      email: project.customerEmail || '',
      contactPerson: project.customerContactPerson || '',
      taxCode: project.customerTaxCode || '',
    };

    // Remove selected property before navigation
    const cleanedWithoutSelected = cleaned.map(({ selected, ...rest }) => rest);

    navigation.navigate('FinalizeQuotation', {
      materials: cleanedWithoutSelected,
      subTotal,
      projectId,
      projectName: project.name || projectName || 'Dá»± Ã¡n',
      customerData,
    });
  };

  const renderRow = ({ item, index }) => {
    return (
      <View style={styles.row}>
        <TouchableOpacity
          style={styles.checkbox}
          onPress={() => handleChange(index, 'selected', !item.selected)}
        >
          <Ionicons
            name={item.selected ? 'checkbox' : 'square-outline'}
            size={20}
            color={item.selected ? '#0066CC' : '#999'}
          />
        </TouchableOpacity>

        <TextInput
          style={[styles.input, { flex: 2 }]}
          placeholder="TÃªn váº­t tÆ°"
          value={item.name}
          onChangeText={(text) => handleChange(index, 'name', text)}
        />

        <TouchableOpacity
          style={[styles.pickerButton, { flex: 1.5 }]}
          onPress={() => {
            setActiveMaterialPicker(index);
            setShowMaterialModal(true);
          }}
        >
          <Text>{item.material || MATERIAL_OPTIONS[0]}</Text>
          <Ionicons name="chevron-down" size={16} color="#666" />
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.pickerButton, { flex: 0.9 }]}
          onPress={() => {
            setActiveUnitPicker(index);
            setShowUnitModal(true);
          }}
        >
          <Text>{item.unit || UNIT_OPTIONS[0]}</Text>
          <Ionicons name="chevron-down" size={16} color="#666" />
        </TouchableOpacity>

        <TextInput
          style={[styles.input, { flex: 0.8 }]}
          placeholder="SL"
          keyboardType="numeric"
          value={formatNumber(item.quantity)}
          onChangeText={(text) => handleChange(index, 'quantity', text)}
        />

        <TextInput
          style={[styles.input, { flex: 1 }]}
          placeholder="ÄÆ¡n giÃ¡"
          keyboardType="numeric"
          value={formatNumber(item.unitPrice)}
          onChangeText={(text) => handleChange(index, 'unitPrice', text)}
        />

        <View style={[styles.totalCol, { flex: 1 }]}>
          <Text>
            {item.totalPrice ? item.totalPrice.toLocaleString('vi-VN') : ''}
          </Text>
        </View>
      </View>
    );
  };

  const [showMaterialModal, setShowMaterialModal] = useState(false);
  const [showUnitModal, setShowUnitModal] = useState(false);
  const [activeMaterialPicker, setActiveMaterialPicker] = useState(-1);
  const [activeUnitPicker, setActiveUnitPicker] = useState(-1);

  const handleSelectMaterial = (value) => {
    if (activeMaterialPicker >= 0) {
      handleChange(activeMaterialPicker, 'material', value);
    }
    setShowMaterialModal(false);
  };

  const handleSelectUnit = (value) => {
    if (activeUnitPicker >= 0) {
      handleChange(activeUnitPicker, 'unit', value);
    }
    setShowUnitModal(false);
  };

  const subTotal = computeSubTotal();

  return (
    <KeyboardAvoidingView
      style={{ flex: 1 }}
      behavior={Platform.OS === 'ios' ? 'padding' : undefined}
    >
      <ScrollView contentContainerStyle={{ padding: 16 }}>
        <Text style={styles.title}>BÃ¡o GiÃ¡ Thá»§ CÃ´ng â€“ {projectName}</Text>

        <View style={styles.bulkActionContainer}>
          <View style={styles.selectAllContainer}>
            <TouchableOpacity
              style={styles.actionButton}
              onPress={() => toggleSelectAll(true)}
            >
              <Ionicons name="checkbox-outline" size={18} color="#fff" />
              <Text style={styles.actionButtonText}>Chá»n táº¥t cáº£</Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[styles.actionButton, styles.unselectButton]}
              onPress={() => toggleSelectAll(false)}
            >
              <Ionicons name="square-outline" size={18} color="#fff" />
              <Text style={styles.actionButtonText}>Bá» chá»n</Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[
                styles.actionButton,
                styles.priceButton,
                !hasSelections && styles.disabledButton,
              ]}
              disabled={!hasSelections}
              onPress={() => setShowBulkPriceModal(true)}
            >
              <Ionicons name="pricetag-outline" size={18} color="#fff" />
              <Text style={styles.actionButtonText}>Ãp dá»¥ng giÃ¡</Text>
            </TouchableOpacity>
          </View>
        </View>

        <View style={styles.tableHeader}>
          <View style={{ width: 30 }}></View>
          <Text style={[styles.headerCell, { flex: 2 }]}>TÃªn VT</Text>
          <Text style={[styles.headerCell, { flex: 1.5 }]}>Váº­t Liá»‡u</Text>
          <Text style={[styles.headerCell, { flex: 0.9 }]}>ÄVT</Text>
          <Text style={[styles.headerCell, { flex: 0.8 }]}>SL</Text>
          <Text style={[styles.headerCell, { flex: 1 }]}>ÄÆ¡n giÃ¡</Text>
          <Text style={[styles.headerCell, { flex: 1 }]}>ThÃ nh tiá»n</Text>
        </View>

        <FlatList
          data={materials}
          keyExtractor={(_, idx) => idx.toString()}
          renderItem={renderRow}
          scrollEnabled={false}
        />

        <TouchableOpacity style={styles.addBtn} onPress={addMaterialRow}>
          <Ionicons name="add-circle-outline" size={20} color="#fff" />
          <Text style={{ color: '#fff', marginLeft: 6 }}>ThÃªm váº­t tÆ°</Text>
        </TouchableOpacity>

        <View style={styles.subTotalRow}>
          <Text style={styles.subTotalLabel}>Tá»•ng cá»™ng:</Text>
          <Text style={styles.subTotalVal}>
            {subTotal.toLocaleString('vi-VN')} Ä‘
          </Text>
        </View>

        <TouchableOpacity style={styles.continueBtn} onPress={handleContinue}>
          <Ionicons name="arrow-forward-circle" size={22} color="#fff" />
          <Text style={{ color: '#fff', marginLeft: 8 }}>Tiáº¿p tá»¥c</Text>
        </TouchableOpacity>
      </ScrollView>

      {/* Material Selection Modal */}
      <Modal
        transparent={true}
        visible={showMaterialModal}
        animationType="slide"
        onRequestClose={() => setShowMaterialModal(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Chá»n váº­t liá»‡u</Text>
            {MATERIAL_OPTIONS.map((option) => (
              <TouchableOpacity
                key={option}
                style={styles.modalItem}
                onPress={() => handleSelectMaterial(option)}
              >
                <Text style={styles.modalItemText}>{option}</Text>
              </TouchableOpacity>
            ))}
            <TouchableOpacity
              style={styles.modalCloseButton}
              onPress={() => setShowMaterialModal(false)}
            >
              <Text style={styles.modalCloseText}>ÄÃ³ng</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      {/* Unit Selection Modal */}
      <Modal
        transparent={true}
        visible={showUnitModal}
        animationType="slide"
        onRequestClose={() => setShowUnitModal(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Chá»n Ä‘Æ¡n vá»‹ tÃ­nh</Text>
            {UNIT_OPTIONS.map((option) => (
              <TouchableOpacity
                key={option}
                style={styles.modalItem}
                onPress={() => handleSelectUnit(option)}
              >
                <Text style={styles.modalItemText}>{option}</Text>
              </TouchableOpacity>
            ))}
            <TouchableOpacity
              style={styles.modalCloseButton}
              onPress={() => setShowUnitModal(false)}
            >
              <Text style={styles.modalCloseText}>ÄÃ³ng</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      {/* Bulk Price Modal */}
      <Modal
        transparent={true}
        visible={showBulkPriceModal}
        animationType="slide"
        onRequestClose={() => setShowBulkPriceModal(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Ãp dá»¥ng giÃ¡ cho má»¥c Ä‘Ã£ chá»n</Text>

            <TextInput
              style={styles.bulkPriceInput}
              placeholder="Nháº­p Ä‘Æ¡n giÃ¡ Ã¡p dá»¥ng"
              keyboardType="numeric"
              value={bulkPrice}
              onChangeText={setBulkPrice}
              autoFocus
            />

            <View style={styles.bulkPriceActions}>
              <TouchableOpacity
                style={[styles.bulkPriceActionButton, styles.cancelButton]}
                onPress={() => setShowBulkPriceModal(false)}
              >
                <Text style={styles.cancelButtonText}>Há»§y</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.bulkPriceActionButton, styles.applyButton]}
                onPress={handleApplyBulkPrice}
              >
                <Text style={styles.applyButtonText}>Ãp dá»¥ng</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </KeyboardAvoidingView>
  );
};

const styles = StyleSheet.create({
  title: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 12,
  },
  tableHeader: {
    flexDirection: 'row',
    borderBottomWidth: 1,
    paddingVertical: 6,
    alignItems: 'center',
  },
  headerCell: {
    fontWeight: '600',
  },
  row: {
    flexDirection: 'row',
    alignItems: 'center',
    marginVertical: 4,
  },
  checkbox: {
    width: 30,
    alignItems: 'center',
    justifyContent: 'center',
  },
  input: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 4,
    padding: 6,
    marginRight: 4,
  },
  pickerContainer: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 4,
    overflow: 'hidden',
    marginRight: 4,
    height: 40,
  },
  totalCol: {
    alignItems: 'flex-end',
    paddingHorizontal: 4,
  },
  addBtn: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#007AFF',
    padding: 10,
    borderRadius: 6,
    alignSelf: 'flex-start',
    marginTop: 8,
  },
  subTotalRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 16,
  },
  subTotalLabel: {
    fontWeight: 'bold',
    fontSize: 16,
  },
  subTotalVal: {
    fontWeight: 'bold',
    fontSize: 16,
    color: '#d11a2a',
  },
  continueBtn: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#28a745',
    justifyContent: 'center',
    padding: 12,
    borderRadius: 8,
    marginTop: 20,
  },
  pickerButton: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 4,
    paddingHorizontal: 10,
    paddingVertical: 8,
    marginRight: 4,
    backgroundColor: '#fff',
  },
  modalOverlay: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0,0,0,0.5)',
    padding: 20,
  },
  modalContent: {
    backgroundColor: '#fff',
    borderRadius: 10,
    padding: 20,
    width: '80%',
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 15,
    textAlign: 'center',
  },
  modalItem: {
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  modalItemText: {
    fontSize: 16,
  },
  modalCloseButton: {
    marginTop: 15,
    backgroundColor: '#0066CC',
    padding: 12,
    borderRadius: 8,
    alignItems: 'center',
  },
  modalCloseText: {
    color: '#fff',
    fontWeight: 'bold',
    fontSize: 16,
  },
  bulkActionContainer: {
    marginBottom: 16,
  },
  selectAllContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'flex-start',
    flexWrap: 'wrap',
    gap: 10,
  },
  actionButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 8,
    paddingHorizontal: 12,
    borderRadius: 6,
    backgroundColor: '#0066CC',
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.2,
    shadowRadius: 1.5,
    minWidth: 110,
  },
  unselectButton: {
    backgroundColor: '#6c757d',
  },
  priceButton: {
    backgroundColor: '#28a745',
  },
  actionButtonText: {
    color: '#fff',
    marginLeft: 6,
    fontWeight: '500',
  },
  disabledButton: {
    backgroundColor: '#ccc',
    opacity: 0.7,
  },
  bulkPriceButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#0066CC',
    paddingVertical: 6,
    paddingHorizontal: 10,
    borderRadius: 4,
  },
  disabledButton: {
    backgroundColor: '#ccc',
  },
  bulkPriceText: {
    color: '#fff',
    marginLeft: 5,
  },
  bulkPriceInput: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 4,
    padding: 12,
    fontSize: 16,
    marginTop: 10,
    marginBottom: 20,
  },
  bulkPriceActions: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  bulkPriceActionButton: {
    paddingVertical: 10,
    paddingHorizontal: 15,
    borderRadius: 4,
    flex: 1,
    marginHorizontal: 5,
    alignItems: 'center',
  },
  cancelButton: {
    backgroundColor: '#f8f9fa',
    borderWidth: 1,
    borderColor: '#ccc',
  },
  cancelButtonText: {
    color: '#333',
  },
  applyButton: {
    backgroundColor: '#28a745',
  },
  applyButtonText: {
    color: '#fff',
    fontWeight: 'bold',
  },
});

export default ManualQuotationScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\MaterialPurchaseScreen.js ---

// src/screens/MaterialPurchaseScreen.js
import React, { useState, useEffect, useCallback, memo } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  ActivityIndicator,
  TouchableOpacity,
  Alert,
  SafeAreaView,
  ScrollView,
  Modal,
  TextInput,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useFocusEffect } from '@react-navigation/native';
import { useProjectDetails } from '../hooks/useProjectDetails';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../config/firebaseConfig';
import {
  collection,
  doc,
  getDoc,
  getDocs,
  addDoc,
  updateDoc,
  query,
  orderBy,
  serverTimestamp,
  where,
} from 'firebase/firestore';
import { getQuotationsByProject } from '../api/quotationService';
import {
  getProposalsByStatus,
  updateProposalMaterialPrices,
} from '../api/proposalService';

// Memoized row component for the materials list
const MaterialRow = memo(({ item, index, onTogglePurchased }) => {
  return (
    <View style={styles.tableRow}>
      <TouchableOpacity
        style={styles.checkbox}
        onPress={() => onTogglePurchased(index)}
      >
        <Ionicons
          name={item.purchased ? 'checkbox' : 'square-outline'}
          size={18}
          color={item.purchased ? '#4CAF50' : '#999'}
        />
      </TouchableOpacity>
      <View style={[styles.tableCell, { flex: 3 }]}>
        <Text style={styles.materialName}>{item.name}</Text>
        {item.material ? (
          <Text style={styles.materialType}>{item.material}</Text>
        ) : null}
        {item.quyCach ? (
          <Text style={styles.materialType}>Quy cÃ¡ch: {item.quyCach}</Text>
        ) : null}
      </View>
      <Text style={[styles.tableCell, { flex: 1, textAlign: 'center' }]}>
        {formatNumber(item.quantity)}
      </Text>
      <Text style={[styles.tableCell, { flex: 1, textAlign: 'center' }]}>
        {formatNumber(item.weight)}
      </Text>
      <Text style={[styles.tableCell, { flex: 0.8, textAlign: 'center' }]}>
        {item.unit}
      </Text>
    </View>
  );
});

// Helper functions
const formatNumber = (num) => {
  if (typeof num !== 'number' || isNaN(num)) return '0';
  const roundedNum = Math.round(num * 10) / 10;
  return roundedNum.toString().replace('.', ',');
};

const MaterialPurchaseScreen = ({ route, navigation }) => {
  const { projectId, projectName, project } = route.params;
  const { currentUser } = useAuth();
  const { project: projectDetails, loading: loadingProject } =
    useProjectDetails(projectId);

  const [materials, setMaterials] = useState([]);
  const [purchaseHistory, setPurchaseHistory] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [selectedForProposal, setSelectedForProposal] = useState([]);
  const [quotations, setQuotations] = useState([]);
  const [approvedProposals, setApprovedProposals] = useState([]);
  const [showPriceModal, setShowPriceModal] = useState(false);
  const [editableMaterials, setEditableMaterials] = useState([]);
  const [currentProposalId, setCurrentProposalId] = useState(null);
  const [loadingProposals, setLoadingProposals] = useState(false);
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [purchasedMaterials, setPurchasedMaterials] = useState([]);
  const [showHistoryDetailModal, setShowHistoryDetailModal] = useState(false);
  const [selectedHistory, setSelectedHistory] = useState(null);
  const [historyMaterials, setHistoryMaterials] = useState([]);
  const [updatingHistory, setUpdatingHistory] = useState(false);

  const handleTogglePurchased = (index) => {
    setMaterials((prev) => {
      const updated = [...prev];
      updated[index] = {
        ...updated[index],
        purchased: !updated[index].purchased,
        selectedForProposal: !updated[index].purchased, // Äá»“ng bá»™ vá»›i tráº¡ng thÃ¡i purchased
      };
      return updated;
    });
  };

  const handleToggleSelectForProposal = (index) => {
    setMaterials((prev) => {
      const arr = [...prev];
      arr[index].selectedForProposal = !arr[index].selectedForProposal;
      return arr;
    });
  };

  const handleCreateProposal = () => {
    // Lá»c theo thuá»™c tÃ­nh purchased thay vÃ¬ selectedForProposal
    const selected = materials.filter((m) => m.purchased);
    if (!selected.length)
      return Alert.alert(
        'ChÆ°a chá»n váº­t tÆ°',
        'Vui lÃ²ng tick chá»n cÃ¡c váº­t tÆ° cáº§n mua.'
      );
    navigation.navigate('CreateProposal', {
      projectId,
      projectName: projectDetails?.name || projectName,
      selectedItems: selected,
    });
  };

  // Modified function to show confirmation before saving
  const handleSavePurchaseList = () => {
    const selected = materials.filter((m) => m.purchased);

    if (selected.length === 0) {
      Alert.alert(
        'ChÆ°a chá»n váº­t tÆ°',
        'Vui lÃ²ng tick chá»n cÃ¡c váº­t tÆ° Ä‘Ã£ mua trÆ°á»›c khi lÆ°u.'
      );
      return;
    }

    setPurchasedMaterials(selected);
    setShowConfirmModal(true);
  };

  // New function to actually save the purchase list after confirmation
  const confirmSavePurchaseList = async () => {
    setSaving(true);
    try {
      // Create a map of material names to purchase status
      const purchasedItems = {};
      materials.forEach((item) => {
        purchasedItems[item.name] = item.purchased === true;
      });

      // Save to purchase history collection
      const purchaseRef = collection(db, 'projects', projectId, 'purchases');
      await addDoc(purchaseRef, {
        projectId,
        purchasedItems,
        createdAt: serverTimestamp(),
        createdBy: currentUser?.uid || 'unknown',
        createdByName: currentUser?.displayName || 'NgÆ°á»i dÃ¹ng',
      });

      // Calculate if all items are purchased
      const allItems = Object.values(purchasedItems);
      const purchasedCount = allItems.filter((v) => v === true).length;
      const totalCount = allItems.length;

      // Update project task status based on purchase progress
      const projectRef = doc(db, 'projects', projectId);
      await updateDoc(projectRef, {
        'tasks.material_purchasing.status':
          purchasedCount === totalCount ? 'completed' : 'in_progress',
      });

      // Close modal and show success message
      setShowConfirmModal(false);
      Alert.alert(
        'ThÃ nh cÃ´ng',
        `ÄÃ£ lÆ°u danh sÃ¡ch ${purchasedCount} váº­t tÆ° Ä‘Ã£ mua.`
      );

      // Reload purchase history
      const purchaseQuery = query(purchaseRef, orderBy('createdAt', 'desc'));
      const purchaseSnapshot = await getDocs(purchaseQuery);
      setPurchaseHistory(
        purchaseSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }))
      );
    } catch (error) {
      console.error('Lá»—i khi lÆ°u danh sÃ¡ch:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ lÆ°u danh sÃ¡ch váº­t tÆ°.');
    } finally {
      setSaving(false);
    }
  };

  // Handle loading quotation materials
  const handleRequote = useCallback(
    (quotation) => {
      if (quotation.materials && Array.isArray(quotation.materials)) {
        // Get purchase history to merge with quotation materials
        const loadPurchaseHistory = async () => {
          try {
            const purchaseRef = collection(
              db,
              'projects',
              projectId,
              'purchases'
            );
            const purchaseQuery = query(
              purchaseRef,
              orderBy('createdAt', 'desc')
            );
            const purchaseSnapshot = await getDocs(purchaseQuery);

            let purchasedItems = {};
            if (!purchaseSnapshot.empty) {
              const latestPurchase = purchaseSnapshot.docs[0].data();
              purchasedItems = latestPurchase.purchasedItems || {};
              setPurchaseHistory(
                purchaseSnapshot.docs.map((doc) => ({
                  id: doc.id,
                  ...doc.data(),
                }))
              );
            }

            // Merge purchased state with materials
            const materialsWithPurchaseState = quotation.materials.map(
              (item) => ({
                ...item,
                purchased: purchasedItems[item.name] === true,
              })
            );

            setMaterials(materialsWithPurchaseState);
          } catch (error) {
            console.error('Lá»—i khi táº£i lá»‹ch sá»­ mua hÃ ng:', error);
          }
        };

        loadPurchaseHistory();
        Alert.alert(
          'Táº£i thÃ nh cÃ´ng',
          `ÄÃ£ táº£i dá»¯ liá»‡u tá»« bÃ¡o giÃ¡ ${
            quotation.quotationNumber || 'má»›i nháº¥t'
          }.`
        );
      } else {
        Alert.alert('Lá»—i', 'BÃ¡o giÃ¡ nÃ y khÃ´ng chá»©a dá»¯ liá»‡u váº­t tÆ° Ä‘á»ƒ táº£i.');
      }
    },
    [projectId]
  );

  // Load approved proposals
  const loadApprovedProposals = useCallback(async () => {
    setLoadingProposals(true);
    try {
      // Get all approved proposals
      const allApproved = await getProposalsByStatus('approved');

      // Filter for this project if projectId is provided
      let projectProposals = allApproved;
      if (projectId) {
        projectProposals = allApproved.filter((p) => p.projectId === projectId);
      }

      setApprovedProposals(projectProposals);
    } catch (error) {
      console.error('Lá»—i khi táº£i Ä‘á» xuáº¥t Ä‘Ã£ duyá»‡t:', error);
    } finally {
      setLoadingProposals(false);
    }
  }, [projectId]);

  // Handle price updates for a proposal
  const openPriceEditor = (proposal) => {
    // Create a deep copy of materials with price fields
    const materialsWithPrices = proposal.items
      ? JSON.parse(JSON.stringify(proposal.items))
      : [];

    // Ensure each material has price and totalPrice fields
    materialsWithPrices.forEach((item) => {
      if (!item.price) item.price = '';
      if (!item.totalPrice) item.totalPrice = '';
    });

    setEditableMaterials(materialsWithPrices);
    setCurrentProposalId(proposal.id);
    setShowPriceModal(true);
  };

  const handlePriceChange = (index, price) => {
    const updatedMaterials = [...editableMaterials];
    updatedMaterials[index].price = price;

    // Calculate total price if both price and quantity exist
    const quantity = parseFloat(updatedMaterials[index].quantity);
    const priceValue = parseFloat(price);

    if (!isNaN(quantity) && !isNaN(priceValue)) {
      updatedMaterials[index].totalPrice = (quantity * priceValue).toString();
    }

    setEditableMaterials(updatedMaterials);
  };

  const savePriceUpdates = async () => {
    if (!currentProposalId) return;

    try {
      await updateProposalMaterialPrices(currentProposalId, editableMaterials);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ cáº­p nháº­t giÃ¡ váº­t tÆ°');
      setShowPriceModal(false);
      loadApprovedProposals(); // Reload to get updated data
    } catch (error) {
      console.error('Error updating prices:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t giÃ¡ váº­t tÆ°');
    }
  };

  // Load project materials and purchase history
  useFocusEffect(
    useCallback(() => {
      const loadData = async () => {
        setLoading(true);
        try {
          // Load quotations to get materials
          const pastQuotations = await getQuotationsByProject(projectId);
          setQuotations(pastQuotations);

          if (pastQuotations.length > 0) {
            // Automatically load the latest quotation
            const latestQuotation = pastQuotations[0];
            handleRequote(latestQuotation);
          }

          // Load approved proposals
          await loadApprovedProposals();
        } catch (error) {
          console.error('Lá»—i khi táº£i dá»¯ liá»‡u:', error);
          Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u váº­t tÆ°.');
        } finally {
          setLoading(false);
        }
      };

      loadData();
    }, [projectId, handleRequote, loadApprovedProposals])
  );

  // Calculate purchase stats
  const calculateStats = () => {
    if (!materials.length)
      return { purchasedCount: 0, totalCount: 0, percentComplete: 0 };

    const purchasedCount = materials.filter((item) => item.purchased).length;
    const totalCount = materials.length;
    const percentComplete = Math.round((purchasedCount / totalCount) * 100);

    return { purchasedCount, totalCount, percentComplete };
  };

  const stats = calculateStats();

  const renderHeader = () => (
    <View style={styles.header}>
      <Text style={styles.headerTitle}>Danh SÃ¡ch Váº­t TÆ° Cáº§n Mua</Text>
      <Text style={styles.projectName}>
        {projectDetails?.name || projectName}
      </Text>

      {materials.length > 0 && (
        <View style={styles.statsContainer}>
          <View style={styles.progressBar}>
            <View
              style={[
                styles.progressFill,
                { width: `${stats.percentComplete}%` },
              ]}
            />
          </View>
          <Text style={styles.statsText}>
            {stats.purchasedCount}/{stats.totalCount} váº­t tÆ° Ä‘Ã£ mua (
            {stats.percentComplete}%)
          </Text>
        </View>
      )}
    </View>
  );

  const renderMaterialsSection = () => (
    <View style={styles.section}>
      <Text style={styles.sectionTitle}>Danh sÃ¡ch váº­t tÆ°</Text>
      {materials.length > 0 ? (
        <>
          <View style={styles.tableHeader}>
            <View style={{ width: 30 }}></View>
            <Text style={[styles.headerCell, { flex: 3 }]}>TÃªn váº­t tÆ°</Text>
            <Text style={[styles.headerCell, { flex: 1, textAlign: 'center' }]}>
              SL
            </Text>
            <Text style={[styles.headerCell, { flex: 1, textAlign: 'center' }]}>
              KL
            </Text>
            <Text
              style={[styles.headerCell, { flex: 0.8, textAlign: 'center' }]}
            >
              ÄVT
            </Text>
          </View>
          <FlatList
            data={materials}
            keyExtractor={(item, index) => `material-row-${index}`}
            renderItem={({ item, index }) => (
              <MaterialRow
                item={item}
                index={index}
                onTogglePurchased={handleTogglePurchased}
              />
            )}
            nestedScrollEnabled={true}
            style={{ maxHeight: 300 }}
          />
        </>
      ) : (
        <View style={styles.emptyContainer}>
          <Ionicons name="list-outline" size={48} color="#ccc" />
          <Text style={styles.emptyText}>
            ChÆ°a cÃ³ dá»¯ liá»‡u váº­t tÆ° tá»« bÃ¡o giÃ¡
          </Text>
          <TouchableOpacity
            style={styles.createQuotationButton}
            onPress={() =>
              navigation.navigate('Quotation', {
                projectId,
                projectName: projectDetails?.name || projectName,
                project: projectDetails,
              })
            }
          >
            <Text style={styles.createQuotationButtonText}>Táº¡o bÃ¡o giÃ¡</Text>
          </TouchableOpacity>
        </View>
      )}
    </View>
  );

  const renderPurchaseHistory = () => (
    <View style={styles.section}>
      <Text style={styles.sectionTitle}>Danh sÃ¡ch cáº§n mua</Text>
      {purchaseHistory.length === 0 ? (
        <Text style={styles.emptyText}>
          ChÆ°a cÃ³ danh sÃ¡ch mua hÃ ng nÃ o Ä‘Æ°á»£c lÆ°u.
        </Text>
      ) : (
        <FlatList
          data={purchaseHistory}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => {
            const purchasedCount = Object.values(item.purchasedItems).filter(
              (v) => v === true
            ).length;
            const totalCount = Object.values(item.purchasedItems).length;

            return (
              <TouchableOpacity
                style={styles.historyItem}
                onPress={() => viewHistoryDetails(item)}
              >
                <Text style={styles.historyDate}>
                  {item.createdAt
                    ? new Date(
                        item.createdAt.seconds * 1000
                      ).toLocaleDateString('vi-VN')
                    : 'KhÃ´ng rÃµ ngÃ y'}
                </Text>
                <Text style={styles.historyCreator}>
                  NgÆ°á»i lÆ°u: {item.createdByName || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}
                </Text>
                <View style={styles.historyStats}>
                  <Text style={styles.historyStatText}>
                    ÄÃ£ mua: {purchasedCount} váº­t tÆ°
                  </Text>
                  <Text style={styles.historyStatText}>
                    ChÆ°a mua: {totalCount - purchasedCount} váº­t tÆ°
                  </Text>
                </View>
                <View style={styles.viewDetailsButton}>
                  <Text style={styles.viewDetailsText}>Xem chi tiáº¿t</Text>
                  <Ionicons name="chevron-forward" size={16} color="#0066cc" />
                </View>
              </TouchableOpacity>
            );
          }}
        />
      )}
    </View>
  );

  const renderQuotationsSection = () => (
    <View style={styles.section}>
      <Text style={styles.sectionTitle}>Lá»‹ch sá»­ bÃ¡o giÃ¡</Text>
      {quotations.length === 0 ? (
        <Text style={styles.emptyText}>ChÆ°a cÃ³ bÃ¡o giÃ¡ nÃ o.</Text>
      ) : (
        <FlatList
          horizontal
          data={quotations}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <TouchableOpacity
              style={styles.quotationItem}
              onPress={() => handleRequote(item)}
            >
              <Text style={styles.quotationNumber}>
                {item.quotationNumber || `BÃ¡o giÃ¡ #${item.id.substring(0, 5)}`}
              </Text>
              <Text style={styles.quotationDate}>
                {item.createdAt
                  ? new Date(item.createdAt.seconds * 1000).toLocaleDateString(
                      'vi-VN'
                    )
                  : 'KhÃ´ng rÃµ'}
              </Text>
            </TouchableOpacity>
          )}
        />
      )}
    </View>
  );

  // Render approved proposals section
  const renderApprovedProposals = () => (
    <View style={styles.section}>
      <View style={styles.sectionHeader}>
        <Text style={styles.sectionTitle}>Äá» xuáº¥t Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t</Text>
      </View>

      {loadingProposals ? (
        <ActivityIndicator size="small" color="#0066cc" />
      ) : approvedProposals.length === 0 ? (
        <Text style={styles.emptyText}>ChÆ°a cÃ³ Ä‘á» xuáº¥t nÃ o Ä‘Æ°á»£c duyá»‡t</Text>
      ) : (
        <FlatList
          data={approvedProposals}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <View style={styles.proposalCard}>
              <View style={styles.proposalHeader}>
                <Text style={styles.proposalCode}>
                  {item.proposalCode || `PO-${item.id.substring(0, 6)}`}
                </Text>
                {item.hasPrices && (
                  <View style={styles.priceBadge}>
                    <Text style={styles.priceBadgeText}>ÄÃ£ cÃ³ giÃ¡</Text>
                  </View>
                )}
              </View>

              <Text style={styles.proposalProject}>{item.projectName}</Text>

              <View style={styles.proposalDetails}>
                <View style={styles.proposalDetailRow}>
                  <Text style={styles.proposalDetailLabel}>NgÃ y yÃªu cáº§u:</Text>
                  <Text style={styles.proposalDetailValue}>
                    {item.requiredDate
                      ? new Date(
                          item.requiredDate.seconds * 1000
                        ).toLocaleDateString('vi-VN')
                      : 'N/A'}
                  </Text>
                </View>

                <View style={styles.proposalDetailRow}>
                  <Text style={styles.proposalDetailLabel}>
                    Sá»‘ lÆ°á»£ng váº­t tÆ°:
                  </Text>
                  <Text style={styles.proposalDetailValue}>
                    {item.items?.length || 0}
                  </Text>
                </View>

                {item.totalValue && (
                  <View style={styles.proposalDetailRow}>
                    <Text style={styles.proposalDetailLabel}>
                      Tá»•ng giÃ¡ trá»‹:
                    </Text>
                    <Text style={styles.proposalDetailValue}>
                      {item.totalValue.toLocaleString('vi-VN')} VNÄ
                    </Text>
                  </View>
                )}
              </View>

              <View style={styles.proposalActions}>
                <TouchableOpacity
                  style={[styles.proposalButton, styles.viewButton]}
                  onPress={() => navigation.navigate('ProposalList')}
                >
                  <Ionicons name="eye-outline" size={16} color="#0066cc" />
                  <Text style={styles.viewButtonText}>Xem chi tiáº¿t</Text>
                </TouchableOpacity>

                <TouchableOpacity
                  style={[styles.proposalButton, styles.priceButton]}
                  onPress={() => openPriceEditor(item)}
                >
                  <Ionicons name="cash-outline" size={16} color="#28a745" />
                  <Text style={[styles.viewButtonText, { color: '#28a745' }]}>
                    {item.hasPrices ? 'Cáº­p nháº­t giÃ¡' : 'Nháº­p giÃ¡'}
                  </Text>
                </TouchableOpacity>
              </View>
            </View>
          )}
          contentContainerStyle={styles.proposalList}
        />
      )}
    </View>
  );

  // New function to render the confirmation modal
  const renderConfirmationModal = () => (
    <Modal visible={showConfirmModal} transparent animationType="slide">
      <View style={styles.modalOverlay}>
        <View style={styles.modalContainer}>
          <View style={styles.modalHeader}>
            <Text style={styles.modalTitle}>XÃ¡c nháº­n váº­t tÆ° Ä‘Ã£ mua</Text>
            <TouchableOpacity onPress={() => setShowConfirmModal(false)}>
              <Ionicons name="close" size={24} color="#666" />
            </TouchableOpacity>
          </View>

          <Text style={styles.confirmText}>
            Báº¡n Ä‘ang xÃ¡c nháº­n Ä‘Ã£ mua {purchasedMaterials.length} váº­t tÆ° sau:
          </Text>

          <ScrollView style={styles.confirmList}>
            {purchasedMaterials.map((item, index) => (
              <View key={index} style={styles.confirmItem}>
                <Ionicons
                  name="checkmark-circle"
                  size={18}
                  color="#4CAF50"
                  style={styles.confirmIcon}
                />
                <View style={styles.confirmItemContent}>
                  <Text style={styles.confirmItemName}>
                    {index + 1}. {item.name}
                  </Text>
                  <Text style={styles.confirmItemDetails}>
                    {item.quantity} {item.unit || 'cÃ¡i'}
                    {item.quyCach ? ` - ${item.quyCach}` : ''}
                  </Text>
                </View>
              </View>
            ))}
          </ScrollView>

          <View style={styles.modalActions}>
            <TouchableOpacity
              style={[styles.modalButton, styles.cancelButton]}
              onPress={() => setShowConfirmModal(false)}
            >
              <Text style={styles.cancelButtonText}>Há»§y</Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[styles.modalButton, styles.confirmButton]}
              onPress={confirmSavePurchaseList}
              disabled={saving}
            >
              {saving ? (
                <ActivityIndicator size="small" color="#fff" />
              ) : (
                <Text style={styles.confirmButtonText}>XÃ¡c nháº­n</Text>
              )}
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </Modal>
  );

  // Function to view history details
  const viewHistoryDetails = async (historyItem) => {
    setSelectedHistory(historyItem);

    try {
      // Get the full material list from the latest quotation
      let materialsList = [...materials];

      // Merge with purchase status from history
      if (historyItem.purchasedItems) {
        materialsList = materialsList.map((material) => ({
          ...material,
          purchased: historyItem.purchasedItems[material.name] === true,
        }));
      }

      setHistoryMaterials(materialsList);
      setShowHistoryDetailModal(true);
    } catch (error) {
      console.error('Lá»—i khi táº£i chi tiáº¿t lá»‹ch sá»­:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i chi tiáº¿t lá»‹ch sá»­ mua hÃ ng.');
    }
  };

  // Function to toggle purchase status in history detail
  const toggleHistoryItemStatus = (index) => {
    setHistoryMaterials((prev) => {
      const updated = [...prev];
      updated[index] = {
        ...updated[index],
        purchased: !updated[index].purchased,
      };
      return updated;
    });
  };

  // Function to update purchase history
  const updatePurchaseHistory = async () => {
    if (!selectedHistory) return;

    setUpdatingHistory(true);
    try {
      // Create updated purchasedItems object
      const purchasedItems = {};
      historyMaterials.forEach((item) => {
        purchasedItems[item.name] = item.purchased === true;
      });

      // Update the history document
      const historyRef = doc(
        db,
        'projects',
        projectId,
        'purchases',
        selectedHistory.id
      );
      await updateDoc(historyRef, {
        purchasedItems,
        updatedAt: serverTimestamp(),
        updatedBy: currentUser?.uid || 'unknown',
        updatedByName:
          currentUser?.displayName || currentUser?.email || 'NgÆ°á»i dÃ¹ng',
      });

      // Calculate if all items are purchased
      const purchasedCount = Object.values(purchasedItems).filter(
        (v) => v === true
      ).length;
      const totalCount = Object.values(purchasedItems).length;

      // Update project task status
      const projectRef = doc(db, 'projects', projectId);
      await updateDoc(projectRef, {
        'tasks.material_purchasing.status':
          purchasedCount === totalCount ? 'completed' : 'in_progress',
      });

      // Reload purchase history
      const purchaseRef = collection(db, 'projects', projectId, 'purchases');
      const purchaseQuery = query(purchaseRef, orderBy('createdAt', 'desc'));
      const purchaseSnapshot = await getDocs(purchaseQuery);
      setPurchaseHistory(
        purchaseSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }))
      );

      setShowHistoryDetailModal(false);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i mua hÃ ng.');
    } catch (error) {
      console.error('Lá»—i khi cáº­p nháº­t lá»‹ch sá»­:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t lá»‹ch sá»­ mua hÃ ng.');
    } finally {
      setUpdatingHistory(false);
    }
  };

  // New function to render history detail modal
  const renderHistoryDetailModal = () => (
    <Modal visible={showHistoryDetailModal} transparent animationType="slide">
      <View style={styles.modalOverlay}>
        <View style={[styles.modalContainer, styles.historyModalContainer]}>
          <View style={styles.modalHeader}>
            <Text style={styles.modalTitle}>Chi tiáº¿t mua hÃ ng</Text>
            <TouchableOpacity onPress={() => setShowHistoryDetailModal(false)}>
              <Ionicons name="close" size={24} color="#666" />
            </TouchableOpacity>
          </View>

          {selectedHistory && (
            <View style={styles.historyDetailHeader}>
              <Text style={styles.historyDetailDate}>
                NgÃ y:{' '}
                {selectedHistory.createdAt
                  ? new Date(
                      selectedHistory.createdAt.seconds * 1000
                    ).toLocaleDateString('vi-VN')
                  : 'KhÃ´ng rÃµ'}
              </Text>
              <Text style={styles.historyDetailPerson}>
                NgÆ°á»i lÆ°u: {selectedHistory.createdByName || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}
              </Text>
              {selectedHistory.updatedAt && (
                <Text style={styles.historyDetailUpdate}>
                  Cáº­p nháº­t láº§n cuá»‘i:{' '}
                  {new Date(
                    selectedHistory.updatedAt.seconds * 1000
                  ).toLocaleDateString('vi-VN')}
                </Text>
              )}
            </View>
          )}

          <Text style={styles.historyDetailInstruction}>
            Nháº¥n vÃ o Ã´ vuÃ´ng Ä‘á»ƒ thay Ä‘á»•i tráº¡ng thÃ¡i Ä‘Ã£ mua/chÆ°a mua
          </Text>

          <ScrollView style={styles.historyDetailList}>
            {historyMaterials.length > 0 ? (
              historyMaterials.map((item, index) => (
                <TouchableOpacity
                  key={index}
                  style={styles.historyDetailItem}
                  onPress={() => toggleHistoryItemStatus(index)}
                >
                  <View style={styles.historyCheckbox}>
                    <Ionicons
                      name={item.purchased ? 'checkbox' : 'square-outline'}
                      size={22}
                      color={item.purchased ? '#4CAF50' : '#999'}
                    />
                  </View>
                  <View style={styles.historyItemContent}>
                    <Text style={styles.historyItemName}>{item.name}</Text>
                    <Text style={styles.historyItemDetails}>
                      {item.quantity} {item.unit || 'cÃ¡i'}
                      {item.quyCach ? ` - ${item.quyCach}` : ''}
                    </Text>
                  </View>
                  <View
                    style={[
                      styles.historyItemStatus,
                      {
                        backgroundColor: item.purchased ? '#e8f5e9' : '#fff3e0',
                      },
                    ]}
                  >
                    <Text
                      style={[
                        styles.historyItemStatusText,
                        { color: item.purchased ? '#4CAF50' : '#FF9800' },
                      ]}
                    >
                      {item.purchased ? 'ÄÃ£ mua' : 'ChÆ°a mua'}
                    </Text>
                  </View>
                </TouchableOpacity>
              ))
            ) : (
              <Text style={styles.emptyText}>KhÃ´ng cÃ³ dá»¯ liá»‡u váº­t tÆ°</Text>
            )}
          </ScrollView>

          <View style={styles.modalActions}>
            <TouchableOpacity
              style={[styles.modalButton, styles.cancelButton]}
              onPress={() => setShowHistoryDetailModal(false)}
            >
              <Text style={styles.cancelButtonText}>ÄÃ³ng</Text>
            </TouchableOpacity>

            <TouchableOpacity
              style={[styles.modalButton, styles.updateButton]}
              onPress={updatePurchaseHistory}
              disabled={updatingHistory}
            >
              {updatingHistory ? (
                <ActivityIndicator size="small" color="#fff" />
              ) : (
                <Text style={styles.updateButtonText}>Cáº­p nháº­t</Text>
              )}
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </Modal>
  );

  return (
    <SafeAreaView style={styles.container}>
      {renderHeader()}

      {loading || loadingProject ? (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#0066cc" />
          <Text style={styles.loadingText}>Äang táº£i dá»¯ liá»‡u...</Text>
        </View>
      ) : (
        <View style={{ flex: 1 }}>
          <ScrollView>
            {renderQuotationsSection()}
            {renderMaterialsSection()}
            {renderApprovedProposals()}
            {renderPurchaseHistory()}
          </ScrollView>

          {materials.length > 0 && (
            <View style={styles.buttonContainer}>
              <TouchableOpacity
                style={styles.saveButton}
                onPress={handleSavePurchaseList}
                disabled={saving}
              >
                <View style={styles.buttonContent}>
                  {saving ? (
                    <ActivityIndicator size="small" color="#fff" />
                  ) : (
                    <Ionicons name="save-outline" size={20} color="#fff" />
                  )}
                  <Text style={styles.saveButtonText}>
                    LÆ°u danh sÃ¡ch mua hÃ ng
                  </Text>
                </View>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.saveButton,
                  { backgroundColor: '#0066cc', marginTop: 8 },
                ]}
                onPress={handleCreateProposal}
              >
                <View style={styles.buttonContent}>
                  <Ionicons name="send" size={20} color="#fff" />
                  <Text style={styles.saveButtonText}>
                    Táº¡o Äá» Xuáº¥t Mua Váº­t TÆ°
                  </Text>
                </View>
              </TouchableOpacity>
            </View>
          )}
        </View>
      )}

      {/* Price Update Modal */}
      <Modal visible={showPriceModal} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContainer}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Cáº­p nháº­t giÃ¡ váº­t tÆ°</Text>
              <TouchableOpacity onPress={() => setShowPriceModal(false)}>
                <Ionicons name="close" size={24} color="#666" />
              </TouchableOpacity>
            </View>

            <ScrollView style={styles.priceScrollView}>
              {editableMaterials && editableMaterials.length > 0 ? (
                editableMaterials.map((item, index) => (
                  <View key={index} style={styles.priceItem}>
                    <Text style={styles.materialName}>
                      {index + 1}. {item.name || 'KhÃ´ng cÃ³ tÃªn'}
                    </Text>
                    <View style={styles.materialDetails}>
                      {item.specification ? (
                        <Text style={styles.materialSpec}>
                          Quy cÃ¡ch: {item.specification}
                        </Text>
                      ) : null}
                      <Text style={styles.materialQuantity}>
                        Sá»‘ lÆ°á»£ng: {item.quantity || 0} {item.unit || ''}
                      </Text>

                      <View style={styles.priceInputContainer}>
                        <Text style={styles.priceLabel}>ÄÆ¡n giÃ¡ (VNÄ):</Text>
                        <TextInput
                          style={styles.priceInput}
                          value={item.price}
                          onChangeText={(text) =>
                            handlePriceChange(index, text)
                          }
                          keyboardType="numeric"
                          placeholder="Nháº­p Ä‘Æ¡n giÃ¡"
                        />
                      </View>

                      {item.totalPrice && (
                        <Text style={styles.materialTotalPrice}>
                          ThÃ nh tiá»n: {item.totalPrice} VNÄ
                        </Text>
                      )}
                    </View>
                  </View>
                ))
              ) : (
                <Text style={styles.emptyText}>KhÃ´ng cÃ³ váº­t tÆ° nÃ o.</Text>
              )}
            </ScrollView>

            <View style={styles.modalActions}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelButton]}
                onPress={() => setShowPriceModal(false)}
              >
                <Text style={styles.cancelButtonText}>Há»§y</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.modalButton, styles.saveButton]}
                onPress={savePriceUpdates}
              >
                <Text style={styles.saveButtonText}>LÆ°u giÃ¡</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* Confirmation Modal */}
      {renderConfirmationModal()}

      {/* History Detail Modal */}
      {renderHistoryDetailModal()}
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  header: {
    padding: 16,
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  projectName: {
    fontSize: 14,
    color: '#666',
    marginTop: 4,
  },
  section: {
    backgroundColor: '#fff',
    borderRadius: 8,
    margin: 8,
    padding: 12,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 3,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 10,
  },
  tableHeader: {
    flexDirection: 'row',
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
    paddingBottom: 8,
    marginBottom: 8,
  },
  headerCell: {
    fontWeight: '600',
    fontSize: 14,
    color: '#333',
  },
  tableRow: {
    flexDirection: 'row',
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
    paddingVertical: 8,
    alignItems: 'center',
  },
  checkbox: {
    width: 30,
    alignItems: 'center',
    justifyContent: 'center',
  },
  tableCell: {
    paddingHorizontal: 4,
  },
  materialName: {
    fontSize: 14,
    fontWeight: '500',
  },
  materialType: {
    fontSize: 12,
    color: '#666',
    marginTop: 2,
  },
  saveButton: {
    backgroundColor: '#4CAF50',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center', // This will center the content
    paddingVertical: 12,
    marginHorizontal: 8,
    borderRadius: 8,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 3,
  },
  saveButtonText: {
    color: '#fff',
    fontWeight: '600',
    marginLeft: 8,
    fontSize: 15, // Slightly larger text
    textAlignVertical: 'center', // Align text vertically
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 12,
    color: '#666',
  },
  emptyContainer: {
    alignItems: 'center',
    justifyContent: 'center',
    padding: 24,
  },
  emptyText: {
    color: '#999',
    marginTop: 8,
  },
  createQuotationButton: {
    marginTop: 16,
    paddingVertical: 8,
    paddingHorizontal: 16,
    backgroundColor: '#0066cc',
    borderRadius: 20,
  },
  createQuotationButtonText: {
    color: '#fff',
    fontWeight: '500',
  },
  historyItem: {
    borderWidth: 1,
    borderColor: '#e0e0e0',
    borderRadius: 8,
    padding: 12,
    marginBottom: 8,
    backgroundColor: '#fff',
  },
  historyDate: {
    fontWeight: '600',
    fontSize: 14,
  },
  historyCreator: {
    fontSize: 12,
    color: '#666',
    marginTop: 4,
  },
  historyStats: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 8,
    paddingTop: 8,
    borderTopWidth: 1,
    borderTopColor: '#f0f0f0',
  },
  historyStatText: {
    fontSize: 12,
  },
  statsContainer: {
    marginTop: 10,
    alignItems: 'center',
  },
  progressBar: {
    width: '100%',
    height: 8,
    backgroundColor: '#e0e0e0',
    borderRadius: 4,
    overflow: 'hidden',
    marginBottom: 5,
  },
  progressFill: {
    height: '100%',
    backgroundColor: '#4CAF50',
    borderRadius: 4,
  },
  statsText: {
    fontSize: 14,
    color: '#666',
  },
  quotationItem: {
    borderWidth: 1,
    borderColor: '#e0e0e0',
    borderRadius: 8,
    padding: 10,
    marginRight: 10,
    width: 150,
    backgroundColor: '#f9f9f9',
  },
  quotationNumber: {
    fontWeight: '600',
    fontSize: 14,
    marginBottom: 4,
  },
  quotationDate: {
    fontSize: 12,
    color: '#666',
  },
  buttonContainer: {
    paddingHorizontal: 8,
    paddingBottom: 16,
  },
  buttonContent: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    width: '100%', // Ensure the content takes the full width
  },

  // Proposal card styles
  proposalCard: {
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 12,
    marginBottom: 10,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  proposalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 6,
  },
  proposalCode: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
  },
  priceBadge: {
    backgroundColor: '#28a745',
    paddingVertical: 2,
    paddingHorizontal: 8,
    borderRadius: 12,
  },
  priceBadgeText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: '500',
  },
  proposalProject: {
    fontSize: 14,
    color: '#444',
    marginBottom: 8,
  },
  proposalDetails: {
    marginBottom: 10,
  },
  proposalDetailRow: {
    flexDirection: 'row',
    marginBottom: 4,
  },
  proposalDetailLabel: {
    fontSize: 13,
    color: '#666',
    width: 100,
  },
  proposalDetailValue: {
    fontSize: 13,
    color: '#333',
    fontWeight: '500',
  },
  proposalActions: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    borderTopWidth: 1,
    borderTopColor: '#eee',
    paddingTop: 8,
  },
  proposalButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 12,
    borderRadius: 16,
    marginLeft: 8,
  },
  viewButton: {
    backgroundColor: '#f0f7ff',
  },
  priceButton: {
    backgroundColor: '#e8f5e9',
  },
  viewButtonText: {
    color: '#0066cc',
    fontSize: 12,
    fontWeight: '500',
    marginLeft: 4,
  },
  emptyText: {
    textAlign: 'center',
    color: '#666',
    padding: 16,
  },

  // Modal styles
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContainer: {
    width: '90%',
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 16,
    maxHeight: '80%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    paddingBottom: 8,
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  priceScrollView: {
    maxHeight: '70%',
  },
  priceItem: {
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  materialName: {
    fontSize: 14,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 4,
  },
  materialSpec: {
    fontSize: 13,
    color: '#666',
    marginBottom: 2,
  },
  materialQuantity: {
    fontSize: 13,
    color: '#333',
  },
  priceInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 6,
    marginBottom: 4,
  },
  priceLabel: {
    fontSize: 13,
    color: '#555',
    width: 100,
  },
  priceInput: {
    flex: 1,
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 4,
    paddingHorizontal: 8,
    paddingVertical: 4,
    fontSize: 13,
  },
  materialTotalPrice: {
    fontSize: 13,
    color: '#28a745',
    fontWeight: '500',
    marginTop: 2,
  },
  modalActions: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    marginTop: 16,
  },
  modalButton: {
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 4,
    marginLeft: 8,
  },
  cancelButton: {
    backgroundColor: '#f5f5f5',
  },
  cancelButtonText: {
    color: '#333',
  },
  saveButton: {
    backgroundColor: '#28a745',
  },
  saveButtonText: {
    color: '#fff',
    fontWeight: '600',
  },
  // New styles for confirmation modal
  confirmText: {
    fontSize: 14,
    color: '#333',
    marginBottom: 12,
  },
  confirmList: {
    maxHeight: 300,
    marginBottom: 12,
  },
  confirmItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 8,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  confirmIcon: {
    marginRight: 8,
  },
  confirmItemContent: {
    flex: 1,
  },
  confirmItemName: {
    fontSize: 14,
    fontWeight: '500',
    color: '#333',
  },
  confirmItemDetails: {
    fontSize: 12,
    color: '#666',
    marginTop: 2,
  },
  confirmButton: {
    backgroundColor: '#4CAF50',
    minWidth: 100,
    justifyContent: 'center',
    alignItems: 'center',
  },
  confirmButtonText: {
    color: '#fff',
    fontWeight: '600',
  },

  // History detail modal styles
  historyModalContainer: {
    maxHeight: '80%',
    width: '90%',
  },
  historyDetailHeader: {
    backgroundColor: '#f9f9f9',
    padding: 12,
    borderRadius: 4,
    marginBottom: 16,
  },
  historyDetailDate: {
    fontSize: 15,
    fontWeight: '600',
    color: '#333',
    marginBottom: 4,
  },
  historyDetailPerson: {
    fontSize: 13,
    color: '#666',
    marginBottom: 2,
  },
  historyDetailUpdate: {
    fontSize: 12,
    color: '#888',
    fontStyle: 'italic',
  },
  historyDetailInstruction: {
    fontSize: 13,
    color: '#666',
    marginBottom: 12,
    fontStyle: 'italic',
  },
  historyDetailList: {
    maxHeight: '60%',
  },
  historyDetailItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 10,
    paddingHorizontal: 4,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  historyCheckbox: {
    width: 30,
    alignItems: 'center',
    justifyContent: 'center',
  },
  historyItemContent: {
    flex: 1,
    paddingHorizontal: 8,
  },
  historyItemName: {
    fontSize: 14,
    fontWeight: '500',
    color: '#333',
  },
  historyItemDetails: {
    fontSize: 12,
    color: '#666',
    marginTop: 2,
  },
  historyItemStatus: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
    minWidth: 80,
    alignItems: 'center',
  },
  historyItemStatusText: {
    fontSize: 12,
    fontWeight: '500',
  },
  updateButton: {
    backgroundColor: '#0066cc',
    minWidth: 100,
    justifyContent: 'center',
    alignItems: 'center',
  },
  updateButtonText: {
    color: '#fff',
    fontWeight: '600',
  },

  // ... other existing styles ...
});

export default MaterialPurchaseScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\NotificationsScreen.js ---

// src/screens/NotificationsScreen.js
import React, { useState, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  ActivityIndicator,
  TouchableOpacity,
  RefreshControl,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useFocusEffect } from '@react-navigation/native';
import { useAuth } from '../contexts/AuthContext';
import {
  getUserNotifications,
  markNotificationAsRead,
} from '../api/notificationService';

const NotificationsScreen = ({ navigation }) => {
  const { currentUser } = useAuth();
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);

  const loadNotifications = useCallback(async () => {
    setLoading(true);
    const data = await getUserNotifications(currentUser?.uid);
    setNotifications(data);
    setLoading(false);
  }, [currentUser]);

  useFocusEffect(
    useCallback(() => {
      loadNotifications();
    }, [loadNotifications])
  );

  const onRefresh = useCallback(() => {
    setRefreshing(true);
    loadNotifications().then(() => setRefreshing(false));
  }, [loadNotifications]);

  const handleNotificationPress = async (item) => {
    if (!item.read) {
      await markNotificationAsRead(item.id);
      // Update UI instantly
      setNotifications((prev) =>
        prev.map((n) => (n.id === item.id ? { ...n, read: true } : n))
      );
    }

    if (item.navLink?.screen) {
      navigation.navigate(item.navLink.screen, item.navLink.params || {});
    }
  };

  const renderItem = ({ item }) => (
    <TouchableOpacity
      style={[styles.notificationItem, !item.read && styles.unreadItem]}
      onPress={() => handleNotificationPress(item)}
    >
      <Ionicons
        name={
          item.type === 'PROPOSAL_APPROVED'
            ? 'checkmark-circle'
            : 'close-circle'
        }
        size={24}
        color={item.type === 'PROPOSAL_APPROVED' ? '#28a745' : '#dc3545'}
        style={styles.icon}
      />
      <View style={styles.content}>
        <Text style={styles.message}>{item.message}</Text>
        <Text style={styles.date}>
          {item.createdAt
            ? new Date(item.createdAt.seconds * 1000).toLocaleString('vi-VN')
            : ''}
        </Text>
      </View>
    </TouchableOpacity>
  );

  if (loading && !refreshing) {
    return (
      <View style={[styles.container, styles.center]}>
        <ActivityIndicator size="large" color="#0066cc" />
      </View>
    );
  }

  return (
    <View style={styles.container}>
      {notifications.length === 0 ? (
        <View style={styles.center}>
          <Ionicons name="notifications-off-outline" size={60} color="#ccc" />
          <Text style={styles.emptyText}>Báº¡n khÃ´ng cÃ³ thÃ´ng bÃ¡o nÃ o.</Text>
        </View>
      ) : (
        <FlatList
          data={notifications}
          renderItem={renderItem}
          keyExtractor={(item) => item.id}
          contentContainerStyle={styles.list}
          refreshControl={
            <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />
          }
        />
      )}
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  center: {
    justifyContent: 'center',
    alignItems: 'center',
  },
  list: {
    padding: 16,
  },
  notificationItem: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#fff',
    padding: 16,
    borderRadius: 8,
    marginBottom: 12,
    elevation: 1,
  },
  unreadItem: {
    backgroundColor: '#eef7ff',
    borderLeftWidth: 4,
    borderLeftColor: '#0066cc',
  },
  icon: {
    marginRight: 16,
  },
  content: {
    flex: 1,
  },
  message: {
    fontSize: 14,
    color: '#333',
    marginBottom: 4,
  },
  date: {
    fontSize: 12,
    color: '#888',
  },
  emptyText: {
    marginTop: 16,
    fontSize: 16,
    color: '#666',
  },
});

export default NotificationsScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\POListScreen.js ---

import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ActivityIndicator,
  FlatList,
  TouchableOpacity,
} from 'react-native';
import {
  useNavigation,
  useRoute,
  useFocusEffect,
} from '@react-navigation/native';
import { Ionicons } from '@expo/vector-icons';
import { getPOsByProject, getAllPOs } from '../api/purchaseOrderService';
import { getProposalsByProject } from '../api/proposalService';

const POListScreen = () => {
  const navigation = useNavigation();
  const route = useRoute();
  const { projectId, projectName: routeProjectName } = route.params || {};

  const [pos, setPos] = useState([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [expandedId, setExpandedId] = useState(null);

  // Handler to create PO with materials pre-filled from approved proposal
  const handleCreatePO = async () => {
    if (!projectId) {
      navigation.navigate('CreatePO');
      return;
    }

    try {
      // Fetch proposals for this project
      const proposals = await getProposalsByProject(projectId);
      // Find first approved proposal (could enhance to choose latest or prompt user)
      const approved = proposals.find((p) => p.status === 'approved');

      if (!approved) {
        navigation.navigate('CreatePO', { projectId });
        return;
      }

      const poData = {
        projectId,
        projectName: approved.projectName,
        materials:
          approved.items?.map((item) => ({
            name: item.name,
            specs: item.specification || '',
            unit: item.unit || '',
            quantity: item.quantity?.toString() || '',
            unitPrice: item.price?.toString() || '',
          })) || [],
        vatPercentage: 10,
        proposalId: approved.id,
        proposalCode: approved.proposalCode,
      };

      navigation.navigate('CreatePO', poData);
    } catch (e) {
      console.error('Failed to fetch proposals for PO creation', e);
      navigation.navigate('CreatePO', { projectId });
    }
  };

  // Header button to create new PO
  React.useLayoutEffect(() => {
    navigation.setOptions({
      headerRight: () => (
        <TouchableOpacity onPress={handleCreatePO} style={{ marginRight: 15 }}>
          <Ionicons name="add" size={24} color="#007AFF" />
        </TouchableOpacity>
      ),
    });
  }, [navigation, projectId]);

  const loadPOs = async () => {
    try {
      setLoading(true);
      const data = projectId
        ? await getPOsByProject(projectId)
        : await getAllPOs();
      setPos(data);
    } catch (e) {
      console.error('Failed to load POs', e);
    } finally {
      setLoading(false);
    }
  };

  useFocusEffect(
    useCallback(() => {
      loadPOs();
    }, [projectId])
  );

  const handleRefresh = async () => {
    setRefreshing(true);
    await loadPOs();
    setRefreshing(false);
  };

  const formatDate = (timestamp) => {
    if (!timestamp) return 'N/A';
    const date = timestamp.seconds
      ? new Date(timestamp.seconds * 1000)
      : new Date(timestamp);
    return date.toLocaleDateString('vi-VN');
  };

  const renderMaterials = (materials = []) => (
    <View style={styles.materialsContainer}>
      {materials.map((m, index) => (
        <View key={index.toString()} style={styles.materialRow}>
          <Text style={styles.materialName}>
            {index + 1}. {m.name} {m.specs ? `(${m.specs})` : ''}
          </Text>
          <Text style={styles.materialInfo}>
            {m.quantity} {m.unit} x {m.unitPrice}
          </Text>
        </View>
      ))}
    </View>
  );

  const renderItem = ({ item }) => {
    const expanded = expandedId === item.id;
    return (
      <View style={styles.card}>
        <TouchableOpacity
          style={styles.cardHeader}
          onPress={() => setExpandedId(expanded ? null : item.id)}
        >
          <View style={{ flex: 1 }}>
            <Text style={styles.poNumber}>{item.poNumber || item.id}</Text>
            <Text style={styles.supplierName}>{item.supplierName}</Text>
            <Text style={styles.createdAt}>{formatDate(item.createdAt)}</Text>
          </View>
          <Ionicons
            name={expanded ? 'chevron-up' : 'chevron-down'}
            size={20}
            color="#555"
          />
        </TouchableOpacity>

        {expanded && (
          <View style={styles.cardBody}>
            {item.projectName || routeProjectName ? (
              <Text style={styles.label}>
                Dá»± Ã¡n: {item.projectName || routeProjectName}
              </Text>
            ) : null}
            {item.proposalNumber ? (
              <Text style={styles.label}>
                Sá»‘ Ä‘á» xuáº¥t: {item.proposalNumber}
              </Text>
            ) : null}
            {item.deliveryTime ? (
              <Text style={styles.label}>Giao hÃ ng: {item.deliveryTime}</Text>
            ) : null}
            <Text style={styles.sectionTitle}>Váº­t tÆ°</Text>
            {renderMaterials(item.materials)}

            <TouchableOpacity
              style={styles.confirmBtn}
              onPress={() =>
                navigation.navigate('ConfirmPOReceipt', { po: item })
              }
            >
              <Ionicons name="checkbox-outline" size={18} color="#fff" />
              <Text style={styles.confirmBtnText}>XÃ¡c nháº­n Ä‘Ã£ nháº­n</Text>
            </TouchableOpacity>
          </View>
        )}
      </View>
    );
  };

  if (loading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#0066cc" />
        <Text style={{ marginTop: 8 }}>Äang táº£i...</Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <FlatList
        data={pos}
        keyExtractor={(item) => item.id}
        renderItem={renderItem}
        refreshing={refreshing}
        onRefresh={handleRefresh}
        ListEmptyComponent={
          <View style={styles.emptyContainer}>
            <Ionicons name="document-text-outline" size={48} color="#ccc" />
            <Text style={styles.emptyText}>ChÆ°a cÃ³ Ä‘Æ¡n Ä‘áº·t hÃ ng</Text>
          </View>
        }
      />
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    marginTop: 40,
  },
  emptyText: {
    marginTop: 8,
    color: '#666',
  },
  card: {
    backgroundColor: '#fff',
    borderRadius: 8,
    marginBottom: 12,
    elevation: 2,
  },
  cardHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 12,
  },
  poNumber: {
    fontSize: 16,
    fontWeight: 'bold',
  },
  supplierName: {
    fontSize: 14,
    color: '#555',
  },
  createdAt: {
    color: '#888',
    fontSize: 12,
  },
  cardBody: {
    padding: 12,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  label: {
    fontSize: 14,
    marginBottom: 4,
  },
  sectionTitle: {
    fontSize: 15,
    fontWeight: 'bold',
    marginTop: 8,
  },
  materialsContainer: {
    marginTop: 4,
  },
  materialRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  materialName: {
    fontSize: 13,
    flex: 1,
  },
  materialInfo: {
    fontSize: 13,
    color: '#555',
  },
  confirmBtn: {
    marginTop: 12,
    backgroundColor: '#28a745',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 8,
    borderRadius: 6,
  },
  confirmBtnText: {
    color: '#fff',
    marginLeft: 6,
    fontSize: 14,
    fontWeight: '600',
  },
});

export default POListScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\ProjectDetailScreen.js ---

//src/screens/ProjectDetailScreen.js
import React, {
  useState,
  useEffect,
  useCallback,
  useLayoutEffect,
} from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  Alert,
  Modal,
  TextInput,
  ActionSheetIOS,
  Platform,
  FlatList,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import {
  updateTaskStatus,
  updateCustomTask,
  deleteProject,
  updateWorkflowStageStatus,
} from '../api/projectService';
import { useAuth } from '../contexts/AuthContext';
import StatusIndicator from '../components/StatusIndicator';
import { useProjectDetails } from '../hooks/useProjectDetails';
import * as Clipboard from 'expo-clipboard';
import { httpsCallable } from 'firebase/functions';
import { functions } from '../config/firebaseConfig';

// Äá»‹nh nghÄ©a danh sÃ¡ch cÃ´ng viá»‡c cá»‘ Ä‘á»‹nh
const TASK_DEFINITIONS = [
  { key: 'material_separation', label: 'BÃ³c tÃ¡ch váº­t tÆ°' },
  { key: 'quotation', label: 'BÃ¡o giÃ¡' },
  { key: 'material_cutting', label: 'Cáº¯t phÃ´i' },
  { key: 'assembly', label: 'Láº¯p rÃ¡p' },
  { key: 'painting', label: 'SÆ¡n' },
  { key: 'shipping', label: 'Váº­n chuyá»ƒn' },
  { key: 'other', label: 'CÃ´ng viá»‡c khÃ¡c' },
];

// Äá»‹nh nghÄ©a cÃ¡c tráº¡ng thÃ¡i cÃ´ng viá»‡c
const TASK_STATUSES = [
  { value: 'pending', label: 'ChÆ°a thá»±c hiá»‡n' },
  { value: 'in_progress', label: 'Äang thá»±c hiá»‡n' },
  { value: 'completed', label: 'HoÃ n thÃ nh' },
];

const ProjectDetailScreen = ({ route, navigation }) => {
  const { projectId } = route.params;
  const { currentUser } = useAuth();
  const { project, loading, error, fetchProjectData } =
    useProjectDetails(projectId);

  // State cho quáº£n lÃ½ cÃ´ng viá»‡c
  const [customTaskModalVisible, setCustomTaskModalVisible] = useState(false);
  const [customTaskName, setCustomTaskName] = useState('');
  const [copySuccess, setCopySuccess] = useState(false);
  const [creatingDriveFolder, setCreatingDriveFolder] = useState(false);

  useEffect(() => {
    if (project?.tasks?.other?.name) {
      setCustomTaskName(project.tasks.other.name);
    }
  }, [project]);

  useEffect(() => {
    const ensureDriveFolder = async () => {
      if (!project || project.driveFolderId || creatingDriveFolder) return;
      try {
        setCreatingDriveFolder(true);
        const callable = httpsCallable(functions, 'createProjectFolders');
        const res = await callable({ projectId });
        console.log('createProjectFolders result:', res.data);
        // Refresh project data to pick up new driveFolderId
        fetchProjectData();
      } catch (err) {
        console.error('Error calling createProjectFolders:', err);
      } finally {
        setCreatingDriveFolder(false);
      }
    };
    ensureDriveFolder();
  }, [
    project,
    project?.driveFolderId,
    creatingDriveFolder,
    projectId,
    fetchProjectData,
  ]);

  // áº¨n header máº·c Ä‘á»‹nh Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p nÃºt back / tiÃªu Ä‘á»
  useLayoutEffect(() => {
    navigation.setOptions({ headerShown: false });
  }, [navigation]);

  // HÃ m cáº­p nháº­t tráº¡ng thÃ¡i cÃ´ng viá»‡c
  const handleUpdateTaskStatus = async (taskKey) => {
    // KhÃ´ng cho phÃ©p thay Ä‘á»•i tráº¡ng thÃ¡i "BÃ¡o giÃ¡" vÃ  "BÃ³c tÃ¡ch" trá»±c tiáº¿p tá»« Ä‘Ã¢y
    if (taskKey === 'quotation' || taskKey === 'material_separation') {
      Alert.alert(
        'ThÃ´ng bÃ¡o',
        `Äá»ƒ cáº­p nháº­t tráº¡ng thÃ¡i "${getTaskDisplayName(
          taskKey
        )}", vui lÃ²ng vÃ o má»¥c "Quáº£n lÃ½ BÃ¡o giÃ¡".`
      );
      return;
    }

    if (Platform.OS === 'ios') {
      // Sá»­ dá»¥ng ActionSheetIOS cho iOS
      ActionSheetIOS.showActionSheetWithOptions(
        {
          options: [...TASK_STATUSES.map((s) => s.label), 'Há»§y'],
          cancelButtonIndex: TASK_STATUSES.length,
          title: `Cáº­p nháº­t "${getTaskDisplayName(taskKey)}"`,
        },
        async (buttonIndex) => {
          if (buttonIndex < TASK_STATUSES.length) {
            try {
              await updateTaskStatus(
                projectId,
                taskKey,
                TASK_STATUSES[buttonIndex].value
              );
              fetchProjectData();
            } catch (err) {
              Alert.alert('Lá»—i', err.message);
            }
          }
        }
      );
    } else {
      // Sá»­ dá»¥ng Alert cho Android
      Alert.alert(
        'Chá»n tráº¡ng thÃ¡i cÃ´ng viá»‡c',
        `Cáº­p nháº­t tráº¡ng thÃ¡i cho "${getTaskDisplayName(taskKey)}"`,
        [
          ...TASK_STATUSES.map((status) => ({
            text: status.label,
            onPress: async () => {
              try {
                await updateTaskStatus(projectId, taskKey, status.value);
                fetchProjectData();
              } catch (err) {
                Alert.alert('Lá»—i', err.message);
              }
            },
          })),
          { text: 'Há»§y', style: 'cancel' },
        ]
      );
    }
  };

  // HÃ m cáº­p nháº­t tÃªn cÃ´ng viá»‡c khÃ¡c
  const handleUpdateCustomTask = async () => {
    if (!customTaskName.trim() && project?.tasks?.other?.name) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p tÃªn cÃ´ng viá»‡c');
      return;
    }

    try {
      await updateCustomTask(
        projectId,
        customTaskName.trim(),
        currentUser?.uid
      );
      setCustomTaskModalVisible(false);
      fetchProjectData();
    } catch (err) {
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t tÃªn cÃ´ng viá»‡c khÃ¡c');
    }
  };

  // Äiá»u hÆ°á»›ng Ä‘áº¿n trang chi tiáº¿t khÃ¡ch hÃ ng
  const navigateToCustomerDetail = () => {
    if (project && project.customerId) {
      navigation.navigate('CustomerDetail', { customerId: project.customerId });
    } else {
      Alert.alert('ThÃ´ng bÃ¡o', 'Dá»± Ã¡n nÃ y chÆ°a Ä‘Æ°á»£c gÃ¡n cho khÃ¡ch hÃ ng nÃ o.');
    }
  };

  // HÃ m xoÃ¡ dá»± Ã¡n
  const handleDeleteProject = async () => {
    Alert.alert(
      'XÃ¡c nháº­n XÃ³a',
      'Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a dá»± Ã¡n nÃ y khÃ´ng? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.',
      [
        { text: 'Há»§y', style: 'cancel' },
        {
          text: 'XÃ³a',
          style: 'destructive',
          onPress: async () => {
            try {
              await deleteProject(projectId);
              Alert.alert('ThÃ nh cÃ´ng', 'Dá»± Ã¡n Ä‘Ã£ Ä‘Æ°á»£c xÃ³a.', [
                { text: 'OK', onPress: () => navigation.goBack() },
              ]);
            } catch (err) {
              Alert.alert('Lá»—i', err.message);
            }
          },
        },
      ]
    );
  };

  const handleCopyDriveLink = async () => {
    if (project?.driveFolderUrl) {
      try {
        await Clipboard.setStringAsync(project.driveFolderUrl);
        setCopySuccess(true);
        setTimeout(() => setCopySuccess(false), 2000);
      } catch (err) {
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ copy Ä‘Æ°á»ng dáº«n.');
      }
    } else {
      Alert.alert('ThÃ´ng bÃ¡o', 'KhÃ´ng cÃ³ Ä‘Æ°á»ng dáº«n Drive Ä‘á»ƒ copy.');
    }
  };

  const handleStagePress = (stage) => {
    navigation.navigate('StageDetail', {
      projectId,
      stage,
    });
  };

  const changeStatus = async (stage, status) => {
    try {
      await updateWorkflowStageStatus(projectId, stage.stageId, status);
      fetchProjectData();
    } catch (e) {
      Alert.alert('Lá»—i', e.message);
    }
  };

  // Hiá»ƒn thá»‹ khi Ä‘ang táº£i dá»¯ liá»‡u
  if (loading) {
    return (
      <View style={styles.centerContainer}>
        <ActivityIndicator size="large" color="#0066cc" />
        <Text style={styles.loadingText}>Äang táº£i thÃ´ng tin dá»± Ã¡n...</Text>
      </View>
    );
  }

  // Hiá»ƒn thá»‹ khi cÃ³ lá»—i
  if (error) {
    return (
      <View style={styles.centerContainer}>
        <Ionicons name="alert-circle-outline" size={50} color="#FF3B30" />
        <Text style={styles.errorText}>{error}</Text>
        <TouchableOpacity
          style={styles.retryButton}
          onPress={() => navigation.goBack()}
        >
          <Text style={styles.retryButtonText}>Quay láº¡i</Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Hiá»ƒn thá»‹ khi khÃ´ng tÃ¬m tháº¥y dá»± Ã¡n
  if (!project) {
    return (
      <View style={styles.centerContainer}>
        <Ionicons name="briefcase-outline" size={50} color="#999" />
        <Text style={styles.errorText}>KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin dá»± Ã¡n</Text>
        <TouchableOpacity
          style={styles.retryButton}
          onPress={() => navigation.goBack()}
        >
          <Text style={styles.retryButtonText}>Quay láº¡i</Text>
        </TouchableOpacity>
      </View>
    );
  }

  // Äá»‹nh dáº¡ng ngÃ y thÃ¡ng
  const formatDate = (timestamp) => {
    if (!timestamp) return 'ChÆ°a xÃ¡c Ä‘á»‹nh';
    try {
      return new Date(timestamp.seconds * 1000).toLocaleDateString('vi-VN');
    } catch (e) {
      return 'NgÃ y khÃ´ng há»£p lá»‡';
    }
  };

  // Äá»‹nh dáº¡ng sá»‘ tiá»n
  const formatCurrency = (amount) => {
    if (!amount) return '0 VNÄ';

    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
      minimumFractionDigits: 0,
    }).format(amount);
  };

  // Láº¥y mÃ u sáº¯c theo tráº¡ng thÃ¡i dá»± Ã¡n
  const getStatusColor = (status) => {
    switch (status) {
      case 'completed':
        return '#4CAF50';
      case 'in-progress':
        return '#FFD54F';
      case 'pending':
        return '#9E9E9E';
      case 'cancelled':
        return '#F44336';
      default:
        return '#6c757d';
    }
  };

  // Láº¥y nhÃ£n hiá»ƒn thá»‹ cho tráº¡ng thÃ¡i dá»± Ã¡n
  const getStatusLabel = (status) => {
    switch (status) {
      case 'completed':
        return 'HoÃ n thÃ nh';
      case 'in-progress':
        return 'Äang thá»±c hiá»‡n';
      case 'pending':
        return 'Chá» xá»­ lÃ½';
      case 'cancelled':
        return 'ÄÃ£ há»§y';
      default:
        return 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
    }
  };

  // Láº¥y mÃ u sáº¯c theo tráº¡ng thÃ¡i cÃ´ng viá»‡c
  const getTaskStatusColor = (status) => {
    switch (status) {
      case 'completed':
        return '#4CAF50';
      case 'in_progress':
        return '#2196F3';
      default:
        return '#FF9800';
    }
  };

  // Láº¥y nhÃ£n hiá»ƒn thá»‹ cho tráº¡ng thÃ¡i cÃ´ng viá»‡c
  const getTaskStatusLabel = (status) => {
    switch (status) {
      case 'completed':
        return 'HoÃ n thÃ nh';
      case 'in_progress':
        return 'Äang lÃ m';
      default:
        return 'Chá» xá»­ lÃ½';
    }
  };

  // Láº¥y tÃªn hiá»ƒn thá»‹ cho cÃ´ng viá»‡c
  const getTaskDisplayName = (taskKey) => {
    const task = TASK_DEFINITIONS.find((t) => t.key === taskKey);
    return task ? task.label : 'CÃ´ng viá»‡c khÃ´ng xÃ¡c Ä‘á»‹nh';
  };

  // Render chÃ­nh
  return (
    <View style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Ionicons name="arrow-back" size={24} color="#333" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Chi tiáº¿t dá»± Ã¡n</Text>
        <TouchableOpacity
          style={styles.deleteButton}
          onPress={handleDeleteProject}
        >
          <Ionicons name="trash-outline" size={24} color="#d11a2a" />
        </TouchableOpacity>
      </View>

      <ScrollView contentContainerStyle={styles.contentContainer}>
        {/* Project Header */}
        <View style={styles.projectHeader}>
          <Text style={styles.projectName}>
            {project.name || 'ChÆ°a cÃ³ tÃªn'}
          </Text>

          <View style={styles.statusContainer}>
            <View
              style={[
                styles.statusTag,
                { borderColor: getStatusColor(project.status) },
              ]}
            >
              <Text
                style={[
                  styles.statusText,
                  { color: getStatusColor(project.status) },
                ]}
              >
                {getStatusLabel(project.status)}
              </Text>
            </View>
          </View>

          <Text style={styles.projectDescription}>
            {project.description || 'KhÃ´ng cÃ³ mÃ´ táº£'}
          </Text>
        </View>

        {/* NÃºt Ä‘iá»u hÆ°á»›ng Ä‘áº¿n mÃ n hÃ¬nh bÃ¡o giÃ¡ */}
        <View style={styles.infoSection}>
          <TouchableOpacity
            style={styles.quotationButton}
            onPress={() =>
              navigation.navigate('Quotation', {
                projectId: project.id,
                projectName: project.name,
                project: project, // Truyá»n toÃ n bá»™ object project
              })
            }
          >
            <Ionicons name="calculator-outline" size={24} color="#fff" />
            <Text style={styles.quotationButtonText}>Quáº£n lÃ½ BÃ¡o giÃ¡</Text>
          </TouchableOpacity>

          {/* NÃºt quáº£n lÃ½ mua váº­t tÆ° - chá»‰ hiá»‡n khi dá»± Ã¡n Ä‘ang thá»±c hiá»‡n */}
          {project.status === 'in-progress' && (
            <TouchableOpacity
              style={[
                styles.quotationButton,
                { backgroundColor: '#4CAF50', marginTop: 8 },
              ]}
              onPress={() =>
                navigation.navigate('MaterialPurchase', {
                  projectId: project.id,
                  projectName: project.name,
                  project: project,
                })
              }
            >
              <Ionicons name="cart-outline" size={24} color="#fff" />
              <Text style={styles.quotationButtonText}>Quáº£n lÃ½ Mua Váº­t TÆ°</Text>
            </TouchableOpacity>
          )}

          {/* NÃºt má»Ÿ thÆ° má»¥c dá»± Ã¡n trÃªn Google Drive */}
          {project.driveFolderUrl ? (
            <View style={styles.driveLinkContainer}>
              <TouchableOpacity
                style={styles.driveLinkButton}
                onPress={() => {
                  const { Linking } = require('react-native');
                  Linking.openURL(project.driveFolderUrl).catch(() =>
                    Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ má»Ÿ thÆ° má»¥c Google Drive')
                  );
                }}
              >
                <Ionicons
                  name="folder-open"
                  size={18}
                  color="#fff"
                  style={styles.buttonIcon}
                />
                <Text style={styles.driveLinkText}>Má»Ÿ thÆ° má»¥c Drive</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.shareButton,
                  { backgroundColor: copySuccess ? '#4CAF50' : '#2980B9' },
                ]}
                onPress={handleCopyDriveLink}
              >
                <Ionicons
                  name={copySuccess ? 'checkmark' : 'copy'}
                  size={20}
                  color="#fff"
                />
              </TouchableOpacity>
            </View>
          ) : (
            <Text style={styles.driveNotAvailable}>
              ThÆ° má»¥c Google Drive Ä‘ang Ä‘Æ°á»£c táº¡o...
            </Text>
          )}
        </View>

        {/* Pháº§n thÃ´ng tin khÃ¡ch hÃ ng vÃ  cÃ¡c thÃ´ng tin khÃ¡c */}
        <View style={styles.infoSection}>
          <Text style={styles.sectionTitle}>ThÃ´ng tin khÃ¡ch hÃ ng</Text>

          <TouchableOpacity
            style={styles.customerCard}
            onPress={navigateToCustomerDetail}
          >
            <View style={styles.customerInfo}>
              <Ionicons
                name="business"
                size={24}
                color="#0066cc"
                style={styles.customerIcon}
              />
              <View>
                <Text style={styles.customerName}>
                  {project.customerName || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}
                </Text>
                {project.customerContact && (
                  <Text style={styles.customerDetail}>
                    NgÆ°á»i liÃªn há»‡: {project.customerContact}
                  </Text>
                )}
                {project.customerEmail && (
                  <Text style={styles.customerDetail}>
                    Email: {project.customerEmail}
                  </Text>
                )}
                {project.customerPhone && (
                  <Text style={styles.customerDetail}>
                    SÄT: {project.customerPhone}
                  </Text>
                )}
              </View>
            </View>
            <Ionicons name="chevron-forward" size={20} color="#999" />
          </TouchableOpacity>
        </View>

        <View style={styles.infoSection}>
          <Text style={styles.sectionTitle}>ThÃ´ng tin cÆ¡ báº£n</Text>

          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>NgÃ y báº¯t Ä‘áº§u:</Text>
            <Text style={styles.infoValue}>
              {project.startDate
                ? formatDate(project.startDate)
                : 'ChÆ°a xÃ¡c Ä‘á»‹nh'}
            </Text>
          </View>

          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>NgÃ y káº¿t thÃºc:</Text>
            <Text style={styles.infoValue}>
              {project.endDate ? formatDate(project.endDate) : 'ChÆ°a xÃ¡c Ä‘á»‹nh'}
            </Text>
          </View>

          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Sá»‘ ngÃ y thi cÃ´ng:</Text>
            <Text style={styles.infoValue}>
              {project.durationInDays
                ? `${project.durationInDays} ngÃ y`
                : 'ChÆ°a xÃ¡c Ä‘á»‹nh'}
            </Text>
          </View>

          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Vá»‹ trÃ­ thi cÃ´ng:</Text>
            <Text style={styles.infoValue}>
              {project.location === 'workshop'
                ? 'Táº¡i xÆ°á»Ÿng'
                : project.location === 'site'
                ? 'Táº¡i cÃ´ng trÃ¬nh'
                : 'ChÆ°a xÃ¡c Ä‘á»‹nh'}
            </Text>
          </View>

          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>NgÃ¢n sÃ¡ch:</Text>
            <Text style={styles.infoValue}>
              {project.budget
                ? formatCurrency(project.budget)
                : 'ChÆ°a xÃ¡c Ä‘á»‹nh'}
            </Text>
          </View>

          {project.notes && (
            <>
              <Text style={styles.notesLabel}>Ghi chÃº:</Text>
              <Text style={styles.notesText}>{project.notes}</Text>
            </>
          )}
        </View>

        {/* Quy trÃ¬nh Sáº£n xuáº¥t */}
        <View style={styles.tasksBoard}>
          <Text style={styles.sectionTitle}>Quy trÃ¬nh Sáº£n xuáº¥t</Text>
          {project.workflowStages?.length ? (
            project.workflowStages
              .sort((a, b) => a.order - b.order)
              .map((item) => {
                const color =
                  item.status === 'completed'
                    ? '#4CAF50'
                    : item.status === 'in_progress'
                    ? '#FFD54F'
                    : '#9E9E9E';
                return (
                  <TouchableOpacity
                    key={item.stageId}
                    style={styles.taskRow}
                    onPress={() => handleStagePress(item)}
                  >
                    <Text style={styles.taskName}>{item.processName}</Text>
                    <Text
                      style={[
                        styles.taskStatusText,
                        { backgroundColor: color + '33', color: color },
                      ]}
                    >
                      {item.status === 'completed'
                        ? 'HoÃ n thÃ nh'
                        : item.status === 'in_progress'
                        ? 'Äang lÃ m'
                        : 'Chá» xá»­ lÃ½'}
                    </Text>
                  </TouchableOpacity>
                );
              })
          ) : (
            <Text style={styles.emptyTasksText}>ChÆ°a cÃ³ cÃ´ng Ä‘oáº¡n.</Text>
          )}
        </View>
      </ScrollView>

      {/* Footer */}
      <View style={styles.footer}>
        <TouchableOpacity
          style={styles.editButton}
          onPress={() => navigation.navigate('EditProject', { project })}
        >
          <Ionicons name="create-outline" size={20} color="#fff" />
          <Text style={styles.editButtonText}>Chá»‰nh sá»­a</Text>
        </TouchableOpacity>
      </View>

      {/* Modal cáº­p nháº­t tÃªn cÃ´ng viá»‡c khÃ¡c */}
      <Modal
        visible={customTaskModalVisible}
        transparent={true}
        animationType="fade"
        onRequestClose={() => setCustomTaskModalVisible(false)}
      >
        <TouchableOpacity
          style={styles.modalContainer}
          activeOpacity={1}
          onPress={() => setCustomTaskModalVisible(false)}
        >
          <TouchableOpacity
            style={styles.modalContent}
            activeOpacity={1}
            onPress={(e) => e.stopPropagation()}
          >
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Cáº­p nháº­t cÃ´ng viá»‡c khÃ¡c</Text>
              <TouchableOpacity
                style={styles.closeButton}
                onPress={() => setCustomTaskModalVisible(false)}
                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}
              >
                <Ionicons name="close" size={24} color="#333" />
              </TouchableOpacity>
            </View>

            <View style={styles.modalBody}>
              <Text style={styles.inputLabel}>TÃªn cÃ´ng viá»‡c:</Text>
              <TextInput
                style={styles.input}
                value={customTaskName}
                onChangeText={setCustomTaskName}
                placeholder="Nháº­p tÃªn cÃ´ng viá»‡c khÃ¡c..."
              />

              <TouchableOpacity
                style={[styles.saveTaskButton, { marginTop: 20 }]}
                onPress={handleUpdateCustomTask}
              >
                <Text style={styles.saveTaskButtonText}>LÆ°u</Text>
              </TouchableOpacity>
            </View>
          </TouchableOpacity>
        </TouchableOpacity>
      </Modal>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  centerContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  loadingText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
  },
  errorText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  retryButton: {
    marginTop: 16,
    backgroundColor: '#0066cc',
    paddingHorizontal: 20,
    paddingVertical: 10,
    borderRadius: 6,
  },
  retryButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '500',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  deleteButton: {
    padding: 4,
  },
  contentContainer: {
    paddingBottom: 20,
  },
  projectHeader: {
    backgroundColor: '#fff',
    padding: 16,
    marginBottom: 12,
  },
  projectName: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 8,
  },
  statusContainer: {
    flexDirection: 'row',
    marginBottom: 12,
  },
  statusTag: {
    borderWidth: 1,
    borderRadius: 12,
    paddingHorizontal: 10,
    paddingVertical: 4,
  },
  statusText: {
    fontSize: 14,
    fontWeight: '500',
  },
  projectDescription: {
    fontSize: 16,
    color: '#666',
    lineHeight: 22,
    marginTop: 8,
  },
  infoSection: {
    backgroundColor: '#fff',
    padding: 16,
    marginBottom: 12,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#333',
    marginBottom: 12,
  },
  customerCard: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#f9f9f9',
    padding: 12,
    borderRadius: 8,
    borderLeftWidth: 4,
    borderLeftColor: '#0066cc',
  },
  customerInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  customerIcon: {
    marginRight: 12,
  },
  customerName: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
    marginBottom: 2,
  },
  customerDetail: {
    fontSize: 14,
    color: '#666',
    marginTop: 2,
  },
  infoRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingVertical: 8,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  infoLabel: {
    fontSize: 15,
    color: '#666',
    flex: 1,
  },
  infoValue: {
    fontSize: 15,
    color: '#333',
    fontWeight: '500',
    flex: 1,
    textAlign: 'right',
  },
  notesLabel: {
    fontSize: 15,
    color: '#666',
    marginTop: 12,
    marginBottom: 6,
  },
  notesText: {
    fontSize: 15,
    color: '#333',
    lineHeight: 20,
  },
  footer: {
    backgroundColor: '#fff',
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  editButton: {
    backgroundColor: '#0066cc',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 12,
    borderRadius: 8,
  },
  editButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
    marginLeft: 8,
  },
  tasksBoard: {
    backgroundColor: '#fff',
    padding: 16,
    marginBottom: 12,
  },
  taskRow: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  taskContent: {
    flex: 1,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginLeft: 12,
  },
  taskName: {
    fontSize: 16,
    color: '#333',
    flex: 1,
    marginRight: 8,
  },
  taskNamePlaceholder: {
    fontSize: 16,
    color: '#999',
    fontStyle: 'italic',
  },
  taskStatusText: {
    fontSize: 14,
    fontWeight: '500',
    backgroundColor: '#f5f5f5',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
    overflow: 'hidden',
    minWidth: 80,
    textAlign: 'center',
  },
  editTaskButton: {
    padding: 8,
  },
  emptyTasksContainer: {
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  emptyTasksText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
  },
  modalContent: {
    backgroundColor: 'white',
    padding: 20,
    borderRadius: 10,
    width: '85%',
    maxWidth: 400,
  },
  modalHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingBottom: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    marginBottom: 16,
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  closeButton: {
    padding: 4,
  },
  modalBody: {
    width: '100%',
  },
  inputLabel: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 12,
  },
  input: {
    borderWidth: 1,
    borderColor: '#ccc',
    padding: 12,
    borderRadius: 6,
    width: '100%',
    backgroundColor: '#fff',
    fontSize: 16,
  },
  saveTaskButton: {
    backgroundColor: '#0066cc',
    padding: 12,
    borderRadius: 6,
    alignItems: 'center',
  },
  saveTaskButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: 'bold',
  },
  quotationButton: {
    backgroundColor: '#4CAF50',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 14,
    borderRadius: 8,
    marginBottom: 10,
  },
  quotationButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
    marginLeft: 10,
  },
  driveLinkContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 10,
  },
  driveLinkButton: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#2196F3',
    paddingVertical: 12,
    borderRadius: 8,
  },
  buttonIcon: {
    marginRight: 10,
  },
  driveLinkText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  shareButton: {
    marginLeft: 12,
    width: 44,
    height: 44,
    borderRadius: 8,
    alignItems: 'center',
    justifyContent: 'center',
  },
  driveNotAvailable: {
    textAlign: 'center',
    color: '#888',
    fontSize: 14,
    marginTop: 8,
    fontStyle: 'italic',
  },
});

export default ProjectDetailScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\ProjectManagementScreen.js ---

//src/screens/ProjectManagementScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  FlatList,
  StyleSheet,
  ActivityIndicator,
  Pressable,
  TouchableOpacity,
  SafeAreaView,
  StatusBar,
  TextInput,
  LayoutAnimation,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { getProjectsByStatus } from '../api/projectService';
import { useTheme } from '../contexts/ThemeContext';

// Component hiá»ƒn thá»‹ tá»«ng dá»± Ã¡n trong danh sÃ¡ch
const ProjectListItem = ({ project, onPress }) => {
  const { theme } = useTheme();
  // XÃ¡c Ä‘á»‹nh mÃ u sáº¯c theo tráº¡ng thÃ¡i dá»± Ã¡n
  const getStatusColor = (status) => {
    switch (status) {
      case 'completed':
        return '#4CAF50'; // xanh lÃ¡
      case 'in-progress':
        return '#FFD54F'; // vÃ ng nháº¡t
      case 'pending':
        return theme.textSecondary; // gray
      case 'cancelled':
        return '#F44336'; // Ä‘á»
      default:
        return theme.textMuted; // Sá»­ dá»¥ng mÃ u tá»« theme
    }
  };

  // Láº¥y nhÃ£n hiá»ƒn thá»‹ cho tráº¡ng thÃ¡i dá»± Ã¡n
  const getStatusLabel = (status) => {
    switch (status) {
      case 'completed':
        return 'HoÃ n thÃ nh';
      case 'in-progress':
        return 'Äang thá»±c hiá»‡n';
      case 'pending':
        return 'Chá» xá»­ lÃ½';
      case 'cancelled':
        return 'ÄÃ£ há»§y';
      default:
        return status || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
    }
  };

  return (
    <Pressable
      style={({ pressed }) => [
        styles.projectCard,
        { backgroundColor: theme.card },
        pressed && styles.cardPressed,
      ]}
      onPress={() => onPress(project)}
    >
      <View style={styles.projectInfo}>
        <Text style={[styles.projectName, { color: theme.text }]}>
          {project.name || 'ChÆ°a cÃ³ tÃªn'}
        </Text>

        {project.customerName && (
          <View style={styles.infoRow}>
            <Ionicons
              name="business-outline"
              size={14}
              color={theme.textSecondary}
            />
            <Text style={[styles.infoText, { color: theme.textSecondary }]}>
              {project.customerName}
            </Text>
          </View>
        )}

        {project.startDate && (
          <View style={styles.infoRow}>
            <Ionicons
              name="calendar-outline"
              size={14}
              color={theme.textSecondary}
            />
            <Text style={[styles.infoText, { color: theme.textSecondary }]}>
              {new Date(project.startDate.seconds * 1000).toLocaleDateString(
                'vi-VN'
              )}
            </Text>
          </View>
        )}

        {project.endDate && (
          <View style={styles.infoRow}>
            <Ionicons
              name="flag-outline"
              size={14}
              color={theme.textSecondary}
            />
            <Text style={[styles.infoText, { color: theme.textSecondary }]}>
              {new Date(project.endDate.seconds * 1000).toLocaleDateString(
                'vi-VN'
              )}
            </Text>
          </View>
        )}
      </View>

      <View style={styles.projectStatusContainer}>
        <View
          style={[
            styles.projectStatusTag,
            { borderColor: getStatusColor(project.status) },
          ]}
        >
          <Text
            style={[
              styles.projectStatusText,
              { color: getStatusColor(project.status) },
            ]}
          >
            {getStatusLabel(project.status)}
          </Text>
        </View>
      </View>
    </Pressable>
  );
};

const ProjectManagementScreen = ({ navigation }) => {
  const { theme } = useTheme();
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [refreshing, setRefreshing] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [filteredProjects, setFilteredProjects] = useState([]);

  // Status filters
  const FILTERS = [
    {
      key: 'pending',
      label: 'Chá» xá»­ lÃ½',
      color: 'transparent',
      textColor: theme.text,
    },
    {
      key: 'in-progress',
      label: 'Äang thá»±c hiá»‡n',
      color: '#FFF9C4',
      textColor: theme.text,
    },
    {
      key: 'completed',
      label: 'ÄÃ£ hoÃ n thÃ nh',
      color: '#4CAF50',
      textColor: '#fff',
    },
  ];

  const [activeFilter, setActiveFilter] = useState('pending');
  const [cacheByStatus, setCacheByStatus] = useState({});

  // HÃ m táº£i danh sÃ¡ch dá»± Ã¡n
  const loadProjectsByStatus = async (statusKey, forceRefresh = false) => {
    try {
      setLoading(true);
      setError(null);

      if (!forceRefresh && cacheByStatus[statusKey]) {
        setProjects(cacheByStatus[statusKey]);
        return;
      }

      if (forceRefresh) {
        setCacheByStatus((prev) => ({ ...prev, [statusKey]: undefined }));
      }

      const data = await getProjectsByStatus(statusKey);

      // LÆ°u cache má»›i
      setCacheByStatus((prev) => ({ ...prev, [statusKey]: data }));

      // ThÃªm animation khi cáº­p nháº­t danh sÃ¡ch
      LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);

      setProjects(data);
      setFilteredProjects(data); // Khá»Ÿi táº¡o danh sÃ¡ch lá»c ban Ä‘áº§u
    } catch (err) {
      console.error('Lá»—i khi táº£i danh sÃ¡ch dá»± Ã¡n:', err);
      setError('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch dá»± Ã¡n. Vui lÃ²ng thá»­ láº¡i sau.');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  // Táº£i dá»¯ liá»‡u khi mÃ n hÃ¬nh Ä‘Æ°á»£c má»Ÿ
  useEffect(() => {
    loadProjectsByStatus(activeFilter);

    // ThÃªm listener Ä‘á»ƒ lÃ m má»›i danh sÃ¡ch khi quay láº¡i tá»« mÃ n hÃ¬nh khÃ¡c
    const unsubscribe = navigation.addListener('focus', () => {
      loadProjectsByStatus(activeFilter, true); // force refresh Ä‘á»ƒ cáº­p nháº­t náº¿u tráº¡ng thÃ¡i dá»± Ã¡n thay Ä‘á»•i
    });

    return unsubscribe;
  }, [navigation, activeFilter]);

  // Lá»c danh sÃ¡ch dá»± Ã¡n theo tá»« khÃ³a tÃ¬m kiáº¿m
  useEffect(() => {
    if (!searchQuery.trim()) {
      LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
      setFilteredProjects(projects);
      return;
    }

    const query = searchQuery.toLowerCase().trim();
    const filtered = projects.filter((project) => {
      const name = (project.name || '').toLowerCase();
      const customerName = (project.customerName || '').toLowerCase();
      const description = (project.description || '').toLowerCase();

      return (
        name.includes(query) ||
        customerName.includes(query) ||
        description.includes(query)
      );
    });

    // ThÃªm animation khi cáº­p nháº­t káº¿t quáº£ tÃ¬m kiáº¿m
    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);

    setFilteredProjects(filtered);
  }, [searchQuery, projects]);

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng kÃ©o Ä‘á»ƒ lÃ m má»›i
  const handleRefresh = () => {
    setRefreshing(true);
    // clear cache for current status then reload
    setCacheByStatus((prev) => ({ ...prev, [activeFilter]: undefined }));
    loadProjectsByStatus(activeFilter);
  };

  // Xá»­ lÃ½ khi thay Ä‘á»•i bá»™ lá»c
  const handleFilterChange = (statusKey) => {
    // LuÃ´n refetch Ä‘á»ƒ Ä‘áº£m báº£o dá»¯ liá»‡u má»›i nháº¥t
    loadProjectsByStatus(statusKey, true);
    setActiveFilter(statusKey);
    setSearchQuery('');
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥n vÃ o má»™t dá»± Ã¡n
  const handleProjectPress = (project) => {
    navigation.navigate('ProjectDetail', { projectId: project.id });
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng muá»‘n thÃªm dá»± Ã¡n má»›i
  const handleAddProject = () => {
    navigation.navigate('AddProject');
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº­p tá»« khÃ³a tÃ¬m kiáº¿m
  const handleSearch = (text) => {
    setSearchQuery(text);
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng muá»‘n xÃ³a tá»« khÃ³a tÃ¬m kiáº¿m
  const handleClearSearch = () => {
    setSearchQuery('');
  };

  // Render filter buttons
  const renderFilterButtons = () => (
    <View style={styles.filterContainer}>
      {FILTERS.map((f) => (
        <TouchableOpacity
          key={f.key}
          style={[
            styles.filterButton,
            {
              backgroundColor: f.color,
              borderWidth: activeFilter === f.key ? 2 : 1,
              borderColor:
                activeFilter === f.key ? theme.primary : theme.border,
            },
          ]}
          onPress={() => handleFilterChange(f.key)}
        >
          <Text style={[styles.filterText, { color: f.textColor }]}>
            {f.label}
          </Text>
        </TouchableOpacity>
      ))}
    </View>
  );

  return (
    <SafeAreaView
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      <StatusBar
        barStyle={theme.dark ? 'light-content' : 'dark-content'}
        backgroundColor={theme.background}
      />

      {renderFilterButtons()}

      {/* Search Bar */}
      <View style={styles.searchContainer}>
        <Ionicons
          name="search-outline"
          size={20}
          color={theme.textMuted}
          style={styles.searchIcon}
        />
        <TextInput
          style={[
            styles.searchInput,
            { color: theme.text, borderColor: theme.border },
          ]}
          placeholder="TÃ¬m theo tÃªn, khÃ¡ch hÃ ng..."
          placeholderTextColor={theme.textMuted}
          value={searchQuery}
          onChangeText={handleSearch}
        />
        {searchQuery.length > 0 && (
          <TouchableOpacity
            onPress={handleClearSearch}
            style={styles.clearSearchButton}
          >
            <Ionicons name="close-circle" size={20} color={theme.textMuted} />
          </TouchableOpacity>
        )}
      </View>

      {/* Project List */}
      {loading && !refreshing ? (
        <View style={styles.centerContainer}>
          <ActivityIndicator size="large" color={theme.primary} />
        </View>
      ) : error ? (
        <View style={styles.centerContainer}>
          <Ionicons
            name="alert-circle-outline"
            size={50}
            color={theme.danger}
          />
          <Text style={[styles.errorText, { color: theme.textSecondary }]}>
            {error}
          </Text>
          <TouchableOpacity
            onPress={handleRefresh}
            style={[styles.button, { backgroundColor: theme.primary }]}
          >
            <Text style={styles.buttonText}>Thá»­ láº¡i</Text>
          </TouchableOpacity>
        </View>
      ) : filteredProjects.length === 0 ? (
        <View style={styles.centerContainer}>
          <Ionicons
            name="file-tray-outline"
            size={60}
            color={theme.textMuted}
          />
          <Text style={[styles.emptyText, { color: theme.textSecondary }]}>
            ChÆ°a cÃ³ dá»± Ã¡n nÃ o
          </Text>
          <TouchableOpacity
            onPress={handleAddProject}
            style={[styles.button, { backgroundColor: theme.primary }]}
          >
            <Text style={styles.buttonText}>ThÃªm dá»± Ã¡n má»›i</Text>
          </TouchableOpacity>
        </View>
      ) : (
        <FlatList
          data={filteredProjects}
          renderItem={({ item }) => (
            <ProjectListItem project={item} onPress={handleProjectPress} />
          )}
          keyExtractor={(item) => item.id.toString()}
          contentContainerStyle={styles.listContainer}
          onRefresh={handleRefresh}
          refreshing={refreshing}
        />
      )}
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f9fa',
  },
  centerContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
    backgroundColor: '#fff',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
  },
  headerTitle: {
    fontSize: 24,
    fontWeight: 'bold',
  },
  addButton: {
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: 'center',
    alignItems: 'center',
    position: 'absolute',
    right: 16,
    bottom: 24,
    zIndex: 1,
    elevation: 4,
  },
  searchContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 12,
    backgroundColor: 'white',
    borderBottomWidth: 1,
    borderBottomColor: '#EEEEEE',
  },
  searchInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f1f1f1',
    borderRadius: 8,
    paddingHorizontal: 10,
  },
  searchIcon: {
    marginRight: 8,
  },
  searchInput: {
    flex: 1,
    height: 44,
    fontSize: 16,
    color: '#333',
  },
  clearButton: {
    padding: 4,
  },
  listContainer: {
    paddingHorizontal: 16,
  },
  resultCount: {
    marginHorizontal: 16,
    marginBottom: 8,
    fontSize: 14,
  },
  projectCard: {
    backgroundColor: 'white',
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
    flexDirection: 'row',
    justifyContent: 'space-between',
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
  },
  cardPressed: {
    opacity: 0.7,
    backgroundColor: '#f5f5f5',
  },
  projectInfo: {
    flex: 1,
    paddingRight: 8,
  },
  projectName: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333333',
    marginBottom: 6,
  },
  infoRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 4,
  },
  infoText: {
    fontSize: 14,
    color: '#666666',
    marginLeft: 6,
  },
  projectStatusContainer: {
    justifyContent: 'flex-start',
    alignItems: 'flex-end',
  },
  projectStatusTag: {
    borderWidth: 1,
    borderRadius: 12,
    paddingHorizontal: 8,
    paddingVertical: 2,
  },
  projectStatusText: {
    fontSize: 12,
    fontWeight: '500',
  },
  loadingText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666666',
  },
  errorText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666666',
    textAlign: 'center',
  },
  retryButton: {
    marginTop: 16,
    backgroundColor: '#0066cc',
    paddingHorizontal: 20,
    paddingVertical: 10,
    borderRadius: 6,
  },
  retryButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '500',
  },
  emptyText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666666',
    marginBottom: 20,
  },
  addProjectButton: {
    backgroundColor: '#0066cc',
    paddingHorizontal: 20,
    paddingVertical: 12,
    borderRadius: 6,
  },
  addProjectButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: 'bold',
  },
  emptySearchContainer: {
    alignItems: 'center',
    justifyContent: 'center',
    padding: 40,
  },
  emptySearchText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666666',
    textAlign: 'center',
  },
  button: {
    marginTop: 16,
    backgroundColor: '#0066cc',
    paddingHorizontal: 20,
    paddingVertical: 10,
    borderRadius: 6,
  },
  buttonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '500',
  },
  clearSearchButton: {
    padding: 4,
  },
  filterContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    padding: 12,
  },
  filterButton: {
    flex: 1,
    paddingVertical: 8,
    borderRadius: 6,
    alignItems: 'center',
    marginHorizontal: 4,
  },
  filterText: {
    fontSize: 14,
    fontWeight: '500',
  },
});

export default ProjectManagementScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\ProjectsScreen.js ---

//src/screens/ProjectsScreen.js
import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  SafeAreaView,
  StatusBar,
  FlatList,
  TouchableOpacity,
  ActivityIndicator,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { getProjectsByStatus } from '../api/projectService';
import { useFocusEffect } from '@react-navigation/native';

const ProjectsScreen = ({ navigation }) => {
  const [projects, setProjects] = useState([]); // projects hiá»ƒn thá»‹ theo bá»™ lá»c hiá»‡n hÃ nh
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [refreshing, setRefreshing] = useState(false);

  // Lá»c theo tráº¡ng thÃ¡i dá»± Ã¡n
  const FILTERS = [
    {
      key: 'pending',
      label: 'Chá» xá»­ lÃ½',
      color: 'transparent',
      textColor: '#333',
    },
    {
      key: 'in-progress',
      label: 'Äang thá»±c hiá»‡n',
      color: '#FFF9C4',
      textColor: '#333',
    }, // vÃ ng nháº¡t
    {
      key: 'completed',
      label: 'HoÃ n thÃ nh',
      color: '#4CAF50',
      textColor: '#fff',
    },
  ];

  const [activeFilter, setActiveFilter] = useState('pending');
  // Cache dá»± Ã¡n theo tráº¡ng thÃ¡i Ä‘á»ƒ khÃ´ng pháº£i gá»i láº¡i
  const [cacheByStatus, setCacheByStatus] = useState({});

  // HÃ m táº£i danh sÃ¡ch dá»± Ã¡n
  const loadProjectsByStatus = async (statusKey) => {
    // Náº¿u Ä‘Ã£ cÃ³ trong cache thÃ¬ dÃ¹ng luÃ´n
    if (cacheByStatus[statusKey]) {
      setProjects(cacheByStatus[statusKey]);
      return;
    }

    try {
      setLoading(true);
      setError(null);
      const data = await getProjectsByStatus(statusKey);
      // LÆ°u cache
      setCacheByStatus((prev) => ({ ...prev, [statusKey]: data }));
      setProjects(data);
    } catch (err) {
      console.error('Lá»—i khi táº£i danh sÃ¡ch dá»± Ã¡n:', err);
      setError('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch dá»± Ã¡n. Vui lÃ²ng thá»­ láº¡i sau.');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  // Táº£i dá»¯ liá»‡u khi mÃ n hÃ¬nh Ä‘Æ°á»£c má»Ÿ
  useEffect(() => {
    loadProjectsByStatus(activeFilter);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [activeFilter]);

  // LÃ m má»›i dá»¯ liá»‡u khi mÃ n hÃ¬nh Ä‘Æ°á»£c focus
  useFocusEffect(
    React.useCallback(() => {
      loadProjectsByStatus(activeFilter);
      // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [activeFilter])
  );

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng kÃ©o Ä‘á»ƒ lÃ m má»›i
  const handleRefresh = () => {
    setRefreshing(true);
    // XÃ³a cache cá»§a bá»™ lá»c hiá»‡n hÃ nh Ä‘á»ƒ buá»™c refetch
    setCacheByStatus((prev) => ({ ...prev, [activeFilter]: undefined }));
    loadProjectsByStatus(activeFilter);
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥n vÃ o nÃºt quáº£n lÃ½ dá»± Ã¡n
  const handleManageProjects = () => {
    navigation.navigate('ProjectManagement');
  };

  // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥n vÃ o má»™t dá»± Ã¡n
  const handleProjectPress = (project) => {
    navigation.navigate('ProjectDetail', { projectId: project.id });
  };

  // NÃºt lá»c tráº¡ng thÃ¡i
  const renderFilterButtons = () => (
    <View style={styles.filterContainer}>
      {FILTERS.map((f) => (
        <TouchableOpacity
          key={f.key}
          style={[
            styles.filterButton,
            {
              backgroundColor: activeFilter === f.key ? f.color : '#fff',
              borderWidth: 1,
              borderColor:
                activeFilter === f.key
                  ? f.color === 'transparent'
                    ? '#ccc'
                    : f.color
                  : '#ccc',
            },
          ]}
          onPress={() => setActiveFilter(f.key)}
        >
          <Text
            style={[
              styles.filterText,
              { color: activeFilter === f.key ? f.textColor : '#333' },
            ]}
          >
            {f.label}
          </Text>
        </TouchableOpacity>
      ))}
    </View>
  );

  // Hiá»ƒn thá»‹ tá»«ng dá»± Ã¡n trong danh sÃ¡ch
  const renderProjectItem = ({ item }) => {
    const getStatusColor = (status) => {
      switch (status) {
        case 'completed':
          return '#4CAF50';
        case 'in-progress':
          return '#FFD54F'; // vÃ ng nháº¡t
        case 'pending':
          return '#9E9E9E';
        case 'cancelled':
          return '#F44336';
        default:
          return '#9E9E9E';
      }
    };

    const getStatusLabel = (status) => {
      switch (status) {
        case 'completed':
          return 'HoÃ n thÃ nh';
        case 'in-progress':
          return 'Äang thá»±c hiá»‡n';
        case 'pending':
          return 'Chá» xá»­ lÃ½';
        case 'cancelled':
          return 'ÄÃ£ há»§y';
        default:
          return status || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
      }
    };

    return (
      <TouchableOpacity
        style={styles.projectCard}
        onPress={() => handleProjectPress(item)}
      >
        <View style={styles.projectHeader}>
          <Text style={styles.projectName}>{item.name || 'ChÆ°a cÃ³ tÃªn'}</Text>
          <View
            style={[
              styles.statusBadge,
              { backgroundColor: getStatusColor(item.status) },
            ]}
          >
            <Text style={styles.statusText}>{getStatusLabel(item.status)}</Text>
          </View>
        </View>

        {item.customerName && (
          <View style={styles.infoRow}>
            <Ionicons name="business-outline" size={14} color="#666" />
            <Text style={styles.infoText}>{item.customerName}</Text>
          </View>
        )}
      </TouchableOpacity>
    );
  };

  if (loading && !refreshing) {
    return (
      <SafeAreaView style={styles.container}>
        <StatusBar barStyle="dark-content" backgroundColor="#f8f8f8" />
        <View style={styles.header}>
          <Text style={styles.headerTitle}>Dá»± Ãn</Text>
        </View>
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#0066cc" />
          <Text style={styles.loadingText}>Äang táº£i dá»± Ã¡n...</Text>
        </View>
      </SafeAreaView>
    );
  }

  if (error) {
    return (
      <SafeAreaView style={styles.container}>
        <StatusBar barStyle="dark-content" backgroundColor="#f8f8f8" />
        <View style={styles.header}>
          <Text style={styles.headerTitle}>Dá»± Ãn</Text>
        </View>
        <View style={styles.errorContainer}>
          <Ionicons name="alert-circle-outline" size={50} color="#FF3B30" />
          <Text style={styles.errorText}>{error}</Text>
          <TouchableOpacity
            style={styles.retryButton}
            onPress={() => loadProjectsByStatus(activeFilter)}
          >
            <Text style={styles.retryButtonText}>Thá»­ láº¡i</Text>
          </TouchableOpacity>
        </View>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView style={styles.container}>
      <StatusBar barStyle="dark-content" backgroundColor="#f8f8f8" />

      <View style={styles.header}>
        <Text style={styles.headerTitle}>Dá»± Ãn</Text>
        <TouchableOpacity
          style={styles.manageButton}
          onPress={handleManageProjects}
        >
          <Text style={styles.manageButtonText}>Quáº£n lÃ½</Text>
          <Ionicons name="settings-outline" size={16} color="#0066cc" />
        </TouchableOpacity>
      </View>

      {renderFilterButtons()}

      {projects.length > 0 ? (
        <FlatList
          data={projects}
          keyExtractor={(item) => item.id}
          renderItem={renderProjectItem}
          contentContainerStyle={styles.listContent}
          refreshing={refreshing}
          onRefresh={handleRefresh}
        />
      ) : (
        <View style={styles.emptyContainer}>
          <Ionicons name="briefcase" size={80} color="#0066cc" />
          <Text style={styles.emptyTitle}>ChÆ°a cÃ³ dá»± Ã¡n nÃ o</Text>
          <Text style={styles.emptySubtitle}>
            Báº¡n chÆ°a cÃ³ dá»± Ã¡n nÃ o. HÃ£y táº¡o dá»± Ã¡n má»›i trong má»¥c quáº£n lÃ½ dá»± Ã¡n.
          </Text>
          <TouchableOpacity
            style={styles.manageFullButton}
            onPress={handleManageProjects}
          >
            <Text style={styles.manageFullButtonText}>Quáº£n lÃ½ dá»± Ã¡n</Text>
          </TouchableOpacity>
        </View>
      )}
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f8f8',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 12,
    backgroundColor: 'white',
    borderBottomWidth: 1,
    borderBottomColor: '#EEEEEE',
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333333',
  },
  manageButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 10,
    borderRadius: 16,
    backgroundColor: '#E6F0FF',
  },
  manageButtonText: {
    fontSize: 14,
    fontWeight: '500',
    color: '#0066cc',
    marginRight: 4,
  },
  listContent: {
    padding: 16,
  },
  projectCard: {
    backgroundColor: 'white',
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
  },
  projectHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  projectName: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
    flex: 1,
  },
  statusBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  statusText: {
    fontSize: 12,
    fontWeight: '500',
    color: 'white',
  },
  infoRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 4,
  },
  infoText: {
    fontSize: 14,
    color: '#666',
    marginLeft: 6,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
  },
  errorContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  errorText: {
    marginTop: 12,
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  retryButton: {
    marginTop: 16,
    paddingVertical: 8,
    paddingHorizontal: 16,
    backgroundColor: '#0066cc',
    borderRadius: 8,
  },
  retryButtonText: {
    fontSize: 14,
    fontWeight: '500',
    color: 'white',
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  emptyTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#333',
    marginTop: 20,
    textAlign: 'center',
  },
  emptySubtitle: {
    fontSize: 16,
    color: '#666',
    marginTop: 10,
    textAlign: 'center',
    paddingHorizontal: 30,
  },
  manageFullButton: {
    marginTop: 24,
    paddingVertical: 12,
    paddingHorizontal: 24,
    backgroundColor: '#0066cc',
    borderRadius: 8,
  },
  manageFullButtonText: {
    fontSize: 16,
    fontWeight: '500',
    color: 'white',
  },
  filterContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 10,
  },
  filterButton: {
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 16,
  },
  filterText: {
    fontSize: 14,
    fontWeight: '500',
  },
});

export default ProjectsScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\ProposalListScreen.js ---

// src/screens/ProposalListScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  TouchableOpacity,
  Alert,
  Modal,
  TextInput,
  ActivityIndicator,
  ScrollView,
  KeyboardAvoidingView,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useAuth } from '../contexts/AuthContext';
import {
  getProposalsByStatus,
  updateProposalStatus,
  canApproveProposal,
  updateProposalMaterialPrices,
} from '../api/proposalService';

const ProposalListScreen = ({ navigation }) => {
  const { currentUser } = useAuth();
  const [loading, setLoading] = useState(true);
  const [proposals, setProposals] = useState([]);
  const [selectedTab, setSelectedTab] = useState('pending');
  const [refreshing, setRefreshing] = useState(false);
  const [showApproveModal, setShowApproveModal] = useState(false);
  const [showRejectModal, setShowRejectModal] = useState(false);
  const [selectedProposal, setSelectedProposal] = useState(null);
  const [comment, setComment] = useState('');
  const [showMaterialsModal, setShowMaterialsModal] = useState(false);
  const [selectedMaterials, setSelectedMaterials] = useState([]);
  const [showPriceModal, setShowPriceModal] = useState(false);
  const [editableMaterials, setEditableMaterials] = useState([]);
  const [currentProposalId, setCurrentProposalId] = useState(null);

  const canApprove = canApproveProposal(currentUser?.role);

  useEffect(() => {
    loadProposals();
  }, [selectedTab]);

  const loadProposals = async () => {
    setLoading(true);
    try {
      const data = await getProposalsByStatus(selectedTab);
      console.log(`Loaded ${selectedTab} proposals:`, data.length);
      setProposals(data);
    } catch (error) {
      console.error('Error loading proposals:', error);
      Alert.alert(
        'Lá»—i',
        'KhÃ´ng thá»ƒ táº£i danh sÃ¡ch Ä‘á» xuáº¥t. Vui lÃ²ng táº¡o chá»‰ má»¥c theo hÆ°á»›ng dáº«n trong Firebase Console.'
      );
      setProposals([]);
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  const handleRefresh = () => {
    setRefreshing(true);
    loadProposals();
  };

  const formatDate = (timestamp) => {
    if (!timestamp) return 'N/A';
    try {
      if (timestamp.toDate) {
        return timestamp.toDate().toLocaleDateString('vi-VN');
      } else if (timestamp instanceof Date) {
        return timestamp.toLocaleDateString('vi-VN');
      }
      return 'N/A';
    } catch (e) {
      return 'N/A';
    }
  };

  const handleApprove = (proposal) => {
    setSelectedProposal(proposal);
    setComment('');
    setShowApproveModal(true);
  };

  const handleReject = (proposal) => {
    setSelectedProposal(proposal);
    setComment('');
    setShowRejectModal(true);
  };

  const confirmApprove = async () => {
    if (!selectedProposal) return;

    try {
      await updateProposalStatus(
        selectedProposal.id,
        'approved',
        currentUser.uid,
        currentUser.displayName || currentUser.email,
        comment
      );
      setShowApproveModal(false);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ phÃª duyá»‡t Ä‘á» xuáº¥t');
      loadProposals();
    } catch (error) {
      console.error('Error approving proposal:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ phÃª duyá»‡t Ä‘á» xuáº¥t');
    }
  };

  const confirmReject = async () => {
    if (!selectedProposal) return;

    if (!comment.trim()) {
      return Alert.alert('Thiáº¿u thÃ´ng tin', 'Vui lÃ²ng nháº­p lÃ½ do tá»« chá»‘i');
    }

    try {
      await updateProposalStatus(
        selectedProposal.id,
        'rejected',
        currentUser.uid,
        currentUser.displayName || currentUser.email,
        comment
      );
      setShowRejectModal(false);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ tá»« chá»‘i Ä‘á» xuáº¥t');
      loadProposals();
    } catch (error) {
      console.error('Error rejecting proposal:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ tá»« chá»‘i Ä‘á» xuáº¥t');
    }
  };

  const showMaterialDetails = (materials) => {
    setSelectedMaterials(materials || []);
    setShowMaterialsModal(true);
  };

  const openPriceEditor = (proposal) => {
    // Create a deep copy of materials with price fields
    const materialsWithPrices = proposal.items
      ? JSON.parse(JSON.stringify(proposal.items))
      : [];

    // Ensure each material has price and totalPrice fields
    materialsWithPrices.forEach((item) => {
      if (!item.price) item.price = '';
      if (!item.totalPrice) item.totalPrice = '';
    });

    setEditableMaterials(materialsWithPrices);
    setCurrentProposalId(proposal.id);
    setShowPriceModal(true);
  };

  const handlePriceChange = (index, price) => {
    const updatedMaterials = [...editableMaterials];
    updatedMaterials[index].price = price;

    // Calculate total price if both price and quantity exist
    const quantity = parseFloat(updatedMaterials[index].quantity);
    const priceValue = parseFloat(price);

    if (!isNaN(quantity) && !isNaN(priceValue)) {
      updatedMaterials[index].totalPrice = (quantity * priceValue).toString();
    }

    setEditableMaterials(updatedMaterials);
  };

  const savePriceUpdates = async () => {
    if (!currentProposalId) return;

    try {
      await updateProposalMaterialPrices(currentProposalId, editableMaterials);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ cáº­p nháº­t giÃ¡ váº­t tÆ°');
      setShowPriceModal(false);
      loadProposals(); // Reload to get updated data
    } catch (error) {
      console.error('Error updating prices:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t giÃ¡ váº­t tÆ°');
    }
  };

  const navigateToProject = (projectId) => {
    if (projectId) {
      navigation.navigate('ProjectDetail', { projectId });
    } else {
      Alert.alert('ThÃ´ng bÃ¡o', 'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin dá»± Ã¡n.');
    }
  };

  // Add function to navigate to CreatePO screen
  const navigateToCreatePO = (proposal) => {
    if (!proposal.projectId) {
      Alert.alert('ThÃ´ng bÃ¡o', 'Cáº§n cÃ³ thÃ´ng tin dá»± Ã¡n Ä‘á»ƒ táº¡o Ä‘Æ¡n Ä‘áº·t hÃ ng.');
      return;
    }

    // Check if materials have prices
    const missingPrices = proposal.items?.some(
      (item) => !item.price || item.price === '0' || item.price === ''
    );
    if (missingPrices) {
      Alert.alert(
        'Cáº§n cáº­p nháº­t giÃ¡',
        'Má»™t sá»‘ váº­t tÆ° chÆ°a cÃ³ giÃ¡. Vui lÃ²ng cáº­p nháº­t giÃ¡ trÆ°á»›c khi táº¡o Ä‘Æ¡n Ä‘áº·t hÃ ng.',
        [
          { text: 'ÄÃ³ng', style: 'cancel' },
          { text: 'Cáº­p nháº­t giÃ¡', onPress: () => openPriceEditor(proposal) },
        ]
      );
      return;
    }

    // Prepare data for PO creation
    const poData = {
      projectId: proposal.projectId,
      projectName: proposal.projectName,
      materials:
        proposal.items?.map((item) => ({
          name: item.name,
          specs: item.specification || '',
          unit: item.unit || '',
          quantity: item.quantity || '0',
          unitPrice: item.price || '0',
        })) || [],
      vatPercentage: 10,
      proposalId: proposal.id,
      proposalCode: proposal.proposalCode,
    };

    navigation.navigate('CreatePO', poData);
  };

  const getPriorityColor = (priority) => {
    switch (priority) {
      case 'urgent':
        return '#FF3B30';
      case 'normal':
        return '#007AFF';
      default:
        return '#007AFF';
    }
  };

  const getPriorityLabel = (priority) => {
    switch (priority) {
      case 'urgent':
        return 'Gáº¥p';
      case 'normal':
        return 'BÃ¬nh thÆ°á»ng';
      default:
        return priority || 'BÃ¬nh thÆ°á»ng';
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'approved':
        return '#4CAF50';
      case 'rejected':
        return '#FF3B30';
      case 'pending':
        return '#FF9500';
      default:
        return '#999';
    }
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'approved':
        return 'ÄÃ£ duyá»‡t';
      case 'rejected':
        return 'Tá»« chá»‘i';
      case 'pending':
        return 'Chá» duyá»‡t';
      default:
        return status || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
    }
  };

  const renderItem = ({ item }) => (
    <View style={styles.card}>
      <View style={styles.cardHeader}>
        <Text style={styles.proposalCode}>{item.proposalCode}</Text>
        <View
          style={[
            styles.statusBadge,
            { backgroundColor: getStatusColor(item.status) },
          ]}
        >
          <Text style={styles.statusText}>{getStatusLabel(item.status)}</Text>
        </View>
      </View>

      <Text style={styles.projectName}>{item.projectName}</Text>

      <View style={styles.infoRow}>
        <View style={styles.infoItem}>
          <Text style={styles.infoLabel}>NgÆ°á»i Ä‘á» xuáº¥t:</Text>
          <Text style={styles.infoValue}>{item.createdByName || 'N/A'}</Text>
        </View>
        <View style={styles.infoItem}>
          <Text style={styles.infoLabel}>NgÃ y táº¡o:</Text>
          <Text style={styles.infoValue}>{formatDate(item.createdAt)}</Text>
        </View>
      </View>

      <View style={styles.infoRow}>
        <View style={styles.infoItem}>
          <Text style={styles.infoLabel}>NgÃ y cáº§n cung cáº¥p:</Text>
          <Text style={styles.infoValue}>{formatDate(item.requiredDate)}</Text>
        </View>
        <View style={styles.infoItem}>
          <Text style={styles.infoLabel}>Má»©c Ä‘á»™:</Text>
          {item.priority === 'normal' ? (
            <Text style={styles.infoValue}>
              {getPriorityLabel(item.priority)}
            </Text>
          ) : (
            <View
              style={[
                styles.priorityBadge,
                { backgroundColor: getPriorityColor(item.priority) },
              ]}
            >
              <Text style={styles.priorityText}>
                {getPriorityLabel(item.priority)}
              </Text>
            </View>
          )}
        </View>
      </View>

      <View style={styles.purposeContainer}>
        <Text style={styles.purposeLabel}>Má»¥c Ä‘Ã­ch:</Text>
        <Text style={styles.purposeText}>
          {item.purpose || 'KhÃ´ng cÃ³ mÃ´ táº£'}
        </Text>
      </View>

      <View style={styles.cardActions}>
        <Text style={styles.itemsCount}>
          Sá»‘ lÆ°á»£ng váº­t tÆ°: {item.items?.length || 0}
        </Text>
        <View style={styles.actionButtonsRow}>
          <TouchableOpacity
            style={styles.viewButton}
            onPress={() => showMaterialDetails(item.items)}
          >
            <Ionicons name="list" size={16} color="#0066cc" />
            <Text style={styles.viewButtonText}>Xem váº­t tÆ°</Text>
          </TouchableOpacity>

          {item.projectId && (
            <TouchableOpacity
              style={styles.viewButton}
              onPress={() => navigateToProject(item.projectId)}
            >
              <Ionicons name="open-outline" size={16} color="#0066cc" />
              <Text style={styles.viewButtonText}>Xem dá»± Ã¡n</Text>
            </TouchableOpacity>
          )}

          <TouchableOpacity
            style={[styles.viewButton, styles.priceButton]}
            onPress={() => openPriceEditor(item)}
          >
            <Ionicons name="cash-outline" size={16} color="#28a745" />
            <Text style={[styles.viewButtonText, { color: '#28a745' }]}>
              Cáº­p nháº­t giÃ¡
            </Text>
          </TouchableOpacity>

          {/* Add PO list button for approved proposals */}
          {item.status === 'approved' && (
            <TouchableOpacity
              style={styles.viewButton}
              onPress={() =>
                navigation.navigate('POList', { projectId: item.projectId })
              }
            >
              <Ionicons
                name="document-text-outline"
                size={16}
                color="#0066cc"
              />
              <Text style={styles.viewButtonText}>PO</Text>
            </TouchableOpacity>
          )}
        </View>
      </View>

      {item.status === 'pending' && canApprove && (
        <View style={styles.actionButtons}>
          <TouchableOpacity
            style={[styles.actionButton, styles.approveButton]}
            onPress={() => handleApprove(item)}
          >
            <Ionicons name="checkmark-circle" size={16} color="#fff" />
            <Text style={styles.actionButtonText}>PhÃª duyá»‡t</Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={[styles.actionButton, styles.rejectButton]}
            onPress={() => handleReject(item)}
          >
            <Ionicons name="close-circle" size={16} color="#fff" />
            <Text style={styles.actionButtonText}>Tá»« chá»‘i</Text>
          </TouchableOpacity>
        </View>
      )}

      {item.status !== 'pending' && item.comment && (
        <View style={styles.commentContainer}>
          <Text style={styles.commentLabel}>Ghi chÃº:</Text>
          <Text style={styles.commentText}>{item.comment}</Text>
        </View>
      )}
    </View>
  );

  return (
    <View style={styles.container}>
      <Text style={styles.title}>Danh sÃ¡ch Ä‘á» xuáº¥t mua váº­t tÆ°</Text>

      {/* Tab navigation */}
      <View style={styles.tabContainer}>
        <TouchableOpacity
          style={[styles.tab, selectedTab === 'pending' && styles.activeTab]}
          onPress={() => setSelectedTab('pending')}
        >
          <Text
            style={[
              styles.tabText,
              selectedTab === 'pending' && styles.activeTabText,
            ]}
          >
            Chá» duyá»‡t
          </Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.tab, selectedTab === 'approved' && styles.activeTab]}
          onPress={() => setSelectedTab('approved')}
        >
          <Text
            style={[
              styles.tabText,
              selectedTab === 'approved' && styles.activeTabText,
            ]}
          >
            ÄÃ£ duyá»‡t
          </Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.tab, selectedTab === 'rejected' && styles.activeTab]}
          onPress={() => setSelectedTab('rejected')}
        >
          <Text
            style={[
              styles.tabText,
              selectedTab === 'rejected' && styles.activeTabText,
            ]}
          >
            Tá»« chá»‘i
          </Text>
        </TouchableOpacity>
      </View>

      {loading && !refreshing ? (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#0066cc" />
          <Text style={styles.loadingText}>Äang táº£i dá»¯ liá»‡u...</Text>
        </View>
      ) : (
        <FlatList
          data={proposals}
          renderItem={renderItem}
          keyExtractor={(item) => item.id}
          contentContainerStyle={styles.listContent}
          refreshing={refreshing}
          onRefresh={handleRefresh}
          ListEmptyComponent={
            <View style={styles.emptyContainer}>
              <Ionicons name="document-text-outline" size={48} color="#ccc" />
              <Text style={styles.emptyText}>
                {selectedTab === 'pending'
                  ? 'KhÃ´ng cÃ³ Ä‘á» xuáº¥t nÃ o Ä‘ang chá» duyá»‡t'
                  : selectedTab === 'approved'
                  ? 'KhÃ´ng cÃ³ Ä‘á» xuáº¥t nÃ o Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t'
                  : 'KhÃ´ng cÃ³ Ä‘á» xuáº¥t nÃ o bá»‹ tá»« chá»‘i'}
              </Text>
            </View>
          }
        />
      )}

      {/* Approve Modal */}
      <Modal visible={showApproveModal} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContainer}>
            <Text style={styles.modalTitle}>PhÃª duyá»‡t Ä‘á» xuáº¥t</Text>
            <Text style={styles.modalSubtitle}>
              {selectedProposal?.proposalCode} - {selectedProposal?.projectName}
            </Text>

            <TextInput
              style={styles.commentInput}
              placeholder="Ghi chÃº (khÃ´ng báº¯t buá»™c)"
              value={comment}
              onChangeText={setComment}
              multiline
            />

            <View style={styles.modalActions}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelButton]}
                onPress={() => setShowApproveModal(false)}
              >
                <Text style={styles.cancelButtonText}>Há»§y</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.modalButton, styles.confirmButton]}
                onPress={confirmApprove}
              >
                <Text style={styles.confirmButtonText}>XÃ¡c nháº­n</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* Reject Modal */}
      <Modal visible={showRejectModal} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContainer}>
            <Text style={styles.modalTitle}>Tá»« chá»‘i Ä‘á» xuáº¥t</Text>
            <Text style={styles.modalSubtitle}>
              {selectedProposal?.proposalCode} - {selectedProposal?.projectName}
            </Text>

            <TextInput
              style={styles.commentInput}
              placeholder="LÃ½ do tá»« chá»‘i (báº¯t buá»™c)"
              value={comment}
              onChangeText={setComment}
              multiline
            />

            <View style={styles.modalActions}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelButton]}
                onPress={() => setShowRejectModal(false)}
              >
                <Text style={styles.cancelButtonText}>Há»§y</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.modalButton, styles.rejectConfirmButton]}
                onPress={confirmReject}
              >
                <Text style={styles.confirmButtonText}>XÃ¡c nháº­n</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* Materials Modal */}
      <Modal visible={showMaterialsModal} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <View style={[styles.modalContainer, styles.materialsModalContainer]}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Chi tiáº¿t váº­t tÆ°</Text>
              <TouchableOpacity onPress={() => setShowMaterialsModal(false)}>
                <Ionicons name="close" size={24} color="#666" />
              </TouchableOpacity>
            </View>

            <ScrollView style={styles.materialsScrollView}>
              {selectedMaterials && selectedMaterials.length > 0 ? (
                selectedMaterials.map((item, index) => (
                  <View key={index} style={styles.materialItem}>
                    <Text style={styles.materialName}>
                      {index + 1}. {item.name || 'KhÃ´ng cÃ³ tÃªn'}
                    </Text>
                    <View style={styles.materialDetails}>
                      {item.specification ? (
                        <Text style={styles.materialSpec}>
                          Quy cÃ¡ch: {item.specification}
                        </Text>
                      ) : null}
                      <Text style={styles.materialQuantity}>
                        Sá»‘ lÆ°á»£ng: {item.quantity || 0} {item.unit || ''}
                      </Text>
                      {item.price && (
                        <Text style={styles.materialPrice}>
                          ÄÆ¡n giÃ¡: {item.price} VNÄ
                        </Text>
                      )}
                      {item.totalPrice && (
                        <Text style={styles.materialTotalPrice}>
                          ThÃ nh tiá»n: {item.totalPrice} VNÄ
                        </Text>
                      )}
                    </View>
                  </View>
                ))
              ) : (
                <Text style={styles.emptyMaterialsText}>
                  KhÃ´ng cÃ³ váº­t tÆ° nÃ o.
                </Text>
              )}
            </ScrollView>

            <TouchableOpacity
              style={styles.closeButton}
              onPress={() => setShowMaterialsModal(false)}
            >
              <Text style={styles.closeButtonText}>ÄÃ³ng</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      {/* Price Update Modal */}
      <Modal visible={showPriceModal} transparent animationType="slide">
        <KeyboardAvoidingView
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
          style={styles.modalOverlay}
        >
          <View style={[styles.modalContainer, styles.priceModalContainer]}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Cáº­p nháº­t giÃ¡ váº­t tÆ°</Text>
              <TouchableOpacity onPress={() => setShowPriceModal(false)}>
                <Ionicons name="close" size={24} color="#666" />
              </TouchableOpacity>
            </View>

            <ScrollView style={styles.priceScrollView}>
              {editableMaterials && editableMaterials.length > 0 ? (
                editableMaterials.map((item, index) => (
                  <View key={index} style={styles.priceItem}>
                    <Text style={styles.materialName}>
                      {index + 1}. {item.name || 'KhÃ´ng cÃ³ tÃªn'}
                    </Text>
                    <View style={styles.materialDetails}>
                      {item.specification ? (
                        <Text style={styles.materialSpec}>
                          Quy cÃ¡ch: {item.specification}
                        </Text>
                      ) : null}
                      <Text style={styles.materialQuantity}>
                        Sá»‘ lÆ°á»£ng: {item.quantity || 0} {item.unit || ''}
                      </Text>

                      <View style={styles.priceInputContainer}>
                        <Text style={styles.priceLabel}>ÄÆ¡n giÃ¡ (VNÄ):</Text>
                        <TextInput
                          style={styles.priceInput}
                          value={item.price}
                          onChangeText={(text) =>
                            handlePriceChange(index, text)
                          }
                          keyboardType="numeric"
                          placeholder="Nháº­p Ä‘Æ¡n giÃ¡"
                        />
                      </View>

                      {item.totalPrice && (
                        <Text style={styles.materialTotalPrice}>
                          ThÃ nh tiá»n: {item.totalPrice} VNÄ
                        </Text>
                      )}
                    </View>
                  </View>
                ))
              ) : (
                <Text style={styles.emptyMaterialsText}>
                  KhÃ´ng cÃ³ váº­t tÆ° nÃ o.
                </Text>
              )}
            </ScrollView>

            <View style={styles.modalActions}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelButton]}
                onPress={() => setShowPriceModal(false)}
              >
                <Text style={styles.cancelButtonText}>Há»§y</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.modalButton, styles.saveButton]}
                onPress={savePriceUpdates}
              >
                <Text style={styles.confirmButtonText}>LÆ°u giÃ¡</Text>
              </TouchableOpacity>
            </View>
          </View>
        </KeyboardAvoidingView>
      </Modal>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
    backgroundColor: '#f5f5f5',
  },
  title: {
    fontSize: 20,
    fontWeight: 'bold',
    marginBottom: 16,
    color: '#333',
  },
  tabContainer: {
    flexDirection: 'row',
    marginBottom: 16,
    backgroundColor: '#fff',
    borderRadius: 8,
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  tab: {
    flex: 1,
    paddingVertical: 12,
    alignItems: 'center',
  },
  activeTab: {
    borderBottomWidth: 2,
    borderBottomColor: '#0066cc',
  },
  tabText: {
    color: '#666',
    fontWeight: '500',
  },
  activeTabText: {
    color: '#0066cc',
    fontWeight: '600',
  },
  listContent: {
    paddingBottom: 20,
  },
  card: {
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  cardHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  proposalCode: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
  },
  statusBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  statusText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: '600',
  },
  projectName: {
    fontSize: 15,
    fontWeight: '500',
    marginBottom: 12,
    color: '#444',
  },
  infoRow: {
    flexDirection: 'row',
    marginBottom: 8,
    alignItems: 'flex-start', // Align items to the top
  },
  infoItem: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    flexWrap: 'wrap', // Allow content to wrap
  },
  infoLabel: {
    fontSize: 13,
    color: '#666',
    marginRight: 4,
  },
  infoValue: {
    fontSize: 13,
    color: '#333',
    fontWeight: '500',
  },
  priorityBadge: {
    paddingHorizontal: 8,
    paddingVertical: 2,
    borderRadius: 12,
  },
  priorityText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: '600',
  },
  purposeContainer: {
    marginTop: 4,
    marginBottom: 8,
    padding: 8,
    backgroundColor: '#f9f9f9',
    borderRadius: 4,
  },
  purposeLabel: {
    fontSize: 13,
    fontWeight: '500',
    color: '#555',
    marginBottom: 4,
  },
  purposeText: {
    fontSize: 13,
    color: '#333',
  },
  cardActions: {
    marginTop: 8,
    borderTopWidth: 1,
    borderTopColor: '#f0f0f0',
    paddingTop: 8,
  },
  itemsCount: {
    fontSize: 13,
    color: '#666',
    marginBottom: 8,
  },
  actionButtonsRow: {
    flexDirection: 'row',
    justifyContent: 'flex-start',
    alignItems: 'center',
  },
  viewButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 12,
    backgroundColor: '#f0f7ff',
    borderRadius: 20,
    marginRight: 8,
  },
  viewButtonText: {
    color: '#0066cc',
    fontSize: 12,
    fontWeight: '500',
    marginLeft: 4,
  },
  actionButtons: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 12,
    borderTopWidth: 1,
    borderTopColor: '#eee',
    paddingTop: 12,
  },
  actionButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 4,
    flex: 1,
    marginHorizontal: 4,
  },
  approveButton: {
    backgroundColor: '#4CAF50',
  },
  rejectButton: {
    backgroundColor: '#E74C3C', // Softer red color
  },
  actionButtonText: {
    color: '#fff',
    fontWeight: '600',
    marginLeft: 4,
  },
  commentContainer: {
    marginTop: 12,
    padding: 8,
    backgroundColor: '#f5f5f5',
    borderRadius: 4,
    borderLeftWidth: 3,
    borderLeftColor: '#ccc',
  },
  commentLabel: {
    fontSize: 12,
    fontWeight: '500',
    color: '#666',
    marginBottom: 2,
  },
  commentText: {
    fontSize: 13,
    color: '#333',
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 8,
    color: '#666',
  },
  emptyContainer: {
    padding: 40,
    alignItems: 'center',
    justifyContent: 'center',
  },
  emptyText: {
    marginTop: 8,
    color: '#666',
    textAlign: 'center',
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContainer: {
    width: '90%',
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 20,
    elevation: 5,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 4,
    color: '#333',
  },
  modalSubtitle: {
    fontSize: 14,
    color: '#666',
    marginBottom: 16,
  },
  commentInput: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 4,
    padding: 10,
    height: 100,
    textAlignVertical: 'top',
    marginBottom: 16,
  },
  modalActions: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
  },
  modalButton: {
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 4,
    marginLeft: 8,
  },
  cancelButton: {
    backgroundColor: '#f5f5f5',
  },
  cancelButtonText: {
    color: '#333',
  },
  confirmButton: {
    backgroundColor: '#4CAF50',
  },
  rejectConfirmButton: {
    backgroundColor: '#E74C3C', // Softer red color
  },
  confirmButtonText: {
    color: '#fff',
    fontWeight: '600',
  },
  materialsModalContainer: {
    maxHeight: '80%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    paddingBottom: 8,
  },
  materialsScrollView: {
    maxHeight: '80%', // Limit height to allow button to be visible
  },
  materialItem: {
    paddingVertical: 10,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  materialName: {
    fontSize: 14,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 4,
  },
  materialDetails: {
    marginLeft: 16,
  },
  materialSpec: {
    fontSize: 13,
    color: '#666',
    marginBottom: 2,
  },
  materialQuantity: {
    fontSize: 13,
    color: '#333',
  },
  emptyMaterialsText: {
    textAlign: 'center',
    padding: 20,
    color: '#666',
  },
  closeButton: {
    backgroundColor: '#0066cc',
    padding: 12,
    borderRadius: 4,
    alignItems: 'center',
    marginTop: 16,
  },
  closeButtonText: {
    color: '#fff',
    fontWeight: '600',
  },
  priceModalContainer: {
    maxHeight: '85%',
    width: '92%',
  },
  priceScrollView: {
    maxHeight: '75%',
  },
  priceItem: {
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  priceInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 6,
    marginBottom: 4,
  },
  priceLabel: {
    fontSize: 13,
    color: '#555',
    width: 100,
  },
  priceInput: {
    flex: 1,
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 4,
    paddingHorizontal: 8,
    paddingVertical: 4,
    fontSize: 13,
  },
  materialPrice: {
    fontSize: 13,
    color: '#28a745',
    marginTop: 2,
  },
  materialTotalPrice: {
    fontSize: 13,
    color: '#28a745',
    fontWeight: '500',
    marginTop: 2,
  },
  saveButton: {
    backgroundColor: '#28a745',
  },
  poButton: {
    backgroundColor: '#fff5e6',
    marginLeft: 8,
    borderColor: '#FF9500',
    borderWidth: 1,
  },
});

export default ProposalListScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\QuotationScreen.js ---

// src/screens/QuotationScreen.js

import React, { useState, useEffect, useCallback, memo } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  ActivityIndicator,
  Modal,
  TextInput,
  TouchableOpacity,
  Alert,
  SafeAreaView,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useFocusEffect } from '@react-navigation/native';
import { useMaterialsProcessor } from '../hooks/useMaterialsProcessor';
import { getQuotationsByProject } from '../api/quotationService';
import * as Sharing from 'expo-sharing';
import * as FileSystem from 'expo-file-system';

// --- CÃ¡c Component vÃ  HÃ m Helper Ä‘Æ°á»£c chuyá»ƒn tá»« ProjectDetailScreen ---

// Memoized row component for the materials list
const MaterialRow = memo(
  ({ item, index, onPriceChange, formatNumber, onToggleSelect }) => {
    // If the item is a note, render it differently
    if (item.isNote) {
      return (
        <View style={styles.tableRow}>
          <View style={styles.noteCell}>
            <Text style={styles.noteText}>{item.name}</Text>
          </View>
        </View>
      );
    }
    return (
      <View style={styles.tableRow}>
        <TouchableOpacity
          style={styles.checkbox}
          onPress={() => onToggleSelect(index)}
        >
          <Ionicons
            name={item.selected ? 'checkbox' : 'square-outline'}
            size={18}
            color={item.selected ? '#0066CC' : '#999'}
          />
        </TouchableOpacity>
        <View style={[styles.tableCell, { flex: 3 }]}>
          <Text style={styles.materialName}>{item.name}</Text>
          {item.material ? (
            <Text style={styles.materialType}>{item.material}</Text>
          ) : null}
          {item.quyCach ? (
            <Text style={styles.materialType}>Quy cÃ¡ch: {item.quyCach}</Text>
          ) : null}
        </View>
        <Text style={[styles.tableCell, { flex: 1, textAlign: 'center' }]}>
          {formatNumber(item.quantity)}
        </Text>
        <Text style={[styles.tableCell, { flex: 1, textAlign: 'center' }]}>
          {formatNumber(item.weight)}
        </Text>
        <Text style={[styles.tableCell, { flex: 0.8, textAlign: 'center' }]}>
          {item.unit}
        </Text>
        <View style={[styles.tableCell, { flex: 1.2 }]}>
          <TextInput
            style={styles.priceInput}
            value={item.unitPrice > 0 ? item.unitPrice.toString() : ''}
            onChangeText={(text) => onPriceChange(text, index)}
            placeholder="Nháº­p..."
            keyboardType="numeric"
            selectTextOnFocus
          />
        </View>
        <Text style={[styles.tableCell, styles.totalPrice, { flex: 1.5 }]}>
          {item.totalPrice > 0 ? item.totalPrice.toLocaleString('vi-VN') : ''}
        </Text>
      </View>
    );
  }
);

// HÃ m format tiá»n
const formatCurrency = (amount) => {
  if (!amount) return '0 VNÄ';
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND',
    minimumFractionDigits: 0,
  }).format(amount);
};

const formatAppNumber = (num) => {
  if (typeof num !== 'number' || isNaN(num)) return '0';
  const roundedNum = Math.round(num * 10) / 10;
  return roundedNum.toString().replace('.', ',');
};
// --------------------------------------------------------------------

const QuotationScreen = ({ route, navigation }) => {
  const { projectId, projectName, project } = route.params;

  const {
    materials,
    showMaterialsTable,
    driveFiles,
    isPickerVisible,
    isLoadingFiles,
    isGoogleDriveLoading,
    handleImportFromGoogleDrive,
    handleFileSelect,
    handlePriceChange,
    handleRequote,
    setIsPickerVisible,
    setMaterials,
  } = useMaterialsProcessor(project);

  const [quotations, setQuotations] = useState([]);
  const [isLoadingQuotations, setIsLoadingQuotations] = useState(true);
  const [showBulkPriceModal, setShowBulkPriceModal] = useState(false);
  const [bulkPrice, setBulkPrice] = useState('');
  const [hasSelections, setHasSelections] = useState(false);

  // Láº¥y lá»‹ch sá»­ bÃ¡o giÃ¡
  useFocusEffect(
    useCallback(() => {
      const loadQuotations = async () => {
        setIsLoadingQuotations(true);
        try {
          const pastQuotations = await getQuotationsByProject(projectId);
          setQuotations(pastQuotations);
        } catch (error) {
          console.error('Lá»—i khi táº£i lá»‹ch sá»­ bÃ¡o giÃ¡:', error);
        } finally {
          setIsLoadingQuotations(false);
        }
      };
      if (projectId) {
        loadQuotations();
      }
    }, [projectId])
  );

  const handleViewPdf = async (pdfUrl, quotationNumber) => {
    if (!pdfUrl) {
      Alert.alert('Lá»—i', 'KhÃ´ng tÃ¬m tháº¥y Ä‘Æ°á»ng dáº«n PDF cho bÃ¡o giÃ¡ nÃ y.');
      return;
    }
    Alert.alert('Äang xá»­ lÃ½', 'Äang táº£i file PDF Ä‘á»ƒ xem...');
    try {
      const fileUri =
        FileSystem.documentDirectory + `${quotationNumber || 'quotation'}.pdf`;
      const { uri } = await FileSystem.downloadAsync(pdfUrl, fileUri);
      if (await Sharing.isAvailableAsync()) {
        await Sharing.shareAsync(uri, { dialogTitle: 'Má»Ÿ hoáº·c chia sáº» PDF' });
      } else {
        Alert.alert(
          'KhÃ´ng thá»ƒ chia sáº»',
          'Thiáº¿t bá»‹ cá»§a báº¡n khÃ´ng há»— trá»£ chá»©c nÄƒng nÃ y.'
        );
      }
    } catch (error) {
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ má»Ÿ file PDF. Vui lÃ²ng thá»­ láº¡i.');
    }
  };

  const handleNavigateToFinalize = () => {
    const subTotal = materials.reduce(
      (sum, item) => sum + (item.totalPrice || 0),
      0
    );
    const customerData = {
      id: project.customerId || '',
      name: project.customerName || 'KhÃ¡ch hÃ ng',
      address: project.customerAddress || '',
      phone: project.customerPhone || '',
      email: project.customerEmail || '',
      contactPerson: project.customerContactPerson || '',
      taxCode: project.customerTaxCode || '',
    };
    navigation.navigate('FinalizeQuotation', {
      materials,
      subTotal,
      projectId,
      projectName: project.name || 'Dá»± Ã¡n má»›i',
      customerData,
    });
  };

  const handleToggleSelect = (index) => {
    setMaterials((prev) => {
      const updated = [...prev];
      updated[index] = {
        ...updated[index],
        selected: !updated[index].selected,
      };

      // Update hasSelections state
      const anySelected = updated.some((item) => item.selected);
      setHasSelections(anySelected);

      return updated;
    });
  };

  const toggleSelectAll = (value) => {
    setMaterials((prev) =>
      prev.map((item) => ({
        ...item,
        selected: value,
      }))
    );
    setHasSelections(value);
  };

  const handleApplyBulkPrice = () => {
    if (!bulkPrice || isNaN(parseFloat(bulkPrice))) {
      Alert.alert('Lá»—i', 'Vui lÃ²ng nháº­p giÃ¡ há»£p lá»‡');
      return;
    }

    const price = parseFloat(bulkPrice);

    setMaterials((prev) => {
      return prev.map((item) => {
        if (item.selected) {
          const weight = parseFloat(item.weight || 0);
          const quantity = parseFloat(item.quantity || 0);

          let totalPrice;
          if (weight > 0) {
            // Náº¿u cÃ³ trá»ng lÆ°á»£ng: thÃ nh tiá»n = sá»‘ lÆ°á»£ng Ã— trá»ng lÆ°á»£ng Ã— Ä‘Æ¡n giÃ¡
            totalPrice = quantity * weight * price;
          } else {
            // Náº¿u khÃ´ng cÃ³ trá»ng lÆ°á»£ng: thÃ nh tiá»n = sá»‘ lÆ°á»£ng Ã— Ä‘Æ¡n giÃ¡
            totalPrice = quantity * price;
          }

          return {
            ...item,
            unitPrice: price,
            totalPrice: totalPrice,
          };
        }
        return item;
      });
    });

    setShowBulkPriceModal(false);
    setBulkPrice('');
  };

  const renderHeader = () => (
    <View style={styles.section}>
      <Text style={styles.sectionTitle}>1. Nháº­p Váº­t TÆ°</Text>
      <TouchableOpacity
        style={[
          styles.importButton,
          isGoogleDriveLoading && styles.importButtonDisabled,
        ]}
        onPress={handleImportFromGoogleDrive}
        disabled={isGoogleDriveLoading}
      >
        {isGoogleDriveLoading ? (
          <ActivityIndicator size="small" color="#fff" />
        ) : (
          <Ionicons name="cloud-download-outline" size={24} color="#fff" />
        )}
        <Text style={styles.importButtonText}>Nháº­p tá»« Google Drive</Text>
      </TouchableOpacity>

      <TouchableOpacity
        style={[styles.manualButton]}
        onPress={() =>
          navigation.navigate('ManualQuotation', {
            projectId,
            projectName,
            project,
          })
        }
      >
        <Ionicons name="create-outline" size={24} color="#fff" />
        <Text style={styles.importButtonText}>Nháº­p thá»§ cÃ´ng</Text>
      </TouchableOpacity>
    </View>
  );

  const renderMaterialsSection = () =>
    showMaterialsTable && (
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>2. Báº£ng TÃ­nh Váº­t TÆ°</Text>

        {materials.length > 0 && (
          <View style={styles.bulkActionContainer}>
            <View style={styles.bulkActionRow}>
              <TouchableOpacity
                style={styles.bulkActionButton}
                onPress={() => toggleSelectAll(true)}
              >
                <Ionicons name="checkbox-outline" size={18} color="#fff" />
                <Text style={styles.bulkActionButtonText}>Chá»n táº¥t cáº£</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.bulkActionButton, styles.unselectButton]}
                onPress={() => toggleSelectAll(false)}
              >
                <Ionicons name="square-outline" size={18} color="#fff" />
                <Text style={styles.bulkActionButtonText}>Bá» chá»n</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.bulkActionButton,
                  styles.priceButton,
                  !hasSelections && styles.disabledButton,
                ]}
                disabled={!hasSelections}
                onPress={() => setShowBulkPriceModal(true)}
              >
                <Ionicons name="pricetag-outline" size={18} color="#fff" />
                <Text style={styles.bulkActionButtonText}>Ãp dá»¥ng giÃ¡</Text>
              </TouchableOpacity>
            </View>
          </View>
        )}

        <View style={styles.tableHeader}>
          <View style={{ width: 30 }}></View>
          <Text style={[styles.headerCell, { flex: 3 }]}>TÃªn váº­t tÆ°</Text>
          <Text style={[styles.headerCell, { flex: 1, textAlign: 'center' }]}>
            SL
          </Text>
          <Text style={[styles.headerCell, { flex: 1, textAlign: 'center' }]}>
            KL
          </Text>
          <Text style={[styles.headerCell, { flex: 0.8, textAlign: 'center' }]}>
            ÄVT
          </Text>
          <Text style={[styles.headerCell, { flex: 1.2, textAlign: 'right' }]}>
            ÄÆ¡n giÃ¡
          </Text>
          <Text style={[styles.headerCell, { flex: 1.5, textAlign: 'right' }]}>
            ThÃ nh tiá»n
          </Text>
        </View>
        <FlatList
          data={materials}
          keyExtractor={(item, index) => `material-row-${index}`}
          renderItem={({ item, index }) => (
            <MaterialRow
              item={item}
              index={index}
              onPriceChange={handlePriceChange}
              formatNumber={formatAppNumber}
              onToggleSelect={handleToggleSelect}
            />
          )}
        />
      </View>
    );

  const renderFooter = () => (
    <>
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>3. Lá»‹ch sá»­ bÃ¡o giÃ¡</Text>
        {isLoadingQuotations ? (
          <ActivityIndicator />
        ) : quotations.length === 0 ? (
          <Text style={styles.emptyText}>ChÆ°a cÃ³ bÃ¡o giÃ¡ nÃ o.</Text>
        ) : (
          <View style={styles.historyContainer}>
            {quotations.map((item, index) => (
              <View
                key={item.id}
                style={[
                  styles.historyItem,
                  index > 0 && styles.historyItemBorder,
                ]}
              >
                <View style={styles.historyInfo}>
                  <Text style={styles.historyNumber}>
                    {item.quotationNumber ||
                      `BÃ¡o giÃ¡ #${item.id.substring(0, 5)}`}
                  </Text>
                  <Text style={styles.historyDate}>
                    NgÃ y táº¡o:{' '}
                    {item.createdAt
                      ? new Date(
                          item.createdAt.seconds * 1000
                        ).toLocaleDateString('vi-VN')
                      : 'KhÃ´ng rÃµ'}
                  </Text>
                  <Text style={styles.historyTotal}>
                    Tá»•ng cá»™ng: {formatCurrency(item.grandTotal)}
                  </Text>
                </View>
                <View style={styles.historyActions}>
                  <TouchableOpacity
                    style={styles.historyActionButton}
                    onPress={() =>
                      handleViewPdf(item.pdfUrl, item.quotationNumber)
                    }
                  >
                    <Ionicons
                      name="document-text-outline"
                      size={20}
                      color="#fff"
                    />
                    <Text style={styles.historyActionButtonText}>Xem PDF</Text>
                  </TouchableOpacity>
                  <TouchableOpacity
                    style={[styles.historyActionButton, styles.requoteButton]}
                    onPress={() => handleRequote(item)}
                  >
                    <Ionicons name="copy-outline" size={20} color="#fff" />
                    <Text style={styles.historyActionButtonText}>
                      BÃ¡o giÃ¡ láº¡i
                    </Text>
                  </TouchableOpacity>
                </View>
              </View>
            ))}
          </View>
        )}
      </View>
    </>
  );

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Ionicons name="arrow-back" size={24} color="#333" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>BÃ¡o giÃ¡: {projectName}</Text>
        <View style={{ width: 24 }} />
      </View>

      <FlatList
        data={[{ key: 'main' }]}
        renderItem={() => <>{renderMaterialsSection()}</>}
        keyExtractor={(item) => item.key}
        ListHeaderComponent={renderHeader}
        ListFooterComponent={renderFooter}
        contentContainerStyle={{ padding: 12 }}
        ListEmptyComponent={
          !showMaterialsTable ? (
            <View>
              <Text style={styles.emptyText}>
                Vui lÃ²ng nháº­p váº­t tÆ° Ä‘á»ƒ báº¯t Ä‘áº§u.
              </Text>
            </View>
          ) : null
        }
      />

      {showMaterialsTable && materials.length > 0 && (
        <View style={styles.footer}>
          <View style={styles.summaryContainer}>
            <Text style={styles.summaryLabel}>Tá»•ng cá»™ng:</Text>
            <Text style={styles.summaryValue}>
              {formatCurrency(
                materials.reduce((sum, item) => sum + (item.totalPrice || 0), 0)
              )}
            </Text>
          </View>
          <TouchableOpacity
            style={styles.continueButton}
            onPress={handleNavigateToFinalize}
          >
            <Text style={styles.continueButtonText}>
              Tiáº¿p tá»¥c hoÃ n thiá»‡n bÃ¡o giÃ¡
            </Text>
            <Ionicons name="arrow-forward" size={20} color="#fff" />
          </TouchableOpacity>
        </View>
      )}

      <Modal
        animationType="slide"
        transparent={true}
        visible={isPickerVisible}
        onRequestClose={() => setIsPickerVisible(false)}
      >
        <View style={styles.modalContainer}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>
              Chá»n file Excel tá»« Google Drive
            </Text>
            {isLoadingFiles ? (
              <ActivityIndicator size="large" />
            ) : (
              <FlatList
                data={driveFiles}
                keyExtractor={(item) => item.id}
                renderItem={({ item }) => (
                  <TouchableOpacity
                    style={styles.fileItem}
                    onPress={() => handleFileSelect(item)}
                  >
                    <Ionicons
                      name="document-text-outline"
                      size={24}
                      color="#4F8EF7"
                    />
                    <Text style={styles.fileName}>{item.name}</Text>
                  </TouchableOpacity>
                )}
                ListEmptyComponent={<Text>KhÃ´ng tÃ¬m tháº¥y file nÃ o.</Text>}
              />
            )}
            <TouchableOpacity
              style={styles.closeButton}
              onPress={() => setIsPickerVisible(false)}
            >
              <Text style={styles.closeButtonText}>ÄÃ³ng</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      {/* Bulk Price Modal */}
      <Modal
        transparent={true}
        visible={showBulkPriceModal}
        animationType="slide"
        onRequestClose={() => setShowBulkPriceModal(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Ãp dá»¥ng giÃ¡ cho má»¥c Ä‘Ã£ chá»n</Text>

            <TextInput
              style={styles.bulkPriceInput}
              placeholder="Nháº­p Ä‘Æ¡n giÃ¡ Ã¡p dá»¥ng"
              keyboardType="numeric"
              value={bulkPrice}
              onChangeText={setBulkPrice}
              autoFocus
            />

            <View style={styles.bulkPriceActions}>
              <TouchableOpacity
                style={[styles.bulkPriceActionButton, styles.cancelButton]}
                onPress={() => setShowBulkPriceModal(false)}
              >
                <Text style={styles.cancelButtonText}>Há»§y</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.bulkPriceActionButton, styles.applyButton]}
                onPress={handleApplyBulkPrice}
              >
                <Text style={styles.applyButtonText}>Ãp dá»¥ng</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#f0f2f5' },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  backButton: { padding: 4 },
  headerTitle: { fontSize: 18, fontWeight: 'bold', color: '#333' },
  section: {
    backgroundColor: '#fff',
    padding: 16,
    borderRadius: 8,
    marginBottom: 12,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#333',
    marginBottom: 12,
  },
  emptyText: { textAlign: 'center', color: '#666', marginTop: 20 },
  importButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#0066cc',
    padding: 12,
    borderRadius: 8,
  },
  importButtonDisabled: { backgroundColor: '#a0a0a0' },
  importButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '500',
    marginLeft: 8,
  },
  manualButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#4CAF50',
    padding: 12,
    borderRadius: 8,
    marginTop: 10,
  },
  tableHeader: {
    flexDirection: 'row',
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
    paddingBottom: 8,
    marginBottom: 4,
  },
  headerCell: { fontWeight: 'bold', color: '#333' },
  tableRow: {
    flexDirection: 'row',
    alignItems: 'center',
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
    paddingVertical: 8,
  },
  tableCell: { fontSize: 12, color: '#333' },
  noteCell: {
    flex: 1,
    paddingHorizontal: 10,
    justifyContent: 'center',
  },
  noteText: {
    fontStyle: 'italic',
    color: '#555',
    fontSize: 13,
  },
  materialName: { fontWeight: '500', fontSize: 13 },
  materialType: { fontSize: 11, color: '#666' },
  priceInput: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 4,
    padding: 6,
    textAlign: 'right',
    fontSize: 12,
  },
  totalPrice: { fontWeight: '500', textAlign: 'right', fontSize: 13 },
  footer: {
    backgroundColor: '#fff',
    padding: 16,
    borderTopWidth: 1,
    borderTopColor: '#eee',
    paddingBottom: 30,
  },
  summaryContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  summaryLabel: { fontSize: 16, fontWeight: '500' },
  summaryValue: { fontSize: 18, fontWeight: 'bold', color: '#d9534f' },
  continueButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#4CAF50',
    padding: 14,
    borderRadius: 8,
  },
  continueButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
    marginRight: 8,
  },
  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0,0,0,0.5)',
  },
  modalContent: {
    backgroundColor: 'white',
    padding: 20,
    borderRadius: 10,
    width: '90%',
    maxHeight: '80%',
  },
  modalTitle: { fontSize: 18, fontWeight: 'bold', marginBottom: 15 },
  fileItem: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 10,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  fileName: { marginLeft: 10, fontSize: 16 },
  closeButton: {
    marginTop: 20,
    backgroundColor: '#d9534f',
    padding: 10,
    borderRadius: 5,
    alignItems: 'center',
  },
  closeButtonText: { color: 'white', fontWeight: 'bold' },
  historyContainer: { marginTop: 8 },
  historyItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 12,
    paddingHorizontal: 2,
  },
  historyItemBorder: {
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  historyInfo: {
    flex: 1,
    paddingRight: 12,
  },
  historyNumber: {
    fontSize: 16,
    fontWeight: 'bold',
    marginBottom: 3,
  },
  historyDate: {
    color: '#666',
    fontSize: 12,
    marginBottom: 3,
  },
  historyTotal: {
    color: '#d9534f',
    fontWeight: '600',
    fontSize: 13,
  },
  historyActions: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  historyActionButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 6,
    backgroundColor: '#0066CC',
  },
  historyActionButtonText: {
    color: '#fff',
    marginLeft: 6,
    fontWeight: '500',
    fontSize: 14,
  },
  requoteButton: {
    backgroundColor: '#4CAF50',
  },
  checkbox: {
    width: 30,
    alignItems: 'center',
    justifyContent: 'center',
    paddingRight: 4,
  },

  bulkActionContainer: {
    marginBottom: 16,
  },

  bulkActionRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'flex-start',
    gap: 10,
  },

  bulkActionButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 8,
    paddingHorizontal: 12,
    borderRadius: 6,
    backgroundColor: '#0066CC',
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.2,
    shadowRadius: 1.5,
  },

  unselectButton: {
    backgroundColor: '#6c757d',
  },

  priceButton: {
    backgroundColor: '#28a745',
  },

  bulkActionButtonText: {
    color: '#fff',
    marginLeft: 6,
    fontWeight: '500',
    fontSize: 14,
  },

  disabledButton: {
    backgroundColor: '#ccc',
    opacity: 0.7,
  },

  modalOverlay: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0,0,0,0.5)',
    padding: 20,
  },

  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 15,
    textAlign: 'center',
  },

  bulkPriceInput: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 4,
    padding: 12,
    fontSize: 16,
    marginTop: 10,
    marginBottom: 20,
  },

  bulkPriceActions: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },

  bulkPriceActionButton: {
    paddingVertical: 10,
    paddingHorizontal: 15,
    borderRadius: 4,
    flex: 1,
    marginHorizontal: 5,
    alignItems: 'center',
  },

  cancelButton: {
    backgroundColor: '#f8f9fa',
    borderWidth: 1,
    borderColor: '#ccc',
  },

  cancelButtonText: {
    color: '#333',
  },

  applyButton: {
    backgroundColor: '#28a745',
  },

  applyButtonText: {
    color: '#fff',
    fontWeight: 'bold',
  },
});

export default QuotationScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\StageDetailScreen.js ---

import React, { useState, useLayoutEffect, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TextInput,
  TouchableOpacity,
  ScrollView,
  Alert,
  ActivityIndicator,
  Image,
  Platform,
  Modal,
  Linking,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import * as ImagePicker from 'expo-image-picker';
import { httpsCallable } from 'firebase/functions';
import { functions } from '../config/firebaseConfig';
import { GoogleSignin } from '@react-native-google-signin/google-signin';
import { updateStageDetails } from '../api/projectService';
import uuid from 'react-native-uuid';
import * as FileSystem from 'expo-file-system';

const STATUS_OPTIONS = [
  { value: 'pending', label: 'Chá» xá»­ lÃ½', color: '#9E9E9E' },
  { value: 'in_progress', label: 'Äang lÃ m', color: '#FFD54F' },
  { value: 'completed', label: 'HoÃ n thÃ nh', color: '#4CAF50' },
  { value: 'failed', label: 'KhÃ´ng Ä‘áº¡t', color: '#F44336' },
];

const StageDetailScreen = ({ route, navigation }) => {
  const { projectId, stage } = route.params; // stage object passed in

  const [status, setStatus] = useState(stage.status);
  const [notes, setNotes] = useState(stage.notes || '');

  const computePreview = (f) => {
    if (f.preview) return f.preview;
    if (f.mimeType && f.mimeType.startsWith('image/')) {
      return `https://drive.google.com/uc?export=download&id=${f.id}`;
    }
    return undefined;
  };

  const initialFiles = (stage.files || []).map((f) => ({
    ...f,
    preview: computePreview(f),
  }));

  const [files, setFiles] = useState(initialFiles);
  const [imagePreviewUri, setImagePreviewUri] = useState(null);
  const [saving, setSaving] = useState(false);

  useLayoutEffect(() => {
    navigation.setOptions({ headerTitle: stage.processName });
  }, [navigation]);

  const pickFile = async () => {
    const { status: perm } =
      await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (perm !== 'granted') {
      Alert.alert('Lá»—i', 'Cáº§n quyá»n truy cáº­p thÆ° viá»‡n áº£nh.');
      return;
    }
    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.All,
      quality: 0.7,
    });
    if (!result.canceled) {
      uploadPickedFile(result.assets[0]);
    }
  };

  const takePhoto = async () => {
    const { status: perm } = await ImagePicker.requestCameraPermissionsAsync();
    if (perm !== 'granted') {
      Alert.alert('Lá»—i', 'Cáº§n quyá»n truy cáº­p camera.');
      return;
    }
    const result = await ImagePicker.launchCameraAsync({ quality: 0.7 });
    if (!result.canceled) {
      uploadPickedFile(result.assets[0]);
    }
  };

  const uploadPickedFile = async (asset) => {
    try {
      setSaving(true);

      if (!asset || !asset.uri) {
        Alert.alert('Lá»—i', 'Táº­p tin khÃ´ng há»£p lá»‡.');
        return;
      }

      const ext = (asset.fileName || asset.uri).split('.').pop();
      const filename = `${uuid.v4()}.${ext}`;

      console.log('Starting upload for:', asset.uri);

      try {
        // Get file info using FileSystem from expo
        const fileInfo = await FileSystem.getInfoAsync(asset.uri);
        console.log('File info:', fileInfo);

        if (!fileInfo.exists || fileInfo.size === 0) {
          throw new Error('File rá»—ng hoáº·c khÃ´ng tá»“n táº¡i');
        }

        console.log('File size:', fileInfo.size, 'bytes');

        // Äá»c file base64 báº±ng expo-file-system
        const base64Data = await FileSystem.readAsStringAsync(asset.uri, {
          encoding: FileSystem.EncodingType.Base64,
        });
        // Láº¥y accessToken Google cá»§a ngÆ°á»i dÃ¹ng
        const tokens = await GoogleSignin.getTokens();
        const accessToken = tokens.accessToken;

        if (!accessToken) {
          throw new Error(
            'PhiÃªn Ä‘Äƒng nháº­p Google Ä‘Ã£ háº¿t. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.'
          );
        }

        // Gá»i Cloud Function uploadFileToDriveUser
        const uploadFn = httpsCallable(functions, 'uploadFileToDriveUser');
        const result = await uploadFn({
          accessToken,
          projectId,
          fileName: filename,
          mimeType: asset.mimeType || asset.type || 'image/jpeg',
          base64Data,
        });

        const {
          fileId,
          webViewLink,
          thumbnailLink,
          mimeType: returnedMime,
        } = result.data;
        const preview =
          returnedMime && returnedMime.startsWith('image/')
            ? thumbnailLink ||
              `https://drive.google.com/uc?export=download&id=${fileId}`
            : webViewLink;
        setFiles((prev) => [
          ...prev,
          { name: filename, id: fileId, url: webViewLink, preview },
        ]);
      } catch (uploadError) {
        console.error('Upload error:', uploadError);
        throw new Error(`Lá»—i khi táº£i lÃªn: ${uploadError.message}`);
      }
    } catch (err) {
      console.error('Error uploading file:', err);
      Alert.alert(
        'Lá»—i',
        `KhÃ´ng thá»ƒ táº£i tá»‡p: ${err.message || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh'}`
      );
    } finally {
      setSaving(false);
    }
  };

  const removeFile = (file) => {
    Alert.alert('XÃ¡c nháº­n', 'XÃ³a tá»‡p Ä‘Ã­nh kÃ¨m nÃ y?', [
      { text: 'Há»§y', style: 'cancel' },
      {
        text: 'XÃ³a',
        style: 'destructive',
        onPress: async () => {
          try {
            // Cáº­p nháº­t Ä‘Æ°á»ng dáº«n Ä‘á»ƒ khá»›p vá»›i khi táº£i lÃªn
            const delFn = httpsCallable(functions, 'deleteFileFromDrive');
            await delFn({ fileId: file.id });
          } catch (e) {
            console.log('Cannot delete from storage, maybe already removed');
          }
          setFiles((prev) => prev.filter((f) => f.name !== file.name));
        },
      },
    ]);
  };

  const viewFile = (file) => {
    if (file.preview && file.preview.startsWith('http')) {
      setImagePreviewUri(file.preview);
    } else if (file.url) {
      Linking.openURL(file.url).catch(() =>
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ má»Ÿ tá»‡p.')
      );
    }
  };

  const handleSave = async () => {
    try {
      setSaving(true);
      // Chá»‰ lÆ°u cÃ¡c trÆ°á»ng cáº§n thiáº¿t Ä‘á»ƒ Firestore gá»n nháº¹
      const filesToSave = files.map(({ name, id, url, mimeType }) => {
        const obj = { name, id, url };
        if (mimeType) obj.mimeType = mimeType;
        return obj;
      });

      await updateStageDetails(projectId, stage.stageId, {
        status,
        notes,
        files: filesToSave,
      });
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ lÆ°u thay Ä‘á»•i', [
        { text: 'OK', onPress: () => navigation.goBack() },
      ]);
    } catch (err) {
      console.error(err);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ lÆ°u.');
    } finally {
      setSaving(false);
    }
  };

  return (
    <ScrollView
      style={styles.container}
      contentContainerStyle={{ padding: 16 }}
    >
      <Text style={styles.label}>Tráº¡ng thÃ¡i</Text>
      <View style={styles.statusRow}>
        {STATUS_OPTIONS.map((opt) => (
          <TouchableOpacity
            key={opt.value}
            style={[
              styles.statusBtn,
              status === opt.value && { backgroundColor: opt.color },
            ]}
            onPress={() => setStatus(opt.value)}
          >
            <Text
              style={[
                styles.statusBtnText,
                status === opt.value && { color: '#fff' },
              ]}
            >
              {opt.label}
            </Text>
          </TouchableOpacity>
        ))}
      </View>

      <Text style={styles.label}>Ghi chÃº / MÃ´ táº£ káº¿t quáº£</Text>
      <TextInput
        style={styles.textArea}
        multiline
        value={notes}
        onChangeText={setNotes}
        placeholder="Nháº­p ghi chÃº ..."
      />

      <Text style={styles.label}>Tá»‡p Ä‘Ã­nh kÃ¨m</Text>
      {files.map((f) => (
        <View key={f.name} style={styles.fileRow}>
          <TouchableOpacity
            style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}
            onPress={() => viewFile(f)}
          >
            {f.preview && f.preview.startsWith('http') ? (
              <Image source={{ uri: f.preview }} style={styles.thumb} />
            ) : (
              <Ionicons name="document-outline" size={24} color="#666" />
            )}
            <Text style={styles.fileName}>{f.name}</Text>
          </TouchableOpacity>
          <TouchableOpacity
            onPress={() => removeFile(f)}
            style={{ padding: 4 }}
          >
            <Ionicons name="trash-outline" size={20} color="#d11a2a" />
          </TouchableOpacity>
        </View>
      ))}

      <View style={styles.attachActions}>
        <TouchableOpacity style={styles.attachBtn} onPress={pickFile}>
          <Ionicons name="images-outline" size={20} color="#fff" />
          <Text style={styles.attachBtnText}>Chá»n tá»« thÆ° viá»‡n</Text>
        </TouchableOpacity>
        <TouchableOpacity style={styles.attachBtn} onPress={takePhoto}>
          <Ionicons name="camera-outline" size={20} color="#fff" />
          <Text style={styles.attachBtnText}>Chá»¥p áº£nh</Text>
        </TouchableOpacity>
      </View>

      <TouchableOpacity
        style={styles.saveBtn}
        onPress={handleSave}
        disabled={saving}
      >
        {saving ? (
          <ActivityIndicator color="#fff" />
        ) : (
          <Text style={styles.saveBtnText}>LÆ°u</Text>
        )}
      </TouchableOpacity>

      {/* Image preview modal */}
      <Modal
        visible={!!imagePreviewUri}
        transparent={true}
        animationType="fade"
      >
        <View style={styles.modalBackdrop}>
          <TouchableOpacity
            style={styles.modalCloseArea}
            onPress={() => setImagePreviewUri(null)}
          />
          <Image
            source={{ uri: imagePreviewUri }}
            style={styles.modalImage}
            resizeMode="contain"
          />
          <TouchableOpacity
            style={styles.modalCloseBtn}
            onPress={() => setImagePreviewUri(null)}
          >
            <Ionicons name="close-circle" size={36} color="#fff" />
          </TouchableOpacity>
        </View>
      </Modal>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#fff' },
  label: { fontWeight: '600', marginBottom: 6, fontSize: 14, color: '#333' },
  statusRow: { flexDirection: 'row', flexWrap: 'wrap', marginBottom: 16 },
  statusBtn: {
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 8,
    backgroundColor: '#f1f1f1',
    marginRight: 8,
    marginBottom: 8,
  },
  statusBtnText: { color: '#333', fontSize: 14 },
  textArea: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 12,
    minHeight: 100,
    textAlignVertical: 'top',
    marginBottom: 16,
  },
  fileRow: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 8,
  },
  thumb: { width: 40, height: 40, borderRadius: 4, marginRight: 8 },
  fileName: { flex: 1, color: '#333' },
  attachActions: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginVertical: 16,
  },
  attachBtn: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#0066cc',
    paddingVertical: 10,
    paddingHorizontal: 12,
    borderRadius: 8,
    flex: 1,
    marginHorizontal: 4,
  },
  attachBtnText: { color: '#fff', marginLeft: 6, fontWeight: '500' },
  saveBtn: {
    backgroundColor: '#4CAF50',
    paddingVertical: 14,
    borderRadius: 8,
    alignItems: 'center',
  },
  saveBtnText: { color: '#fff', fontSize: 16, fontWeight: '600' },
  modalBackdrop: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.9)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalImage: {
    width: '90%',
    height: '80%',
  },
  modalCloseBtn: {
    position: 'absolute',
    top: 40,
    right: 20,
  },
  modalCloseArea: {
    ...StyleSheet.absoluteFillObject,
  },
});

export default StageDetailScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\SupplierDetailScreen.js ---

// src/screens/SupplierDetailScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  Alert,
  SafeAreaView,
  Linking,
  Share,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import {
  getSupplierById,
  deleteSupplier,
  addSupplierRating,
} from '../api/supplierService';
import { useAuth } from '../contexts/AuthContext';

const SupplierDetailScreen = ({ route, navigation }) => {
  const { supplierId } = route.params;
  const { currentUser } = useAuth();
  const [supplier, setSupplier] = useState(null);
  const [loading, setLoading] = useState(true);
  const [showRatingModal, setShowRatingModal] = useState(false);

  useEffect(() => {
    const loadSupplierData = async () => {
      try {
        const data = await getSupplierById(supplierId);
        setSupplier(data);
      } catch (error) {
        console.error('Lá»—i khi táº£i thÃ´ng tin nhÃ  cung cáº¥p:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i thÃ´ng tin nhÃ  cung cáº¥p');
        navigation.goBack();
      } finally {
        setLoading(false);
      }
    };

    loadSupplierData();
  }, [supplierId, navigation]);

  const handleCall = () => {
    if (!supplier?.phone) return;

    Linking.openURL(`tel:${supplier.phone}`);
  };

  const handleEmail = () => {
    if (!supplier?.email) return;

    Linking.openURL(`mailto:${supplier.email}`);
  };

  const handleShare = async () => {
    if (!supplier) return;

    try {
      const message = `
ThÃ´ng tin nhÃ  cung cáº¥p:
TÃªn: ${supplier.name}
LiÃªn há»‡: ${supplier.contactName || 'N/A'}
SÄT: ${supplier.phone || 'N/A'}
Email: ${supplier.email || 'N/A'}
Äá»‹a chá»‰: ${supplier.address || 'N/A'}
      `;

      await Share.share({
        message,
        title: `ThÃ´ng tin nhÃ  cung cáº¥p: ${supplier.name}`,
      });
    } catch (error) {
      console.error('Lá»—i khi chia sáº»:', error);
    }
  };

  const handleEdit = () => {
    navigation.navigate('EditSupplier', { supplierId, supplier });
  };

  const handleDelete = () => {
    Alert.alert(
      'XÃ¡c nháº­n xÃ³a',
      `Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a nhÃ  cung cáº¥p "${supplier?.name}" khÃ´ng?`,
      [
        { text: 'Há»§y', style: 'cancel' },
        {
          text: 'XÃ³a',
          style: 'destructive',
          onPress: async () => {
            try {
              await deleteSupplier(supplierId);
              Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ xÃ³a nhÃ  cung cáº¥p');
              navigation.goBack();
            } catch (error) {
              console.error('Lá»—i khi xÃ³a nhÃ  cung cáº¥p:', error);
              Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ xÃ³a nhÃ  cung cáº¥p');
            }
          },
        },
      ]
    );
  };

  if (loading) {
    return (
      <SafeAreaView style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#0066cc" />
        <Text style={styles.loadingText}>Äang táº£i dá»¯ liá»‡u...</Text>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Ionicons name="arrow-back" size={24} color="#333" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Chi tiáº¿t nhÃ  cung cáº¥p</Text>
        <TouchableOpacity onPress={handleShare}>
          <Ionicons name="share-outline" size={24} color="#333" />
        </TouchableOpacity>
      </View>

      <ScrollView style={styles.content}>
        <View style={styles.supplierHeader}>
          <View style={styles.supplierNameContainer}>
            <Text style={styles.supplierName}>{supplier?.name}</Text>
            {supplier?.verified && (
              <View style={styles.verifiedBadge}>
                <Ionicons name="checkmark-circle" size={16} color="#fff" />
                <Text style={styles.verifiedText}>ÄÃ£ xÃ¡c minh</Text>
              </View>
            )}
          </View>

          {supplier?.categories && supplier.categories.length > 0 && (
            <View style={styles.categoriesContainer}>
              {supplier.categories.map((category, index) => (
                <View key={index} style={styles.categoryTag}>
                  <Text style={styles.categoryText}>{category}</Text>
                </View>
              ))}
            </View>
          )}
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>ThÃ´ng tin liÃªn há»‡</Text>

          {supplier?.contactName && (
            <View style={styles.infoRow}>
              <Ionicons name="person-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>NgÆ°á»i liÃªn há»‡:</Text>
              <Text style={styles.infoText}>{supplier.contactName}</Text>
            </View>
          )}

          {supplier?.phone && (
            <TouchableOpacity style={styles.infoRow} onPress={handleCall}>
              <Ionicons name="call-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>Sá»‘ Ä‘iá»‡n thoáº¡i:</Text>
              <Text style={[styles.infoText, styles.linkText]}>
                {supplier.phone}
              </Text>
            </TouchableOpacity>
          )}

          {supplier?.email && (
            <TouchableOpacity style={styles.infoRow} onPress={handleEmail}>
              <Ionicons name="mail-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>Email:</Text>
              <Text style={[styles.infoText, styles.linkText]}>
                {supplier.email}
              </Text>
            </TouchableOpacity>
          )}

          {supplier?.address && (
            <View style={styles.infoRow}>
              <Ionicons name="location-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>Äá»‹a chá»‰:</Text>
              <Text style={styles.infoText}>{supplier.address}</Text>
            </View>
          )}
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>ThÃ´ng tin thanh toÃ¡n</Text>

          {supplier?.taxCode ? (
            <View style={styles.infoRow}>
              <Ionicons name="document-text-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>MÃ£ sá»‘ thuáº¿:</Text>
              <Text style={styles.infoText}>{supplier.taxCode}</Text>
            </View>
          ) : (
            <Text style={styles.emptyText}>ChÆ°a cÃ³ thÃ´ng tin mÃ£ sá»‘ thuáº¿</Text>
          )}

          {supplier?.bankAccount && (
            <View style={styles.infoRow}>
              <Ionicons name="card-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>TÃ i khoáº£n:</Text>
              <Text style={styles.infoText}>{supplier.bankAccount}</Text>
            </View>
          )}

          {supplier?.bankName && (
            <View style={styles.infoRow}>
              <Ionicons name="business-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>NgÃ¢n hÃ ng:</Text>
              <Text style={styles.infoText}>{supplier.bankName}</Text>
            </View>
          )}
        </View>

        {supplier?.description && (
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>MÃ´ táº£</Text>
            <Text style={styles.descriptionText}>{supplier.description}</Text>
          </View>
        )}

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>ÄÃ¡nh giÃ¡</Text>
          <View style={styles.ratingContainer}>
            <View style={styles.ratingStars}>
              {supplier?.averageRating ? (
                <>
                  <Text style={styles.ratingValue}>
                    {supplier.averageRating.toFixed(1)}
                  </Text>
                  <View style={styles.starsContainer}>
                    {[1, 2, 3, 4, 5].map((star) => (
                      <Ionicons
                        key={star}
                        name={
                          star <= Math.round(supplier.averageRating)
                            ? 'star'
                            : 'star-outline'
                        }
                        size={16}
                        color="#FFD700"
                      />
                    ))}
                  </View>
                  <Text style={styles.ratingCount}>
                    ({supplier.ratings?.length || 0} Ä‘Ã¡nh giÃ¡)
                  </Text>
                </>
              ) : (
                <Text style={styles.emptyText}>ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡ nÃ o</Text>
              )}
            </View>
          </View>
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>ThÃ´ng tin khÃ¡c</Text>

          <View style={styles.infoRow}>
            <Ionicons name="time-outline" size={20} color="#666" />
            <Text style={styles.infoLabel}>NgÃ y táº¡o:</Text>
            <Text style={styles.infoText}>
              {supplier?.createdAt
                ? new Date(
                    supplier.createdAt.seconds * 1000
                  ).toLocaleDateString('vi-VN')
                : 'N/A'}
            </Text>
          </View>

          {supplier?.updatedAt && (
            <View style={styles.infoRow}>
              <Ionicons name="refresh-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>Cáº­p nháº­t:</Text>
              <Text style={styles.infoText}>
                {new Date(supplier.updatedAt.seconds * 1000).toLocaleDateString(
                  'vi-VN'
                )}
              </Text>
            </View>
          )}

          {supplier?.createdByName && (
            <View style={styles.infoRow}>
              <Ionicons name="person-add-outline" size={20} color="#666" />
              <Text style={styles.infoLabel}>NgÆ°á»i táº¡o:</Text>
              <Text style={styles.infoText}>{supplier.createdByName}</Text>
            </View>
          )}
        </View>

        <View style={styles.actionButtons}>
          <TouchableOpacity
            style={[styles.actionButton, styles.editButton]}
            onPress={handleEdit}
          >
            <Ionicons name="create-outline" size={20} color="#fff" />
            <Text style={styles.actionButtonText}>Chá»‰nh sá»­a</Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={[styles.actionButton, styles.deleteButton]}
            onPress={handleDelete}
          >
            <Ionicons name="trash-outline" size={20} color="#fff" />
            <Text style={styles.actionButtonText}>XÃ³a</Text>
          </TouchableOpacity>
        </View>
      </ScrollView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#f5f5f5',
  },
  loadingText: {
    marginTop: 12,
    color: '#666',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: '#fff',
    paddingVertical: 16,
    paddingHorizontal: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  backButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  content: {
    flex: 1,
    padding: 16,
  },
  supplierHeader: {
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
  },
  supplierNameContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    marginBottom: 12,
  },
  supplierName: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#333',
    flex: 1,
  },
  verifiedBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#4caf50',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  verifiedText: {
    color: '#fff',
    fontSize: 12,
    marginLeft: 4,
  },
  categoriesContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
  },
  categoryTag: {
    backgroundColor: '#f0f0f0',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
    marginRight: 8,
    marginBottom: 8,
  },
  categoryText: {
    color: '#666',
    fontSize: 12,
  },
  section: {
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
    paddingBottom: 8,
  },
  infoRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 12,
  },
  infoLabel: {
    width: 100,
    color: '#666',
    fontSize: 14,
    marginLeft: 8,
  },
  infoText: {
    flex: 1,
    color: '#333',
    fontSize: 14,
  },
  linkText: {
    color: '#0066cc',
  },
  descriptionText: {
    color: '#333',
    fontSize: 14,
    lineHeight: 20,
  },
  emptyText: {
    color: '#999',
    fontStyle: 'italic',
    textAlign: 'center',
    marginVertical: 8,
  },
  ratingContainer: {
    alignItems: 'center',
  },
  ratingStars: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  ratingValue: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
    marginRight: 8,
  },
  starsContainer: {
    flexDirection: 'row',
    marginRight: 8,
  },
  ratingCount: {
    color: '#666',
    fontSize: 12,
  },
  actionButtons: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 30,
  },
  actionButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 12,
    borderRadius: 8,
    flex: 1,
    marginHorizontal: 4,
  },
  editButton: {
    backgroundColor: '#0066cc',
  },
  deleteButton: {
    backgroundColor: '#ff3b30',
  },
  actionButtonText: {
    color: '#fff',
    fontWeight: '600',
    marginLeft: 8,
  },
});

export default SupplierDetailScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\SupplierManagementScreen.js ---

// src/screens/SupplierManagementScreen.js
import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  TouchableOpacity,
  TextInput,
  Alert,
  ActivityIndicator,
  SafeAreaView,
  Modal,
  ScrollView,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useFocusEffect } from '@react-navigation/native';
import {
  getAllSuppliers,
  deleteSupplier,
  searchSuppliers,
} from '../api/supplierService';
import { useAuth } from '../contexts/AuthContext';

const SupplierManagementScreen = ({ navigation }) => {
  const { currentUser } = useAuth();
  const [suppliers, setSuppliers] = useState([]);
  const [filteredSuppliers, setFilteredSuppliers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [refreshing, setRefreshing] = useState(false);
  const [showFilterModal, setShowFilterModal] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [categories, setCategories] = useState([]);

  // Láº¥y danh sÃ¡ch nhÃ  cung cáº¥p
  const loadSuppliers = useCallback(async () => {
    try {
      setLoading(true);
      const data = await getAllSuppliers();
      setSuppliers(data);
      setFilteredSuppliers(data);

      // TrÃ­ch xuáº¥t danh sÃ¡ch cÃ¡c danh má»¥c tá»« nhÃ  cung cáº¥p
      const allCategories = new Set();
      data.forEach((supplier) => {
        if (supplier.categories && Array.isArray(supplier.categories)) {
          supplier.categories.forEach((category) =>
            allCategories.add(category)
          );
        }
      });
      setCategories(Array.from(allCategories));
    } catch (error) {
      console.error('Lá»—i khi táº£i danh sÃ¡ch nhÃ  cung cáº¥p:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i danh sÃ¡ch nhÃ  cung cáº¥p');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  }, []);

  // Táº£i láº¡i danh sÃ¡ch khi mÃ n hÃ¬nh Ä‘Æ°á»£c focus
  useFocusEffect(
    useCallback(() => {
      loadSuppliers();
    }, [loadSuppliers])
  );

  // Xá»­ lÃ½ tÃ¬m kiáº¿m
  const handleSearch = async (text) => {
    setSearchQuery(text);

    if (!text.trim()) {
      setFilteredSuppliers(suppliers);
      return;
    }

    try {
      const results = await searchSuppliers(text);
      setFilteredSuppliers(results);
    } catch (error) {
      console.error('Lá»—i khi tÃ¬m kiáº¿m:', error);
    }
  };

  // Xá»­ lÃ½ refresh
  const handleRefresh = () => {
    setRefreshing(true);
    loadSuppliers();
  };

  // Xá»­ lÃ½ xÃ³a nhÃ  cung cáº¥p
  const handleDeleteSupplier = (supplier) => {
    Alert.alert(
      'XÃ¡c nháº­n xÃ³a',
      `Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a nhÃ  cung cáº¥p "${supplier.name}" khÃ´ng?`,
      [
        { text: 'Há»§y', style: 'cancel' },
        {
          text: 'XÃ³a',
          style: 'destructive',
          onPress: async () => {
            try {
              await deleteSupplier(supplier.id);
              Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ xÃ³a nhÃ  cung cáº¥p');
              loadSuppliers();
            } catch (error) {
              console.error('Lá»—i khi xÃ³a nhÃ  cung cáº¥p:', error);
              Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ xÃ³a nhÃ  cung cáº¥p');
            }
          },
        },
      ]
    );
  };

  // Xá»­ lÃ½ lá»c theo danh má»¥c
  const handleFilterByCategory = (category) => {
    setSelectedCategory(category);
    setShowFilterModal(false);

    if (!category) {
      setFilteredSuppliers(suppliers);
      return;
    }

    const filtered = suppliers.filter(
      (supplier) =>
        supplier.categories &&
        Array.isArray(supplier.categories) &&
        supplier.categories.includes(category)
    );

    setFilteredSuppliers(filtered);
  };

  // Hiá»ƒn thá»‹ item nhÃ  cung cáº¥p
  const renderSupplierItem = ({ item }) => (
    <TouchableOpacity
      style={styles.supplierCard}
      onPress={() =>
        navigation.navigate('SupplierDetail', { supplierId: item.id })
      }
    >
      <View style={styles.supplierHeader}>
        <Text style={styles.supplierName}>{item.name}</Text>
        {item.verified && (
          <View style={styles.verifiedBadge}>
            <Ionicons name="checkmark-circle" size={16} color="#fff" />
            <Text style={styles.verifiedText}>ÄÃ£ xÃ¡c minh</Text>
          </View>
        )}
      </View>

      <View style={styles.supplierInfo}>
        {item.contactName && (
          <View style={styles.infoRow}>
            <Ionicons name="person-outline" size={16} color="#666" />
            <Text style={styles.infoText}>{item.contactName}</Text>
          </View>
        )}

        {item.phone && (
          <View style={styles.infoRow}>
            <Ionicons name="call-outline" size={16} color="#666" />
            <Text style={styles.infoText}>{item.phone}</Text>
          </View>
        )}

        {item.email && (
          <View style={styles.infoRow}>
            <Ionicons name="mail-outline" size={16} color="#666" />
            <Text style={styles.infoText}>{item.email}</Text>
          </View>
        )}

        {item.address && (
          <View style={styles.infoRow}>
            <Ionicons name="location-outline" size={16} color="#666" />
            <Text style={styles.infoText} numberOfLines={1}>
              {item.address}
            </Text>
          </View>
        )}
      </View>

      {item.categories && item.categories.length > 0 && (
        <View style={styles.categoriesContainer}>
          {item.categories.map((category, index) => (
            <View key={index} style={styles.categoryTag}>
              <Text style={styles.categoryText}>{category}</Text>
            </View>
          ))}
        </View>
      )}

      <View style={styles.supplierActions}>
        <TouchableOpacity
          style={styles.actionButton}
          onPress={() =>
            navigation.navigate('EditSupplier', { supplier: item })
          }
        >
          <Ionicons name="create-outline" size={18} color="#0066cc" />
          <Text style={[styles.actionText, { color: '#0066cc' }]}>Sá»­a</Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={styles.actionButton}
          onPress={() => handleDeleteSupplier(item)}
        >
          <Ionicons name="trash-outline" size={18} color="#ff3b30" />
          <Text style={[styles.actionText, { color: '#ff3b30' }]}>XÃ³a</Text>
        </TouchableOpacity>
      </View>
    </TouchableOpacity>
  );

  // Hiá»ƒn thá»‹ modal lá»c
  const renderFilterModal = () => (
    <Modal
      visible={showFilterModal}
      transparent
      animationType="slide"
      onRequestClose={() => setShowFilterModal(false)}
    >
      <View style={styles.modalOverlay}>
        <View style={styles.modalContainer}>
          <View style={styles.modalHeader}>
            <Text style={styles.modalTitle}>Lá»c theo danh má»¥c</Text>
            <TouchableOpacity onPress={() => setShowFilterModal(false)}>
              <Ionicons name="close" size={24} color="#666" />
            </TouchableOpacity>
          </View>

          <ScrollView style={styles.modalContent}>
            <TouchableOpacity
              style={[
                styles.categoryItem,
                !selectedCategory && styles.selectedCategoryItem,
              ]}
              onPress={() => handleFilterByCategory(null)}
            >
              <Text
                style={[
                  styles.categoryItemText,
                  !selectedCategory && styles.selectedCategoryText,
                ]}
              >
                Táº¥t cáº£ danh má»¥c
              </Text>
              {!selectedCategory && (
                <Ionicons name="checkmark" size={18} color="#0066cc" />
              )}
            </TouchableOpacity>

            {categories.map((category, index) => (
              <TouchableOpacity
                key={index}
                style={[
                  styles.categoryItem,
                  selectedCategory === category && styles.selectedCategoryItem,
                ]}
                onPress={() => handleFilterByCategory(category)}
              >
                <Text
                  style={[
                    styles.categoryItemText,
                    selectedCategory === category &&
                      styles.selectedCategoryText,
                  ]}
                >
                  {category}
                </Text>
                {selectedCategory === category && (
                  <Ionicons name="checkmark" size={18} color="#0066cc" />
                )}
              </TouchableOpacity>
            ))}
          </ScrollView>
        </View>
      </View>
    </Modal>
  );

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <Text style={styles.headerTitle}>Quáº£n lÃ½ nhÃ  cung cáº¥p</Text>
      </View>

      <View style={styles.searchContainer}>
        <View style={styles.searchBar}>
          <Ionicons
            name="search"
            size={20}
            color="#999"
            style={styles.searchIcon}
          />
          <TextInput
            style={styles.searchInput}
            placeholder="TÃ¬m kiáº¿m nhÃ  cung cáº¥p..."
            value={searchQuery}
            onChangeText={handleSearch}
          />
          {searchQuery ? (
            <TouchableOpacity onPress={() => handleSearch('')}>
              <Ionicons name="close-circle" size={20} color="#999" />
            </TouchableOpacity>
          ) : null}
        </View>

        <TouchableOpacity
          style={styles.filterButton}
          onPress={() => setShowFilterModal(true)}
        >
          <Ionicons name="filter" size={20} color="#fff" />
        </TouchableOpacity>
      </View>

      {selectedCategory && (
        <View style={styles.activeFilterContainer}>
          <Text style={styles.activeFilterText}>
            Äang lá»c: {selectedCategory}
          </Text>
          <TouchableOpacity onPress={() => handleFilterByCategory(null)}>
            <Ionicons name="close-circle" size={18} color="#666" />
          </TouchableOpacity>
        </View>
      )}

      {loading ? (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#0066cc" />
          <Text style={styles.loadingText}>Äang táº£i dá»¯ liá»‡u...</Text>
        </View>
      ) : (
        <FlatList
          data={filteredSuppliers}
          renderItem={renderSupplierItem}
          keyExtractor={(item) => item.id}
          contentContainerStyle={styles.listContainer}
          refreshing={refreshing}
          onRefresh={handleRefresh}
          ListEmptyComponent={
            <View style={styles.emptyContainer}>
              <Ionicons name="business-outline" size={48} color="#ccc" />
              <Text style={styles.emptyText}>
                {searchQuery
                  ? 'KhÃ´ng tÃ¬m tháº¥y nhÃ  cung cáº¥p nÃ o phÃ¹ há»£p'
                  : 'ChÆ°a cÃ³ nhÃ  cung cáº¥p nÃ o'}
              </Text>
            </View>
          }
        />
      )}

      <TouchableOpacity
        style={styles.addButton}
        onPress={() => navigation.navigate('AddSupplier')}
      >
        <Ionicons name="add" size={24} color="#fff" />
      </TouchableOpacity>

      {renderFilterModal()}
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  header: {
    backgroundColor: '#fff',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  searchContainer: {
    flexDirection: 'row',
    padding: 12,
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  searchBar: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f0f0f0',
    borderRadius: 8,
    paddingHorizontal: 12,
    marginRight: 8,
  },
  searchIcon: {
    marginRight: 8,
  },
  searchInput: {
    flex: 1,
    height: 40,
    fontSize: 16,
  },
  filterButton: {
    backgroundColor: '#0066cc',
    width: 40,
    height: 40,
    borderRadius: 8,
    justifyContent: 'center',
    alignItems: 'center',
  },
  activeFilterContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#e6f2ff',
    padding: 8,
    marginHorizontal: 12,
    marginTop: 8,
    borderRadius: 4,
    justifyContent: 'space-between',
  },
  activeFilterText: {
    color: '#0066cc',
    fontSize: 14,
  },
  listContainer: {
    padding: 12,
  },
  supplierCard: {
    backgroundColor: '#fff',
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
  },
  supplierHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  supplierName: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
    flex: 1,
  },
  verifiedBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#4caf50',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  verifiedText: {
    color: '#fff',
    fontSize: 12,
    marginLeft: 4,
  },
  supplierInfo: {
    marginBottom: 12,
  },
  infoRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 6,
  },
  infoText: {
    marginLeft: 8,
    color: '#666',
    fontSize: 14,
  },
  categoriesContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    marginBottom: 12,
  },
  categoryTag: {
    backgroundColor: '#f0f0f0',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
    marginRight: 8,
    marginBottom: 8,
  },
  categoryText: {
    color: '#666',
    fontSize: 12,
  },
  supplierActions: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    borderTopWidth: 1,
    borderTopColor: '#f0f0f0',
    paddingTop: 12,
  },
  actionButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 12,
    paddingVertical: 6,
    marginLeft: 8,
  },
  actionText: {
    marginLeft: 4,
    fontSize: 14,
    fontWeight: '500',
  },
  addButton: {
    position: 'absolute',
    right: 20,
    bottom: 20,
    width: 56,
    height: 56,
    borderRadius: 28,
    backgroundColor: '#0066cc',
    justifyContent: 'center',
    alignItems: 'center',
    elevation: 4,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.2,
    shadowRadius: 4,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 12,
    color: '#666',
  },
  emptyContainer: {
    alignItems: 'center',
    justifyContent: 'center',
    padding: 40,
  },
  emptyText: {
    marginTop: 12,
    color: '#666',
    textAlign: 'center',
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContainer: {
    width: '80%',
    backgroundColor: '#fff',
    borderRadius: 8,
    overflow: 'hidden',
    maxHeight: '70%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  modalTitle: {
    fontSize: 16,
    fontWeight: 'bold',
  },
  modalContent: {
    padding: 16,
    maxHeight: 300,
  },
  categoryItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  selectedCategoryItem: {
    backgroundColor: '#e6f2ff',
  },
  categoryItemText: {
    fontSize: 14,
    color: '#333',
  },
  selectedCategoryText: {
    color: '#0066cc',
    fontWeight: '500',
  },
});

export default SupplierManagementScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\TaskDetailScreen.js ---

import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  SafeAreaView,
  ActivityIndicator,
  Alert,
  ScrollView,
  Linking,
  Share,
} from 'react-native';
import { useRoute, useNavigation } from '@react-navigation/native';
import { doc, getDoc } from 'firebase/firestore';
import { db } from '../config/firebaseConfig';
import { useTheme } from '../contexts/ThemeContext';
import { updateTaskStatus } from '../api/projectService'; // We will create this function
import { Ionicons } from '@expo/vector-icons';
import {
  getTaskDisplayLabel,
  getStatusDisplayLabel,
  getStatusColor,
} from '../utils/taskHelpers';

const TaskDetailScreen = () => {
  const route = useRoute();
  const navigation = useNavigation();
  const { theme } = useTheme();
  const { projectId, taskKey } = route.params;

  const [project, setProject] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isUpdating, setIsUpdating] = useState(false);
  const [shareSuccess, setShareSuccess] = useState(false);

  useEffect(() => {
    const fetchProjectDetails = async () => {
      try {
        setLoading(true);
        const projectRef = doc(db, 'projects', projectId);
        const projectSnap = await getDoc(projectRef);

        if (projectSnap.exists()) {
          setProject({ id: projectSnap.id, ...projectSnap.data() });
        } else {
          setError('KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin dá»± Ã¡n.');
        }
      } catch (err) {
        console.error('Error fetching project details for task:', err);
        setError('Lá»—i khi táº£i dá»¯ liá»‡u dá»± Ã¡n.');
      } finally {
        setLoading(false);
      }
    };
    fetchProjectDetails();
  }, [projectId]);

  const handleCompleteTask = async () => {
    setIsUpdating(true);
    try {
      await updateTaskStatus(projectId, taskKey, 'completed');
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i cÃ´ng viá»‡c.', [
        { text: 'OK', onPress: () => navigation.goBack() },
      ]);
    } catch (err) {
      console.error('Error updating task status:', err);
      Alert.alert(
        'Lá»—i',
        err.message || 'KhÃ´ng thá»ƒ cáº­p nháº­t tráº¡ng thÃ¡i cÃ´ng viá»‡c.'
      );
    } finally {
      setIsUpdating(false);
    }
  };

  const handleOpenDriveFolder = () => {
    if (project?.driveFolderUrl) {
      Linking.openURL(project.driveFolderUrl);
    } else {
      Alert.alert('ThÃ´ng bÃ¡o', 'KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c Drive cho dá»± Ã¡n nÃ y.');
    }
  };

  const handleShareDriveLink = async () => {
    if (project?.driveFolderUrl) {
      try {
        await Share.share({
          message: project.driveFolderUrl,
        });
        setShareSuccess(true);

        // Reset success message after 2 seconds
        setTimeout(() => {
          setShareSuccess(false);
        }, 2000);
      } catch (error) {
        console.error('Error sharing link:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ chia sáº» Ä‘Æ°á»ng dáº«n.');
      }
    } else {
      Alert.alert('ThÃ´ng bÃ¡o', 'KhÃ´ng cÃ³ Ä‘Æ°á»ng dáº«n Drive Ä‘á»ƒ chia sáº».');
    }
  };

  if (loading) {
    return (
      <View
        style={[styles.centerContainer, { backgroundColor: theme.background }]}
      >
        <ActivityIndicator size="large" color={theme.primary} />
      </View>
    );
  }

  if (error) {
    return (
      <View
        style={[styles.centerContainer, { backgroundColor: theme.background }]}
      >
        <Text style={{ color: theme.text }}>{error}</Text>
      </View>
    );
  }

  const task = project?.tasks?.[taskKey];
  const taskLabel = getTaskDisplayLabel(taskKey, task);
  const statusLabel = getStatusDisplayLabel(task?.status);
  const statusColor = getStatusColor(task?.status, theme);

  return (
    <SafeAreaView
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      <View style={styles.header}>
        <TouchableOpacity
          onPress={() => navigation.goBack()}
          style={styles.backButton}
        >
          <Ionicons name="arrow-back" size={28} color={theme.text} />
        </TouchableOpacity>
        <Text style={[styles.headerTitle, { color: theme.text }]}>
          Chi tiáº¿t CÃ´ng viá»‡c
        </Text>
      </View>

      <ScrollView style={styles.content}>
        <View style={[styles.card, { backgroundColor: theme.card }]}>
          <Text style={[styles.sectionTitle, { color: theme.textSecondary }]}>
            CÃ´ng viá»‡c
          </Text>
          <Text style={[styles.taskName, { color: theme.text }]}>
            {taskLabel}
          </Text>
          <View style={styles.statusContainer}>
            <Text style={[styles.detailText, { color: theme.textSecondary }]}>
              Tráº¡ng thÃ¡i:{' '}
            </Text>
            <Text style={[styles.statusText, { color: statusColor }]}>
              {statusLabel}
            </Text>
          </View>
        </View>

        <View style={[styles.card, { backgroundColor: theme.card }]}>
          <Text style={[styles.sectionTitle, { color: theme.textSecondary }]}>
            Thuá»™c dá»± Ã¡n
          </Text>
          <Text style={[styles.detailText, { color: theme.text }]}>
            TÃªn dá»± Ã¡n: {project?.name}
          </Text>
          <Text style={[styles.detailText, { color: theme.text }]}>
            KhÃ¡ch hÃ ng: {project?.customerName || 'KhÃ´ng cÃ³'}
          </Text>

          {project?.driveFolderUrl && (
            <View style={styles.driveLinkContainer}>
              <TouchableOpacity
                style={[
                  styles.driveLinkButton,
                  { backgroundColor: theme.primary },
                ]}
                onPress={handleOpenDriveFolder}
              >
                <Ionicons
                  name="folder-open"
                  size={18}
                  color="#fff"
                  style={styles.buttonIcon}
                />
                <Text style={styles.driveLinkText}>Má»Ÿ thÆ° má»¥c Drive</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.shareButton,
                  {
                    backgroundColor: shareSuccess
                      ? theme.success
                      : theme.secondary,
                  },
                ]}
                onPress={handleShareDriveLink}
                accessibilityLabel="Chia sáº» Ä‘Æ°á»ng dáº«n thÆ° má»¥c"
              >
                <Ionicons
                  name={shareSuccess ? 'checkmark' : 'share'}
                  size={20}
                  color="#fff"
                />
              </TouchableOpacity>
            </View>
          )}
        </View>
      </ScrollView>

      <View style={styles.footer}>
        <TouchableOpacity
          style={[
            styles.completeButton,
            {
              backgroundColor:
                task?.status === 'completed' || isUpdating
                  ? theme.textMuted
                  : theme.success || '#28a745',
            },
          ]}
          onPress={handleCompleteTask}
          disabled={task?.status === 'completed' || isUpdating}
        >
          {isUpdating ? (
            <ActivityIndicator color="#fff" />
          ) : (
            <Text style={styles.buttonText}>
              {task?.status === 'completed'
                ? 'ÄÃ£ hoÃ n thÃ nh'
                : 'HoÃ n thÃ nh cÃ´ng viá»‡c'}
            </Text>
          )}
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1 },
  centerContainer: { flex: 1, justifyContent: 'center', alignItems: 'center' },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 10,
    borderBottomWidth: 1,
    borderBottomColor: '#333',
  },
  backButton: { padding: 5 },
  headerTitle: { fontSize: 22, fontWeight: 'bold', marginLeft: 16 },
  content: { flex: 1, padding: 16 },
  card: {
    padding: 20,
    borderRadius: 12,
    marginBottom: 20,
    borderWidth: 1,
    borderColor: '#333',
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 12,
    color: '#888',
  },
  taskName: { fontSize: 26, fontWeight: 'bold', marginBottom: 10 },
  statusContainer: { flexDirection: 'row', alignItems: 'center' },
  statusText: { fontSize: 16, fontWeight: 'bold' },
  detailText: { fontSize: 16, lineHeight: 24 },
  footer: { padding: 16, borderTopWidth: 1, borderTopColor: '#333' },
  completeButton: {
    paddingVertical: 15,
    borderRadius: 12,
    alignItems: 'center',
  },
  buttonText: { color: '#fff', fontSize: 18, fontWeight: 'bold' },
  driveLinkContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 16,
  },
  driveLinkButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 10,
    paddingHorizontal: 16,
    borderRadius: 8,
    flex: 1,
  },
  driveLinkText: {
    color: '#fff',
    fontWeight: '600',
    fontSize: 16,
  },
  buttonIcon: {
    marginRight: 8,
  },
  shareButton: {
    marginLeft: 12,
    width: 44,
    height: 44,
    borderRadius: 8,
    alignItems: 'center',
    justifyContent: 'center',
  },
});

export default TaskDetailScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\TaskReportScreen.js ---

//src/screens/TaskReportScreen.js
import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  FlatList,
  StyleSheet,
  ActivityIndicator,
  TouchableOpacity,
  SafeAreaView,
  ScrollView,
} from 'react-native';
import { useFocusEffect } from '@react-navigation/native';
import { collection, query, where, getDocs, orderBy } from 'firebase/firestore';
import { db } from '../config/firebaseConfig';
import { useAuth } from '../contexts/AuthContext';
import { useTheme } from '../contexts/ThemeContext';

const TaskCard = ({ item, onPress, theme }) => {
  const getStatusColor = (status) => {
    switch (status) {
      case 'completed':
        return { bg: 'rgba(46, 204, 113, 0.2)', text: '#27AE60' };
      case 'in_progress':
        return { bg: 'rgba(52, 152, 219, 0.2)', text: '#2980B9' };
      case 'pending':
        return { bg: 'rgba(241, 196, 15, 0.2)', text: '#F39C12' };
      default:
        return { bg: theme.border, text: theme.textSecondary };
    }
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'completed':
        return 'HoÃ n thÃ nh';
      case 'in_progress':
        return 'Äang thá»±c hiá»‡n';
      case 'pending':
        return 'Chá» xá»­ lÃ½';
      default:
        return 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
    }
  };

  const statusStyle = getStatusColor(item.status);

  return (
    <TouchableOpacity
      style={[styles.card, { backgroundColor: theme.card }]}
      onPress={onPress}
    >
      <View style={styles.cardHeader}>
        <Text
          style={[styles.taskLabel, { color: theme.text }]}
          numberOfLines={1}
        >
          {item.taskLabel}
        </Text>
        <View style={[styles.statusBadge, { backgroundColor: statusStyle.bg }]}>
          <Text style={[styles.statusText, { color: statusStyle.text }]}>
            {getStatusLabel(item.status)}
          </Text>
        </View>
      </View>
      <View style={styles.cardBody}>
        <Text style={[styles.projectName, { color: theme.textSecondary }]}>
          Dá»± Ã¡n: {item.projectName}
        </Text>
        <Text style={[styles.assignedTo, { color: theme.textSecondary }]}>
          Phá»¥ trÃ¡ch: {item.assignedToName}
        </Text>
      </View>
    </TouchableOpacity>
  );
};

const TaskReportScreen = ({ navigation }) => {
  const { currentUser } = useAuth();
  const { theme } = useTheme();

  // Common states
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // States for Manager View
  const [myTasks, setMyTasks] = useState([]);
  const [staffPendingTasks, setStaffPendingTasks] = useState([]);
  const [staffCompletedTasks, setStaffCompletedTasks] = useState([]);

  // State for manager tabs
  const [activeManagerView, setActiveManagerView] = useState('my_tasks'); // 'my_tasks', 'staff_pending', 'staff_completed'

  // States for Staff View
  const [tasks, setTasks] = useState([]);
  const [filteredTasks, setFilteredTasks] = useState([]);
  const [activeFilter, setActiveFilter] = useState('all');

  const isManager = ['giam_doc', 'pho_giam_doc', 'admin'].includes(
    currentUser?.role
  );

  const fetchManagerTasks = async () => {
    setLoading(true);
    setError(null);
    try {
      const tasksCollection = collection(db, 'tasks');

      // 1. My tasks (pending or in-progress)
      const myTasksQuery = query(
        tasksCollection,
        where('assignedToId', '==', currentUser.uid),
        where('status', 'in', ['pending', 'in_progress'])
      );
      const myTasksSnapshot = await getDocs(myTasksQuery);
      setMyTasks(
        myTasksSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }))
      );

      // 2. Staff pending tasks
      const staffPendingQuery = query(
        tasksCollection,
        where('assignedToId', '!=', currentUser.uid),
        where('status', 'in', ['pending', 'in_progress'])
      );
      const staffPendingSnapshot = await getDocs(staffPendingQuery);
      setStaffPendingTasks(
        staffPendingSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }))
      );

      // 3. Staff completed tasks
      const staffCompletedQuery = query(
        tasksCollection,
        where('assignedToId', '!=', currentUser.uid),
        where('status', '==', 'completed')
      );
      const staffCompletedSnapshot = await getDocs(staffCompletedQuery);
      setStaffCompletedTasks(
        staffCompletedSnapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }))
      );
    } catch (err) {
      console.error('Error fetching manager tasks:', err);
      setError('KhÃ´ng thá»ƒ táº£i bÃ¡o cÃ¡o cÃ´ng viá»‡c.');
    } finally {
      setLoading(false);
    }
  };

  const fetchStaffTasks = async () => {
    setLoading(true);
    setError(null);
    try {
      const tasksCollection = collection(db, 'tasks');
      const tasksQuery = query(
        tasksCollection,
        where('assignedToId', '==', currentUser.uid),
        orderBy('updatedAt', 'desc')
      );

      const querySnapshot = await getDocs(tasksQuery);
      const fetchedTasks = querySnapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      }));
      setTasks(fetchedTasks);
      setFilteredTasks(fetchedTasks);
    } catch (err) {
      console.error('Error fetching tasks:', err);
      setError('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch cÃ´ng viá»‡c.');
    } finally {
      setLoading(false);
    }
  };

  useFocusEffect(
    useCallback(() => {
      if (isManager) {
        fetchManagerTasks();
      } else {
        fetchStaffTasks();
      }
    }, [currentUser, isManager])
  );

  useEffect(() => {
    if (!isManager) {
      if (activeFilter === 'all') {
        setFilteredTasks(tasks);
      } else {
        const filtered = tasks.filter((task) => task.status === activeFilter);
        setFilteredTasks(filtered);
      }
    }
  }, [activeFilter, tasks, isManager]);

  const handleTaskPress = (item) => {
    if (isManager) {
      // Managers go to the full project detail screen
      navigation.navigate('ProjectDetail', { projectId: item.projectId });
    } else {
      // Staff go to the dedicated, simplified task detail screen
      navigation.navigate('TaskDetail', {
        projectId: item.projectId,
        taskKey: item.taskKey,
      });
    }
  };

  // -- RENDER METHODS --

  if (loading) {
    return (
      <View
        style={[styles.centerContainer, { backgroundColor: theme.background }]}
      >
        <ActivityIndicator size="large" color={theme.primary} />
      </View>
    );
  }

  if (error) {
    return (
      <View
        style={[styles.centerContainer, { backgroundColor: theme.background }]}
      >
        <Text style={{ color: theme.text }}>{error}</Text>
      </View>
    );
  }

  const renderTaskList = (data) => {
    if (data.length === 0) {
      return (
        <View style={styles.emptySection}>
          <Text style={{ color: theme.textSecondary }}>
            KhÃ´ng cÃ³ cÃ´ng viá»‡c nÃ o.
          </Text>
        </View>
      );
    }
    return data.map((item) => (
      <TaskCard
        key={item.id}
        item={item}
        onPress={() => handleTaskPress(item)}
        theme={theme}
      />
    ));
  };

  // Manager View
  if (isManager) {
    const renderManagerContent = () => {
      switch (activeManagerView) {
        case 'staff_pending':
          return renderTaskList(staffPendingTasks);
        case 'staff_completed':
          return renderTaskList(staffCompletedTasks);
        case 'my_tasks':
        default:
          return renderTaskList(myTasks);
      }
    };

    return (
      <SafeAreaView
        style={[styles.container, { backgroundColor: theme.background }]}
      >
        <Text style={[styles.headerTitle, { color: theme.text }]}>
          BÃ¡o cÃ¡o CÃ´ng viá»‡c
        </Text>

        {/* Manager Tabs */}
        <View style={styles.managerTabContainer}>
          <TouchableOpacity
            style={[
              styles.managerTab,
              { backgroundColor: theme.card },
              activeManagerView === 'my_tasks' && {
                backgroundColor: theme.primary,
              },
            ]}
            onPress={() => setActiveManagerView('my_tasks')}
          >
            <Text
              style={[
                styles.managerTabText,
                { color: theme.text },
                activeManagerView === 'my_tasks' && { color: '#FFFFFF' },
              ]}
            >
              Viá»‡c cá»§a tÃ´i
            </Text>
          </TouchableOpacity>
          <TouchableOpacity
            style={[
              styles.managerTab,
              { backgroundColor: theme.card },
              activeManagerView === 'staff_pending' && {
                backgroundColor: theme.primary,
              },
            ]}
            onPress={() => setActiveManagerView('staff_pending')}
          >
            <Text
              style={[
                styles.managerTabText,
                { color: theme.text },
                activeManagerView === 'staff_pending' && { color: '#FFFFFF' },
              ]}
            >
              NV Äang LÃ m
            </Text>
          </TouchableOpacity>
          <TouchableOpacity
            style={[
              styles.managerTab,
              { backgroundColor: theme.card },
              activeManagerView === 'staff_completed' && {
                backgroundColor: theme.primary,
              },
            ]}
            onPress={() => setActiveManagerView('staff_completed')}
          >
            <Text
              style={[
                styles.managerTabText,
                { color: theme.text },
                activeManagerView === 'staff_completed' && { color: '#FFFFFF' },
              ]}
            >
              ÄÃ£ HoÃ n ThÃ nh
            </Text>
          </TouchableOpacity>
        </View>

        <ScrollView contentContainerStyle={styles.listContainer}>
          {renderManagerContent()}
        </ScrollView>
      </SafeAreaView>
    );
  }

  // Staff View
  const renderFilterButtons = () => {
    const filters = [
      { key: 'all', label: 'Táº¥t cáº£' },
      { key: 'in_progress', label: 'Äang lÃ m' },
      { key: 'completed', label: 'HoÃ n thÃ nh' },
      { key: 'pending', label: 'Chá» xá»­ lÃ½' },
    ];

    return (
      <View style={styles.filterContainer}>
        {filters.map((filter) => (
          <TouchableOpacity
            key={filter.key}
            style={[
              styles.filterButton,
              {
                backgroundColor:
                  activeFilter === filter.key ? theme.primary : theme.card,
              },
            ]}
            onPress={() => setActiveFilter(filter.key)}
          >
            <Text
              style={[
                styles.filterText,
                { color: activeFilter === filter.key ? '#fff' : theme.text },
              ]}
            >
              {filter.label}
            </Text>
          </TouchableOpacity>
        ))}
      </View>
    );
  };

  return (
    <SafeAreaView
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      <Text style={[styles.headerTitle, { color: theme.text }]}>
        CÃ´ng viá»‡c cá»§a báº¡n
      </Text>
      {renderFilterButtons()}
      <FlatList
        data={filteredTasks}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <TaskCard
            item={item}
            onPress={() => handleTaskPress(item)}
            theme={theme}
          />
        )}
        contentContainerStyle={styles.listContainer}
        ListEmptyComponent={() => (
          <View style={styles.centerContainer}>
            <Text style={{ color: theme.textSecondary }}>
              KhÃ´ng cÃ³ cÃ´ng viá»‡c nÃ o.
            </Text>
          </View>
        )}
      />
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1 },
  centerContainer: { flex: 1, justifyContent: 'center', alignItems: 'center' },
  headerTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    padding: 16,
    paddingBottom: 8,
  },
  listContainer: { paddingHorizontal: 16, paddingBottom: 16 },
  card: {
    padding: 16,
    borderRadius: 12,
    marginVertical: 8,
    borderWidth: 1,
    borderColor: '#eee',
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.05,
    shadowRadius: 2,
  },
  cardHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  taskLabel: { fontSize: 18, fontWeight: 'bold', flexShrink: 1 },
  statusBadge: {
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 10,
    marginLeft: 8,
  },
  statusText: { fontSize: 12, fontWeight: '600' },
  cardBody: {},
  projectName: { fontSize: 14, marginBottom: 4 },
  assignedTo: { fontSize: 14 },
  filterContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    paddingHorizontal: 16,
    marginBottom: 8,
  },
  filterButton: {
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 16,
  },
  filterText: {
    fontWeight: '500',
  },
  // Styles for Manager View
  managerTabContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    paddingHorizontal: 16,
    marginBottom: 16,
  },
  managerTab: {
    flex: 1,
    paddingVertical: 10,
    borderRadius: 20,
    alignItems: 'center',
    marginHorizontal: 4,
  },
  managerTabText: {
    fontWeight: 'bold',
  },
  section: {
    marginBottom: 24,
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    marginBottom: 8,
  },
  emptySection: {
    padding: 16,
    alignItems: 'center',
    backgroundColor: '#f9f9f9',
    borderRadius: 8,
    borderWidth: 1,
    borderColor: '#eee',
  },
});

export default TaskReportScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\screens\UserManagementScreen.js ---

// src/screens/UserManagementScreen.js
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  TouchableOpacity,
  Modal,
  TextInput,
  ActivityIndicator,
  Alert,
  Image,
  SafeAreaView,
  ScrollView,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useTheme } from '../contexts/ThemeContext';
import { useAuth } from '../contexts/AuthContext';
import {
  collection,
  getDocs,
  doc,
  updateDoc,
  query,
  orderBy,
  getDoc,
} from 'firebase/firestore';
import { db } from '../config/firebaseConfig';
import * as ImagePicker from 'expo-image-picker';
import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';

const UserManagementScreen = () => {
  const { theme } = useTheme();
  const { currentUser } = useAuth();
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedUser, setSelectedUser] = useState(null);
  const [editModalVisible, setEditModalVisible] = useState(false);
  const [editData, setEditData] = useState({
    displayName: '',
    email: '',
    role: '',
    photoURL: '',
    monthlySalary: '',
    phoneNumber: '',
    address: '',
    notes: '',
  });
  const [savingUser, setSavingUser] = useState(false);
  const [uploadingImage, setUploadingImage] = useState(false);

  // Role options for dropdown
  const roleOptions = [
    { value: 'giam_doc', label: 'GiÃ¡m Ä‘á»‘c' },
    { value: 'pho_giam_doc', label: 'PhÃ³ GiÃ¡m Ä‘á»‘c' },
    { value: 'ke_toan', label: 'Káº¿ toÃ¡n' },
    { value: 'ky_su', label: 'Ká»¹ sÆ°' },
    { value: 'thuong_mai', label: 'ThÆ°Æ¡ng máº¡i' },
    { value: 'cong_nhan', label: 'CÃ´ng nhÃ¢n' },
    { value: 'user', label: 'NgÆ°á»i dÃ¹ng' },
  ];

  // Load users
  useEffect(() => {
    const fetchUsers = async () => {
      try {
        setLoading(true);
        const usersRef = collection(db, 'users');
        const q = query(usersRef, orderBy('displayName'));
        const snapshot = await getDocs(q);
        const usersList = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        setUsers(usersList);
      } catch (error) {
        console.error('Error loading users:', error);
        Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i danh sÃ¡ch ngÆ°á»i dÃ¹ng');
      } finally {
        setLoading(false);
      }
    };

    fetchUsers();
  }, []);

  // Handle user selection for editing
  const handleEditUser = (user) => {
    setSelectedUser(user);
    setEditData({
      displayName: user.displayName || '',
      email: user.email || '',
      role: user.role || 'user',
      photoURL: user.photoURL || '',
      monthlySalary: user.monthlySalary ? String(user.monthlySalary) : '',
      phoneNumber: user.phoneNumber || '',
      address: user.address || '',
      notes: user.notes || '',
    });
    setEditModalVisible(true);
  };

  // Save user changes
  const saveUserChanges = async () => {
    if (!selectedUser) return;

    try {
      setSavingUser(true);

      // Validate required fields
      if (!editData.displayName.trim()) {
        Alert.alert('Lá»—i', 'TÃªn ngÆ°á»i dÃ¹ng khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');
        return;
      }

      // Convert salary to number if provided
      const userData = {
        ...editData,
        monthlySalary: editData.monthlySalary
          ? parseFloat(editData.monthlySalary)
          : null,
      };

      // Update user in Firestore
      const userRef = doc(db, 'users', selectedUser.id);
      await updateDoc(userRef, userData);

      // Update local state
      setUsers((prevUsers) =>
        prevUsers.map((u) =>
          u.id === selectedUser.id ? { ...u, ...userData } : u
        )
      );

      // Close modal
      setEditModalVisible(false);
      setSelectedUser(null);
      Alert.alert('ThÃ nh cÃ´ng', 'ÄÃ£ cáº­p nháº­t thÃ´ng tin ngÆ°á»i dÃ¹ng');
    } catch (error) {
      console.error('Error updating user:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ cáº­p nháº­t thÃ´ng tin ngÆ°á»i dÃ¹ng');
    } finally {
      setSavingUser(false);
    }
  };

  // Pick and upload profile image
  const pickImage = async () => {
    try {
      const result = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        allowsEditing: true,
        aspect: [1, 1],
        quality: 0.7,
      });

      if (!result.canceled && result.assets && result.assets[0]) {
        uploadImage(result.assets[0].uri);
      }
    } catch (error) {
      console.error('Error picking image:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ chá»n áº£nh');
    }
  };

  // Upload image to Firebase Storage
  const uploadImage = async (uri) => {
    try {
      setUploadingImage(true);

      // Convert image to blob
      const response = await fetch(uri);
      const blob = await response.blob();

      // Upload to Firebase Storage
      const storage = getStorage();
      const fileExtension = uri.split('.').pop();
      const fileName = `profile_${
        selectedUser.id
      }_${Date.now()}.${fileExtension}`;
      const storageRef = ref(storage, `profiles/${fileName}`);

      await uploadBytes(storageRef, blob);
      const downloadURL = await getDownloadURL(storageRef);

      // Update edit data with new image URL
      setEditData((prev) => ({
        ...prev,
        photoURL: downloadURL,
      }));
    } catch (error) {
      console.error('Error uploading image:', error);
      Alert.alert('Lá»—i', 'KhÃ´ng thá»ƒ táº£i lÃªn áº£nh');
    } finally {
      setUploadingImage(false);
    }
  };

  // Render user item in list
  const renderUserItem = ({ item }) => {
    const isCurrentUser = item.id === currentUser?.uid;

    return (
      <TouchableOpacity
        style={[styles.userCard, { backgroundColor: theme.card }]}
        onPress={() => handleEditUser(item)}
      >
        <View style={styles.userCardLeft}>
          {item.photoURL ? (
            <Image source={{ uri: item.photoURL }} style={styles.avatar} />
          ) : (
            <View
              style={[
                styles.avatarPlaceholder,
                { backgroundColor: theme.primaryLight },
              ]}
            >
              <Text style={[styles.avatarText, { color: theme.primary }]}>
                {(item.displayName || item.email || '?')[0].toUpperCase()}
              </Text>
            </View>
          )}
        </View>

        <View style={styles.userCardMiddle}>
          <Text style={[styles.userName, { color: theme.text }]}>
            {item.displayName || item.email || 'KhÃ´ng cÃ³ tÃªn'}
            {isCurrentUser && ' (Báº¡n)'}
          </Text>
          <Text style={[styles.userRole, { color: theme.textSecondary }]}>
            {getRoleLabel(item.role)}
          </Text>
          {item.monthlySalary && (
            <Text style={[styles.userSalary, { color: theme.textMuted }]}>
              {formatCurrency(item.monthlySalary)} VND/thÃ¡ng
            </Text>
          )}
        </View>

        <View style={styles.userCardRight}>
          <Ionicons name="chevron-forward" size={20} color={theme.textMuted} />
        </View>
      </TouchableOpacity>
    );
  };

  // Helper function to get role label
  const getRoleLabel = (role) => {
    const option = roleOptions.find((o) => o.value === role);
    return option ? option.label : 'NgÆ°á»i dÃ¹ng';
  };

  // Format currency
  const formatCurrency = (value) => {
    return new Intl.NumberFormat('vi-VN').format(value);
  };

  return (
    <SafeAreaView
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      {/* Header */}
      <View style={[styles.header, { backgroundColor: theme.card }]}>
        <Text style={[styles.headerTitle, { color: theme.text }]}>
          Quáº£n lÃ½ NhÃ¢n viÃªn
        </Text>
      </View>

      {/* User list */}
      {loading ? (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color={theme.primary} />
          <Text style={[styles.loadingText, { color: theme.textSecondary }]}>
            Äang táº£i danh sÃ¡ch ngÆ°á»i dÃ¹ng...
          </Text>
        </View>
      ) : (
        <FlatList
          data={users}
          renderItem={renderUserItem}
          keyExtractor={(item) => item.id}
          contentContainerStyle={styles.listContent}
          ListEmptyComponent={
            <View style={styles.emptyContainer}>
              <Ionicons name="people" size={40} color={theme.textMuted} />
              <Text style={[styles.emptyText, { color: theme.textMuted }]}>
                KhÃ´ng cÃ³ ngÆ°á»i dÃ¹ng nÃ o
              </Text>
            </View>
          }
        />
      )}

      {/* Edit user modal */}
      <Modal
        visible={editModalVisible}
        transparent
        animationType="slide"
        onRequestClose={() => setEditModalVisible(false)}
      >
        <View style={styles.modalBackdrop}>
          <View style={[styles.modalContent, { backgroundColor: theme.card }]}>
            <View style={styles.modalHeader}>
              <Text style={[styles.modalTitle, { color: theme.text }]}>
                Chá»‰nh sá»­a thÃ´ng tin
              </Text>
              <TouchableOpacity
                onPress={() => setEditModalVisible(false)}
                style={styles.closeButton}
              >
                <Ionicons name="close" size={24} color={theme.textMuted} />
              </TouchableOpacity>
            </View>

            <ScrollView style={styles.modalScrollView}>
              {/* Profile image */}
              <View style={styles.profileImageContainer}>
                {uploadingImage ? (
                  <ActivityIndicator size="large" color={theme.primary} />
                ) : editData.photoURL ? (
                  <Image
                    source={{ uri: editData.photoURL }}
                    style={styles.profileImage}
                  />
                ) : (
                  <View
                    style={[
                      styles.profileImagePlaceholder,
                      { backgroundColor: theme.primaryLight },
                    ]}
                  >
                    <Text
                      style={[
                        styles.profileImageText,
                        { color: theme.primary },
                      ]}
                    >
                      {(editData.displayName || '?')[0].toUpperCase()}
                    </Text>
                  </View>
                )}

                <TouchableOpacity
                  style={[
                    styles.changePhotoButton,
                    { backgroundColor: theme.primary },
                  ]}
                  onPress={pickImage}
                >
                  <Ionicons name="camera" size={18} color="#fff" />
                  <Text style={styles.changePhotoText}>Äá»•i áº£nh</Text>
                </TouchableOpacity>
              </View>

              {/* Form fields */}
              <View style={styles.formGroup}>
                <Text style={[styles.label, { color: theme.text }]}>TÃªn</Text>
                <TextInput
                  style={[
                    styles.input,
                    { borderColor: theme.border, color: theme.text },
                  ]}
                  value={editData.displayName}
                  onChangeText={(text) =>
                    setEditData((prev) => ({ ...prev, displayName: text }))
                  }
                  placeholder="TÃªn ngÆ°á»i dÃ¹ng"
                  placeholderTextColor={theme.textMuted}
                />
              </View>

              <View style={styles.formGroup}>
                <Text style={[styles.label, { color: theme.text }]}>Email</Text>
                <TextInput
                  style={[
                    styles.input,
                    { borderColor: theme.border, color: theme.text },
                  ]}
                  value={editData.email}
                  onChangeText={(text) =>
                    setEditData((prev) => ({ ...prev, email: text }))
                  }
                  placeholder="Email"
                  placeholderTextColor={theme.textMuted}
                  keyboardType="email-address"
                />
              </View>

              <View style={styles.formGroup}>
                <Text style={[styles.label, { color: theme.text }]}>
                  Vai trÃ²
                </Text>
                <View
                  style={[
                    styles.pickerContainer,
                    { borderColor: theme.border },
                  ]}
                >
                  {roleOptions.map((option) => (
                    <TouchableOpacity
                      key={option.value}
                      style={[
                        styles.roleOption,
                        editData.role === option.value && [
                          styles.selectedRole,
                          { backgroundColor: theme.primary + '20' },
                        ],
                      ]}
                      onPress={() =>
                        setEditData((prev) => ({ ...prev, role: option.value }))
                      }
                    >
                      <Text
                        style={[
                          styles.roleOptionText,
                          { color: theme.text },
                          editData.role === option.value && {
                            color: theme.primary,
                            fontWeight: '600',
                          },
                        ]}
                      >
                        {option.label}
                      </Text>
                    </TouchableOpacity>
                  ))}
                </View>
              </View>

              <View style={styles.formGroup}>
                <Text style={[styles.label, { color: theme.text }]}>
                  LÆ°Æ¡ng thÃ¡ng (VND)
                </Text>
                <TextInput
                  style={[
                    styles.input,
                    { borderColor: theme.border, color: theme.text },
                  ]}
                  value={editData.monthlySalary}
                  onChangeText={(text) => {
                    // Only allow numbers
                    const filtered = text.replace(/[^0-9]/g, '');
                    setEditData((prev) => ({
                      ...prev,
                      monthlySalary: filtered,
                    }));
                  }}
                  placeholder="LÆ°Æ¡ng thÃ¡ng"
                  placeholderTextColor={theme.textMuted}
                  keyboardType="numeric"
                />
              </View>

              <View style={styles.formGroup}>
                <Text style={[styles.label, { color: theme.text }]}>
                  Sá»‘ Ä‘iá»‡n thoáº¡i
                </Text>
                <TextInput
                  style={[
                    styles.input,
                    { borderColor: theme.border, color: theme.text },
                  ]}
                  value={editData.phoneNumber}
                  onChangeText={(text) =>
                    setEditData((prev) => ({ ...prev, phoneNumber: text }))
                  }
                  placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i"
                  placeholderTextColor={theme.textMuted}
                  keyboardType="phone-pad"
                />
              </View>

              <View style={styles.formGroup}>
                <Text style={[styles.label, { color: theme.text }]}>
                  Äá»‹a chá»‰
                </Text>
                <TextInput
                  style={[
                    styles.input,
                    { borderColor: theme.border, color: theme.text },
                  ]}
                  value={editData.address}
                  onChangeText={(text) =>
                    setEditData((prev) => ({ ...prev, address: text }))
                  }
                  placeholder="Äá»‹a chá»‰"
                  placeholderTextColor={theme.textMuted}
                />
              </View>

              <View style={styles.formGroup}>
                <Text style={[styles.label, { color: theme.text }]}>
                  Ghi chÃº
                </Text>
                <TextInput
                  style={[
                    styles.textArea,
                    { borderColor: theme.border, color: theme.text },
                  ]}
                  value={editData.notes}
                  onChangeText={(text) =>
                    setEditData((prev) => ({ ...prev, notes: text }))
                  }
                  placeholder="Ghi chÃº"
                  placeholderTextColor={theme.textMuted}
                  multiline
                  numberOfLines={4}
                  textAlignVertical="top"
                />
              </View>
            </ScrollView>

            <View style={styles.modalFooter}>
              <TouchableOpacity
                style={[styles.cancelButton, { borderColor: theme.border }]}
                onPress={() => setEditModalVisible(false)}
              >
                <Text style={{ color: theme.text }}>Há»§y</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.saveButton, { backgroundColor: theme.primary }]}
                onPress={saveUserChanges}
                disabled={savingUser}
              >
                {savingUser ? (
                  <ActivityIndicator size="small" color="#fff" />
                ) : (
                  <Text style={styles.saveButtonText}>LÆ°u thay Ä‘á»•i</Text>
                )}
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  header: {
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    elevation: 2,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 12,
  },
  listContent: {
    padding: 12,
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 40,
  },
  emptyText: {
    marginTop: 12,
    fontSize: 16,
  },
  userCard: {
    flexDirection: 'row',
    padding: 12,
    marginBottom: 8,
    borderRadius: 8,
    elevation: 1,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 1,
  },
  userCardLeft: {
    marginRight: 12,
  },
  avatar: {
    width: 50,
    height: 50,
    borderRadius: 25,
  },
  avatarPlaceholder: {
    width: 50,
    height: 50,
    borderRadius: 25,
    justifyContent: 'center',
    alignItems: 'center',
  },
  avatarText: {
    fontSize: 20,
    fontWeight: 'bold',
  },
  userCardMiddle: {
    flex: 1,
    justifyContent: 'center',
  },
  userName: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 4,
  },
  userRole: {
    fontSize: 14,
    marginBottom: 2,
  },
  userSalary: {
    fontSize: 12,
  },
  userCardRight: {
    justifyContent: 'center',
  },
  modalBackdrop: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContent: {
    width: '90%',
    maxHeight: '90%',
    borderRadius: 12,
    elevation: 5,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  closeButton: {
    padding: 4,
  },
  modalScrollView: {
    padding: 16,
  },
  profileImageContainer: {
    alignItems: 'center',
    marginBottom: 20,
  },
  profileImage: {
    width: 100,
    height: 100,
    borderRadius: 50,
    marginBottom: 10,
  },
  profileImagePlaceholder: {
    width: 100,
    height: 100,
    borderRadius: 50,
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 10,
  },
  profileImageText: {
    fontSize: 36,
    fontWeight: 'bold',
  },
  changePhotoButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 16,
  },
  changePhotoText: {
    color: '#fff',
    marginLeft: 6,
    fontWeight: '500',
  },
  formGroup: {
    marginBottom: 16,
  },
  label: {
    marginBottom: 6,
    fontWeight: '500',
  },
  input: {
    borderWidth: 1,
    borderRadius: 8,
    padding: 10,
    fontSize: 16,
  },
  textArea: {
    borderWidth: 1,
    borderRadius: 8,
    padding: 10,
    fontSize: 16,
    height: 100,
  },
  pickerContainer: {
    borderWidth: 1,
    borderRadius: 8,
    padding: 6,
  },
  roleOption: {
    paddingVertical: 8,
    paddingHorizontal: 12,
    borderRadius: 4,
    marginBottom: 2,
  },
  selectedRole: {
    fontWeight: 'bold',
  },
  roleOptionText: {
    fontSize: 16,
  },
  modalFooter: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    padding: 16,
    borderTopWidth: 1,
    borderTopColor: '#eee',
  },
  cancelButton: {
    borderWidth: 1,
    borderRadius: 8,
    paddingVertical: 10,
    paddingHorizontal: 16,
    marginRight: 12,
  },
  saveButton: {
    borderRadius: 8,
    paddingVertical: 10,
    paddingHorizontal: 24,
  },
  saveButtonText: {
    color: '#fff',
    fontWeight: '600',
  },
});

export default UserManagementScreen;


--- File: C:\Users\Admin\Downloads\thpapp\src\utils\taskHelpers.js ---

/**
 * Gets the Vietnamese display label for a task key.
 * @param {string} taskKey The key of the task (e.g., "material_cutting").
 * @param {any} taskData The data object for the task, used for the custom "other" task.
 * @returns {string} The display label for the task.
 */
export const getTaskDisplayLabel = (taskKey, taskData) => {
  const taskLabels = {
    material_separation: 'BÃ³c tÃ¡ch váº­t tÆ°',
    quotation: 'BÃ¡o giÃ¡',
    material_purchasing: 'Mua váº­t tÆ° & phá»¥ kiá»‡n',
    material_cutting: 'Cáº¯t phÃ´i',
    assembly: 'Láº¯p rÃ¡p',
    painting: 'SÆ¡n',
    shipping: 'Váº­n chuyá»ƒn',
    other: taskData?.name || 'CÃ´ng viá»‡c khÃ¡c',
  };
  return taskLabels[taskKey] || taskKey.replace(/_/g, ' ');
};

/**
 * Gets the Vietnamese display label for a task status.
 * @param {string} status The status key (e.g., "in_progress").
 * @returns {string} The display label for the status.
 */
export const getStatusDisplayLabel = (status) => {
  const statusLabels = {
    completed: 'HoÃ n thÃ nh',
    in_progress: 'Äang thá»±c hiá»‡n',
    pending: 'Chá» xá»­ lÃ½',
  };
  return statusLabels[status] || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
};

/**
 * Gets the color code associated with a task status.
 * @param {string} status The status key (e.g., "in_progress").
 * @param {object} theme The application theme object.
 * @returns {string} The color hex code.
 */
export const getStatusColor = (status, theme) => {
  switch (status) {
    case 'completed':
      return theme.success || '#28a745';
    case 'in_progress':
      return theme.info || '#17a2b8';
    case 'pending':
      return theme.warning || '#ffc107';
    default:
      return theme.textMuted || '#6c757d';
  }
};

